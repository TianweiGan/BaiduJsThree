var __defProp=Object.defineProperty,__defNormalProp=(e,t,i)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,__publicField=(e,t,i)=>(__defNormalProp(e,"symbol"!=typeof t?t+"":t,i),i);!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).mapvthree={})}(this,(function(e){"use strict";const t="mapv";function i(e,t){if(void 0===e.className)e.className=t;else if(e.className!==t){const i=e.className.split(/ +/);-1===i.indexOf(t)&&(i.push(t),e.className=i.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return e}function n(e,t){if(t)if(e.className===t)e.removeAttribute("class");else{const i=e.className.split(/ +/),n=i.indexOf(t);-1!==n&&(i.splice(n,1),e.className=i.join(" "))}else e.className=void 0;return e}const s={};const o="158",r=1,a=2,l=3,g=0,c=1,d=100,h=200,u=201,I=0,p=1,m=2,A=0,C=1,f=2,b=3,y=4,_=5,v="attached",x=301,B=302,w=303,S=306,G=1e3,M=1001,R=1002,T=1003,Z=1004,V=1005,W=1006,E=1007,N=1008,F=1009,X=1010,H=1011,z=1012,L=1013,D=1014,K=1015,Y=1016,P=1017,k=1018,O=1020,U=1023,Q=1024,J=1026,j=1027,q=1028,$=1029,ee=1030,te=1031,ie=1033,ne=33776,se=33777,oe=33778,re=33779,ae=35840,le=35841,ge=35842,ce=35843,de=36196,he=37492,ue=37496,Ie=37808,pe=37809,me=37810,Ae=37811,Ce=37812,fe=37813,be=37814,ye=37815,_e=37816,ve=37817,xe=37818,Be=37819,we=37820,Se=37821,Ge=36492,Me=36494,Re=36495,Te=36284,Ze=36285,Ve=36286,We=2300,Ee=2301,Ne=2302,Fe=2400,Xe=2401,He=2402,ze=2500,Le=3e3,De=3001,Ke="",Ye="srgb",Pe="srgb-linear",ke="display-p3",Oe="display-p3-linear",Ue="linear",Qe="srgb",Je="rec709",je="p3",qe=7680,$e=35044,et=35048,tt="300 es",it=1035,nt=2e3,st=2001;
/**
   * @license
   * Copyright 2010-2023 Three.js Authors
   * SPDX-License-Identifier: MIT
   */class ot{addEventListener(e,t){void 0===this._listeners&&(this._listeners={});const i=this._listeners;void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t)}hasEventListener(e,t){if(void 0===this._listeners)return!1;const i=this._listeners;return void 0!==i[e]&&-1!==i[e].indexOf(t)}removeEventListener(e,t){if(void 0===this._listeners)return;const i=this._listeners[e];if(void 0!==i){const e=i.indexOf(t);-1!==e&&i.splice(e,1)}}dispatchEvent(e){if(void 0===this._listeners)return;const t=this._listeners[e.type];if(void 0!==t){e.target=this;const i=t.slice(0);for(let t=0,n=i.length;t<n;t++)i[t].call(this,e);e.target=null}}}const rt=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];let at=1234567;const lt=Math.PI/180,gt=180/Math.PI;function ct(){const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return(rt[255&e]+rt[e>>8&255]+rt[e>>16&255]+rt[e>>24&255]+"-"+rt[255&t]+rt[t>>8&255]+"-"+rt[t>>16&15|64]+rt[t>>24&255]+"-"+rt[63&i|128]+rt[i>>8&255]+"-"+rt[i>>16&255]+rt[i>>24&255]+rt[255&n]+rt[n>>8&255]+rt[n>>16&255]+rt[n>>24&255]).toLowerCase()}function dt(e,t,i){return Math.max(t,Math.min(i,e))}function ht(e,t){return(e%t+t)%t}function ut(e,t,i){return(1-i)*e+i*t}function It(e){return 0==(e&e-1)&&0!==e}function pt(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))}function mt(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))}function At(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return e/4294967295;case Uint16Array:return e/65535;case Uint8Array:return e/255;case Int32Array:return Math.max(e/2147483647,-1);case Int16Array:return Math.max(e/32767,-1);case Int8Array:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}function Ct(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return Math.round(4294967295*e);case Uint16Array:return Math.round(65535*e);case Uint8Array:return Math.round(255*e);case Int32Array:return Math.round(2147483647*e);case Int16Array:return Math.round(32767*e);case Int8Array:return Math.round(127*e);default:throw new Error("Invalid component type.")}}const ft={DEG2RAD:lt,RAD2DEG:gt,generateUUID:ct,clamp:dt,euclideanModulo:ht,mapLinear:function(e,t,i,n,s){return n+(e-t)*(s-n)/(i-t)},inverseLerp:function(e,t,i){return e!==t?(i-e)/(t-e):0},lerp:ut,damp:function(e,t,i,n){return ut(e,t,1-Math.exp(-i*n))},pingpong:function(e,t=1){return t-Math.abs(ht(e,2*t)-t)},smoothstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*(3-2*e)},smootherstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},seededRandom:function(e){void 0!==e&&(at=e);let t=at+=1831565813;return t=Math.imul(t^t>>>15,1|t),t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296},degToRad:function(e){return e*lt},radToDeg:function(e){return e*gt},isPowerOfTwo:It,ceilPowerOfTwo:pt,floorPowerOfTwo:mt,setQuaternionFromProperEuler:function(e,t,i,n,s){const o=Math.cos,r=Math.sin,a=o(i/2),l=r(i/2),g=o((t+n)/2),c=r((t+n)/2),d=o((t-n)/2),h=r((t-n)/2),u=o((n-t)/2),I=r((n-t)/2);switch(s){case"XYX":e.set(a*c,l*d,l*h,a*g);break;case"YZY":e.set(l*h,a*c,l*d,a*g);break;case"ZXZ":e.set(l*d,l*h,a*c,a*g);break;case"XZX":e.set(a*c,l*I,l*u,a*g);break;case"YXY":e.set(l*u,a*c,l*I,a*g);break;case"ZYZ":e.set(l*I,l*u,a*c,a*g);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+s)}},normalize:Ct,denormalize:At};class bt{constructor(e=0,t=0){bt.prototype.isVector2=!0,this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,i=this.y,n=e.elements;return this.x=n[0]*t+n[3]*i+n[6],this.y=n[1]*t+n[4]*i+n[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const i=this.dot(e)/t;return Math.acos(dt(i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y;return t*t+i*i}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const i=Math.cos(t),n=Math.sin(t),s=this.x-e.x,o=this.y-e.y;return this.x=s*i-o*n+e.x,this.y=s*n+o*i+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class yt{constructor(e,t,i,n,s,o,r,a,l){yt.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==e&&this.set(e,t,i,n,s,o,r,a,l)}set(e,t,i,n,s,o,r,a,l){const g=this.elements;return g[0]=e,g[1]=n,g[2]=r,g[3]=t,g[4]=s,g[5]=a,g[6]=i,g[7]=o,g[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this}extractBasis(e,t,i){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,n=t.elements,s=this.elements,o=i[0],r=i[3],a=i[6],l=i[1],g=i[4],c=i[7],d=i[2],h=i[5],u=i[8],I=n[0],p=n[3],m=n[6],A=n[1],C=n[4],f=n[7],b=n[2],y=n[5],_=n[8];return s[0]=o*I+r*A+a*b,s[3]=o*p+r*C+a*y,s[6]=o*m+r*f+a*_,s[1]=l*I+g*A+c*b,s[4]=l*p+g*C+c*y,s[7]=l*m+g*f+c*_,s[2]=d*I+h*A+u*b,s[5]=d*p+h*C+u*y,s[8]=d*m+h*f+u*_,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],i=e[1],n=e[2],s=e[3],o=e[4],r=e[5],a=e[6],l=e[7],g=e[8];return t*o*g-t*r*l-i*s*g+i*r*a+n*s*l-n*o*a}invert(){const e=this.elements,t=e[0],i=e[1],n=e[2],s=e[3],o=e[4],r=e[5],a=e[6],l=e[7],g=e[8],c=g*o-r*l,d=r*a-g*s,h=l*s-o*a,u=t*c+i*d+n*h;if(0===u)return this.set(0,0,0,0,0,0,0,0,0);const I=1/u;return e[0]=c*I,e[1]=(n*l-g*i)*I,e[2]=(r*i-n*o)*I,e[3]=d*I,e[4]=(g*t-n*a)*I,e[5]=(n*s-r*t)*I,e[6]=h*I,e[7]=(i*a-l*t)*I,e[8]=(o*t-i*s)*I,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,i,n,s,o,r){const a=Math.cos(s),l=Math.sin(s);return this.set(i*a,i*l,-i*(a*o+l*r)+o+e,-n*l,n*a,-n*(-l*o+a*r)+r+t,0,0,1),this}scale(e,t){return this.premultiply(_t.makeScale(e,t)),this}rotate(e){return this.premultiply(_t.makeRotation(-e)),this}translate(e,t){return this.premultiply(_t.makeTranslation(e,t)),this}makeTranslation(e,t){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,t,0,0,1),this}makeRotation(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,i,t,0,0,0,1),this}makeScale(e,t){return this.set(e,0,0,0,t,0,0,0,1),this}equals(e){const t=this.elements,i=e.elements;for(let n=0;n<9;n++)if(t[n]!==i[n])return!1;return!0}fromArray(e,t=0){for(let i=0;i<9;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e}clone(){return(new this.constructor).fromArray(this.elements)}}const _t=new yt;function vt(e){for(let t=e.length-1;t>=0;--t)if(e[t]>=65535)return!0;return!1}function xt(e){return document.createElementNS("http://www.w3.org/1999/xhtml",e)}function Bt(){const e=xt("canvas");return e.style.display="block",e}const wt={};function St(e){e in wt||(wt[e]=!0,console.warn(e))}const Gt=(new yt).set(.8224621,.177538,0,.0331941,.9668058,0,.0170827,.0723974,.9105199),Mt=(new yt).set(1.2249401,-.2249404,0,-.0420569,1.0420571,0,-.0196376,-.0786361,1.0982735),Rt={[Pe]:{transfer:Ue,primaries:Je,toReference:e=>e,fromReference:e=>e},[Ye]:{transfer:Qe,primaries:Je,toReference:e=>e.convertSRGBToLinear(),fromReference:e=>e.convertLinearToSRGB()},[Oe]:{transfer:Ue,primaries:je,toReference:e=>e.applyMatrix3(Mt),fromReference:e=>e.applyMatrix3(Gt)},[ke]:{transfer:Qe,primaries:je,toReference:e=>e.convertSRGBToLinear().applyMatrix3(Mt),fromReference:e=>e.applyMatrix3(Gt).convertLinearToSRGB()}},Tt=new Set([Pe,Oe]),Zt={enabled:!0,_workingColorSpace:Pe,get legacyMode(){return console.warn("THREE.ColorManagement: .legacyMode=false renamed to .enabled=true in r150."),!this.enabled},set legacyMode(e){console.warn("THREE.ColorManagement: .legacyMode=false renamed to .enabled=true in r150."),this.enabled=!e},get workingColorSpace(){return this._workingColorSpace},set workingColorSpace(e){if(!Tt.has(e))throw new Error(`Unsupported working color space, "${e}".`);this._workingColorSpace=e},convert:function(e,t,i){if(!1===this.enabled||t===i||!t||!i)return e;const n=Rt[t].toReference;return(0,Rt[i].fromReference)(n(e))},fromWorkingColorSpace:function(e,t){return this.convert(e,this._workingColorSpace,t)},toWorkingColorSpace:function(e,t){return this.convert(e,t,this._workingColorSpace)},getPrimaries:function(e){return Rt[e].primaries},getTransfer:function(e){return e===Ke?Ue:Rt[e].transfer}};function Vt(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function Wt(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}let Et;class Nt{static getDataURL(e){if(/^data:/i.test(e.src))return e.src;if("undefined"==typeof HTMLCanvasElement)return e.src;let t;if(e instanceof HTMLCanvasElement)t=e;else{void 0===Et&&(Et=xt("canvas")),Et.width=e.width,Et.height=e.height;const i=Et.getContext("2d");e instanceof ImageData?i.putImageData(e,0,0):i.drawImage(e,0,0,e.width,e.height),t=Et}return t.width>2048||t.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",e),t.toDataURL("image/jpeg",.6)):t.toDataURL("image/png")}static sRGBToLinear(e){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const t=xt("canvas");t.width=e.width,t.height=e.height;const i=t.getContext("2d");i.drawImage(e,0,0,e.width,e.height);const n=i.getImageData(0,0,e.width,e.height),s=n.data;for(let e=0;e<s.length;e++)s[e]=255*Vt(s[e]/255);return i.putImageData(n,0,0),t}if(e.data){const t=e.data.slice(0);for(let e=0;e<t.length;e++)t instanceof Uint8Array||t instanceof Uint8ClampedArray?t[e]=Math.floor(255*Vt(t[e]/255)):t[e]=Vt(t[e]);return{data:t,width:e.width,height:e.height}}return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),e}}let Ft=0;class Xt{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:Ft++}),this.uuid=ct(),this.data=e,this.version=0}set needsUpdate(e){!0===e&&this.version++}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.images[this.uuid])return e.images[this.uuid];const i={uuid:this.uuid,url:""},n=this.data;if(null!==n){let e;if(Array.isArray(n)){e=[];for(let t=0,i=n.length;t<i;t++)n[t].isDataTexture?e.push(Ht(n[t].image)):e.push(Ht(n[t]))}else e=Ht(n);i.url=e}return t||(e.images[this.uuid]=i),i}}function Ht(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?Nt.getDataURL(e):e.data?{data:Array.from(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let zt=0;class Lt extends ot{constructor(e=Lt.DEFAULT_IMAGE,t=Lt.DEFAULT_MAPPING,i=1001,n=1001,s=1006,o=1008,r=1023,a=F,l=Lt.DEFAULT_ANISOTROPY,g=Ke){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:zt++}),this.uuid=ct(),this.name="",this.source=new Xt(e),this.mipmaps=[],this.mapping=t,this.channel=0,this.wrapS=i,this.wrapT=n,this.magFilter=s,this.minFilter=o,this.anisotropy=l,this.format=r,this.internalFormat=null,this.type=a,this.offset=new bt(0,0),this.repeat=new bt(1,1),this.center=new bt(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new yt,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,"string"==typeof g?this.colorSpace=g:(St("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace=g===De?Ye:Ke),this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.needsPMREMUpdate=!1}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];const i={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(i.userData=this.userData),t||(e.textures[this.uuid]=i),i}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(300!==this.mapping)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case G:e.x=e.x-Math.floor(e.x);break;case M:e.x=e.x<0?0:1;break;case R:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case G:e.y=e.y-Math.floor(e.y);break;case M:e.y=e.y<0?0:1;break;case R:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&(this.version++,this.source.needsUpdate=!0)}get encoding(){return St("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace===Ye?De:Le}set encoding(e){St("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace=e===De?Ye:Ke}}Lt.DEFAULT_IMAGE=null,Lt.DEFAULT_MAPPING=300,Lt.DEFAULT_ANISOTROPY=1;class Dt{constructor(e=0,t=0,i=0,n=1){Dt.prototype.isVector4=!0,this.x=e,this.y=t,this.z=i,this.w=n}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,i=this.y,n=this.z,s=this.w,o=e.elements;return this.x=o[0]*t+o[4]*i+o[8]*n+o[12]*s,this.y=o[1]*t+o[5]*i+o[9]*n+o[13]*s,this.z=o[2]*t+o[6]*i+o[10]*n+o[14]*s,this.w=o[3]*t+o[7]*i+o[11]*n+o[15]*s,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,i,n,s;const o=.01,r=.1,a=e.elements,l=a[0],g=a[4],c=a[8],d=a[1],h=a[5],u=a[9],I=a[2],p=a[6],m=a[10];if(Math.abs(g-d)<o&&Math.abs(c-I)<o&&Math.abs(u-p)<o){if(Math.abs(g+d)<r&&Math.abs(c+I)<r&&Math.abs(u+p)<r&&Math.abs(l+h+m-3)<r)return this.set(1,0,0,0),this;t=Math.PI;const e=(l+1)/2,a=(h+1)/2,A=(m+1)/2,C=(g+d)/4,f=(c+I)/4,b=(u+p)/4;return e>a&&e>A?e<o?(i=0,n=.707106781,s=.707106781):(i=Math.sqrt(e),n=C/i,s=f/i):a>A?a<o?(i=.707106781,n=0,s=.707106781):(n=Math.sqrt(a),i=C/n,s=b/n):A<o?(i=.707106781,n=.707106781,s=0):(s=Math.sqrt(A),i=f/s,n=b/s),this.set(i,n,s,t),this}let A=Math.sqrt((p-u)*(p-u)+(c-I)*(c-I)+(d-g)*(d-g));return Math.abs(A)<.001&&(A=1),this.x=(p-u)/A,this.y=(c-I)/A,this.z=(d-g)/A,this.w=Math.acos((l+h+m-1)/2),this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this.w=Math.max(e,Math.min(t,this.w)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this.w=e.w+(t.w-e.w)*i,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class Kt extends ot{constructor(e=1,t=1,i={}){super(),this.isRenderTarget=!0,this.width=e,this.height=t,this.depth=1,this.scissor=new Dt(0,0,e,t),this.scissorTest=!1,this.viewport=new Dt(0,0,e,t);const n={width:e,height:t,depth:1};void 0!==i.encoding&&(St("THREE.WebGLRenderTarget: option.encoding has been replaced by option.colorSpace."),i.colorSpace=i.encoding===De?Ye:Ke),i=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:W,depthBuffer:!0,stencilBuffer:!1,depthTexture:null,samples:0},i),this.texture=new Lt(n,i.mapping,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.flipY=!1,this.texture.generateMipmaps=i.generateMipmaps,this.texture.internalFormat=i.internalFormat,this.depthBuffer=i.depthBuffer,this.stencilBuffer=i.stencilBuffer,this.depthTexture=i.depthTexture,this.samples=i.samples}setSize(e,t,i=1){this.width===e&&this.height===t&&this.depth===i||(this.width=e,this.height=t,this.depth=i,this.texture.image.width=e,this.texture.image.height=t,this.texture.image.depth=i,this.dispose()),this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return(new this.constructor).copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.texture=e.texture.clone(),this.texture.isRenderTargetTexture=!0;const t=Object.assign({},e.texture.image);return this.texture.source=new Xt(t),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,null!==e.depthTexture&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class Yt extends Kt{constructor(e=1,t=1,i={}){super(e,t,i),this.isWebGLRenderTarget=!0}}class Pt extends Lt{constructor(e=null,t=1,i=1,n=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:t,height:i,depth:n},this.magFilter=T,this.minFilter=T,this.wrapR=M,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class kt extends Lt{constructor(e=null,t=1,i=1,n=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:i,depth:n},this.magFilter=T,this.minFilter=T,this.wrapR=M,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class Ot extends Yt{constructor(e=1,t=1,i=1,n={}){super(e,t,n),this.isWebGLMultipleRenderTargets=!0;const s=this.texture;this.texture=[];for(let o=0;o<i;o++)this.texture[o]=s.clone(),this.texture[o].isRenderTargetTexture=!0}setSize(e,t,i=1){if(this.width!==e||this.height!==t||this.depth!==i){this.width=e,this.height=t,this.depth=i;for(let n=0,s=this.texture.length;n<s;n++)this.texture[n].image.width=e,this.texture[n].image.height=t,this.texture[n].image.depth=i;this.dispose()}this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}copy(e){this.dispose(),this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,null!==e.depthTexture&&(this.depthTexture=e.depthTexture.clone()),this.texture.length=0;for(let t=0,i=e.texture.length;t<i;t++)this.texture[t]=e.texture[t].clone(),this.texture[t].isRenderTargetTexture=!0;return this}}class Ut{constructor(e=0,t=0,i=0,n=1){this.isQuaternion=!0,this._x=e,this._y=t,this._z=i,this._w=n}static slerpFlat(e,t,i,n,s,o,r){let a=i[n+0],l=i[n+1],g=i[n+2],c=i[n+3];const d=s[o+0],h=s[o+1],u=s[o+2],I=s[o+3];if(0===r)return e[t+0]=a,e[t+1]=l,e[t+2]=g,void(e[t+3]=c);if(1===r)return e[t+0]=d,e[t+1]=h,e[t+2]=u,void(e[t+3]=I);if(c!==I||a!==d||l!==h||g!==u){let e=1-r;const t=a*d+l*h+g*u+c*I,i=t>=0?1:-1,n=1-t*t;if(n>Number.EPSILON){const s=Math.sqrt(n),o=Math.atan2(s,t*i);e=Math.sin(e*o)/s,r=Math.sin(r*o)/s}const s=r*i;if(a=a*e+d*s,l=l*e+h*s,g=g*e+u*s,c=c*e+I*s,e===1-r){const e=1/Math.sqrt(a*a+l*l+g*g+c*c);a*=e,l*=e,g*=e,c*=e}}e[t]=a,e[t+1]=l,e[t+2]=g,e[t+3]=c}static multiplyQuaternionsFlat(e,t,i,n,s,o){const r=i[n],a=i[n+1],l=i[n+2],g=i[n+3],c=s[o],d=s[o+1],h=s[o+2],u=s[o+3];return e[t]=r*u+g*c+a*h-l*d,e[t+1]=a*u+g*d+l*c-r*h,e[t+2]=l*u+g*h+r*d-a*c,e[t+3]=g*u-r*c-a*d-l*h,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,i,n){return this._x=e,this._y=t,this._z=i,this._w=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t){const i=e._x,n=e._y,s=e._z,o=e._order,r=Math.cos,a=Math.sin,l=r(i/2),g=r(n/2),c=r(s/2),d=a(i/2),h=a(n/2),u=a(s/2);switch(o){case"XYZ":this._x=d*g*c+l*h*u,this._y=l*h*c-d*g*u,this._z=l*g*u+d*h*c,this._w=l*g*c-d*h*u;break;case"YXZ":this._x=d*g*c+l*h*u,this._y=l*h*c-d*g*u,this._z=l*g*u-d*h*c,this._w=l*g*c+d*h*u;break;case"ZXY":this._x=d*g*c-l*h*u,this._y=l*h*c+d*g*u,this._z=l*g*u+d*h*c,this._w=l*g*c-d*h*u;break;case"ZYX":this._x=d*g*c-l*h*u,this._y=l*h*c+d*g*u,this._z=l*g*u-d*h*c,this._w=l*g*c+d*h*u;break;case"YZX":this._x=d*g*c+l*h*u,this._y=l*h*c+d*g*u,this._z=l*g*u-d*h*c,this._w=l*g*c-d*h*u;break;case"XZY":this._x=d*g*c-l*h*u,this._y=l*h*c-d*g*u,this._z=l*g*u+d*h*c,this._w=l*g*c+d*h*u;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+o)}return!1!==t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const i=t/2,n=Math.sin(i);return this._x=e.x*n,this._y=e.y*n,this._z=e.z*n,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,i=t[0],n=t[4],s=t[8],o=t[1],r=t[5],a=t[9],l=t[2],g=t[6],c=t[10],d=i+r+c;if(d>0){const e=.5/Math.sqrt(d+1);this._w=.25/e,this._x=(g-a)*e,this._y=(s-l)*e,this._z=(o-n)*e}else if(i>r&&i>c){const e=2*Math.sqrt(1+i-r-c);this._w=(g-a)/e,this._x=.25*e,this._y=(n+o)/e,this._z=(s+l)/e}else if(r>c){const e=2*Math.sqrt(1+r-i-c);this._w=(s-l)/e,this._x=(n+o)/e,this._y=.25*e,this._z=(a+g)/e}else{const e=2*Math.sqrt(1+c-i-r);this._w=(o-n)/e,this._x=(s+l)/e,this._y=(a+g)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let i=e.dot(t)+1;return i<Number.EPSILON?(i=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=i):(this._x=0,this._y=-e.z,this._z=e.y,this._w=i)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=i),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(dt(this.dot(e),-1,1)))}rotateTowards(e,t){const i=this.angleTo(e);if(0===i)return this;const n=Math.min(1,t/i);return this.slerp(e,n),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const i=e._x,n=e._y,s=e._z,o=e._w,r=t._x,a=t._y,l=t._z,g=t._w;return this._x=i*g+o*r+n*l-s*a,this._y=n*g+o*a+s*r-i*l,this._z=s*g+o*l+i*a-n*r,this._w=o*g-i*r-n*a-s*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);const i=this._x,n=this._y,s=this._z,o=this._w;let r=o*e._w+i*e._x+n*e._y+s*e._z;if(r<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,r=-r):this.copy(e),r>=1)return this._w=o,this._x=i,this._y=n,this._z=s,this;const a=1-r*r;if(a<=Number.EPSILON){const e=1-t;return this._w=e*o+t*this._w,this._x=e*i+t*this._x,this._y=e*n+t*this._y,this._z=e*s+t*this._z,this.normalize(),this._onChangeCallback(),this}const l=Math.sqrt(a),g=Math.atan2(l,r),c=Math.sin((1-t)*g)/l,d=Math.sin(t*g)/l;return this._w=o*c+this._w*d,this._x=i*c+this._x*d,this._y=n*c+this._y*d,this._z=s*c+this._z*d,this._onChangeCallback(),this}slerpQuaternions(e,t,i){return this.copy(e).slerp(t,i)}random(){const e=Math.random(),t=Math.sqrt(1-e),i=Math.sqrt(e),n=2*Math.PI*Math.random(),s=2*Math.PI*Math.random();return this.set(t*Math.cos(n),i*Math.sin(s),i*Math.cos(s),t*Math.sin(n))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class Qt{constructor(e=0,t=0,i=0){Qt.prototype.isVector3=!0,this.x=e,this.y=t,this.z=i}set(e,t,i){return void 0===i&&(i=this.z),this.x=e,this.y=t,this.z=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(jt.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(jt.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,i=this.y,n=this.z,s=e.elements;return this.x=s[0]*t+s[3]*i+s[6]*n,this.y=s[1]*t+s[4]*i+s[7]*n,this.z=s[2]*t+s[5]*i+s[8]*n,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,i=this.y,n=this.z,s=e.elements,o=1/(s[3]*t+s[7]*i+s[11]*n+s[15]);return this.x=(s[0]*t+s[4]*i+s[8]*n+s[12])*o,this.y=(s[1]*t+s[5]*i+s[9]*n+s[13])*o,this.z=(s[2]*t+s[6]*i+s[10]*n+s[14])*o,this}applyQuaternion(e){const t=this.x,i=this.y,n=this.z,s=e.x,o=e.y,r=e.z,a=e.w,l=2*(o*n-r*i),g=2*(r*t-s*n),c=2*(s*i-o*t);return this.x=t+a*l+o*c-r*g,this.y=i+a*g+r*l-s*c,this.z=n+a*c+s*g-o*l,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,i=this.y,n=this.z,s=e.elements;return this.x=s[0]*t+s[4]*i+s[8]*n,this.y=s[1]*t+s[5]*i+s[9]*n,this.z=s[2]*t+s[6]*i+s[10]*n,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const i=e.x,n=e.y,s=e.z,o=t.x,r=t.y,a=t.z;return this.x=n*a-s*r,this.y=s*o-i*a,this.z=i*r-n*o,this}projectOnVector(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const i=e.dot(this)/t;return this.copy(e).multiplyScalar(i)}projectOnPlane(e){return Jt.copy(this).projectOnVector(e),this.sub(Jt)}reflect(e){return this.sub(Jt.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const i=this.dot(e)/t;return Math.acos(dt(i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y,n=this.z-e.z;return t*t+i*i+n*n}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,i){const n=Math.sin(t)*e;return this.x=n*Math.sin(i),this.y=Math.cos(t)*e,this.z=n*Math.cos(i),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,i){return this.x=e*Math.sin(t),this.y=i,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),i=this.setFromMatrixColumn(e,1).length(),n=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=i,this.z=n,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=2*(Math.random()-.5),t=Math.random()*Math.PI*2,i=Math.sqrt(1-e**2);return this.x=i*Math.cos(t),this.y=i*Math.sin(t),this.z=e,this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const Jt=new Qt,jt=new Ut;class qt{constructor(e=new Qt(1/0,1/0,1/0),t=new Qt(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t+=3)this.expandByPoint(ei.fromArray(e,t));return this}setFromBufferAttribute(e){this.makeEmpty();for(let t=0,i=e.count;t<i;t++)this.expandByPoint(ei.fromBufferAttribute(e,t));return this}setFromPoints(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const i=ei.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}setFromObject(e,t=!1){return this.makeEmpty(),this.expandByObject(e,t)}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,t=!1){e.updateWorldMatrix(!1,!1);const i=e.geometry;if(void 0!==i){const n=i.getAttribute("position");if(!0===t&&void 0!==n&&!0!==e.isInstancedMesh)for(let t=0,i=n.count;t<i;t++)!0===e.isMesh?e.getVertexPosition(t,ei):ei.fromBufferAttribute(n,t),ei.applyMatrix4(e.matrixWorld),this.expandByPoint(ei);else void 0!==e.boundingBox?(null===e.boundingBox&&e.computeBoundingBox(),ti.copy(e.boundingBox)):(null===i.boundingBox&&i.computeBoundingBox(),ti.copy(i.boundingBox)),ti.applyMatrix4(e.matrixWorld),this.union(ti)}const n=e.children;for(let s=0,o=n.length;s<o;s++)this.expandByObject(n[s],t);return this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}intersectsSphere(e){return this.clampPoint(e.center,ei),ei.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,i;return e.normal.x>0?(t=e.normal.x*this.min.x,i=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,i=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,i+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,i+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,i+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,i+=e.normal.z*this.min.z),t<=-e.constant&&i>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(li),gi.subVectors(this.max,li),ii.subVectors(e.a,li),ni.subVectors(e.b,li),si.subVectors(e.c,li),oi.subVectors(ni,ii),ri.subVectors(si,ni),ai.subVectors(ii,si);let t=[0,-oi.z,oi.y,0,-ri.z,ri.y,0,-ai.z,ai.y,oi.z,0,-oi.x,ri.z,0,-ri.x,ai.z,0,-ai.x,-oi.y,oi.x,0,-ri.y,ri.x,0,-ai.y,ai.x,0];return!!hi(t,ii,ni,si,gi)&&(t=[1,0,0,0,1,0,0,0,1],!!hi(t,ii,ni,si,gi)&&(ci.crossVectors(oi,ri),t=[ci.x,ci.y,ci.z],hi(t,ii,ni,si,gi)))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,ei).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=.5*this.getSize(ei).length()),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||($t[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),$t[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),$t[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),$t[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),$t[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),$t[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),$t[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),$t[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints($t)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}const $t=[new Qt,new Qt,new Qt,new Qt,new Qt,new Qt,new Qt,new Qt],ei=new Qt,ti=new qt,ii=new Qt,ni=new Qt,si=new Qt,oi=new Qt,ri=new Qt,ai=new Qt,li=new Qt,gi=new Qt,ci=new Qt,di=new Qt;function hi(e,t,i,n,s){for(let o=0,r=e.length-3;o<=r;o+=3){di.fromArray(e,o);const r=s.x*Math.abs(di.x)+s.y*Math.abs(di.y)+s.z*Math.abs(di.z),a=t.dot(di),l=i.dot(di),g=n.dot(di);if(Math.max(-Math.max(a,l,g),Math.min(a,l,g))>r)return!1}return!0}const ui=new qt,Ii=new Qt,pi=new Qt;class mi{constructor(e=new Qt,t=-1){this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const i=this.center;void 0!==t?i.copy(t):ui.setFromPoints(e).getCenter(i);let n=0;for(let s=0,o=e.length;s<o;s++)n=Math.max(n,i.distanceToSquared(e[s]));return this.radius=Math.sqrt(n),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const i=this.center.distanceToSquared(e);return t.copy(e),i>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;Ii.subVectors(e,this.center);const t=Ii.lengthSq();if(t>this.radius*this.radius){const e=Math.sqrt(t),i=.5*(e-this.radius);this.center.addScaledVector(Ii,i/e),this.radius+=i}return this}union(e){return e.isEmpty()?this:this.isEmpty()?(this.copy(e),this):(!0===this.center.equals(e.center)?this.radius=Math.max(this.radius,e.radius):(pi.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(Ii.copy(e.center).add(pi)),this.expandByPoint(Ii.copy(e.center).sub(pi))),this)}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return(new this.constructor).copy(this)}}const Ai=new Qt,Ci=new Qt,fi=new Qt,bi=new Qt,yi=new Qt,_i=new Qt,vi=new Qt;class xi{constructor(e=new Qt,t=new Qt(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,Ai)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);const i=t.dot(this.direction);return i<0?t.copy(this.origin):t.copy(this.origin).addScaledVector(this.direction,i)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=Ai.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(Ai.copy(this.origin).addScaledVector(this.direction,t),Ai.distanceToSquared(e))}distanceSqToSegment(e,t,i,n){Ci.copy(e).add(t).multiplyScalar(.5),fi.copy(t).sub(e).normalize(),bi.copy(this.origin).sub(Ci);const s=.5*e.distanceTo(t),o=-this.direction.dot(fi),r=bi.dot(this.direction),a=-bi.dot(fi),l=bi.lengthSq(),g=Math.abs(1-o*o);let c,d,h,u;if(g>0)if(c=o*a-r,d=o*r-a,u=s*g,c>=0)if(d>=-u)if(d<=u){const e=1/g;c*=e,d*=e,h=c*(c+o*d+2*r)+d*(o*c+d+2*a)+l}else d=s,c=Math.max(0,-(o*d+r)),h=-c*c+d*(d+2*a)+l;else d=-s,c=Math.max(0,-(o*d+r)),h=-c*c+d*(d+2*a)+l;else d<=-u?(c=Math.max(0,-(-o*s+r)),d=c>0?-s:Math.min(Math.max(-s,-a),s),h=-c*c+d*(d+2*a)+l):d<=u?(c=0,d=Math.min(Math.max(-s,-a),s),h=d*(d+2*a)+l):(c=Math.max(0,-(o*s+r)),d=c>0?s:Math.min(Math.max(-s,-a),s),h=-c*c+d*(d+2*a)+l);else d=o>0?-s:s,c=Math.max(0,-(o*d+r)),h=-c*c+d*(d+2*a)+l;return i&&i.copy(this.origin).addScaledVector(this.direction,c),n&&n.copy(Ci).addScaledVector(fi,d),h}intersectSphere(e,t){Ai.subVectors(e.center,this.origin);const i=Ai.dot(this.direction),n=Ai.dot(Ai)-i*i,s=e.radius*e.radius;if(n>s)return null;const o=Math.sqrt(s-n),r=i-o,a=i+o;return a<0?null:r<0?this.at(a,t):this.at(r,t)}intersectsSphere(e){return this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;const i=-(this.origin.dot(e.normal)+e.constant)/t;return i>=0?i:null}intersectPlane(e,t){const i=this.distanceToPlane(e);return null===i?null:this.at(i,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);if(0===t)return!0;return e.normal.dot(this.direction)*t<0}intersectBox(e,t){let i,n,s,o,r,a;const l=1/this.direction.x,g=1/this.direction.y,c=1/this.direction.z,d=this.origin;return l>=0?(i=(e.min.x-d.x)*l,n=(e.max.x-d.x)*l):(i=(e.max.x-d.x)*l,n=(e.min.x-d.x)*l),g>=0?(s=(e.min.y-d.y)*g,o=(e.max.y-d.y)*g):(s=(e.max.y-d.y)*g,o=(e.min.y-d.y)*g),i>o||s>n?null:((s>i||isNaN(i))&&(i=s),(o<n||isNaN(n))&&(n=o),c>=0?(r=(e.min.z-d.z)*c,a=(e.max.z-d.z)*c):(r=(e.max.z-d.z)*c,a=(e.min.z-d.z)*c),i>a||r>n?null:((r>i||i!=i)&&(i=r),(a<n||n!=n)&&(n=a),n<0?null:this.at(i>=0?i:n,t)))}intersectsBox(e){return null!==this.intersectBox(e,Ai)}intersectTriangle(e,t,i,n,s){yi.subVectors(t,e),_i.subVectors(i,e),vi.crossVectors(yi,_i);let o,r=this.direction.dot(vi);if(r>0){if(n)return null;o=1}else{if(!(r<0))return null;o=-1,r=-r}bi.subVectors(this.origin,e);const a=o*this.direction.dot(_i.crossVectors(bi,_i));if(a<0)return null;const l=o*this.direction.dot(yi.cross(bi));if(l<0)return null;if(a+l>r)return null;const g=-o*bi.dot(vi);return g<0?null:this.at(g/r,s)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class Bi{constructor(e,t,i,n,s,o,r,a,l,g,c,d,h,u,I,p){Bi.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==e&&this.set(e,t,i,n,s,o,r,a,l,g,c,d,h,u,I,p)}set(e,t,i,n,s,o,r,a,l,g,c,d,h,u,I,p){const m=this.elements;return m[0]=e,m[4]=t,m[8]=i,m[12]=n,m[1]=s,m[5]=o,m[9]=r,m[13]=a,m[2]=l,m[6]=g,m[10]=c,m[14]=d,m[3]=h,m[7]=u,m[11]=I,m[15]=p,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Bi).fromArray(this.elements)}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],this}copyPosition(e){const t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,i){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,i=e.elements,n=1/wi.setFromMatrixColumn(e,0).length(),s=1/wi.setFromMatrixColumn(e,1).length(),o=1/wi.setFromMatrixColumn(e,2).length();return t[0]=i[0]*n,t[1]=i[1]*n,t[2]=i[2]*n,t[3]=0,t[4]=i[4]*s,t[5]=i[5]*s,t[6]=i[6]*s,t[7]=0,t[8]=i[8]*o,t[9]=i[9]*o,t[10]=i[10]*o,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){const t=this.elements,i=e.x,n=e.y,s=e.z,o=Math.cos(i),r=Math.sin(i),a=Math.cos(n),l=Math.sin(n),g=Math.cos(s),c=Math.sin(s);if("XYZ"===e.order){const e=o*g,i=o*c,n=r*g,s=r*c;t[0]=a*g,t[4]=-a*c,t[8]=l,t[1]=i+n*l,t[5]=e-s*l,t[9]=-r*a,t[2]=s-e*l,t[6]=n+i*l,t[10]=o*a}else if("YXZ"===e.order){const e=a*g,i=a*c,n=l*g,s=l*c;t[0]=e+s*r,t[4]=n*r-i,t[8]=o*l,t[1]=o*c,t[5]=o*g,t[9]=-r,t[2]=i*r-n,t[6]=s+e*r,t[10]=o*a}else if("ZXY"===e.order){const e=a*g,i=a*c,n=l*g,s=l*c;t[0]=e-s*r,t[4]=-o*c,t[8]=n+i*r,t[1]=i+n*r,t[5]=o*g,t[9]=s-e*r,t[2]=-o*l,t[6]=r,t[10]=o*a}else if("ZYX"===e.order){const e=o*g,i=o*c,n=r*g,s=r*c;t[0]=a*g,t[4]=n*l-i,t[8]=e*l+s,t[1]=a*c,t[5]=s*l+e,t[9]=i*l-n,t[2]=-l,t[6]=r*a,t[10]=o*a}else if("YZX"===e.order){const e=o*a,i=o*l,n=r*a,s=r*l;t[0]=a*g,t[4]=s-e*c,t[8]=n*c+i,t[1]=c,t[5]=o*g,t[9]=-r*g,t[2]=-l*g,t[6]=i*c+n,t[10]=e-s*c}else if("XZY"===e.order){const e=o*a,i=o*l,n=r*a,s=r*l;t[0]=a*g,t[4]=-c,t[8]=l*g,t[1]=e*c+s,t[5]=o*g,t[9]=i*c-n,t[2]=n*c-i,t[6]=r*g,t[10]=s*c+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(Gi,e,Mi)}lookAt(e,t,i){const n=this.elements;return Zi.subVectors(e,t),0===Zi.lengthSq()&&(Zi.z=1),Zi.normalize(),Ri.crossVectors(i,Zi),0===Ri.lengthSq()&&(1===Math.abs(i.z)?Zi.x+=1e-4:Zi.z+=1e-4,Zi.normalize(),Ri.crossVectors(i,Zi)),Ri.normalize(),Ti.crossVectors(Zi,Ri),n[0]=Ri.x,n[4]=Ti.x,n[8]=Zi.x,n[1]=Ri.y,n[5]=Ti.y,n[9]=Zi.y,n[2]=Ri.z,n[6]=Ti.z,n[10]=Zi.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,n=t.elements,s=this.elements,o=i[0],r=i[4],a=i[8],l=i[12],g=i[1],c=i[5],d=i[9],h=i[13],u=i[2],I=i[6],p=i[10],m=i[14],A=i[3],C=i[7],f=i[11],b=i[15],y=n[0],_=n[4],v=n[8],x=n[12],B=n[1],w=n[5],S=n[9],G=n[13],M=n[2],R=n[6],T=n[10],Z=n[14],V=n[3],W=n[7],E=n[11],N=n[15];return s[0]=o*y+r*B+a*M+l*V,s[4]=o*_+r*w+a*R+l*W,s[8]=o*v+r*S+a*T+l*E,s[12]=o*x+r*G+a*Z+l*N,s[1]=g*y+c*B+d*M+h*V,s[5]=g*_+c*w+d*R+h*W,s[9]=g*v+c*S+d*T+h*E,s[13]=g*x+c*G+d*Z+h*N,s[2]=u*y+I*B+p*M+m*V,s[6]=u*_+I*w+p*R+m*W,s[10]=u*v+I*S+p*T+m*E,s[14]=u*x+I*G+p*Z+m*N,s[3]=A*y+C*B+f*M+b*V,s[7]=A*_+C*w+f*R+b*W,s[11]=A*v+C*S+f*T+b*E,s[15]=A*x+C*G+f*Z+b*N,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[0],i=e[4],n=e[8],s=e[12],o=e[1],r=e[5],a=e[9],l=e[13],g=e[2],c=e[6],d=e[10],h=e[14];return e[3]*(+s*a*c-n*l*c-s*r*d+i*l*d+n*r*h-i*a*h)+e[7]*(+t*a*h-t*l*d+s*o*d-n*o*h+n*l*g-s*a*g)+e[11]*(+t*l*c-t*r*h-s*o*c+i*o*h+s*r*g-i*l*g)+e[15]*(-n*r*g-t*a*c+t*r*d+n*o*c-i*o*d+i*a*g)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,i){const n=this.elements;return e.isVector3?(n[12]=e.x,n[13]=e.y,n[14]=e.z):(n[12]=e,n[13]=t,n[14]=i),this}invert(){const e=this.elements,t=e[0],i=e[1],n=e[2],s=e[3],o=e[4],r=e[5],a=e[6],l=e[7],g=e[8],c=e[9],d=e[10],h=e[11],u=e[12],I=e[13],p=e[14],m=e[15],A=c*p*l-I*d*l+I*a*h-r*p*h-c*a*m+r*d*m,C=u*d*l-g*p*l-u*a*h+o*p*h+g*a*m-o*d*m,f=g*I*l-u*c*l+u*r*h-o*I*h-g*r*m+o*c*m,b=u*c*a-g*I*a-u*r*d+o*I*d+g*r*p-o*c*p,y=t*A+i*C+n*f+s*b;if(0===y)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const _=1/y;return e[0]=A*_,e[1]=(I*d*s-c*p*s-I*n*h+i*p*h+c*n*m-i*d*m)*_,e[2]=(r*p*s-I*a*s+I*n*l-i*p*l-r*n*m+i*a*m)*_,e[3]=(c*a*s-r*d*s-c*n*l+i*d*l+r*n*h-i*a*h)*_,e[4]=C*_,e[5]=(g*p*s-u*d*s+u*n*h-t*p*h-g*n*m+t*d*m)*_,e[6]=(u*a*s-o*p*s-u*n*l+t*p*l+o*n*m-t*a*m)*_,e[7]=(o*d*s-g*a*s+g*n*l-t*d*l-o*n*h+t*a*h)*_,e[8]=f*_,e[9]=(u*c*s-g*I*s-u*i*h+t*I*h+g*i*m-t*c*m)*_,e[10]=(o*I*s-u*r*s+u*i*l-t*I*l-o*i*m+t*r*m)*_,e[11]=(g*r*s-o*c*s-g*i*l+t*c*l+o*i*h-t*r*h)*_,e[12]=b*_,e[13]=(g*I*n-u*c*n+u*i*d-t*I*d-g*i*p+t*c*p)*_,e[14]=(u*r*n-o*I*n-u*i*a+t*I*a+o*i*p-t*r*p)*_,e[15]=(o*c*n-g*r*n+g*i*a-t*c*a-o*i*d+t*r*d)*_,this}scale(e){const t=this.elements,i=e.x,n=e.y,s=e.z;return t[0]*=i,t[4]*=n,t[8]*=s,t[1]*=i,t[5]*=n,t[9]*=s,t[2]*=i,t[6]*=n,t[10]*=s,t[3]*=i,t[7]*=n,t[11]*=s,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],n=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,i,n))}makeTranslation(e,t,i){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const i=Math.cos(t),n=Math.sin(t),s=1-i,o=e.x,r=e.y,a=e.z,l=s*o,g=s*r;return this.set(l*o+i,l*r-n*a,l*a+n*r,0,l*r+n*a,g*r+i,g*a-n*o,0,l*a-n*r,g*a+n*o,s*a*a+i,0,0,0,0,1),this}makeScale(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this}makeShear(e,t,i,n,s,o){return this.set(1,i,s,0,e,1,o,0,t,n,1,0,0,0,0,1),this}compose(e,t,i){const n=this.elements,s=t._x,o=t._y,r=t._z,a=t._w,l=s+s,g=o+o,c=r+r,d=s*l,h=s*g,u=s*c,I=o*g,p=o*c,m=r*c,A=a*l,C=a*g,f=a*c,b=i.x,y=i.y,_=i.z;return n[0]=(1-(I+m))*b,n[1]=(h+f)*b,n[2]=(u-C)*b,n[3]=0,n[4]=(h-f)*y,n[5]=(1-(d+m))*y,n[6]=(p+A)*y,n[7]=0,n[8]=(u+C)*_,n[9]=(p-A)*_,n[10]=(1-(d+I))*_,n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1,this}decompose(e,t,i){const n=this.elements;let s=wi.set(n[0],n[1],n[2]).length();const o=wi.set(n[4],n[5],n[6]).length(),r=wi.set(n[8],n[9],n[10]).length();this.determinant()<0&&(s=-s),e.x=n[12],e.y=n[13],e.z=n[14],Si.copy(this);const a=1/s,l=1/o,g=1/r;return Si.elements[0]*=a,Si.elements[1]*=a,Si.elements[2]*=a,Si.elements[4]*=l,Si.elements[5]*=l,Si.elements[6]*=l,Si.elements[8]*=g,Si.elements[9]*=g,Si.elements[10]*=g,t.setFromRotationMatrix(Si),i.x=s,i.y=o,i.z=r,this}makePerspective(e,t,i,n,s,o,r=2e3){const a=this.elements,l=2*s/(t-e),g=2*s/(i-n),c=(t+e)/(t-e),d=(i+n)/(i-n);let h,u;if(r===nt)h=-(o+s)/(o-s),u=-2*o*s/(o-s);else{if(r!==st)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+r);h=-o/(o-s),u=-o*s/(o-s)}return a[0]=l,a[4]=0,a[8]=c,a[12]=0,a[1]=0,a[5]=g,a[9]=d,a[13]=0,a[2]=0,a[6]=0,a[10]=h,a[14]=u,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this}makeOrthographic(e,t,i,n,s,o,r=2e3){const a=this.elements,l=1/(t-e),g=1/(i-n),c=1/(o-s),d=(t+e)*l,h=(i+n)*g;let u,I;if(r===nt)u=(o+s)*c,I=-2*c;else{if(r!==st)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+r);u=s*c,I=-1*c}return a[0]=2*l,a[4]=0,a[8]=0,a[12]=-d,a[1]=0,a[5]=2*g,a[9]=0,a[13]=-h,a[2]=0,a[6]=0,a[10]=I,a[14]=-u,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this}equals(e){const t=this.elements,i=e.elements;for(let n=0;n<16;n++)if(t[n]!==i[n])return!1;return!0}fromArray(e,t=0){for(let i=0;i<16;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],e}}const wi=new Qt,Si=new Bi,Gi=new Qt(0,0,0),Mi=new Qt(1,1,1),Ri=new Qt,Ti=new Qt,Zi=new Qt,Vi=new Bi,Wi=new Ut;class Ei{constructor(e=0,t=0,i=0,n=Ei.DEFAULT_ORDER){this.isEuler=!0,this._x=e,this._y=t,this._z=i,this._order=n}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,i,n=this._order){return this._x=e,this._y=t,this._z=i,this._order=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,i=!0){const n=e.elements,s=n[0],o=n[4],r=n[8],a=n[1],l=n[5],g=n[9],c=n[2],d=n[6],h=n[10];switch(t){case"XYZ":this._y=Math.asin(dt(r,-1,1)),Math.abs(r)<.9999999?(this._x=Math.atan2(-g,h),this._z=Math.atan2(-o,s)):(this._x=Math.atan2(d,l),this._z=0);break;case"YXZ":this._x=Math.asin(-dt(g,-1,1)),Math.abs(g)<.9999999?(this._y=Math.atan2(r,h),this._z=Math.atan2(a,l)):(this._y=Math.atan2(-c,s),this._z=0);break;case"ZXY":this._x=Math.asin(dt(d,-1,1)),Math.abs(d)<.9999999?(this._y=Math.atan2(-c,h),this._z=Math.atan2(-o,l)):(this._y=0,this._z=Math.atan2(a,s));break;case"ZYX":this._y=Math.asin(-dt(c,-1,1)),Math.abs(c)<.9999999?(this._x=Math.atan2(d,h),this._z=Math.atan2(a,s)):(this._x=0,this._z=Math.atan2(-o,l));break;case"YZX":this._z=Math.asin(dt(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-g,l),this._y=Math.atan2(-c,s)):(this._x=0,this._y=Math.atan2(r,h));break;case"XZY":this._z=Math.asin(-dt(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(d,l),this._y=Math.atan2(r,s)):(this._x=Math.atan2(-g,h),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this._order=t,!0===i&&this._onChangeCallback(),this}setFromQuaternion(e,t,i){return Vi.makeRotationFromQuaternion(e),this.setFromRotationMatrix(Vi,t,i)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return Wi.setFromEuler(this),this.setFromQuaternion(Wi,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}Ei.DEFAULT_ORDER="XYZ";class Ni{constructor(){this.mask=1}set(e){this.mask=(1<<e|0)>>>0}enable(e){this.mask|=1<<e|0}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e|0}disable(e){this.mask&=~(1<<e|0)}disableAll(){this.mask=0}test(e){return 0!=(this.mask&e.mask)}isEnabled(e){return 0!=(this.mask&(1<<e|0))}}let Fi=0;const Xi=new Qt,Hi=new Ut,zi=new Bi,Li=new Qt,Di=new Qt,Ki=new Qt,Yi=new Ut,Pi=new Qt(1,0,0),ki=new Qt(0,1,0),Oi=new Qt(0,0,1),Ui={type:"added"},Qi={type:"removed"};class Ji extends ot{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:Fi++}),this.uuid=ct(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Ji.DEFAULT_UP.clone();const e=new Qt,t=new Ei,i=new Ut,n=new Qt(1,1,1);t._onChange((function(){i.setFromEuler(t,!1)})),i._onChange((function(){t.setFromQuaternion(i,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:n},modelViewMatrix:{value:new Bi},normalMatrix:{value:new yt}}),this.matrix=new Bi,this.matrixWorld=new Bi,this.matrixAutoUpdate=Ji.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.matrixWorldAutoUpdate=Ji.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.layers=new Ni,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return Hi.setFromAxisAngle(e,t),this.quaternion.multiply(Hi),this}rotateOnWorldAxis(e,t){return Hi.setFromAxisAngle(e,t),this.quaternion.premultiply(Hi),this}rotateX(e){return this.rotateOnAxis(Pi,e)}rotateY(e){return this.rotateOnAxis(ki,e)}rotateZ(e){return this.rotateOnAxis(Oi,e)}translateOnAxis(e,t){return Xi.copy(e).applyQuaternion(this.quaternion),this.position.add(Xi.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(Pi,e)}translateY(e){return this.translateOnAxis(ki,e)}translateZ(e){return this.translateOnAxis(Oi,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(zi.copy(this.matrixWorld).invert())}lookAt(e,t,i){e.isVector3?Li.copy(e):Li.set(e,t,i);const n=this.parent;this.updateWorldMatrix(!0,!1),Di.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?zi.lookAt(Di,Li,this.up):zi.lookAt(Li,Di,this.up),this.quaternion.setFromRotationMatrix(zi),n&&(zi.extractRotation(n.matrixWorld),Hi.setFromRotationMatrix(zi),this.quaternion.premultiply(Hi.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(null!==e.parent&&e.parent.remove(e),e.parent=this,this.children.push(e),e.dispatchEvent(Ui)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(Qi)),this}removeFromParent(){const e=this.parent;return null!==e&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),zi.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),zi.multiply(e.parent.matrixWorld)),e.applyMatrix4(zi),this.add(e),e.updateWorldMatrix(!1,!0),this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;for(let i=0,n=this.children.length;i<n;i++){const n=this.children[i].getObjectByProperty(e,t);if(void 0!==n)return n}}getObjectsByProperty(e,t){let i=[];this[e]===t&&i.push(this);for(let n=0,s=this.children.length;n<s;n++){const s=this.children[n].getObjectsByProperty(e,t);s.length>0&&(i=i.concat(s))}return i}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Di,e,Ki),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Di,Yi,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(e){e(this);const t=this.children;for(let i=0,n=t.length;i<n;i++)t[i].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);const t=this.children;for(let i=0,n=t.length;i<n;i++)t[i].traverseVisible(e)}traverseAncestors(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let i=0,n=t.length;i<n;i++){const n=t[i];!0!==n.matrixWorldAutoUpdate&&!0!==e||n.updateMatrixWorld(e)}}updateWorldMatrix(e,t){const i=this.parent;if(!0===e&&null!==i&&!0===i.matrixWorldAutoUpdate&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===t){const e=this.children;for(let t=0,i=e.length;t<i;t++){const i=e[t];!0===i.matrixWorldAutoUpdate&&i.updateWorldMatrix(!1,!0)}}}toJSON(e){const t=void 0===e||"string"==typeof e,i={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},i.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const n={};function s(t,i){return void 0===t[i.uuid]&&(t[i.uuid]=i.toJSON(e)),i.uuid}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),n.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),this.isInstancedMesh&&(n.type="InstancedMesh",n.count=this.count,n.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(n.instanceColor=this.instanceColor.toJSON())),this.isScene)this.background&&(this.background.isColor?n.background=this.background.toJSON():this.background.isTexture&&(n.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(n.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){n.geometry=s(e.geometries,this.geometry);const t=this.geometry.parameters;if(void 0!==t&&void 0!==t.shapes){const i=t.shapes;if(Array.isArray(i))for(let t=0,n=i.length;t<n;t++){const n=i[t];s(e.shapes,n)}else s(e.shapes,i)}}if(this.isSkinnedMesh&&(n.bindMode=this.bindMode,n.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(s(e.skeletons,this.skeleton),n.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const t=[];for(let i=0,n=this.material.length;i<n;i++)t.push(s(e.materials,this.material[i]));n.material=t}else n.material=s(e.materials,this.material);if(this.children.length>0){n.children=[];for(let t=0;t<this.children.length;t++)n.children.push(this.children[t].toJSON(e).object)}if(this.animations.length>0){n.animations=[];for(let t=0;t<this.animations.length;t++){const i=this.animations[t];n.animations.push(s(e.animations,i))}}if(t){const t=o(e.geometries),n=o(e.materials),s=o(e.textures),r=o(e.images),a=o(e.shapes),l=o(e.skeletons),g=o(e.animations),c=o(e.nodes);t.length>0&&(i.geometries=t),n.length>0&&(i.materials=n),s.length>0&&(i.textures=s),r.length>0&&(i.images=r),a.length>0&&(i.shapes=a),l.length>0&&(i.skeletons=l),g.length>0&&(i.animations=g),c.length>0&&(i.nodes=c)}return i.object=n,i;function o(e){const t=[];for(const i in e){const n=e[i];delete n.metadata,t.push(n)}return t}}clone(e){return(new this.constructor).copy(this,e)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(let i=0;i<e.children.length;i++){const t=e.children[i];this.add(t.clone())}return this}}Ji.DEFAULT_UP=new Qt(0,1,0),Ji.DEFAULT_MATRIX_AUTO_UPDATE=!0,Ji.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const ji=new Qt,qi=new Qt,$i=new Qt,en=new Qt,tn=new Qt,nn=new Qt,sn=new Qt,on=new Qt,rn=new Qt,an=new Qt;let ln=!1;class gn{constructor(e=new Qt,t=new Qt,i=new Qt){this.a=e,this.b=t,this.c=i}static getNormal(e,t,i,n){n.subVectors(i,t),ji.subVectors(e,t),n.cross(ji);const s=n.lengthSq();return s>0?n.multiplyScalar(1/Math.sqrt(s)):n.set(0,0,0)}static getBarycoord(e,t,i,n,s){ji.subVectors(n,t),qi.subVectors(i,t),$i.subVectors(e,t);const o=ji.dot(ji),r=ji.dot(qi),a=ji.dot($i),l=qi.dot(qi),g=qi.dot($i),c=o*l-r*r;if(0===c)return s.set(-2,-1,-1);const d=1/c,h=(l*a-r*g)*d,u=(o*g-r*a)*d;return s.set(1-h-u,u,h)}static containsPoint(e,t,i,n){return this.getBarycoord(e,t,i,n,en),en.x>=0&&en.y>=0&&en.x+en.y<=1}static getUV(e,t,i,n,s,o,r,a){return!1===ln&&(console.warn("THREE.Triangle.getUV() has been renamed to THREE.Triangle.getInterpolation()."),ln=!0),this.getInterpolation(e,t,i,n,s,o,r,a)}static getInterpolation(e,t,i,n,s,o,r,a){return this.getBarycoord(e,t,i,n,en),a.setScalar(0),a.addScaledVector(s,en.x),a.addScaledVector(o,en.y),a.addScaledVector(r,en.z),a}static isFrontFacing(e,t,i,n){return ji.subVectors(i,t),qi.subVectors(e,t),ji.cross(qi).dot(n)<0}set(e,t,i){return this.a.copy(e),this.b.copy(t),this.c.copy(i),this}setFromPointsAndIndices(e,t,i,n){return this.a.copy(e[t]),this.b.copy(e[i]),this.c.copy(e[n]),this}setFromAttributeAndIndices(e,t,i,n){return this.a.fromBufferAttribute(e,t),this.b.fromBufferAttribute(e,i),this.c.fromBufferAttribute(e,n),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return ji.subVectors(this.c,this.b),qi.subVectors(this.a,this.b),.5*ji.cross(qi).length()}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return gn.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return gn.getBarycoord(e,this.a,this.b,this.c,t)}getUV(e,t,i,n,s){return!1===ln&&(console.warn("THREE.Triangle.getUV() has been renamed to THREE.Triangle.getInterpolation()."),ln=!0),gn.getInterpolation(e,this.a,this.b,this.c,t,i,n,s)}getInterpolation(e,t,i,n,s){return gn.getInterpolation(e,this.a,this.b,this.c,t,i,n,s)}containsPoint(e){return gn.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return gn.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){const i=this.a,n=this.b,s=this.c;let o,r;tn.subVectors(n,i),nn.subVectors(s,i),on.subVectors(e,i);const a=tn.dot(on),l=nn.dot(on);if(a<=0&&l<=0)return t.copy(i);rn.subVectors(e,n);const g=tn.dot(rn),c=nn.dot(rn);if(g>=0&&c<=g)return t.copy(n);const d=a*c-g*l;if(d<=0&&a>=0&&g<=0)return o=a/(a-g),t.copy(i).addScaledVector(tn,o);an.subVectors(e,s);const h=tn.dot(an),u=nn.dot(an);if(u>=0&&h<=u)return t.copy(s);const I=h*l-a*u;if(I<=0&&l>=0&&u<=0)return r=l/(l-u),t.copy(i).addScaledVector(nn,r);const p=g*u-h*c;if(p<=0&&c-g>=0&&h-u>=0)return sn.subVectors(s,n),r=(c-g)/(c-g+(h-u)),t.copy(n).addScaledVector(sn,r);const m=1/(p+I+d);return o=I*m,r=d*m,t.copy(i).addScaledVector(tn,o).addScaledVector(nn,r)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}const cn={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},dn={h:0,s:0,l:0},hn={h:0,s:0,l:0};function un(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+6*(t-e)*(2/3-i):e}class In{constructor(e,t,i){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,t,i)}set(e,t,i){if(void 0===t&&void 0===i){const t=e;t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t)}else this.setRGB(e,t,i);return this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,t=Ye){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,Zt.toWorkingColorSpace(this,t),this}setRGB(e,t,i,n=Zt.workingColorSpace){return this.r=e,this.g=t,this.b=i,Zt.toWorkingColorSpace(this,n),this}setHSL(e,t,i,n=Zt.workingColorSpace){if(e=ht(e,1),t=dt(t,0,1),i=dt(i,0,1),0===t)this.r=this.g=this.b=i;else{const n=i<=.5?i*(1+t):i+t-i*t,s=2*i-n;this.r=un(s,n,e+1/3),this.g=un(s,n,e),this.b=un(s,n,e-1/3)}return Zt.toWorkingColorSpace(this,n),this}setStyle(e,t=Ye){function i(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}let n;if(n=/^(\w+)\(([^\)]*)\)/.exec(e)){let s;const o=n[1],r=n[2];switch(o){case"rgb":case"rgba":if(s=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r))return i(s[4]),this.setRGB(Math.min(255,parseInt(s[1],10))/255,Math.min(255,parseInt(s[2],10))/255,Math.min(255,parseInt(s[3],10))/255,t);if(s=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r))return i(s[4]),this.setRGB(Math.min(100,parseInt(s[1],10))/100,Math.min(100,parseInt(s[2],10))/100,Math.min(100,parseInt(s[3],10))/100,t);break;case"hsl":case"hsla":if(s=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r))return i(s[4]),this.setHSL(parseFloat(s[1])/360,parseFloat(s[2])/100,parseFloat(s[3])/100,t);break;default:console.warn("THREE.Color: Unknown color model "+e)}}else if(n=/^\#([A-Fa-f\d]+)$/.exec(e)){const i=n[1],s=i.length;if(3===s)return this.setRGB(parseInt(i.charAt(0),16)/15,parseInt(i.charAt(1),16)/15,parseInt(i.charAt(2),16)/15,t);if(6===s)return this.setHex(parseInt(i,16),t);console.warn("THREE.Color: Invalid hex color "+e)}else if(e&&e.length>0)return this.setColorName(e,t);return this}setColorName(e,t=Ye){const i=cn[e.toLowerCase()];return void 0!==i?this.setHex(i,t):console.warn("THREE.Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=Vt(e.r),this.g=Vt(e.g),this.b=Vt(e.b),this}copyLinearToSRGB(e){return this.r=Wt(e.r),this.g=Wt(e.g),this.b=Wt(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=Ye){return Zt.fromWorkingColorSpace(pn.copy(this),e),65536*Math.round(dt(255*pn.r,0,255))+256*Math.round(dt(255*pn.g,0,255))+Math.round(dt(255*pn.b,0,255))}getHexString(e=Ye){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,t=Zt.workingColorSpace){Zt.fromWorkingColorSpace(pn.copy(this),t);const i=pn.r,n=pn.g,s=pn.b,o=Math.max(i,n,s),r=Math.min(i,n,s);let a,l;const g=(r+o)/2;if(r===o)a=0,l=0;else{const e=o-r;switch(l=g<=.5?e/(o+r):e/(2-o-r),o){case i:a=(n-s)/e+(n<s?6:0);break;case n:a=(s-i)/e+2;break;case s:a=(i-n)/e+4}a/=6}return e.h=a,e.s=l,e.l=g,e}getRGB(e,t=Zt.workingColorSpace){return Zt.fromWorkingColorSpace(pn.copy(this),t),e.r=pn.r,e.g=pn.g,e.b=pn.b,e}getStyle(e=Ye){Zt.fromWorkingColorSpace(pn.copy(this),e);const t=pn.r,i=pn.g,n=pn.b;return e!==Ye?`color(${e} ${t.toFixed(3)} ${i.toFixed(3)} ${n.toFixed(3)})`:`rgb(${Math.round(255*t)},${Math.round(255*i)},${Math.round(255*n)})`}offsetHSL(e,t,i){return this.getHSL(dn),this.setHSL(dn.h+e,dn.s+t,dn.l+i)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,i){return this.r=e.r+(t.r-e.r)*i,this.g=e.g+(t.g-e.g)*i,this.b=e.b+(t.b-e.b)*i,this}lerpHSL(e,t){this.getHSL(dn),e.getHSL(hn);const i=ut(dn.h,hn.h,t),n=ut(dn.s,hn.s,t),s=ut(dn.l,hn.l,t);return this.setHSL(i,n,s),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){const t=this.r,i=this.g,n=this.b,s=e.elements;return this.r=s[0]*t+s[3]*i+s[6]*n,this.g=s[1]*t+s[4]*i+s[7]*n,this.b=s[2]*t+s[5]*i+s[8]*n,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const pn=new In;In.NAMES=cn;let mn=0;class An extends ot{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:mn++}),this.uuid=ct(),this.name="",this.type="Material",this.blending=1,this.side=g,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=d,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new In(0,0,0),this.blendAlpha=0,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=qe,this.stencilZFail=qe,this.stencilZPass=qe,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBuild(){}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(void 0!==e)for(const t in e){const i=e[t];if(void 0===i){console.warn(`THREE.Material: parameter '${t}' has value of undefined.`);continue}const n=this[t];void 0!==n?n&&n.isColor?n.set(i):n&&n.isVector3&&i&&i.isVector3?n.copy(i):this[t]=i:console.warn(`THREE.Material: '${t}' is not a property of THREE.${this.type}.`)}}toJSON(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});const i={metadata:{version:4.6,type:"Material",generator:"Material.toJSON"}};function n(e){const t=[];for(const i in e){const n=e[i];delete n.metadata,t.push(n)}return t}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),void 0!==this.sheen&&(i.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(i.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(i.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),this.emissiveIntensity&&1!==this.emissiveIntensity&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(i.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(i.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearcoat&&(i.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.iridescence&&(i.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(i.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(i.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(i.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(i.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),void 0!==this.anisotropy&&(i.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(i.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(i.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(e).uuid,i.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(e).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(e).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(e).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(e).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(i.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(i.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine&&(i.combine=this.combine)),void 0!==this.envMapIntensity&&(i.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(i.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(i.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(i.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(i.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(i.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(i.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(i.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(i.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(i.size=this.size),null!==this.shadowSide&&(i.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(i.blending=this.blending),this.side!==g&&(i.side=this.side),!0===this.vertexColors&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=!0),204!==this.blendSrc&&(i.blendSrc=this.blendSrc),205!==this.blendDst&&(i.blendDst=this.blendDst),this.blendEquation!==d&&(i.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(i.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(i.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(i.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(i.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(i.blendAlpha=this.blendAlpha),3!==this.depthFunc&&(i.depthFunc=this.depthFunc),!1===this.depthTest&&(i.depthTest=this.depthTest),!1===this.depthWrite&&(i.depthWrite=this.depthWrite),!1===this.colorWrite&&(i.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(i.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(i.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(i.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(i.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==qe&&(i.stencilFail=this.stencilFail),this.stencilZFail!==qe&&(i.stencilZFail=this.stencilZFail),this.stencilZPass!==qe&&(i.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(i.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(i.rotation=this.rotation),!0===this.polygonOffset&&(i.polygonOffset=!0),0!==this.polygonOffsetFactor&&(i.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(i.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(i.linewidth=this.linewidth),void 0!==this.dashSize&&(i.dashSize=this.dashSize),void 0!==this.gapSize&&(i.gapSize=this.gapSize),void 0!==this.scale&&(i.scale=this.scale),!0===this.dithering&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.alphaHash&&(i.alphaHash=!0),!0===this.alphaToCoverage&&(i.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=!0),!0===this.forceSinglePass&&(i.forceSinglePass=!0),!0===this.wireframe&&(i.wireframe=!0),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(i.flatShading=!0),!1===this.visible&&(i.visible=!1),!1===this.toneMapped&&(i.toneMapped=!1),!1===this.fog&&(i.fog=!1),Object.keys(this.userData).length>0&&(i.userData=this.userData),t){const t=n(e.textures),s=n(e.images);t.length>0&&(i.textures=t),s.length>0&&(i.images=s)}return i}clone(){return(new this.constructor).copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let i=null;if(null!==t){const e=t.length;i=new Array(e);for(let n=0;n!==e;++n)i[n]=t[n].clone()}return this.clippingPlanes=i,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}}class Cn extends An{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new In(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=I,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}const fn=bn();function bn(){const e=new ArrayBuffer(4),t=new Float32Array(e),i=new Uint32Array(e),n=new Uint32Array(512),s=new Uint32Array(512);for(let l=0;l<256;++l){const e=l-127;e<-27?(n[l]=0,n[256|l]=32768,s[l]=24,s[256|l]=24):e<-14?(n[l]=1024>>-e-14,n[256|l]=1024>>-e-14|32768,s[l]=-e-1,s[256|l]=-e-1):e<=15?(n[l]=e+15<<10,n[256|l]=e+15<<10|32768,s[l]=13,s[256|l]=13):e<128?(n[l]=31744,n[256|l]=64512,s[l]=24,s[256|l]=24):(n[l]=31744,n[256|l]=64512,s[l]=13,s[256|l]=13)}const o=new Uint32Array(2048),r=new Uint32Array(64),a=new Uint32Array(64);for(let l=1;l<1024;++l){let e=l<<13,t=0;for(;0==(8388608&e);)e<<=1,t-=8388608;e&=-8388609,t+=947912704,o[l]=e|t}for(let l=1024;l<2048;++l)o[l]=939524096+(l-1024<<13);for(let l=1;l<31;++l)r[l]=l<<23;r[31]=1199570944,r[32]=2147483648;for(let l=33;l<63;++l)r[l]=2147483648+(l-32<<23);r[63]=3347054592;for(let l=1;l<64;++l)32!==l&&(a[l]=1024);return{floatView:t,uint32View:i,baseTable:n,shiftTable:s,mantissaTable:o,exponentTable:r,offsetTable:a}}function yn(e){Math.abs(e)>65504&&console.warn("THREE.DataUtils.toHalfFloat(): Value out of range."),e=dt(e,-65504,65504),fn.floatView[0]=e;const t=fn.uint32View[0],i=t>>23&511;return fn.baseTable[i]+((8388607&t)>>fn.shiftTable[i])}function _n(e){const t=e>>10;return fn.uint32View[0]=fn.mantissaTable[fn.offsetTable[t]+(1023&e)]+fn.exponentTable[t],fn.floatView[0]}const vn=new Qt,xn=new bt;class Bn{constructor(e,t,i=!1){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=i,this.usage=$e,this.updateRange={offset:0,count:-1},this.gpuType=K,this.version=0}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,t,i){e*=this.itemSize,i*=t.itemSize;for(let n=0,s=this.itemSize;n<s;n++)this.array[e+n]=t.array[i+n];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(2===this.itemSize)for(let t=0,i=this.count;t<i;t++)xn.fromBufferAttribute(this,t),xn.applyMatrix3(e),this.setXY(t,xn.x,xn.y);else if(3===this.itemSize)for(let t=0,i=this.count;t<i;t++)vn.fromBufferAttribute(this,t),vn.applyMatrix3(e),this.setXYZ(t,vn.x,vn.y,vn.z);return this}applyMatrix4(e){for(let t=0,i=this.count;t<i;t++)vn.fromBufferAttribute(this,t),vn.applyMatrix4(e),this.setXYZ(t,vn.x,vn.y,vn.z);return this}applyNormalMatrix(e){for(let t=0,i=this.count;t<i;t++)vn.fromBufferAttribute(this,t),vn.applyNormalMatrix(e),this.setXYZ(t,vn.x,vn.y,vn.z);return this}transformDirection(e){for(let t=0,i=this.count;t<i;t++)vn.fromBufferAttribute(this,t),vn.transformDirection(e),this.setXYZ(t,vn.x,vn.y,vn.z);return this}set(e,t=0){return this.array.set(e,t),this}getComponent(e,t){let i=this.array[e*this.itemSize+t];return this.normalized&&(i=At(i,this.array)),i}setComponent(e,t,i){return this.normalized&&(i=Ct(i,this.array)),this.array[e*this.itemSize+t]=i,this}getX(e){let t=this.array[e*this.itemSize];return this.normalized&&(t=At(t,this.array)),t}setX(e,t){return this.normalized&&(t=Ct(t,this.array)),this.array[e*this.itemSize]=t,this}getY(e){let t=this.array[e*this.itemSize+1];return this.normalized&&(t=At(t,this.array)),t}setY(e,t){return this.normalized&&(t=Ct(t,this.array)),this.array[e*this.itemSize+1]=t,this}getZ(e){let t=this.array[e*this.itemSize+2];return this.normalized&&(t=At(t,this.array)),t}setZ(e,t){return this.normalized&&(t=Ct(t,this.array)),this.array[e*this.itemSize+2]=t,this}getW(e){let t=this.array[e*this.itemSize+3];return this.normalized&&(t=At(t,this.array)),t}setW(e,t){return this.normalized&&(t=Ct(t,this.array)),this.array[e*this.itemSize+3]=t,this}setXY(e,t,i){return e*=this.itemSize,this.normalized&&(t=Ct(t,this.array),i=Ct(i,this.array)),this.array[e+0]=t,this.array[e+1]=i,this}setXYZ(e,t,i,n){return e*=this.itemSize,this.normalized&&(t=Ct(t,this.array),i=Ct(i,this.array),n=Ct(n,this.array)),this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=n,this}setXYZW(e,t,i,n,s){return e*=this.itemSize,this.normalized&&(t=Ct(t,this.array),i=Ct(i,this.array),n=Ct(n,this.array),s=Ct(s,this.array)),this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=n,this.array[e+3]=s,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(e.name=this.name),this.usage!==$e&&(e.usage=this.usage),0===this.updateRange.offset&&-1===this.updateRange.count||(e.updateRange=this.updateRange),e}}class wn extends Bn{constructor(e,t,i){super(new Uint16Array(e),t,i)}}class Sn extends Bn{constructor(e,t,i){super(new Uint32Array(e),t,i)}}class Gn extends Bn{constructor(e,t,i){super(new Uint16Array(e),t,i),this.isFloat16BufferAttribute=!0}getX(e){let t=_n(this.array[e*this.itemSize]);return this.normalized&&(t=At(t,this.array)),t}setX(e,t){return this.normalized&&(t=Ct(t,this.array)),this.array[e*this.itemSize]=yn(t),this}getY(e){let t=_n(this.array[e*this.itemSize+1]);return this.normalized&&(t=At(t,this.array)),t}setY(e,t){return this.normalized&&(t=Ct(t,this.array)),this.array[e*this.itemSize+1]=yn(t),this}getZ(e){let t=_n(this.array[e*this.itemSize+2]);return this.normalized&&(t=At(t,this.array)),t}setZ(e,t){return this.normalized&&(t=Ct(t,this.array)),this.array[e*this.itemSize+2]=yn(t),this}getW(e){let t=_n(this.array[e*this.itemSize+3]);return this.normalized&&(t=At(t,this.array)),t}setW(e,t){return this.normalized&&(t=Ct(t,this.array)),this.array[e*this.itemSize+3]=yn(t),this}setXY(e,t,i){return e*=this.itemSize,this.normalized&&(t=Ct(t,this.array),i=Ct(i,this.array)),this.array[e+0]=yn(t),this.array[e+1]=yn(i),this}setXYZ(e,t,i,n){return e*=this.itemSize,this.normalized&&(t=Ct(t,this.array),i=Ct(i,this.array),n=Ct(n,this.array)),this.array[e+0]=yn(t),this.array[e+1]=yn(i),this.array[e+2]=yn(n),this}setXYZW(e,t,i,n,s){return e*=this.itemSize,this.normalized&&(t=Ct(t,this.array),i=Ct(i,this.array),n=Ct(n,this.array),s=Ct(s,this.array)),this.array[e+0]=yn(t),this.array[e+1]=yn(i),this.array[e+2]=yn(n),this.array[e+3]=yn(s),this}}class Mn extends Bn{constructor(e,t,i){super(new Float32Array(e),t,i)}}let Rn=0;const Tn=new Bi,Zn=new Ji,Vn=new Qt,Wn=new qt,En=new qt,Nn=new Qt;class Fn extends ot{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:Rn++}),this.uuid=ct(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(vt(e)?Sn:wn)(e,1):this.index=e,this}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return void 0!==this.attributes[e]}addGroup(e,t,i=0){this.groups.push({start:e,count:t,materialIndex:i})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){const t=this.attributes.position;void 0!==t&&(t.applyMatrix4(e),t.needsUpdate=!0);const i=this.attributes.normal;if(void 0!==i){const t=(new yt).getNormalMatrix(e);i.applyNormalMatrix(t),i.needsUpdate=!0}const n=this.attributes.tangent;return void 0!==n&&(n.transformDirection(e),n.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(e){return Tn.makeRotationFromQuaternion(e),this.applyMatrix4(Tn),this}rotateX(e){return Tn.makeRotationX(e),this.applyMatrix4(Tn),this}rotateY(e){return Tn.makeRotationY(e),this.applyMatrix4(Tn),this}rotateZ(e){return Tn.makeRotationZ(e),this.applyMatrix4(Tn),this}translate(e,t,i){return Tn.makeTranslation(e,t,i),this.applyMatrix4(Tn),this}scale(e,t,i){return Tn.makeScale(e,t,i),this.applyMatrix4(Tn),this}lookAt(e){return Zn.lookAt(e),Zn.updateMatrix(),this.applyMatrix4(Zn.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(Vn).negate(),this.translate(Vn.x,Vn.y,Vn.z),this}setFromPoints(e){const t=[];for(let i=0,n=e.length;i<n;i++){const n=e[i];t.push(n.x,n.y,n.z||0)}return this.setAttribute("position",new Mn(t,3)),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new qt);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingBox.set(new Qt(-1/0,-1/0,-1/0),new Qt(1/0,1/0,1/0));if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),t)for(let i=0,n=t.length;i<n;i++){const e=t[i];Wn.setFromBufferAttribute(e),this.morphTargetsRelative?(Nn.addVectors(this.boundingBox.min,Wn.min),this.boundingBox.expandByPoint(Nn),Nn.addVectors(this.boundingBox.max,Wn.max),this.boundingBox.expandByPoint(Nn)):(this.boundingBox.expandByPoint(Wn.min),this.boundingBox.expandByPoint(Wn.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new mi);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingSphere.set(new Qt,1/0);if(e){const i=this.boundingSphere.center;if(Wn.setFromBufferAttribute(e),t)for(let e=0,s=t.length;e<s;e++){const i=t[e];En.setFromBufferAttribute(i),this.morphTargetsRelative?(Nn.addVectors(Wn.min,En.min),Wn.expandByPoint(Nn),Nn.addVectors(Wn.max,En.max),Wn.expandByPoint(Nn)):(Wn.expandByPoint(En.min),Wn.expandByPoint(En.max))}Wn.getCenter(i);let n=0;for(let t=0,s=e.count;t<s;t++)Nn.fromBufferAttribute(e,t),n=Math.max(n,i.distanceToSquared(Nn));if(t)for(let s=0,o=t.length;s<o;s++){const o=t[s],r=this.morphTargetsRelative;for(let t=0,s=o.count;t<s;t++)Nn.fromBufferAttribute(o,t),r&&(Vn.fromBufferAttribute(e,t),Nn.add(Vn)),n=Math.max(n,i.distanceToSquared(Nn))}this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const e=this.index,t=this.attributes;if(null===e||void 0===t.position||void 0===t.normal||void 0===t.uv)return void console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const i=e.array,n=t.position.array,s=t.normal.array,o=t.uv.array,r=n.length/3;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new Bn(new Float32Array(4*r),4));const a=this.getAttribute("tangent").array,l=[],g=[];for(let B=0;B<r;B++)l[B]=new Qt,g[B]=new Qt;const c=new Qt,d=new Qt,h=new Qt,u=new bt,I=new bt,p=new bt,m=new Qt,A=new Qt;function C(e,t,i){c.fromArray(n,3*e),d.fromArray(n,3*t),h.fromArray(n,3*i),u.fromArray(o,2*e),I.fromArray(o,2*t),p.fromArray(o,2*i),d.sub(c),h.sub(c),I.sub(u),p.sub(u);const s=1/(I.x*p.y-p.x*I.y);isFinite(s)&&(m.copy(d).multiplyScalar(p.y).addScaledVector(h,-I.y).multiplyScalar(s),A.copy(h).multiplyScalar(I.x).addScaledVector(d,-p.x).multiplyScalar(s),l[e].add(m),l[t].add(m),l[i].add(m),g[e].add(A),g[t].add(A),g[i].add(A))}let f=this.groups;0===f.length&&(f=[{start:0,count:i.length}]);for(let B=0,w=f.length;B<w;++B){const e=f[B],t=e.start;for(let n=t,s=t+e.count;n<s;n+=3)C(i[n+0],i[n+1],i[n+2])}const b=new Qt,y=new Qt,_=new Qt,v=new Qt;function x(e){_.fromArray(s,3*e),v.copy(_);const t=l[e];b.copy(t),b.sub(_.multiplyScalar(_.dot(t))).normalize(),y.crossVectors(v,t);const i=y.dot(g[e])<0?-1:1;a[4*e]=b.x,a[4*e+1]=b.y,a[4*e+2]=b.z,a[4*e+3]=i}for(let B=0,w=f.length;B<w;++B){const e=f[B],t=e.start;for(let n=t,s=t+e.count;n<s;n+=3)x(i[n+0]),x(i[n+1]),x(i[n+2])}}computeVertexNormals(){const e=this.index,t=this.getAttribute("position");if(void 0!==t){let i=this.getAttribute("normal");if(void 0===i)i=new Bn(new Float32Array(3*t.count),3),this.setAttribute("normal",i);else for(let e=0,t=i.count;e<t;e++)i.setXYZ(e,0,0,0);const n=new Qt,s=new Qt,o=new Qt,r=new Qt,a=new Qt,l=new Qt,g=new Qt,c=new Qt;if(e)for(let d=0,h=e.count;d<h;d+=3){const h=e.getX(d+0),u=e.getX(d+1),I=e.getX(d+2);n.fromBufferAttribute(t,h),s.fromBufferAttribute(t,u),o.fromBufferAttribute(t,I),g.subVectors(o,s),c.subVectors(n,s),g.cross(c),r.fromBufferAttribute(i,h),a.fromBufferAttribute(i,u),l.fromBufferAttribute(i,I),r.add(g),a.add(g),l.add(g),i.setXYZ(h,r.x,r.y,r.z),i.setXYZ(u,a.x,a.y,a.z),i.setXYZ(I,l.x,l.y,l.z)}else for(let e=0,d=t.count;e<d;e+=3)n.fromBufferAttribute(t,e+0),s.fromBufferAttribute(t,e+1),o.fromBufferAttribute(t,e+2),g.subVectors(o,s),c.subVectors(n,s),g.cross(c),i.setXYZ(e+0,g.x,g.y,g.z),i.setXYZ(e+1,g.x,g.y,g.z),i.setXYZ(e+2,g.x,g.y,g.z);this.normalizeNormals(),i.needsUpdate=!0}}normalizeNormals(){const e=this.attributes.normal;for(let t=0,i=e.count;t<i;t++)Nn.fromBufferAttribute(e,t),Nn.normalize(),e.setXYZ(t,Nn.x,Nn.y,Nn.z)}toNonIndexed(){function e(e,t){const i=e.array,n=e.itemSize,s=e.normalized,o=new i.constructor(t.length*n);let r=0,a=0;for(let l=0,g=t.length;l<g;l++){r=e.isInterleavedBufferAttribute?t[l]*e.data.stride+e.offset:t[l]*n;for(let e=0;e<n;e++)o[a++]=i[r++]}return new Bn(o,n,s)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const t=new Fn,i=this.index.array,n=this.attributes;for(const r in n){const s=e(n[r],i);t.setAttribute(r,s)}const s=this.morphAttributes;for(const r in s){const n=[],o=s[r];for(let t=0,s=o.length;t<s;t++){const s=e(o[t],i);n.push(s)}t.morphAttributes[r]=n}t.morphTargetsRelative=this.morphTargetsRelative;const o=this.groups;for(let r=0,a=o.length;r<a;r++){const e=o[r];t.addGroup(e.start,e.count,e.materialIndex)}return t}toJSON(){const e={metadata:{version:4.6,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){const t=this.parameters;for(const i in t)void 0!==t[i]&&(e[i]=t[i]);return e}e.data={attributes:{}};const t=this.index;null!==t&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const i=this.attributes;for(const a in i){const t=i[a];e.data.attributes[a]=t.toJSON(e.data)}const n={};let s=!1;for(const a in this.morphAttributes){const t=this.morphAttributes[a],i=[];for(let n=0,s=t.length;n<s;n++){const s=t[n];i.push(s.toJSON(e.data))}i.length>0&&(n[a]=i,s=!0)}s&&(e.data.morphAttributes=n,e.data.morphTargetsRelative=this.morphTargetsRelative);const o=this.groups;o.length>0&&(e.data.groups=JSON.parse(JSON.stringify(o)));const r=this.boundingSphere;return null!==r&&(e.data.boundingSphere={center:r.center.toArray(),radius:r.radius}),e}clone(){return(new this.constructor).copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const i=e.index;null!==i&&this.setIndex(i.clone(t));const n=e.attributes;for(const l in n){const e=n[l];this.setAttribute(l,e.clone(t))}const s=e.morphAttributes;for(const l in s){const e=[],i=s[l];for(let n=0,s=i.length;n<s;n++)e.push(i[n].clone(t));this.morphAttributes[l]=e}this.morphTargetsRelative=e.morphTargetsRelative;const o=e.groups;for(let l=0,g=o.length;l<g;l++){const e=o[l];this.addGroup(e.start,e.count,e.materialIndex)}const r=e.boundingBox;null!==r&&(this.boundingBox=r.clone());const a=e.boundingSphere;return null!==a&&(this.boundingSphere=a.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const Xn=new Bi,Hn=new xi,zn=new mi,Ln=new Qt,Dn=new Qt,Kn=new Qt,Yn=new Qt,Pn=new Qt,kn=new Qt,On=new bt,Un=new bt,Qn=new bt,Jn=new Qt,jn=new Qt,qn=new Qt,$n=new Qt,es=new Qt;class ts extends Ji{constructor(e=new Fn,t=new Cn){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const i=e[t[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=i.length;e<t;e++){const t=i[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}getVertexPosition(e,t){const i=this.geometry,n=i.attributes.position,s=i.morphAttributes.position,o=i.morphTargetsRelative;t.fromBufferAttribute(n,e);const r=this.morphTargetInfluences;if(s&&r){kn.set(0,0,0);for(let i=0,n=s.length;i<n;i++){const n=r[i],a=s[i];0!==n&&(Pn.fromBufferAttribute(a,e),o?kn.addScaledVector(Pn,n):kn.addScaledVector(Pn.sub(t),n))}t.add(kn)}return t}raycast(e,t){const i=this.geometry,n=this.material,s=this.matrixWorld;if(void 0!==n){if(null===i.boundingSphere&&i.computeBoundingSphere(),zn.copy(i.boundingSphere),zn.applyMatrix4(s),Hn.copy(e.ray).recast(e.near),!1===zn.containsPoint(Hn.origin)){if(null===Hn.intersectSphere(zn,Ln))return;if(Hn.origin.distanceToSquared(Ln)>(e.far-e.near)**2)return}Xn.copy(s).invert(),Hn.copy(e.ray).applyMatrix4(Xn),null!==i.boundingBox&&!1===Hn.intersectsBox(i.boundingBox)||this._computeIntersections(e,t,Hn)}}_computeIntersections(e,t,i){let n;const s=this.geometry,o=this.material,r=s.index,a=s.attributes.position,l=s.attributes.uv,g=s.attributes.uv1,c=s.attributes.normal,d=s.groups,h=s.drawRange;if(null!==r)if(Array.isArray(o))for(let u=0,I=d.length;u<I;u++){const s=d[u],a=o[s.materialIndex];for(let o=Math.max(s.start,h.start),d=Math.min(r.count,Math.min(s.start+s.count,h.start+h.count));o<d;o+=3){n=is(this,a,e,i,l,g,c,r.getX(o),r.getX(o+1),r.getX(o+2)),n&&(n.faceIndex=Math.floor(o/3),n.face.materialIndex=s.materialIndex,t.push(n))}}else{for(let s=Math.max(0,h.start),a=Math.min(r.count,h.start+h.count);s<a;s+=3){n=is(this,o,e,i,l,g,c,r.getX(s),r.getX(s+1),r.getX(s+2)),n&&(n.faceIndex=Math.floor(s/3),t.push(n))}}else if(void 0!==a)if(Array.isArray(o))for(let u=0,I=d.length;u<I;u++){const s=d[u],r=o[s.materialIndex];for(let o=Math.max(s.start,h.start),d=Math.min(a.count,Math.min(s.start+s.count,h.start+h.count));o<d;o+=3){n=is(this,r,e,i,l,g,c,o,o+1,o+2),n&&(n.faceIndex=Math.floor(o/3),n.face.materialIndex=s.materialIndex,t.push(n))}}else{for(let s=Math.max(0,h.start),r=Math.min(a.count,h.start+h.count);s<r;s+=3){n=is(this,o,e,i,l,g,c,s,s+1,s+2),n&&(n.faceIndex=Math.floor(s/3),t.push(n))}}}}function is(e,t,i,n,s,o,r,a,l,d){e.getVertexPosition(a,Dn),e.getVertexPosition(l,Kn),e.getVertexPosition(d,Yn);const h=function(e,t,i,n,s,o,r,a){let l;if(l=t.side===c?n.intersectTriangle(r,o,s,!0,a):n.intersectTriangle(s,o,r,t.side===g,a),null===l)return null;es.copy(a),es.applyMatrix4(e.matrixWorld);const d=i.ray.origin.distanceTo(es);return d<i.near||d>i.far?null:{distance:d,point:es.clone(),object:e}}(e,t,i,n,Dn,Kn,Yn,$n);if(h){s&&(On.fromBufferAttribute(s,a),Un.fromBufferAttribute(s,l),Qn.fromBufferAttribute(s,d),h.uv=gn.getInterpolation($n,Dn,Kn,Yn,On,Un,Qn,new bt)),o&&(On.fromBufferAttribute(o,a),Un.fromBufferAttribute(o,l),Qn.fromBufferAttribute(o,d),h.uv1=gn.getInterpolation($n,Dn,Kn,Yn,On,Un,Qn,new bt),h.uv2=h.uv1),r&&(Jn.fromBufferAttribute(r,a),jn.fromBufferAttribute(r,l),qn.fromBufferAttribute(r,d),h.normal=gn.getInterpolation($n,Dn,Kn,Yn,Jn,jn,qn,new Qt),h.normal.dot(n.direction)>0&&h.normal.multiplyScalar(-1));const e={a:a,b:l,c:d,normal:new Qt,materialIndex:0};gn.getNormal(Dn,Kn,Yn,e.normal),h.face=e}return h}class ns extends Fn{constructor(e=1,t=1,i=1,n=1,s=1,o=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:i,widthSegments:n,heightSegments:s,depthSegments:o};const r=this;n=Math.floor(n),s=Math.floor(s),o=Math.floor(o);const a=[],l=[],g=[],c=[];let d=0,h=0;function u(e,t,i,n,s,o,u,I,p,m,A){const C=o/p,f=u/m,b=o/2,y=u/2,_=I/2,v=p+1,x=m+1;let B=0,w=0;const S=new Qt;for(let r=0;r<x;r++){const o=r*f-y;for(let a=0;a<v;a++){const d=a*C-b;S[e]=d*n,S[t]=o*s,S[i]=_,l.push(S.x,S.y,S.z),S[e]=0,S[t]=0,S[i]=I>0?1:-1,g.push(S.x,S.y,S.z),c.push(a/p),c.push(1-r/m),B+=1}}for(let r=0;r<m;r++)for(let e=0;e<p;e++){const t=d+e+v*r,i=d+e+v*(r+1),n=d+(e+1)+v*(r+1),s=d+(e+1)+v*r;a.push(t,i,s),a.push(i,n,s),w+=6}r.addGroup(h,w,A),h+=w,d+=B}u("z","y","x",-1,-1,i,t,e,o,s,0),u("z","y","x",1,-1,i,t,-e,o,s,1),u("x","z","y",1,1,e,i,t,n,o,2),u("x","z","y",1,-1,e,i,-t,n,o,3),u("x","y","z",1,-1,e,t,i,n,s,4),u("x","y","z",-1,-1,e,t,-i,n,s,5),this.setIndex(a),this.setAttribute("position",new Mn(l,3)),this.setAttribute("normal",new Mn(g,3)),this.setAttribute("uv",new Mn(c,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new ns(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function ss(e){const t={};for(const i in e){t[i]={};for(const n in e[i]){const s=e[i][n];s&&(s.isColor||s.isMatrix3||s.isMatrix4||s.isVector2||s.isVector3||s.isVector4||s.isTexture||s.isQuaternion)?s.isRenderTargetTexture?(console.warn("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),t[i][n]=null):t[i][n]=s.clone():Array.isArray(s)?t[i][n]=s.slice():t[i][n]=s}}return t}function os(e){const t={};for(let i=0;i<e.length;i++){const n=ss(e[i]);for(const e in n)t[e]=n[e]}return t}function rs(e){return null===e.getRenderTarget()?e.outputColorSpace:Zt.workingColorSpace}const as={clone:ss,merge:os};class ls extends An{constructor(e){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=ss(e.uniforms),this.uniformsGroups=function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].clone());return t}(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){const t=super.toJSON(e);t.glslVersion=this.glslVersion,t.uniforms={};for(const n in this.uniforms){const i=this.uniforms[n].value;i&&i.isTexture?t.uniforms[n]={type:"t",value:i.toJSON(e).uuid}:i&&i.isColor?t.uniforms[n]={type:"c",value:i.getHex()}:i&&i.isVector2?t.uniforms[n]={type:"v2",value:i.toArray()}:i&&i.isVector3?t.uniforms[n]={type:"v3",value:i.toArray()}:i&&i.isVector4?t.uniforms[n]={type:"v4",value:i.toArray()}:i&&i.isMatrix3?t.uniforms[n]={type:"m3",value:i.toArray()}:i&&i.isMatrix4?t.uniforms[n]={type:"m4",value:i.toArray()}:t.uniforms[n]={value:i}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t.lights=this.lights,t.clipping=this.clipping;const i={};for(const n in this.extensions)!0===this.extensions[n]&&(i[n]=!0);return Object.keys(i).length>0&&(t.extensions=i),t}}class gs extends Ji{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new Bi,this.projectionMatrix=new Bi,this.projectionMatrixInverse=new Bi,this.coordinateSystem=nt}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}class cs extends gs{constructor(e=50,t=1,i=.1,n=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=i,this.far=n,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const t=.5*this.getFilmHeight()/e;this.fov=2*gt*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(.5*lt*this.fov);return.5*this.getFilmHeight()/e}getEffectiveFOV(){return 2*gt*Math.atan(Math.tan(.5*lt*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}setViewOffset(e,t,i,n,s,o){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=n,this.view.width=s,this.view.height=o,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(.5*lt*this.fov)/this.zoom,i=2*t,n=this.aspect*i,s=-.5*n;const o=this.view;if(null!==this.view&&this.view.enabled){const e=o.fullWidth,r=o.fullHeight;s+=o.offsetX*n/e,t-=o.offsetY*i/r,n*=o.width/e,i*=o.height/r}const r=this.filmOffset;0!==r&&(s+=e*r/this.getFilmWidth()),this.projectionMatrix.makePerspective(s,s+n,t,t-i,e,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}const ds=-90;class hs extends Ji{constructor(e,t,i){super(),this.type="CubeCamera",this.renderTarget=i,this.coordinateSystem=null,this.activeMipmapLevel=0;const n=new cs(ds,1,e,t);n.layers=this.layers,this.add(n);const s=new cs(ds,1,e,t);s.layers=this.layers,this.add(s);const o=new cs(ds,1,e,t);o.layers=this.layers,this.add(o);const r=new cs(ds,1,e,t);r.layers=this.layers,this.add(r);const a=new cs(ds,1,e,t);a.layers=this.layers,this.add(a);const l=new cs(ds,1,e,t);l.layers=this.layers,this.add(l)}updateCoordinateSystem(){const e=this.coordinateSystem,t=this.children.concat(),[i,n,s,o,r,a]=t;for(const l of t)this.remove(l);if(e===nt)i.up.set(0,1,0),i.lookAt(1,0,0),n.up.set(0,1,0),n.lookAt(-1,0,0),s.up.set(0,0,-1),s.lookAt(0,1,0),o.up.set(0,0,1),o.lookAt(0,-1,0),r.up.set(0,1,0),r.lookAt(0,0,1),a.up.set(0,1,0),a.lookAt(0,0,-1);else{if(e!==st)throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+e);i.up.set(0,-1,0),i.lookAt(-1,0,0),n.up.set(0,-1,0),n.lookAt(1,0,0),s.up.set(0,0,1),s.lookAt(0,1,0),o.up.set(0,0,-1),o.lookAt(0,-1,0),r.up.set(0,-1,0),r.lookAt(0,0,1),a.up.set(0,-1,0),a.lookAt(0,0,-1)}for(const l of t)this.add(l),l.updateMatrixWorld()}update(e,t){null===this.parent&&this.updateMatrixWorld();const{renderTarget:i,activeMipmapLevel:n}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());const[s,o,r,a,l,g]=this.children,c=e.getRenderTarget(),d=e.getActiveCubeFace(),h=e.getActiveMipmapLevel(),u=e.xr.enabled;e.xr.enabled=!1;const I=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,e.setRenderTarget(i,0,n),e.render(t,s),e.setRenderTarget(i,1,n),e.render(t,o),e.setRenderTarget(i,2,n),e.render(t,r),e.setRenderTarget(i,3,n),e.render(t,a),e.setRenderTarget(i,4,n),e.render(t,l),i.texture.generateMipmaps=I,e.setRenderTarget(i,5,n),e.render(t,g),e.setRenderTarget(c,d,h),e.xr.enabled=u,i.texture.needsPMREMUpdate=!0}}class us extends Lt{constructor(e,t,i,n,s,o,r,a,l,g){super(e=void 0!==e?e:[],t=void 0!==t?t:x,i,n,s,o,r,a,l,g),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}class Is extends Yt{constructor(e=1,t={}){super(e,e,t),this.isWebGLCubeRenderTarget=!0;const i={width:e,height:e,depth:1},n=[i,i,i,i,i,i];void 0!==t.encoding&&(St("THREE.WebGLCubeRenderTarget: option.encoding has been replaced by option.colorSpace."),t.colorSpace=t.encoding===De?Ye:Ke),this.texture=new us(n,t.mapping,t.wrapS,t.wrapT,t.magFilter,t.minFilter,t.format,t.type,t.anisotropy,t.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=void 0!==t.generateMipmaps&&t.generateMipmaps,this.texture.minFilter=void 0!==t.minFilter?t.minFilter:W}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const i={uniforms:{tEquirect:{value:null}},vertexShader:"\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t"},n=new ns(5,5,5),s=new ls({name:"CubemapFromEquirect",uniforms:ss(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:c,blending:0});s.uniforms.tEquirect.value=t;const o=new ts(n,s),r=t.minFilter;t.minFilter===N&&(t.minFilter=W);return new hs(1,10,this).update(e,o),t.minFilter=r,o.geometry.dispose(),o.material.dispose(),this}clear(e,t,i,n){const s=e.getRenderTarget();for(let o=0;o<6;o++)e.setRenderTarget(this,o),e.clear(t,i,n);e.setRenderTarget(s)}}const ps=new Qt,ms=new Qt,As=new yt;class Cs{constructor(e=new Qt(1,0,0),t=0){this.isPlane=!0,this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,i,n){return this.normal.set(e,t,i),this.constant=n,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,i){const n=ps.subVectors(i,t).cross(ms.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(n,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,t){const i=e.delta(ps),n=this.normal.dot(i);if(0===n)return 0===this.distanceToPoint(e.start)?t.copy(e.start):null;const s=-(e.start.dot(this.normal)+this.constant)/n;return s<0||s>1?null:t.copy(e.start).addScaledVector(i,s)}intersectsLine(e){const t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const i=t||As.getNormalMatrix(e),n=this.coplanarPoint(ps).applyMatrix4(e),s=this.normal.applyMatrix3(i).normalize();return this.constant=-n.dot(s),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new this.constructor).copy(this)}}const fs=new mi,bs=new Qt;class ys{constructor(e=new Cs,t=new Cs,i=new Cs,n=new Cs,s=new Cs,o=new Cs){this.planes=[e,t,i,n,s,o]}set(e,t,i,n,s,o){const r=this.planes;return r[0].copy(e),r[1].copy(t),r[2].copy(i),r[3].copy(n),r[4].copy(s),r[5].copy(o),this}copy(e){const t=this.planes;for(let i=0;i<6;i++)t[i].copy(e.planes[i]);return this}setFromProjectionMatrix(e,t=2e3){const i=this.planes,n=e.elements,s=n[0],o=n[1],r=n[2],a=n[3],l=n[4],g=n[5],c=n[6],d=n[7],h=n[8],u=n[9],I=n[10],p=n[11],m=n[12],A=n[13],C=n[14],f=n[15];if(i[0].setComponents(a-s,d-l,p-h,f-m).normalize(),i[1].setComponents(a+s,d+l,p+h,f+m).normalize(),i[2].setComponents(a+o,d+g,p+u,f+A).normalize(),i[3].setComponents(a-o,d-g,p-u,f-A).normalize(),i[4].setComponents(a-r,d-c,p-I,f-C).normalize(),t===nt)i[5].setComponents(a+r,d+c,p+I,f+C).normalize();else{if(t!==st)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+t);i[5].setComponents(r,c,I,C).normalize()}return this}intersectsObject(e){if(void 0!==e.boundingSphere)null===e.boundingSphere&&e.computeBoundingSphere(),fs.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{const t=e.geometry;null===t.boundingSphere&&t.computeBoundingSphere(),fs.copy(t.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(fs)}intersectsSprite(e){return fs.center.set(0,0,0),fs.radius=.7071067811865476,fs.applyMatrix4(e.matrixWorld),this.intersectsSphere(fs)}intersectsSphere(e){const t=this.planes,i=e.center,n=-e.radius;for(let s=0;s<6;s++){if(t[s].distanceToPoint(i)<n)return!1}return!0}intersectsBox(e){const t=this.planes;for(let i=0;i<6;i++){const n=t[i];if(bs.x=n.normal.x>0?e.max.x:e.min.x,bs.y=n.normal.y>0?e.max.y:e.min.y,bs.z=n.normal.z>0?e.max.z:e.min.z,n.distanceToPoint(bs)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let i=0;i<6;i++)if(t[i].distanceToPoint(e)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}function _s(){let e=null,t=!1,i=null,n=null;function s(t,o){i(t,o),n=e.requestAnimationFrame(s)}return{start:function(){!0!==t&&null!==i&&(n=e.requestAnimationFrame(s),t=!0)},stop:function(){e.cancelAnimationFrame(n),t=!1},setAnimationLoop:function(e){i=e},setContext:function(t){e=t}}}function vs(e,t){const i=t.isWebGL2,n=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),n.get(e)},remove:function(t){t.isInterleavedBufferAttribute&&(t=t.data);const i=n.get(t);i&&(e.deleteBuffer(i.buffer),n.delete(t))},update:function(t,s){if(t.isGLBufferAttribute){const e=n.get(t);return void((!e||e.version<t.version)&&n.set(t,{buffer:t.buffer,type:t.type,bytesPerElement:t.elementSize,version:t.version}))}t.isInterleavedBufferAttribute&&(t=t.data);const o=n.get(t);void 0===o?n.set(t,function(t,n){const s=t.array,o=t.usage,r=e.createBuffer();let a;if(e.bindBuffer(n,r),e.bufferData(n,s,o),t.onUploadCallback(),s instanceof Float32Array)a=e.FLOAT;else if(s instanceof Uint16Array)if(t.isFloat16BufferAttribute){if(!i)throw new Error("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2.");a=e.HALF_FLOAT}else a=e.UNSIGNED_SHORT;else if(s instanceof Int16Array)a=e.SHORT;else if(s instanceof Uint32Array)a=e.UNSIGNED_INT;else if(s instanceof Int32Array)a=e.INT;else if(s instanceof Int8Array)a=e.BYTE;else if(s instanceof Uint8Array)a=e.UNSIGNED_BYTE;else{if(!(s instanceof Uint8ClampedArray))throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+s);a=e.UNSIGNED_BYTE}return{buffer:r,type:a,bytesPerElement:s.BYTES_PER_ELEMENT,version:t.version}}(t,s)):o.version<t.version&&(!function(t,n,s){const o=n.array,r=n.updateRange;e.bindBuffer(s,t),-1===r.count?e.bufferSubData(s,0,o):(i?e.bufferSubData(s,r.offset*o.BYTES_PER_ELEMENT,o,r.offset,r.count):e.bufferSubData(s,r.offset*o.BYTES_PER_ELEMENT,o.subarray(r.offset,r.offset+r.count)),r.count=-1),n.onUploadCallback()}(o.buffer,t,s),o.version=t.version)}}}class xs extends Fn{constructor(e=1,t=1,i=1,n=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:n};const s=e/2,o=t/2,r=Math.floor(i),a=Math.floor(n),l=r+1,g=a+1,c=e/r,d=t/a,h=[],u=[],I=[],p=[];for(let m=0;m<g;m++){const e=m*d-o;for(let t=0;t<l;t++){const i=t*c-s;u.push(i,-e,0),I.push(0,0,1),p.push(t/r),p.push(1-m/a)}}for(let m=0;m<a;m++)for(let e=0;e<r;e++){const t=e+l*m,i=e+l*(m+1),n=e+1+l*(m+1),s=e+1+l*m;h.push(t,i,s),h.push(i,n,s)}this.setIndex(h),this.setAttribute("position",new Mn(u,3)),this.setAttribute("normal",new Mn(I,3)),this.setAttribute("uv",new Mn(p,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new xs(e.width,e.height,e.widthSegments,e.heightSegments)}}const Bs={alphahash_fragment:"#ifdef USE_ALPHAHASH\n\tif ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;\n#endif",alphahash_pars_fragment:"#ifdef USE_ALPHAHASH\n\tconst float ALPHA_HASH_SCALE = 0.05;\n\tfloat hash2D( vec2 value ) {\n\t\treturn fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );\n\t}\n\tfloat hash3D( vec3 value ) {\n\t\treturn hash2D( vec2( hash2D( value.xy ), value.z ) );\n\t}\n\tfloat getAlphaHashThreshold( vec3 position ) {\n\t\tfloat maxDeriv = max(\n\t\t\tlength( dFdx( position.xyz ) ),\n\t\t\tlength( dFdy( position.xyz ) )\n\t\t);\n\t\tfloat pixScale = 1.0 / ( ALPHA_HASH_SCALE * maxDeriv );\n\t\tvec2 pixScales = vec2(\n\t\t\texp2( floor( log2( pixScale ) ) ),\n\t\t\texp2( ceil( log2( pixScale ) ) )\n\t\t);\n\t\tvec2 alpha = vec2(\n\t\t\thash3D( floor( pixScales.x * position.xyz ) ),\n\t\t\thash3D( floor( pixScales.y * position.xyz ) )\n\t\t);\n\t\tfloat lerpFactor = fract( log2( pixScale ) );\n\t\tfloat x = ( 1.0 - lerpFactor ) * alpha.x + lerpFactor * alpha.y;\n\t\tfloat a = min( lerpFactor, 1.0 - lerpFactor );\n\t\tvec3 cases = vec3(\n\t\t\tx * x / ( 2.0 * a * ( 1.0 - a ) ),\n\t\t\t( x - 0.5 * a ) / ( 1.0 - a ),\n\t\t\t1.0 - ( ( 1.0 - x ) * ( 1.0 - x ) / ( 2.0 * a * ( 1.0 - a ) ) )\n\t\t);\n\t\tfloat threshold = ( x < ( 1.0 - a ) )\n\t\t\t? ( ( x < a ) ? cases.x : cases.y )\n\t\t\t: cases.z;\n\t\treturn clamp( threshold , 1.0e-6, 1.0 );\n\t}\n#endif",alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vAlphaMapUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef USE_ALPHATEST\n\tif ( diffuseColor.a < alphaTest ) discard;\n#endif",alphatest_pars_fragment:"#ifdef USE_ALPHATEST\n\tuniform float alphaTest;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_CLEARCOAT ) \n\t\tclearcoatSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_SHEEN ) \n\t\tsheenSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometryNormal, geometryViewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex:"vec3 transformed = vec3( position );\n#ifdef USE_ALPHAHASH\n\tvPosition = vec3( position );\n#endif",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"float G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, 1.0, dotVH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n} // validated",iridescence_fragment:"#ifdef USE_IRIDESCENCE\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t 3.2404542, -0.9692660,  0.0556434,\n\t\t-1.5371385,  1.8760108, -0.2040259,\n\t\t-0.4985314,  0.0415560,  1.0572252\n\t);\n\tvec3 Fresnel0ToIor( vec3 fresnel0 ) {\n\t\tvec3 sqrtF0 = sqrt( fresnel0 );\n\t\treturn ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );\n\t}\n\tvec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );\n\t}\n\tfloat IorToFresnel0( float transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));\n\t}\n\tvec3 evalSensitivity( float OPD, vec3 shift ) {\n\t\tfloat phase = 2.0 * PI * OPD * 1.0e-9;\n\t\tvec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );\n\t\tvec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );\n\t\tvec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );\n\t\tvec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );\n\t\txyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );\n\t\txyz /= 1.0685e-7;\n\t\tvec3 rgb = XYZ_TO_REC709 * xyz;\n\t\treturn rgb;\n\t}\n\tvec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {\n\t\tvec3 I;\n\t\tfloat iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );\n\t\tfloat sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );\n\t\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\t\tif ( cosTheta2Sq < 0.0 ) {\n\t\t\treturn vec3( 1.0 );\n\t\t}\n\t\tfloat cosTheta2 = sqrt( cosTheta2Sq );\n\t\tfloat R0 = IorToFresnel0( iridescenceIOR, outsideIOR );\n\t\tfloat R12 = F_Schlick( R0, 1.0, cosTheta1 );\n\t\tfloat T121 = 1.0 - R12;\n\t\tfloat phi12 = 0.0;\n\t\tif ( iridescenceIOR < outsideIOR ) phi12 = PI;\n\t\tfloat phi21 = PI - phi12;\n\t\tvec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) );\t\tvec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );\n\t\tvec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );\n\t\tvec3 phi23 = vec3( 0.0 );\n\t\tif ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;\n\t\tif ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;\n\t\tif ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;\n\t\tfloat OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;\n\t\tvec3 phi = vec3( phi21 ) + phi23;\n\t\tvec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );\n\t\tvec3 r123 = sqrt( R123 );\n\t\tvec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );\n\t\tvec3 C0 = R12 + Rs;\n\t\tI = C0;\n\t\tvec3 Cm = Rs - T121;\n\t\tfor ( int m = 1; m <= 2; ++ m ) {\n\t\t\tCm *= r123;\n\t\t\tvec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );\n\t\t\tI += Cm * Sm;\n\t\t}\n\t\treturn max( I, vec3( 0.0 ) );\n\t}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vBumpMapUv );\n\t\tvec2 dSTdy = dFdy( vBumpMapUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n\t\tvec3 vSigmaX = normalize( dFdx( surf_pos.xyz ) );\n\t\tvec3 vSigmaY = normalize( dFdy( surf_pos.xyz ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 ) * faceDirection;\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\tplane = clippingPlanes[ i ];\n\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t#pragma unroll_loop_end\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\tif ( clipped ) discard;\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment:"#if defined( USE_COLOR_ALPHA )\n\tdiffuseColor *= vColor;\n#elif defined( USE_COLOR )\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR )\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvColor = vec4( 1.0 );\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor *= color;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement( a ) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nvec3 pow2( const in vec3 x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }\nfloat average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract( sin( sn ) * c );\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\n#ifdef USE_ALPHAHASH\n\tvarying vec3 vPosition;\n#endif\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nfloat luminance( const in vec3 rgb ) {\n\tconst vec3 weights = vec3( 0.2126729, 0.7151522, 0.0721750 );\n\treturn dot( weights, rgb );\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}\nvec3 BRDF_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n}\nfloat F_Schlick( const in float f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n} // validated",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\thighp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tuv.x += filterInt * 3.0 * cubeUV_minTileSize;\n\t\tuv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );\n\t\tuv.x *= CUBEUV_TEXEL_WIDTH;\n\t\tuv.y *= CUBEUV_TEXEL_HEIGHT;\n\t\t#ifdef texture2DGradEXT\n\t\t\treturn texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb;\n\t\t#else\n\t\t\treturn texture2D( envMap, uv ).rgb;\n\t\t#endif\n\t}\n\t#define cubeUV_r0 1.0\n\t#define cubeUV_v0 0.339\n\t#define cubeUV_m0 - 2.0\n\t#define cubeUV_r1 0.8\n\t#define cubeUV_v1 0.276\n\t#define cubeUV_m1 - 1.0\n\t#define cubeUV_r4 0.4\n\t#define cubeUV_v4 0.046\n\t#define cubeUV_m4 2.0\n\t#define cubeUV_r5 0.305\n\t#define cubeUV_v5 0.016\n\t#define cubeUV_m5 3.0\n\t#define cubeUV_r6 0.21\n\t#define cubeUV_v6 0.0038\n\t#define cubeUV_m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= cubeUV_r1 ) {\n\t\t\tmip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;\n\t\t} else if ( roughness >= cubeUV_r4 ) {\n\t\t\tmip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;\n\t\t} else if ( roughness >= cubeUV_r5 ) {\n\t\t\tmip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;\n\t\t} else if ( roughness >= cubeUV_r6 ) {\n\t\t\tmip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = objectNormal;\n#ifdef USE_INSTANCING\n\tmat3 m = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n\ttransformedNormal = m * transformedNormal;\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vDisplacementMapUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vEmissiveMapUv );\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",colorspace_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",colorspace_pars_fragment:"\nconst mat3 LINEAR_SRGB_TO_LINEAR_DISPLAY_P3 = mat3(\n\tvec3( 0.8224621, 0.177538, 0.0 ),\n\tvec3( 0.0331941, 0.9668058, 0.0 ),\n\tvec3( 0.0170827, 0.0723974, 0.9105199 )\n);\nconst mat3 LINEAR_DISPLAY_P3_TO_LINEAR_SRGB = mat3(\n\tvec3( 1.2249401, - 0.2249404, 0.0 ),\n\tvec3( - 0.0420569, 1.0420571, 0.0 ),\n\tvec3( - 0.0196376, - 0.0786361, 1.0982735 )\n);\nvec4 LinearSRGBToLinearDisplayP3( in vec4 value ) {\n\treturn vec4( value.rgb * LINEAR_SRGB_TO_LINEAR_DISPLAY_P3, value.a );\n}\nvec4 LinearDisplayP3ToLinearSRGB( in vec4 value ) {\n\treturn vec4( value.rgb * LINEAR_DISPLAY_P3_TO_LINEAR_SRGB, value.a );\n}\nvec4 LinearTransferOETF( in vec4 value ) {\n\treturn value;\n}\nvec4 sRGBTransferOETF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn sRGBTransferOETF( value );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#ifdef USE_ENVMAP\n\tvec3 getIBLIrradiance( const in vec3 normal ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );\n\t\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\tvec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 reflectVec = reflect( - viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );\n\t\t\treturn envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\t#ifdef USE_ANISOTROPY\n\t\tvec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {\n\t\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\t\tvec3 bentNormal = cross( bitangent, viewDir );\n\t\t\t\tbentNormal = normalize( cross( bentNormal, bitangent ) );\n\t\t\t\tbentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );\n\t\t\t\treturn getIBLRadiance( viewDir, bentNormal, roughness );\n\t\t\t#else\n\t\t\t\treturn vec3( 0.0 );\n\t\t\t#endif\n\t\t}\n\t#endif\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tvFogDepth = - mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float vFogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, vFogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float vFogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn vec3( texture2D( gradientMap, coord ).r );\n\t#else\n\t\tvec2 fw = fwidth( coord ) * 0.5;\n\t\treturn mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );\n\t#endif\n}",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\treflectedLight.indirectDiffuse += lightMapIrradiance;\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_fragment:"LambertMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularStrength = specularStrength;",lights_lambert_pars_fragment:"varying vec3 vViewPosition;\nstruct LambertMaterial {\n\tvec3 diffuseColor;\n\tfloat specularStrength;\n};\nvoid RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Lambert\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Lambert",lights_pars_begin:"uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\n#if defined( USE_LIGHT_PROBES )\n\tuniform vec3 lightProbe[ 9 ];\n#endif\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {\n\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\treturn irradiance;\n}\nfloat getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\t#if defined ( LEGACY_LIGHTS )\n\t\tif ( cutoffDistance > 0.0 && decayExponent > 0.0 ) {\n\t\t\treturn pow( saturate( - lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\t\t}\n\t\treturn 1.0;\n\t#else\n\t\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\t\tif ( cutoffDistance > 0.0 ) {\n\t\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t\t}\n\t\treturn distanceFalloff;\n\t#endif\n}\nfloat getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {\n\treturn smoothstep( coneCosine, penumbraCosine, angleCosine );\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {\n\t\tlight.color = directionalLight.color;\n\t\tlight.direction = directionalLight.direction;\n\t\tlight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = pointLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tlight.color = pointLight.color;\n\t\tlight.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );\n\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = spotLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat angleCos = dot( light.direction, spotLight.direction );\n\t\tfloat spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\tif ( spotAttenuation > 0.0 ) {\n\t\t\tfloat lightDistance = length( lVector );\n\t\t\tlight.color = spotLight.color * spotAttenuation;\n\t\t\tlight.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t\t} else {\n\t\t\tlight.color = vec3( 0.0 );\n\t\t\tlight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {\n\t\tfloat dotNL = dot( normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\treturn irradiance;\n\t}\n#endif",lights_toon_fragment:"ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometryNormal, directLight.direction ) * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 dxy = max( abs( dFdx( nonPerturbedNormal ) ), abs( dFdy( nonPerturbedNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;\nmaterial.roughness = min( material.roughness, 1.0 );\n#ifdef IOR\n\tmaterial.ior = ior;\n\t#ifdef USE_SPECULAR\n\t\tfloat specularIntensityFactor = specularIntensity;\n\t\tvec3 specularColorFactor = specularColor;\n\t\t#ifdef USE_SPECULAR_COLORMAP\n\t\t\tspecularColorFactor *= texture2D( specularColorMap, vSpecularColorMapUv ).rgb;\n\t\t#endif\n\t\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\t\tspecularIntensityFactor *= texture2D( specularIntensityMap, vSpecularIntensityMapUv ).a;\n\t\t#endif\n\t\tmaterial.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );\n\t#else\n\t\tfloat specularIntensityFactor = 1.0;\n\t\tvec3 specularColorFactor = vec3( 1.0 );\n\t\tmaterial.specularF90 = 1.0;\n\t#endif\n\tmaterial.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.specularF90 = 1.0;\n#endif\n#ifdef USE_CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\tmaterial.clearcoatF0 = vec3( 0.04 );\n\tmaterial.clearcoatF90 = 1.0;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vClearcoatMapUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vClearcoatRoughnessMapUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_IRIDESCENCE\n\tmaterial.iridescence = iridescence;\n\tmaterial.iridescenceIOR = iridescenceIOR;\n\t#ifdef USE_IRIDESCENCEMAP\n\t\tmaterial.iridescence *= texture2D( iridescenceMap, vIridescenceMapUv ).r;\n\t#endif\n\t#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\t\tmaterial.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vIridescenceThicknessMapUv ).g + iridescenceThicknessMinimum;\n\t#else\n\t\tmaterial.iridescenceThickness = iridescenceThicknessMaximum;\n\t#endif\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheenColor;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tmaterial.sheenColor *= texture2D( sheenColorMap, vSheenColorMapUv ).rgb;\n\t#endif\n\tmaterial.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tmaterial.sheenRoughness *= texture2D( sheenRoughnessMap, vSheenRoughnessMapUv ).a;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\t#ifdef USE_ANISOTROPYMAP\n\t\tmat2 anisotropyMat = mat2( anisotropyVector.x, anisotropyVector.y, - anisotropyVector.y, anisotropyVector.x );\n\t\tvec3 anisotropyPolar = texture2D( anisotropyMap, vAnisotropyMapUv ).rgb;\n\t\tvec2 anisotropyV = anisotropyMat * normalize( 2.0 * anisotropyPolar.rg - vec2( 1.0 ) ) * anisotropyPolar.b;\n\t#else\n\t\tvec2 anisotropyV = anisotropyVector;\n\t#endif\n\tmaterial.anisotropy = length( anisotropyV );\n\tanisotropyV /= material.anisotropy;\n\tmaterial.anisotropy = saturate( material.anisotropy );\n\tmaterial.alphaT = mix( pow2( material.roughness ), 1.0, pow2( material.anisotropy ) );\n\tmaterial.anisotropyT = tbn[ 0 ] * anisotropyV.x - tbn[ 1 ] * anisotropyV.y;\n\tmaterial.anisotropyB = tbn[ 1 ] * anisotropyV.x + tbn[ 0 ] * anisotropyV.y;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat roughness;\n\tvec3 specularColor;\n\tfloat specularF90;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat clearcoat;\n\t\tfloat clearcoatRoughness;\n\t\tvec3 clearcoatF0;\n\t\tfloat clearcoatF90;\n\t#endif\n\t#ifdef USE_IRIDESCENCE\n\t\tfloat iridescence;\n\t\tfloat iridescenceIOR;\n\t\tfloat iridescenceThickness;\n\t\tvec3 iridescenceFresnel;\n\t\tvec3 iridescenceF0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tvec3 sheenColor;\n\t\tfloat sheenRoughness;\n\t#endif\n\t#ifdef IOR\n\t\tfloat ior;\n\t#endif\n\t#ifdef USE_TRANSMISSION\n\t\tfloat transmission;\n\t\tfloat transmissionAlpha;\n\t\tfloat thickness;\n\t\tfloat attenuationDistance;\n\t\tvec3 attenuationColor;\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat anisotropy;\n\t\tfloat alphaT;\n\t\tvec3 anisotropyT;\n\t\tvec3 anisotropyB;\n\t#endif\n};\nvec3 clearcoatSpecularDirect = vec3( 0.0 );\nvec3 clearcoatSpecularIndirect = vec3( 0.0 );\nvec3 sheenSpecularDirect = vec3( 0.0 );\nvec3 sheenSpecularIndirect = vec3(0.0 );\nvec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {\n    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );\n    float x2 = x * x;\n    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );\n    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );\n}\nfloat V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\n#ifdef USE_ANISOTROPY\n\tfloat V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {\n\t\tfloat gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );\n\t\tfloat gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );\n\t\tfloat v = 0.5 / ( gv + gl );\n\t\treturn saturate(v);\n\t}\n\tfloat D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {\n\t\tfloat a2 = alphaT * alphaB;\n\t\thighp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );\n\t\thighp float v2 = dot( v, v );\n\t\tfloat w2 = a2 / v2;\n\t\treturn RECIPROCAL_PI * a2 * pow2 ( w2 );\n\t}\n#endif\n#ifdef USE_CLEARCOAT\n\tvec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {\n\t\tvec3 f0 = material.clearcoatF0;\n\t\tfloat f90 = material.clearcoatF90;\n\t\tfloat roughness = material.clearcoatRoughness;\n\t\tfloat alpha = pow2( roughness );\n\t\tvec3 halfDir = normalize( lightDir + viewDir );\n\t\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\t\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\t\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\t\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\t\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t\treturn F * ( V * D );\n\t}\n#endif\nvec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {\n\tvec3 f0 = material.specularColor;\n\tfloat f90 = material.specularF90;\n\tfloat roughness = material.roughness;\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t#ifdef USE_IRIDESCENCE\n\t\tF = mix( F, material.iridescenceFresnel, material.iridescence );\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat dotTL = dot( material.anisotropyT, lightDir );\n\t\tfloat dotTV = dot( material.anisotropyT, viewDir );\n\t\tfloat dotTH = dot( material.anisotropyT, halfDir );\n\t\tfloat dotBL = dot( material.anisotropyB, lightDir );\n\t\tfloat dotBV = dot( material.anisotropyB, viewDir );\n\t\tfloat dotBH = dot( material.anisotropyB, halfDir );\n\t\tfloat V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );\n\t\tfloat D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );\n\t#else\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t#endif\n\treturn F * ( V * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie( float roughness, float dotNH ) {\n\tfloat alpha = pow2( roughness );\n\tfloat invAlpha = 1.0 / alpha;\n\tfloat cos2h = dotNH * dotNH;\n\tfloat sin2h = max( 1.0 - cos2h, 0.0078125 );\n\treturn ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );\n}\nfloat V_Neubelt( float dotNV, float dotNL ) {\n\treturn saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );\n}\nvec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat D = D_Charlie( sheenRoughness, dotNH );\n\tfloat V = V_Neubelt( dotNV, dotNL );\n\treturn sheenColor * ( D * V );\n}\n#endif\nfloat IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat r2 = roughness * roughness;\n\tfloat a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;\n\tfloat b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;\n\tfloat DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );\n\treturn saturate( DG * RECIPROCAL_PI );\n}\nvec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;\n\treturn fab;\n}\nvec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\treturn specularColor * fab.x + specularF90 * fab.y;\n}\n#ifdef USE_IRIDESCENCE\nvoid computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#else\nvoid computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#endif\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\t#ifdef USE_IRIDESCENCE\n\t\tvec3 Fr = mix( specularColor, iridescenceF0, iridescence );\n\t#else\n\t\tvec3 Fr = specularColor;\n\t#endif\n\tvec3 FssEss = Fr * fab.x + specularF90 * fab.y;\n\tfloat Ess = fab.x + fab.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometryNormal;\n\t\tvec3 viewDir = geometryViewDir;\n\t\tvec3 position = geometryPosition;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.roughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = dotNLcc * directLight.color;\n\t\tclearcoatSpecularDirect += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularDirect += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );\n\t#endif\n\treflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometryViewDir, geometryNormal, material );\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatSpecularIndirect += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularIndirect += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );\n\t#endif\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\t#ifdef USE_IRIDESCENCE\n\t\tcomputeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness, singleScattering, multiScattering );\n\t#else\n\t\tcomputeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );\n\t#endif\n\tvec3 totalScattering = singleScattering + multiScattering;\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - max( max( totalScattering.r, totalScattering.g ), totalScattering.b ) );\n\treflectedLight.indirectSpecular += radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\nvec3 geometryClearcoatNormal = vec3( 0.0 );\n#ifdef USE_CLEARCOAT\n\tgeometryClearcoatNormal = clearcoatNormal;\n#endif\n#ifdef USE_IRIDESCENCE\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\tif ( material.iridescenceThickness == 0.0 ) {\n\t\tmaterial.iridescence = 0.0;\n\t} else {\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\t}\n\tif ( material.iridescence > 0.0 ) {\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\t}\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#if defined( USE_LIGHT_PROBES )\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getIBLIrradiance( geometryNormal );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\t#ifdef USE_ANISOTROPY\n\t\tradiance += getIBLAnisotropyRadiance( geometryViewDir, geometryNormal, material.roughness, material.anisotropyB, material.anisotropy );\n\t#else\n\t\tradiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tgl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t\tvarying float vIsPerspective;\n\t#else\n\t\tuniform float logDepthBufFC;\n\t#endif\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n\t#else\n\t\tif ( isPerspectiveMatrix( projectionMatrix ) ) {\n\t\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\t\tgl_Position.z *= gl_Position.w;\n\t\t}\n\t#endif\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 sampledDiffuseColor = texture2D( map, vMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\tsampledDiffuseColor = vec4( mix( pow( sampledDiffuseColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), sampledDiffuseColor.rgb * 0.0773993808, vec3( lessThanEqual( sampledDiffuseColor.rgb, vec3( 0.04045 ) ) ) ), sampledDiffuseColor.w );\n\t\n\t#endif\n\tdiffuseColor *= sampledDiffuseColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t#if defined( USE_POINTS_UV )\n\t\tvec2 uv = vUv;\n\t#else\n\t\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tdiffuseColor *= texture2D( map, uv );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment:"#if defined( USE_POINTS_UV )\n\tvarying vec2 vUv;\n#else\n\t#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t\tuniform mat3 uvTransform;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vMetalnessMapUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphcolor_vertex:"#if defined( USE_MORPHCOLORS ) && defined( MORPHTARGETS_TEXTURE )\n\tvColor *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t#if defined( USE_COLOR_ALPHA )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];\n\t\t#elif defined( USE_COLOR )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];\n\t\t#endif\n\t}\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];\n\t\t}\n\t#else\n\t\tobjectNormal += morphNormal0 * morphTargetInfluences[ 0 ];\n\t\tobjectNormal += morphNormal1 * morphTargetInfluences[ 1 ];\n\t\tobjectNormal += morphNormal2 * morphTargetInfluences[ 2 ];\n\t\tobjectNormal += morphNormal3 * morphTargetInfluences[ 3 ];\n\t#endif\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\tuniform float morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tuniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\t\tuniform sampler2DArray morphTargetsTexture;\n\t\tuniform ivec2 morphTargetsTextureSize;\n\t\tvec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {\n\t\t\tint texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;\n\t\t\tint y = texelIndex / morphTargetsTextureSize.x;\n\t\t\tint x = texelIndex - y * morphTargetsTextureSize.x;\n\t\t\tivec3 morphUV = ivec3( x, y, morphTargetIndex );\n\t\t\treturn texelFetch( morphTargetsTexture, morphUV, 0 );\n\t\t}\n\t#else\n\t\t#ifndef USE_MORPHNORMALS\n\t\t\tuniform float morphTargetInfluences[ 8 ];\n\t\t#else\n\t\t\tuniform float morphTargetInfluences[ 4 ];\n\t\t#endif\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];\n\t\t}\n\t#else\n\t\ttransformed += morphTarget0 * morphTargetInfluences[ 0 ];\n\t\ttransformed += morphTarget1 * morphTargetInfluences[ 1 ];\n\t\ttransformed += morphTarget2 * morphTargetInfluences[ 2 ];\n\t\ttransformed += morphTarget3 * morphTargetInfluences[ 3 ];\n\t\t#ifndef USE_MORPHNORMALS\n\t\t\ttransformed += morphTarget4 * morphTargetInfluences[ 4 ];\n\t\t\ttransformed += morphTarget5 * morphTargetInfluences[ 5 ];\n\t\t\ttransformed += morphTarget6 * morphTargetInfluences[ 6 ];\n\t\t\ttransformed += morphTarget7 * morphTargetInfluences[ 7 ];\n\t\t#endif\n\t#endif\n#endif",normal_fragment_begin:"float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;\n#ifdef FLAT_SHADED\n\tvec3 fdx = dFdx( vViewPosition );\n\tvec3 fdy = dFdy( vViewPosition );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal *= faceDirection;\n\t#endif\n#endif\n#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn = getTangentFrame( - vViewPosition, normal,\n\t\t#if defined( USE_NORMALMAP )\n\t\t\tvNormalMapUv\n\t\t#elif defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tvClearcoatNormalMapUv\n\t\t#else\n\t\t\tvUv\n\t\t#endif\n\t\t);\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn[0] *= faceDirection;\n\t\ttbn[1] *= faceDirection;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn2 = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn2 = getTangentFrame( - vViewPosition, normal, vClearcoatNormalMapUv );\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn2[0] *= faceDirection;\n\t\ttbn2[1] *= faceDirection;\n\t#endif\n#endif\nvec3 nonPerturbedNormal = normal;",normal_fragment_maps:"#ifdef USE_NORMALMAP_OBJECTSPACE\n\tnormal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( USE_NORMALMAP_TANGENTSPACE )\n\tvec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\tnormal = normalize( tbn * mapN );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n#endif",normal_pars_fragment:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_pars_vertex:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_vertex:"#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef USE_NORMALMAP_OBJECTSPACE\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( USE_NORMALMAP_TANGENTSPACE ) || defined ( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) )\n\tmat3 getTangentFrame( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {\n\t\tvec3 q0 = dFdx( eye_pos.xyz );\n\t\tvec3 q1 = dFdy( eye_pos.xyz );\n\t\tvec2 st0 = dFdx( uv.st );\n\t\tvec2 st1 = dFdy( uv.st );\n\t\tvec3 N = surf_norm;\n\t\tvec3 q1perp = cross( q1, N );\n\t\tvec3 q0perp = cross( N, q0 );\n\t\tvec3 T = q1perp * st0.x + q0perp * st1.x;\n\t\tvec3 B = q1perp * st0.y + q0perp * st1.y;\n\t\tfloat det = max( dot( T, T ), dot( B, B ) );\n\t\tfloat scale = ( det == 0.0 ) ? 0.0 : inversesqrt( det );\n\t\treturn mat3( T * scale, B * scale, N );\n\t}\n#endif",clearcoat_normal_fragment_begin:"#ifdef USE_CLEARCOAT\n\tvec3 clearcoatNormal = nonPerturbedNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vClearcoatNormalMapUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\tclearcoatNormal = normalize( tbn2 * clearcoatMapN );\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif",iridescence_pars_fragment:"#ifdef USE_IRIDESCENCEMAP\n\tuniform sampler2D iridescenceMap;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform sampler2D iridescenceThicknessMap;\n#endif",opaque_fragment:"#ifdef OPAQUE\ndiffuseColor.a = 1.0;\n#endif\n#ifdef USE_TRANSMISSION\ndiffuseColor.a *= material.transmissionAlpha;\n#endif\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nvec2 packDepthToRG( in highp float v ) {\n\treturn packDepthToRGBA( v ).yx;\n}\nfloat unpackRGToDepth( const in highp vec2 v ) {\n\treturn unpackRGBAToDepth( vec4( v.xy, 0.0, 0.0 ) );\n}\nvec4 pack2HalfToRGBA( vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );\n}\nvec2 unpackRGBATo2Half( vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn depth * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * depth - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vRoughnessMapUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#if NUM_SPOT_LIGHT_MAPS > 0\n\tuniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;\n\t\tbool frustumTest = inFrustum && shadowCoord.z <= 1.0;\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn shadow;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\tdp += shadowBias;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif",shadowmap_pars_vertex:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tuniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex:"#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )\n\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\tvec4 shadowWorldPosition;\n#endif\n#if defined( USE_SHADOWMAP )\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if NUM_SPOT_LIGHT_COORDS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition;\n\t\t#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t\tshadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;\n\t\t#endif\n\t\tvSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\tuniform highp sampler2D boneTexture;\n\tuniform int boneTextureSize;\n\tmat4 getBoneMatrix( const in float i ) {\n\t\tfloat j = i * 4.0;\n\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\ty = dy * ( y + 0.5 );\n\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\treturn bone;\n\t}\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vSpecularMapUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn saturate( toneMappingExposure * color );\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmission_fragment:"#ifdef USE_TRANSMISSION\n\tmaterial.transmission = transmission;\n\tmaterial.transmissionAlpha = 1.0;\n\tmaterial.thickness = thickness;\n\tmaterial.attenuationDistance = attenuationDistance;\n\tmaterial.attenuationColor = attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tmaterial.transmission *= texture2D( transmissionMap, vTransmissionMapUv ).r;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tmaterial.thickness *= texture2D( thicknessMap, vThicknessMapUv ).g;\n\t#endif\n\tvec3 pos = vWorldPosition;\n\tvec3 v = normalize( cameraPosition - pos );\n\tvec3 n = inverseTransformDirection( normal, viewMatrix );\n\tvec4 transmitted = getIBLVolumeRefraction(\n\t\tn, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,\n\t\tpos, modelMatrix, viewMatrix, projectionMatrix, material.ior, material.thickness,\n\t\tmaterial.attenuationColor, material.attenuationDistance );\n\tmaterial.transmissionAlpha = mix( material.transmissionAlpha, transmitted.a, material.transmission );\n\ttotalDiffuse = mix( totalDiffuse, transmitted.rgb, material.transmission );\n#endif",transmission_pars_fragment:"#ifdef USE_TRANSMISSION\n\tuniform float transmission;\n\tuniform float thickness;\n\tuniform float attenuationDistance;\n\tuniform vec3 attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tuniform sampler2D transmissionMap;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tuniform sampler2D thicknessMap;\n\t#endif\n\tuniform vec2 transmissionSamplerSize;\n\tuniform sampler2D transmissionSamplerMap;\n\tuniform mat4 modelMatrix;\n\tuniform mat4 projectionMatrix;\n\tvarying vec3 vWorldPosition;\n\tfloat w0( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );\n\t}\n\tfloat w1( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );\n\t}\n\tfloat w2( float a ){\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );\n\t}\n\tfloat w3( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * a * a );\n\t}\n\tfloat g0( float a ) {\n\t\treturn w0( a ) + w1( a );\n\t}\n\tfloat g1( float a ) {\n\t\treturn w2( a ) + w3( a );\n\t}\n\tfloat h0( float a ) {\n\t\treturn - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );\n\t}\n\tfloat h1( float a ) {\n\t\treturn 1.0 + w3( a ) / ( w2( a ) + w3( a ) );\n\t}\n\tvec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {\n\t\tuv = uv * texelSize.zw + 0.5;\n\t\tvec2 iuv = floor( uv );\n\t\tvec2 fuv = fract( uv );\n\t\tfloat g0x = g0( fuv.x );\n\t\tfloat g1x = g1( fuv.x );\n\t\tfloat h0x = h0( fuv.x );\n\t\tfloat h1x = h1( fuv.x );\n\t\tfloat h0y = h0( fuv.y );\n\t\tfloat h1y = h1( fuv.y );\n\t\tvec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\treturn g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) +\n\t\t\tg1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );\n\t}\n\tvec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {\n\t\tvec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );\n\t\tvec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );\n\t\tvec2 fLodSizeInv = 1.0 / fLodSize;\n\t\tvec2 cLodSizeInv = 1.0 / cLodSize;\n\t\tvec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );\n\t\tvec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );\n\t\treturn mix( fSample, cSample, fract( lod ) );\n\t}\n\tvec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {\n\t\tvec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );\n\t\tvec3 modelScale;\n\t\tmodelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );\n\t\tmodelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );\n\t\tmodelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );\n\t\treturn normalize( refractionVector ) * thickness * modelScale;\n\t}\n\tfloat applyIorToRoughness( const in float roughness, const in float ior ) {\n\t\treturn roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );\n\t}\n\tvec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {\n\t\tfloat lod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );\n\t\treturn textureBicubic( transmissionSamplerMap, fragCoord.xy, lod );\n\t}\n\tvec3 volumeAttenuation( const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tif ( isinf( attenuationDistance ) ) {\n\t\t\treturn vec3( 1.0 );\n\t\t} else {\n\t\t\tvec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;\n\t\t\tvec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );\t\t\treturn transmittance;\n\t\t}\n\t}\n\tvec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,\n\t\tconst in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,\n\t\tconst in mat4 viewMatrix, const in mat4 projMatrix, const in float ior, const in float thickness,\n\t\tconst in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );\n\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\trefractionCoords += 1.0;\n\t\trefractionCoords /= 2.0;\n\t\tvec4 transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );\n\t\tvec3 transmittance = diffuseColor * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance );\n\t\tvec3 attenuatedColor = transmittance * transmittedLight.rgb;\n\t\tvec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );\n\t\tfloat transmittanceFactor = ( transmittance.r + transmittance.g + transmittance.b ) / 3.0;\n\t\treturn vec4( ( 1.0 - F ) * attenuatedColor, 1.0 - ( 1.0 - transmittedLight.a ) * transmittanceFactor );\n\t}\n#endif",uv_pars_fragment:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_pars_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tuniform mat3 mapTransform;\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform mat3 alphaMapTransform;\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tuniform mat3 lightMapTransform;\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tuniform mat3 aoMapTransform;\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tuniform mat3 bumpMapTransform;\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tuniform mat3 normalMapTransform;\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tuniform mat3 displacementMapTransform;\n\tvarying vec2 vDisplacementMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tuniform mat3 emissiveMapTransform;\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tuniform mat3 metalnessMapTransform;\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tuniform mat3 roughnessMapTransform;\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tuniform mat3 anisotropyMapTransform;\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tuniform mat3 clearcoatMapTransform;\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform mat3 clearcoatNormalMapTransform;\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform mat3 clearcoatRoughnessMapTransform;\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tuniform mat3 sheenColorMapTransform;\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tuniform mat3 sheenRoughnessMapTransform;\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tuniform mat3 iridescenceMapTransform;\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform mat3 iridescenceThicknessMapTransform;\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tuniform mat3 specularMapTransform;\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tuniform mat3 specularColorMapTransform;\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tuniform mat3 specularIntensityMapTransform;\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvUv = vec3( uv, 1 ).xy;\n#endif\n#ifdef USE_MAP\n\tvMapUv = ( mapTransform * vec3( MAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ALPHAMAP\n\tvAlphaMapUv = ( alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_LIGHTMAP\n\tvLightMapUv = ( lightMapTransform * vec3( LIGHTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_AOMAP\n\tvAoMapUv = ( aoMapTransform * vec3( AOMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_BUMPMAP\n\tvBumpMapUv = ( bumpMapTransform * vec3( BUMPMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_NORMALMAP\n\tvNormalMapUv = ( normalMapTransform * vec3( NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tvDisplacementMapUv = ( displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvEmissiveMapUv = ( emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_METALNESSMAP\n\tvMetalnessMapUv = ( metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvRoughnessMapUv = ( roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvAnisotropyMapUv = ( anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvClearcoatMapUv = ( clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvClearcoatNormalMapUv = ( clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvClearcoatRoughnessMapUv = ( clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvIridescenceMapUv = ( iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvIridescenceThicknessMapUv = ( iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvSheenColorMapUv = ( sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvSheenRoughnessMapUv = ( sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULARMAP\n\tvSpecularMapUv = ( specularMapTransform * vec3( SPECULARMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvSpecularColorMapUv = ( specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvSpecularIntensityMapUv = ( specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tvTransmissionMapUv = ( transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_THICKNESSMAP\n\tvThicknessMapUv = ( thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) ).xy;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",background_frag:"uniform sampler2D t2D;\nuniform float backgroundIntensity;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\ttexColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",backgroundCube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",backgroundCube_frag:"#ifdef ENVMAP_TYPE_CUBE\n\tuniform samplerCube envMap;\n#elif defined( ENVMAP_TYPE_CUBE_UV )\n\tuniform sampler2D envMap;\n#endif\nuniform float flipEnvMap;\nuniform float backgroundBlurriness;\nuniform float backgroundIntensity;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 texColor = textureCube( envMap, vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 texColor = textureCubeUV( envMap, vWorldDirection, backgroundBlurriness );\n\t#else\n\t\tvec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldDirection;\nvoid main() {\n\tvec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );\n\tgl_FragColor = texColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#endif\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"#define LAMBERT\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_lambert_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_lambert_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t#else\n\t\tvec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshnormal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",meshnormal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n\t#ifdef OPAQUE\n\t\tgl_FragColor.a = 1.0;\n\t#endif\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n\t#define IOR\n\t#define USE_SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\n\tuniform float ior;\n#endif\n#ifdef USE_SPECULAR\n\tuniform float specularIntensity;\n\tuniform vec3 specularColor;\n\t#ifdef USE_SPECULAR_COLORMAP\n\t\tuniform sampler2D specularColorMap;\n\t#endif\n\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\tuniform sampler2D specularIntensityMap;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_IRIDESCENCE\n\tuniform float iridescence;\n\tuniform float iridescenceIOR;\n\tuniform float iridescenceThicknessMinimum;\n\tuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheenColor;\n\tuniform float sheenRoughness;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tuniform sampler2D sheenColorMap;\n\t#endif\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tuniform sampler2D sheenRoughnessMap;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\tuniform vec2 anisotropyVector;\n\t#ifdef USE_ANISOTROPYMAP\n\t\tuniform sampler2D anisotropyMap;\n\t#endif\n#endif\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n\tvec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t#include <transmission_fragment>\n\tvec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\t#ifdef USE_SHEEN\n\t\tfloat sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n\t\toutgoingLight = outgoingLight * sheenEnergyComp + sheenSpecularDirect + sheenSpecularIndirect;\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );\n\t\tvec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n\t\toutgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;\n\t#endif\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#ifdef USE_POINTS_UV\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n#endif\nvoid main() {\n\t#ifdef USE_POINTS_UV\n\t\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\t#endif\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",shadow_vert:"#include <common>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <logdepthbuf_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec2 scale;\n\tscale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n\tscale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}"},ws={common:{diffuse:{value:new In(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new yt},alphaMap:{value:null},alphaMapTransform:{value:new yt},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new yt}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new yt}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new yt}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new yt},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new yt},normalScale:{value:new bt(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new yt},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new yt}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new yt}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new yt}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new In(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new In(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new yt},alphaTest:{value:0},uvTransform:{value:new yt}},sprite:{diffuse:{value:new In(16777215)},opacity:{value:1},center:{value:new bt(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new yt},alphaMap:{value:null},alphaMapTransform:{value:new yt},alphaTest:{value:0}}},Ss={basic:{uniforms:os([ws.common,ws.specularmap,ws.envmap,ws.aomap,ws.lightmap,ws.fog]),vertexShader:Bs.meshbasic_vert,fragmentShader:Bs.meshbasic_frag},lambert:{uniforms:os([ws.common,ws.specularmap,ws.envmap,ws.aomap,ws.lightmap,ws.emissivemap,ws.bumpmap,ws.normalmap,ws.displacementmap,ws.fog,ws.lights,{emissive:{value:new In(0)}}]),vertexShader:Bs.meshlambert_vert,fragmentShader:Bs.meshlambert_frag},phong:{uniforms:os([ws.common,ws.specularmap,ws.envmap,ws.aomap,ws.lightmap,ws.emissivemap,ws.bumpmap,ws.normalmap,ws.displacementmap,ws.fog,ws.lights,{emissive:{value:new In(0)},specular:{value:new In(1118481)},shininess:{value:30}}]),vertexShader:Bs.meshphong_vert,fragmentShader:Bs.meshphong_frag},standard:{uniforms:os([ws.common,ws.envmap,ws.aomap,ws.lightmap,ws.emissivemap,ws.bumpmap,ws.normalmap,ws.displacementmap,ws.roughnessmap,ws.metalnessmap,ws.fog,ws.lights,{emissive:{value:new In(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:Bs.meshphysical_vert,fragmentShader:Bs.meshphysical_frag},toon:{uniforms:os([ws.common,ws.aomap,ws.lightmap,ws.emissivemap,ws.bumpmap,ws.normalmap,ws.displacementmap,ws.gradientmap,ws.fog,ws.lights,{emissive:{value:new In(0)}}]),vertexShader:Bs.meshtoon_vert,fragmentShader:Bs.meshtoon_frag},matcap:{uniforms:os([ws.common,ws.bumpmap,ws.normalmap,ws.displacementmap,ws.fog,{matcap:{value:null}}]),vertexShader:Bs.meshmatcap_vert,fragmentShader:Bs.meshmatcap_frag},points:{uniforms:os([ws.points,ws.fog]),vertexShader:Bs.points_vert,fragmentShader:Bs.points_frag},dashed:{uniforms:os([ws.common,ws.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:Bs.linedashed_vert,fragmentShader:Bs.linedashed_frag},depth:{uniforms:os([ws.common,ws.displacementmap]),vertexShader:Bs.depth_vert,fragmentShader:Bs.depth_frag},normal:{uniforms:os([ws.common,ws.bumpmap,ws.normalmap,ws.displacementmap,{opacity:{value:1}}]),vertexShader:Bs.meshnormal_vert,fragmentShader:Bs.meshnormal_frag},sprite:{uniforms:os([ws.sprite,ws.fog]),vertexShader:Bs.sprite_vert,fragmentShader:Bs.sprite_frag},background:{uniforms:{uvTransform:{value:new yt},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:Bs.background_vert,fragmentShader:Bs.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1}},vertexShader:Bs.backgroundCube_vert,fragmentShader:Bs.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:Bs.cube_vert,fragmentShader:Bs.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:Bs.equirect_vert,fragmentShader:Bs.equirect_frag},distanceRGBA:{uniforms:os([ws.common,ws.displacementmap,{referencePosition:{value:new Qt},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:Bs.distanceRGBA_vert,fragmentShader:Bs.distanceRGBA_frag},shadow:{uniforms:os([ws.lights,ws.fog,{color:{value:new In(0)},opacity:{value:1}}]),vertexShader:Bs.shadow_vert,fragmentShader:Bs.shadow_frag}};Ss.physical={uniforms:os([Ss.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new yt},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new yt},clearcoatNormalScale:{value:new bt(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new yt},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new yt},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new yt},sheen:{value:0},sheenColor:{value:new In(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new yt},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new yt},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new yt},transmissionSamplerSize:{value:new bt},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new yt},attenuationDistance:{value:0},attenuationColor:{value:new In(0)},specularColor:{value:new In(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new yt},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new yt},anisotropyVector:{value:new bt},anisotropyMap:{value:null},anisotropyMapTransform:{value:new yt}}]),vertexShader:Bs.meshphysical_vert,fragmentShader:Bs.meshphysical_frag};const Gs={r:0,b:0,g:0};function Ms(e,t,i,n,s,o,r){const a=new In(0);let l,d,h=!0===o?0:1,u=null,I=0,p=null;function m(t,i){t.getRGB(Gs,rs(e)),n.buffers.color.setClear(Gs.r,Gs.g,Gs.b,i,r)}return{getClearColor:function(){return a},setClearColor:function(e,t=1){a.set(e),h=t,m(a,h)},getClearAlpha:function(){return h},setClearAlpha:function(e){h=e,m(a,h)},render:function(o,A){let C=!1,f=!0===A.isScene?A.background:null;if(f&&f.isTexture){f=(A.backgroundBlurriness>0?i:t).get(f)}null===f?m(a,h):f&&f.isColor&&(m(f,1),C=!0);const b=e.xr.getEnvironmentBlendMode();"additive"===b?n.buffers.color.setClear(0,0,0,1,r):"alpha-blend"===b&&n.buffers.color.setClear(0,0,0,0,r),(e.autoClear||C)&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),f&&(f.isCubeTexture||f.mapping===S)?(void 0===d&&(d=new ts(new ns(1,1,1),new ls({name:"BackgroundCubeMaterial",uniforms:ss(Ss.backgroundCube.uniforms),vertexShader:Ss.backgroundCube.vertexShader,fragmentShader:Ss.backgroundCube.fragmentShader,side:c,depthTest:!1,depthWrite:!1,fog:!1})),d.geometry.deleteAttribute("normal"),d.geometry.deleteAttribute("uv"),d.onBeforeRender=function(e,t,i){this.matrixWorld.copyPosition(i.matrixWorld)},Object.defineProperty(d.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),s.update(d)),d.material.uniforms.envMap.value=f,d.material.uniforms.flipEnvMap.value=f.isCubeTexture&&!1===f.isRenderTargetTexture?-1:1,d.material.uniforms.backgroundBlurriness.value=A.backgroundBlurriness,d.material.uniforms.backgroundIntensity.value=A.backgroundIntensity,d.material.toneMapped=Zt.getTransfer(f.colorSpace)!==Qe,u===f&&I===f.version&&p===e.toneMapping||(d.material.needsUpdate=!0,u=f,I=f.version,p=e.toneMapping),d.layers.enableAll(),o.unshift(d,d.geometry,d.material,0,0,null)):f&&f.isTexture&&(void 0===l&&(l=new ts(new xs(2,2),new ls({name:"BackgroundMaterial",uniforms:ss(Ss.background.uniforms),vertexShader:Ss.background.vertexShader,fragmentShader:Ss.background.fragmentShader,side:g,depthTest:!1,depthWrite:!1,fog:!1})),l.geometry.deleteAttribute("normal"),Object.defineProperty(l.material,"map",{get:function(){return this.uniforms.t2D.value}}),s.update(l)),l.material.uniforms.t2D.value=f,l.material.uniforms.backgroundIntensity.value=A.backgroundIntensity,l.material.toneMapped=Zt.getTransfer(f.colorSpace)!==Qe,!0===f.matrixAutoUpdate&&f.updateMatrix(),l.material.uniforms.uvTransform.value.copy(f.matrix),u===f&&I===f.version&&p===e.toneMapping||(l.material.needsUpdate=!0,u=f,I=f.version,p=e.toneMapping),l.layers.enableAll(),o.unshift(l,l.geometry,l.material,0,0,null))}}}function Rs(e,t,i,n){const s=e.getParameter(e.MAX_VERTEX_ATTRIBS),o=n.isWebGL2?null:t.get("OES_vertex_array_object"),r=n.isWebGL2||null!==o,a={},l=u(null);let g=l,c=!1;function d(t){return n.isWebGL2?e.bindVertexArray(t):o.bindVertexArrayOES(t)}function h(t){return n.isWebGL2?e.deleteVertexArray(t):o.deleteVertexArrayOES(t)}function u(e){const t=[],i=[],n=[];for(let o=0;o<s;o++)t[o]=0,i[o]=0,n[o]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:t,enabledAttributes:i,attributeDivisors:n,object:e,attributes:{},index:null}}function I(){const e=g.newAttributes;for(let t=0,i=e.length;t<i;t++)e[t]=0}function p(e){m(e,0)}function m(i,s){const o=g.newAttributes,r=g.enabledAttributes,a=g.attributeDivisors;if(o[i]=1,0===r[i]&&(e.enableVertexAttribArray(i),r[i]=1),a[i]!==s){(n.isWebGL2?e:t.get("ANGLE_instanced_arrays"))[n.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](i,s),a[i]=s}}function A(){const t=g.newAttributes,i=g.enabledAttributes;for(let n=0,s=i.length;n<s;n++)i[n]!==t[n]&&(e.disableVertexAttribArray(n),i[n]=0)}function C(t,i,n,s,o,r,a){!0===a?e.vertexAttribIPointer(t,i,n,o,r):e.vertexAttribPointer(t,i,n,s,o,r)}function f(){b(),c=!0,g!==l&&(g=l,d(g.object))}function b(){l.geometry=null,l.program=null,l.wireframe=!1}return{setup:function(s,l,h,f,b){let y=!1;if(r){const t=function(t,i,s){const r=!0===s.wireframe;let l=a[t.id];void 0===l&&(l={},a[t.id]=l);let g=l[i.id];void 0===g&&(g={},l[i.id]=g);let c=g[r];void 0===c&&(c=u(n.isWebGL2?e.createVertexArray():o.createVertexArrayOES()),g[r]=c);return c}(f,h,l);g!==t&&(g=t,d(g.object)),y=function(e,t,i,n){const s=g.attributes,o=t.attributes;let r=0;const a=i.getAttributes();for(const l in a){if(a[l].location>=0){const t=s[l];let i=o[l];if(void 0===i&&("instanceMatrix"===l&&e.instanceMatrix&&(i=e.instanceMatrix),"instanceColor"===l&&e.instanceColor&&(i=e.instanceColor)),void 0===t)return!0;if(t.attribute!==i)return!0;if(i&&t.data!==i.data)return!0;r++}}return g.attributesNum!==r||g.index!==n}(s,f,h,b),y&&function(e,t,i,n){const s={},o=t.attributes;let r=0;const a=i.getAttributes();for(const l in a){if(a[l].location>=0){let t=o[l];void 0===t&&("instanceMatrix"===l&&e.instanceMatrix&&(t=e.instanceMatrix),"instanceColor"===l&&e.instanceColor&&(t=e.instanceColor));const i={};i.attribute=t,t&&t.data&&(i.data=t.data),s[l]=i,r++}}g.attributes=s,g.attributesNum=r,g.index=n}(s,f,h,b)}else{const e=!0===l.wireframe;g.geometry===f.id&&g.program===h.id&&g.wireframe===e||(g.geometry=f.id,g.program=h.id,g.wireframe=e,y=!0)}null!==b&&i.update(b,e.ELEMENT_ARRAY_BUFFER),(y||c)&&(c=!1,function(s,o,r,a){if(!1===n.isWebGL2&&(s.isInstancedMesh||a.isInstancedBufferGeometry)&&null===t.get("ANGLE_instanced_arrays"))return;I();const l=a.attributes,g=r.getAttributes(),c=o.defaultAttributeValues;for(const t in g){const o=g[t];if(o.location>=0){let r=l[t];if(void 0===r&&("instanceMatrix"===t&&s.instanceMatrix&&(r=s.instanceMatrix),"instanceColor"===t&&s.instanceColor&&(r=s.instanceColor)),void 0!==r){const t=r.normalized,l=r.itemSize,g=i.get(r);if(void 0===g)continue;const c=g.buffer,d=g.type,h=g.bytesPerElement,u=!0===n.isWebGL2&&(d===e.INT||d===e.UNSIGNED_INT||r.gpuType===L);if(r.isInterleavedBufferAttribute){const i=r.data,n=i.stride,g=r.offset;if(i.isInstancedInterleavedBuffer){for(let e=0;e<o.locationSize;e++)m(o.location+e,i.meshPerAttribute);!0!==s.isInstancedMesh&&void 0===a._maxInstanceCount&&(a._maxInstanceCount=i.meshPerAttribute*i.count)}else for(let e=0;e<o.locationSize;e++)p(o.location+e);e.bindBuffer(e.ARRAY_BUFFER,c);for(let e=0;e<o.locationSize;e++)C(o.location+e,l/o.locationSize,d,t,n*h,(g+l/o.locationSize*e)*h,u)}else{if(r.isInstancedBufferAttribute){for(let e=0;e<o.locationSize;e++)m(o.location+e,r.meshPerAttribute);!0!==s.isInstancedMesh&&void 0===a._maxInstanceCount&&(a._maxInstanceCount=r.meshPerAttribute*r.count)}else for(let e=0;e<o.locationSize;e++)p(o.location+e);e.bindBuffer(e.ARRAY_BUFFER,c);for(let e=0;e<o.locationSize;e++)C(o.location+e,l/o.locationSize,d,t,l*h,l/o.locationSize*e*h,u)}}else if(void 0!==c){const i=c[t];if(void 0!==i)switch(i.length){case 2:e.vertexAttrib2fv(o.location,i);break;case 3:e.vertexAttrib3fv(o.location,i);break;case 4:e.vertexAttrib4fv(o.location,i);break;default:e.vertexAttrib1fv(o.location,i)}}}}A()}(s,l,h,f),null!==b&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.get(b).buffer))},reset:f,resetDefaultState:b,dispose:function(){f();for(const e in a){const t=a[e];for(const e in t){const i=t[e];for(const e in i)h(i[e].object),delete i[e];delete t[e]}delete a[e]}},releaseStatesOfGeometry:function(e){if(void 0===a[e.id])return;const t=a[e.id];for(const i in t){const e=t[i];for(const t in e)h(e[t].object),delete e[t];delete t[i]}delete a[e.id]},releaseStatesOfProgram:function(e){for(const t in a){const i=a[t];if(void 0===i[e.id])continue;const n=i[e.id];for(const e in n)h(n[e].object),delete n[e];delete i[e.id]}},initAttributes:I,enableAttribute:p,disableUnusedAttributes:A}}function Ts(e,t,i,n){const s=n.isWebGL2;let o;this.setMode=function(e){o=e},this.render=function(t,n){e.drawArrays(o,t,n),i.update(n,o,1)},this.renderInstances=function(n,r,a){if(0===a)return;let l,g;if(s)l=e,g="drawArraysInstanced";else if(l=t.get("ANGLE_instanced_arrays"),g="drawArraysInstancedANGLE",null===l)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");l[g](o,n,r,a),i.update(r,o,a)}}function Zs(e,t,i){let n;function s(t){if("highp"===t){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}const o="undefined"!=typeof WebGL2RenderingContext&&"WebGL2RenderingContext"===e.constructor.name;let r=void 0!==i.precision?i.precision:"highp";const a=s(r);a!==r&&(console.warn("THREE.WebGLRenderer:",r,"not supported, using",a,"instead."),r=a);const l=o||t.has("WEBGL_draw_buffers"),g=!0===i.logarithmicDepthBuffer,c=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),d=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),h=e.getParameter(e.MAX_TEXTURE_SIZE),u=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),I=e.getParameter(e.MAX_VERTEX_ATTRIBS),p=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),m=e.getParameter(e.MAX_VARYING_VECTORS),A=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),C=d>0,f=o||t.has("OES_texture_float");return{isWebGL2:o,drawBuffers:l,getMaxAnisotropy:function(){if(void 0!==n)return n;if(!0===t.has("EXT_texture_filter_anisotropic")){const i=t.get("EXT_texture_filter_anisotropic");n=e.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else n=0;return n},getMaxPrecision:s,precision:r,logarithmicDepthBuffer:g,maxTextures:c,maxVertexTextures:d,maxTextureSize:h,maxCubemapSize:u,maxAttributes:I,maxVertexUniforms:p,maxVaryings:m,maxFragmentUniforms:A,vertexTextures:C,floatFragmentTextures:f,floatVertexTextures:C&&f,maxSamples:o?e.getParameter(e.MAX_SAMPLES):0}}function Vs(e){const t=this;let i=null,n=0,s=!1,o=!1;const r=new Cs,a=new yt,l={value:null,needsUpdate:!1};function g(e,i,n,s){const o=null!==e?e.length:0;let g=null;if(0!==o){if(g=l.value,!0!==s||null===g){const t=n+4*o,s=i.matrixWorldInverse;a.getNormalMatrix(s),(null===g||g.length<t)&&(g=new Float32Array(t));for(let i=0,l=n;i!==o;++i,l+=4)r.copy(e[i]).applyMatrix4(s,a),r.normal.toArray(g,l),g[l+3]=r.constant}l.value=g,l.needsUpdate=!0}return t.numPlanes=o,t.numIntersection=0,g}this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(e,t){const i=0!==e.length||t||0!==n||s;return s=t,n=e.length,i},this.beginShadows=function(){o=!0,g(null)},this.endShadows=function(){o=!1},this.setGlobalState=function(e,t){i=g(e,t,0)},this.setState=function(r,a,c){const d=r.clippingPlanes,h=r.clipIntersection,u=r.clipShadows,I=e.get(r);if(!s||null===d||0===d.length||o&&!u)o?g(null):function(){l.value!==i&&(l.value=i,l.needsUpdate=n>0);t.numPlanes=n,t.numIntersection=0}();else{const e=o?0:n,t=4*e;let s=I.clippingState||null;l.value=s,s=g(d,a,t,c);for(let n=0;n!==t;++n)s[n]=i[n];I.clippingState=s,this.numIntersection=h?this.numPlanes:0,this.numPlanes+=e}}}function Ws(e){let t=new WeakMap;function i(e,t){return t===w?e.mapping=x:304===t&&(e.mapping=B),e}function n(e){const i=e.target;i.removeEventListener("dispose",n);const s=t.get(i);void 0!==s&&(t.delete(i),s.dispose())}return{get:function(s){if(s&&s.isTexture&&!1===s.isRenderTargetTexture){const o=s.mapping;if(o===w||304===o){if(t.has(s)){return i(t.get(s).texture,s.mapping)}{const o=s.image;if(o&&o.height>0){const r=new Is(o.height/2);return r.fromEquirectangularTexture(e,s),t.set(s,r),s.addEventListener("dispose",n),i(r.texture,s.mapping)}return null}}}return s},dispose:function(){t=new WeakMap}}}class Es extends gs{constructor(e=-1,t=1,i=1,n=-1,s=.1,o=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=i,this.bottom=n,this.near=s,this.far=o,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,t,i,n,s,o){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=n,this.view.width=s,this.view.height=o,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,n=(this.top+this.bottom)/2;let s=i-e,o=i+e,r=n+t,a=n-t;if(null!==this.view&&this.view.enabled){const e=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom;s+=e*this.view.offsetX,o=s+e*this.view.width,r-=t*this.view.offsetY,a=r-t*this.view.height}this.projectionMatrix.makeOrthographic(s,o,r,a,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}const Ns=[.125,.215,.35,.446,.526,.582],Fs=20,Xs=new Es,Hs=new In;let zs=null,Ls=0,Ds=0;const Ks=(1+Math.sqrt(5))/2,Ys=1/Ks,Ps=[new Qt(1,1,1),new Qt(-1,1,1),new Qt(1,1,-1),new Qt(-1,1,-1),new Qt(0,Ks,Ys),new Qt(0,Ks,-Ys),new Qt(Ys,0,Ks),new Qt(-Ys,0,Ks),new Qt(Ks,Ys,0),new Qt(-Ks,Ys,0)];class ks{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._compileMaterial(this._blurMaterial)}fromScene(e,t=0,i=.1,n=100){zs=this._renderer.getRenderTarget(),Ls=this._renderer.getActiveCubeFace(),Ds=this._renderer.getActiveMipmapLevel(),this._setSize(256);const s=this._allocateTargets();return s.depthBuffer=!0,this._sceneToCubeUV(e,i,n,s),t>0&&this._blur(s,0,0,t),this._applyPMREM(s),this._cleanup(s),s}fromEquirectangular(e,t=null){return this._fromTexture(e,t)}fromCubemap(e,t=null){return this._fromTexture(e,t)}compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=Js(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=Qs(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose()}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(zs,Ls,Ds),e.scissorTest=!1,Us(e,0,0,e.width,e.height)}_fromTexture(e,t){e.mapping===x||e.mapping===B?this._setSize(0===e.image.length?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4),zs=this._renderer.getRenderTarget(),Ls=this._renderer.getActiveCubeFace(),Ds=this._renderer.getActiveMipmapLevel();const i=t||this._allocateTargets();return this._textureToCubeUV(e,i),this._applyPMREM(i),this._cleanup(i),i}_allocateTargets(){const e=3*Math.max(this._cubeSize,112),t=4*this._cubeSize,i={magFilter:W,minFilter:W,generateMipmaps:!1,type:Y,format:U,colorSpace:Pe,depthBuffer:!1},n=Os(e,t,i);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==e||this._pingPongRenderTarget.height!==t){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=Os(e,t,i);const{_lodMax:n}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas}=function(e){const t=[],i=[],n=[];let s=e;const o=e-4+1+Ns.length;for(let r=0;r<o;r++){const o=Math.pow(2,s);i.push(o);let a=1/o;r>e-4?a=Ns[r-e+4-1]:0===r&&(a=0),n.push(a);const l=1/(o-2),g=-l,c=1+l,d=[g,g,c,g,c,c,g,g,c,c,g,c],h=6,u=6,I=3,p=2,m=1,A=new Float32Array(I*u*h),C=new Float32Array(p*u*h),f=new Float32Array(m*u*h);for(let e=0;e<h;e++){const t=e%3*2/3-1,i=e>2?0:-1,n=[t,i,0,t+2/3,i,0,t+2/3,i+1,0,t,i,0,t+2/3,i+1,0,t,i+1,0];A.set(n,I*u*e),C.set(d,p*u*e);const s=[e,e,e,e,e,e];f.set(s,m*u*e)}const b=new Fn;b.setAttribute("position",new Bn(A,I)),b.setAttribute("uv",new Bn(C,p)),b.setAttribute("faceIndex",new Bn(f,m)),t.push(b),s>4&&s--}return{lodPlanes:t,sizeLods:i,sigmas:n}}(n)),this._blurMaterial=function(e,t,i){const n=new Float32Array(Fs),s=new Qt(0,1,0),o=new ls({name:"SphericalGaussianBlur",defines:{n:Fs,CUBEUV_TEXEL_WIDTH:1/t,CUBEUV_TEXEL_HEIGHT:1/i,CUBEUV_MAX_MIP:`${e}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:n},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:s}},vertexShader:js(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform int samples;\n\t\t\tuniform float weights[ n ];\n\t\t\tuniform bool latitudinal;\n\t\t\tuniform float dTheta;\n\t\t\tuniform float mipInt;\n\t\t\tuniform vec3 poleAxis;\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\tvec3 getSample( float theta, vec3 axis ) {\n\n\t\t\t\tfloat cosTheta = cos( theta );\n\t\t\t\t// Rodrigues' axis-angle rotation\n\t\t\t\tvec3 sampleDirection = vOutputDirection * cosTheta\n\t\t\t\t\t+ cross( axis, vOutputDirection ) * sin( theta )\n\t\t\t\t\t+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );\n\n\t\t\t\treturn bilinearCubeUV( envMap, sampleDirection, mipInt );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );\n\n\t\t\t\tif ( all( equal( axis, vec3( 0.0 ) ) ) ) {\n\n\t\t\t\t\taxis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );\n\n\t\t\t\t}\n\n\t\t\t\taxis = normalize( axis );\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );\n\n\t\t\t\tfor ( int i = 1; i < n; i++ ) {\n\n\t\t\t\t\tif ( i >= samples ) {\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat theta = dTheta * float( i );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( theta, axis );\n\n\t\t\t\t}\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1});return o}(n,e,t)}return n}_compileMaterial(e){const t=new ts(this._lodPlanes[0],e);this._renderer.compile(t,Xs)}_sceneToCubeUV(e,t,i,n){const s=new cs(90,1,t,i),o=[1,-1,1,1,1,1],r=[1,1,1,-1,-1,-1],a=this._renderer,l=a.autoClear,g=a.toneMapping;a.getClearColor(Hs),a.toneMapping=A,a.autoClear=!1;const d=new Cn({name:"PMREM.Background",side:c,depthWrite:!1,depthTest:!1}),h=new ts(new ns,d);let u=!1;const I=e.background;I?I.isColor&&(d.color.copy(I),e.background=null,u=!0):(d.color.copy(Hs),u=!0);for(let c=0;c<6;c++){const t=c%3;0===t?(s.up.set(0,o[c],0),s.lookAt(r[c],0,0)):1===t?(s.up.set(0,0,o[c]),s.lookAt(0,r[c],0)):(s.up.set(0,o[c],0),s.lookAt(0,0,r[c]));const i=this._cubeSize;Us(n,t*i,c>2?i:0,i,i),a.setRenderTarget(n),u&&a.render(h,s),a.render(e,s)}h.geometry.dispose(),h.material.dispose(),a.toneMapping=g,a.autoClear=l,e.background=I}_textureToCubeUV(e,t){const i=this._renderer,n=e.mapping===x||e.mapping===B;n?(null===this._cubemapMaterial&&(this._cubemapMaterial=Js()),this._cubemapMaterial.uniforms.flipEnvMap.value=!1===e.isRenderTargetTexture?-1:1):null===this._equirectMaterial&&(this._equirectMaterial=Qs());const s=n?this._cubemapMaterial:this._equirectMaterial,o=new ts(this._lodPlanes[0],s);s.uniforms.envMap.value=e;const r=this._cubeSize;Us(t,0,0,3*r,2*r),i.setRenderTarget(t),i.render(o,Xs)}_applyPMREM(e){const t=this._renderer,i=t.autoClear;t.autoClear=!1;for(let n=1;n<this._lodPlanes.length;n++){const t=Math.sqrt(this._sigmas[n]*this._sigmas[n]-this._sigmas[n-1]*this._sigmas[n-1]),i=Ps[(n-1)%Ps.length];this._blur(e,n-1,n,t,i)}t.autoClear=i}_blur(e,t,i,n,s){const o=this._pingPongRenderTarget;this._halfBlur(e,o,t,i,n,"latitudinal",s),this._halfBlur(o,e,i,i,n,"longitudinal",s)}_halfBlur(e,t,i,n,s,o,r){const a=this._renderer,l=this._blurMaterial;"latitudinal"!==o&&"longitudinal"!==o&&console.error("blur direction must be either latitudinal or longitudinal!");const g=new ts(this._lodPlanes[n],l),c=l.uniforms,d=this._sizeLods[i]-1,h=isFinite(s)?Math.PI/(2*d):2*Math.PI/39,u=s/h,I=isFinite(s)?1+Math.floor(3*u):Fs;I>Fs&&console.warn(`sigmaRadians, ${s}, is too large and will clip, as it requested ${I} samples when the maximum is set to 20`);const p=[];let m=0;for(let f=0;f<Fs;++f){const e=f/u,t=Math.exp(-e*e/2);p.push(t),0===f?m+=t:f<I&&(m+=2*t)}for(let f=0;f<p.length;f++)p[f]=p[f]/m;c.envMap.value=e.texture,c.samples.value=I,c.weights.value=p,c.latitudinal.value="latitudinal"===o,r&&(c.poleAxis.value=r);const{_lodMax:A}=this;c.dTheta.value=h,c.mipInt.value=A-i;const C=this._sizeLods[n];Us(t,3*C*(n>A-4?n-A+4:0),4*(this._cubeSize-C),3*C,2*C),a.setRenderTarget(t),a.render(g,Xs)}}function Os(e,t,i){const n=new Yt(e,t,i);return n.texture.mapping=S,n.texture.name="PMREM.cubeUv",n.scissorTest=!0,n}function Us(e,t,i,n,s){e.viewport.set(t,i,n,s),e.scissor.set(t,i,n,s)}function Qs(){return new ls({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:js(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 outputDirection = normalize( vOutputDirection );\n\t\t\t\tvec2 uv = equirectUv( outputDirection );\n\n\t\t\t\tgl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function Js(){return new ls({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:js(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tuniform float flipEnvMap;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform samplerCube envMap;\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function js(){return"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t"}function qs(e){let t=new WeakMap,i=null;function n(e){const i=e.target;i.removeEventListener("dispose",n);const s=t.get(i);void 0!==s&&(t.delete(i),s.dispose())}return{get:function(s){if(s&&s.isTexture){const o=s.mapping,r=o===w||304===o,a=o===x||o===B;if(r||a){if(s.isRenderTargetTexture&&!0===s.needsPMREMUpdate){s.needsPMREMUpdate=!1;let n=t.get(s);return null===i&&(i=new ks(e)),n=r?i.fromEquirectangular(s,n):i.fromCubemap(s,n),t.set(s,n),n.texture}if(t.has(s))return t.get(s).texture;{const o=s.image;if(r&&o&&o.height>0||a&&o&&function(e){let t=0;const i=6;for(let n=0;n<i;n++)void 0!==e[n]&&t++;return t===i}(o)){null===i&&(i=new ks(e));const o=r?i.fromEquirectangular(s):i.fromCubemap(s);return t.set(s,o),s.addEventListener("dispose",n),o.texture}return null}}}return s},dispose:function(){t=new WeakMap,null!==i&&(i.dispose(),i=null)}}}function $s(e){const t={};function i(i){if(void 0!==t[i])return t[i];let n;switch(i){case"WEBGL_depth_texture":n=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":n=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:n=e.getExtension(i)}return t[i]=n,n}return{has:function(e){return null!==i(e)},init:function(e){e.isWebGL2?i("EXT_color_buffer_float"):(i("WEBGL_depth_texture"),i("OES_texture_float"),i("OES_texture_half_float"),i("OES_texture_half_float_linear"),i("OES_standard_derivatives"),i("OES_element_index_uint"),i("OES_vertex_array_object"),i("ANGLE_instanced_arrays")),i("OES_texture_float_linear"),i("EXT_color_buffer_half_float"),i("WEBGL_multisampled_render_to_texture")},get:function(e){const t=i(e);return null===t&&console.warn("THREE.WebGLRenderer: "+e+" extension not supported."),t}}}function eo(e,t,i,n){const s={},o=new WeakMap;function r(e){const a=e.target;null!==a.index&&t.remove(a.index);for(const i in a.attributes)t.remove(a.attributes[i]);for(const i in a.morphAttributes){const e=a.morphAttributes[i];for(let i=0,n=e.length;i<n;i++)t.remove(e[i])}a.removeEventListener("dispose",r),delete s[a.id];const l=o.get(a);l&&(t.remove(l),o.delete(a)),n.releaseStatesOfGeometry(a),!0===a.isInstancedBufferGeometry&&delete a._maxInstanceCount,i.memory.geometries--}function a(e){const i=[],n=e.index,s=e.attributes.position;let r=0;if(null!==n){const e=n.array;r=n.version;for(let t=0,n=e.length;t<n;t+=3){const n=e[t+0],s=e[t+1],o=e[t+2];i.push(n,s,s,o,o,n)}}else{if(void 0===s)return;{const e=s.array;r=s.version;for(let t=0,n=e.length/3-1;t<n;t+=3){const e=t+0,n=t+1,s=t+2;i.push(e,n,n,s,s,e)}}}const a=new(vt(i)?Sn:wn)(i,1);a.version=r;const l=o.get(e);l&&t.remove(l),o.set(e,a)}return{get:function(e,t){return!0===s[t.id]||(t.addEventListener("dispose",r),s[t.id]=!0,i.memory.geometries++),t},update:function(i){const n=i.attributes;for(const o in n)t.update(n[o],e.ARRAY_BUFFER);const s=i.morphAttributes;for(const o in s){const i=s[o];for(let n=0,s=i.length;n<s;n++)t.update(i[n],e.ARRAY_BUFFER)}},getWireframeAttribute:function(e){const t=o.get(e);if(t){const i=e.index;null!==i&&t.version<i.version&&a(e)}else a(e);return o.get(e)}}}function to(e,t,i,n){const s=n.isWebGL2;let o,r,a;this.setMode=function(e){o=e},this.setIndex=function(e){r=e.type,a=e.bytesPerElement},this.render=function(t,n){e.drawElements(o,n,r,t*a),i.update(n,o,1)},this.renderInstances=function(n,l,g){if(0===g)return;let c,d;if(s)c=e,d="drawElementsInstanced";else if(c=t.get("ANGLE_instanced_arrays"),d="drawElementsInstancedANGLE",null===c)return void console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");c[d](o,l,r,n*a,g),i.update(l,o,g)}}function io(e){const t={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:t,programs:null,autoReset:!0,reset:function(){t.calls=0,t.triangles=0,t.points=0,t.lines=0},update:function(i,n,s){switch(t.calls++,n){case e.TRIANGLES:t.triangles+=s*(i/3);break;case e.LINES:t.lines+=s*(i/2);break;case e.LINE_STRIP:t.lines+=s*(i-1);break;case e.LINE_LOOP:t.lines+=s*i;break;case e.POINTS:t.points+=s*i;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",n)}}}}function no(e,t){return e[0]-t[0]}function so(e,t){return Math.abs(t[1])-Math.abs(e[1])}function oo(e,t,i){const n={},s=new Float32Array(8),o=new WeakMap,r=new Dt,a=[];for(let l=0;l<8;l++)a[l]=[l,0];return{update:function(l,g,c){const d=l.morphTargetInfluences;if(!0===t.isWebGL2){const n=g.morphAttributes.position||g.morphAttributes.normal||g.morphAttributes.color,s=void 0!==n?n.length:0;let a=o.get(g);if(void 0===a||a.count!==s){let e=function(){A.dispose(),o.delete(g),g.removeEventListener("dispose",e)};void 0!==a&&a.texture.dispose();const i=void 0!==g.morphAttributes.position,n=void 0!==g.morphAttributes.normal,l=void 0!==g.morphAttributes.color,c=g.morphAttributes.position||[],d=g.morphAttributes.normal||[],h=g.morphAttributes.color||[];let u=0;!0===i&&(u=1),!0===n&&(u=2),!0===l&&(u=3);let I=g.attributes.position.count*u,p=1;I>t.maxTextureSize&&(p=Math.ceil(I/t.maxTextureSize),I=t.maxTextureSize);const m=new Float32Array(I*p*4*s),A=new Pt(m,I,p,s);A.type=K,A.needsUpdate=!0;const C=4*u;for(let t=0;t<s;t++){const e=c[t],s=d[t],o=h[t],a=I*p*4*t;for(let t=0;t<e.count;t++){const g=t*C;!0===i&&(r.fromBufferAttribute(e,t),m[a+g+0]=r.x,m[a+g+1]=r.y,m[a+g+2]=r.z,m[a+g+3]=0),!0===n&&(r.fromBufferAttribute(s,t),m[a+g+4]=r.x,m[a+g+5]=r.y,m[a+g+6]=r.z,m[a+g+7]=0),!0===l&&(r.fromBufferAttribute(o,t),m[a+g+8]=r.x,m[a+g+9]=r.y,m[a+g+10]=r.z,m[a+g+11]=4===o.itemSize?r.w:1)}}a={count:s,texture:A,size:new bt(I,p)},o.set(g,a),g.addEventListener("dispose",e)}let l=0;for(let e=0;e<d.length;e++)l+=d[e];const h=g.morphTargetsRelative?1:1-l;c.getUniforms().setValue(e,"morphTargetBaseInfluence",h),c.getUniforms().setValue(e,"morphTargetInfluences",d),c.getUniforms().setValue(e,"morphTargetsTexture",a.texture,i),c.getUniforms().setValue(e,"morphTargetsTextureSize",a.size)}else{const t=void 0===d?0:d.length;let i=n[g.id];if(void 0===i||i.length!==t){i=[];for(let e=0;e<t;e++)i[e]=[e,0];n[g.id]=i}for(let e=0;e<t;e++){const t=i[e];t[0]=e,t[1]=d[e]}i.sort(so);for(let e=0;e<8;e++)e<t&&i[e][1]?(a[e][0]=i[e][0],a[e][1]=i[e][1]):(a[e][0]=Number.MAX_SAFE_INTEGER,a[e][1]=0);a.sort(no);const o=g.morphAttributes.position,r=g.morphAttributes.normal;let l=0;for(let e=0;e<8;e++){const t=a[e],i=t[0],n=t[1];i!==Number.MAX_SAFE_INTEGER&&n?(o&&g.getAttribute("morphTarget"+e)!==o[i]&&g.setAttribute("morphTarget"+e,o[i]),r&&g.getAttribute("morphNormal"+e)!==r[i]&&g.setAttribute("morphNormal"+e,r[i]),s[e]=n,l+=n):(o&&!0===g.hasAttribute("morphTarget"+e)&&g.deleteAttribute("morphTarget"+e),r&&!0===g.hasAttribute("morphNormal"+e)&&g.deleteAttribute("morphNormal"+e),s[e]=0)}const h=g.morphTargetsRelative?1:1-l;c.getUniforms().setValue(e,"morphTargetBaseInfluence",h),c.getUniforms().setValue(e,"morphTargetInfluences",s)}}}}function ro(e,t,i,n){let s=new WeakMap;function o(e){const t=e.target;t.removeEventListener("dispose",o),i.remove(t.instanceMatrix),null!==t.instanceColor&&i.remove(t.instanceColor)}return{update:function(r){const a=n.render.frame,l=r.geometry,g=t.get(r,l);if(s.get(g)!==a&&(t.update(g),s.set(g,a)),r.isInstancedMesh&&(!1===r.hasEventListener("dispose",o)&&r.addEventListener("dispose",o),s.get(r)!==a&&(i.update(r.instanceMatrix,e.ARRAY_BUFFER),null!==r.instanceColor&&i.update(r.instanceColor,e.ARRAY_BUFFER),s.set(r,a))),r.isSkinnedMesh){const e=r.skeleton;s.get(e)!==a&&(e.update(),s.set(e,a))}return g},dispose:function(){s=new WeakMap}}}const ao=new Lt,lo=new Pt,go=new kt,co=new us,ho=[],uo=[],Io=new Float32Array(16),po=new Float32Array(9),mo=new Float32Array(4);function Ao(e,t,i){const n=e[0];if(n<=0||n>0)return e;const s=t*i;let o=ho[s];if(void 0===o&&(o=new Float32Array(s),ho[s]=o),0!==t){n.toArray(o,0);for(let n=1,s=0;n!==t;++n)s+=i,e[n].toArray(o,s)}return o}function Co(e,t){if(e.length!==t.length)return!1;for(let i=0,n=e.length;i<n;i++)if(e[i]!==t[i])return!1;return!0}function fo(e,t){for(let i=0,n=t.length;i<n;i++)e[i]=t[i]}function bo(e,t){let i=uo[t];void 0===i&&(i=new Int32Array(t),uo[t]=i);for(let n=0;n!==t;++n)i[n]=e.allocateTextureUnit();return i}function yo(e,t){const i=this.cache;i[0]!==t&&(e.uniform1f(this.addr,t),i[0]=t)}function _o(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y||(e.uniform2f(this.addr,t.x,t.y),i[0]=t.x,i[1]=t.y);else{if(Co(i,t))return;e.uniform2fv(this.addr,t),fo(i,t)}}function vo(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z||(e.uniform3f(this.addr,t.x,t.y,t.z),i[0]=t.x,i[1]=t.y,i[2]=t.z);else if(void 0!==t.r)i[0]===t.r&&i[1]===t.g&&i[2]===t.b||(e.uniform3f(this.addr,t.r,t.g,t.b),i[0]=t.r,i[1]=t.g,i[2]=t.b);else{if(Co(i,t))return;e.uniform3fv(this.addr,t),fo(i,t)}}function xo(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z&&i[3]===t.w||(e.uniform4f(this.addr,t.x,t.y,t.z,t.w),i[0]=t.x,i[1]=t.y,i[2]=t.z,i[3]=t.w);else{if(Co(i,t))return;e.uniform4fv(this.addr,t),fo(i,t)}}function Bo(e,t){const i=this.cache,n=t.elements;if(void 0===n){if(Co(i,t))return;e.uniformMatrix2fv(this.addr,!1,t),fo(i,t)}else{if(Co(i,n))return;mo.set(n),e.uniformMatrix2fv(this.addr,!1,mo),fo(i,n)}}function wo(e,t){const i=this.cache,n=t.elements;if(void 0===n){if(Co(i,t))return;e.uniformMatrix3fv(this.addr,!1,t),fo(i,t)}else{if(Co(i,n))return;po.set(n),e.uniformMatrix3fv(this.addr,!1,po),fo(i,n)}}function So(e,t){const i=this.cache,n=t.elements;if(void 0===n){if(Co(i,t))return;e.uniformMatrix4fv(this.addr,!1,t),fo(i,t)}else{if(Co(i,n))return;Io.set(n),e.uniformMatrix4fv(this.addr,!1,Io),fo(i,n)}}function Go(e,t){const i=this.cache;i[0]!==t&&(e.uniform1i(this.addr,t),i[0]=t)}function Mo(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y||(e.uniform2i(this.addr,t.x,t.y),i[0]=t.x,i[1]=t.y);else{if(Co(i,t))return;e.uniform2iv(this.addr,t),fo(i,t)}}function Ro(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z||(e.uniform3i(this.addr,t.x,t.y,t.z),i[0]=t.x,i[1]=t.y,i[2]=t.z);else{if(Co(i,t))return;e.uniform3iv(this.addr,t),fo(i,t)}}function To(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z&&i[3]===t.w||(e.uniform4i(this.addr,t.x,t.y,t.z,t.w),i[0]=t.x,i[1]=t.y,i[2]=t.z,i[3]=t.w);else{if(Co(i,t))return;e.uniform4iv(this.addr,t),fo(i,t)}}function Zo(e,t){const i=this.cache;i[0]!==t&&(e.uniform1ui(this.addr,t),i[0]=t)}function Vo(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y||(e.uniform2ui(this.addr,t.x,t.y),i[0]=t.x,i[1]=t.y);else{if(Co(i,t))return;e.uniform2uiv(this.addr,t),fo(i,t)}}function Wo(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z||(e.uniform3ui(this.addr,t.x,t.y,t.z),i[0]=t.x,i[1]=t.y,i[2]=t.z);else{if(Co(i,t))return;e.uniform3uiv(this.addr,t),fo(i,t)}}function Eo(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z&&i[3]===t.w||(e.uniform4ui(this.addr,t.x,t.y,t.z,t.w),i[0]=t.x,i[1]=t.y,i[2]=t.z,i[3]=t.w);else{if(Co(i,t))return;e.uniform4uiv(this.addr,t),fo(i,t)}}function No(e,t,i){const n=this.cache,s=i.allocateTextureUnit();n[0]!==s&&(e.uniform1i(this.addr,s),n[0]=s),i.setTexture2D(t||ao,s)}function Fo(e,t,i){const n=this.cache,s=i.allocateTextureUnit();n[0]!==s&&(e.uniform1i(this.addr,s),n[0]=s),i.setTexture3D(t||go,s)}function Xo(e,t,i){const n=this.cache,s=i.allocateTextureUnit();n[0]!==s&&(e.uniform1i(this.addr,s),n[0]=s),i.setTextureCube(t||co,s)}function Ho(e,t,i){const n=this.cache,s=i.allocateTextureUnit();n[0]!==s&&(e.uniform1i(this.addr,s),n[0]=s),i.setTexture2DArray(t||lo,s)}function zo(e,t){e.uniform1fv(this.addr,t)}function Lo(e,t){const i=Ao(t,this.size,2);e.uniform2fv(this.addr,i)}function Do(e,t){const i=Ao(t,this.size,3);e.uniform3fv(this.addr,i)}function Ko(e,t){const i=Ao(t,this.size,4);e.uniform4fv(this.addr,i)}function Yo(e,t){const i=Ao(t,this.size,4);e.uniformMatrix2fv(this.addr,!1,i)}function Po(e,t){const i=Ao(t,this.size,9);e.uniformMatrix3fv(this.addr,!1,i)}function ko(e,t){const i=Ao(t,this.size,16);e.uniformMatrix4fv(this.addr,!1,i)}function Oo(e,t){e.uniform1iv(this.addr,t)}function Uo(e,t){e.uniform2iv(this.addr,t)}function Qo(e,t){e.uniform3iv(this.addr,t)}function Jo(e,t){e.uniform4iv(this.addr,t)}function jo(e,t){e.uniform1uiv(this.addr,t)}function qo(e,t){e.uniform2uiv(this.addr,t)}function $o(e,t){e.uniform3uiv(this.addr,t)}function er(e,t){e.uniform4uiv(this.addr,t)}function tr(e,t,i){const n=this.cache,s=t.length,o=bo(i,s);Co(n,o)||(e.uniform1iv(this.addr,o),fo(n,o));for(let r=0;r!==s;++r)i.setTexture2D(t[r]||ao,o[r])}function ir(e,t,i){const n=this.cache,s=t.length,o=bo(i,s);Co(n,o)||(e.uniform1iv(this.addr,o),fo(n,o));for(let r=0;r!==s;++r)i.setTexture3D(t[r]||go,o[r])}function nr(e,t,i){const n=this.cache,s=t.length,o=bo(i,s);Co(n,o)||(e.uniform1iv(this.addr,o),fo(n,o));for(let r=0;r!==s;++r)i.setTextureCube(t[r]||co,o[r])}function sr(e,t,i){const n=this.cache,s=t.length,o=bo(i,s);Co(n,o)||(e.uniform1iv(this.addr,o),fo(n,o));for(let r=0;r!==s;++r)i.setTexture2DArray(t[r]||lo,o[r])}class or{constructor(e,t,i){this.id=e,this.addr=i,this.cache=[],this.setValue=function(e){switch(e){case 5126:return yo;case 35664:return _o;case 35665:return vo;case 35666:return xo;case 35674:return Bo;case 35675:return wo;case 35676:return So;case 5124:case 35670:return Go;case 35667:case 35671:return Mo;case 35668:case 35672:return Ro;case 35669:case 35673:return To;case 5125:return Zo;case 36294:return Vo;case 36295:return Wo;case 36296:return Eo;case 35678:case 36198:case 36298:case 36306:case 35682:return No;case 35679:case 36299:case 36307:return Fo;case 35680:case 36300:case 36308:case 36293:return Xo;case 36289:case 36303:case 36311:case 36292:return Ho}}(t.type)}}class rr{constructor(e,t,i){this.id=e,this.addr=i,this.cache=[],this.size=t.size,this.setValue=function(e){switch(e){case 5126:return zo;case 35664:return Lo;case 35665:return Do;case 35666:return Ko;case 35674:return Yo;case 35675:return Po;case 35676:return ko;case 5124:case 35670:return Oo;case 35667:case 35671:return Uo;case 35668:case 35672:return Qo;case 35669:case 35673:return Jo;case 5125:return jo;case 36294:return qo;case 36295:return $o;case 36296:return er;case 35678:case 36198:case 36298:case 36306:case 35682:return tr;case 35679:case 36299:case 36307:return ir;case 35680:case 36300:case 36308:case 36293:return nr;case 36289:case 36303:case 36311:case 36292:return sr}}(t.type)}}class ar{constructor(e){this.id=e,this.seq=[],this.map={}}setValue(e,t,i){const n=this.seq;for(let s=0,o=n.length;s!==o;++s){const o=n[s];o.setValue(e,t[o.id],i)}}}const lr=/(\w+)(\])?(\[|\.)?/g;function gr(e,t){e.seq.push(t),e.map[t.id]=t}function cr(e,t,i){const n=e.name,s=n.length;for(lr.lastIndex=0;;){const o=lr.exec(n),r=lr.lastIndex;let a=o[1];const l="]"===o[2],g=o[3];if(l&&(a|=0),void 0===g||"["===g&&r+2===s){gr(i,void 0===g?new or(a,e,t):new rr(a,e,t));break}{let e=i.map[a];void 0===e&&(e=new ar(a),gr(i,e)),i=e}}}class dr{constructor(e,t){this.seq=[],this.map={};const i=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(let n=0;n<i;++n){const i=e.getActiveUniform(t,n);cr(i,e.getUniformLocation(t,i.name),this)}}setValue(e,t,i,n){const s=this.map[t];void 0!==s&&s.setValue(e,i,n)}setOptional(e,t,i){const n=t[i];void 0!==n&&this.setValue(e,i,n)}static upload(e,t,i,n){for(let s=0,o=t.length;s!==o;++s){const o=t[s],r=i[o.id];!1!==r.needsUpdate&&o.setValue(e,r.value,n)}}static seqWithValue(e,t){const i=[];for(let n=0,s=e.length;n!==s;++n){const s=e[n];s.id in t&&i.push(s)}return i}}function hr(e,t,i){const n=e.createShader(t);return e.shaderSource(n,i),e.compileShader(n),n}const ur=37297;let Ir=0;function pr(e,t,i){const n=e.getShaderParameter(t,e.COMPILE_STATUS),s=e.getShaderInfoLog(t).trim();if(n&&""===s)return"";const o=/ERROR: 0:(\d+)/.exec(s);if(o){const n=parseInt(o[1]);return i.toUpperCase()+"\n\n"+s+"\n\n"+function(e,t){const i=e.split("\n"),n=[],s=Math.max(t-6,0),o=Math.min(t+6,i.length);for(let r=s;r<o;r++){const e=r+1;n.push(`${e===t?">":" "} ${e}: ${i[r]}`)}return n.join("\n")}(e.getShaderSource(t),n)}return s}function mr(e,t){const i=function(e){const t=Zt.getPrimaries(Zt.workingColorSpace),i=Zt.getPrimaries(e);let n;switch(t===i?n="":t===je&&i===Je?n="LinearDisplayP3ToLinearSRGB":t===Je&&i===je&&(n="LinearSRGBToLinearDisplayP3"),e){case Pe:case Oe:return[n,"LinearTransferOETF"];case Ye:case ke:return[n,"sRGBTransferOETF"];default:return console.warn("THREE.WebGLProgram: Unsupported color space:",e),[n,"LinearTransferOETF"]}}(t);return`vec4 ${e}( vec4 value ) { return ${i[0]}( ${i[1]}( value ) ); }`}function Ar(e,t){let i;switch(t){case C:i="Linear";break;case f:i="Reinhard";break;case b:i="OptimizedCineon";break;case y:i="ACESFilmic";break;case _:i="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",t),i="Linear"}return"vec3 "+e+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}function Cr(e){return""!==e}function fr(e,t){const i=t.numSpotLightShadows+t.numSpotLightMaps-t.numSpotLightShadowsWithMaps;return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,t.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,i).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,t.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,t.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,t.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,t.numPointLightShadows)}function br(e,t){return e.replace(/NUM_CLIPPING_PLANES/g,t.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,t.numClippingPlanes-t.numClipIntersection)}const yr=/^[ \t]*#include +<([\w\d./]+)>/gm;function _r(e){return e.replace(yr,xr)}const vr=new Map([["encodings_fragment","colorspace_fragment"],["encodings_pars_fragment","colorspace_pars_fragment"],["output_fragment","opaque_fragment"]]);function xr(e,t){let i=Bs[t];if(void 0===i){const e=vr.get(t);if(void 0===e)throw new Error("Can not resolve #include <"+t+">");i=Bs[e],console.warn('THREE.WebGLRenderer: Shader chunk "%s" has been deprecated. Use "%s" instead.',t,e)}return _r(i)}const Br=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function wr(e){return e.replace(Br,Sr)}function Sr(e,t,i,n){let s="";for(let o=parseInt(t);o<parseInt(i);o++)s+=n.replace(/\[\s*i\s*\]/g,"[ "+o+" ]").replace(/UNROLLED_LOOP_INDEX/g,o);return s}function Gr(e){let t="precision "+e.precision+" float;\nprecision "+e.precision+" int;";return"highp"===e.precision?t+="\n#define HIGH_PRECISION":"mediump"===e.precision?t+="\n#define MEDIUM_PRECISION":"lowp"===e.precision&&(t+="\n#define LOW_PRECISION"),t}function Mr(e,t,i,n){const s=e.getContext(),o=i.defines;let g=i.vertexShader,c=i.fragmentShader;const d=function(e){let t="SHADOWMAP_TYPE_BASIC";return e.shadowMapType===r?t="SHADOWMAP_TYPE_PCF":e.shadowMapType===a?t="SHADOWMAP_TYPE_PCF_SOFT":e.shadowMapType===l&&(t="SHADOWMAP_TYPE_VSM"),t}(i),h=function(e){let t="ENVMAP_TYPE_CUBE";if(e.envMap)switch(e.envMapMode){case x:case B:t="ENVMAP_TYPE_CUBE";break;case S:t="ENVMAP_TYPE_CUBE_UV"}return t}(i),u=function(e){let t="ENVMAP_MODE_REFLECTION";e.envMap&&e.envMapMode===B&&(t="ENVMAP_MODE_REFRACTION");return t}(i),C=function(e){let t="ENVMAP_BLENDING_NONE";if(e.envMap)switch(e.combine){case I:t="ENVMAP_BLENDING_MULTIPLY";break;case p:t="ENVMAP_BLENDING_MIX";break;case m:t="ENVMAP_BLENDING_ADD"}return t}(i),f=function(e){const t=e.envMapCubeUVHeight;if(null===t)return null;const i=Math.log2(t)-2,n=1/t;return{texelWidth:1/(3*Math.max(Math.pow(2,i),112)),texelHeight:n,maxMip:i}}(i),b=i.isWebGL2?"":function(e){return[e.extensionDerivatives||e.envMapCubeUVHeight||e.bumpMap||e.normalMapTangentSpace||e.clearcoatNormalMap||e.flatShading||"physical"===e.shaderID?"#extension GL_OES_standard_derivatives : enable":"",(e.extensionFragDepth||e.logarithmicDepthBuffer)&&e.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",e.extensionDrawBuffers&&e.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(e.extensionShaderTextureLOD||e.envMap||e.transmission)&&e.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(Cr).join("\n")}(i),y=function(e){const t=[];for(const i in e){const n=e[i];!1!==n&&t.push("#define "+i+" "+n)}return t.join("\n")}(o),_=s.createProgram();let v,w,G=i.glslVersion?"#version "+i.glslVersion+"\n":"";i.isRawShaderMaterial?(v=["#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,y].filter(Cr).join("\n"),v.length>0&&(v+="\n"),w=[b,"#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,y].filter(Cr).join("\n"),w.length>0&&(w+="\n")):(v=[Gr(i),"#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,y,i.instancing?"#define USE_INSTANCING":"",i.instancingColor?"#define USE_INSTANCING_COLOR":"",i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+u:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",i.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",i.displacementMap?"#define USE_DISPLACEMENTMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.anisotropy?"#define USE_ANISOTROPY":"",i.anisotropyMap?"#define USE_ANISOTROPYMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",i.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",i.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.alphaHash?"#define USE_ALPHAHASH":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",i.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",i.mapUv?"#define MAP_UV "+i.mapUv:"",i.alphaMapUv?"#define ALPHAMAP_UV "+i.alphaMapUv:"",i.lightMapUv?"#define LIGHTMAP_UV "+i.lightMapUv:"",i.aoMapUv?"#define AOMAP_UV "+i.aoMapUv:"",i.emissiveMapUv?"#define EMISSIVEMAP_UV "+i.emissiveMapUv:"",i.bumpMapUv?"#define BUMPMAP_UV "+i.bumpMapUv:"",i.normalMapUv?"#define NORMALMAP_UV "+i.normalMapUv:"",i.displacementMapUv?"#define DISPLACEMENTMAP_UV "+i.displacementMapUv:"",i.metalnessMapUv?"#define METALNESSMAP_UV "+i.metalnessMapUv:"",i.roughnessMapUv?"#define ROUGHNESSMAP_UV "+i.roughnessMapUv:"",i.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+i.anisotropyMapUv:"",i.clearcoatMapUv?"#define CLEARCOATMAP_UV "+i.clearcoatMapUv:"",i.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+i.clearcoatNormalMapUv:"",i.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+i.clearcoatRoughnessMapUv:"",i.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+i.iridescenceMapUv:"",i.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+i.iridescenceThicknessMapUv:"",i.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+i.sheenColorMapUv:"",i.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+i.sheenRoughnessMapUv:"",i.specularMapUv?"#define SPECULARMAP_UV "+i.specularMapUv:"",i.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+i.specularColorMapUv:"",i.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+i.specularIntensityMapUv:"",i.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+i.transmissionMapUv:"",i.thicknessMapUv?"#define THICKNESSMAP_UV "+i.thicknessMapUv:"",i.vertexTangents&&!1===i.flatShading?"#define USE_TANGENT":"",i.vertexColors?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUv1s?"#define USE_UV1":"",i.vertexUv2s?"#define USE_UV2":"",i.vertexUv3s?"#define USE_UV3":"",i.pointsUvs?"#define USE_POINTS_UV":"",i.flatShading?"#define FLAT_SHADED":"",i.skinning?"#define USE_SKINNING":"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals&&!1===i.flatShading?"#define USE_MORPHNORMALS":"",i.morphColors&&i.isWebGL2?"#define USE_MORPHCOLORS":"",i.morphTargetsCount>0&&i.isWebGL2?"#define MORPHTARGETS_TEXTURE":"",i.morphTargetsCount>0&&i.isWebGL2?"#define MORPHTARGETS_TEXTURE_STRIDE "+i.morphTextureStride:"",i.morphTargetsCount>0&&i.isWebGL2?"#define MORPHTARGETS_COUNT "+i.morphTargetsCount:"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+d:"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"",i.numLightProbes>0?"#define USE_LIGHT_PROBES":"",i.useLegacyLights?"#define LEGACY_LIGHTS":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","\tattribute vec2 uv1;","#endif","#ifdef USE_UV2","\tattribute vec2 uv2;","#endif","#ifdef USE_UV3","\tattribute vec2 uv3;","#endif","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#if ( defined( USE_MORPHTARGETS ) && ! defined( MORPHTARGETS_TEXTURE ) )","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(Cr).join("\n"),w=[b,Gr(i),"#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,y,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.matcap?"#define USE_MATCAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+h:"",i.envMap?"#define "+u:"",i.envMap?"#define "+C:"",f?"#define CUBEUV_TEXEL_WIDTH "+f.texelWidth:"",f?"#define CUBEUV_TEXEL_HEIGHT "+f.texelHeight:"",f?"#define CUBEUV_MAX_MIP "+f.maxMip+".0":"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",i.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.anisotropy?"#define USE_ANISOTROPY":"",i.anisotropyMap?"#define USE_ANISOTROPYMAP":"",i.clearcoat?"#define USE_CLEARCOAT":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.iridescence?"#define USE_IRIDESCENCE":"",i.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",i.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",i.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.alphaTest?"#define USE_ALPHATEST":"",i.alphaHash?"#define USE_ALPHAHASH":"",i.sheen?"#define USE_SHEEN":"",i.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",i.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.vertexTangents&&!1===i.flatShading?"#define USE_TANGENT":"",i.vertexColors||i.instancingColor?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUv1s?"#define USE_UV1":"",i.vertexUv2s?"#define USE_UV2":"",i.vertexUv3s?"#define USE_UV3":"",i.pointsUvs?"#define USE_POINTS_UV":"",i.gradientMap?"#define USE_GRADIENTMAP":"",i.flatShading?"#define FLAT_SHADED":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+d:"",i.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",i.numLightProbes>0?"#define USE_LIGHT_PROBES":"",i.useLegacyLights?"#define LEGACY_LIGHTS":"",i.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",i.toneMapping!==A?"#define TONE_MAPPING":"",i.toneMapping!==A?Bs.tonemapping_pars_fragment:"",i.toneMapping!==A?Ar("toneMapping",i.toneMapping):"",i.dithering?"#define DITHERING":"",i.opaque?"#define OPAQUE":"",Bs.colorspace_pars_fragment,mr("linearToOutputTexel",i.outputColorSpace),i.useDepthPacking?"#define DEPTH_PACKING "+i.depthPacking:"","\n"].filter(Cr).join("\n")),g=_r(g),g=fr(g,i),g=br(g,i),c=_r(c),c=fr(c,i),c=br(c,i),g=wr(g),c=wr(c),i.isWebGL2&&!0!==i.isRawShaderMaterial&&(G="#version 300 es\n",v=["precision mediump sampler2DArray;","#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+v,w=["precision mediump sampler2DArray;","#define varying in",i.glslVersion===tt?"":"layout(location = 0) out highp vec4 pc_fragColor;",i.glslVersion===tt?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+w);const M=G+v+g,R=G+w+c,T=hr(s,s.VERTEX_SHADER,M),Z=hr(s,s.FRAGMENT_SHADER,R);function V(t){if(e.debug.checkShaderErrors){const i=s.getProgramInfoLog(_).trim(),n=s.getShaderInfoLog(T).trim(),o=s.getShaderInfoLog(Z).trim();let r=!0,a=!0;if(!1===s.getProgramParameter(_,s.LINK_STATUS))if(r=!1,"function"==typeof e.debug.onShaderError)e.debug.onShaderError(s,_,T,Z);else{const e=pr(s,T,"vertex"),t=pr(s,Z,"fragment");console.error("THREE.WebGLProgram: Shader Error "+s.getError()+" - VALIDATE_STATUS "+s.getProgramParameter(_,s.VALIDATE_STATUS)+"\n\nProgram Info Log: "+i+"\n"+e+"\n"+t)}else""!==i?console.warn("THREE.WebGLProgram: Program Info Log:",i):""!==n&&""!==o||(a=!1);a&&(t.diagnostics={runnable:r,programLog:i,vertexShader:{log:n,prefix:v},fragmentShader:{log:o,prefix:w}})}s.deleteShader(T),s.deleteShader(Z),W=new dr(s,_),E=function(e,t){const i={},n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(let s=0;s<n;s++){const n=e.getActiveAttrib(t,s),o=n.name;let r=1;n.type===e.FLOAT_MAT2&&(r=2),n.type===e.FLOAT_MAT3&&(r=3),n.type===e.FLOAT_MAT4&&(r=4),i[o]={type:n.type,location:e.getAttribLocation(t,o),locationSize:r}}return i}(s,_)}let W,E;s.attachShader(_,T),s.attachShader(_,Z),void 0!==i.index0AttributeName?s.bindAttribLocation(_,0,i.index0AttributeName):!0===i.morphTargets&&s.bindAttribLocation(_,0,"position"),s.linkProgram(_),this.getUniforms=function(){return void 0===W&&V(this),W},this.getAttributes=function(){return void 0===E&&V(this),E};let N=!1===i.rendererExtensionParallelShaderCompile;return this.isReady=function(){return!1===N&&(N=s.getProgramParameter(_,ur)),N},this.destroy=function(){n.releaseStatesOfProgram(this),s.deleteProgram(_),this.program=void 0},this.type=i.shaderType,this.name=i.shaderName,this.id=Ir++,this.cacheKey=t,this.usedTimes=1,this.program=_,this.vertexShader=T,this.fragmentShader=Z,this}let Rr=0;class Tr{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(e){const t=e.vertexShader,i=e.fragmentShader,n=this._getShaderStage(t),s=this._getShaderStage(i),o=this._getShaderCacheForMaterial(e);return!1===o.has(n)&&(o.add(n),n.usedTimes++),!1===o.has(s)&&(o.add(s),s.usedTimes++),this}remove(e){const t=this.materialCache.get(e);for(const i of t)i.usedTimes--,0===i.usedTimes&&this.shaderCache.delete(i.code);return this.materialCache.delete(e),this}getVertexShaderID(e){return this._getShaderStage(e.vertexShader).id}getFragmentShaderID(e){return this._getShaderStage(e.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(e){const t=this.materialCache;let i=t.get(e);return void 0===i&&(i=new Set,t.set(e,i)),i}_getShaderStage(e){const t=this.shaderCache;let i=t.get(e);return void 0===i&&(i=new Zr(e),t.set(e,i)),i}}class Zr{constructor(e){this.id=Rr++,this.code=e,this.usedTimes=0}}function Vr(e,t,i,n,s,o,r){const a=new Ni,l=new Tr,g=[],d=s.isWebGL2,h=s.logarithmicDepthBuffer,u=s.vertexTextures;let I=s.precision;const p={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function m(e){return 0===e?"uv":`uv${e}`}return{getParameters:function(o,a,g,C,f){const b=C.fog,y=f.geometry,_=o.isMeshStandardMaterial?C.environment:null,v=(o.isMeshStandardMaterial?i:t).get(o.envMap||_),x=v&&v.mapping===S?v.image.height:null,B=p[o.type];null!==o.precision&&(I=s.getMaxPrecision(o.precision),I!==o.precision&&console.warn("THREE.WebGLProgram.getParameters:",o.precision,"not supported, using",I,"instead."));const w=y.morphAttributes.position||y.morphAttributes.normal||y.morphAttributes.color,G=void 0!==w?w.length:0;let M,R,T,Z,V=0;if(void 0!==y.morphAttributes.position&&(V=1),void 0!==y.morphAttributes.normal&&(V=2),void 0!==y.morphAttributes.color&&(V=3),B){const e=Ss[B];M=e.vertexShader,R=e.fragmentShader}else M=o.vertexShader,R=o.fragmentShader,l.update(o),T=l.getVertexShaderID(o),Z=l.getFragmentShaderID(o);const W=e.getRenderTarget(),E=!0===f.isInstancedMesh,N=!!o.map,F=!!o.matcap,X=!!v,H=!!o.aoMap,z=!!o.lightMap,L=!!o.bumpMap,D=!!o.normalMap,K=!!o.displacementMap,Y=!!o.emissiveMap,P=!!o.metalnessMap,k=!!o.roughnessMap,O=o.anisotropy>0,U=o.clearcoat>0,Q=o.iridescence>0,J=o.sheen>0,j=o.transmission>0,q=O&&!!o.anisotropyMap,$=U&&!!o.clearcoatMap,ee=U&&!!o.clearcoatNormalMap,te=U&&!!o.clearcoatRoughnessMap,ie=Q&&!!o.iridescenceMap,ne=Q&&!!o.iridescenceThicknessMap,se=J&&!!o.sheenColorMap,oe=J&&!!o.sheenRoughnessMap,re=!!o.specularMap,ae=!!o.specularColorMap,le=!!o.specularIntensityMap,ge=j&&!!o.transmissionMap,ce=j&&!!o.thicknessMap,de=!!o.gradientMap,he=!!o.alphaMap,ue=o.alphaTest>0,Ie=!!o.alphaHash,pe=!!o.extensions,me=!!y.attributes.uv1,Ae=!!y.attributes.uv2,Ce=!!y.attributes.uv3;let fe=A;return o.toneMapped&&(null!==W&&!0!==W.isXRRenderTarget||(fe=e.toneMapping)),{isWebGL2:d,shaderID:B,shaderType:o.type,shaderName:o.name,vertexShader:M,fragmentShader:R,defines:o.defines,customVertexShaderID:T,customFragmentShaderID:Z,isRawShaderMaterial:!0===o.isRawShaderMaterial,glslVersion:o.glslVersion,precision:I,instancing:E,instancingColor:E&&null!==f.instanceColor,supportsVertexTextures:u,outputColorSpace:null===W?e.outputColorSpace:!0===W.isXRRenderTarget?W.texture.colorSpace:Pe,map:N,matcap:F,envMap:X,envMapMode:X&&v.mapping,envMapCubeUVHeight:x,aoMap:H,lightMap:z,bumpMap:L,normalMap:D,displacementMap:u&&K,emissiveMap:Y,normalMapObjectSpace:D&&1===o.normalMapType,normalMapTangentSpace:D&&0===o.normalMapType,metalnessMap:P,roughnessMap:k,anisotropy:O,anisotropyMap:q,clearcoat:U,clearcoatMap:$,clearcoatNormalMap:ee,clearcoatRoughnessMap:te,iridescence:Q,iridescenceMap:ie,iridescenceThicknessMap:ne,sheen:J,sheenColorMap:se,sheenRoughnessMap:oe,specularMap:re,specularColorMap:ae,specularIntensityMap:le,transmission:j,transmissionMap:ge,thicknessMap:ce,gradientMap:de,opaque:!1===o.transparent&&1===o.blending,alphaMap:he,alphaTest:ue,alphaHash:Ie,combine:o.combine,mapUv:N&&m(o.map.channel),aoMapUv:H&&m(o.aoMap.channel),lightMapUv:z&&m(o.lightMap.channel),bumpMapUv:L&&m(o.bumpMap.channel),normalMapUv:D&&m(o.normalMap.channel),displacementMapUv:K&&m(o.displacementMap.channel),emissiveMapUv:Y&&m(o.emissiveMap.channel),metalnessMapUv:P&&m(o.metalnessMap.channel),roughnessMapUv:k&&m(o.roughnessMap.channel),anisotropyMapUv:q&&m(o.anisotropyMap.channel),clearcoatMapUv:$&&m(o.clearcoatMap.channel),clearcoatNormalMapUv:ee&&m(o.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:te&&m(o.clearcoatRoughnessMap.channel),iridescenceMapUv:ie&&m(o.iridescenceMap.channel),iridescenceThicknessMapUv:ne&&m(o.iridescenceThicknessMap.channel),sheenColorMapUv:se&&m(o.sheenColorMap.channel),sheenRoughnessMapUv:oe&&m(o.sheenRoughnessMap.channel),specularMapUv:re&&m(o.specularMap.channel),specularColorMapUv:ae&&m(o.specularColorMap.channel),specularIntensityMapUv:le&&m(o.specularIntensityMap.channel),transmissionMapUv:ge&&m(o.transmissionMap.channel),thicknessMapUv:ce&&m(o.thicknessMap.channel),alphaMapUv:he&&m(o.alphaMap.channel),vertexTangents:!!y.attributes.tangent&&(D||O),vertexColors:o.vertexColors,vertexAlphas:!0===o.vertexColors&&!!y.attributes.color&&4===y.attributes.color.itemSize,vertexUv1s:me,vertexUv2s:Ae,vertexUv3s:Ce,pointsUvs:!0===f.isPoints&&!!y.attributes.uv&&(N||he),fog:!!b,useFog:!0===o.fog,fogExp2:b&&b.isFogExp2,flatShading:!0===o.flatShading,sizeAttenuation:!0===o.sizeAttenuation,logarithmicDepthBuffer:h,skinning:!0===f.isSkinnedMesh,morphTargets:void 0!==y.morphAttributes.position,morphNormals:void 0!==y.morphAttributes.normal,morphColors:void 0!==y.morphAttributes.color,morphTargetsCount:G,morphTextureStride:V,numDirLights:a.directional.length,numPointLights:a.point.length,numSpotLights:a.spot.length,numSpotLightMaps:a.spotLightMap.length,numRectAreaLights:a.rectArea.length,numHemiLights:a.hemi.length,numDirLightShadows:a.directionalShadowMap.length,numPointLightShadows:a.pointShadowMap.length,numSpotLightShadows:a.spotShadowMap.length,numSpotLightShadowsWithMaps:a.numSpotLightShadowsWithMaps,numLightProbes:a.numLightProbes,numClippingPlanes:r.numPlanes,numClipIntersection:r.numIntersection,dithering:o.dithering,shadowMapEnabled:e.shadowMap.enabled&&g.length>0,shadowMapType:e.shadowMap.type,toneMapping:fe,useLegacyLights:e._useLegacyLights,decodeVideoTexture:N&&!0===o.map.isVideoTexture&&Zt.getTransfer(o.map.colorSpace)===Qe,premultipliedAlpha:o.premultipliedAlpha,doubleSided:2===o.side,flipSided:o.side===c,useDepthPacking:o.depthPacking>=0,depthPacking:o.depthPacking||0,index0AttributeName:o.index0AttributeName,extensionDerivatives:pe&&!0===o.extensions.derivatives,extensionFragDepth:pe&&!0===o.extensions.fragDepth,extensionDrawBuffers:pe&&!0===o.extensions.drawBuffers,extensionShaderTextureLOD:pe&&!0===o.extensions.shaderTextureLOD,rendererExtensionFragDepth:d||n.has("EXT_frag_depth"),rendererExtensionDrawBuffers:d||n.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:d||n.has("EXT_shader_texture_lod"),rendererExtensionParallelShaderCompile:n.has("KHR_parallel_shader_compile"),customProgramCacheKey:o.customProgramCacheKey()}},getProgramCacheKey:function(t){const i=[];if(t.shaderID?i.push(t.shaderID):(i.push(t.customVertexShaderID),i.push(t.customFragmentShaderID)),void 0!==t.defines)for(const e in t.defines)i.push(e),i.push(t.defines[e]);return!1===t.isRawShaderMaterial&&(!function(e,t){e.push(t.precision),e.push(t.outputColorSpace),e.push(t.envMapMode),e.push(t.envMapCubeUVHeight),e.push(t.mapUv),e.push(t.alphaMapUv),e.push(t.lightMapUv),e.push(t.aoMapUv),e.push(t.bumpMapUv),e.push(t.normalMapUv),e.push(t.displacementMapUv),e.push(t.emissiveMapUv),e.push(t.metalnessMapUv),e.push(t.roughnessMapUv),e.push(t.anisotropyMapUv),e.push(t.clearcoatMapUv),e.push(t.clearcoatNormalMapUv),e.push(t.clearcoatRoughnessMapUv),e.push(t.iridescenceMapUv),e.push(t.iridescenceThicknessMapUv),e.push(t.sheenColorMapUv),e.push(t.sheenRoughnessMapUv),e.push(t.specularMapUv),e.push(t.specularColorMapUv),e.push(t.specularIntensityMapUv),e.push(t.transmissionMapUv),e.push(t.thicknessMapUv),e.push(t.combine),e.push(t.fogExp2),e.push(t.sizeAttenuation),e.push(t.morphTargetsCount),e.push(t.morphAttributeCount),e.push(t.numDirLights),e.push(t.numPointLights),e.push(t.numSpotLights),e.push(t.numSpotLightMaps),e.push(t.numHemiLights),e.push(t.numRectAreaLights),e.push(t.numDirLightShadows),e.push(t.numPointLightShadows),e.push(t.numSpotLightShadows),e.push(t.numSpotLightShadowsWithMaps),e.push(t.numLightProbes),e.push(t.shadowMapType),e.push(t.toneMapping),e.push(t.numClippingPlanes),e.push(t.numClipIntersection),e.push(t.depthPacking)}(i,t),function(e,t){a.disableAll(),t.isWebGL2&&a.enable(0);t.supportsVertexTextures&&a.enable(1);t.instancing&&a.enable(2);t.instancingColor&&a.enable(3);t.matcap&&a.enable(4);t.envMap&&a.enable(5);t.normalMapObjectSpace&&a.enable(6);t.normalMapTangentSpace&&a.enable(7);t.clearcoat&&a.enable(8);t.iridescence&&a.enable(9);t.alphaTest&&a.enable(10);t.vertexColors&&a.enable(11);t.vertexAlphas&&a.enable(12);t.vertexUv1s&&a.enable(13);t.vertexUv2s&&a.enable(14);t.vertexUv3s&&a.enable(15);t.vertexTangents&&a.enable(16);t.anisotropy&&a.enable(17);t.alphaHash&&a.enable(18);e.push(a.mask),a.disableAll(),t.fog&&a.enable(0);t.useFog&&a.enable(1);t.flatShading&&a.enable(2);t.logarithmicDepthBuffer&&a.enable(3);t.skinning&&a.enable(4);t.morphTargets&&a.enable(5);t.morphNormals&&a.enable(6);t.morphColors&&a.enable(7);t.premultipliedAlpha&&a.enable(8);t.shadowMapEnabled&&a.enable(9);t.useLegacyLights&&a.enable(10);t.doubleSided&&a.enable(11);t.flipSided&&a.enable(12);t.useDepthPacking&&a.enable(13);t.dithering&&a.enable(14);t.transmission&&a.enable(15);t.sheen&&a.enable(16);t.opaque&&a.enable(17);t.pointsUvs&&a.enable(18);t.decodeVideoTexture&&a.enable(19);e.push(a.mask)}(i,t),i.push(e.outputColorSpace)),i.push(t.customProgramCacheKey),i.join()},getUniforms:function(e){const t=p[e.type];let i;if(t){const e=Ss[t];i=as.clone(e.uniforms)}else i=e.uniforms;return i},acquireProgram:function(t,i){let n;for(let e=0,s=g.length;e<s;e++){const t=g[e];if(t.cacheKey===i){n=t,++n.usedTimes;break}}return void 0===n&&(n=new Mr(e,i,t,o),g.push(n)),n},releaseProgram:function(e){if(0==--e.usedTimes){const t=g.indexOf(e);g[t]=g[g.length-1],g.pop(),e.destroy()}},releaseShaderCache:function(e){l.remove(e)},programs:g,dispose:function(){l.dispose()}}}function Wr(){let e=new WeakMap;return{get:function(t){let i=e.get(t);return void 0===i&&(i={},e.set(t,i)),i},remove:function(t){e.delete(t)},update:function(t,i,n){e.get(t)[i]=n},dispose:function(){e=new WeakMap}}}function Er(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function Nr(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function Fr(){const e=[];let t=0;const i=[],n=[],s=[];function o(i,n,s,o,r,a){let l=e[t];return void 0===l?(l={id:i.id,object:i,geometry:n,material:s,groupOrder:o,renderOrder:i.renderOrder,z:r,group:a},e[t]=l):(l.id=i.id,l.object=i,l.geometry=n,l.material=s,l.groupOrder=o,l.renderOrder=i.renderOrder,l.z=r,l.group=a),t++,l}return{opaque:i,transmissive:n,transparent:s,init:function(){t=0,i.length=0,n.length=0,s.length=0},push:function(e,t,r,a,l,g){const c=o(e,t,r,a,l,g);r.transmission>0?n.push(c):!0===r.transparent?s.push(c):i.push(c)},unshift:function(e,t,r,a,l,g){const c=o(e,t,r,a,l,g);r.transmission>0?n.unshift(c):!0===r.transparent?s.unshift(c):i.unshift(c)},finish:function(){for(let i=t,n=e.length;i<n;i++){const t=e[i];if(null===t.id)break;t.id=null,t.object=null,t.geometry=null,t.material=null,t.group=null}},sort:function(e,t){i.length>1&&i.sort(e||Er),n.length>1&&n.sort(t||Nr),s.length>1&&s.sort(t||Nr)}}}function Xr(){let e=new WeakMap;return{get:function(t,i){const n=e.get(t);let s;return void 0===n?(s=new Fr,e.set(t,[s])):i>=n.length?(s=new Fr,n.push(s)):s=n[i],s},dispose:function(){e=new WeakMap}}}function Hr(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let i;switch(t.type){case"DirectionalLight":i={direction:new Qt,color:new In};break;case"SpotLight":i={position:new Qt,direction:new Qt,color:new In,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":i={position:new Qt,color:new In,distance:0,decay:0};break;case"HemisphereLight":i={direction:new Qt,skyColor:new In,groundColor:new In};break;case"RectAreaLight":i={color:new In,position:new Qt,halfWidth:new Qt,halfHeight:new Qt}}return e[t.id]=i,i}}}let zr=0;function Lr(e,t){return(t.castShadow?2:0)-(e.castShadow?2:0)+(t.map?1:0)-(e.map?1:0)}function Dr(e,t){const i=new Hr,n=function(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let i;switch(t.type){case"DirectionalLight":case"SpotLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new bt};break;case"PointLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new bt,shadowCameraNear:1,shadowCameraFar:1e3}}return e[t.id]=i,i}}}(),s={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let l=0;l<9;l++)s.probe.push(new Qt);const o=new Qt,r=new Bi,a=new Bi;return{setup:function(o,r){let a=0,l=0,g=0;for(let e=0;e<9;e++)s.probe[e].set(0,0,0);let c=0,d=0,h=0,u=0,I=0,p=0,m=0,A=0,C=0,f=0,b=0;o.sort(Lr);const y=!0===r?Math.PI:1;for(let e=0,t=o.length;e<t;e++){const t=o[e],r=t.color,_=t.intensity,v=t.distance,x=t.shadow&&t.shadow.map?t.shadow.map.texture:null;if(t.isAmbientLight)a+=r.r*_*y,l+=r.g*_*y,g+=r.b*_*y;else if(t.isLightProbe){for(let e=0;e<9;e++)s.probe[e].addScaledVector(t.sh.coefficients[e],_);b++}else if(t.isDirectionalLight){const e=i.get(t);if(e.color.copy(t.color).multiplyScalar(t.intensity*y),t.castShadow){const e=t.shadow,i=n.get(t);i.shadowBias=e.bias,i.shadowNormalBias=e.normalBias,i.shadowRadius=e.radius,i.shadowMapSize=e.mapSize,s.directionalShadow[c]=i,s.directionalShadowMap[c]=x,s.directionalShadowMatrix[c]=t.shadow.matrix,p++}s.directional[c]=e,c++}else if(t.isSpotLight){const e=i.get(t);e.position.setFromMatrixPosition(t.matrixWorld),e.color.copy(r).multiplyScalar(_*y),e.distance=v,e.coneCos=Math.cos(t.angle),e.penumbraCos=Math.cos(t.angle*(1-t.penumbra)),e.decay=t.decay,s.spot[h]=e;const o=t.shadow;if(t.map&&(s.spotLightMap[C]=t.map,C++,o.updateMatrices(t),t.castShadow&&f++),s.spotLightMatrix[h]=o.matrix,t.castShadow){const e=n.get(t);e.shadowBias=o.bias,e.shadowNormalBias=o.normalBias,e.shadowRadius=o.radius,e.shadowMapSize=o.mapSize,s.spotShadow[h]=e,s.spotShadowMap[h]=x,A++}h++}else if(t.isRectAreaLight){const e=i.get(t);e.color.copy(r).multiplyScalar(_),e.halfWidth.set(.5*t.width,0,0),e.halfHeight.set(0,.5*t.height,0),s.rectArea[u]=e,u++}else if(t.isPointLight){const e=i.get(t);if(e.color.copy(t.color).multiplyScalar(t.intensity*y),e.distance=t.distance,e.decay=t.decay,t.castShadow){const e=t.shadow,i=n.get(t);i.shadowBias=e.bias,i.shadowNormalBias=e.normalBias,i.shadowRadius=e.radius,i.shadowMapSize=e.mapSize,i.shadowCameraNear=e.camera.near,i.shadowCameraFar=e.camera.far,s.pointShadow[d]=i,s.pointShadowMap[d]=x,s.pointShadowMatrix[d]=t.shadow.matrix,m++}s.point[d]=e,d++}else if(t.isHemisphereLight){const e=i.get(t);e.skyColor.copy(t.color).multiplyScalar(_*y),e.groundColor.copy(t.groundColor).multiplyScalar(_*y),s.hemi[I]=e,I++}}u>0&&(t.isWebGL2||!0===e.has("OES_texture_float_linear")?(s.rectAreaLTC1=ws.LTC_FLOAT_1,s.rectAreaLTC2=ws.LTC_FLOAT_2):!0===e.has("OES_texture_half_float_linear")?(s.rectAreaLTC1=ws.LTC_HALF_1,s.rectAreaLTC2=ws.LTC_HALF_2):console.error("THREE.WebGLRenderer: Unable to use RectAreaLight. Missing WebGL extensions.")),s.ambient[0]=a,s.ambient[1]=l,s.ambient[2]=g;const _=s.hash;_.directionalLength===c&&_.pointLength===d&&_.spotLength===h&&_.rectAreaLength===u&&_.hemiLength===I&&_.numDirectionalShadows===p&&_.numPointShadows===m&&_.numSpotShadows===A&&_.numSpotMaps===C&&_.numLightProbes===b||(s.directional.length=c,s.spot.length=h,s.rectArea.length=u,s.point.length=d,s.hemi.length=I,s.directionalShadow.length=p,s.directionalShadowMap.length=p,s.pointShadow.length=m,s.pointShadowMap.length=m,s.spotShadow.length=A,s.spotShadowMap.length=A,s.directionalShadowMatrix.length=p,s.pointShadowMatrix.length=m,s.spotLightMatrix.length=A+C-f,s.spotLightMap.length=C,s.numSpotLightShadowsWithMaps=f,s.numLightProbes=b,_.directionalLength=c,_.pointLength=d,_.spotLength=h,_.rectAreaLength=u,_.hemiLength=I,_.numDirectionalShadows=p,_.numPointShadows=m,_.numSpotShadows=A,_.numSpotMaps=C,_.numLightProbes=b,s.version=zr++)},setupView:function(e,t){let i=0,n=0,l=0,g=0,c=0;const d=t.matrixWorldInverse;for(let h=0,u=e.length;h<u;h++){const t=e[h];if(t.isDirectionalLight){const e=s.directional[i];e.direction.setFromMatrixPosition(t.matrixWorld),o.setFromMatrixPosition(t.target.matrixWorld),e.direction.sub(o),e.direction.transformDirection(d),i++}else if(t.isSpotLight){const e=s.spot[l];e.position.setFromMatrixPosition(t.matrixWorld),e.position.applyMatrix4(d),e.direction.setFromMatrixPosition(t.matrixWorld),o.setFromMatrixPosition(t.target.matrixWorld),e.direction.sub(o),e.direction.transformDirection(d),l++}else if(t.isRectAreaLight){const e=s.rectArea[g];e.position.setFromMatrixPosition(t.matrixWorld),e.position.applyMatrix4(d),a.identity(),r.copy(t.matrixWorld),r.premultiply(d),a.extractRotation(r),e.halfWidth.set(.5*t.width,0,0),e.halfHeight.set(0,.5*t.height,0),e.halfWidth.applyMatrix4(a),e.halfHeight.applyMatrix4(a),g++}else if(t.isPointLight){const e=s.point[n];e.position.setFromMatrixPosition(t.matrixWorld),e.position.applyMatrix4(d),n++}else if(t.isHemisphereLight){const e=s.hemi[c];e.direction.setFromMatrixPosition(t.matrixWorld),e.direction.transformDirection(d),c++}}},state:s}}function Kr(e,t){const i=new Dr(e,t),n=[],s=[];return{init:function(){n.length=0,s.length=0},state:{lightsArray:n,shadowsArray:s,lights:i},setupLights:function(e){i.setup(n,e)},setupLightsView:function(e){i.setupView(n,e)},pushLight:function(e){n.push(e)},pushShadow:function(e){s.push(e)}}}function Yr(e,t){let i=new WeakMap;return{get:function(n,s=0){const o=i.get(n);let r;return void 0===o?(r=new Kr(e,t),i.set(n,[r])):s>=o.length?(r=new Kr(e,t),o.push(r)):r=o[s],r},dispose:function(){i=new WeakMap}}}class Pr extends An{constructor(e){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}class kr extends An{constructor(e){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}function Or(e,t,i){let n=new ys;const s=new bt,o=new bt,a=new Dt,d=new Pr({depthPacking:3201}),h=new kr,u={},I=i.maxTextureSize,p={[g]:c,[c]:g,2:2},m=new ls({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new bt},radius:{value:4}},vertexShader:"void main() {\n\tgl_Position = vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tconst float samples = float( VSM_SAMPLES );\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );\n\tfloat uvStart = samples <= 1.0 ? 0.0 : - 1.0;\n\tfor ( float i = 0.0; i < samples; i ++ ) {\n\t\tfloat uvOffset = uvStart + i * uvStride;\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean / samples;\n\tsquared_mean = squared_mean / samples;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}"}),A=m.clone();A.defines.HORIZONTAL_PASS=1;const C=new Fn;C.setAttribute("position",new Bn(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const f=new ts(C,m),b=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=r;let y=this.type;function _(i,n){const o=t.update(f);m.defines.VSM_SAMPLES!==i.blurSamples&&(m.defines.VSM_SAMPLES=i.blurSamples,A.defines.VSM_SAMPLES=i.blurSamples,m.needsUpdate=!0,A.needsUpdate=!0),null===i.mapPass&&(i.mapPass=new Yt(s.x,s.y)),m.uniforms.shadow_pass.value=i.map.texture,m.uniforms.resolution.value=i.mapSize,m.uniforms.radius.value=i.radius,e.setRenderTarget(i.mapPass),e.clear(),e.renderBufferDirect(n,null,o,m,f,null),A.uniforms.shadow_pass.value=i.mapPass.texture,A.uniforms.resolution.value=i.mapSize,A.uniforms.radius.value=i.radius,e.setRenderTarget(i.map),e.clear(),e.renderBufferDirect(n,null,o,A,f,null)}function v(t,i,n,s){let o=null;const r=!0===n.isPointLight?t.customDistanceMaterial:t.customDepthMaterial;if(void 0!==r)o=r;else if(o=!0===n.isPointLight?h:d,e.localClippingEnabled&&!0===i.clipShadows&&Array.isArray(i.clippingPlanes)&&0!==i.clippingPlanes.length||i.displacementMap&&0!==i.displacementScale||i.alphaMap&&i.alphaTest>0||i.map&&i.alphaTest>0){const e=o.uuid,t=i.uuid;let n=u[e];void 0===n&&(n={},u[e]=n);let s=n[t];void 0===s&&(s=o.clone(),n[t]=s),o=s}if(o.visible=i.visible,o.wireframe=i.wireframe,o.side=s===l?null!==i.shadowSide?i.shadowSide:i.side:null!==i.shadowSide?i.shadowSide:p[i.side],o.alphaMap=i.alphaMap,o.alphaTest=i.alphaTest,o.map=i.map,o.clipShadows=i.clipShadows,o.clippingPlanes=i.clippingPlanes,o.clipIntersection=i.clipIntersection,o.displacementMap=i.displacementMap,o.displacementScale=i.displacementScale,o.displacementBias=i.displacementBias,o.wireframeLinewidth=i.wireframeLinewidth,o.linewidth=i.linewidth,!0===n.isPointLight&&!0===o.isMeshDistanceMaterial){e.properties.get(o).light=n}return o}function x(i,s,o,r,a){if(!1===i.visible)return;if(i.layers.test(s.layers)&&(i.isMesh||i.isLine||i.isPoints)&&(i.castShadow||i.receiveShadow&&a===l)&&(!i.frustumCulled||n.intersectsObject(i))){i.modelViewMatrix.multiplyMatrices(o.matrixWorldInverse,i.matrixWorld);const n=t.update(i),s=i.material;if(Array.isArray(s)){const t=n.groups;for(let l=0,g=t.length;l<g;l++){const g=t[l],c=s[g.materialIndex];if(c&&c.visible){const t=v(i,c,r,a);e.renderBufferDirect(o,null,n,t,i,g)}}}else if(s.visible){const t=v(i,s,r,a);e.renderBufferDirect(o,null,n,t,i,null)}}const g=i.children;for(let e=0,t=g.length;e<t;e++)x(g[e],s,o,r,a)}this.render=function(t,i,r){if(!1===b.enabled)return;if(!1===b.autoUpdate&&!1===b.needsUpdate)return;if(0===t.length)return;const g=e.getRenderTarget(),c=e.getActiveCubeFace(),d=e.getActiveMipmapLevel(),h=e.state;h.setBlending(0),h.buffers.color.setClear(1,1,1,1),h.buffers.depth.setTest(!0),h.setScissorTest(!1);const u=y!==l&&this.type===l,p=y===l&&this.type!==l;for(let m=0,A=t.length;m<A;m++){const g=t[m],c=g.shadow;if(void 0===c){console.warn("THREE.WebGLShadowMap:",g,"has no shadow.");continue}if(!1===c.autoUpdate&&!1===c.needsUpdate)continue;s.copy(c.mapSize);const d=c.getFrameExtents();if(s.multiply(d),o.copy(c.mapSize),(s.x>I||s.y>I)&&(s.x>I&&(o.x=Math.floor(I/d.x),s.x=o.x*d.x,c.mapSize.x=o.x),s.y>I&&(o.y=Math.floor(I/d.y),s.y=o.y*d.y,c.mapSize.y=o.y)),null===c.map||!0===u||!0===p){const e=this.type!==l?{minFilter:T,magFilter:T}:{};null!==c.map&&c.map.dispose(),c.map=new Yt(s.x,s.y,e),c.map.texture.name=g.name+".shadowMap",c.camera.updateProjectionMatrix()}e.setRenderTarget(c.map),e.clear();const A=c.getViewportCount();for(let e=0;e<A;e++){const t=c.getViewport(e);a.set(o.x*t.x,o.y*t.y,o.x*t.z,o.y*t.w),h.viewport(a),c.updateMatrices(g,e),n=c.getFrustum(),x(i,r,c.camera,g,this.type)}!0!==c.isPointLightShadow&&this.type===l&&_(c,r),c.needsUpdate=!1}y=this.type,b.needsUpdate=!1,e.setRenderTarget(g,c,d)}}function Ur(e,t,i){const n=i.isWebGL2;const s=new function(){let t=!1;const i=new Dt;let n=null;const s=new Dt(0,0,0,0);return{setMask:function(i){n===i||t||(e.colorMask(i,i,i,i),n=i)},setLocked:function(e){t=e},setClear:function(t,n,o,r,a){!0===a&&(t*=r,n*=r,o*=r),i.set(t,n,o,r),!1===s.equals(i)&&(e.clearColor(t,n,o,r),s.copy(i))},reset:function(){t=!1,n=null,s.set(-1,0,0,0)}}},o=new function(){let t=!1,i=null,n=null,s=null;return{setTest:function(t){t?k(e.DEPTH_TEST):O(e.DEPTH_TEST)},setMask:function(n){i===n||t||(e.depthMask(n),i=n)},setFunc:function(t){if(n!==t){switch(t){case 0:e.depthFunc(e.NEVER);break;case 1:e.depthFunc(e.ALWAYS);break;case 2:e.depthFunc(e.LESS);break;case 3:default:e.depthFunc(e.LEQUAL);break;case 4:e.depthFunc(e.EQUAL);break;case 5:e.depthFunc(e.GEQUAL);break;case 6:e.depthFunc(e.GREATER);break;case 7:e.depthFunc(e.NOTEQUAL)}n=t}},setLocked:function(e){t=e},setClear:function(t){s!==t&&(e.clearDepth(t),s=t)},reset:function(){t=!1,i=null,n=null,s=null}}},r=new function(){let t=!1,i=null,n=null,s=null,o=null,r=null,a=null,l=null,g=null;return{setTest:function(i){t||(i?k(e.STENCIL_TEST):O(e.STENCIL_TEST))},setMask:function(n){i===n||t||(e.stencilMask(n),i=n)},setFunc:function(t,i,r){n===t&&s===i&&o===r||(e.stencilFunc(t,i,r),n=t,s=i,o=r)},setOp:function(t,i,n){r===t&&a===i&&l===n||(e.stencilOp(t,i,n),r=t,a=i,l=n)},setLocked:function(e){t=e},setClear:function(t){g!==t&&(e.clearStencil(t),g=t)},reset:function(){t=!1,i=null,n=null,s=null,o=null,r=null,a=null,l=null,g=null}}},a=new WeakMap,l=new WeakMap;let g={},I={},p=new WeakMap,m=[],A=null,C=!1,f=null,b=null,y=null,_=null,v=null,x=null,B=null,w=new In(0,0,0),S=0,G=!1,M=null,R=null,T=null,Z=null,V=null;const W=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let E=!1,N=0;const F=e.getParameter(e.VERSION);-1!==F.indexOf("WebGL")?(N=parseFloat(/^WebGL (\d)/.exec(F)[1]),E=N>=1):-1!==F.indexOf("OpenGL ES")&&(N=parseFloat(/^OpenGL ES (\d)/.exec(F)[1]),E=N>=2);let X=null,H={};const z=e.getParameter(e.SCISSOR_BOX),L=e.getParameter(e.VIEWPORT),D=(new Dt).fromArray(z),K=(new Dt).fromArray(L);function Y(t,i,s,o){const r=new Uint8Array(4),a=e.createTexture();e.bindTexture(t,a),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.NEAREST);for(let l=0;l<s;l++)!n||t!==e.TEXTURE_3D&&t!==e.TEXTURE_2D_ARRAY?e.texImage2D(i+l,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,r):e.texImage3D(i,0,e.RGBA,1,1,o,0,e.RGBA,e.UNSIGNED_BYTE,r);return a}const P={};function k(t){!0!==g[t]&&(e.enable(t),g[t]=!0)}function O(t){!1!==g[t]&&(e.disable(t),g[t]=!1)}P[e.TEXTURE_2D]=Y(e.TEXTURE_2D,e.TEXTURE_2D,1),P[e.TEXTURE_CUBE_MAP]=Y(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),n&&(P[e.TEXTURE_2D_ARRAY]=Y(e.TEXTURE_2D_ARRAY,e.TEXTURE_2D_ARRAY,1,1),P[e.TEXTURE_3D]=Y(e.TEXTURE_3D,e.TEXTURE_3D,1,1)),s.setClear(0,0,0,1),o.setClear(1),r.setClear(0),k(e.DEPTH_TEST),o.setFunc(3),j(!1),q(1),k(e.CULL_FACE),J(0);const U={[d]:e.FUNC_ADD,101:e.FUNC_SUBTRACT,102:e.FUNC_REVERSE_SUBTRACT};if(n)U[103]=e.MIN,U[104]=e.MAX;else{const e=t.get("EXT_blend_minmax");null!==e&&(U[103]=e.MIN_EXT,U[104]=e.MAX_EXT)}const Q={[h]:e.ZERO,[u]:e.ONE,202:e.SRC_COLOR,204:e.SRC_ALPHA,210:e.SRC_ALPHA_SATURATE,208:e.DST_COLOR,206:e.DST_ALPHA,203:e.ONE_MINUS_SRC_COLOR,205:e.ONE_MINUS_SRC_ALPHA,209:e.ONE_MINUS_DST_COLOR,207:e.ONE_MINUS_DST_ALPHA,211:e.CONSTANT_COLOR,212:e.ONE_MINUS_CONSTANT_COLOR,213:e.CONSTANT_ALPHA,214:e.ONE_MINUS_CONSTANT_ALPHA};function J(t,i,n,s,o,r,a,l,g,c){if(0!==t){if(!1===C&&(k(e.BLEND),C=!0),5===t)o=o||i,r=r||n,a=a||s,i===b&&o===v||(e.blendEquationSeparate(U[i],U[o]),b=i,v=o),n===y&&s===_&&r===x&&a===B||(e.blendFuncSeparate(Q[n],Q[s],Q[r],Q[a]),y=n,_=s,x=r,B=a),!1!==l.equals(w)&&g===S||(e.blendColor(l.r,l.g,l.b,g),w.copy(l),S=g),f=t,G=!1;else if(t!==f||c!==G){if(b===d&&v===d||(e.blendEquation(e.FUNC_ADD),b=d,v=d),c)switch(t){case 1:e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case 2:e.blendFunc(e.ONE,e.ONE);break;case 3:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case 4:e.blendFuncSeparate(e.ZERO,e.SRC_COLOR,e.ZERO,e.SRC_ALPHA);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}else switch(t){case 1:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case 2:e.blendFunc(e.SRC_ALPHA,e.ONE);break;case 3:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case 4:e.blendFunc(e.ZERO,e.SRC_COLOR);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}y=null,_=null,x=null,B=null,w.set(0,0,0),S=0,f=t,G=c}}else!0===C&&(O(e.BLEND),C=!1)}function j(t){M!==t&&(t?e.frontFace(e.CW):e.frontFace(e.CCW),M=t)}function q(t){0!==t?(k(e.CULL_FACE),t!==R&&(1===t?e.cullFace(e.BACK):2===t?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):O(e.CULL_FACE),R=t}function $(t,i,n){t?(k(e.POLYGON_OFFSET_FILL),Z===i&&V===n||(e.polygonOffset(i,n),Z=i,V=n)):O(e.POLYGON_OFFSET_FILL)}return{buffers:{color:s,depth:o,stencil:r},enable:k,disable:O,bindFramebuffer:function(t,i){return I[t]!==i&&(e.bindFramebuffer(t,i),I[t]=i,n&&(t===e.DRAW_FRAMEBUFFER&&(I[e.FRAMEBUFFER]=i),t===e.FRAMEBUFFER&&(I[e.DRAW_FRAMEBUFFER]=i)),!0)},drawBuffers:function(n,s){let o=m,r=!1;if(n)if(o=p.get(s),void 0===o&&(o=[],p.set(s,o)),n.isWebGLMultipleRenderTargets){const t=n.texture;if(o.length!==t.length||o[0]!==e.COLOR_ATTACHMENT0){for(let i=0,n=t.length;i<n;i++)o[i]=e.COLOR_ATTACHMENT0+i;o.length=t.length,r=!0}}else o[0]!==e.COLOR_ATTACHMENT0&&(o[0]=e.COLOR_ATTACHMENT0,r=!0);else o[0]!==e.BACK&&(o[0]=e.BACK,r=!0);r&&(i.isWebGL2?e.drawBuffers(o):t.get("WEBGL_draw_buffers").drawBuffersWEBGL(o))},useProgram:function(t){return A!==t&&(e.useProgram(t),A=t,!0)},setBlending:J,setMaterial:function(t,i){2===t.side?O(e.CULL_FACE):k(e.CULL_FACE);let n=t.side===c;i&&(n=!n),j(n),1===t.blending&&!1===t.transparent?J(0):J(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.blendColor,t.blendAlpha,t.premultipliedAlpha),o.setFunc(t.depthFunc),o.setTest(t.depthTest),o.setMask(t.depthWrite),s.setMask(t.colorWrite);const a=t.stencilWrite;r.setTest(a),a&&(r.setMask(t.stencilWriteMask),r.setFunc(t.stencilFunc,t.stencilRef,t.stencilFuncMask),r.setOp(t.stencilFail,t.stencilZFail,t.stencilZPass)),$(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits),!0===t.alphaToCoverage?k(e.SAMPLE_ALPHA_TO_COVERAGE):O(e.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:j,setCullFace:q,setLineWidth:function(t){t!==T&&(E&&e.lineWidth(t),T=t)},setPolygonOffset:$,setScissorTest:function(t){t?k(e.SCISSOR_TEST):O(e.SCISSOR_TEST)},activeTexture:function(t){void 0===t&&(t=e.TEXTURE0+W-1),X!==t&&(e.activeTexture(t),X=t)},bindTexture:function(t,i,n){void 0===n&&(n=null===X?e.TEXTURE0+W-1:X);let s=H[n];void 0===s&&(s={type:void 0,texture:void 0},H[n]=s),s.type===t&&s.texture===i||(X!==n&&(e.activeTexture(n),X=n),e.bindTexture(t,i||P[t]),s.type=t,s.texture=i)},unbindTexture:function(){const t=H[X];void 0!==t&&void 0!==t.type&&(e.bindTexture(t.type,null),t.type=void 0,t.texture=void 0)},compressedTexImage2D:function(){try{e.compressedTexImage2D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},compressedTexImage3D:function(){try{e.compressedTexImage3D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texImage2D:function(){try{e.texImage2D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texImage3D:function(){try{e.texImage3D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},updateUBOMapping:function(t,i){let n=l.get(i);void 0===n&&(n=new WeakMap,l.set(i,n));let s=n.get(t);void 0===s&&(s=e.getUniformBlockIndex(i,t.name),n.set(t,s))},uniformBlockBinding:function(t,i){const n=l.get(i).get(t);a.get(i)!==n&&(e.uniformBlockBinding(i,n,t.__bindingPointIndex),a.set(i,n))},texStorage2D:function(){try{e.texStorage2D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texStorage3D:function(){try{e.texStorage3D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texSubImage2D:function(){try{e.texSubImage2D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texSubImage3D:function(){try{e.texSubImage3D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},compressedTexSubImage2D:function(){try{e.compressedTexSubImage2D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},compressedTexSubImage3D:function(){try{e.compressedTexSubImage3D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},scissor:function(t){!1===D.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),D.copy(t))},viewport:function(t){!1===K.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),K.copy(t))},reset:function(){e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.disable(e.SCISSOR_TEST),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.blendColor(0,0,0,0),e.colorMask(!0,!0,!0,!0),e.clearColor(0,0,0,0),e.depthMask(!0),e.depthFunc(e.LESS),e.clearDepth(1),e.stencilMask(4294967295),e.stencilFunc(e.ALWAYS,0,4294967295),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.clearStencil(0),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.activeTexture(e.TEXTURE0),e.bindFramebuffer(e.FRAMEBUFFER,null),!0===n&&(e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.bindFramebuffer(e.READ_FRAMEBUFFER,null)),e.useProgram(null),e.lineWidth(1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.viewport(0,0,e.canvas.width,e.canvas.height),g={},X=null,H={},I={},p=new WeakMap,m=[],A=null,C=!1,f=null,b=null,y=null,_=null,v=null,x=null,B=null,w=new In(0,0,0),S=0,G=!1,M=null,R=null,T=null,Z=null,V=null,D.set(0,0,e.canvas.width,e.canvas.height),K.set(0,0,e.canvas.width,e.canvas.height),s.reset(),o.reset(),r.reset()}}}function Qr(e,t,i,n,s,o,r){const a=s.isWebGL2,l=s.maxTextures,g=s.maxCubemapSize,c=s.maxTextureSize,d=s.maxSamples,h=t.has("WEBGL_multisampled_render_to_texture")?t.get("WEBGL_multisampled_render_to_texture"):null,u="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),I=new WeakMap;let p;const m=new WeakMap;let A=!1;try{A="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(ae){}function C(e,t){return A?new OffscreenCanvas(e,t):xt("canvas")}function f(e,t,i,n){let s=1;if((e.width>n||e.height>n)&&(s=n/Math.max(e.width,e.height)),s<1||!0===t){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const n=t?mt:Math.floor,o=n(s*e.width),r=n(s*e.height);void 0===p&&(p=C(o,r));const a=i?C(o,r):p;a.width=o,a.height=r;return a.getContext("2d").drawImage(e,0,0,o,r),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+e.width+"x"+e.height+") to ("+o+"x"+r+")."),a}return"data"in e&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+e.width+"x"+e.height+")."),e}return e}function b(e){return It(e.width)&&It(e.height)}function y(e,t){return e.generateMipmaps&&t&&e.minFilter!==T&&e.minFilter!==W}function _(t){e.generateMipmap(t)}function v(i,n,s,o,r=!1){if(!1===a)return n;if(null!==i){if(void 0!==e[i])return e[i];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+i+"'")}let l=n;if(n===e.RED&&(s===e.FLOAT&&(l=e.R32F),s===e.HALF_FLOAT&&(l=e.R16F),s===e.UNSIGNED_BYTE&&(l=e.R8)),n===e.RED_INTEGER&&(s===e.UNSIGNED_BYTE&&(l=e.R8UI),s===e.UNSIGNED_SHORT&&(l=e.R16UI),s===e.UNSIGNED_INT&&(l=e.R32UI),s===e.BYTE&&(l=e.R8I),s===e.SHORT&&(l=e.R16I),s===e.INT&&(l=e.R32I)),n===e.RG&&(s===e.FLOAT&&(l=e.RG32F),s===e.HALF_FLOAT&&(l=e.RG16F),s===e.UNSIGNED_BYTE&&(l=e.RG8)),n===e.RGBA){const t=r?Ue:Zt.getTransfer(o);s===e.FLOAT&&(l=e.RGBA32F),s===e.HALF_FLOAT&&(l=e.RGBA16F),s===e.UNSIGNED_BYTE&&(l=t===Qe?e.SRGB8_ALPHA8:e.RGBA8),s===e.UNSIGNED_SHORT_4_4_4_4&&(l=e.RGBA4),s===e.UNSIGNED_SHORT_5_5_5_1&&(l=e.RGB5_A1)}return l!==e.R16F&&l!==e.R32F&&l!==e.RG16F&&l!==e.RG32F&&l!==e.RGBA16F&&l!==e.RGBA32F||t.get("EXT_color_buffer_float"),l}function x(e,t,i){return!0===y(e,i)||e.isFramebufferTexture&&e.minFilter!==T&&e.minFilter!==W?Math.log2(Math.max(t.width,t.height))+1:void 0!==e.mipmaps&&e.mipmaps.length>0?e.mipmaps.length:e.isCompressedTexture&&Array.isArray(e.image)?t.mipmaps.length:1}function B(t){return t===T||t===Z||t===V?e.NEAREST:e.LINEAR}function w(e){const t=e.target;t.removeEventListener("dispose",w),function(e){const t=n.get(e);if(void 0===t.__webglInit)return;const i=e.source,s=m.get(i);if(s){const n=s[t.__cacheKey];n.usedTimes--,0===n.usedTimes&&X(e),0===Object.keys(s).length&&m.delete(i)}n.remove(e)}(t),t.isVideoTexture&&I.delete(t)}function S(t){const i=t.target;i.removeEventListener("dispose",S),function(t){const i=t.texture,s=n.get(t),o=n.get(i);void 0!==o.__webglTexture&&(e.deleteTexture(o.__webglTexture),r.memory.textures--);t.depthTexture&&t.depthTexture.dispose();if(t.isWebGLCubeRenderTarget)for(let n=0;n<6;n++){if(Array.isArray(s.__webglFramebuffer[n]))for(let t=0;t<s.__webglFramebuffer[n].length;t++)e.deleteFramebuffer(s.__webglFramebuffer[n][t]);else e.deleteFramebuffer(s.__webglFramebuffer[n]);s.__webglDepthbuffer&&e.deleteRenderbuffer(s.__webglDepthbuffer[n])}else{if(Array.isArray(s.__webglFramebuffer))for(let t=0;t<s.__webglFramebuffer.length;t++)e.deleteFramebuffer(s.__webglFramebuffer[t]);else e.deleteFramebuffer(s.__webglFramebuffer);if(s.__webglDepthbuffer&&e.deleteRenderbuffer(s.__webglDepthbuffer),s.__webglMultisampledFramebuffer&&e.deleteFramebuffer(s.__webglMultisampledFramebuffer),s.__webglColorRenderbuffer)for(let t=0;t<s.__webglColorRenderbuffer.length;t++)s.__webglColorRenderbuffer[t]&&e.deleteRenderbuffer(s.__webglColorRenderbuffer[t]);s.__webglDepthRenderbuffer&&e.deleteRenderbuffer(s.__webglDepthRenderbuffer)}if(t.isWebGLMultipleRenderTargets)for(let a=0,l=i.length;a<l;a++){const t=n.get(i[a]);t.__webglTexture&&(e.deleteTexture(t.__webglTexture),r.memory.textures--),n.remove(i[a])}n.remove(i),n.remove(t)}(i)}function X(t){const i=n.get(t);e.deleteTexture(i.__webglTexture);const s=t.source;delete m.get(s)[i.__cacheKey],r.memory.textures--}let H=0;function L(t,s){const o=n.get(t);if(t.isVideoTexture&&function(e){const t=r.render.frame;I.get(e)!==t&&(I.set(e,t),e.update())}(t),!1===t.isRenderTargetTexture&&t.version>0&&o.__version!==t.version){const e=t.image;if(null===e)console.warn("THREE.WebGLRenderer: Texture marked for update but no image data found.");else{if(!1!==e.complete)return void ee(o,t,s);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}i.bindTexture(e.TEXTURE_2D,o.__webglTexture,e.TEXTURE0+s)}const P={[G]:e.REPEAT,[M]:e.CLAMP_TO_EDGE,[R]:e.MIRRORED_REPEAT},k={[T]:e.NEAREST,[Z]:e.NEAREST_MIPMAP_NEAREST,[V]:e.NEAREST_MIPMAP_LINEAR,[W]:e.LINEAR,[E]:e.LINEAR_MIPMAP_NEAREST,[N]:e.LINEAR_MIPMAP_LINEAR},Q={512:e.NEVER,519:e.ALWAYS,513:e.LESS,515:e.LEQUAL,514:e.EQUAL,518:e.GEQUAL,516:e.GREATER,517:e.NOTEQUAL};function q(i,o,r){if(r?(e.texParameteri(i,e.TEXTURE_WRAP_S,P[o.wrapS]),e.texParameteri(i,e.TEXTURE_WRAP_T,P[o.wrapT]),i!==e.TEXTURE_3D&&i!==e.TEXTURE_2D_ARRAY||e.texParameteri(i,e.TEXTURE_WRAP_R,P[o.wrapR]),e.texParameteri(i,e.TEXTURE_MAG_FILTER,k[o.magFilter]),e.texParameteri(i,e.TEXTURE_MIN_FILTER,k[o.minFilter])):(e.texParameteri(i,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(i,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),i!==e.TEXTURE_3D&&i!==e.TEXTURE_2D_ARRAY||e.texParameteri(i,e.TEXTURE_WRAP_R,e.CLAMP_TO_EDGE),o.wrapS===M&&o.wrapT===M||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),e.texParameteri(i,e.TEXTURE_MAG_FILTER,B(o.magFilter)),e.texParameteri(i,e.TEXTURE_MIN_FILTER,B(o.minFilter)),o.minFilter!==T&&o.minFilter!==W&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.")),o.compareFunction&&(e.texParameteri(i,e.TEXTURE_COMPARE_MODE,e.COMPARE_REF_TO_TEXTURE),e.texParameteri(i,e.TEXTURE_COMPARE_FUNC,Q[o.compareFunction])),!0===t.has("EXT_texture_filter_anisotropic")){const r=t.get("EXT_texture_filter_anisotropic");if(o.magFilter===T)return;if(o.minFilter!==V&&o.minFilter!==N)return;if(o.type===K&&!1===t.has("OES_texture_float_linear"))return;if(!1===a&&o.type===Y&&!1===t.has("OES_texture_half_float_linear"))return;(o.anisotropy>1||n.get(o).__currentAnisotropy)&&(e.texParameterf(i,r.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(o.anisotropy,s.getMaxAnisotropy())),n.get(o).__currentAnisotropy=o.anisotropy)}}function $(t,i){let n=!1;void 0===t.__webglInit&&(t.__webglInit=!0,i.addEventListener("dispose",w));const s=i.source;let o=m.get(s);void 0===o&&(o={},m.set(s,o));const a=function(e){const t=[];return t.push(e.wrapS),t.push(e.wrapT),t.push(e.wrapR||0),t.push(e.magFilter),t.push(e.minFilter),t.push(e.anisotropy),t.push(e.internalFormat),t.push(e.format),t.push(e.type),t.push(e.generateMipmaps),t.push(e.premultiplyAlpha),t.push(e.flipY),t.push(e.unpackAlignment),t.push(e.colorSpace),t.join()}(i);if(a!==t.__cacheKey){void 0===o[a]&&(o[a]={texture:e.createTexture(),usedTimes:0},r.memory.textures++,n=!0),o[a].usedTimes++;const s=o[t.__cacheKey];void 0!==s&&(o[t.__cacheKey].usedTimes--,0===s.usedTimes&&X(i)),t.__cacheKey=a,t.__webglTexture=o[a].texture}return n}function ee(t,s,r){let l=e.TEXTURE_2D;(s.isDataArrayTexture||s.isCompressedArrayTexture)&&(l=e.TEXTURE_2D_ARRAY),s.isData3DTexture&&(l=e.TEXTURE_3D);const g=$(t,s),d=s.source;i.bindTexture(l,t.__webglTexture,e.TEXTURE0+r);const h=n.get(d);if(d.version!==h.__version||!0===g){i.activeTexture(e.TEXTURE0+r);const t=Zt.getPrimaries(Zt.workingColorSpace),n=s.colorSpace===Ke?null:Zt.getPrimaries(s.colorSpace),u=s.colorSpace===Ke||t===n?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,s.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,s.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,u);const I=function(e){return!a&&(e.wrapS!==M||e.wrapT!==M||e.minFilter!==T&&e.minFilter!==W)}(s)&&!1===b(s.image);let p=f(s.image,I,!1,c);p=re(s,p);const m=b(p)||a,A=o.convert(s.format,s.colorSpace);let C,B=o.convert(s.type),w=v(s.internalFormat,A,B,s.colorSpace,s.isVideoTexture);q(l,s,m);const S=s.mipmaps,G=a&&!0!==s.isVideoTexture,R=void 0===h.__version||!0===g,Z=x(s,p,m);if(s.isDepthTexture)w=e.DEPTH_COMPONENT,a?w=s.type===K?e.DEPTH_COMPONENT32F:s.type===D?e.DEPTH_COMPONENT24:s.type===O?e.DEPTH24_STENCIL8:e.DEPTH_COMPONENT16:s.type===K&&console.error("WebGLRenderer: Floating point depth texture requires WebGL2."),s.format===J&&w===e.DEPTH_COMPONENT&&s.type!==z&&s.type!==D&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),s.type=D,B=o.convert(s.type)),s.format===j&&w===e.DEPTH_COMPONENT&&(w=e.DEPTH_STENCIL,s.type!==O&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),s.type=O,B=o.convert(s.type))),R&&(G?i.texStorage2D(e.TEXTURE_2D,1,w,p.width,p.height):i.texImage2D(e.TEXTURE_2D,0,w,p.width,p.height,0,A,B,null));else if(s.isDataTexture)if(S.length>0&&m){G&&R&&i.texStorage2D(e.TEXTURE_2D,Z,w,S[0].width,S[0].height);for(let t=0,n=S.length;t<n;t++)C=S[t],G?i.texSubImage2D(e.TEXTURE_2D,t,0,0,C.width,C.height,A,B,C.data):i.texImage2D(e.TEXTURE_2D,t,w,C.width,C.height,0,A,B,C.data);s.generateMipmaps=!1}else G?(R&&i.texStorage2D(e.TEXTURE_2D,Z,w,p.width,p.height),i.texSubImage2D(e.TEXTURE_2D,0,0,0,p.width,p.height,A,B,p.data)):i.texImage2D(e.TEXTURE_2D,0,w,p.width,p.height,0,A,B,p.data);else if(s.isCompressedTexture)if(s.isCompressedArrayTexture){G&&R&&i.texStorage3D(e.TEXTURE_2D_ARRAY,Z,w,S[0].width,S[0].height,p.depth);for(let t=0,n=S.length;t<n;t++)C=S[t],s.format!==U?null!==A?G?i.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,C.width,C.height,p.depth,A,C.data,0,0):i.compressedTexImage3D(e.TEXTURE_2D_ARRAY,t,w,C.width,C.height,p.depth,0,C.data,0,0):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):G?i.texSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,C.width,C.height,p.depth,A,B,C.data):i.texImage3D(e.TEXTURE_2D_ARRAY,t,w,C.width,C.height,p.depth,0,A,B,C.data)}else{G&&R&&i.texStorage2D(e.TEXTURE_2D,Z,w,S[0].width,S[0].height);for(let t=0,n=S.length;t<n;t++)C=S[t],s.format!==U?null!==A?G?i.compressedTexSubImage2D(e.TEXTURE_2D,t,0,0,C.width,C.height,A,C.data):i.compressedTexImage2D(e.TEXTURE_2D,t,w,C.width,C.height,0,C.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):G?i.texSubImage2D(e.TEXTURE_2D,t,0,0,C.width,C.height,A,B,C.data):i.texImage2D(e.TEXTURE_2D,t,w,C.width,C.height,0,A,B,C.data)}else if(s.isDataArrayTexture)G?(R&&i.texStorage3D(e.TEXTURE_2D_ARRAY,Z,w,p.width,p.height,p.depth),i.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,0,p.width,p.height,p.depth,A,B,p.data)):i.texImage3D(e.TEXTURE_2D_ARRAY,0,w,p.width,p.height,p.depth,0,A,B,p.data);else if(s.isData3DTexture)G?(R&&i.texStorage3D(e.TEXTURE_3D,Z,w,p.width,p.height,p.depth),i.texSubImage3D(e.TEXTURE_3D,0,0,0,0,p.width,p.height,p.depth,A,B,p.data)):i.texImage3D(e.TEXTURE_3D,0,w,p.width,p.height,p.depth,0,A,B,p.data);else if(s.isFramebufferTexture){if(R)if(G)i.texStorage2D(e.TEXTURE_2D,Z,w,p.width,p.height);else{let t=p.width,n=p.height;for(let s=0;s<Z;s++)i.texImage2D(e.TEXTURE_2D,s,w,t,n,0,A,B,null),t>>=1,n>>=1}}else if(S.length>0&&m){G&&R&&i.texStorage2D(e.TEXTURE_2D,Z,w,S[0].width,S[0].height);for(let t=0,n=S.length;t<n;t++)C=S[t],G?i.texSubImage2D(e.TEXTURE_2D,t,0,0,A,B,C):i.texImage2D(e.TEXTURE_2D,t,w,A,B,C);s.generateMipmaps=!1}else G?(R&&i.texStorage2D(e.TEXTURE_2D,Z,w,p.width,p.height),i.texSubImage2D(e.TEXTURE_2D,0,0,0,A,B,p)):i.texImage2D(e.TEXTURE_2D,0,w,A,B,p);y(s,m)&&_(l),h.__version=d.version,s.onUpdate&&s.onUpdate(s)}t.__version=s.version}function te(t,s,r,a,l,g){const c=o.convert(r.format,r.colorSpace),d=o.convert(r.type),u=v(r.internalFormat,c,d,r.colorSpace);if(!n.get(s).__hasExternalTextures){const t=Math.max(1,s.width>>g),n=Math.max(1,s.height>>g);l===e.TEXTURE_3D||l===e.TEXTURE_2D_ARRAY?i.texImage3D(l,g,u,t,n,s.depth,0,c,d,null):i.texImage2D(l,g,u,t,n,0,c,d,null)}i.bindFramebuffer(e.FRAMEBUFFER,t),oe(s)?h.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,a,l,n.get(r).__webglTexture,0,se(s)):(l===e.TEXTURE_2D||l>=e.TEXTURE_CUBE_MAP_POSITIVE_X&&l<=e.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&e.framebufferTexture2D(e.FRAMEBUFFER,a,l,n.get(r).__webglTexture,g),i.bindFramebuffer(e.FRAMEBUFFER,null)}function ie(t,i,n){if(e.bindRenderbuffer(e.RENDERBUFFER,t),i.depthBuffer&&!i.stencilBuffer){let s=!0===a?e.DEPTH_COMPONENT24:e.DEPTH_COMPONENT16;if(n||oe(i)){const t=i.depthTexture;t&&t.isDepthTexture&&(t.type===K?s=e.DEPTH_COMPONENT32F:t.type===D&&(s=e.DEPTH_COMPONENT24));const n=se(i);oe(i)?h.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,n,s,i.width,i.height):e.renderbufferStorageMultisample(e.RENDERBUFFER,n,s,i.width,i.height)}else e.renderbufferStorage(e.RENDERBUFFER,s,i.width,i.height);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t)}else if(i.depthBuffer&&i.stencilBuffer){const s=se(i);n&&!1===oe(i)?e.renderbufferStorageMultisample(e.RENDERBUFFER,s,e.DEPTH24_STENCIL8,i.width,i.height):oe(i)?h.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,s,e.DEPTH24_STENCIL8,i.width,i.height):e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,i.width,i.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t)}else{const t=!0===i.isWebGLMultipleRenderTargets?i.texture:[i.texture];for(let s=0;s<t.length;s++){const r=t[s],a=o.convert(r.format,r.colorSpace),l=o.convert(r.type),g=v(r.internalFormat,a,l,r.colorSpace),c=se(i);n&&!1===oe(i)?e.renderbufferStorageMultisample(e.RENDERBUFFER,c,g,i.width,i.height):oe(i)?h.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,c,g,i.width,i.height):e.renderbufferStorage(e.RENDERBUFFER,g,i.width,i.height)}}e.bindRenderbuffer(e.RENDERBUFFER,null)}function ne(t){const s=n.get(t),o=!0===t.isWebGLCubeRenderTarget;if(t.depthTexture&&!s.__autoAllocateDepthBuffer){if(o)throw new Error("target.depthTexture not supported in Cube render targets");!function(t,s){if(s&&s.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(i.bindFramebuffer(e.FRAMEBUFFER,t),!s.depthTexture||!s.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");n.get(s.depthTexture).__webglTexture&&s.depthTexture.image.width===s.width&&s.depthTexture.image.height===s.height||(s.depthTexture.image.width=s.width,s.depthTexture.image.height=s.height,s.depthTexture.needsUpdate=!0),L(s.depthTexture,0);const o=n.get(s.depthTexture).__webglTexture,r=se(s);if(s.depthTexture.format===J)oe(s)?h.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,o,0,r):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,o,0);else{if(s.depthTexture.format!==j)throw new Error("Unknown depthTexture format");oe(s)?h.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,o,0,r):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,o,0)}}(s.__webglFramebuffer,t)}else if(o){s.__webglDepthbuffer=[];for(let n=0;n<6;n++)i.bindFramebuffer(e.FRAMEBUFFER,s.__webglFramebuffer[n]),s.__webglDepthbuffer[n]=e.createRenderbuffer(),ie(s.__webglDepthbuffer[n],t,!1)}else i.bindFramebuffer(e.FRAMEBUFFER,s.__webglFramebuffer),s.__webglDepthbuffer=e.createRenderbuffer(),ie(s.__webglDepthbuffer,t,!1);i.bindFramebuffer(e.FRAMEBUFFER,null)}function se(e){return Math.min(d,e.samples)}function oe(e){const i=n.get(e);return a&&e.samples>0&&!0===t.has("WEBGL_multisampled_render_to_texture")&&!1!==i.__useRenderToTexture}function re(e,i){const n=e.colorSpace,s=e.format,o=e.type;return!0===e.isCompressedTexture||!0===e.isVideoTexture||e.format===it||n!==Pe&&n!==Ke&&(Zt.getTransfer(n)===Qe?!1===a?!0===t.has("EXT_sRGB")&&s===U?(e.format=it,e.minFilter=W,e.generateMipmaps=!1):i=Nt.sRGBToLinear(i):s===U&&o===F||console.warn("THREE.WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):console.error("THREE.WebGLTextures: Unsupported texture color space:",n)),i}this.allocateTextureUnit=function(){const e=H;return e>=l&&console.warn("THREE.WebGLTextures: Trying to use "+e+" texture units while this GPU supports only "+l),H+=1,e},this.resetTextureUnits=function(){H=0},this.setTexture2D=L,this.setTexture2DArray=function(t,s){const o=n.get(t);t.version>0&&o.__version!==t.version?ee(o,t,s):i.bindTexture(e.TEXTURE_2D_ARRAY,o.__webglTexture,e.TEXTURE0+s)},this.setTexture3D=function(t,s){const o=n.get(t);t.version>0&&o.__version!==t.version?ee(o,t,s):i.bindTexture(e.TEXTURE_3D,o.__webglTexture,e.TEXTURE0+s)},this.setTextureCube=function(t,s){const r=n.get(t);t.version>0&&r.__version!==t.version?function(t,s,r){if(6!==s.image.length)return;const l=$(t,s),c=s.source;i.bindTexture(e.TEXTURE_CUBE_MAP,t.__webglTexture,e.TEXTURE0+r);const d=n.get(c);if(c.version!==d.__version||!0===l){i.activeTexture(e.TEXTURE0+r);const t=Zt.getPrimaries(Zt.workingColorSpace),n=s.colorSpace===Ke?null:Zt.getPrimaries(s.colorSpace),h=s.colorSpace===Ke||t===n?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,s.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,s.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,h);const u=s.isCompressedTexture||s.image[0].isCompressedTexture,I=s.image[0]&&s.image[0].isDataTexture,p=[];for(let e=0;e<6;e++)p[e]=u||I?I?s.image[e].image:s.image[e]:f(s.image[e],!1,!0,g),p[e]=re(s,p[e]);const m=p[0],A=b(m)||a,C=o.convert(s.format,s.colorSpace),B=o.convert(s.type),w=v(s.internalFormat,C,B,s.colorSpace),S=a&&!0!==s.isVideoTexture,G=void 0===d.__version||!0===l;let M,R=x(s,m,A);if(q(e.TEXTURE_CUBE_MAP,s,A),u){S&&G&&i.texStorage2D(e.TEXTURE_CUBE_MAP,R,w,m.width,m.height);for(let t=0;t<6;t++){M=p[t].mipmaps;for(let n=0;n<M.length;n++){const o=M[n];s.format!==U?null!==C?S?i.compressedTexSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,n,0,0,o.width,o.height,C,o.data):i.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,n,w,o.width,o.height,0,o.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):S?i.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,n,0,0,o.width,o.height,C,B,o.data):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,n,w,o.width,o.height,0,C,B,o.data)}}}else{M=s.mipmaps,S&&G&&(M.length>0&&R++,i.texStorage2D(e.TEXTURE_CUBE_MAP,R,w,p[0].width,p[0].height));for(let t=0;t<6;t++)if(I){S?i.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,p[t].width,p[t].height,C,B,p[t].data):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,w,p[t].width,p[t].height,0,C,B,p[t].data);for(let n=0;n<M.length;n++){const s=M[n].image[t].image;S?i.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,n+1,0,0,s.width,s.height,C,B,s.data):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,n+1,w,s.width,s.height,0,C,B,s.data)}}else{S?i.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,C,B,p[t]):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,w,C,B,p[t]);for(let n=0;n<M.length;n++){const s=M[n];S?i.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,n+1,0,0,C,B,s.image[t]):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,n+1,w,C,B,s.image[t])}}}y(s,A)&&_(e.TEXTURE_CUBE_MAP),d.__version=c.version,s.onUpdate&&s.onUpdate(s)}t.__version=s.version}(r,t,s):i.bindTexture(e.TEXTURE_CUBE_MAP,r.__webglTexture,e.TEXTURE0+s)},this.rebindTextures=function(t,i,s){const o=n.get(t);void 0!==i&&te(o.__webglFramebuffer,t,t.texture,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,0),void 0!==s&&ne(t)},this.setupRenderTarget=function(t){const l=t.texture,g=n.get(t),c=n.get(l);t.addEventListener("dispose",S),!0!==t.isWebGLMultipleRenderTargets&&(void 0===c.__webglTexture&&(c.__webglTexture=e.createTexture()),c.__version=l.version,r.memory.textures++);const d=!0===t.isWebGLCubeRenderTarget,h=!0===t.isWebGLMultipleRenderTargets,u=b(t)||a;if(d){g.__webglFramebuffer=[];for(let t=0;t<6;t++)if(a&&l.mipmaps&&l.mipmaps.length>0){g.__webglFramebuffer[t]=[];for(let i=0;i<l.mipmaps.length;i++)g.__webglFramebuffer[t][i]=e.createFramebuffer()}else g.__webglFramebuffer[t]=e.createFramebuffer()}else{if(a&&l.mipmaps&&l.mipmaps.length>0){g.__webglFramebuffer=[];for(let t=0;t<l.mipmaps.length;t++)g.__webglFramebuffer[t]=e.createFramebuffer()}else g.__webglFramebuffer=e.createFramebuffer();if(h)if(s.drawBuffers){const i=t.texture;for(let t=0,s=i.length;t<s;t++){const s=n.get(i[t]);void 0===s.__webglTexture&&(s.__webglTexture=e.createTexture(),r.memory.textures++)}}else console.warn("THREE.WebGLRenderer: WebGLMultipleRenderTargets can only be used with WebGL2 or WEBGL_draw_buffers extension.");if(a&&t.samples>0&&!1===oe(t)){const n=h?l:[l];g.__webglMultisampledFramebuffer=e.createFramebuffer(),g.__webglColorRenderbuffer=[],i.bindFramebuffer(e.FRAMEBUFFER,g.__webglMultisampledFramebuffer);for(let i=0;i<n.length;i++){const s=n[i];g.__webglColorRenderbuffer[i]=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,g.__webglColorRenderbuffer[i]);const r=o.convert(s.format,s.colorSpace),a=o.convert(s.type),l=v(s.internalFormat,r,a,s.colorSpace,!0===t.isXRRenderTarget),c=se(t);e.renderbufferStorageMultisample(e.RENDERBUFFER,c,l,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+i,e.RENDERBUFFER,g.__webglColorRenderbuffer[i])}e.bindRenderbuffer(e.RENDERBUFFER,null),t.depthBuffer&&(g.__webglDepthRenderbuffer=e.createRenderbuffer(),ie(g.__webglDepthRenderbuffer,t,!0)),i.bindFramebuffer(e.FRAMEBUFFER,null)}}if(d){i.bindTexture(e.TEXTURE_CUBE_MAP,c.__webglTexture),q(e.TEXTURE_CUBE_MAP,l,u);for(let i=0;i<6;i++)if(a&&l.mipmaps&&l.mipmaps.length>0)for(let n=0;n<l.mipmaps.length;n++)te(g.__webglFramebuffer[i][n],t,l,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+i,n);else te(g.__webglFramebuffer[i],t,l,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+i,0);y(l,u)&&_(e.TEXTURE_CUBE_MAP),i.unbindTexture()}else if(h){const s=t.texture;for(let o=0,r=s.length;o<r;o++){const r=s[o],a=n.get(r);i.bindTexture(e.TEXTURE_2D,a.__webglTexture),q(e.TEXTURE_2D,r,u),te(g.__webglFramebuffer,t,r,e.COLOR_ATTACHMENT0+o,e.TEXTURE_2D,0),y(r,u)&&_(e.TEXTURE_2D)}i.unbindTexture()}else{let n=e.TEXTURE_2D;if((t.isWebGL3DRenderTarget||t.isWebGLArrayRenderTarget)&&(a?n=t.isWebGL3DRenderTarget?e.TEXTURE_3D:e.TEXTURE_2D_ARRAY:console.error("THREE.WebGLTextures: THREE.Data3DTexture and THREE.DataArrayTexture only supported with WebGL2.")),i.bindTexture(n,c.__webglTexture),q(n,l,u),a&&l.mipmaps&&l.mipmaps.length>0)for(let i=0;i<l.mipmaps.length;i++)te(g.__webglFramebuffer[i],t,l,e.COLOR_ATTACHMENT0,n,i);else te(g.__webglFramebuffer,t,l,e.COLOR_ATTACHMENT0,n,0);y(l,u)&&_(n),i.unbindTexture()}t.depthBuffer&&ne(t)},this.updateRenderTargetMipmap=function(t){const s=b(t)||a,o=!0===t.isWebGLMultipleRenderTargets?t.texture:[t.texture];for(let r=0,a=o.length;r<a;r++){const a=o[r];if(y(a,s)){const s=t.isWebGLCubeRenderTarget?e.TEXTURE_CUBE_MAP:e.TEXTURE_2D,o=n.get(a).__webglTexture;i.bindTexture(s,o),_(s),i.unbindTexture()}}},this.updateMultisampleRenderTarget=function(t){if(a&&t.samples>0&&!1===oe(t)){const s=t.isWebGLMultipleRenderTargets?t.texture:[t.texture],o=t.width,r=t.height;let a=e.COLOR_BUFFER_BIT;const l=[],g=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,c=n.get(t),d=!0===t.isWebGLMultipleRenderTargets;if(d)for(let t=0;t<s.length;t++)i.bindFramebuffer(e.FRAMEBUFFER,c.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,null),i.bindFramebuffer(e.FRAMEBUFFER,c.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,null,0);i.bindFramebuffer(e.READ_FRAMEBUFFER,c.__webglMultisampledFramebuffer),i.bindFramebuffer(e.DRAW_FRAMEBUFFER,c.__webglFramebuffer);for(let i=0;i<s.length;i++){l.push(e.COLOR_ATTACHMENT0+i),t.depthBuffer&&l.push(g);const h=void 0!==c.__ignoreDepthValues&&c.__ignoreDepthValues;if(!1===h&&(t.depthBuffer&&(a|=e.DEPTH_BUFFER_BIT),t.stencilBuffer&&(a|=e.STENCIL_BUFFER_BIT)),d&&e.framebufferRenderbuffer(e.READ_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,c.__webglColorRenderbuffer[i]),!0===h&&(e.invalidateFramebuffer(e.READ_FRAMEBUFFER,[g]),e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,[g])),d){const t=n.get(s[i]).__webglTexture;e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0)}e.blitFramebuffer(0,0,o,r,0,0,o,r,a,e.NEAREST),u&&e.invalidateFramebuffer(e.READ_FRAMEBUFFER,l)}if(i.bindFramebuffer(e.READ_FRAMEBUFFER,null),i.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),d)for(let t=0;t<s.length;t++){i.bindFramebuffer(e.FRAMEBUFFER,c.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,c.__webglColorRenderbuffer[t]);const o=n.get(s[t]).__webglTexture;i.bindFramebuffer(e.FRAMEBUFFER,c.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,o,0)}i.bindFramebuffer(e.DRAW_FRAMEBUFFER,c.__webglMultisampledFramebuffer)}},this.setupDepthRenderbuffer=ne,this.setupFrameBufferTexture=te,this.useMultisampledRTT=oe}function Jr(e,t,i){const n=i.isWebGL2;return{convert:function(i,s=Ke){let o;const r=Zt.getTransfer(s);if(i===F)return e.UNSIGNED_BYTE;if(i===P)return e.UNSIGNED_SHORT_4_4_4_4;if(i===k)return e.UNSIGNED_SHORT_5_5_5_1;if(i===X)return e.BYTE;if(i===H)return e.SHORT;if(i===z)return e.UNSIGNED_SHORT;if(i===L)return e.INT;if(i===D)return e.UNSIGNED_INT;if(i===K)return e.FLOAT;if(i===Y)return n?e.HALF_FLOAT:(o=t.get("OES_texture_half_float"),null!==o?o.HALF_FLOAT_OES:null);if(1021===i)return e.ALPHA;if(i===U)return e.RGBA;if(i===Q)return e.LUMINANCE;if(1025===i)return e.LUMINANCE_ALPHA;if(i===J)return e.DEPTH_COMPONENT;if(i===j)return e.DEPTH_STENCIL;if(i===it)return o=t.get("EXT_sRGB"),null!==o?o.SRGB_ALPHA_EXT:null;if(i===q)return e.RED;if(i===$)return e.RED_INTEGER;if(i===ee)return e.RG;if(i===te)return e.RG_INTEGER;if(i===ie)return e.RGBA_INTEGER;if(i===ne||i===se||i===oe||i===re)if(r===Qe){if(o=t.get("WEBGL_compressed_texture_s3tc_srgb"),null===o)return null;if(i===ne)return o.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(i===se)return o.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(i===oe)return o.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(i===re)return o.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(o=t.get("WEBGL_compressed_texture_s3tc"),null===o)return null;if(i===ne)return o.COMPRESSED_RGB_S3TC_DXT1_EXT;if(i===se)return o.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(i===oe)return o.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(i===re)return o.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(i===ae||i===le||i===ge||i===ce){if(o=t.get("WEBGL_compressed_texture_pvrtc"),null===o)return null;if(i===ae)return o.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(i===le)return o.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(i===ge)return o.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(i===ce)return o.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(i===de)return o=t.get("WEBGL_compressed_texture_etc1"),null!==o?o.COMPRESSED_RGB_ETC1_WEBGL:null;if(i===he||i===ue){if(o=t.get("WEBGL_compressed_texture_etc"),null===o)return null;if(i===he)return r===Qe?o.COMPRESSED_SRGB8_ETC2:o.COMPRESSED_RGB8_ETC2;if(i===ue)return r===Qe?o.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:o.COMPRESSED_RGBA8_ETC2_EAC}if(i===Ie||i===pe||i===me||i===Ae||i===Ce||i===fe||i===be||i===ye||i===_e||i===ve||i===xe||i===Be||i===we||i===Se){if(o=t.get("WEBGL_compressed_texture_astc"),null===o)return null;if(i===Ie)return r===Qe?o.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:o.COMPRESSED_RGBA_ASTC_4x4_KHR;if(i===pe)return r===Qe?o.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:o.COMPRESSED_RGBA_ASTC_5x4_KHR;if(i===me)return r===Qe?o.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:o.COMPRESSED_RGBA_ASTC_5x5_KHR;if(i===Ae)return r===Qe?o.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:o.COMPRESSED_RGBA_ASTC_6x5_KHR;if(i===Ce)return r===Qe?o.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:o.COMPRESSED_RGBA_ASTC_6x6_KHR;if(i===fe)return r===Qe?o.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:o.COMPRESSED_RGBA_ASTC_8x5_KHR;if(i===be)return r===Qe?o.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:o.COMPRESSED_RGBA_ASTC_8x6_KHR;if(i===ye)return r===Qe?o.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:o.COMPRESSED_RGBA_ASTC_8x8_KHR;if(i===_e)return r===Qe?o.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:o.COMPRESSED_RGBA_ASTC_10x5_KHR;if(i===ve)return r===Qe?o.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:o.COMPRESSED_RGBA_ASTC_10x6_KHR;if(i===xe)return r===Qe?o.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:o.COMPRESSED_RGBA_ASTC_10x8_KHR;if(i===Be)return r===Qe?o.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:o.COMPRESSED_RGBA_ASTC_10x10_KHR;if(i===we)return r===Qe?o.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:o.COMPRESSED_RGBA_ASTC_12x10_KHR;if(i===Se)return r===Qe?o.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:o.COMPRESSED_RGBA_ASTC_12x12_KHR}if(i===Ge||i===Me||i===Re){if(o=t.get("EXT_texture_compression_bptc"),null===o)return null;if(i===Ge)return r===Qe?o.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:o.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(i===Me)return o.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(i===Re)return o.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(36283===i||i===Te||i===Ze||i===Ve){if(o=t.get("EXT_texture_compression_rgtc"),null===o)return null;if(i===Ge)return o.COMPRESSED_RED_RGTC1_EXT;if(i===Te)return o.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(i===Ze)return o.COMPRESSED_RED_GREEN_RGTC2_EXT;if(i===Ve)return o.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return i===O?n?e.UNSIGNED_INT_24_8:(o=t.get("WEBGL_depth_texture"),null!==o?o.UNSIGNED_INT_24_8_WEBGL:null):void 0!==e[i]?e[i]:null}}}class jr extends cs{constructor(e=[]){super(),this.isArrayCamera=!0,this.cameras=e}}class qr extends Ji{constructor(){super(),this.isGroup=!0,this.type="Group"}}const $r={type:"move"};class ea{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new qr,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new qr,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new Qt,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new Qt),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new qr,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new Qt,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new Qt),this._grip}dispatchEvent(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),null!==this._hand&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){const t=this._hand;if(t)for(const i of e.hand.values())this._getHandJoint(t,i)}return this.dispatchEvent({type:"connected",data:e}),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(e,t,i){let n=null,s=null,o=null;const r=this._targetRay,a=this._grip,l=this._hand;if(e&&"visible-blurred"!==t.session.visibilityState){if(l&&e.hand){o=!0;for(const o of e.hand.values()){const e=t.getJointPose(o,i),n=this._getHandJoint(l,o);null!==e&&(n.matrix.fromArray(e.transform.matrix),n.matrix.decompose(n.position,n.rotation,n.scale),n.matrixWorldNeedsUpdate=!0,n.jointRadius=e.radius),n.visible=null!==e}const n=l.joints["index-finger-tip"],s=l.joints["thumb-tip"],r=n.position.distanceTo(s.position),a=.02,g=.005;l.inputState.pinching&&r>a+g?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!l.inputState.pinching&&r<=a-g&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else null!==a&&e.gripSpace&&(s=t.getPose(e.gripSpace,i),null!==s&&(a.matrix.fromArray(s.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),a.matrixWorldNeedsUpdate=!0,s.linearVelocity?(a.hasLinearVelocity=!0,a.linearVelocity.copy(s.linearVelocity)):a.hasLinearVelocity=!1,s.angularVelocity?(a.hasAngularVelocity=!0,a.angularVelocity.copy(s.angularVelocity)):a.hasAngularVelocity=!1));null!==r&&(n=t.getPose(e.targetRaySpace,i),null===n&&null!==s&&(n=s),null!==n&&(r.matrix.fromArray(n.transform.matrix),r.matrix.decompose(r.position,r.rotation,r.scale),r.matrixWorldNeedsUpdate=!0,n.linearVelocity?(r.hasLinearVelocity=!0,r.linearVelocity.copy(n.linearVelocity)):r.hasLinearVelocity=!1,n.angularVelocity?(r.hasAngularVelocity=!0,r.angularVelocity.copy(n.angularVelocity)):r.hasAngularVelocity=!1,this.dispatchEvent($r)))}return null!==r&&(r.visible=null!==n),null!==a&&(a.visible=null!==s),null!==l&&(l.visible=null!==o),this}_getHandJoint(e,t){if(void 0===e.joints[t.jointName]){const i=new qr;i.matrixAutoUpdate=!1,i.visible=!1,e.joints[t.jointName]=i,e.add(i)}return e.joints[t.jointName]}}class ta extends Lt{constructor(e,t,i,n,s,o,r,a,l,g){if((g=void 0!==g?g:J)!==J&&g!==j)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===i&&g===J&&(i=D),void 0===i&&g===j&&(i=O),super(null,n,s,o,r,a,g,i,l),this.isDepthTexture=!0,this.image={width:e,height:t},this.magFilter=void 0!==r?r:T,this.minFilter=void 0!==a?a:T,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.compareFunction=e.compareFunction,this}toJSON(e){const t=super.toJSON(e);return null!==this.compareFunction&&(t.compareFunction=this.compareFunction),t}}class ia extends ot{constructor(e,t){super();const i=this;let n=null,s=1,o=null,r="local-floor",a=1,l=null,g=null,c=null,d=null,h=null,u=null;const I=t.getContextAttributes();let p=null,m=null;const A=[],C=[],f=new cs;f.layers.enable(1),f.viewport=new Dt;const b=new cs;b.layers.enable(2),b.viewport=new Dt;const y=[f,b],_=new jr;_.layers.enable(1),_.layers.enable(2);let v=null,x=null;function B(e){const t=C.indexOf(e.inputSource);if(-1===t)return;const i=A[t];void 0!==i&&(i.update(e.inputSource,e.frame,l||o),i.dispatchEvent({type:e.type,data:e.inputSource}))}function w(){n.removeEventListener("select",B),n.removeEventListener("selectstart",B),n.removeEventListener("selectend",B),n.removeEventListener("squeeze",B),n.removeEventListener("squeezestart",B),n.removeEventListener("squeezeend",B),n.removeEventListener("end",w),n.removeEventListener("inputsourceschange",S);for(let e=0;e<A.length;e++){const t=C[e];null!==t&&(C[e]=null,A[e].disconnect(t))}v=null,x=null,e.setRenderTarget(p),h=null,d=null,c=null,n=null,m=null,Z.stop(),i.isPresenting=!1,i.dispatchEvent({type:"sessionend"})}function S(e){for(let t=0;t<e.removed.length;t++){const i=e.removed[t],n=C.indexOf(i);n>=0&&(C[n]=null,A[n].disconnect(i))}for(let t=0;t<e.added.length;t++){const i=e.added[t];let n=C.indexOf(i);if(-1===n){for(let e=0;e<A.length;e++){if(e>=C.length){C.push(i),n=e;break}if(null===C[e]){C[e]=i,n=e;break}}if(-1===n)break}const s=A[n];s&&s.connect(i)}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(e){let t=A[e];return void 0===t&&(t=new ea,A[e]=t),t.getTargetRaySpace()},this.getControllerGrip=function(e){let t=A[e];return void 0===t&&(t=new ea,A[e]=t),t.getGripSpace()},this.getHand=function(e){let t=A[e];return void 0===t&&(t=new ea,A[e]=t),t.getHandSpace()},this.setFramebufferScaleFactor=function(e){s=e,!0===i.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(e){r=e,!0===i.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return l||o},this.setReferenceSpace=function(e){l=e},this.getBaseLayer=function(){return null!==d?d:h},this.getBinding=function(){return c},this.getFrame=function(){return u},this.getSession=function(){return n},this.setSession=async function(g){if(n=g,null!==n){if(p=e.getRenderTarget(),n.addEventListener("select",B),n.addEventListener("selectstart",B),n.addEventListener("selectend",B),n.addEventListener("squeeze",B),n.addEventListener("squeezestart",B),n.addEventListener("squeezeend",B),n.addEventListener("end",w),n.addEventListener("inputsourceschange",S),!0!==I.xrCompatible&&await t.makeXRCompatible(),void 0===n.renderState.layers||!1===e.capabilities.isWebGL2){const i={antialias:void 0!==n.renderState.layers||I.antialias,alpha:!0,depth:I.depth,stencil:I.stencil,framebufferScaleFactor:s};h=new XRWebGLLayer(n,t,i),n.updateRenderState({baseLayer:h}),m=new Yt(h.framebufferWidth,h.framebufferHeight,{format:U,type:F,colorSpace:e.outputColorSpace,stencilBuffer:I.stencil})}else{let i=null,o=null,r=null;I.depth&&(r=I.stencil?t.DEPTH24_STENCIL8:t.DEPTH_COMPONENT24,i=I.stencil?j:J,o=I.stencil?O:D);const a={colorFormat:t.RGBA8,depthFormat:r,scaleFactor:s};c=new XRWebGLBinding(n,t),d=c.createProjectionLayer(a),n.updateRenderState({layers:[d]}),m=new Yt(d.textureWidth,d.textureHeight,{format:U,type:F,depthTexture:new ta(d.textureWidth,d.textureHeight,o,void 0,void 0,void 0,void 0,void 0,void 0,i),stencilBuffer:I.stencil,colorSpace:e.outputColorSpace,samples:I.antialias?4:0});e.properties.get(m).__ignoreDepthValues=d.ignoreDepthValues}m.isXRRenderTarget=!0,this.setFoveation(a),l=null,o=await n.requestReferenceSpace(r),Z.setContext(n),Z.start(),i.isPresenting=!0,i.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(null!==n)return n.environmentBlendMode};const G=new Qt,M=new Qt;function R(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}this.updateCamera=function(e){if(null===n)return;_.near=b.near=f.near=e.near,_.far=b.far=f.far=e.far,v===_.near&&x===_.far||(n.updateRenderState({depthNear:_.near,depthFar:_.far}),v=_.near,x=_.far);const t=e.parent,i=_.cameras;R(_,t);for(let n=0;n<i.length;n++)R(i[n],t);2===i.length?function(e,t,i){G.setFromMatrixPosition(t.matrixWorld),M.setFromMatrixPosition(i.matrixWorld);const n=G.distanceTo(M),s=t.projectionMatrix.elements,o=i.projectionMatrix.elements,r=s[14]/(s[10]-1),a=s[14]/(s[10]+1),l=(s[9]+1)/s[5],g=(s[9]-1)/s[5],c=(s[8]-1)/s[0],d=(o[8]+1)/o[0],h=r*c,u=r*d,I=n/(-c+d),p=I*-c;t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(p),e.translateZ(I),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert();const m=r+I,A=a+I,C=h-p,f=u+(n-p),b=l*a/A*m,y=g*a/A*m;e.projectionMatrix.makePerspective(C,f,b,y,m,A),e.projectionMatrixInverse.copy(e.projectionMatrix).invert()}(_,f,b):_.projectionMatrix.copy(f.projectionMatrix),function(e,t,i){null===i?e.matrix.copy(t.matrixWorld):(e.matrix.copy(i.matrixWorld),e.matrix.invert(),e.matrix.multiply(t.matrixWorld));e.matrix.decompose(e.position,e.quaternion,e.scale),e.updateMatrixWorld(!0),e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse),e.isPerspectiveCamera&&(e.fov=2*gt*Math.atan(1/e.projectionMatrix.elements[5]),e.zoom=1)}(e,_,t)},this.getCamera=function(){return _},this.getFoveation=function(){if(null!==d||null!==h)return a},this.setFoveation=function(e){a=e,null!==d&&(d.fixedFoveation=e),null!==h&&void 0!==h.fixedFoveation&&(h.fixedFoveation=e)};let T=null;const Z=new _s;Z.setAnimationLoop((function(t,n){if(g=n.getViewerPose(l||o),u=n,null!==g){const t=g.views;null!==h&&(e.setRenderTargetFramebuffer(m,h.framebuffer),e.setRenderTarget(m));let i=!1;t.length!==_.cameras.length&&(_.cameras.length=0,i=!0);for(let n=0;n<t.length;n++){const s=t[n];let o=null;if(null!==h)o=h.getViewport(s);else{const t=c.getViewSubImage(d,s);o=t.viewport,0===n&&(e.setRenderTargetTextures(m,t.colorTexture,d.ignoreDepthValues?void 0:t.depthStencilTexture),e.setRenderTarget(m))}let r=y[n];void 0===r&&(r=new cs,r.layers.enable(n),r.viewport=new Dt,y[n]=r),r.matrix.fromArray(s.transform.matrix),r.matrix.decompose(r.position,r.quaternion,r.scale),r.projectionMatrix.fromArray(s.projectionMatrix),r.projectionMatrixInverse.copy(r.projectionMatrix).invert(),r.viewport.set(o.x,o.y,o.width,o.height),0===n&&(_.matrix.copy(r.matrix),_.matrix.decompose(_.position,_.quaternion,_.scale)),!0===i&&_.cameras.push(r)}}for(let e=0;e<A.length;e++){const t=C[e],i=A[e];null!==t&&void 0!==i&&i.update(t,n,l||o)}T&&T(t,n),n.detectedPlanes&&i.dispatchEvent({type:"planesdetected",data:n}),u=null})),this.setAnimationLoop=function(e){T=e},this.dispose=function(){}}}function na(e,t){function i(e,t){!0===e.matrixAutoUpdate&&e.updateMatrix(),t.value.copy(e.matrix)}function n(n,s){n.opacity.value=s.opacity,s.color&&n.diffuse.value.copy(s.color),s.emissive&&n.emissive.value.copy(s.emissive).multiplyScalar(s.emissiveIntensity),s.map&&(n.map.value=s.map,i(s.map,n.mapTransform)),s.alphaMap&&(n.alphaMap.value=s.alphaMap,i(s.alphaMap,n.alphaMapTransform)),s.bumpMap&&(n.bumpMap.value=s.bumpMap,i(s.bumpMap,n.bumpMapTransform),n.bumpScale.value=s.bumpScale,s.side===c&&(n.bumpScale.value*=-1)),s.normalMap&&(n.normalMap.value=s.normalMap,i(s.normalMap,n.normalMapTransform),n.normalScale.value.copy(s.normalScale),s.side===c&&n.normalScale.value.negate()),s.displacementMap&&(n.displacementMap.value=s.displacementMap,i(s.displacementMap,n.displacementMapTransform),n.displacementScale.value=s.displacementScale,n.displacementBias.value=s.displacementBias),s.emissiveMap&&(n.emissiveMap.value=s.emissiveMap,i(s.emissiveMap,n.emissiveMapTransform)),s.specularMap&&(n.specularMap.value=s.specularMap,i(s.specularMap,n.specularMapTransform)),s.alphaTest>0&&(n.alphaTest.value=s.alphaTest);const o=t.get(s).envMap;if(o&&(n.envMap.value=o,n.flipEnvMap.value=o.isCubeTexture&&!1===o.isRenderTargetTexture?-1:1,n.reflectivity.value=s.reflectivity,n.ior.value=s.ior,n.refractionRatio.value=s.refractionRatio),s.lightMap){n.lightMap.value=s.lightMap;const t=!0===e._useLegacyLights?Math.PI:1;n.lightMapIntensity.value=s.lightMapIntensity*t,i(s.lightMap,n.lightMapTransform)}s.aoMap&&(n.aoMap.value=s.aoMap,n.aoMapIntensity.value=s.aoMapIntensity,i(s.aoMap,n.aoMapTransform))}return{refreshFogUniforms:function(t,i){i.color.getRGB(t.fogColor.value,rs(e)),i.isFog?(t.fogNear.value=i.near,t.fogFar.value=i.far):i.isFogExp2&&(t.fogDensity.value=i.density)},refreshMaterialUniforms:function(e,s,o,r,a){s.isMeshBasicMaterial||s.isMeshLambertMaterial?n(e,s):s.isMeshToonMaterial?(n(e,s),function(e,t){t.gradientMap&&(e.gradientMap.value=t.gradientMap)}(e,s)):s.isMeshPhongMaterial?(n(e,s),function(e,t){e.specular.value.copy(t.specular),e.shininess.value=Math.max(t.shininess,1e-4)}(e,s)):s.isMeshStandardMaterial?(n(e,s),function(e,n){e.metalness.value=n.metalness,n.metalnessMap&&(e.metalnessMap.value=n.metalnessMap,i(n.metalnessMap,e.metalnessMapTransform));e.roughness.value=n.roughness,n.roughnessMap&&(e.roughnessMap.value=n.roughnessMap,i(n.roughnessMap,e.roughnessMapTransform));const s=t.get(n).envMap;s&&(e.envMapIntensity.value=n.envMapIntensity)}(e,s),s.isMeshPhysicalMaterial&&function(e,t,n){e.ior.value=t.ior,t.sheen>0&&(e.sheenColor.value.copy(t.sheenColor).multiplyScalar(t.sheen),e.sheenRoughness.value=t.sheenRoughness,t.sheenColorMap&&(e.sheenColorMap.value=t.sheenColorMap,i(t.sheenColorMap,e.sheenColorMapTransform)),t.sheenRoughnessMap&&(e.sheenRoughnessMap.value=t.sheenRoughnessMap,i(t.sheenRoughnessMap,e.sheenRoughnessMapTransform)));t.clearcoat>0&&(e.clearcoat.value=t.clearcoat,e.clearcoatRoughness.value=t.clearcoatRoughness,t.clearcoatMap&&(e.clearcoatMap.value=t.clearcoatMap,i(t.clearcoatMap,e.clearcoatMapTransform)),t.clearcoatRoughnessMap&&(e.clearcoatRoughnessMap.value=t.clearcoatRoughnessMap,i(t.clearcoatRoughnessMap,e.clearcoatRoughnessMapTransform)),t.clearcoatNormalMap&&(e.clearcoatNormalMap.value=t.clearcoatNormalMap,i(t.clearcoatNormalMap,e.clearcoatNormalMapTransform),e.clearcoatNormalScale.value.copy(t.clearcoatNormalScale),t.side===c&&e.clearcoatNormalScale.value.negate()));t.iridescence>0&&(e.iridescence.value=t.iridescence,e.iridescenceIOR.value=t.iridescenceIOR,e.iridescenceThicknessMinimum.value=t.iridescenceThicknessRange[0],e.iridescenceThicknessMaximum.value=t.iridescenceThicknessRange[1],t.iridescenceMap&&(e.iridescenceMap.value=t.iridescenceMap,i(t.iridescenceMap,e.iridescenceMapTransform)),t.iridescenceThicknessMap&&(e.iridescenceThicknessMap.value=t.iridescenceThicknessMap,i(t.iridescenceThicknessMap,e.iridescenceThicknessMapTransform)));t.transmission>0&&(e.transmission.value=t.transmission,e.transmissionSamplerMap.value=n.texture,e.transmissionSamplerSize.value.set(n.width,n.height),t.transmissionMap&&(e.transmissionMap.value=t.transmissionMap,i(t.transmissionMap,e.transmissionMapTransform)),e.thickness.value=t.thickness,t.thicknessMap&&(e.thicknessMap.value=t.thicknessMap,i(t.thicknessMap,e.thicknessMapTransform)),e.attenuationDistance.value=t.attenuationDistance,e.attenuationColor.value.copy(t.attenuationColor));t.anisotropy>0&&(e.anisotropyVector.value.set(t.anisotropy*Math.cos(t.anisotropyRotation),t.anisotropy*Math.sin(t.anisotropyRotation)),t.anisotropyMap&&(e.anisotropyMap.value=t.anisotropyMap,i(t.anisotropyMap,e.anisotropyMapTransform)));e.specularIntensity.value=t.specularIntensity,e.specularColor.value.copy(t.specularColor),t.specularColorMap&&(e.specularColorMap.value=t.specularColorMap,i(t.specularColorMap,e.specularColorMapTransform));t.specularIntensityMap&&(e.specularIntensityMap.value=t.specularIntensityMap,i(t.specularIntensityMap,e.specularIntensityMapTransform))}(e,s,a)):s.isMeshMatcapMaterial?(n(e,s),function(e,t){t.matcap&&(e.matcap.value=t.matcap)}(e,s)):s.isMeshDepthMaterial?n(e,s):s.isMeshDistanceMaterial?(n(e,s),function(e,i){const n=t.get(i).light;e.referencePosition.value.setFromMatrixPosition(n.matrixWorld),e.nearDistance.value=n.shadow.camera.near,e.farDistance.value=n.shadow.camera.far}(e,s)):s.isMeshNormalMaterial?n(e,s):s.isLineBasicMaterial?(function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,t.map&&(e.map.value=t.map,i(t.map,e.mapTransform))}(e,s),s.isLineDashedMaterial&&function(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(e,s)):s.isPointsMaterial?function(e,t,n,s){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.size.value=t.size*n,e.scale.value=.5*s,t.map&&(e.map.value=t.map,i(t.map,e.uvTransform));t.alphaMap&&(e.alphaMap.value=t.alphaMap,i(t.alphaMap,e.alphaMapTransform));t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,s,o,r):s.isSpriteMaterial?function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.rotation.value=t.rotation,t.map&&(e.map.value=t.map,i(t.map,e.mapTransform));t.alphaMap&&(e.alphaMap.value=t.alphaMap,i(t.alphaMap,e.alphaMapTransform));t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,s):s.isShadowMaterial?(e.color.value.copy(s.color),e.opacity.value=s.opacity):s.isShaderMaterial&&(s.uniformsNeedUpdate=!1)}}}function sa(e,t,i,n){let s={},o={},r=[];const a=i.isWebGL2?e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS):0;function l(e,t,i){const n=e.value;if(void 0===i[t]){if("number"==typeof n)i[t]=n;else{const e=Array.isArray(n)?n:[n],s=[];for(let t=0;t<e.length;t++)s.push(e[t].clone());i[t]=s}return!0}if("number"==typeof n){if(i[t]!==n)return i[t]=n,!0}else{const e=Array.isArray(i[t])?i[t]:[i[t]],s=Array.isArray(n)?n:[n];for(let t=0;t<e.length;t++){const i=e[t];if(!1===i.equals(s[t]))return i.copy(s[t]),!0}}return!1}function g(e){const t={boundary:0,storage:0};return"number"==typeof e?(t.boundary=4,t.storage=4):e.isVector2?(t.boundary=8,t.storage=8):e.isVector3||e.isColor?(t.boundary=16,t.storage=12):e.isVector4?(t.boundary=16,t.storage=16):e.isMatrix3?(t.boundary=48,t.storage=48):e.isMatrix4?(t.boundary=64,t.storage=64):e.isTexture?console.warn("THREE.WebGLRenderer: Texture samplers can not be part of an uniforms group."):console.warn("THREE.WebGLRenderer: Unsupported uniform value type.",e),t}function c(t){const i=t.target;i.removeEventListener("dispose",c);const n=r.indexOf(i.__bindingPointIndex);r.splice(n,1),e.deleteBuffer(s[i.id]),delete s[i.id],delete o[i.id]}return{bind:function(e,t){const i=t.program;n.uniformBlockBinding(e,i)},update:function(i,d){let h=s[i.id];void 0===h&&(!function(e){const t=e.uniforms;let i=0;const n=16;let s=0;for(let o=0,r=t.length;o<r;o++){const e=t[o],r={boundary:0,storage:0},a=Array.isArray(e.value)?e.value:[e.value];for(let t=0,i=a.length;t<i;t++){const e=g(a[t]);r.boundary+=e.boundary,r.storage+=e.storage}if(e.__data=new Float32Array(r.storage/Float32Array.BYTES_PER_ELEMENT),e.__offset=i,o>0){s=i%n;0!==s&&n-s-r.boundary<0&&(i+=n-s,e.__offset=i)}i+=r.storage}s=i%n,s>0&&(i+=n-s);e.__size=i,e.__cache={}}(i),h=function(t){const i=function(){for(let e=0;e<a;e++)if(-1===r.indexOf(e))return r.push(e),e;return console.error("THREE.WebGLRenderer: Maximum number of simultaneously usable uniforms groups reached."),0}();t.__bindingPointIndex=i;const n=e.createBuffer(),s=t.__size,o=t.usage;return e.bindBuffer(e.UNIFORM_BUFFER,n),e.bufferData(e.UNIFORM_BUFFER,s,o),e.bindBuffer(e.UNIFORM_BUFFER,null),e.bindBufferBase(e.UNIFORM_BUFFER,i,n),n}(i),s[i.id]=h,i.addEventListener("dispose",c));const u=d.program;n.updateUBOMapping(i,u);const I=t.render.frame;o[i.id]!==I&&(!function(t){const i=s[t.id],n=t.uniforms,o=t.__cache;e.bindBuffer(e.UNIFORM_BUFFER,i);for(let s=0,r=n.length;s<r;s++){const t=n[s];if(!0===l(t,s,o)){const i=t.__offset,n=Array.isArray(t.value)?t.value:[t.value];let s=0;for(let o=0;o<n.length;o++){const r=n[o],a=g(r);"number"==typeof r?(t.__data[0]=r,e.bufferSubData(e.UNIFORM_BUFFER,i+s,t.__data)):r.isMatrix3?(t.__data[0]=r.elements[0],t.__data[1]=r.elements[1],t.__data[2]=r.elements[2],t.__data[3]=r.elements[0],t.__data[4]=r.elements[3],t.__data[5]=r.elements[4],t.__data[6]=r.elements[5],t.__data[7]=r.elements[0],t.__data[8]=r.elements[6],t.__data[9]=r.elements[7],t.__data[10]=r.elements[8],t.__data[11]=r.elements[0]):(r.toArray(t.__data,s),s+=a.storage/Float32Array.BYTES_PER_ELEMENT)}e.bufferSubData(e.UNIFORM_BUFFER,i,t.__data)}}e.bindBuffer(e.UNIFORM_BUFFER,null)}(i),o[i.id]=I)},dispose:function(){for(const t in s)e.deleteBuffer(s[t]);r=[],s={},o={}}}}class oa{constructor(e={}){const{canvas:t=Bt(),context:i=null,depth:n=!0,stencil:s=!0,alpha:r=!1,antialias:a=!1,premultipliedAlpha:l=!0,preserveDrawingBuffer:d=!1,powerPreference:h="default",failIfMajorPerformanceCaveat:u=!1}=e;let I;this.isWebGLRenderer=!0,I=null!==i?i.getContextAttributes().alpha:r;const p=new Uint32Array(4),m=new Int32Array(4);let C=null,f=null;const b=[],y=[];this.domElement=t,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this._outputColorSpace=Ye,this._useLegacyLights=!1,this.toneMapping=A,this.toneMappingExposure=1;const _=this;let v=!1,x=0,B=0,w=null,S=-1,G=null;const M=new Dt,R=new Dt;let T=null;const Z=new In(0);let V=0,W=t.width,E=t.height,X=1,H=null,L=null;const Q=new Dt(0,0,W,E),J=new Dt(0,0,W,E);let j=!1;const q=new ys;let ee=!1,ne=!1,se=null;const oe=new Bi,re=new bt,ae=new Qt,le={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function ge(){return null===w?X:1}let ce,de,he,ue,Ie,pe,me,Ae,Ce,fe,be,ye,_e,ve,xe,Be,we,Se,Ge,Me,Re,Te,Ze,Ve,We=i;function Ee(e,i){for(let n=0;n<e.length;n++){const s=e[n],o=t.getContext(s,i);if(null!==o)return o}return null}try{const e={alpha:!0,depth:n,stencil:s,antialias:a,premultipliedAlpha:l,preserveDrawingBuffer:d,powerPreference:h,failIfMajorPerformanceCaveat:u};if("setAttribute"in t&&t.setAttribute("data-engine",`three.js r${o}`),t.addEventListener("webglcontextlost",Xe,!1),t.addEventListener("webglcontextrestored",He,!1),t.addEventListener("webglcontextcreationerror",ze,!1),null===We){const t=["webgl2","webgl","experimental-webgl"];if(!0===_.isWebGL1Renderer&&t.shift(),We=Ee(t,e),null===We)throw Ee(t)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}"undefined"!=typeof WebGLRenderingContext&&We instanceof WebGLRenderingContext&&console.warn("THREE.WebGLRenderer: WebGL 1 support was deprecated in r153 and will be removed in r163."),void 0===We.getShaderPrecisionFormat&&(We.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(it){throw console.error("THREE.WebGLRenderer: "+it.message),it}function Ne(){ce=new $s(We),de=new Zs(We,ce,e),ce.init(de),Te=new Jr(We,ce,de),he=new Ur(We,ce,de),ue=new io(We),Ie=new Wr,pe=new Qr(We,ce,he,Ie,de,Te,ue),me=new Ws(_),Ae=new qs(_),Ce=new vs(We,de),Ze=new Rs(We,ce,Ce,de),fe=new eo(We,Ce,ue,Ze),be=new ro(We,fe,Ce,ue),Ge=new oo(We,de,pe),Be=new Vs(Ie),ye=new Vr(_,me,Ae,ce,de,Ze,Be),_e=new na(_,Ie),ve=new Xr,xe=new Yr(ce,de),Se=new Ms(_,me,Ae,he,be,I,l),we=new Or(_,be,de),Ve=new sa(We,ue,de,he),Me=new Ts(We,ce,ue,de),Re=new to(We,ce,ue,de),ue.programs=ye.programs,_.capabilities=de,_.extensions=ce,_.properties=Ie,_.renderLists=ve,_.shadowMap=we,_.state=he,_.info=ue}Ne();const Fe=new ia(_,We);function Xe(e){e.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),v=!0}function He(){console.log("THREE.WebGLRenderer: Context Restored."),v=!1;const e=ue.autoReset,t=we.enabled,i=we.autoUpdate,n=we.needsUpdate,s=we.type;Ne(),ue.autoReset=e,we.enabled=t,we.autoUpdate=i,we.needsUpdate=n,we.type=s}function ze(e){console.error("THREE.WebGLRenderer: A WebGL context could not be created. Reason: ",e.statusMessage)}function Le(e){const t=e.target;t.removeEventListener("dispose",Le),function(e){(function(e){const t=Ie.get(e).programs;void 0!==t&&(t.forEach((function(e){ye.releaseProgram(e)})),e.isShaderMaterial&&ye.releaseShaderCache(e))})(e),Ie.remove(e)}(t)}function De(e,t,i){!0===e.transparent&&2===e.side&&!1===e.forceSinglePass?(e.side=c,e.needsUpdate=!0,$e(e,t,i),e.side=g,e.needsUpdate=!0,$e(e,t,i),e.side=2):$e(e,t,i)}this.xr=Fe,this.getContext=function(){return We},this.getContextAttributes=function(){return We.getContextAttributes()},this.forceContextLoss=function(){const e=ce.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){const e=ce.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return X},this.setPixelRatio=function(e){void 0!==e&&(X=e,this.setSize(W,E,!1))},this.getSize=function(e){return e.set(W,E)},this.setSize=function(e,i,n=!0){Fe.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(W=e,E=i,t.width=Math.floor(e*X),t.height=Math.floor(i*X),!0===n&&(t.style.width=e+"px",t.style.height=i+"px"),this.setViewport(0,0,e,i))},this.getDrawingBufferSize=function(e){return e.set(W*X,E*X).floor()},this.setDrawingBufferSize=function(e,i,n){W=e,E=i,X=n,t.width=Math.floor(e*n),t.height=Math.floor(i*n),this.setViewport(0,0,e,i)},this.getCurrentViewport=function(e){return e.copy(M)},this.getViewport=function(e){return e.copy(Q)},this.setViewport=function(e,t,i,n){e.isVector4?Q.set(e.x,e.y,e.z,e.w):Q.set(e,t,i,n),he.viewport(M.copy(Q).multiplyScalar(X).floor())},this.getScissor=function(e){return e.copy(J)},this.setScissor=function(e,t,i,n){e.isVector4?J.set(e.x,e.y,e.z,e.w):J.set(e,t,i,n),he.scissor(R.copy(J).multiplyScalar(X).floor())},this.getScissorTest=function(){return j},this.setScissorTest=function(e){he.setScissorTest(j=e)},this.setOpaqueSort=function(e){H=e},this.setTransparentSort=function(e){L=e},this.getClearColor=function(e){return e.copy(Se.getClearColor())},this.setClearColor=function(){Se.setClearColor.apply(Se,arguments)},this.getClearAlpha=function(){return Se.getClearAlpha()},this.setClearAlpha=function(){Se.setClearAlpha.apply(Se,arguments)},this.clear=function(e=!0,t=!0,i=!0){let n=0;if(e){let e=!1;if(null!==w){const t=w.texture.format;e=t===ie||t===te||t===$}if(e){const e=w.texture.type,t=e===F||e===D||e===z||e===O||e===P||e===k,i=Se.getClearColor(),n=Se.getClearAlpha(),s=i.r,o=i.g,r=i.b;t?(p[0]=s,p[1]=o,p[2]=r,p[3]=n,We.clearBufferuiv(We.COLOR,0,p)):(m[0]=s,m[1]=o,m[2]=r,m[3]=n,We.clearBufferiv(We.COLOR,0,m))}else n|=We.COLOR_BUFFER_BIT}t&&(n|=We.DEPTH_BUFFER_BIT),i&&(n|=We.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(4294967295)),We.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){t.removeEventListener("webglcontextlost",Xe,!1),t.removeEventListener("webglcontextrestored",He,!1),t.removeEventListener("webglcontextcreationerror",ze,!1),ve.dispose(),xe.dispose(),Ie.dispose(),me.dispose(),Ae.dispose(),be.dispose(),Ze.dispose(),Ve.dispose(),ye.dispose(),Fe.dispose(),Fe.removeEventListener("sessionstart",ke),Fe.removeEventListener("sessionend",Oe),se&&(se.dispose(),se=null),Ue.stop()},this.renderBufferDirect=function(e,t,i,n,s,o){null===t&&(t=le);const r=s.isMesh&&s.matrixWorld.determinant()<0,a=function(e,t,i,n,s){!0!==t.isScene&&(t=le);pe.resetTextureUnits();const o=t.fog,r=n.isMeshStandardMaterial?t.environment:null,a=null===w?_.outputColorSpace:!0===w.isXRRenderTarget?w.texture.colorSpace:Pe,l=(n.isMeshStandardMaterial?Ae:me).get(n.envMap||r),g=!0===n.vertexColors&&!!i.attributes.color&&4===i.attributes.color.itemSize,c=!!i.attributes.tangent&&(!!n.normalMap||n.anisotropy>0),d=!!i.morphAttributes.position,h=!!i.morphAttributes.normal,u=!!i.morphAttributes.color;let I=A;n.toneMapped&&(null!==w&&!0!==w.isXRRenderTarget||(I=_.toneMapping));const p=i.morphAttributes.position||i.morphAttributes.normal||i.morphAttributes.color,m=void 0!==p?p.length:0,C=Ie.get(n),b=f.state.lights;if(!0===ee&&(!0===ne||e!==G)){const t=e===G&&n.id===S;Be.setState(n,e,t)}let y=!1;n.version===C.__version?C.needsLights&&C.lightsStateVersion!==b.state.version||C.outputColorSpace!==a||s.isInstancedMesh&&!1===C.instancing?y=!0:s.isInstancedMesh||!0!==C.instancing?s.isSkinnedMesh&&!1===C.skinning?y=!0:s.isSkinnedMesh||!0!==C.skinning?s.isInstancedMesh&&!0===C.instancingColor&&null===s.instanceColor||s.isInstancedMesh&&!1===C.instancingColor&&null!==s.instanceColor||C.envMap!==l||!0===n.fog&&C.fog!==o?y=!0:void 0===C.numClippingPlanes||C.numClippingPlanes===Be.numPlanes&&C.numIntersection===Be.numIntersection?(C.vertexAlphas!==g||C.vertexTangents!==c||C.morphTargets!==d||C.morphNormals!==h||C.morphColors!==u||C.toneMapping!==I||!0===de.isWebGL2&&C.morphTargetsCount!==m)&&(y=!0):y=!0:y=!0:y=!0:(y=!0,C.__version=n.version);let v=C.currentProgram;!0===y&&(v=$e(n,t,s));let x=!1,B=!1,M=!1;const R=v.getUniforms(),T=C.uniforms;he.useProgram(v.program)&&(x=!0,B=!0,M=!0);n.id!==S&&(S=n.id,B=!0);if(x||G!==e){R.setValue(We,"projectionMatrix",e.projectionMatrix),R.setValue(We,"viewMatrix",e.matrixWorldInverse);const t=R.map.cameraPosition;void 0!==t&&t.setValue(We,ae.setFromMatrixPosition(e.matrixWorld)),de.logarithmicDepthBuffer&&R.setValue(We,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),(n.isMeshPhongMaterial||n.isMeshToonMaterial||n.isMeshLambertMaterial||n.isMeshBasicMaterial||n.isMeshStandardMaterial||n.isShaderMaterial)&&R.setValue(We,"isOrthographic",!0===e.isOrthographicCamera),G!==e&&(G=e,B=!0,M=!0)}if(s.isSkinnedMesh){R.setOptional(We,s,"bindMatrix"),R.setOptional(We,s,"bindMatrixInverse");const e=s.skeleton;e&&(de.floatVertexTextures?(null===e.boneTexture&&e.computeBoneTexture(),R.setValue(We,"boneTexture",e.boneTexture,pe),R.setValue(We,"boneTextureSize",e.boneTextureSize)):console.warn("THREE.WebGLRenderer: SkinnedMesh can only be used with WebGL 2. With WebGL 1 OES_texture_float and vertex textures support is required."))}const Z=i.morphAttributes;(void 0!==Z.position||void 0!==Z.normal||void 0!==Z.color&&!0===de.isWebGL2)&&Ge.update(s,i,v);(B||C.receiveShadow!==s.receiveShadow)&&(C.receiveShadow=s.receiveShadow,R.setValue(We,"receiveShadow",s.receiveShadow));n.isMeshGouraudMaterial&&null!==n.envMap&&(T.envMap.value=l,T.flipEnvMap.value=l.isCubeTexture&&!1===l.isRenderTargetTexture?-1:1);B&&(R.setValue(We,"toneMappingExposure",_.toneMappingExposure),C.needsLights&&(W=M,(V=T).ambientLightColor.needsUpdate=W,V.lightProbe.needsUpdate=W,V.directionalLights.needsUpdate=W,V.directionalLightShadows.needsUpdate=W,V.pointLights.needsUpdate=W,V.pointLightShadows.needsUpdate=W,V.spotLights.needsUpdate=W,V.spotLightShadows.needsUpdate=W,V.rectAreaLights.needsUpdate=W,V.hemisphereLights.needsUpdate=W),o&&!0===n.fog&&_e.refreshFogUniforms(T,o),_e.refreshMaterialUniforms(T,n,X,E,se),dr.upload(We,et(C),T,pe));var V,W;n.isShaderMaterial&&!0===n.uniformsNeedUpdate&&(dr.upload(We,et(C),T,pe),n.uniformsNeedUpdate=!1);n.isSpriteMaterial&&R.setValue(We,"center",s.center);if(R.setValue(We,"modelViewMatrix",s.modelViewMatrix),R.setValue(We,"normalMatrix",s.normalMatrix),R.setValue(We,"modelMatrix",s.matrixWorld),n.isShaderMaterial||n.isRawShaderMaterial){const e=n.uniformsGroups;for(let t=0,i=e.length;t<i;t++)if(de.isWebGL2){const i=e[t];Ve.update(i,v),Ve.bind(i,v)}else console.warn("THREE.WebGLRenderer: Uniform Buffer Objects can only be used with WebGL 2.")}return v}(e,t,i,n,s);he.setMaterial(n,r);let l=i.index,g=1;if(!0===n.wireframe){if(l=fe.getWireframeAttribute(i),void 0===l)return;g=2}const c=i.drawRange,d=i.attributes.position;let h=c.start*g,u=(c.start+c.count)*g;null!==o&&(h=Math.max(h,o.start*g),u=Math.min(u,(o.start+o.count)*g)),null!==l?(h=Math.max(h,0),u=Math.min(u,l.count)):null!=d&&(h=Math.max(h,0),u=Math.min(u,d.count));const I=u-h;if(I<0||I===1/0)return;let p;Ze.setup(s,n,a,i,l);let m=Me;if(null!==l&&(p=Ce.get(l),m=Re,m.setIndex(p)),s.isMesh)!0===n.wireframe?(he.setLineWidth(n.wireframeLinewidth*ge()),m.setMode(We.LINES)):m.setMode(We.TRIANGLES);else if(s.isLine){let e=n.linewidth;void 0===e&&(e=1),he.setLineWidth(e*ge()),s.isLineSegments?m.setMode(We.LINES):s.isLineLoop?m.setMode(We.LINE_LOOP):m.setMode(We.LINE_STRIP)}else s.isPoints?m.setMode(We.POINTS):s.isSprite&&m.setMode(We.TRIANGLES);if(s.isInstancedMesh)m.renderInstances(h,I,s.count);else if(i.isInstancedBufferGeometry){const e=void 0!==i._maxInstanceCount?i._maxInstanceCount:1/0,t=Math.min(i.instanceCount,e);m.renderInstances(h,I,t)}else m.render(h,I)},this.compile=function(e,t,i=null){null===i&&(i=e),f=xe.get(i),f.init(),y.push(f),i.traverseVisible((function(e){e.isLight&&e.layers.test(t.layers)&&(f.pushLight(e),e.castShadow&&f.pushShadow(e))})),e!==i&&e.traverseVisible((function(e){e.isLight&&e.layers.test(t.layers)&&(f.pushLight(e),e.castShadow&&f.pushShadow(e))})),f.setupLights(_._useLegacyLights);const n=new Set;return e.traverse((function(e){const t=e.material;if(t)if(Array.isArray(t))for(let s=0;s<t.length;s++){const o=t[s];De(o,i,e),n.add(o)}else De(t,i,e),n.add(t)})),y.pop(),f=null,n},this.compileAsync=function(e,t,i=null){const n=this.compile(e,t,i);return new Promise((t=>{function i(){n.forEach((function(e){Ie.get(e).currentProgram.isReady()&&n.delete(e)})),0!==n.size?setTimeout(i,10):t(e)}null!==ce.get("KHR_parallel_shader_compile")?i():setTimeout(i,10)}))};let Ke=null;function ke(){Ue.stop()}function Oe(){Ue.start()}const Ue=new _s;function Qe(e,t,i,n){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)i=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)f.pushLight(e),e.castShadow&&f.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||q.intersectsSprite(e)){n&&ae.setFromMatrixPosition(e.matrixWorld).applyMatrix4(oe);const t=be.update(e),s=e.material;s.visible&&C.push(e,t,s,i,ae.z,null)}}else if((e.isMesh||e.isLine||e.isPoints)&&(!e.frustumCulled||q.intersectsObject(e))){const t=be.update(e),s=e.material;if(n&&(void 0!==e.boundingSphere?(null===e.boundingSphere&&e.computeBoundingSphere(),ae.copy(e.boundingSphere.center)):(null===t.boundingSphere&&t.computeBoundingSphere(),ae.copy(t.boundingSphere.center)),ae.applyMatrix4(e.matrixWorld).applyMatrix4(oe)),Array.isArray(s)){const n=t.groups;for(let o=0,r=n.length;o<r;o++){const r=n[o],a=s[r.materialIndex];a&&a.visible&&C.push(e,t,a,i,ae.z,r)}}else s.visible&&C.push(e,t,s,i,ae.z,null)}const s=e.children;for(let o=0,r=s.length;o<r;o++)Qe(s[o],t,i,n)}function Je(e,t,i,n){const s=e.opaque,o=e.transmissive,r=e.transparent;f.setupLightsView(i),!0===ee&&Be.setGlobalState(_.clippingPlanes,i),o.length>0&&function(e,t,i,n){const s=!0===i.isScene?i.overrideMaterial:null;if(null!==s)return;const o=de.isWebGL2;null===se&&(se=new Yt(1,1,{generateMipmaps:!0,type:ce.has("EXT_color_buffer_half_float")?Y:F,minFilter:N,samples:o?4:0}));_.getDrawingBufferSize(re),o?se.setSize(re.x,re.y):se.setSize(mt(re.x),mt(re.y));const r=_.getRenderTarget();_.setRenderTarget(se),_.getClearColor(Z),V=_.getClearAlpha(),V<1&&_.setClearColor(16777215,.5);_.clear();const a=_.toneMapping;_.toneMapping=A,je(e,i,n),pe.updateMultisampleRenderTarget(se),pe.updateRenderTargetMipmap(se);let l=!1;for(let g=0,d=t.length;g<d;g++){const e=t[g],s=e.object,o=e.geometry,r=e.material,a=e.group;if(2===r.side&&s.layers.test(n.layers)){const e=r.side;r.side=c,r.needsUpdate=!0,qe(s,i,n,o,r,a),r.side=e,r.needsUpdate=!0,l=!0}}!0===l&&(pe.updateMultisampleRenderTarget(se),pe.updateRenderTargetMipmap(se));_.setRenderTarget(r),_.setClearColor(Z,V),_.toneMapping=a}(s,o,t,i),n&&he.viewport(M.copy(n)),s.length>0&&je(s,t,i),o.length>0&&je(o,t,i),r.length>0&&je(r,t,i),he.buffers.depth.setTest(!0),he.buffers.depth.setMask(!0),he.buffers.color.setMask(!0),he.setPolygonOffset(!1)}function je(e,t,i){const n=!0===t.isScene?t.overrideMaterial:null;for(let s=0,o=e.length;s<o;s++){const o=e[s],r=o.object,a=o.geometry,l=null===n?o.material:n,g=o.group;r.layers.test(i.layers)&&qe(r,t,i,a,l,g)}}function qe(e,t,i,n,s,o){e.onBeforeRender(_,t,i,n,s,o),e.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),s.onBeforeRender(_,t,i,n,e,o),!0===s.transparent&&2===s.side&&!1===s.forceSinglePass?(s.side=c,s.needsUpdate=!0,_.renderBufferDirect(i,t,n,s,e,o),s.side=g,s.needsUpdate=!0,_.renderBufferDirect(i,t,n,s,e,o),s.side=2):_.renderBufferDirect(i,t,n,s,e,o),e.onAfterRender(_,t,i,n,s,o)}function $e(e,t,i){!0!==t.isScene&&(t=le);const n=Ie.get(e),s=f.state.lights,o=f.state.shadowsArray,r=s.state.version,a=ye.getParameters(e,s.state,o,t,i),l=ye.getProgramCacheKey(a);let g=n.programs;n.environment=e.isMeshStandardMaterial?t.environment:null,n.fog=t.fog,n.envMap=(e.isMeshStandardMaterial?Ae:me).get(e.envMap||n.environment),void 0===g&&(e.addEventListener("dispose",Le),g=new Map,n.programs=g);let c=g.get(l);if(void 0!==c){if(n.currentProgram===c&&n.lightsStateVersion===r)return tt(e,a),c}else a.uniforms=ye.getUniforms(e),e.onBuild(i,a,_),e.onBeforeCompile(a,_),c=ye.acquireProgram(a,l),g.set(l,c),n.uniforms=a.uniforms;const d=n.uniforms;return(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(d.clippingPlanes=Be.uniform),tt(e,a),n.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),n.lightsStateVersion=r,n.needsLights&&(d.ambientLightColor.value=s.state.ambient,d.lightProbe.value=s.state.probe,d.directionalLights.value=s.state.directional,d.directionalLightShadows.value=s.state.directionalShadow,d.spotLights.value=s.state.spot,d.spotLightShadows.value=s.state.spotShadow,d.rectAreaLights.value=s.state.rectArea,d.ltc_1.value=s.state.rectAreaLTC1,d.ltc_2.value=s.state.rectAreaLTC2,d.pointLights.value=s.state.point,d.pointLightShadows.value=s.state.pointShadow,d.hemisphereLights.value=s.state.hemi,d.directionalShadowMap.value=s.state.directionalShadowMap,d.directionalShadowMatrix.value=s.state.directionalShadowMatrix,d.spotShadowMap.value=s.state.spotShadowMap,d.spotLightMatrix.value=s.state.spotLightMatrix,d.spotLightMap.value=s.state.spotLightMap,d.pointShadowMap.value=s.state.pointShadowMap,d.pointShadowMatrix.value=s.state.pointShadowMatrix),n.currentProgram=c,n.uniformsList=null,c}function et(e){if(null===e.uniformsList){const t=e.currentProgram.getUniforms();e.uniformsList=dr.seqWithValue(t.seq,e.uniforms)}return e.uniformsList}function tt(e,t){const i=Ie.get(e);i.outputColorSpace=t.outputColorSpace,i.instancing=t.instancing,i.instancingColor=t.instancingColor,i.skinning=t.skinning,i.morphTargets=t.morphTargets,i.morphNormals=t.morphNormals,i.morphColors=t.morphColors,i.morphTargetsCount=t.morphTargetsCount,i.numClippingPlanes=t.numClippingPlanes,i.numIntersection=t.numClipIntersection,i.vertexAlphas=t.vertexAlphas,i.vertexTangents=t.vertexTangents,i.toneMapping=t.toneMapping}Ue.setAnimationLoop((function(e){Ke&&Ke(e)})),"undefined"!=typeof self&&Ue.setContext(self),this.setAnimationLoop=function(e){Ke=e,Fe.setAnimationLoop(e),null===e?Ue.stop():Ue.start()},Fe.addEventListener("sessionstart",ke),Fe.addEventListener("sessionend",Oe),this.render=function(e,t){if(void 0!==t&&!0!==t.isCamera)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===v)return;!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===t.parent&&!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),!0===Fe.enabled&&!0===Fe.isPresenting&&(!0===Fe.cameraAutoUpdate&&Fe.updateCamera(t),t=Fe.getCamera()),!0===e.isScene&&e.onBeforeRender(_,e,t,w),f=xe.get(e,y.length),f.init(),y.push(f),oe.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),q.setFromProjectionMatrix(oe),ne=this.localClippingEnabled,ee=Be.init(this.clippingPlanes,ne),C=ve.get(e,b.length),C.init(),b.push(C),Qe(e,t,0,_.sortObjects),C.finish(),!0===_.sortObjects&&C.sort(H,L),this.info.render.frame++,!0===ee&&Be.beginShadows();const i=f.state.shadowsArray;if(we.render(i,e,t),!0===ee&&Be.endShadows(),!0===this.info.autoReset&&this.info.reset(),Se.render(C,e),f.setupLights(_._useLegacyLights),t.isArrayCamera){const i=t.cameras;for(let t=0,n=i.length;t<n;t++){const n=i[t];Je(C,e,n,n.viewport)}}else Je(C,e,t);null!==w&&(pe.updateMultisampleRenderTarget(w),pe.updateRenderTargetMipmap(w)),!0===e.isScene&&e.onAfterRender(_,e,t),Ze.resetDefaultState(),S=-1,G=null,y.pop(),f=y.length>0?y[y.length-1]:null,b.pop(),C=b.length>0?b[b.length-1]:null},this.getActiveCubeFace=function(){return x},this.getActiveMipmapLevel=function(){return B},this.getRenderTarget=function(){return w},this.setRenderTargetTextures=function(e,t,i){Ie.get(e.texture).__webglTexture=t,Ie.get(e.depthTexture).__webglTexture=i;const n=Ie.get(e);n.__hasExternalTextures=!0,n.__hasExternalTextures&&(n.__autoAllocateDepthBuffer=void 0===i,n.__autoAllocateDepthBuffer||!0===ce.has("WEBGL_multisampled_render_to_texture")&&(console.warn("THREE.WebGLRenderer: Render-to-texture extension was disabled because an external texture was provided"),n.__useRenderToTexture=!1))},this.setRenderTargetFramebuffer=function(e,t){const i=Ie.get(e);i.__webglFramebuffer=t,i.__useDefaultFramebuffer=void 0===t},this.setRenderTarget=function(e,t=0,i=0){w=e,x=t,B=i;let n=!0,s=null,o=!1,r=!1;if(e){const a=Ie.get(e);void 0!==a.__useDefaultFramebuffer?(he.bindFramebuffer(We.FRAMEBUFFER,null),n=!1):void 0===a.__webglFramebuffer?pe.setupRenderTarget(e):a.__hasExternalTextures&&pe.rebindTextures(e,Ie.get(e.texture).__webglTexture,Ie.get(e.depthTexture).__webglTexture);const l=e.texture;(l.isData3DTexture||l.isDataArrayTexture||l.isCompressedArrayTexture)&&(r=!0);const g=Ie.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(s=Array.isArray(g[t])?g[t][i]:g[t],o=!0):s=de.isWebGL2&&e.samples>0&&!1===pe.useMultisampledRTT(e)?Ie.get(e).__webglMultisampledFramebuffer:Array.isArray(g)?g[i]:g,M.copy(e.viewport),R.copy(e.scissor),T=e.scissorTest}else M.copy(Q).multiplyScalar(X).floor(),R.copy(J).multiplyScalar(X).floor(),T=j;if(he.bindFramebuffer(We.FRAMEBUFFER,s)&&de.drawBuffers&&n&&he.drawBuffers(e,s),he.viewport(M),he.scissor(R),he.setScissorTest(T),o){const n=Ie.get(e.texture);We.framebufferTexture2D(We.FRAMEBUFFER,We.COLOR_ATTACHMENT0,We.TEXTURE_CUBE_MAP_POSITIVE_X+t,n.__webglTexture,i)}else if(r){const n=Ie.get(e.texture),s=t||0;We.framebufferTextureLayer(We.FRAMEBUFFER,We.COLOR_ATTACHMENT0,n.__webglTexture,i||0,s)}S=-1},this.readRenderTargetPixels=function(e,t,i,n,s,o,r){if(!e||!e.isWebGLRenderTarget)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let a=Ie.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==r&&(a=a[r]),a){he.bindFramebuffer(We.FRAMEBUFFER,a);try{const r=e.texture,a=r.format,l=r.type;if(a!==U&&Te.convert(a)!==We.getParameter(We.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");const g=l===Y&&(ce.has("EXT_color_buffer_half_float")||de.isWebGL2&&ce.has("EXT_color_buffer_float"));if(!(l===F||Te.convert(l)===We.getParameter(We.IMPLEMENTATION_COLOR_READ_TYPE)||l===K&&(de.isWebGL2||ce.has("OES_texture_float")||ce.has("WEBGL_color_buffer_float"))||g))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");t>=0&&t<=e.width-n&&i>=0&&i<=e.height-s&&We.readPixels(t,i,n,s,Te.convert(a),Te.convert(l),o)}finally{const e=null!==w?Ie.get(w).__webglFramebuffer:null;he.bindFramebuffer(We.FRAMEBUFFER,e)}}},this.copyFramebufferToTexture=function(e,t,i=0){const n=Math.pow(2,-i),s=Math.floor(t.image.width*n),o=Math.floor(t.image.height*n);pe.setTexture2D(t,0),We.copyTexSubImage2D(We.TEXTURE_2D,i,0,0,e.x,e.y,s,o),he.unbindTexture()},this.copyTextureToTexture=function(e,t,i,n=0){const s=t.image.width,o=t.image.height,r=Te.convert(i.format),a=Te.convert(i.type);pe.setTexture2D(i,0),We.pixelStorei(We.UNPACK_FLIP_Y_WEBGL,i.flipY),We.pixelStorei(We.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i.premultiplyAlpha),We.pixelStorei(We.UNPACK_ALIGNMENT,i.unpackAlignment),t.isDataTexture?We.texSubImage2D(We.TEXTURE_2D,n,e.x,e.y,s,o,r,a,t.image.data):t.isCompressedTexture?We.compressedTexSubImage2D(We.TEXTURE_2D,n,e.x,e.y,t.mipmaps[0].width,t.mipmaps[0].height,r,t.mipmaps[0].data):We.texSubImage2D(We.TEXTURE_2D,n,e.x,e.y,r,a,t.image),0===n&&i.generateMipmaps&&We.generateMipmap(We.TEXTURE_2D),he.unbindTexture()},this.copyTextureToTexture3D=function(e,t,i,n,s=0){if(_.isWebGL1Renderer)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: can only be used with WebGL2.");const o=e.max.x-e.min.x+1,r=e.max.y-e.min.y+1,a=e.max.z-e.min.z+1,l=Te.convert(n.format),g=Te.convert(n.type);let c;if(n.isData3DTexture)pe.setTexture3D(n,0),c=We.TEXTURE_3D;else{if(!n.isDataArrayTexture)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: only supports THREE.DataTexture3D and THREE.DataTexture2DArray.");pe.setTexture2DArray(n,0),c=We.TEXTURE_2D_ARRAY}We.pixelStorei(We.UNPACK_FLIP_Y_WEBGL,n.flipY),We.pixelStorei(We.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.premultiplyAlpha),We.pixelStorei(We.UNPACK_ALIGNMENT,n.unpackAlignment);const d=We.getParameter(We.UNPACK_ROW_LENGTH),h=We.getParameter(We.UNPACK_IMAGE_HEIGHT),u=We.getParameter(We.UNPACK_SKIP_PIXELS),I=We.getParameter(We.UNPACK_SKIP_ROWS),p=We.getParameter(We.UNPACK_SKIP_IMAGES),m=i.isCompressedTexture?i.mipmaps[0]:i.image;We.pixelStorei(We.UNPACK_ROW_LENGTH,m.width),We.pixelStorei(We.UNPACK_IMAGE_HEIGHT,m.height),We.pixelStorei(We.UNPACK_SKIP_PIXELS,e.min.x),We.pixelStorei(We.UNPACK_SKIP_ROWS,e.min.y),We.pixelStorei(We.UNPACK_SKIP_IMAGES,e.min.z),i.isDataTexture||i.isData3DTexture?We.texSubImage3D(c,s,t.x,t.y,t.z,o,r,a,l,g,m.data):i.isCompressedArrayTexture?(console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: untested support for compressed srcTexture."),We.compressedTexSubImage3D(c,s,t.x,t.y,t.z,o,r,a,l,m.data)):We.texSubImage3D(c,s,t.x,t.y,t.z,o,r,a,l,g,m),We.pixelStorei(We.UNPACK_ROW_LENGTH,d),We.pixelStorei(We.UNPACK_IMAGE_HEIGHT,h),We.pixelStorei(We.UNPACK_SKIP_PIXELS,u),We.pixelStorei(We.UNPACK_SKIP_ROWS,I),We.pixelStorei(We.UNPACK_SKIP_IMAGES,p),0===s&&n.generateMipmaps&&We.generateMipmap(c),he.unbindTexture()},this.initTexture=function(e){e.isCubeTexture?pe.setTextureCube(e,0):e.isData3DTexture?pe.setTexture3D(e,0):e.isDataArrayTexture||e.isCompressedArrayTexture?pe.setTexture2DArray(e,0):pe.setTexture2D(e,0),he.unbindTexture()},this.resetState=function(){x=0,B=0,w=null,he.reset(),Ze.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return nt}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e;const t=this.getContext();t.drawingBufferColorSpace=e===ke?"display-p3":"srgb",t.unpackColorSpace=Zt.workingColorSpace===Oe?"display-p3":"srgb"}get physicallyCorrectLights(){return console.warn("THREE.WebGLRenderer: The property .physicallyCorrectLights has been removed. Set renderer.useLegacyLights instead."),!this.useLegacyLights}set physicallyCorrectLights(e){console.warn("THREE.WebGLRenderer: The property .physicallyCorrectLights has been removed. Set renderer.useLegacyLights instead."),this.useLegacyLights=!e}get outputEncoding(){return console.warn("THREE.WebGLRenderer: Property .outputEncoding has been removed. Use .outputColorSpace instead."),this.outputColorSpace===Ye?De:Le}set outputEncoding(e){console.warn("THREE.WebGLRenderer: Property .outputEncoding has been removed. Use .outputColorSpace instead."),this.outputColorSpace=e===De?Ye:Pe}get useLegacyLights(){return console.warn("THREE.WebGLRenderer: The property .useLegacyLights has been deprecated. Migrate your lighting according to the following guide: https://discourse.threejs.org/t/updates-to-lighting-in-three-js-r155/53733."),this._useLegacyLights}set useLegacyLights(e){console.warn("THREE.WebGLRenderer: The property .useLegacyLights has been deprecated. Migrate your lighting according to the following guide: https://discourse.threejs.org/t/updates-to-lighting-in-three-js-r155/53733."),this._useLegacyLights=e}}(class extends oa{}).prototype.isWebGL1Renderer=!0;class ra extends Ji{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return null!==this.fog&&(t.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(t.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(t.object.backgroundIntensity=this.backgroundIntensity),t}}class aa{constructor(e,t){this.isInterleavedBuffer=!0,this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.usage=$e,this.updateRange={offset:0,count:-1},this.version=0,this.uuid=ct()}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}copy(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.usage=e.usage,this}copyAt(e,t,i){e*=this.stride,i*=t.stride;for(let n=0,s=this.stride;n<s;n++)this.array[e+n]=t.array[i+n];return this}set(e,t=0){return this.array.set(e,t),this}clone(e){void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=ct()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const t=new this.array.constructor(e.arrayBuffers[this.array.buffer._uuid]),i=new this.constructor(t,this.stride);return i.setUsage(this.usage),i}onUpload(e){return this.onUploadCallback=e,this}toJSON(e){return void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=ct()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}const la=new Qt;class ga{constructor(e,t,i,n=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=e,this.itemSize=t,this.offset=i,this.normalized=n}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(e){this.data.needsUpdate=e}applyMatrix4(e){for(let t=0,i=this.data.count;t<i;t++)la.fromBufferAttribute(this,t),la.applyMatrix4(e),this.setXYZ(t,la.x,la.y,la.z);return this}applyNormalMatrix(e){for(let t=0,i=this.count;t<i;t++)la.fromBufferAttribute(this,t),la.applyNormalMatrix(e),this.setXYZ(t,la.x,la.y,la.z);return this}transformDirection(e){for(let t=0,i=this.count;t<i;t++)la.fromBufferAttribute(this,t),la.transformDirection(e),this.setXYZ(t,la.x,la.y,la.z);return this}setX(e,t){return this.normalized&&(t=Ct(t,this.array)),this.data.array[e*this.data.stride+this.offset]=t,this}setY(e,t){return this.normalized&&(t=Ct(t,this.array)),this.data.array[e*this.data.stride+this.offset+1]=t,this}setZ(e,t){return this.normalized&&(t=Ct(t,this.array)),this.data.array[e*this.data.stride+this.offset+2]=t,this}setW(e,t){return this.normalized&&(t=Ct(t,this.array)),this.data.array[e*this.data.stride+this.offset+3]=t,this}getX(e){let t=this.data.array[e*this.data.stride+this.offset];return this.normalized&&(t=At(t,this.array)),t}getY(e){let t=this.data.array[e*this.data.stride+this.offset+1];return this.normalized&&(t=At(t,this.array)),t}getZ(e){let t=this.data.array[e*this.data.stride+this.offset+2];return this.normalized&&(t=At(t,this.array)),t}getW(e){let t=this.data.array[e*this.data.stride+this.offset+3];return this.normalized&&(t=At(t,this.array)),t}setXY(e,t,i){return e=e*this.data.stride+this.offset,this.normalized&&(t=Ct(t,this.array),i=Ct(i,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=i,this}setXYZ(e,t,i,n){return e=e*this.data.stride+this.offset,this.normalized&&(t=Ct(t,this.array),i=Ct(i,this.array),n=Ct(n,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=n,this}setXYZW(e,t,i,n,s){return e=e*this.data.stride+this.offset,this.normalized&&(t=Ct(t,this.array),i=Ct(i,this.array),n=Ct(n,this.array),s=Ct(s,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=n,this.data.array[e+3]=s,this}clone(e){if(void 0===e){console.log("THREE.InterleavedBufferAttribute.clone(): Cloning an interleaved buffer attribute will de-interleave buffer data.");const e=[];for(let t=0;t<this.count;t++){const i=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[i+t])}return new Bn(new this.array.constructor(e),this.itemSize,this.normalized)}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.clone(e)),new ga(e.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(e){if(void 0===e){console.log("THREE.InterleavedBufferAttribute.toJSON(): Serializing an interleaved buffer attribute will de-interleave buffer data.");const e=[];for(let t=0;t<this.count;t++){const i=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[i+t])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:e,normalized:this.normalized}}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.toJSON(e)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}const ca=new Qt,da=new Dt,ha=new Dt,ua=new Qt,Ia=new Bi,pa=new Qt,ma=new mi,Aa=new Bi,Ca=new xi;class fa extends ts{constructor(e,t){super(e,t),this.isSkinnedMesh=!0,this.type="SkinnedMesh",this.bindMode=v,this.bindMatrix=new Bi,this.bindMatrixInverse=new Bi,this.boundingBox=null,this.boundingSphere=null}computeBoundingBox(){const e=this.geometry;null===this.boundingBox&&(this.boundingBox=new qt),this.boundingBox.makeEmpty();const t=e.getAttribute("position");for(let i=0;i<t.count;i++)this.getVertexPosition(i,pa),this.boundingBox.expandByPoint(pa)}computeBoundingSphere(){const e=this.geometry;null===this.boundingSphere&&(this.boundingSphere=new mi),this.boundingSphere.makeEmpty();const t=e.getAttribute("position");for(let i=0;i<t.count;i++)this.getVertexPosition(i,pa),this.boundingSphere.expandByPoint(pa)}copy(e,t){return super.copy(e,t),this.bindMode=e.bindMode,this.bindMatrix.copy(e.bindMatrix),this.bindMatrixInverse.copy(e.bindMatrixInverse),this.skeleton=e.skeleton,null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}raycast(e,t){const i=this.material,n=this.matrixWorld;void 0!==i&&(null===this.boundingSphere&&this.computeBoundingSphere(),ma.copy(this.boundingSphere),ma.applyMatrix4(n),!1!==e.ray.intersectsSphere(ma)&&(Aa.copy(n).invert(),Ca.copy(e.ray).applyMatrix4(Aa),null!==this.boundingBox&&!1===Ca.intersectsBox(this.boundingBox)||this._computeIntersections(e,t,Ca)))}getVertexPosition(e,t){return super.getVertexPosition(e,t),this.applyBoneTransform(e,t),t}bind(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.copy(t).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){const e=new Dt,t=this.geometry.attributes.skinWeight;for(let i=0,n=t.count;i<n;i++){e.fromBufferAttribute(t,i);const n=1/e.manhattanLength();n!==1/0?e.multiplyScalar(n):e.set(1,0,0,0),t.setXYZW(i,e.x,e.y,e.z,e.w)}}updateMatrixWorld(e){super.updateMatrixWorld(e),this.bindMode===v?this.bindMatrixInverse.copy(this.matrixWorld).invert():"detached"===this.bindMode?this.bindMatrixInverse.copy(this.bindMatrix).invert():console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}applyBoneTransform(e,t){const i=this.skeleton,n=this.geometry;da.fromBufferAttribute(n.attributes.skinIndex,e),ha.fromBufferAttribute(n.attributes.skinWeight,e),ca.copy(t).applyMatrix4(this.bindMatrix),t.set(0,0,0);for(let s=0;s<4;s++){const e=ha.getComponent(s);if(0!==e){const n=da.getComponent(s);Ia.multiplyMatrices(i.bones[n].matrixWorld,i.boneInverses[n]),t.addScaledVector(ua.copy(ca).applyMatrix4(Ia),e)}}return t.applyMatrix4(this.bindMatrixInverse)}boneTransform(e,t){return console.warn("THREE.SkinnedMesh: .boneTransform() was renamed to .applyBoneTransform() in r151."),this.applyBoneTransform(e,t)}}class ba extends Ji{constructor(){super(),this.isBone=!0,this.type="Bone"}}class ya extends Lt{constructor(e=null,t=1,i=1,n,s,o,r,a,l=1003,g=1003,c,d){super(null,o,r,a,l,g,n,s,c,d),this.isDataTexture=!0,this.image={data:e,width:t,height:i},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}const _a=new Bi,va=new Bi;class xa{constructor(e=[],t=[]){this.uuid=ct(),this.bones=e.slice(0),this.boneInverses=t,this.boneMatrices=null,this.boneTexture=null,this.boneTextureSize=0,this.init()}init(){const e=this.bones,t=this.boneInverses;if(this.boneMatrices=new Float32Array(16*e.length),0===t.length)this.calculateInverses();else if(e.length!==t.length){console.warn("THREE.Skeleton: Number of inverse bone matrices does not match amount of bones."),this.boneInverses=[];for(let e=0,t=this.bones.length;e<t;e++)this.boneInverses.push(new Bi)}}calculateInverses(){this.boneInverses.length=0;for(let e=0,t=this.bones.length;e<t;e++){const t=new Bi;this.bones[e]&&t.copy(this.bones[e].matrixWorld).invert(),this.boneInverses.push(t)}}pose(){for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&t.matrixWorld.copy(this.boneInverses[e]).invert()}for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&(t.parent&&t.parent.isBone?(t.matrix.copy(t.parent.matrixWorld).invert(),t.matrix.multiply(t.matrixWorld)):t.matrix.copy(t.matrixWorld),t.matrix.decompose(t.position,t.quaternion,t.scale))}}update(){const e=this.bones,t=this.boneInverses,i=this.boneMatrices,n=this.boneTexture;for(let s=0,o=e.length;s<o;s++){const n=e[s]?e[s].matrixWorld:va;_a.multiplyMatrices(n,t[s]),_a.toArray(i,16*s)}null!==n&&(n.needsUpdate=!0)}clone(){return new xa(this.bones,this.boneInverses)}computeBoneTexture(){let e=Math.sqrt(4*this.bones.length);e=pt(e),e=Math.max(e,4);const t=new Float32Array(e*e*4);t.set(this.boneMatrices);const i=new ya(t,e,e,U,K);return i.needsUpdate=!0,this.boneMatrices=t,this.boneTexture=i,this.boneTextureSize=e,this}getBoneByName(e){for(let t=0,i=this.bones.length;t<i;t++){const i=this.bones[t];if(i.name===e)return i}}dispose(){null!==this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=null)}fromJSON(e,t){this.uuid=e.uuid;for(let i=0,n=e.bones.length;i<n;i++){const n=e.bones[i];let s=t[n];void 0===s&&(console.warn("THREE.Skeleton: No bone found with UUID:",n),s=new ba),this.bones.push(s),this.boneInverses.push((new Bi).fromArray(e.boneInverses[i]))}return this.init(),this}toJSON(){const e={metadata:{version:4.6,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};e.uuid=this.uuid;const t=this.bones,i=this.boneInverses;for(let n=0,s=t.length;n<s;n++){const s=t[n];e.bones.push(s.uuid);const o=i[n];e.boneInverses.push(o.toArray())}return e}}class Ba extends Bn{constructor(e,t,i,n=1){super(e,t,i),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=n}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}toJSON(){const e=super.toJSON();return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}}const wa=new Bi,Sa=new Bi,Ga=[],Ma=new qt,Ra=new Bi,Ta=new ts,Za=new mi;class Va extends ts{constructor(e,t,i){super(e,t),this.isInstancedMesh=!0,this.instanceMatrix=new Ba(new Float32Array(16*i),16),this.instanceColor=null,this.count=i,this.boundingBox=null,this.boundingSphere=null;for(let n=0;n<i;n++)this.setMatrixAt(n,Ra)}computeBoundingBox(){const e=this.geometry,t=this.count;null===this.boundingBox&&(this.boundingBox=new qt),null===e.boundingBox&&e.computeBoundingBox(),this.boundingBox.makeEmpty();for(let i=0;i<t;i++)this.getMatrixAt(i,wa),Ma.copy(e.boundingBox).applyMatrix4(wa),this.boundingBox.union(Ma)}computeBoundingSphere(){const e=this.geometry,t=this.count;null===this.boundingSphere&&(this.boundingSphere=new mi),null===e.boundingSphere&&e.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let i=0;i<t;i++)this.getMatrixAt(i,wa),Za.copy(e.boundingSphere).applyMatrix4(wa),this.boundingSphere.union(Za)}copy(e,t){return super.copy(e,t),this.instanceMatrix.copy(e.instanceMatrix),null!==e.instanceColor&&(this.instanceColor=e.instanceColor.clone()),this.count=e.count,null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}getColorAt(e,t){t.fromArray(this.instanceColor.array,3*e)}getMatrixAt(e,t){t.fromArray(this.instanceMatrix.array,16*e)}raycast(e,t){const i=this.matrixWorld,n=this.count;if(Ta.geometry=this.geometry,Ta.material=this.material,void 0!==Ta.material&&(null===this.boundingSphere&&this.computeBoundingSphere(),Za.copy(this.boundingSphere),Za.applyMatrix4(i),!1!==e.ray.intersectsSphere(Za)))for(let s=0;s<n;s++){this.getMatrixAt(s,wa),Sa.multiplyMatrices(i,wa),Ta.matrixWorld=Sa,Ta.raycast(e,Ga);for(let e=0,i=Ga.length;e<i;e++){const i=Ga[e];i.instanceId=s,i.object=this,t.push(i)}Ga.length=0}}setColorAt(e,t){null===this.instanceColor&&(this.instanceColor=new Ba(new Float32Array(3*this.instanceMatrix.count),3)),t.toArray(this.instanceColor.array,3*e)}setMatrixAt(e,t){t.toArray(this.instanceMatrix.array,16*e)}updateMorphTargets(){}dispose(){this.dispatchEvent({type:"dispose"})}}class Wa extends An{constructor(e){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new In(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.fog=e.fog,this}}const Ea=new Qt,Na=new Qt,Fa=new Bi,Xa=new xi,Ha=new mi;class za extends Ji{constructor(e=new Fn,t=new Wa){super(),this.isLine=!0,this.type="Line",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,i=[0];for(let e=1,n=t.count;e<n;e++)Ea.fromBufferAttribute(t,e-1),Na.fromBufferAttribute(t,e),i[e]=i[e-1],i[e]+=Ea.distanceTo(Na);e.setAttribute("lineDistance",new Mn(i,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(e,t){const i=this.geometry,n=this.matrixWorld,s=e.params.Line.threshold,o=i.drawRange;if(null===i.boundingSphere&&i.computeBoundingSphere(),Ha.copy(i.boundingSphere),Ha.applyMatrix4(n),Ha.radius+=s,!1===e.ray.intersectsSphere(Ha))return;Fa.copy(n).invert(),Xa.copy(e.ray).applyMatrix4(Fa);const r=s/((this.scale.x+this.scale.y+this.scale.z)/3),a=r*r,l=new Qt,g=new Qt,c=new Qt,d=new Qt,h=this.isLineSegments?2:1,u=i.index,I=i.attributes.position;if(null!==u){for(let i=Math.max(0,o.start),n=Math.min(u.count,o.start+o.count)-1;i<n;i+=h){const n=u.getX(i),s=u.getX(i+1);l.fromBufferAttribute(I,n),g.fromBufferAttribute(I,s);if(Xa.distanceSqToSegment(l,g,d,c)>a)continue;d.applyMatrix4(this.matrixWorld);const o=e.ray.origin.distanceTo(d);o<e.near||o>e.far||t.push({distance:o,point:c.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}else{for(let i=Math.max(0,o.start),n=Math.min(I.count,o.start+o.count)-1;i<n;i+=h){l.fromBufferAttribute(I,i),g.fromBufferAttribute(I,i+1);if(Xa.distanceSqToSegment(l,g,d,c)>a)continue;d.applyMatrix4(this.matrixWorld);const n=e.ray.origin.distanceTo(d);n<e.near||n>e.far||t.push({distance:n,point:c.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const i=e[t[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=i.length;e<t;e++){const t=i[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}}const La=new Qt,Da=new Qt;class Ka extends za{constructor(e,t){super(e,t),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,i=[];for(let e=0,n=t.count;e<n;e+=2)La.fromBufferAttribute(t,e),Da.fromBufferAttribute(t,e+1),i[e]=0===e?0:i[e-1],i[e+1]=i[e]+La.distanceTo(Da);e.setAttribute("lineDistance",new Mn(i,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}class Ya extends za{constructor(e,t){super(e,t),this.isLineLoop=!0,this.type="LineLoop"}}class Pa extends An{constructor(e){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new In(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}const ka=new Bi,Oa=new xi,Ua=new mi,Qa=new Qt;class Ja extends Ji{constructor(e=new Fn,t=new Pa){super(),this.isPoints=!0,this.type="Points",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}raycast(e,t){const i=this.geometry,n=this.matrixWorld,s=e.params.Points.threshold,o=i.drawRange;if(null===i.boundingSphere&&i.computeBoundingSphere(),Ua.copy(i.boundingSphere),Ua.applyMatrix4(n),Ua.radius+=s,!1===e.ray.intersectsSphere(Ua))return;ka.copy(n).invert(),Oa.copy(e.ray).applyMatrix4(ka);const r=s/((this.scale.x+this.scale.y+this.scale.z)/3),a=r*r,l=i.index,g=i.attributes.position;if(null!==l){for(let i=Math.max(0,o.start),s=Math.min(l.count,o.start+o.count);i<s;i++){const s=l.getX(i);Qa.fromBufferAttribute(g,s),ja(Qa,s,a,n,e,t,this)}}else{for(let i=Math.max(0,o.start),s=Math.min(g.count,o.start+o.count);i<s;i++)Qa.fromBufferAttribute(g,i),ja(Qa,i,a,n,e,t,this)}}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const i=e[t[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=i.length;e<t;e++){const t=i[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}}function ja(e,t,i,n,s,o,r){const a=Oa.distanceSqToPoint(e);if(a<i){const i=new Qt;Oa.closestPointToPoint(e,i),i.applyMatrix4(n);const l=s.ray.origin.distanceTo(i);if(l<s.near||l>s.far)return;o.push({distance:l,distanceToRay:Math.sqrt(a),point:i,index:t,face:null,object:r})}}class qa extends Lt{constructor(e,t){super({width:e,height:t}),this.isFramebufferTexture=!0,this.magFilter=T,this.minFilter=T,this.generateMipmaps=!1,this.needsUpdate=!0}}class $a extends Lt{constructor(e,t,i,n,s,o,r,a,l,g,c,d){super(null,o,r,a,l,g,n,s,c,d),this.isCompressedTexture=!0,this.image={width:t,height:i},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}}class el extends $a{constructor(e,t,i,n,s,o){super(e,t,i,s,o),this.isCompressedArrayTexture=!0,this.image.depth=n,this.wrapR=M}}class tl extends $a{constructor(e,t,i){super(void 0,e[0].width,e[0].height,t,i,x),this.isCompressedCubeTexture=!0,this.isCubeTexture=!0,this.image=e}}class il extends Lt{constructor(e,t,i,n,s,o,r,a,l){super(e,t,i,n,s,o,r,a,l),this.isCanvasTexture=!0,this.needsUpdate=!0}}class nl extends Fn{constructor(e=1,t=1,i=1,n=32,s=1,o=!1,r=0,a=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:i,radialSegments:n,heightSegments:s,openEnded:o,thetaStart:r,thetaLength:a};const l=this;n=Math.floor(n),s=Math.floor(s);const g=[],c=[],d=[],h=[];let u=0;const I=[],p=i/2;let m=0;function A(i){const s=u,o=new bt,I=new Qt;let A=0;const C=!0===i?e:t,f=!0===i?1:-1;for(let e=1;e<=n;e++)c.push(0,p*f,0),d.push(0,f,0),h.push(.5,.5),u++;const b=u;for(let e=0;e<=n;e++){const t=e/n*a+r,i=Math.cos(t),s=Math.sin(t);I.x=C*s,I.y=p*f,I.z=C*i,c.push(I.x,I.y,I.z),d.push(0,f,0),o.x=.5*i+.5,o.y=.5*s*f+.5,h.push(o.x,o.y),u++}for(let e=0;e<n;e++){const t=s+e,n=b+e;!0===i?g.push(n,n+1,t):g.push(n+1,n,t),A+=3}l.addGroup(m,A,!0===i?1:2),m+=A}!function(){const o=new Qt,A=new Qt;let C=0;const f=(t-e)/i;for(let l=0;l<=s;l++){const g=[],m=l/s,C=m*(t-e)+e;for(let e=0;e<=n;e++){const t=e/n,s=t*a+r,l=Math.sin(s),I=Math.cos(s);A.x=C*l,A.y=-m*i+p,A.z=C*I,c.push(A.x,A.y,A.z),o.set(l,f,I).normalize(),d.push(o.x,o.y,o.z),h.push(t,1-m),g.push(u++)}I.push(g)}for(let e=0;e<n;e++)for(let t=0;t<s;t++){const i=I[t][e],n=I[t+1][e],s=I[t+1][e+1],o=I[t][e+1];g.push(i,n,o),g.push(n,s,o),C+=6}l.addGroup(m,C,0),m+=C}(),!1===o&&(e>0&&A(!0),t>0&&A(!1)),this.setIndex(g),this.setAttribute("position",new Mn(c,3)),this.setAttribute("normal",new Mn(d,3)),this.setAttribute("uv",new Mn(h,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new nl(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class sl extends Fn{constructor(e=[],t=[],i=1,n=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:i,detail:n};const s=[],o=[];function r(e,t,i,n){const s=n+1,o=[];for(let r=0;r<=s;r++){o[r]=[];const n=e.clone().lerp(i,r/s),a=t.clone().lerp(i,r/s),l=s-r;for(let e=0;e<=l;e++)o[r][e]=0===e&&r===s?n:n.clone().lerp(a,e/l)}for(let r=0;r<s;r++)for(let e=0;e<2*(s-r)-1;e++){const t=Math.floor(e/2);e%2==0?(a(o[r][t+1]),a(o[r+1][t]),a(o[r][t])):(a(o[r][t+1]),a(o[r+1][t+1]),a(o[r+1][t]))}}function a(e){s.push(e.x,e.y,e.z)}function l(t,i){const n=3*t;i.x=e[n+0],i.y=e[n+1],i.z=e[n+2]}function g(e,t,i,n){n<0&&1===e.x&&(o[t]=e.x-1),0===i.x&&0===i.z&&(o[t]=n/2/Math.PI+.5)}function c(e){return Math.atan2(e.z,-e.x)}!function(e){const i=new Qt,n=new Qt,s=new Qt;for(let o=0;o<t.length;o+=3)l(t[o+0],i),l(t[o+1],n),l(t[o+2],s),r(i,n,s,e)}(n),function(e){const t=new Qt;for(let i=0;i<s.length;i+=3)t.x=s[i+0],t.y=s[i+1],t.z=s[i+2],t.normalize().multiplyScalar(e),s[i+0]=t.x,s[i+1]=t.y,s[i+2]=t.z}(i),function(){const e=new Qt;for(let i=0;i<s.length;i+=3){e.x=s[i+0],e.y=s[i+1],e.z=s[i+2];const n=c(e)/2/Math.PI+.5,r=(t=e,Math.atan2(-t.y,Math.sqrt(t.x*t.x+t.z*t.z))/Math.PI+.5);o.push(n,1-r)}var t;(function(){const e=new Qt,t=new Qt,i=new Qt,n=new Qt,r=new bt,a=new bt,l=new bt;for(let d=0,h=0;d<s.length;d+=9,h+=6){e.set(s[d+0],s[d+1],s[d+2]),t.set(s[d+3],s[d+4],s[d+5]),i.set(s[d+6],s[d+7],s[d+8]),r.set(o[h+0],o[h+1]),a.set(o[h+2],o[h+3]),l.set(o[h+4],o[h+5]),n.copy(e).add(t).add(i).divideScalar(3);const u=c(n);g(r,h+0,e,u),g(a,h+2,t,u),g(l,h+4,i,u)}})(),function(){for(let e=0;e<o.length;e+=6){const t=o[e+0],i=o[e+2],n=o[e+4],s=Math.max(t,i,n),r=Math.min(t,i,n);s>.9&&r<.1&&(t<.2&&(o[e+0]+=1),i<.2&&(o[e+2]+=1),n<.2&&(o[e+4]+=1))}}()}(),this.setAttribute("position",new Mn(s,3)),this.setAttribute("normal",new Mn(s.slice(),3)),this.setAttribute("uv",new Mn(o,2)),0===n?this.computeVertexNormals():this.normalizeNormals()}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new sl(e.vertices,e.indices,e.radius,e.details)}}const ol=new Qt,rl=new Qt,al=new Qt,ll=new gn;class gl extends Fn{constructor(e=null,t=1){if(super(),this.type="EdgesGeometry",this.parameters={geometry:e,thresholdAngle:t},null!==e){const i=4,n=Math.pow(10,i),s=Math.cos(lt*t),o=e.getIndex(),r=e.getAttribute("position"),a=o?o.count:r.count,l=[0,0,0],g=["a","b","c"],c=new Array(3),d={},h=[];for(let e=0;e<a;e+=3){o?(l[0]=o.getX(e),l[1]=o.getX(e+1),l[2]=o.getX(e+2)):(l[0]=e,l[1]=e+1,l[2]=e+2);const{a:t,b:i,c:a}=ll;if(t.fromBufferAttribute(r,l[0]),i.fromBufferAttribute(r,l[1]),a.fromBufferAttribute(r,l[2]),ll.getNormal(al),c[0]=`${Math.round(t.x*n)},${Math.round(t.y*n)},${Math.round(t.z*n)}`,c[1]=`${Math.round(i.x*n)},${Math.round(i.y*n)},${Math.round(i.z*n)}`,c[2]=`${Math.round(a.x*n)},${Math.round(a.y*n)},${Math.round(a.z*n)}`,c[0]!==c[1]&&c[1]!==c[2]&&c[2]!==c[0])for(let e=0;e<3;e++){const t=(e+1)%3,i=c[e],n=c[t],o=ll[g[e]],r=ll[g[t]],a=`${i}_${n}`,u=`${n}_${i}`;u in d&&d[u]?(al.dot(d[u].normal)<=s&&(h.push(o.x,o.y,o.z),h.push(r.x,r.y,r.z)),d[u]=null):a in d||(d[a]={index0:l[e],index1:l[t],normal:al.clone()})}}for(const e in d)if(d[e]){const{index0:t,index1:i}=d[e];ol.fromBufferAttribute(r,t),rl.fromBufferAttribute(r,i),h.push(ol.x,ol.y,ol.z),h.push(rl.x,rl.y,rl.z)}this.setAttribute("position",new Mn(h,3))}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}}class cl extends sl{constructor(e=1,t=0){super([1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],e,t),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new cl(e.radius,e.detail)}}class dl extends Fn{constructor(e=1,t=32,i=16,n=0,s=2*Math.PI,o=0,r=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:i,phiStart:n,phiLength:s,thetaStart:o,thetaLength:r},t=Math.max(3,Math.floor(t)),i=Math.max(2,Math.floor(i));const a=Math.min(o+r,Math.PI);let l=0;const g=[],c=new Qt,d=new Qt,h=[],u=[],I=[],p=[];for(let m=0;m<=i;m++){const h=[],A=m/i;let C=0;0===m&&0===o?C=.5/t:m===i&&a===Math.PI&&(C=-.5/t);for(let i=0;i<=t;i++){const a=i/t;c.x=-e*Math.cos(n+a*s)*Math.sin(o+A*r),c.y=e*Math.cos(o+A*r),c.z=e*Math.sin(n+a*s)*Math.sin(o+A*r),u.push(c.x,c.y,c.z),d.copy(c).normalize(),I.push(d.x,d.y,d.z),p.push(a+C,1-A),h.push(l++)}g.push(h)}for(let m=0;m<i;m++)for(let e=0;e<t;e++){const t=g[m][e+1],n=g[m][e],s=g[m+1][e],r=g[m+1][e+1];(0!==m||o>0)&&h.push(t,n,r),(m!==i-1||a<Math.PI)&&h.push(n,s,r)}this.setIndex(h),this.setAttribute("position",new Mn(u,3)),this.setAttribute("normal",new Mn(I,3)),this.setAttribute("uv",new Mn(p,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new dl(e.radius,e.widthSegments,e.heightSegments,e.phiStart,e.phiLength,e.thetaStart,e.thetaLength)}}class hl extends Fn{constructor(e=1,t=.4,i=12,n=48,s=2*Math.PI){super(),this.type="TorusGeometry",this.parameters={radius:e,tube:t,radialSegments:i,tubularSegments:n,arc:s},i=Math.floor(i),n=Math.floor(n);const o=[],r=[],a=[],l=[],g=new Qt,c=new Qt,d=new Qt;for(let h=0;h<=i;h++)for(let o=0;o<=n;o++){const u=o/n*s,I=h/i*Math.PI*2;c.x=(e+t*Math.cos(I))*Math.cos(u),c.y=(e+t*Math.cos(I))*Math.sin(u),c.z=t*Math.sin(I),r.push(c.x,c.y,c.z),g.x=e*Math.cos(u),g.y=e*Math.sin(u),d.subVectors(c,g).normalize(),a.push(d.x,d.y,d.z),l.push(o/n),l.push(h/i)}for(let h=1;h<=i;h++)for(let e=1;e<=n;e++){const t=(n+1)*h+e-1,i=(n+1)*(h-1)+e-1,s=(n+1)*(h-1)+e,r=(n+1)*h+e;o.push(t,i,r),o.push(i,s,r)}this.setIndex(o),this.setAttribute("position",new Mn(r,3)),this.setAttribute("normal",new Mn(a,3)),this.setAttribute("uv",new Mn(l,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new hl(e.radius,e.tube,e.radialSegments,e.tubularSegments,e.arc)}}class ul extends ls{constructor(e){super(e),this.isRawShaderMaterial=!0,this.type="RawShaderMaterial"}}class Il extends An{constructor(e){super(),this.isMeshStandardMaterial=!0,this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new In(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new In(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new bt(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapIntensity=e.envMapIntensity,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class pl extends Il{constructor(e){super(),this.isMeshPhysicalMaterial=!0,this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.anisotropyRotation=0,this.anisotropyMap=null,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new bt(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return dt(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(e){this.ior=(1+.4*e)/(1-.4*e)}}),this.iridescenceMap=null,this.iridescenceIOR=1.3,this.iridescenceThicknessRange=[100,400],this.iridescenceThicknessMap=null,this.sheenColor=new In(0),this.sheenColorMap=null,this.sheenRoughness=1,this.sheenRoughnessMap=null,this.transmissionMap=null,this.thickness=0,this.thicknessMap=null,this.attenuationDistance=1/0,this.attenuationColor=new In(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularColor=new In(1,1,1),this.specularColorMap=null,this._anisotropy=0,this._clearcoat=0,this._iridescence=0,this._sheen=0,this._transmission=0,this.setValues(e)}get anisotropy(){return this._anisotropy}set anisotropy(e){this._anisotropy>0!=e>0&&this.version++,this._anisotropy=e}get clearcoat(){return this._clearcoat}set clearcoat(e){this._clearcoat>0!=e>0&&this.version++,this._clearcoat=e}get iridescence(){return this._iridescence}set iridescence(e){this._iridescence>0!=e>0&&this.version++,this._iridescence=e}get sheen(){return this._sheen}set sheen(e){this._sheen>0!=e>0&&this.version++,this._sheen=e}get transmission(){return this._transmission}set transmission(e){this._transmission>0!=e>0&&this.version++,this._transmission=e}copy(e){return super.copy(e),this.defines={STANDARD:"",PHYSICAL:""},this.anisotropy=e.anisotropy,this.anisotropyRotation=e.anisotropyRotation,this.anisotropyMap=e.anisotropyMap,this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.ior=e.ior,this.iridescence=e.iridescence,this.iridescenceMap=e.iridescenceMap,this.iridescenceIOR=e.iridescenceIOR,this.iridescenceThicknessRange=[...e.iridescenceThicknessRange],this.iridescenceThicknessMap=e.iridescenceThicknessMap,this.sheen=e.sheen,this.sheenColor.copy(e.sheenColor),this.sheenColorMap=e.sheenColorMap,this.sheenRoughness=e.sheenRoughness,this.sheenRoughnessMap=e.sheenRoughnessMap,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this.thickness=e.thickness,this.thicknessMap=e.thicknessMap,this.attenuationDistance=e.attenuationDistance,this.attenuationColor.copy(e.attenuationColor),this.specularIntensity=e.specularIntensity,this.specularIntensityMap=e.specularIntensityMap,this.specularColor.copy(e.specularColor),this.specularColorMap=e.specularColorMap,this}}function ml(e,t,i){return!e||!i&&e.constructor===t?e:"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e)}function Al(e){const t=e.length,i=new Array(t);for(let n=0;n!==t;++n)i[n]=n;return i.sort((function(t,i){return e[t]-e[i]})),i}function Cl(e,t,i){const n=e.length,s=new e.constructor(n);for(let o=0,r=0;r!==n;++o){const n=i[o]*t;for(let i=0;i!==t;++i)s[r++]=e[n+i]}return s}function fl(e,t,i,n){let s=1,o=e[0];for(;void 0!==o&&void 0===o[n];)o=e[s++];if(void 0===o)return;let r=o[n];if(void 0!==r)if(Array.isArray(r))do{r=o[n],void 0!==r&&(t.push(o.time),i.push.apply(i,r)),o=e[s++]}while(void 0!==o);else if(void 0!==r.toArray)do{r=o[n],void 0!==r&&(t.push(o.time),r.toArray(i,i.length)),o=e[s++]}while(void 0!==o);else do{r=o[n],void 0!==r&&(t.push(o.time),i.push(r)),o=e[s++]}while(void 0!==o)}class bl{constructor(e,t,i,n){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==n?n:new t.constructor(i),this.sampleValues=t,this.valueSize=i,this.settings=null,this.DefaultSettings_={}}evaluate(e){const t=this.parameterPositions;let i=this._cachedIndex,n=t[i],s=t[i-1];e:{t:{let o;i:{n:if(!(e<n)){for(let o=i+2;;){if(void 0===n){if(e<s)break n;return i=t.length,this._cachedIndex=i,this.copySampleValue_(i-1)}if(i===o)break;if(s=n,n=t[++i],e<n)break t}o=t.length;break i}if(e>=s)break e;{const r=t[1];e<r&&(i=2,s=r);for(let o=i-2;;){if(void 0===s)return this._cachedIndex=0,this.copySampleValue_(0);if(i===o)break;if(n=s,s=t[--i-1],e>=s)break t}o=i,i=0}}for(;i<o;){const n=i+o>>>1;e<t[n]?o=n:i=n+1}if(n=t[i],s=t[i-1],void 0===s)return this._cachedIndex=0,this.copySampleValue_(0);if(void 0===n)return i=t.length,this._cachedIndex=i,this.copySampleValue_(i-1)}this._cachedIndex=i,this.intervalChanged_(i,s,n)}return this.interpolate_(i,s,e,n)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,n=this.valueSize,s=e*n;for(let o=0;o!==n;++o)t[o]=i[s+o];return t}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}class yl extends bl{constructor(e,t,i,n){super(e,t,i,n),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:Fe,endingEnd:Fe}}intervalChanged_(e,t,i){const n=this.parameterPositions;let s=e-2,o=e+1,r=n[s],a=n[o];if(void 0===r)switch(this.getSettings_().endingStart){case Xe:s=e,r=2*t-i;break;case He:s=n.length-2,r=t+n[s]-n[s+1];break;default:s=e,r=i}if(void 0===a)switch(this.getSettings_().endingEnd){case Xe:o=e,a=2*i-t;break;case He:o=1,a=i+n[1]-n[0];break;default:o=e-1,a=t}const l=.5*(i-t),g=this.valueSize;this._weightPrev=l/(t-r),this._weightNext=l/(a-i),this._offsetPrev=s*g,this._offsetNext=o*g}interpolate_(e,t,i,n){const s=this.resultBuffer,o=this.sampleValues,r=this.valueSize,a=e*r,l=a-r,g=this._offsetPrev,c=this._offsetNext,d=this._weightPrev,h=this._weightNext,u=(i-t)/(n-t),I=u*u,p=I*u,m=-d*p+2*d*I-d*u,A=(1+d)*p+(-1.5-2*d)*I+(-.5+d)*u+1,C=(-1-h)*p+(1.5+h)*I+.5*u,f=h*p-h*I;for(let b=0;b!==r;++b)s[b]=m*o[g+b]+A*o[l+b]+C*o[a+b]+f*o[c+b];return s}}class _l extends bl{constructor(e,t,i,n){super(e,t,i,n)}interpolate_(e,t,i,n){const s=this.resultBuffer,o=this.sampleValues,r=this.valueSize,a=e*r,l=a-r,g=(i-t)/(n-t),c=1-g;for(let d=0;d!==r;++d)s[d]=o[l+d]*c+o[a+d]*g;return s}}class vl extends bl{constructor(e,t,i,n){super(e,t,i,n)}interpolate_(e){return this.copySampleValue_(e-1)}}class xl{constructor(e,t,i,n){if(void 0===e)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===t||0===t.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+e);this.name=e,this.times=ml(t,this.TimeBufferType),this.values=ml(i,this.ValueBufferType),this.setInterpolation(n||this.DefaultInterpolation)}static toJSON(e){const t=e.constructor;let i;if(t.toJSON!==this.toJSON)i=t.toJSON(e);else{i={name:e.name,times:ml(e.times,Array),values:ml(e.values,Array)};const t=e.getInterpolation();t!==e.DefaultInterpolation&&(i.interpolation=t)}return i.type=e.ValueTypeName,i}InterpolantFactoryMethodDiscrete(e){return new vl(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodLinear(e){return new _l(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodSmooth(e){return new yl(this.times,this.values,this.getValueSize(),e)}setInterpolation(e){let t;switch(e){case We:t=this.InterpolantFactoryMethodDiscrete;break;case Ee:t=this.InterpolantFactoryMethodLinear;break;case Ne:t=this.InterpolantFactoryMethodSmooth}if(void 0===t){const t="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e===this.DefaultInterpolation)throw new Error(t);this.setInterpolation(this.DefaultInterpolation)}return console.warn("THREE.KeyframeTrack:",t),this}return this.createInterpolant=t,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return We;case this.InterpolantFactoryMethodLinear:return Ee;case this.InterpolantFactoryMethodSmooth:return Ne}}getValueSize(){return this.values.length/this.times.length}shift(e){if(0!==e){const t=this.times;for(let i=0,n=t.length;i!==n;++i)t[i]+=e}return this}scale(e){if(1!==e){const t=this.times;for(let i=0,n=t.length;i!==n;++i)t[i]*=e}return this}trim(e,t){const i=this.times,n=i.length;let s=0,o=n-1;for(;s!==n&&i[s]<e;)++s;for(;-1!==o&&i[o]>t;)--o;if(++o,0!==s||o!==n){s>=o&&(o=Math.max(o,1),s=o-1);const e=this.getValueSize();this.times=i.slice(s,o),this.values=this.values.slice(s*e,o*e)}return this}validate(){let e=!0;const t=this.getValueSize();t-Math.floor(t)!=0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),e=!1);const i=this.times,n=this.values,s=i.length;0===s&&(console.error("THREE.KeyframeTrack: Track is empty.",this),e=!1);let o=null;for(let a=0;a!==s;a++){const t=i[a];if("number"==typeof t&&isNaN(t)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,a,t),e=!1;break}if(null!==o&&o>t){console.error("THREE.KeyframeTrack: Out of order keys.",this,a,t,o),e=!1;break}o=t}if(void 0!==n&&(r=n,ArrayBuffer.isView(r)&&!(r instanceof DataView)))for(let a=0,l=n.length;a!==l;++a){const t=n[a];if(isNaN(t)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,a,t),e=!1;break}}var r;return e}optimize(){const e=this.times.slice(),t=this.values.slice(),i=this.getValueSize(),n=this.getInterpolation()===Ne,s=e.length-1;let o=1;for(let r=1;r<s;++r){let s=!1;const a=e[r];if(a!==e[r+1]&&(1!==r||a!==e[0]))if(n)s=!0;else{const e=r*i,n=e-i,o=e+i;for(let r=0;r!==i;++r){const i=t[e+r];if(i!==t[n+r]||i!==t[o+r]){s=!0;break}}}if(s){if(r!==o){e[o]=e[r];const n=r*i,s=o*i;for(let e=0;e!==i;++e)t[s+e]=t[n+e]}++o}}if(s>0){e[o]=e[s];for(let e=s*i,n=o*i,r=0;r!==i;++r)t[n+r]=t[e+r];++o}return o!==e.length?(this.times=e.slice(0,o),this.values=t.slice(0,o*i)):(this.times=e,this.values=t),this}clone(){const e=this.times.slice(),t=this.values.slice(),i=new(0,this.constructor)(this.name,e,t);return i.createInterpolant=this.createInterpolant,i}}xl.prototype.TimeBufferType=Float32Array,xl.prototype.ValueBufferType=Float32Array,xl.prototype.DefaultInterpolation=Ee;class Bl extends xl{}Bl.prototype.ValueTypeName="bool",Bl.prototype.ValueBufferType=Array,Bl.prototype.DefaultInterpolation=We,Bl.prototype.InterpolantFactoryMethodLinear=void 0,Bl.prototype.InterpolantFactoryMethodSmooth=void 0;class wl extends xl{}wl.prototype.ValueTypeName="color";class Sl extends xl{}Sl.prototype.ValueTypeName="number";class Gl extends bl{constructor(e,t,i,n){super(e,t,i,n)}interpolate_(e,t,i,n){const s=this.resultBuffer,o=this.sampleValues,r=this.valueSize,a=(i-t)/(n-t);let l=e*r;for(let g=l+r;l!==g;l+=4)Ut.slerpFlat(s,0,o,l-r,o,l,a);return s}}class Ml extends xl{InterpolantFactoryMethodLinear(e){return new Gl(this.times,this.values,this.getValueSize(),e)}}Ml.prototype.ValueTypeName="quaternion",Ml.prototype.DefaultInterpolation=Ee,Ml.prototype.InterpolantFactoryMethodSmooth=void 0;class Rl extends xl{}Rl.prototype.ValueTypeName="string",Rl.prototype.ValueBufferType=Array,Rl.prototype.DefaultInterpolation=We,Rl.prototype.InterpolantFactoryMethodLinear=void 0,Rl.prototype.InterpolantFactoryMethodSmooth=void 0;class Tl extends xl{}Tl.prototype.ValueTypeName="vector";class Zl{constructor(e,t=-1,i,n=2500){this.name=e,this.tracks=i,this.duration=t,this.blendMode=n,this.uuid=ct(),this.duration<0&&this.resetDuration()}static parse(e){const t=[],i=e.tracks,n=1/(e.fps||1);for(let o=0,r=i.length;o!==r;++o)t.push(Vl(i[o]).scale(n));const s=new this(e.name,e.duration,t,e.blendMode);return s.uuid=e.uuid,s}static toJSON(e){const t=[],i=e.tracks,n={name:e.name,duration:e.duration,tracks:t,uuid:e.uuid,blendMode:e.blendMode};for(let s=0,o=i.length;s!==o;++s)t.push(xl.toJSON(i[s]));return n}static CreateFromMorphTargetSequence(e,t,i,n){const s=t.length,o=[];for(let r=0;r<s;r++){let e=[],a=[];e.push((r+s-1)%s,r,(r+1)%s),a.push(0,1,0);const l=Al(e);e=Cl(e,1,l),a=Cl(a,1,l),n||0!==e[0]||(e.push(s),a.push(a[0])),o.push(new Sl(".morphTargetInfluences["+t[r].name+"]",e,a).scale(1/i))}return new this(e,-1,o)}static findByName(e,t){let i=e;if(!Array.isArray(e)){const t=e;i=t.geometry&&t.geometry.animations||t.animations}for(let n=0;n<i.length;n++)if(i[n].name===t)return i[n];return null}static CreateClipsFromMorphTargetSequences(e,t,i){const n={},s=/^([\w-]*?)([\d]+)$/;for(let r=0,a=e.length;r<a;r++){const t=e[r],i=t.name.match(s);if(i&&i.length>1){const e=i[1];let s=n[e];s||(n[e]=s=[]),s.push(t)}}const o=[];for(const r in n)o.push(this.CreateFromMorphTargetSequence(r,n[r],t,i));return o}static parseAnimation(e,t){if(!e)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;const i=function(e,t,i,n,s){if(0!==i.length){const o=[],r=[];fl(i,o,r,n),0!==o.length&&s.push(new e(t,o,r))}},n=[],s=e.name||"default",o=e.fps||30,r=e.blendMode;let a=e.length||-1;const l=e.hierarchy||[];for(let g=0;g<l.length;g++){const e=l[g].keys;if(e&&0!==e.length)if(e[0].morphTargets){const t={};let i;for(i=0;i<e.length;i++)if(e[i].morphTargets)for(let n=0;n<e[i].morphTargets.length;n++)t[e[i].morphTargets[n]]=-1;for(const s in t){const t=[],o=[];for(let n=0;n!==e[i].morphTargets.length;++n){const n=e[i];t.push(n.time),o.push(n.morphTarget===s?1:0)}n.push(new Sl(".morphTargetInfluence["+s+"]",t,o))}a=t.length*o}else{const s=".bones["+t[g].name+"]";i(Tl,s+".position",e,"pos",n),i(Ml,s+".quaternion",e,"rot",n),i(Tl,s+".scale",e,"scl",n)}}if(0===n.length)return null;return new this(s,a,n,r)}resetDuration(){let e=0;for(let t=0,i=this.tracks.length;t!==i;++t){const i=this.tracks[t];e=Math.max(e,i.times[i.times.length-1])}return this.duration=e,this}trim(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this}validate(){let e=!0;for(let t=0;t<this.tracks.length;t++)e=e&&this.tracks[t].validate();return e}optimize(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}clone(){const e=[];for(let t=0;t<this.tracks.length;t++)e.push(this.tracks[t].clone());return new this.constructor(this.name,this.duration,e,this.blendMode)}toJSON(){return this.constructor.toJSON(this)}}function Vl(e){if(void 0===e.type)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const t=function(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return Sl;case"vector":case"vector2":case"vector3":case"vector4":return Tl;case"color":return wl;case"quaternion":return Ml;case"bool":case"boolean":return Bl;case"string":return Rl}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+e)}(e.type);if(void 0===e.times){const t=[],i=[];fl(e.keys,t,i,"value"),e.times=t,e.values=i}return void 0!==t.parse?t.parse(e):new t(e.name,e.times,e.values,e.interpolation)}const Wl={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}};class El{constructor(e,t,i){const n=this;let s,o=!1,r=0,a=0;const l=[];this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=i,this.itemStart=function(e){a++,!1===o&&void 0!==n.onStart&&n.onStart(e,r,a),o=!0},this.itemEnd=function(e){r++,void 0!==n.onProgress&&n.onProgress(e,r,a),r===a&&(o=!1,void 0!==n.onLoad&&n.onLoad())},this.itemError=function(e){void 0!==n.onError&&n.onError(e)},this.resolveURL=function(e){return s?s(e):e},this.setURLModifier=function(e){return s=e,this},this.addHandler=function(e,t){return l.push(e,t),this},this.removeHandler=function(e){const t=l.indexOf(e);return-1!==t&&l.splice(t,2),this},this.getHandler=function(e){for(let t=0,i=l.length;t<i;t+=2){const i=l[t],n=l[t+1];if(i.global&&(i.lastIndex=0),i.test(e))return n}return null}}}const Nl=new El;class Fl{constructor(e){this.manager=void 0!==e?e:Nl,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){const i=this;return new Promise((function(n,s){i.load(e,n,t,s)}))}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}}Fl.DEFAULT_MATERIAL_NAME="__DEFAULT";const Xl={};class Hl extends Error{constructor(e,t){super(e),this.response=t}}class zl extends Fl{constructor(e){super(e)}load(e,t,i,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const s=Wl.get(e);if(void 0!==s)return this.manager.itemStart(e),setTimeout((()=>{t&&t(s),this.manager.itemEnd(e)}),0),s;if(void 0!==Xl[e])return void Xl[e].push({onLoad:t,onProgress:i,onError:n});Xl[e]=[],Xl[e].push({onLoad:t,onProgress:i,onError:n});const o=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),r=this.mimeType,a=this.responseType;fetch(o).then((t=>{if(200===t.status||0===t.status){if(0===t.status&&console.warn("THREE.FileLoader: HTTP Status 0 received."),"undefined"==typeof ReadableStream||void 0===t.body||void 0===t.body.getReader)return t;const i=Xl[e],n=t.body.getReader(),s=t.headers.get("Content-Length")||t.headers.get("X-File-Size"),o=s?parseInt(s):0,r=0!==o;let a=0;const l=new ReadableStream({start(e){!function t(){n.read().then((({done:n,value:s})=>{if(n)e.close();else{a+=s.byteLength;const n=new ProgressEvent("progress",{lengthComputable:r,loaded:a,total:o});for(let e=0,t=i.length;e<t;e++){const t=i[e];t.onProgress&&t.onProgress(n)}e.enqueue(s),t()}}))}()}});return new Response(l)}throw new Hl(`fetch for "${t.url}" responded with ${t.status}: ${t.statusText}`,t)})).then((e=>{switch(a){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"document":return e.text().then((e=>(new DOMParser).parseFromString(e,r)));case"json":return e.json();default:if(void 0===r)return e.text();{const t=/charset="?([^;"\s]*)"?/i.exec(r),i=t&&t[1]?t[1].toLowerCase():void 0,n=new TextDecoder(i);return e.arrayBuffer().then((e=>n.decode(e)))}}})).then((t=>{Wl.add(e,t);const i=Xl[e];delete Xl[e];for(let e=0,n=i.length;e<n;e++){const n=i[e];n.onLoad&&n.onLoad(t)}})).catch((t=>{const i=Xl[e];if(void 0===i)throw this.manager.itemError(e),t;delete Xl[e];for(let e=0,n=i.length;e<n;e++){const n=i[e];n.onError&&n.onError(t)}this.manager.itemError(e)})).finally((()=>{this.manager.itemEnd(e)})),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}}class Ll extends Fl{constructor(e){super(e)}load(e,t,i,n){void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const s=this,o=Wl.get(e);if(void 0!==o)return s.manager.itemStart(e),setTimeout((function(){t&&t(o),s.manager.itemEnd(e)}),0),o;const r=xt("img");function a(){g(),Wl.add(e,this),t&&t(this),s.manager.itemEnd(e)}function l(t){g(),n&&n(t),s.manager.itemError(e),s.manager.itemEnd(e)}function g(){r.removeEventListener("load",a,!1),r.removeEventListener("error",l,!1)}return r.addEventListener("load",a,!1),r.addEventListener("error",l,!1),"data:"!==e.slice(0,5)&&void 0!==this.crossOrigin&&(r.crossOrigin=this.crossOrigin),s.manager.itemStart(e),r.src=e,r}}class Dl extends Fl{constructor(e){super(e)}load(e,t,i,n){const s=new Lt,o=new Ll(this.manager);return o.setCrossOrigin(this.crossOrigin),o.setPath(this.path),o.load(e,(function(e){s.image=e,s.needsUpdate=!0,void 0!==t&&t(s)}),i,n),s}}class Kl extends Ji{constructor(e,t=1){super(),this.isLight=!0,this.type="Light",this.color=new In(e),this.intensity=t}dispose(){}copy(e,t){return super.copy(e,t),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),t}}const Yl=new Bi,Pl=new Qt,kl=new Qt;class Ol{constructor(e){this.camera=e,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new bt(512,512),this.map=null,this.mapPass=null,this.matrix=new Bi,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new ys,this._frameExtents=new bt(1,1),this._viewportCount=1,this._viewports=[new Dt(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,i=this.matrix;Pl.setFromMatrixPosition(e.matrixWorld),t.position.copy(Pl),kl.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(kl),t.updateMatrixWorld(),Yl.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(Yl),i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(Yl)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const e={};return 0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class Ul extends Ol{constructor(){super(new cs(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1}updateMatrices(e){const t=this.camera,i=2*gt*e.angle*this.focus,n=this.mapSize.width/this.mapSize.height,s=e.distance||t.far;i===t.fov&&n===t.aspect&&s===t.far||(t.fov=i,t.aspect=n,t.far=s,t.updateProjectionMatrix()),super.updateMatrices(e)}copy(e){return super.copy(e),this.focus=e.focus,this}}class Ql extends Kl{constructor(e,t,i=0,n=Math.PI/3,s=0,o=2){super(e,t),this.isSpotLight=!0,this.type="SpotLight",this.position.copy(Ji.DEFAULT_UP),this.updateMatrix(),this.target=new Ji,this.distance=i,this.angle=n,this.penumbra=s,this.decay=o,this.map=null,this.shadow=new Ul}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}const Jl=new Bi,jl=new Qt,ql=new Qt;class $l extends Ol{constructor(){super(new cs(90,1,.5,500)),this.isPointLightShadow=!0,this._frameExtents=new bt(4,2),this._viewportCount=6,this._viewports=[new Dt(2,1,1,1),new Dt(0,1,1,1),new Dt(3,1,1,1),new Dt(1,1,1,1),new Dt(3,0,1,1),new Dt(1,0,1,1)],this._cubeDirections=[new Qt(1,0,0),new Qt(-1,0,0),new Qt(0,0,1),new Qt(0,0,-1),new Qt(0,1,0),new Qt(0,-1,0)],this._cubeUps=[new Qt(0,1,0),new Qt(0,1,0),new Qt(0,1,0),new Qt(0,1,0),new Qt(0,0,1),new Qt(0,0,-1)]}updateMatrices(e,t=0){const i=this.camera,n=this.matrix,s=e.distance||i.far;s!==i.far&&(i.far=s,i.updateProjectionMatrix()),jl.setFromMatrixPosition(e.matrixWorld),i.position.copy(jl),ql.copy(i.position),ql.add(this._cubeDirections[t]),i.up.copy(this._cubeUps[t]),i.lookAt(ql),i.updateMatrixWorld(),n.makeTranslation(-jl.x,-jl.y,-jl.z),Jl.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),this._frustum.setFromProjectionMatrix(Jl)}}class eg extends Kl{constructor(e,t,i=0,n=2){super(e,t),this.isPointLight=!0,this.type="PointLight",this.distance=i,this.decay=n,this.shadow=new $l}get power(){return 4*this.intensity*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}class tg extends Ol{constructor(){super(new Es(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class ig extends Kl{constructor(e,t){super(e,t),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(Ji.DEFAULT_UP),this.updateMatrix(),this.target=new Ji,this.shadow=new tg}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}class ng extends Kl{constructor(e,t){super(e,t),this.isAmbientLight=!0,this.type="AmbientLight"}}class sg{static decodeText(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let t="";for(let i=0,n=e.length;i<n;i++)t+=String.fromCharCode(e[i]);try{return decodeURIComponent(escape(t))}catch(pb){return t}}static extractUrlBase(e){const t=e.lastIndexOf("/");return-1===t?"./":e.slice(0,t+1)}static resolveURL(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}}class og extends Fn{constructor(){super(),this.isInstancedBufferGeometry=!0,this.type="InstancedBufferGeometry",this.instanceCount=1/0}copy(e){return super.copy(e),this.instanceCount=e.instanceCount,this}toJSON(){const e=super.toJSON();return e.instanceCount=this.instanceCount,e.isInstancedBufferGeometry=!0,e}}class rg extends Fl{constructor(e){super(e),this.isImageBitmapLoader=!0,"undefined"==typeof createImageBitmap&&console.warn("THREE.ImageBitmapLoader: createImageBitmap() not supported."),"undefined"==typeof fetch&&console.warn("THREE.ImageBitmapLoader: fetch() not supported."),this.options={premultiplyAlpha:"none"}}setOptions(e){return this.options=e,this}load(e,t,i,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const s=this,o=Wl.get(e);if(void 0!==o)return s.manager.itemStart(e),setTimeout((function(){t&&t(o),s.manager.itemEnd(e)}),0),o;const r={};r.credentials="anonymous"===this.crossOrigin?"same-origin":"include",r.headers=this.requestHeader,fetch(e,r).then((function(e){return e.blob()})).then((function(e){return createImageBitmap(e,Object.assign(s.options,{colorSpaceConversion:"none"}))})).then((function(i){Wl.add(e,i),t&&t(i),s.manager.itemEnd(e)})).catch((function(t){n&&n(t),s.manager.itemError(e),s.manager.itemEnd(e)})),s.manager.itemStart(e)}}class ag{constructor(e=!0){this.autoStart=e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=lg(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const t=lg();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}}function lg(){return("undefined"==typeof performance?Date:performance).now()}class gg{constructor(e,t,i){let n,s,o;switch(this.binding=e,this.valueSize=i,t){case"quaternion":n=this._slerp,s=this._slerpAdditive,o=this._setAdditiveIdentityQuaternion,this.buffer=new Float64Array(6*i),this._workIndex=5;break;case"string":case"bool":n=this._select,s=this._select,o=this._setAdditiveIdentityOther,this.buffer=new Array(5*i);break;default:n=this._lerp,s=this._lerpAdditive,o=this._setAdditiveIdentityNumeric,this.buffer=new Float64Array(5*i)}this._mixBufferRegion=n,this._mixBufferRegionAdditive=s,this._setIdentity=o,this._origIndex=3,this._addIndex=4,this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,this.useCount=0,this.referenceCount=0}accumulate(e,t){const i=this.buffer,n=this.valueSize,s=e*n+n;let o=this.cumulativeWeight;if(0===o){for(let e=0;e!==n;++e)i[s+e]=i[e];o=t}else{o+=t;const e=t/o;this._mixBufferRegion(i,s,0,e,n)}this.cumulativeWeight=o}accumulateAdditive(e){const t=this.buffer,i=this.valueSize,n=i*this._addIndex;0===this.cumulativeWeightAdditive&&this._setIdentity(),this._mixBufferRegionAdditive(t,n,0,e,i),this.cumulativeWeightAdditive+=e}apply(e){const t=this.valueSize,i=this.buffer,n=e*t+t,s=this.cumulativeWeight,o=this.cumulativeWeightAdditive,r=this.binding;if(this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,s<1){const e=t*this._origIndex;this._mixBufferRegion(i,n,e,1-s,t)}o>0&&this._mixBufferRegionAdditive(i,n,this._addIndex*t,1,t);for(let a=t,l=t+t;a!==l;++a)if(i[a]!==i[a+t]){r.setValue(i,n);break}}saveOriginalState(){const e=this.binding,t=this.buffer,i=this.valueSize,n=i*this._origIndex;e.getValue(t,n);for(let s=i,o=n;s!==o;++s)t[s]=t[n+s%i];this._setIdentity(),this.cumulativeWeight=0,this.cumulativeWeightAdditive=0}restoreOriginalState(){const e=3*this.valueSize;this.binding.setValue(this.buffer,e)}_setAdditiveIdentityNumeric(){const e=this._addIndex*this.valueSize,t=e+this.valueSize;for(let i=e;i<t;i++)this.buffer[i]=0}_setAdditiveIdentityQuaternion(){this._setAdditiveIdentityNumeric(),this.buffer[this._addIndex*this.valueSize+3]=1}_setAdditiveIdentityOther(){const e=this._origIndex*this.valueSize,t=this._addIndex*this.valueSize;for(let i=0;i<this.valueSize;i++)this.buffer[t+i]=this.buffer[e+i]}_select(e,t,i,n,s){if(n>=.5)for(let o=0;o!==s;++o)e[t+o]=e[i+o]}_slerp(e,t,i,n){Ut.slerpFlat(e,t,e,t,e,i,n)}_slerpAdditive(e,t,i,n,s){const o=this._workIndex*s;Ut.multiplyQuaternionsFlat(e,o,e,t,e,i),Ut.slerpFlat(e,t,e,t,e,o,n)}_lerp(e,t,i,n,s){const o=1-n;for(let r=0;r!==s;++r){const s=t+r;e[s]=e[s]*o+e[i+r]*n}}_lerpAdditive(e,t,i,n,s){for(let o=0;o!==s;++o){const s=t+o;e[s]=e[s]+e[i+o]*n}}}const cg="\\[\\]\\.:\\/",dg=new RegExp("["+cg+"]","g"),hg="[^"+cg+"]",ug="[^"+cg.replace("\\.","")+"]",Ig=new RegExp("^"+/((?:WC+[\/:])*)/.source.replace("WC",hg)+/(WCOD+)?/.source.replace("WCOD",ug)+/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",hg)+/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",hg)+"$"),pg=["material","materials","bones","map"];class mg{constructor(e,t,i){this.path=t,this.parsedPath=i||mg.parseTrackName(t),this.node=mg.findNode(e,this.parsedPath.nodeName),this.rootNode=e,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(e,t,i){return e&&e.isAnimationObjectGroup?new mg.Composite(e,t,i):new mg(e,t,i)}static sanitizeNodeName(e){return e.replace(/\s/g,"_").replace(dg,"")}static parseTrackName(e){const t=Ig.exec(e);if(null===t)throw new Error("PropertyBinding: Cannot parse trackName: "+e);const i={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},n=i.nodeName&&i.nodeName.lastIndexOf(".");if(void 0!==n&&-1!==n){const e=i.nodeName.substring(n+1);-1!==pg.indexOf(e)&&(i.nodeName=i.nodeName.substring(0,n),i.objectName=e)}if(null===i.propertyName||0===i.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return i}static findNode(e,t){if(void 0===t||""===t||"."===t||-1===t||t===e.name||t===e.uuid)return e;if(e.skeleton){const i=e.skeleton.getBoneByName(t);if(void 0!==i)return i}if(e.children){const i=function(e){for(let n=0;n<e.length;n++){const s=e[n];if(s.name===t||s.uuid===t)return s;const o=i(s.children);if(o)return o}return null},n=i(e.children);if(n)return n}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(e,t){e[t]=this.targetObject[this.propertyName]}_getValue_array(e,t){const i=this.resolvedProperty;for(let n=0,s=i.length;n!==s;++n)e[t++]=i[n]}_getValue_arrayElement(e,t){e[t]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(e,t){this.resolvedProperty.toArray(e,t)}_setValue_direct(e,t){this.targetObject[this.propertyName]=e[t]}_setValue_direct_setNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(e,t){const i=this.resolvedProperty;for(let n=0,s=i.length;n!==s;++n)i[n]=e[t++]}_setValue_array_setNeedsUpdate(e,t){const i=this.resolvedProperty;for(let n=0,s=i.length;n!==s;++n)i[n]=e[t++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(e,t){const i=this.resolvedProperty;for(let n=0,s=i.length;n!==s;++n)i[n]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(e,t){this.resolvedProperty[this.propertyIndex]=e[t]}_setValue_arrayElement_setNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(e,t){this.resolvedProperty.fromArray(e,t)}_setValue_fromArray_setNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(e,t){this.bind(),this.getValue(e,t)}_setValue_unbound(e,t){this.bind(),this.setValue(e,t)}bind(){let e=this.node;const t=this.parsedPath,i=t.objectName,n=t.propertyName;let s=t.propertyIndex;if(e||(e=mg.findNode(this.rootNode,t.nodeName),this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!e)return void console.warn("THREE.PropertyBinding: No target node found for track: "+this.path+".");if(i){let n=t.objectIndex;switch(i){case"materials":if(!e.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);e=e.material.materials;break;case"bones":if(!e.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);e=e.skeleton.bones;for(let t=0;t<e.length;t++)if(e[t].name===n){n=t;break}break;case"map":if("map"in e){e=e.map;break}if(!e.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.map)return void console.error("THREE.PropertyBinding: Can not bind to material.map as node.material does not have a map.",this);e=e.material.map;break;default:if(void 0===e[i])return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);e=e[i]}if(void 0!==n){if(void 0===e[n])return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,e);e=e[n]}}const o=e[n];if(void 0===o){const i=t.nodeName;return void console.error("THREE.PropertyBinding: Trying to update property for track: "+i+"."+n+" but it wasn't found.",e)}let r=this.Versioning.None;this.targetObject=e,void 0!==e.needsUpdate?r=this.Versioning.NeedsUpdate:void 0!==e.matrixWorldNeedsUpdate&&(r=this.Versioning.MatrixWorldNeedsUpdate);let a=this.BindingType.Direct;if(void 0!==s){if("morphTargetInfluences"===n){if(!e.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(!e.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);void 0!==e.morphTargetDictionary[s]&&(s=e.morphTargetDictionary[s])}a=this.BindingType.ArrayElement,this.resolvedProperty=o,this.propertyIndex=s}else void 0!==o.fromArray&&void 0!==o.toArray?(a=this.BindingType.HasFromToArray,this.resolvedProperty=o):Array.isArray(o)?(a=this.BindingType.EntireArray,this.resolvedProperty=o):this.propertyName=n;this.getValue=this.GetterByBindingType[a],this.setValue=this.SetterByBindingTypeAndVersioning[a][r]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}mg.Composite=class{constructor(e,t,i){const n=i||mg.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,n)}getValue(e,t){this.bind();const i=this._targetGroup.nCachedObjects_,n=this._bindings[i];void 0!==n&&n.getValue(e,t)}setValue(e,t){const i=this._bindings;for(let n=this._targetGroup.nCachedObjects_,s=i.length;n!==s;++n)i[n].setValue(e,t)}bind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].bind()}unbind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].unbind()}},mg.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},mg.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},mg.prototype.GetterByBindingType=[mg.prototype._getValue_direct,mg.prototype._getValue_array,mg.prototype._getValue_arrayElement,mg.prototype._getValue_toArray],mg.prototype.SetterByBindingTypeAndVersioning=[[mg.prototype._setValue_direct,mg.prototype._setValue_direct_setNeedsUpdate,mg.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[mg.prototype._setValue_array,mg.prototype._setValue_array_setNeedsUpdate,mg.prototype._setValue_array_setMatrixWorldNeedsUpdate],[mg.prototype._setValue_arrayElement,mg.prototype._setValue_arrayElement_setNeedsUpdate,mg.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[mg.prototype._setValue_fromArray,mg.prototype._setValue_fromArray_setNeedsUpdate,mg.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]];class Ag{constructor(e,t,i=null,n=t.blendMode){this._mixer=e,this._clip=t,this._localRoot=i,this.blendMode=n;const s=t.tracks,o=s.length,r=new Array(o),a={endingStart:Fe,endingEnd:Fe};for(let l=0;l!==o;++l){const e=s[l].createInterpolant(null);r[l]=e,e.settings=a}this._interpolantSettings=a,this._interpolants=r,this._propertyBindings=new Array(o),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=2201,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}play(){return this._mixer._activateAction(this),this}stop(){return this._mixer._deactivateAction(this),this.reset()}reset(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()}isRunning(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)}isScheduled(){return this._mixer._isActiveAction(this)}startAt(e){return this._startTime=e,this}setLoop(e,t){return this.loop=e,this.repetitions=t,this}setEffectiveWeight(e){return this.weight=e,this._effectiveWeight=this.enabled?e:0,this.stopFading()}getEffectiveWeight(){return this._effectiveWeight}fadeIn(e){return this._scheduleFading(e,0,1)}fadeOut(e){return this._scheduleFading(e,1,0)}crossFadeFrom(e,t,i){if(e.fadeOut(t),this.fadeIn(t),i){const i=this._clip.duration,n=e._clip.duration,s=n/i,o=i/n;e.warp(1,s,t),this.warp(o,1,t)}return this}crossFadeTo(e,t,i){return e.crossFadeFrom(this,t,i)}stopFading(){const e=this._weightInterpolant;return null!==e&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this}setEffectiveTimeScale(e){return this.timeScale=e,this._effectiveTimeScale=this.paused?0:e,this.stopWarping()}getEffectiveTimeScale(){return this._effectiveTimeScale}setDuration(e){return this.timeScale=this._clip.duration/e,this.stopWarping()}syncWith(e){return this.time=e.time,this.timeScale=e.timeScale,this.stopWarping()}halt(e){return this.warp(this._effectiveTimeScale,0,e)}warp(e,t,i){const n=this._mixer,s=n.time,o=this.timeScale;let r=this._timeScaleInterpolant;null===r&&(r=n._lendControlInterpolant(),this._timeScaleInterpolant=r);const a=r.parameterPositions,l=r.sampleValues;return a[0]=s,a[1]=s+i,l[0]=e/o,l[1]=t/o,this}stopWarping(){const e=this._timeScaleInterpolant;return null!==e&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this}getMixer(){return this._mixer}getClip(){return this._clip}getRoot(){return this._localRoot||this._mixer._root}_update(e,t,i,n){if(!this.enabled)return void this._updateWeight(e);const s=this._startTime;if(null!==s){const n=(e-s)*i;n<0||0===i?t=0:(this._startTime=null,t=i*n)}t*=this._updateTimeScale(e);const o=this._updateTime(t),r=this._updateWeight(e);if(r>0){const e=this._interpolants,t=this._propertyBindings;if(2501===this.blendMode)for(let i=0,n=e.length;i!==n;++i)e[i].evaluate(o),t[i].accumulateAdditive(r);else for(let i=0,s=e.length;i!==s;++i)e[i].evaluate(o),t[i].accumulate(n,r)}}_updateWeight(e){let t=0;if(this.enabled){t=this.weight;const i=this._weightInterpolant;if(null!==i){const n=i.evaluate(e)[0];t*=n,e>i.parameterPositions[1]&&(this.stopFading(),0===n&&(this.enabled=!1))}}return this._effectiveWeight=t,t}_updateTimeScale(e){let t=0;if(!this.paused){t=this.timeScale;const i=this._timeScaleInterpolant;if(null!==i){t*=i.evaluate(e)[0],e>i.parameterPositions[1]&&(this.stopWarping(),0===t?this.paused=!0:this.timeScale=t)}}return this._effectiveTimeScale=t,t}_updateTime(e){const t=this._clip.duration,i=this.loop;let n=this.time+e,s=this._loopCount;const o=2202===i;if(0===e)return-1===s?n:o&&1==(1&s)?t-n:n;if(2200===i){-1===s&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(n>=t)n=t;else{if(!(n<0)){this.time=n;break e}n=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=n,this._mixer.dispatchEvent({type:"finished",action:this,direction:e<0?-1:1})}}else{if(-1===s&&(e>=0?(s=0,this._setEndings(!0,0===this.repetitions,o)):this._setEndings(0===this.repetitions,!0,o)),n>=t||n<0){const i=Math.floor(n/t);n-=t*i,s+=Math.abs(i);const r=this.repetitions-s;if(r<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,n=e>0?t:0,this.time=n,this._mixer.dispatchEvent({type:"finished",action:this,direction:e>0?1:-1});else{if(1===r){const t=e<0;this._setEndings(t,!t,o)}else this._setEndings(!1,!1,o);this._loopCount=s,this.time=n,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:i})}}else this.time=n;if(o&&1==(1&s))return t-n}return n}_setEndings(e,t,i){const n=this._interpolantSettings;i?(n.endingStart=Xe,n.endingEnd=Xe):(n.endingStart=e?this.zeroSlopeAtStart?Xe:Fe:He,n.endingEnd=t?this.zeroSlopeAtEnd?Xe:Fe:He)}_scheduleFading(e,t,i){const n=this._mixer,s=n.time;let o=this._weightInterpolant;null===o&&(o=n._lendControlInterpolant(),this._weightInterpolant=o);const r=o.parameterPositions,a=o.sampleValues;return r[0]=s,a[0]=t,r[1]=s+e,a[1]=i,this}}const Cg=new Float32Array(1);class fg extends ot{constructor(e){super(),this._root=e,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}_bindAction(e,t){const i=e._localRoot||this._root,n=e._clip.tracks,s=n.length,o=e._propertyBindings,r=e._interpolants,a=i.uuid,l=this._bindingsByRootAndName;let g=l[a];void 0===g&&(g={},l[a]=g);for(let c=0;c!==s;++c){const e=n[c],s=e.name;let l=g[s];if(void 0!==l)++l.referenceCount,o[c]=l;else{if(l=o[c],void 0!==l){null===l._cacheIndex&&(++l.referenceCount,this._addInactiveBinding(l,a,s));continue}const n=t&&t._propertyBindings[c].binding.parsedPath;l=new gg(mg.create(i,s,n),e.ValueTypeName,e.getValueSize()),++l.referenceCount,this._addInactiveBinding(l,a,s),o[c]=l}r[c].resultBuffer=l.buffer}}_activateAction(e){if(!this._isActiveAction(e)){if(null===e._cacheIndex){const t=(e._localRoot||this._root).uuid,i=e._clip.uuid,n=this._actionsByClip[i];this._bindAction(e,n&&n.knownActions[0]),this._addInactiveAction(e,i,t)}const t=e._propertyBindings;for(let e=0,i=t.length;e!==i;++e){const i=t[e];0==i.useCount++&&(this._lendBinding(i),i.saveOriginalState())}this._lendAction(e)}}_deactivateAction(e){if(this._isActiveAction(e)){const t=e._propertyBindings;for(let e=0,i=t.length;e!==i;++e){const i=t[e];0==--i.useCount&&(i.restoreOriginalState(),this._takeBackBinding(i))}this._takeBackAction(e)}}_initMemoryManager(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;const e=this;this.stats={actions:{get total(){return e._actions.length},get inUse(){return e._nActiveActions}},bindings:{get total(){return e._bindings.length},get inUse(){return e._nActiveBindings}},controlInterpolants:{get total(){return e._controlInterpolants.length},get inUse(){return e._nActiveControlInterpolants}}}}_isActiveAction(e){const t=e._cacheIndex;return null!==t&&t<this._nActiveActions}_addInactiveAction(e,t,i){const n=this._actions,s=this._actionsByClip;let o=s[t];if(void 0===o)o={knownActions:[e],actionByRoot:{}},e._byClipCacheIndex=0,s[t]=o;else{const t=o.knownActions;e._byClipCacheIndex=t.length,t.push(e)}e._cacheIndex=n.length,n.push(e),o.actionByRoot[i]=e}_removeInactiveAction(e){const t=this._actions,i=t[t.length-1],n=e._cacheIndex;i._cacheIndex=n,t[n]=i,t.pop(),e._cacheIndex=null;const s=e._clip.uuid,o=this._actionsByClip,r=o[s],a=r.knownActions,l=a[a.length-1],g=e._byClipCacheIndex;l._byClipCacheIndex=g,a[g]=l,a.pop(),e._byClipCacheIndex=null;delete r.actionByRoot[(e._localRoot||this._root).uuid],0===a.length&&delete o[s],this._removeInactiveBindingsForAction(e)}_removeInactiveBindingsForAction(e){const t=e._propertyBindings;for(let i=0,n=t.length;i!==n;++i){const e=t[i];0==--e.referenceCount&&this._removeInactiveBinding(e)}}_lendAction(e){const t=this._actions,i=e._cacheIndex,n=this._nActiveActions++,s=t[n];e._cacheIndex=n,t[n]=e,s._cacheIndex=i,t[i]=s}_takeBackAction(e){const t=this._actions,i=e._cacheIndex,n=--this._nActiveActions,s=t[n];e._cacheIndex=n,t[n]=e,s._cacheIndex=i,t[i]=s}_addInactiveBinding(e,t,i){const n=this._bindingsByRootAndName,s=this._bindings;let o=n[t];void 0===o&&(o={},n[t]=o),o[i]=e,e._cacheIndex=s.length,s.push(e)}_removeInactiveBinding(e){const t=this._bindings,i=e.binding,n=i.rootNode.uuid,s=i.path,o=this._bindingsByRootAndName,r=o[n],a=t[t.length-1],l=e._cacheIndex;a._cacheIndex=l,t[l]=a,t.pop(),delete r[s],0===Object.keys(r).length&&delete o[n]}_lendBinding(e){const t=this._bindings,i=e._cacheIndex,n=this._nActiveBindings++,s=t[n];e._cacheIndex=n,t[n]=e,s._cacheIndex=i,t[i]=s}_takeBackBinding(e){const t=this._bindings,i=e._cacheIndex,n=--this._nActiveBindings,s=t[n];e._cacheIndex=n,t[n]=e,s._cacheIndex=i,t[i]=s}_lendControlInterpolant(){const e=this._controlInterpolants,t=this._nActiveControlInterpolants++;let i=e[t];return void 0===i&&(i=new _l(new Float32Array(2),new Float32Array(2),1,Cg),i.__cacheIndex=t,e[t]=i),i}_takeBackControlInterpolant(e){const t=this._controlInterpolants,i=e.__cacheIndex,n=--this._nActiveControlInterpolants,s=t[n];e.__cacheIndex=n,t[n]=e,s.__cacheIndex=i,t[i]=s}clipAction(e,t,i){const n=t||this._root,s=n.uuid;let o="string"==typeof e?Zl.findByName(n,e):e;const r=null!==o?o.uuid:e,a=this._actionsByClip[r];let l=null;if(void 0===i&&(i=null!==o?o.blendMode:ze),void 0!==a){const e=a.actionByRoot[s];if(void 0!==e&&e.blendMode===i)return e;l=a.knownActions[0],null===o&&(o=l._clip)}if(null===o)return null;const g=new Ag(this,o,t,i);return this._bindAction(g,l),this._addInactiveAction(g,r,s),g}existingAction(e,t){const i=t||this._root,n=i.uuid,s="string"==typeof e?Zl.findByName(i,e):e,o=s?s.uuid:e,r=this._actionsByClip[o];return void 0!==r&&r.actionByRoot[n]||null}stopAllAction(){const e=this._actions;for(let t=this._nActiveActions-1;t>=0;--t)e[t].stop();return this}update(e){e*=this.timeScale;const t=this._actions,i=this._nActiveActions,n=this.time+=e,s=Math.sign(e),o=this._accuIndex^=1;for(let l=0;l!==i;++l){t[l]._update(n,e,s,o)}const r=this._bindings,a=this._nActiveBindings;for(let l=0;l!==a;++l)r[l].apply(o);return this}setTime(e){this.time=0;for(let t=0;t<this._actions.length;t++)this._actions[t].time=0;return this.update(e)}getRoot(){return this._root}uncacheClip(e){const t=this._actions,i=e.uuid,n=this._actionsByClip,s=n[i];if(void 0!==s){const e=s.knownActions;for(let i=0,n=e.length;i!==n;++i){const n=e[i];this._deactivateAction(n);const s=n._cacheIndex,o=t[t.length-1];n._cacheIndex=null,n._byClipCacheIndex=null,o._cacheIndex=s,t[s]=o,t.pop(),this._removeInactiveBindingsForAction(n)}delete n[i]}}uncacheRoot(e){const t=e.uuid,i=this._actionsByClip;for(const s in i){const e=i[s].actionByRoot[t];void 0!==e&&(this._deactivateAction(e),this._removeInactiveAction(e))}const n=this._bindingsByRootAndName[t];if(void 0!==n)for(const s in n){const e=n[s];e.restoreOriginalState(),this._removeInactiveBinding(e)}}uncacheAction(e,t){const i=this.existingAction(e,t);null!==i&&(this._deactivateAction(i),this._removeInactiveAction(i))}}class bg extends aa{constructor(e,t,i=1){super(e,t),this.isInstancedInterleavedBuffer=!0,this.meshPerAttribute=i}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}clone(e){const t=super.clone(e);return t.meshPerAttribute=this.meshPerAttribute,t}toJSON(e){const t=super.toJSON(e);return t.isInstancedInterleavedBuffer=!0,t.meshPerAttribute=this.meshPerAttribute,t}}class yg{constructor(e,t,i=0,n=1/0){this.ray=new xi(e,t),this.near=i,this.far=n,this.camera=null,this.layers=new Ni,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(e,t){this.ray.set(e,t)}setFromCamera(e,t){t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize(),this.camera=t):t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld),this.camera=t):console.error("THREE.Raycaster: Unsupported camera type: "+t.type)}intersectObject(e,t=!0,i=[]){return vg(e,this,i,t),i.sort(_g),i}intersectObjects(e,t=!0,i=[]){for(let n=0,s=e.length;n<s;n++)vg(e[n],this,i,t);return i.sort(_g),i}}function _g(e,t){return e.distance-t.distance}function vg(e,t,i,n){if(e.layers.test(t.layers)&&e.raycast(t,i),!0===n){const n=e.children;for(let e=0,s=n.length;e<s;e++)vg(n[e],t,i,!0)}}const xg=new bt;class Bg{constructor(e=new bt(1/0,1/0),t=new bt(-1/0,-1/0)){this.isBox2=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromPoints(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const i=xg.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(e){return this.isEmpty()?e.set(0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,xg).distanceTo(e)}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}const wg=new Qt,Sg=new gs;class Gg extends Ka{constructor(e){const t=new Fn,i=new Wa({color:16777215,vertexColors:!0,toneMapped:!1}),n=[],s=[],o={};function r(e,t){a(e),a(t)}function a(e){n.push(0,0,0),s.push(0,0,0),void 0===o[e]&&(o[e]=[]),o[e].push(n.length/3-1)}r("n1","n2"),r("n2","n4"),r("n4","n3"),r("n3","n1"),r("f1","f2"),r("f2","f4"),r("f4","f3"),r("f3","f1"),r("n1","f1"),r("n2","f2"),r("n3","f3"),r("n4","f4"),r("p","n1"),r("p","n2"),r("p","n3"),r("p","n4"),r("u1","u2"),r("u2","u3"),r("u3","u1"),r("c","t"),r("p","c"),r("cn1","cn2"),r("cn3","cn4"),r("cf1","cf2"),r("cf3","cf4"),t.setAttribute("position",new Mn(n,3)),t.setAttribute("color",new Mn(s,3)),super(t,i),this.type="CameraHelper",this.camera=e,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=o,this.update();const l=new In(16755200),g=new In(16711680),c=new In(43775),d=new In(16777215),h=new In(3355443);this.setColors(l,g,c,d,h)}setColors(e,t,i,n,s){const o=this.geometry.getAttribute("color");o.setXYZ(0,e.r,e.g,e.b),o.setXYZ(1,e.r,e.g,e.b),o.setXYZ(2,e.r,e.g,e.b),o.setXYZ(3,e.r,e.g,e.b),o.setXYZ(4,e.r,e.g,e.b),o.setXYZ(5,e.r,e.g,e.b),o.setXYZ(6,e.r,e.g,e.b),o.setXYZ(7,e.r,e.g,e.b),o.setXYZ(8,e.r,e.g,e.b),o.setXYZ(9,e.r,e.g,e.b),o.setXYZ(10,e.r,e.g,e.b),o.setXYZ(11,e.r,e.g,e.b),o.setXYZ(12,e.r,e.g,e.b),o.setXYZ(13,e.r,e.g,e.b),o.setXYZ(14,e.r,e.g,e.b),o.setXYZ(15,e.r,e.g,e.b),o.setXYZ(16,e.r,e.g,e.b),o.setXYZ(17,e.r,e.g,e.b),o.setXYZ(18,e.r,e.g,e.b),o.setXYZ(19,e.r,e.g,e.b),o.setXYZ(20,e.r,e.g,e.b),o.setXYZ(21,e.r,e.g,e.b),o.setXYZ(22,e.r,e.g,e.b),o.setXYZ(23,e.r,e.g,e.b),o.setXYZ(24,t.r,t.g,t.b),o.setXYZ(25,t.r,t.g,t.b),o.setXYZ(26,t.r,t.g,t.b),o.setXYZ(27,t.r,t.g,t.b),o.setXYZ(28,t.r,t.g,t.b),o.setXYZ(29,t.r,t.g,t.b),o.setXYZ(30,t.r,t.g,t.b),o.setXYZ(31,t.r,t.g,t.b),o.setXYZ(32,i.r,i.g,i.b),o.setXYZ(33,i.r,i.g,i.b),o.setXYZ(34,i.r,i.g,i.b),o.setXYZ(35,i.r,i.g,i.b),o.setXYZ(36,i.r,i.g,i.b),o.setXYZ(37,i.r,i.g,i.b),o.setXYZ(38,n.r,n.g,n.b),o.setXYZ(39,n.r,n.g,n.b),o.setXYZ(40,s.r,s.g,s.b),o.setXYZ(41,s.r,s.g,s.b),o.setXYZ(42,s.r,s.g,s.b),o.setXYZ(43,s.r,s.g,s.b),o.setXYZ(44,s.r,s.g,s.b),o.setXYZ(45,s.r,s.g,s.b),o.setXYZ(46,s.r,s.g,s.b),o.setXYZ(47,s.r,s.g,s.b),o.setXYZ(48,s.r,s.g,s.b),o.setXYZ(49,s.r,s.g,s.b),o.needsUpdate=!0}update(){const e=this.geometry,t=this.pointMap;Sg.projectionMatrixInverse.copy(this.camera.projectionMatrixInverse),Mg("c",t,e,Sg,0,0,-1),Mg("t",t,e,Sg,0,0,1),Mg("n1",t,e,Sg,-1,-1,-1),Mg("n2",t,e,Sg,1,-1,-1),Mg("n3",t,e,Sg,-1,1,-1),Mg("n4",t,e,Sg,1,1,-1),Mg("f1",t,e,Sg,-1,-1,1),Mg("f2",t,e,Sg,1,-1,1),Mg("f3",t,e,Sg,-1,1,1),Mg("f4",t,e,Sg,1,1,1),Mg("u1",t,e,Sg,.7,1.1,-1),Mg("u2",t,e,Sg,-.7,1.1,-1),Mg("u3",t,e,Sg,0,2,-1),Mg("cf1",t,e,Sg,-1,0,1),Mg("cf2",t,e,Sg,1,0,1),Mg("cf3",t,e,Sg,0,-1,1),Mg("cf4",t,e,Sg,0,1,1),Mg("cn1",t,e,Sg,-1,0,-1),Mg("cn2",t,e,Sg,1,0,-1),Mg("cn3",t,e,Sg,0,-1,-1),Mg("cn4",t,e,Sg,0,1,-1),e.getAttribute("position").needsUpdate=!0}dispose(){this.geometry.dispose(),this.material.dispose()}}function Mg(e,t,i,n,s,o,r){wg.set(s,o,r).unproject(n);const a=t[e];if(void 0!==a){const e=i.getAttribute("position");for(let t=0,i=a.length;t<i;t++)e.setXYZ(a[t],wg.x,wg.y,wg.z)}}class Rg extends Ka{constructor(e,t=16776960){const i=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new Fn;n.setIndex(new Bn(i,1)),n.setAttribute("position",new Mn([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3)),super(n,new Wa({color:t,toneMapped:!1})),this.box=e,this.type="Box3Helper",this.geometry.computeBoundingSphere()}updateMatrixWorld(e){const t=this.box;t.isEmpty()||(t.getCenter(this.position),t.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(e))}dispose(){this.geometry.dispose(),this.material.dispose()}}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:o}})),"undefined"!=typeof window&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=o);const Tg="vertex",Zg="none",Vg="frame",Wg="render",Eg="object",Ng=["fragment","vertex"],Fg=["setup","analyze","generate"],Xg=[...Ng,"compute"],Hg=["x","y","z","w"];function zg(e){let t="{";!0===e.isNode&&(t+=`uuid:"${e.uuid}"`);for(const{property:i,index:n,childNode:s}of Lg(e)){let e=zg(s);e.includes(",")||(e=e.slice(e.indexOf('"'),e.indexOf("}"))),t+=`,${i}${void 0!==n?"/"+n:""}:${e}`}return t+="}",t}function*Lg(e,t=!1){for(const i in e){if(!0===i.startsWith("_"))continue;const n=e[i];if(!0===Array.isArray(n))for(let e=0;e<n.length;e++){const s=n[e];s&&(!0===s.isNode||t&&"function"==typeof s.toJSON)&&(yield{property:i,index:e,childNode:s})}else if(n&&!0===n.isNode)yield{property:i,childNode:n};else if("object"==typeof n)for(const e in n){const s=n[e];s&&(!0===s.isNode||t&&"function"==typeof s.toJSON)&&(yield{property:i,index:e,childNode:s})}}}function Dg(e){if(null==e)return null;const t=typeof e;return!0===e.isNode?"node":"number"===t?"float":"boolean"===t?"bool":"string"===t?"string":"function"===t?"shader":!0===e.isVector2?"vec2":!0===e.isVector3?"vec3":!0===e.isVector4?"vec4":!0===e.isMatrix3?"mat3":!0===e.isMatrix4?"mat4":!0===e.isColor?"color":e instanceof ArrayBuffer?"ArrayBuffer":null}function Kg(e,...t){const i=e?e.slice(-4):void 0;return 1===t.length&&("vec2"===i?t=[t[0],t[0]]:"vec3"===i?t=[t[0],t[0],t[0]]:"vec4"===i&&(t=[t[0],t[0],t[0],t[0]])),"color"===e?new In(...t):"vec2"===i?new bt(...t):"vec3"===i?new Qt(...t):"vec4"===i?new Dt(...t):"mat3"===i?new yt(...t):"mat4"===i?new Bi(...t):"bool"===e?t[0]||!1:"float"===e||"int"===e||"uint"===e?t[0]||0:"string"===e?t[0]||"":"ArrayBuffer"===e?(n=t[0],Uint8Array.from(atob(n),(e=>e.charCodeAt(0))).buffer):null;var n}const Yg=new Map;let Pg=0;const kg=class extends ot{constructor(e=null){super(),this.nodeType=e,this.updateType=Zg,this.updateBeforeType=Zg,this.uuid=ft.generateUUID(),this.isNode=!0,Object.defineProperty(this,"id",{value:Pg++})}get type(){return this.constructor.type}getSelf(){return this.self||this}updateReference(){return this}isGlobal(){return!1}*getChildren(){for(const{childNode:e}of Lg(this))yield e}dispose(){this.dispatchEvent({type:"dispose"})}traverse(e){e(this);for(const t of this.getChildren())t.traverse(e)}getCacheKey(){return zg(this)}getHash(){return this.uuid}getUpdateType(){return this.updateType}getUpdateBeforeType(){return this.updateBeforeType}getNodeType(e){const t=e.getNodeProperties(this);return t.outputNode?t.outputNode.getNodeType(e):this.nodeType}getShared(e){const t=this.getHash(e);return e.getNodeFromHash(t)||this}setup(e){const t=e.getNodeProperties(this);for(const i of this.getChildren())t["_node"+i.id]=i;return null}construct(e){return console.warn("THREE.Node: construct() is deprecated. Use setup() instead."),this.setup(e)}analyze(e){const t=e.getDataFromNode(this);if(t.dependenciesCount=void 0===t.dependenciesCount?1:t.dependenciesCount+1,1===t.dependenciesCount){const t=e.getNodeProperties(this);for(const i of Object.values(t))i&&!0===i.isNode&&i.build(e)}}generate(e,t){const{outputNode:i}=e.getNodeProperties(this);if(i&&!0===i.isNode)return i.build(e,t)}updateBefore(){console.warn("Abstract function.")}update(){console.warn("Abstract function.")}build(e,t=null){const i=this.getShared(e);if(this!==i)return i.build(e,t);e.addNode(this),e.addChain(this);let n=null;const s=e.getBuildStage();if("setup"===s){const t=e.getNodeProperties(this);if(!0!==t.initialized||!1===e.context.tempRead){const i=e.stack.nodes.length;t.initialized=!0,t.outputNode=this.setup(e),null!==t.outputNode&&e.stack.nodes.length!==i&&(t.outputNode=e.stack);for(const n of Object.values(t))n&&!0===n.isNode&&n.build(e)}}else if("analyze"===s)this.analyze(e);else if("generate"===s){if(1===this.generate.length){const i=this.getNodeType(e),s=e.getDataFromNode(this);n=s.snippet,void 0===n&&(n=this.generate(e)||"",s.snippet=n),n=e.format(n,i,t)}else n=this.generate(e,t)||""}return e.removeChain(this),n}getSerializeChildren(){return Lg(this)}serialize(e){const t=this.getSerializeChildren(),i={};for(const{property:n,index:s,childNode:o}of t)void 0!==s?(void 0===i[n]&&(i[n]=Number.isInteger(s)?[]:{}),i[n][s]=o.toJSON(e.meta).uuid):i[n]=o.toJSON(e.meta).uuid;Object.keys(i).length>0&&(e.inputNodes=i)}deserialize(e){if(void 0!==e.inputNodes){const t=e.meta.nodes;for(const i in e.inputNodes)if(Array.isArray(e.inputNodes[i])){const n=[];for(const s of e.inputNodes[i])n.push(t[s]);this[i]=n}else if("object"==typeof e.inputNodes[i]){const n={};for(const s in e.inputNodes[i]){const o=e.inputNodes[i][s];n[s]=t[o]}this[i]=n}else{const n=e.inputNodes[i];this[i]=t[n]}}}toJSON(e){const{uuid:t,type:i}=this,n=void 0===e||"string"==typeof e;n&&(e={textures:{},images:{},nodes:{}});let s=e.nodes[t];function o(e){const t=[];for(const i in e){const n=e[i];delete n.metadata,t.push(n)}return t}if(void 0===s&&(s={uuid:t,type:i,meta:e,metadata:{version:4.6,type:"Node",generator:"Node.toJSON"}},!0!==n&&(e.nodes[s.uuid]=s),this.serialize(s),delete s.meta),n){const t=o(e.textures),i=o(e.images),n=o(e.nodes);t.length>0&&(s.textures=t),i.length>0&&(s.images=i),n.length>0&&(s.nodes=n)}return s}};function Og(e,t){if("function"!=typeof t||!e)throw new Error(`Node class ${e} is not a class`);if(Yg.has(e))throw new Error(`Redefinition of node class ${e}`);Yg.set(e,t),t.type=e}class Ug extends kg{constructor(e,t=null){super(t),this.isInputNode=!0,this.value=e,this.precision=null}getNodeType(){return null===this.nodeType?Dg(this.value):this.nodeType}getInputType(e){return this.getNodeType(e)}setPrecision(e){return this.precision=e,this}serialize(e){super.serialize(e),e.value=this.value,this.value&&this.value.toArray&&(e.value=this.value.toArray()),e.valueType=Dg(this.value),e.nodeType=this.nodeType,"ArrayBuffer"===e.valueType&&(e.value=function(e){let t="";const i=new Uint8Array(e);for(let n=0;n<i.length;n++)t+=String.fromCharCode(i[n]);return btoa(t)}(e.value)),e.precision=this.precision}deserialize(e){super.deserialize(e),this.nodeType=e.nodeType,this.value=Array.isArray(e.value)?Kg(e.valueType,...e.value):e.value,this.precision=e.precision||null,this.value&&this.value.fromArray&&(this.value=this.value.fromArray(e.value))}generate(){console.warn("Abstract function.")}}const Qg=Ug;Og("InputNode",Ug);class Jg extends kg{constructor(e,t){super(),this.node=e,this.indexNode=t,this.isArrayElementNode=!0}getNodeType(e){return this.node.getNodeType(e)}generate(e){return`${this.node.build(e)}[ ${this.indexNode.build(e,"uint")} ]`}}const jg=Jg;Og("ArrayElementNode",Jg);class qg extends kg{constructor(e,t){super(),this.node=e,this.convertTo=t}getNodeType(e){const t=this.node.getNodeType(e);let i=null;for(const n of this.convertTo.split("|"))null!==i&&e.getTypeLength(t)!==e.getTypeLength(n)||(i=n);return i}serialize(e){super.serialize(e),e.convertTo=this.convertTo}deserialize(e){super.deserialize(e),this.convertTo=e.convertTo}generate(e,t){const i=this.node,n=this.getNodeType(e),s=i.build(e,n);return e.format(s,n,t)}}const $g=qg;Og("ConvertNode",qg);class ec extends kg{constructor(e){super(e),this.isTempNode=!0}hasDependencies(e){return e.getDataFromNode(this).dependenciesCount>1}build(e,t){if("generate"===e.getBuildStage()){const i=e.getVectorType(this.getNodeType(e,t)),n=e.getDataFromNode(this);if(!1!==e.context.tempRead&&void 0!==n.propertyName)return e.format(n.propertyName,i,t);if(!1!==e.context.tempWrite&&"void"!==i&&"void"!==t&&this.hasDependencies(e)){const s=super.build(e,i),o=e.getVarFromNode(this,null,i),r=e.getPropertyName(o);return e.addLineFlowCode(`${r} = ${s}`),n.snippet=s,n.propertyName=r,e.format(n.propertyName,i,t)}}return super.build(e,t)}}const tc=ec;Og("TempNode",ec);class ic extends tc{constructor(e=[],t=null){super(t),this.nodes=e}getNodeType(e){return null!==this.nodeType?e.getVectorType(this.nodeType):e.getTypeFromLength(this.nodes.reduce(((t,i)=>t+e.getTypeLength(i.getNodeType(e))),0))}generate(e,t){const i=this.getNodeType(e),n=this.nodes,s=e.getPrimitiveType(i),o=[];for(const a of n){let t=a.build(e);const i=e.getPrimitiveType(a.getNodeType(e));i!==s&&(t=e.format(t,i,s)),o.push(t)}const r=`${e.getType(i)}( ${o.join(", ")} )`;return e.format(r,i,t)}}const nc=ic;Og("JoinNode",ic);const sc=Hg.join("");class oc extends kg{constructor(e,t="x"){super(),this.node=e,this.components=t,this.isSplitNode=!0}getVectorLength(){let e=this.components.length;for(const t of this.components)e=Math.max(Hg.indexOf(t)+1,e);return e}getNodeType(e){return e.getTypeFromLength(this.components.length)}generate(e,t){const i=this.node,n=e.getTypeLength(i.getNodeType(e));let s=null;if(n>1){let o=null;this.getVectorLength()>=n&&(o=e.getTypeFromLength(this.getVectorLength()));const r=i.build(e,o);s=this.components.length===n&&this.components===sc.slice(0,this.components.length)?e.format(r,o,t):e.format(`${r}.${this.components}`,this.getNodeType(e),t)}else s=i.build(e,t);return s}serialize(e){super.serialize(e),e.components=this.components}deserialize(e){super.deserialize(e),this.components=e.components}}const rc=oc;Og("SplitNode",oc);class ac extends tc{constructor(e,t,i){super(),this.sourceNode=e,this.components=t,this.targetNode=i}getNodeType(e){return this.sourceNode.getNodeType(e)}generate(e){const{sourceNode:t,components:i,targetNode:n}=this,s=this.getNodeType(e),o=e.getTypeFromLength(i.length),r=n.build(e,o),a=t.build(e,s),l=e.getTypeLength(s),g=[];for(let c=0;c<l;c++){const e=Hg[c];e===i[0]?(g.push(r),c+=i.length-1):g.push(a+"."+e)}return`${e.getType(s)}( ${g.join(", ")} )`}}const lc=ac;Og("SetNode",ac);class gc extends Qg{constructor(e,t=null){super(e,t),this.isConstNode=!0}generateConst(e){return e.getConst(this.getNodeType(e),this.value)}generate(e,t){const i=this.getNodeType(e);return e.format(this.generateConst(e),i,t)}}const cc=gc;Og("ConstNode",gc);let dc=null;const hc=new Map;function uc(e,t){if(hc.has(e))throw new Error(`Redefinition of node element ${e}`);if("function"!=typeof t)throw new Error(`Node element ${e} is not a function`);hc.set(e,t)}const Ic=e=>e.replace(/r|s/g,"x").replace(/g|t/g,"y").replace(/b|p/g,"z").replace(/a|q/g,"w"),pc={setup(e,t){const i=t.shift();return e(Xc(i),...t)},get(e,t,i){if("string"==typeof t&&void 0===e[t]){if(!0!==e.isStackNode&&"assign"===t)return(...e)=>dc.assign(i,...e);if(hc.has(t)){const n=hc.get(t);return e.isStackNode?(...e)=>i.add(n(...e)):(...e)=>n(i,...e)}if("self"===t)return e;if(t.endsWith("Assign")&&hc.has(t.slice(0,t.length-6))){const n=hc.get(t.slice(0,t.length-6));return e.isStackNode?(...e)=>i.assign(e[0],n(...e)):(...e)=>i.assign(n(i,...e))}if(!0===/^[xyzwrgbastpq]{1,4}$/.test(t))return t=Ic(t),Fc(new rc(i,t));if(!0===/^set[XYZWRGBASTPQ]{1,4}$/.test(t))return t=(t=Ic(t.slice(3).toLowerCase())).split("").sort().join(""),i=>Fc(new lc(e,t,i));if("width"===t||"height"===t||"depth"===t)return"width"===t?t="x":"height"===t?t="y":"depth"===t&&(t="z"),Fc(new rc(e,t));if(!0===/^\d+$/.test(t))return Fc(new jg(i,new cc(Number(t),"uint")))}return Reflect.get(e,t,i)},set:(e,t,i,n)=>"string"!=typeof t||void 0!==e[t]||!0!==/^[xyzwrgbastpq]{1,4}$/.test(t)&&"width"!==t&&"height"!==t&&"depth"!==t&&!0!==/^\d+$/.test(t)?Reflect.set(e,t,i,n):(n[t].assign(i),!0)},mc=new WeakMap,Ac=new WeakMap,Cc=function(e,t=null){for(const i in e)e[i]=Fc(e[i],t);return e},fc=function(e,t=null){const i=e.length;for(let n=0;n<i;n++)e[n]=Fc(e[n],t);return e},bc=function(e,t=null,i=null,n=null){const s=e=>Fc(null!==n?Object.assign(e,n):e);return null===t?(...t)=>s(new e(...Hc(t))):null!==i?(i=Fc(i),(...n)=>s(new e(t,...Hc(n),i))):(...i)=>s(new e(t,...Hc(i)))},yc=function(e,...t){return Fc(new e(...Hc(t)))};class _c extends kg{constructor(e,t){super(),this.shaderNode=e,this.inputNodes=t}getNodeType(e){const{outputNode:t}=e.getNodeProperties(this);return t?t.getNodeType(e):super.getNodeType(e)}call(e){const{shaderNode:t,inputNodes:i}=this;if(t.layout){let n=Ac.get(e.constructor);void 0===n&&(n=new WeakMap,Ac.set(e.constructor,n));let s=n.get(t);return void 0===s&&(s=Fc(e.buildFunctionNode(t)),n.set(t,s)),Fc(s.call(i))}const n=t.jsFunc,s=null!==i?n(i,e.stack,e):n(e.stack,e);return Fc(s)}setup(e){return e.addStack(),e.stack.outputNode=this.call(e),e.removeStack()}generate(e,t){const{outputNode:i}=e.getNodeProperties(this);return null===i?this.call(e).build(e,t):super.generate(e,t)}}class vc extends kg{constructor(e){super(),this.jsFunc=e,this.layout=null}get isArrayInput(){return/^\(\s+?\[/.test(this.jsFunc.toString())}setLayout(e){return this.layout=e,this}call(e=null){return Xc(e),Fc(new _c(this,e))}setup(){return this.call()}}const xc=[!1,!0],Bc=[0,1,2,3],wc=[-1,-2],Sc=[.5,1.5,1/3,1e-6,1e6,Math.PI,2*Math.PI,1/Math.PI,2/Math.PI,1/(2*Math.PI),Math.PI/2],Gc=new Map;for(const tq of xc)Gc.set(tq,new cc(tq));const Mc=new Map;for(const tq of Bc)Mc.set(tq,new cc(tq,"uint"));const Rc=new Map([...Mc].map((e=>new cc(e.value,"int"))));for(const tq of wc)Rc.set(tq,new cc(tq,"int"));const Tc=new Map([...Rc].map((e=>new cc(e.value))));for(const tq of Sc)Tc.set(tq,new cc(tq));for(const tq of Sc)Tc.set(-tq,new cc(-tq));const Zc={bool:Gc,uint:Mc,ints:Rc,float:Tc},Vc=new Map([...Gc,...Tc]),Wc=(e,t)=>Vc.has(e)?Vc.get(e):!0===e.isNode?e:new cc(e,t),Ec=function(e,t=null){return(...i)=>{if((0===i.length||!["bool","float","int","uint"].includes(e)&&i.every((e=>"object"!=typeof e)))&&(i=[Kg(e,...i)]),1===i.length&&null!==t&&t.has(i[0]))return Fc(t.get(i[0]));if(1===i.length){const t=Wc(i[0],e);return(e=>{try{return e.getNodeType()}catch(t){return}})(t)===e?Fc(t):Fc(new $g(t,e))}const n=i.map((e=>Wc(e)));return Fc(new nc(n,e))}};function Nc(e){return new Proxy(new vc(e),pc)}const Fc=(e,t=null)=>function(e,t=null){const i=Dg(e);if("node"===i){let t=mc.get(e);return void 0===t&&(t=new Proxy(e,pc),mc.set(e,t),mc.set(t,t)),t}return null===t&&("float"===i||"boolean"===i)||i&&"shader"!==i&&"string"!==i?Fc(Wc(e,t)):"shader"===i?Dc(e):e}(e,t),Xc=(e,t=null)=>new Cc(e,t),Hc=(e,t=null)=>new fc(e,t),zc=(...e)=>new bc(...e),Lc=(...e)=>new yc(...e),Dc=e=>{const t=new Nc(e),i=(...e)=>{let i;return Xc(e),i=e[0]&&e[0].isNode?[...e]:e[0],t.call(i)};return i.shaderNode=t,i.setLayout=e=>(t.setLayout(e),i),i};Og("ShaderNode",Nc);const Kc=e=>dc=e,Yc=()=>dc;uc("append",(function(e){return dc&&dc.add(e),e}));const Pc=new Ec("color"),kc=new Ec("float",Zc.float),Oc=new Ec("int",Zc.int),Uc=new Ec("uint",Zc.uint),Qc=new Ec("bool",Zc.bool),Jc=new Ec("vec2"),jc=new Ec("ivec2"),qc=new Ec("uvec2"),$c=new Ec("bvec2"),ed=new Ec("vec3"),td=new Ec("ivec3"),id=new Ec("uvec3"),nd=new Ec("bvec3"),sd=new Ec("vec4"),od=new Ec("ivec4"),rd=new Ec("uvec4"),ad=new Ec("bvec4"),ld=new Ec("mat3"),gd=new Ec("imat3"),cd=new Ec("umat3"),dd=new Ec("bmat3"),hd=new Ec("mat4"),ud=new Ec("imat4"),Id=new Ec("umat4"),pd=new Ec("bmat4");uc("color",Pc),uc("float",kc),uc("int",Oc),uc("uint",Uc),uc("bool",Qc),uc("vec2",Jc),uc("ivec2",jc),uc("uvec2",qc),uc("bvec2",$c),uc("vec3",ed),uc("ivec3",td),uc("uvec3",id),uc("bvec3",nd),uc("vec4",sd),uc("ivec4",od),uc("uvec4",rd),uc("bvec4",ad),uc("mat3",ld),uc("imat3",gd),uc("umat3",cd),uc("bmat3",dd),uc("mat4",hd),uc("imat4",ud),uc("umat4",Id),uc("bmat4",pd),uc("string",((e="")=>Fc(new cc(e,"string")))),uc("arrayBuffer",(e=>Fc(new cc(e,"ArrayBuffer"))));uc("element",zc(jg)),uc("convert",((e,t)=>Fc(new $g(Fc(e),t))));class md extends Qg{constructor(e,t=null){super(e,t),this.isUniformNode=!0}getUniformHash(e){return this.getHash(e)}generate(e,t){const i=this.getNodeType(e),n=this.getUniformHash(e);let s=e.getNodeFromHash(n);void 0===s&&(e.setHashNode(this,n),s=this);const o=s.getInputType(e),r=e.getUniformFromNode(s,o,e.shaderStage,e.context.label),a=e.getPropertyName(r);return void 0!==e.context.label&&delete e.context.label,e.format(a,i,t)}}const Ad=md,Cd=(e,t)=>{const i=(e=>null!=e?e.nodeType||e.convertTo||("string"==typeof e?e:null):null)(t||e),n=e&&!0===e.isNode?e.node&&e.node.value||e.value:e;return Fc(new md(n,i))};Og("UniformNode",md);class fd extends kg{constructor(e,t=null){super(),this.node=e,this.name=t,this.isVaryingNode=!0}isGlobal(){return!0}getHash(e){return this.name||super.getHash(e)}getNodeType(e){return this.node.getNodeType(e)}generate(e){const{name:t,node:i}=this,n=this.getNodeType(e),s=e.getVaryingFromNode(this,n);s.needsInterpolation||(s.needsInterpolation="fragment"===e.shaderStage),null!==t&&(s.name=t);const o=e.getPropertyName(s,Tg);return e.flowNodeFromShaderStage(Tg,i,n,o),e.getPropertyName(s)}}const bd=zc(fd);uc("varying",bd),Og("VaryingNode",fd);class yd extends kg{constructor(e,t=null){super(t),this._attributeName=e}getHash(e){return this.getAttributeName(e)}getNodeType(e){let t=super.getNodeType(e);if(null===t){const i=this.getAttributeName(e);if(e.hasGeometryAttribute(i)){const n=e.geometry.getAttribute(i);t=e.getTypeFromAttribute(n)}else t="float"}return t}setAttributeName(e){return this._attributeName=e,this}getAttributeName(){return this._attributeName}generate(e){const t=this.getAttributeName(e),i=this.getNodeType(e);if(!0===e.hasGeometryAttribute(t)){const n=e.geometry.getAttribute(t),s=e.getTypeFromAttribute(n),o=e.getAttribute(t,s);if("vertex"===e.shaderStage)return e.format(o.name,s,i);return bd(this).build(e,i)}return console.warn(`AttributeNode: Attribute "${t}" not found.`),e.getConst(i)}}const _d=(e,t)=>Fc(new yd(e,t));Og("AttributeNode",yd);let vd=0;const xd=class{constructor(){this.id=vd++,this.nodesData=new WeakMap}getNodeData(e){return this.nodesData.get(e)}setNodeData(e,t){this.nodesData.set(e,t)}};class Bd extends kg{constructor(e,t=new xd){super(),this.isCacheNode=!0,this.node=e,this.cache=t}getNodeType(e){return this.node.getNodeType(e)}build(e,...t){const i=e.getCache();e.setCache(this.cache);const n=this.node.build(e,...t);return e.setCache(i),n}}const wd=zc(Bd);uc("cache",wd),Og("CacheNode",Bd);class Sd extends kg{constructor(e,t={}){super(),this.isContextNode=!0,this.node=e,this.context=t}getNodeType(e){return this.node.getNodeType(e)}setup(e){const t=e.getContext();e.setContext({...e.context,...this.context});const i=this.node.build(e);return e.setContext(t),i}generate(e,t){const i=e.getContext();e.setContext({...e.context,...this.context});const n=this.node.build(e,t);return e.setContext(i),n}}const Gd=zc(Sd),Md=(e,t)=>Gd(e,{label:t});uc("context",Gd),uc("label",Md),Og("ContextNode",Sd);class Rd extends kg{constructor(e,t=null){super(),this.node=e,this.name=t}isGlobal(){return!0}getHash(e){return this.name||super.getHash(e)}getNodeType(e){return this.node.getNodeType(e)}generate(e){const{node:t,name:i}=this,n=e.getVarFromNode(this,i,e.getVectorType(this.getNodeType(e))),s=e.getPropertyName(n),o=t.build(e,n.type);return e.addLineFlowCode(`${s} = ${o}`),s}}const Td=zc(Rd);uc("temp",Td),uc("toVar",((...e)=>Td(...e).append())),Og("VarNode",Rd);const Zd=class{constructor(e,t,i=null){this.isNodeAttribute=!0,this.name=e,this.type=t,this.node=i}};const Vd=class{constructor(e,t,i,n=void 0){this.isNodeUniform=!0,this.name=e,this.type=t,this.node=i.getSelf(),this.needsUpdate=n}get value(){return this.node.value}set value(e){this.node.value=e}};const Wd=class{constructor(e,t){this.isNodeVar=!0,this.name=e,this.type=t}};const Ed=class extends Wd{constructor(e,t){super(e,t),this.needsInterpolation=!1,this.isNodeVarying=!0}};const Nd=class{constructor(e,t,i=""){this.name=e,this.type=t,this.code=i,Object.defineProperty(this,"isNodeCode",{value:!0})}};const Fd=class{constructor(){this.keywords=[],this.nodes=[],this.keywordsCallback={}}getNode(e){let t=this.nodes[e];return void 0===t&&void 0!==this.keywordsCallback[e]&&(t=this.keywordsCallback[e](e),this.nodes[e]=t),t}addKeyword(e,t){return this.keywords.push(e),this.keywordsCallback[e]=t,this}parse(e){const t=this.keywords,i=new RegExp(`\\b${t.join("\\b|\\b")}\\b`,"g"),n=e.match(i),s=[];if(null!==n)for(const o of n){const e=this.getNode(o);void 0!==e&&-1===s.indexOf(e)&&s.push(e)}return s}include(e,t){const i=this.parse(t);for(const n of i)n.build(e)}};class Xd extends kg{constructor(e,t=null){super(e),this.name=t,this.isPropertyNode=!0}getHash(e){return this.name||super.getHash(e)}isGlobal(){return!0}generate(e){return e.getPropertyName(e.getVarFromNode(this,this.name))}}const Hd=(e,t)=>Fc(new Xd(e,t)),zd=Lc(Xd,"vec4","DiffuseColor"),Ld=Lc(Xd,"float","Roughness");Lc(Xd,"float","Metalness"),Lc(Xd,"float","Clearcoat");const Dd=Lc(Xd,"float","ClearcoatRoughness");Lc(Xd,"vec3","Sheen"),Lc(Xd,"float","SheenRoughness"),Lc(Xd,"float","Iridescence"),Lc(Xd,"float","IridescenceIOR"),Lc(Xd,"float","IridescenceThickness"),Lc(Xd,"color","SpecularColor"),Lc(Xd,"float","Shininess");const Kd=Lc(Xd,"vec4","Output");Lc(Xd,"float","dashSize"),Lc(Xd,"float","gapSize"),Lc(Xd,"float","pointWidth"),Og("PropertyNode",Xd);class Yd extends Xd{constructor(e,t=null){super(e,t),this.isParameterNode=!0}getHash(){return this.uuid}generate(){return this.name}}const Pd=Yd;Og("ParameterNode",Yd);class kd extends yd{constructor(e=0){super(null,"vec2"),this.isUVNode=!0,this.index=e}getAttributeName(){const e=this.index;return"uv"+(e>0?e:"")}serialize(e){super.serialize(e),e.index=this.index}deserialize(e){super.deserialize(e),this.index=e.index}}Og("UVNode",kd);class Od extends kg{constructor(e,t=null){super("uvec2"),this.isTextureSizeNode=!0,this.textureNode=e,this.levelNode=t}generate(e,t){const i=this.textureNode.build(e,"property"),n=this.levelNode.build(e,"int");return e.format(`${e.getMethod("textureDimensions")}( ${i}, ${n} )`,this.getNodeType(e),t)}}const Ud=zc(Od);uc("textureSize",Ud),Og("TextureSizeNode",Od);class Qd extends tc{constructor(e,t,i,...n){if(super(),this.op=e,n.length>0){let t=i;for(let i=0;i<n.length;i++)t=new Qd(e,t,n[i]);i=t}this.aNode=t,this.bNode=i}getNodeType(e,t){const i=this.op,n=this.aNode,s=this.bNode,o=n.getNodeType(e),r=s.getNodeType(e);if("void"===o||"void"===r)return"void";if("%"===i)return o;if("&"===i||"|"===i||"^"===i||">>"===i||"<<"===i)return e.getIntegerType(o);if("=="===i||"&&"===i||"||"===i||"^^"===i)return"bool";if("<"===i||">"===i||"<="===i||">="===i){const i=t?e.getTypeLength(t):Math.max(e.getTypeLength(o),e.getTypeLength(r));return i>1?`bvec${i}`:"bool"}return"float"===o&&e.isMatrix(r)?r:e.isMatrix(o)&&e.isVector(r)?e.getVectorFromMatrix(o):e.isVector(o)&&e.isMatrix(r)?e.getVectorFromMatrix(r):e.getTypeLength(r)>e.getTypeLength(o)?r:o}generate(e,t){const i=this.op,n=this.aNode,s=this.bNode,o=this.getNodeType(e,t);let r=null,a=null;"void"!==o?(r=n.getNodeType(e),a=s.getNodeType(e),"<"===i||">"===i||"<="===i||">="===i||"=="===i?e.isVector(r)?a=r:r=a="float":">>"===i||"<<"===i?(r=o,a=e.changeComponentType(a,"uint")):e.isMatrix(r)&&e.isVector(a)?a=e.getVectorFromMatrix(r):r=e.isVector(r)&&e.isMatrix(a)?e.getVectorFromMatrix(a):a=o):r=a=o;const l=n.build(e,r),g=s.build(e,a),c=e.getTypeLength(t);return"void"!==t?"<"===i&&c>1?e.format(`${e.getMethod("lessThan")}( ${l}, ${g} )`,o,t):"<="===i&&c>1?e.format(`${e.getMethod("lessThanEqual")}( ${l}, ${g} )`,o,t):">"===i&&c>1?e.format(`${e.getMethod("greaterThan")}( ${l}, ${g} )`,o,t):">="===i&&c>1?e.format(`${e.getMethod("greaterThanEqual")}( ${l}, ${g} )`,o,t):e.format(`( ${l} ${this.op} ${g} )`,o,t):"void"!==r?e.format(`${l} ${this.op} ${g}`,o,t):void 0}serialize(e){super.serialize(e),e.op=this.op}deserialize(e){super.deserialize(e),this.op=e.op}}const Jd=zc(Qd,"+"),jd=zc(Qd,"-"),qd=zc(Qd,"*"),$d=zc(Qd,"/"),eh=zc(Qd,"%"),th=zc(Qd,"=="),ih=zc(Qd,"!="),nh=zc(Qd,"<"),sh=zc(Qd,">"),oh=zc(Qd,"<="),rh=zc(Qd,">="),ah=zc(Qd,"&&"),lh=zc(Qd,"||"),gh=zc(Qd,"^^"),ch=zc(Qd,"&"),dh=zc(Qd,"|"),hh=zc(Qd,"^"),uh=zc(Qd,"<<"),Ih=zc(Qd,">>");uc("add",Jd),uc("sub",jd),uc("mul",qd),uc("div",$d),uc("remainder",eh),uc("equal",th),uc("notEqual",ih),uc("lessThan",nh),uc("greaterThan",sh),uc("lessThanEqual",oh),uc("greaterThanEqual",rh),uc("and",ah),uc("or",lh),uc("xor",gh),uc("bitAnd",ch),uc("bitOr",dh),uc("bitXor",hh),uc("shiftLeft",uh),uc("shiftRight",Ih),Og("OperatorNode",Qd);class ph extends tc{constructor(e,t,i=null,n=null){super(),this.method=e,this.aNode=t,this.bNode=i,this.cNode=n}getInputType(e){const t=this.aNode.getNodeType(e),i=this.bNode?this.bNode.getNodeType(e):null,n=this.cNode?this.cNode.getNodeType(e):null,s=e.isMatrix(t)?0:e.getTypeLength(t),o=e.isMatrix(i)?0:e.getTypeLength(i),r=e.isMatrix(n)?0:e.getTypeLength(n);return s>o&&s>r?t:o>r?i:r>s?n:t}getNodeType(e){const t=this.method;return t===ph.LENGTH||t===ph.DISTANCE||t===ph.DOT?"float":t===ph.CROSS?"vec3":this.getInputType(e)}generate(e,t){const i=this.method,n=this.getNodeType(e),s=this.getInputType(e),o=this.aNode,r=this.bNode,a=this.cNode,l=!0===e.renderer.isWebGLRenderer;if(i===ph.TRANSFORM_DIRECTION){let i=o,n=r;e.isMatrix(i.getNodeType(e))?n=sd(ed(n),0):i=sd(ed(i),0);const s=qd(i,n).xyz;return Sh(s).build(e,t)}if(i===ph.NEGATE)return e.format("( - "+o.build(e,s)+" )",n,t);if(i===ph.ONE_MINUS)return jd(1,o).build(e,t);if(i===ph.RECIPROCAL)return $d(1,o).build(e,t);if(i===ph.DIFFERENCE)return Eh(jd(o,r)).build(e,t);{const g=[];return i===ph.CROSS?g.push(o.build(e,n),r.build(e,n)):i===ph.STEP?g.push(o.build(e,1===e.getTypeLength(o.getNodeType(e))?"float":s),r.build(e,s)):l&&(i===ph.MIN||i===ph.MAX)||i===ph.MOD?g.push(o.build(e,s),r.build(e,1===e.getTypeLength(r.getNodeType(e))?"float":s)):i===ph.REFRACT?g.push(o.build(e,s),r.build(e,s),a.build(e,"float")):i===ph.MIX?g.push(o.build(e,s),r.build(e,s),a.build(e,1===e.getTypeLength(a.getNodeType(e))?"float":s)):(g.push(o.build(e,s)),null!==r&&g.push(r.build(e,s)),null!==a&&g.push(a.build(e,s))),e.format(`${e.getMethod(i)}( ${g.join(", ")} )`,n,t)}}serialize(e){super.serialize(e),e.method=this.method}deserialize(e){super.deserialize(e),this.method=e.method}}ph.RADIANS="radians",ph.DEGREES="degrees",ph.EXP="exp",ph.EXP2="exp2",ph.LOG="log",ph.LOG2="log2",ph.SQRT="sqrt",ph.INVERSE_SQRT="inversesqrt",ph.FLOOR="floor",ph.CEIL="ceil",ph.NORMALIZE="normalize",ph.FRACT="fract",ph.SIN="sin",ph.COS="cos",ph.TAN="tan",ph.ASIN="asin",ph.ACOS="acos",ph.ATAN="atan",ph.ABS="abs",ph.SIGN="sign",ph.LENGTH="length",ph.NEGATE="negate",ph.ONE_MINUS="oneMinus",ph.DFDX="dFdx",ph.DFDY="dFdy",ph.ROUND="round",ph.RECIPROCAL="reciprocal",ph.TRUNC="trunc",ph.FWIDTH="fwidth",ph.ATAN2="atan2",ph.MIN="min",ph.MAX="max",ph.MOD="mod",ph.STEP="step",ph.REFLECT="reflect",ph.DISTANCE="distance",ph.DIFFERENCE="difference",ph.DOT="dot",ph.CROSS="cross",ph.POW="pow",ph.TRANSFORM_DIRECTION="transformDirection",ph.MIX="mix",ph.CLAMP="clamp",ph.REFRACT="refract",ph.SMOOTHSTEP="smoothstep",ph.FACEFORWARD="faceforward";const mh=ph;kc(1e-6),kc(1e6);const Ah=zc(ph,ph.RADIANS),Ch=zc(ph,ph.DEGREES),fh=zc(ph,ph.EXP),bh=zc(ph,ph.EXP2),yh=zc(ph,ph.LOG),_h=zc(ph,ph.LOG2),vh=zc(ph,ph.SQRT),xh=zc(ph,ph.INVERSE_SQRT),Bh=zc(ph,ph.FLOOR),wh=zc(ph,ph.CEIL),Sh=zc(ph,ph.NORMALIZE),Gh=zc(ph,ph.FRACT),Mh=zc(ph,ph.SIN),Rh=zc(ph,ph.COS),Th=zc(ph,ph.TAN),Zh=zc(ph,ph.ASIN),Vh=zc(ph,ph.ACOS),Wh=zc(ph,ph.ATAN),Eh=zc(ph,ph.ABS),Nh=zc(ph,ph.SIGN),Fh=zc(ph,ph.LENGTH),Xh=zc(ph,ph.NEGATE),Hh=zc(ph,ph.ONE_MINUS),zh=zc(ph,ph.DFDX),Lh=zc(ph,ph.DFDY),Dh=zc(ph,ph.ROUND),Kh=zc(ph,ph.RECIPROCAL),Yh=zc(ph,ph.TRUNC),Ph=zc(ph,ph.FWIDTH),kh=zc(ph,ph.ATAN2),Oh=zc(ph,ph.MIN),Uh=zc(ph,ph.MAX),Qh=zc(ph,ph.MOD),Jh=zc(ph,ph.STEP),jh=zc(ph,ph.REFLECT),qh=zc(ph,ph.DISTANCE),$h=zc(ph,ph.DIFFERENCE),eu=zc(ph,ph.DOT),tu=zc(ph,ph.CROSS),iu=zc(ph,ph.POW),nu=zc(ph,ph.POW,2),su=zc(ph,ph.POW,3),ou=zc(ph,ph.POW,4),ru=zc(ph,ph.TRANSFORM_DIRECTION),au=zc(ph,ph.MIX),lu=(e,t=0,i=1)=>Fc(new ph(ph.CLAMP,Fc(e),Fc(t),Fc(i))),gu=zc(ph,ph.REFRACT),cu=zc(ph,ph.SMOOTHSTEP),du=zc(ph,ph.FACEFORWARD);uc("radians",Ah),uc("degrees",Ch),uc("exp",fh),uc("exp2",bh),uc("log",yh),uc("log2",_h),uc("sqrt",vh),uc("inverseSqrt",xh),uc("floor",Bh),uc("ceil",wh),uc("normalize",Sh),uc("fract",Gh),uc("sin",Mh),uc("cos",Rh),uc("tan",Th),uc("asin",Zh),uc("acos",Vh),uc("atan",Wh),uc("abs",Eh),uc("sign",Nh),uc("length",Fh),uc("negate",Xh),uc("oneMinus",Hh),uc("dFdx",zh),uc("dFdy",Lh),uc("round",Dh),uc("reciprocal",Kh),uc("trunc",Yh),uc("fwidth",Ph),uc("atan2",kh),uc("min",Oh),uc("max",Uh),uc("mod",Qh),uc("step",Jh),uc("reflect",jh),uc("distance",qh),uc("dot",eu),uc("cross",tu),uc("pow",iu),uc("pow2",nu),uc("pow3",su),uc("pow4",ou),uc("transformDirection",ru),uc("mix",((e,t,i)=>au(t,i,e))),uc("clamp",lu),uc("refract",gu),uc("smoothstep",((e,t,i)=>cu(t,i,e))),uc("faceForward",du),uc("difference",$h),uc("saturate",(e=>lu(e))),Og("MathNode",ph);const hu=Dc((e=>{const{value:t}=e,{rgb:i}=t,n=i.mul(.9478672986).add(.0521327014).pow(2.4),s=i.mul(.0773993808),o=i.lessThanEqual(.04045),r=au(n,s,o);return sd(r,t.a)})),uu=Dc((e=>{const{value:t}=e,{rgb:i}=t,n=i.pow(.41666).mul(1.055).sub(.055),s=i.mul(12.92),o=i.lessThanEqual(.0031308),r=au(n,s,o);return sd(r,t.a)})),Iu=e=>{let t=null;return e===Pe?t="Linear":e===Ye&&(t="sRGB"),t},pu=(e,t)=>Iu(e)+"To"+Iu(t);class mu extends tc{constructor(e,t){super("vec4"),this.method=e,this.node=t}setup(){const{method:e,node:t}=this;return e===mu.LINEAR_TO_LINEAR?t:Au[e]({value:t})}}mu.LINEAR_TO_LINEAR="LinearToLinear",mu.LINEAR_TO_sRGB="LinearTosRGB",mu.sRGB_TO_LINEAR="sRGBToLinear";const Au={[mu.LINEAR_TO_sRGB]:uu,[mu.sRGB_TO_LINEAR]:hu},Cu=(e,t)=>Fc(new mu(pu(t,Pe),Fc(e))),fu=zc(mu,mu.LINEAR_TO_sRGB),bu=zc(mu,mu.sRGB_TO_LINEAR);uc("linearTosRGB",fu),uc("sRGBToLinear",bu),uc("linearToColorSpace",((e,t)=>Fc(new mu(pu(Pe,t),Fc(e))))),uc("colorSpaceToLinear",Cu),Og("ColorSpaceNode",mu);class yu extends kg{constructor(e="",t="void"){super(t),this.snippet=e}generate(e,t){const i=this.getNodeType(e),n=this.snippet;if("void"!==i)return e.format(`( ${n} )`,i,t);e.addLineFlowCode(n)}}const _u=zc(yu);Og("ExpressionNode",yu);class vu extends Ad{constructor(e,t=null,i=null,n=null){super(e),this.isTextureNode=!0,this.uvNode=t,this.levelNode=i,this.compareNode=n,this.updateMatrix=!1,this.updateType=Zg,this.setUpdateMatrix(null===t)}getUniformHash(){return this.value.uuid}getNodeType(){return!0===this.value.isDepthTexture?"float":"vec4"}getInputType(){return"texture"}getDefaultUV(){return((...e)=>Fc(new kd(...e)))(this.value.channel)}updateReference(){return this.value}getTransformedUV(e){const t=this.value;return Cd(t.matrix).mul(ed(e,1)).xy}setUpdateMatrix(e){return this.updateMatrix=e,this.updateType=e?Vg:Zg,this}setup(e){const t=e.getNodeProperties(this);let i=this.uvNode;null!==i&&!0!==e.context.forceUVContext||!e.context.getUVNode||(i=e.context.getUVNode(this)),i||(i=this.getDefaultUV()),!0===this.updateMatrix&&(i=this.getTransformedUV(i));let n=this.levelNode;null===n&&e.context.getSamplerLevelNode&&(n=e.context.getSamplerLevelNode(this)),t.uvNode=i,t.levelNode=n?e.context.getMIPLevelAlgorithmNode(this,n):null}generate(e,t){const{uvNode:i,levelNode:n}=e.getNodeProperties(this),s=this.compareNode,o=this.value;if(!o||!0!==o.isTexture)throw new Error("TextureNode: Need a three.js texture.");const r=super.generate(e,"property");if("sampler"===t)return r+"_sampler";if(e.isReference(t))return r;{const a=e.getDataFromNode(this);let l=a.propertyName;if(void 0===l){const t=i.build(e,"vec2"),g=e.getVarFromNode(this);l=e.getPropertyName(g);let c=null;if(n&&!0===n.isNode){const i=n.build(e,"float");c=e.getTextureLevel(o,r,t,i)}else if(null!==s){const i=s.build(e,"float");c=e.getTextureCompare(o,r,t,i)}else c=e.getTexture(o,r,t);e.addLineFlowCode(`${l} = ${c}`),!1!==e.context.tempWrite&&(a.snippet=c,a.propertyName=l)}let g=l;const c=this.getNodeType(e);return e.needsColorSpaceToLinear(this.value)&&(g=Cu(_u(g,c),this.value.colorSpace).setup(e).build(e,c)),e.format(g,c,t)}}uv(e){const t=this.clone();return t.uvNode=e,Fc(t)}level(e){const t=this.clone();return t.levelNode=e,Gd(t,{getMIPLevelAlgorithmNode:(e,t)=>t})}size(e){return Ud(this,e)}compare(e){const t=this.clone();return t.compareNode=Fc(e),Fc(t)}serialize(e){super.serialize(e),e.value=this.value.toJSON(e.meta).uuid}deserialize(e){super.deserialize(e),this.value=e.meta.textures[e.value]}update(){const e=this.value;!0===e.matrixAutoUpdate&&e.updateMatrix()}clone(){return new this.constructor(this.value,this.uvNode,this.levelNode,this.compareNode)}}const xu=zc(vu);uc("texture",xu),Og("TextureNode",vu);class Bu extends kg{constructor(e,t,i=null){super(),this.property=e,this.uniformType=t,this.object=i,this.reference=null,this.node=null,this.updateType=Eg,this.setNodeType(t)}updateReference(e){return this.reference=null!==this.object?this.object:e.object,this.reference}setNodeType(e){let t=null;t="texture"===e?xu(null):Cd(e),this.node=t}getNodeType(e){return this.node.getNodeType(e)}update(){this.node.value=this.reference[this.property]}setup(){return this.node}}const wu=(e,t,i)=>Fc(new Bu(e,t,i));Og("ReferenceNode",Bu);class Su extends Bu{constructor(e,t,i=null){super(e,t,i),this.material=i,this.updateType=Wg}updateReference(e){return this.reference=null!==this.material?this.material:e.material,this.reference}setup(e){const t=null!==this.material?this.material:e.material;return this.node.value=t[this.property],super.setup(e)}}Og("MaterialReferenceNode",Su);class Gu extends kg{constructor(e=Gu.VIEW_MATRIX,t=null){super(),this.scope=e,this.object3d=t,this.updateType=Eg,this._uniformNode=new Ad(null)}getNodeType(){const e=this.scope;return e===Gu.WORLD_MATRIX||e===Gu.VIEW_MATRIX?"mat4":e===Gu.NORMAL_MATRIX?"mat3":e===Gu.POSITION||e===Gu.VIEW_POSITION||e===Gu.DIRECTION||e===Gu.SCALE?"vec3":void 0}update(e){const t=this.object3d,i=this._uniformNode,n=this.scope;if(n===Gu.VIEW_MATRIX)i.value=t.modelViewMatrix;else if(n===Gu.NORMAL_MATRIX)i.value=t.normalMatrix;else if(n===Gu.WORLD_MATRIX)i.value=t.matrixWorld;else if(n===Gu.POSITION)i.value=i.value||new Qt,i.value.setFromMatrixPosition(t.matrixWorld);else if(n===Gu.SCALE)i.value=i.value||new Qt,i.value.setFromMatrixScale(t.matrixWorld);else if(n===Gu.DIRECTION)i.value=i.value||new Qt,t.getWorldDirection(i.value);else if(n===Gu.VIEW_POSITION){const n=e.camera;i.value=i.value||new Qt,i.value.setFromMatrixPosition(t.matrixWorld),i.value.applyMatrix4(n.matrixWorldInverse)}}generate(e){const t=this.scope;return t===Gu.WORLD_MATRIX||t===Gu.VIEW_MATRIX?this._uniformNode.nodeType="mat4":t===Gu.NORMAL_MATRIX?this._uniformNode.nodeType="mat3":t!==Gu.POSITION&&t!==Gu.VIEW_POSITION&&t!==Gu.DIRECTION&&t!==Gu.SCALE||(this._uniformNode.nodeType="vec3"),this._uniformNode.build(e)}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}}Gu.VIEW_MATRIX="viewMatrix",Gu.NORMAL_MATRIX="normalMatrix",Gu.WORLD_MATRIX="worldMatrix",Gu.POSITION="position",Gu.SCALE="scale",Gu.VIEW_POSITION="viewPosition",Gu.DIRECTION="direction";const Mu=Gu;zc(Gu,Gu.DIRECTION),zc(Gu,Gu.VIEW_MATRIX),zc(Gu,Gu.NORMAL_MATRIX),zc(Gu,Gu.WORLD_MATRIX),zc(Gu,Gu.POSITION),zc(Gu,Gu.SCALE),zc(Gu,Gu.VIEW_POSITION),Og("Object3DNode",Gu);class Ru extends Mu{constructor(e=Ru.POSITION){super(e)}getNodeType(e){const t=this.scope;return t===Ru.PROJECTION_MATRIX?"mat4":t===Ru.NEAR||t===Ru.FAR?"float":super.getNodeType(e)}update(e){const t=e.camera,i=this._uniformNode,n=this.scope;n===Ru.VIEW_MATRIX?i.value=t.matrixWorldInverse:n===Ru.PROJECTION_MATRIX?i.value=t.projectionMatrix:n===Ru.NEAR?i.value=t.near:n===Ru.FAR?i.value=t.far:(this.object3d=t,super.update(e))}generate(e){const t=this.scope;return t===Ru.PROJECTION_MATRIX?this._uniformNode.nodeType="mat4":t!==Ru.NEAR&&t!==Ru.FAR||(this._uniformNode.nodeType="float"),super.generate(e)}}Ru.PROJECTION_MATRIX="projectionMatrix",Ru.NEAR="near",Ru.FAR="far";const Tu=Md(Lc(Ru,Ru.PROJECTION_MATRIX),"projectionMatrix");Lc(Ru,Ru.NEAR),Lc(Ru,Ru.FAR);const Zu=Lc(Ru,Ru.VIEW_MATRIX);Lc(Ru,Ru.NORMAL_MATRIX),Lc(Ru,Ru.WORLD_MATRIX),Lc(Ru,Ru.POSITION),Og("CameraNode",Ru);class Vu extends Mu{constructor(e=Vu.VIEW_MATRIX){super(e)}update(e){this.object3d=e.object,super.update(e)}}Lc(Vu,Vu.DIRECTION);const Wu=Lc(Vu,Vu.VIEW_MATRIX).temp("ModelViewMatrix"),Eu=Lc(Vu,Vu.NORMAL_MATRIX),Nu=Lc(Vu,Vu.WORLD_MATRIX);Lc(Vu,Vu.POSITION),Lc(Vu,Vu.SCALE),Lc(Vu,Vu.VIEW_POSITION),Og("ModelNode",Vu);class Fu extends kg{constructor(e=Fu.LOCAL){super("vec3"),this.scope=e}isGlobal(){return!0}getHash(){return`normal-${this.scope}`}generate(e){const t=this.scope;let i=null;if(t===Fu.GEOMETRY)i=_d("normal","vec3");else if(t===Fu.LOCAL)i=bd(Xu);else if(t===Fu.VIEW){const e=Eu.mul(Hu);i=Sh(bd(e))}else if(t===Fu.WORLD){const e=zu.transformDirection(Zu);i=Sh(bd(e))}return i.build(e,this.getNodeType(e))}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}}Fu.GEOMETRY="geometry",Fu.LOCAL="local",Fu.VIEW="view",Fu.WORLD="world";const Xu=Lc(Fu,Fu.GEOMETRY),Hu=Lc(Fu,Fu.LOCAL).temp("Normal"),zu=Lc(Fu,Fu.VIEW),Lu=Lc(Fu,Fu.WORLD),Du=Hd("vec3","TransformedNormalView"),Ku=Du.transformDirection(Zu).normalize(),Yu=Hd("vec3","TransformedClearcoatNormalView");Og("NormalNode",Fu);const Pu=new Map;class ku extends kg{constructor(e){super(),this.scope=e}getCache(e,t){let i=Pu.get(e);return void 0===i&&(i=((e,t,i)=>Fc(new Su(e,t,i)))(e,t),Pu.set(e,i)),i}getFloat(e){return this.getCache(e,"float")}getColor(e){return this.getCache(e,"color")}getTexture(e){return this.getCache("map"===e?"map":e+"Map","texture")}setup(e){const t=e.context.material,i=this.scope;let n=null;if(i===ku.COLOR){const e=this.getColor(i);n=t.map&&!0===t.map.isTexture?e.mul(this.getTexture("map")):e}else if(i===ku.OPACITY){const e=this.getFloat(i);n=t.alphaMap&&!0===t.alphaMap.isTexture?e.mul(this.getTexture("alpha")):e}else if(i===ku.SPECULAR_STRENGTH)n=t.specularMap&&!0===t.specularMap.isTexture?this.getTexture(i).r:kc(1);else if(i===ku.ROUGHNESS){const e=this.getFloat(i);n=t.roughnessMap&&!0===t.roughnessMap.isTexture?e.mul(this.getTexture(i).g):e}else if(i===ku.METALNESS){const e=this.getFloat(i);n=t.metalnessMap&&!0===t.metalnessMap.isTexture?e.mul(this.getTexture(i).b):e}else if(i===ku.EMISSIVE){const e=this.getColor(i);n=t.emissiveMap&&!0===t.emissiveMap.isTexture?e.mul(this.getTexture(i)):e}else if(i===ku.NORMAL)n=t.normalMap?this.getTexture("normal").normalMap(this.getCache("normalScale","vec2")):t.bumpMap?this.getTexture("bump").r.bumpMap(this.getFloat("bumpScale")):zu;else if(i===ku.CLEARCOAT){const e=this.getFloat(i);n=t.clearcoatMap&&!0===t.clearcoatMap.isTexture?e.mul(this.getTexture(i).r):e}else if(i===ku.CLEARCOAT_ROUGHNESS){const e=this.getFloat(i);n=t.clearcoatRoughnessMap&&!0===t.clearcoatRoughnessMap.isTexture?e.mul(this.getTexture(i).r):e}else if(i===ku.CLEARCOAT_NORMAL)n=t.clearcoatNormalMap?this.getTexture(i).normalMap(this.getCache(i+"Scale","vec2")):zu;else if(i===ku.SHEEN){const e=this.getColor("sheenColor").mul(this.getFloat("sheen"));n=t.sheenColorMap&&!0===t.sheenColorMap.isTexture?e.mul(this.getTexture("sheenColor").rgb):e}else if(i===ku.SHEEN_ROUGHNESS){const e=this.getFloat(i);n=t.sheenRoughnessMap&&!0===t.sheenRoughnessMap.isTexture?e.mul(this.getTexture(i).a):e,n=n.clamp(.07,1)}else if(i===ku.IRIDESCENCE_THICKNESS){const e=wu(1,"float",t.iridescenceThicknessRange);if(t.iridescenceThicknessMap){const s=wu(0,"float",t.iridescenceThicknessRange);n=e.sub(s).mul(this.getTexture(i).g).add(s)}else n=e}else{const t=this.getNodeType(e);n=this.getCache(i,t)}return n}}ku.ALPHA_TEST="alphaTest",ku.COLOR="color",ku.OPACITY="opacity",ku.SHININESS="shininess",ku.SPECULAR_COLOR="specular",ku.SPECULAR_STRENGTH="specularStrength",ku.REFLECTIVITY="reflectivity",ku.ROUGHNESS="roughness",ku.METALNESS="metalness",ku.NORMAL="normal",ku.CLEARCOAT="clearcoat",ku.CLEARCOAT_ROUGHNESS="clearcoatRoughness",ku.CLEARCOAT_NORMAL="clearcoatNormal",ku.EMISSIVE="emissive",ku.ROTATION="rotation",ku.SHEEN="sheen",ku.SHEEN_ROUGHNESS="sheenRoughness",ku.IRIDESCENCE="iridescence",ku.IRIDESCENCE_IOR="iridescenceIOR",ku.IRIDESCENCE_THICKNESS="iridescenceThickness",ku.LINE_SCALE="scale",ku.LINE_DASH_SIZE="dashSize",ku.LINE_GAP_SIZE="gapSize",ku.LINE_WIDTH="linewidth",ku.LINE_DASH_OFFSET="dashOffset",ku.POINT_WIDTH="pointWidth";const Ou=Lc(ku,ku.ALPHA_TEST),Uu=Lc(ku,ku.COLOR);Lc(ku,ku.SHININESS);const Qu=Lc(ku,ku.EMISSIVE),Ju=Lc(ku,ku.OPACITY);Lc(ku,ku.SPECULAR_COLOR),Lc(ku,ku.SPECULAR_STRENGTH),Lc(ku,ku.REFLECTIVITY),Lc(ku,ku.ROUGHNESS),Lc(ku,ku.METALNESS);const ju=Lc(ku,ku.NORMAL);Lc(ku,ku.CLEARCOAT),Lc(ku,ku.CLEARCOAT_ROUGHNESS),Lc(ku,ku.CLEARCOAT_NORMAL),Lc(ku,ku.ROTATION),Lc(ku,ku.SHEEN),Lc(ku,ku.SHEEN_ROUGHNESS),Lc(ku,ku.IRIDESCENCE),Lc(ku,ku.IRIDESCENCE_IOR),Lc(ku,ku.IRIDESCENCE_THICKNESS),Lc(ku,ku.LINE_SCALE),Lc(ku,ku.LINE_DASH_SIZE),Lc(ku,ku.LINE_GAP_SIZE),Lc(ku,ku.LINE_WIDTH),Lc(ku,ku.LINE_DASH_OFFSET),Lc(ku,ku.POINT_WIDTH),Og("MaterialNode",ku);class qu extends kg{constructor(e=qu.LOCAL){super("vec3"),this.scope=e}isGlobal(){return!0}getHash(){return`position-${this.scope}`}generate(e){const t=this.scope;let i=null;if(t===qu.GEOMETRY)i=_d("position","vec3");else if(t===qu.LOCAL)i=bd($u);else if(t===qu.WORLD){const e=Nu.mul(eI);i=bd(e)}else if(t===qu.VIEW){const e=Wu.mul(eI);i=bd(e)}else if(t===qu.VIEW_DIRECTION){const e=nI.negate();i=Sh(bd(e))}else if(t===qu.WORLD_DIRECTION){const e=eI.transformDirection(Nu);i=Sh(bd(e))}return i.build(e,this.getNodeType(e))}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}}qu.GEOMETRY="geometry",qu.LOCAL="local",qu.WORLD="world",qu.WORLD_DIRECTION="worldDirection",qu.VIEW="view",qu.VIEW_DIRECTION="viewDirection";const $u=Lc(qu,qu.GEOMETRY),eI=Lc(qu,qu.LOCAL).temp("Position"),tI=Lc(qu,qu.WORLD),iI=Lc(qu,qu.WORLD_DIRECTION),nI=Lc(qu,qu.VIEW),sI=Lc(qu,qu.VIEW_DIRECTION);Og("PositionNode",qu);class oI extends tc{constructor(e=eI){super("vec4"),this.positionNode=e}setup(){return Tu.mul(Wu).mul(this.positionNode)}}const rI=zc(oI);Og("ModelViewProjectionNode",oI);class aI extends Qg{constructor(e,t=null,i=0,n=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferStride=i,this.bufferOffset=n,this.usage=$e,this.instanced=!1,this.attribute=null,e&&!0===e.isBufferAttribute&&(this.attribute=e,this.usage=e.usage,this.instanced=e.isInstancedBufferAttribute)}getNodeType(e){return null===this.bufferType&&(this.bufferType=e.getTypeFromAttribute(this.attribute)),this.bufferType}setup(e){if(null!==this.attribute)return;const t=this.getNodeType(e),i=this.value,n=e.getTypeLength(t),s=this.bufferStride||n,o=this.bufferOffset,r=!0===i.isInterleavedBuffer?i:new aa(i,s),a=new ga(r,n,o);r.setUsage(this.usage),this.attribute=a,this.attribute.isInstancedBufferAttribute=this.instanced}generate(e){const t=this.getNodeType(e),i=e.getBufferAttributeFromNode(this,t),n=e.getPropertyName(i);let s=null;if("vertex"===e.shaderStage)s=n;else{s=bd(this).build(e,t)}return s}getInputType(){return"bufferAttribute"}setUsage(e){return this.usage=e,this}setInstanced(e){return this.instanced=e,this}}const lI=(e,t,i,n)=>Fc(new aI(e,t,i,n)),gI=(e,t,i,n)=>lI(e,t,i,n).setInstanced(!0),cI=(e,t,i,n)=>((e,t,i,n)=>lI(e,t,i,n).setUsage(et))(e,t,i,n).setInstanced(!0);uc("toAttribute",(e=>lI(e.value))),Og("BufferAttributeNode",aI);class dI extends kg{constructor(e){super("void"),this.instanceMesh=e,this.instanceMatrixNode=null}setup(){let e=this.instanceMatrixNode;if(null===e){const t=this.instanceMesh.instanceMatrix,i=new bg(t.array,16,1),n=t.usage===et?cI:gI,s=[n(i,"vec4",16,0),n(i,"vec4",16,4),n(i,"vec4",16,8),n(i,"vec4",16,12)];e=hd(...s),this.instanceMatrixNode=e}const t=e.mul(eI).xyz,i=ld(e[0].xyz,e[1].xyz,e[2].xyz),n=Hu.div(ed(i[0].dot(i[0]),i[1].dot(i[1]),i[2].dot(i[2]))),s=i.mul(n).xyz;eI.assign(t),Hu.assign(s)}}const hI=zc(dI);Og("InstanceNode",dI);class uI extends Ad{constructor(e,t,i=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferCount=i}getInputType(){return"buffer"}}Og("BufferNode",uI);class II extends kg{constructor(e=II.LOCAL){super(),this.scope=e}getHash(){return`tangent-${this.scope}`}getNodeType(){return this.scope===II.GEOMETRY?"vec4":"vec3"}generate(e){const t=this.scope;let i=null;if(t===II.GEOMETRY)i=_d("tangent","vec4");else if(t===II.LOCAL)i=bd(pI.xyz);else if(t===II.VIEW){const e=Wu.mul(mI).xyz;i=Sh(bd(e))}else if(t===II.WORLD){const e=AI.transformDirection(Zu);i=Sh(bd(e))}return i.build(e,this.getNodeType(e))}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}}II.GEOMETRY="geometry",II.LOCAL="local",II.VIEW="view",II.WORLD="world";const pI=Lc(II,II.GEOMETRY),mI=Lc(II,II.LOCAL),AI=Lc(II,II.VIEW);Lc(II,II.WORLD);const CI=Td(AI,"TransformedTangentView");Sh(CI.transformDirection(Zu)),Og("TangentNode",II);class fI extends kg{constructor(e){var t,i,n;super("void"),this.skinnedMesh=e,this.updateType=Eg,this.skinIndexNode=_d("skinIndex","uvec4"),this.skinWeightNode=_d("skinWeight","vec4"),this.bindMatrixNode=Cd(e.bindMatrix,"mat4"),this.bindMatrixInverseNode=Cd(e.bindMatrixInverse,"mat4"),this.boneMatricesNode=(t=e.skeleton.boneMatrices,i="mat4",n=e.skeleton.bones.length,Fc(new uI(t,i,n)))}setup(e){const{skinIndexNode:t,skinWeightNode:i,bindMatrixNode:n,bindMatrixInverseNode:s,boneMatricesNode:o}=this,r=o.element(t.x),a=o.element(t.y),l=o.element(t.z),g=o.element(t.w),c=n.mul(eI),d=Jd(r.mul(i.x).mul(c),a.mul(i.y).mul(c),l.mul(i.z).mul(c),g.mul(i.w).mul(c)),h=s.mul(d).xyz;let u=Jd(i.x.mul(r),i.y.mul(a),i.z.mul(l),i.w.mul(g));u=s.mul(u).mul(n);const I=u.transformDirection(Hu).xyz;eI.assign(h),Hu.assign(I),e.hasGeometryAttribute("tangent")&&mI.assign(I)}generate(e,t){if("void"!==t)return eI.build(e,t)}update(){this.skinnedMesh.skeleton.update()}}const bI=zc(fI);Og("SkinningNode",fI);class yI extends kg{constructor(e){super("void"),this.mesh=e,this.morphBaseInfluence=Cd(1),this.updateType=Eg}setupAttribute(e,t=eI){const i=this.mesh,n=i.geometry.morphAttributes[e];t.mulAssign(this.morphBaseInfluence);for(let s=0;s<n.length;s++){const e=n[s],o=lI(e.array,"vec3"),r=wu(s,"float",i.morphTargetInfluences);t.addAssign(o.mul(r))}}setup(){this.setupAttribute("position")}update(){const e=this.morphBaseInfluence;this.mesh.geometry.morphTargetsRelative?e.value=1:e.value=1-this.mesh.morphTargetInfluences.reduce(((e,t)=>e+t),0)}}const _I=zc(yI);Og("MorphNode",yI);class vI extends kg{constructor(){super("vec3")}getHash(){return"reflectVector"}setup(){return sI.negate().reflect(Du).transformDirection(Zu)}}const xI=Lc(vI);Og("ReflectVectorNode",vI);class BI extends vu{constructor(e,t=null,i=null){super(e,t,i),this.isCubeTextureNode=!0}getInputType(){return"cubeTexture"}getDefaultUV(){return xI}setUpdateMatrix(){}generate(e,t){const{uvNode:i,levelNode:n}=e.getNodeProperties(this),s=this.value;if(!s||!0!==s.isCubeTexture)throw new Error("CubeTextureNode: Need a three.js cube texture.");const o=Ad.prototype.generate.call(this,e,"cubeTexture");if("sampler"===t)return o+"_sampler";if(e.isReference(t))return o;{const s=e.getDataFromNode(this);let r=s.propertyName;if(void 0===r){const t=ed(i.x.negate(),i.yz).build(e,"vec3"),a=e.getVarFromNode(this);r=e.getPropertyName(a);let l=null;if(n&&!0===n.isNode){const i=n.build(e,"float");l=e.getTextureLevel(this,o,t,i)}else l=e.getTexture(this,o,t);e.addLineFlowCode(`${r} = ${l}`),!1!==e.context.tempWrite&&(s.snippet=l,s.propertyName=r)}let a=r;const l=this.getNodeType(e);return e.needsColorSpaceToLinear(this.value)&&(a=Cu(_u(a,l),this.value.colorSpace).setup(e).build(e,l)),e.format(a,l,t)}}}const wI=zc(BI);uc("cubeTexture",wI),Og("CubeTextureNode",BI);class SI extends kg{constructor(){super("vec3")}generate(){console.warn("Abstract function.")}}const GI=SI;Og("LightingNode",SI);let MI=null;class RI extends GI{constructor(e=null){super(),this.updateType=Vg,this.light=e,this.rtt=null,this.shadowNode=null,this.color=new In,this.colorNode=Cd(this.color)}getHash(){return this.light.uuid}setupShadow(e){let t=this.shadowNode;if(null===t){null===MI&&(MI=e.createNodeMaterial("MeshBasicNodeMaterial"));const i=this.light.shadow,n=e.getRenderTarget(i.mapSize.width,i.mapSize.height),s=new ta;s.minFilter=T,s.magFilter=T,s.image.width=i.mapSize.width,s.image.height=i.mapSize.height,s.compareFunction=513,n.depthTexture=s,i.camera.updateProjectionMatrix();const o=wu("bias","float",i),r=wu("normalBias","float",i);let a=Cd(i.matrix).mul(tI.add(Lu.mul(r)));a=a.xyz.div(a.w);const l=a.x.greaterThanEqual(0).and(a.x.lessThanEqual(1)).and(a.y.greaterThanEqual(0)).and(a.y.lessThanEqual(1)).and(a.z.lessThanEqual(1));a=e.renderer.coordinateSystem===st?ed(a.x,a.y.oneMinus(),a.z.add(o).mul(2).sub(1)):ed(a.x,a.y,a.z.add(o));t=((e,t,i)=>xu(e,t).compare(i))(s,a.xy,a.z),this.rtt=n,this.colorNode=this.colorNode.mul(l.mix(1,t)),this.shadowNode=t,this.updateBeforeType=Wg}}setup(e){this.light.castShadow&&this.setupShadow(e)}updateShadow(e){const{rtt:t,light:i}=this,{renderer:n,scene:s}=e;s.overrideMaterial=MI,t.setSize(i.shadow.mapSize.width,i.shadow.mapSize.height),i.shadow.updateMatrices(i),n.setRenderTarget(t),n.render(s,i.shadow.camera),n.setRenderTarget(null),s.overrideMaterial=null}updateBefore(e){const{light:t}=this;t.castShadow&&this.updateShadow(e)}update(){const{light:e}=this;this.color.copy(e.color).multiplyScalar(e.intensity)}}const TI=RI;Og("AnalyticLightNode",RI);const ZI=new WeakMap;const VI=zc(class extends kg{constructor(e=[]){super("vec3"),this.totalDiffuseNode=ed().temp("totalDiffuse"),this.totalSpecularNode=ed().temp("totalSpecular"),this.outgoingLightNode=ed().temp("outgoingLight"),this.lightNodes=e,this._hash=null}get hasLight(){return this.lightNodes.length>0}setup(e){const t=e.context,i=t.lightingModel;let n=this.outgoingLightNode;if(i){const{lightNodes:s,totalDiffuseNode:o,totalSpecularNode:r}=this;t.outgoingLight=n;const a=e.addStack();i.start(t,a,e);for(const t of s)t.build(e);i.indirectDiffuse(t,a,e),i.indirectSpecular(t,a,e),i.ambientOcclusion(t,a,e);const{backdrop:l,backdropAlpha:g}=t,{directDiffuse:c,directSpecular:d,indirectDiffuse:h,indirectSpecular:u}=t.reflectedLight;let I=c.add(h);null!==l&&(I=ed(null!==g?g.mix(I,l):l)),o.assign(I),r.assign(d.add(u)),n.assign(o.add(r)),i.finish(t,a,e),n=n.bypass(e.removeStack())}return n}getHash(e){if(null===this._hash){let t="";const i=this.lightNodes;for(const n of i)t+=n.getHash(e)+" ";this._hash=t}return this._hash}getLightNodeByHash(e){const t=this.lightNodes;for(const i of t)if(i.light.uuid===e)return i;return null}fromLights(e=[]){const t=[];e=(e=>e.sort(((e,t)=>e.id-t.id)))(e);for(const i of e){let e=this.getLightNodeByHash(i.uuid);if(null===e){const t=i.constructor,n=ZI.has(t)?ZI.get(t):TI;e=Fc(new n(i))}t.push(e)}return this.lightNodes=t,this._hash=null,this}});class WI extends GI{constructor(e=null){super(),this.aoNode=e}setup(e){const t=this.aoNode.x.sub(1).mul(1).add(1);e.context.ambientOcclusion.mulAssign(t)}}const EI=WI;Og("AONode",WI);class NI extends Sd{constructor(e,t=null,i=null,n=null){super(e),this.lightingModel=t,this.backdropNode=i,this.backdropAlphaNode=n,this._context=null}getContext(){const{backdropNode:e,backdropAlphaNode:t}=this,i={directDiffuse:ed().temp("directDiffuse"),directSpecular:ed().temp("directSpecular"),indirectDiffuse:ed().temp("indirectDiffuse"),indirectSpecular:ed().temp("indirectSpecular")};return{radiance:ed().temp("radiance"),irradiance:ed().temp("irradiance"),iblIrradiance:ed().temp("iblIrradiance"),ambientOcclusion:kc(1).temp("ambientOcclusion"),reflectedLight:i,backdrop:e,backdropAlpha:t}}setup(e){return this.context=this._context||(this._context=this.getContext()),this.context.lightingModel=this.lightingModel||e.context.lightingModel,super.setup(e)}}const FI=zc(NI);uc("lightingContext",FI),Og("LightingContextNode",NI);class XI extends tc{constructor(e=iI){super("vec2"),this.dirNode=e}setup(){const e=this.dirNode,t=e.z.atan2(e.x).mul(1/(2*Math.PI)).add(.5),i=e.y.negate().clamp(-1,1).asin().mul(1/Math.PI).add(.5);return Jc(t,i)}}const HI=zc(XI);Og("EquirectUVNode",XI);class zI extends Ad{constructor(e){super(0),this.textureNode=e,this.updateType=Vg}get texture(){return this.textureNode.value}update(){const e=this.texture,t=e.images,i=t&&t.length>0?t[0]&&t[0].image||t[0]:e.image;if(i&&void 0!==i.width){const{width:e,height:t}=i;this.value=Math.log2(Math.max(e,t))}}}const LI=zc(zI);Og("MaxMipLevelNode",zI);class DI extends kg{constructor(e,t=null){super("float"),this.textureNode=e,this.roughnessNode=t}setup(){const{textureNode:e,roughnessNode:t}=this,i=LI(e),n=t.mul(t).mul(Math.PI).div(t.add(1));return i.add(n.log2()).clamp(0,i)}}const KI=zc(DI);Og("SpecularMIPLevelNode",DI);const YI=new WeakMap;class PI extends GI{constructor(e=null){super(),this.envNode=e}setup(e){let t=this.envNode;if(t.isTextureNode&&!0!==t.value.isCubeTexture){let i=YI.get(t.value);if(void 0===i){const n=t.value,s=e.renderer,o=e.getCubeRenderTarget(512).fromEquirectangularTexture(s,n);i=wI(o.texture),YI.set(t.value,i)}t=i}const i=wu("envMapIntensity","float",e.material),n=Gd(t,kI(Ld,Du)).mul(i),s=Gd(t,OI(Ku)).mul(Math.PI).mul(i),o=wd(n);e.context.radiance.addAssign(o),e.context.iblIrradiance.addAssign(s);const r=e.context.lightingModel.clearcoatRadiance;if(r){const e=Gd(t,kI(Dd,Yu)).mul(i),n=wd(e);r.addAssign(n)}}}const kI=(e,t)=>{let i=null,n=null;return{getUVNode:s=>{let o=null;return null===i&&(i=sI.negate().reflect(t),i=e.mul(e).mix(i,t).normalize(),i=i.transformDirection(Zu)),s.isCubeTextureNode?o=i:s.isTextureNode&&(null===n&&(n=HI(i)),o=n),o},getSamplerLevelNode:()=>e,getMIPLevelAlgorithmNode:(e,t)=>KI(e,t)}},OI=e=>{let t=null;return{getUVNode:i=>{let n=null;return i.isCubeTextureNode?n=e:i.isTextureNode&&(null===t&&(t=HI(e),t=Jc(t.x,t.y.oneMinus())),n=t),n},getSamplerLevelNode:()=>kc(1),getMIPLevelAlgorithmNode:(e,t)=>KI(e,t)}},UI=PI;Og("EnvironmentNode",PI);const QI=new Map;class JI extends ls{constructor(){super(),this.isNodeMaterial=!0,this.type=this.constructor.type,this.forceSinglePass=!1,this.unlit=this.constructor===JI.prototype.constructor,this.fog=!0,this.lights=!0,this.normals=!0,this.colorSpace=!0,this.lightsNode=null,this.envNode=null,this.colorNode=null,this.normalNode=null,this.opacityNode=null,this.backdropNode=null,this.backdropAlphaNode=null,this.alphaTestNode=null,this.positionNode=null,this.outputNode=null,this.vertexNode=null}customProgramCacheKey(){return this.type+zg(this)}build(e){this.setup(e)}setup(e){let t;if(e.addStack(),e.stack.outputNode=this.setupPosition(e),e.addFlow("vertex",e.removeStack()),e.addStack(),!1===this.unlit){!0===this.normals&&this.setupNormal(e),this.setupDiffuseColor(e),this.setupVariants(e);const i=this.setupLighting(e);t=this.setupOutput(e,sd(i,zd.a)),Kd.assign(t),null!==this.outputNode&&(t=this.outputNode)}else t=this.setupOutput(e,this.outputNode||sd(0,0,0,1));e.stack.outputNode=t,e.addFlow("fragment",e.removeStack())}setupPosition(e){const t=e.object,i=t.geometry;return e.addStack(),(i.morphAttributes.position||i.morphAttributes.normal||i.morphAttributes.color)&&_I(t).append(),!0===t.isSkinnedMesh&&bI(t).append(),t.instanceMatrix&&!0===t.instanceMatrix.isInstancedBufferAttribute&&!0===e.isAvailable("instance")&&hI(t).append(),null!==this.positionNode&&eI.assign(this.positionNode),e.context.vertex=e.removeStack(),this.vertexNode||rI()}setupDiffuseColor({geometry:e}){let t=this.colorNode?sd(this.colorNode):Uu;!0===this.vertexColors&&e.hasAttribute("color")&&(t=sd(t.xyz.mul(_d("color")),t.a)),zd.assign(t);const i=this.opacityNode?kc(this.opacityNode):Ju;if(zd.a.assign(zd.a.mul(i)),null!==this.alphaTestNode||this.alphaTest>0){const e=null!==this.alphaTestNode?kc(this.alphaTestNode):Ou;zd.a.lessThanEqual(e).discard()}}setupVariants(){}setupNormal(){if(!0===this.flatShading){const e=nI.dFdx().cross(nI.dFdy()).normalize();Du.assign(e)}else{const e=this.normalNode?ed(this.normalNode):ju;Du.assign(e)}}getEnvNode(e){let t=null;return this.envNode?t=this.envNode:this.envMap?t=this.envMap.isCubeTexture?wI(this.envMap):xu(this.envMap):e.environmentNode&&(t=e.environmentNode),t}setupLights(e){const t=this.getEnvNode(e),i=[];t&&i.push(new UI(t)),e.material.aoMap&&i.push(new EI(xu(e.material.aoMap)));let n=this.lightsNode||e.lightsNode;return i.length>0&&(n=VI([...n.lightNodes,...i])),n}setupLightingModel(){}setupLighting(e){const{material:t}=e,{backdropNode:i,backdropAlphaNode:n,emissiveNode:s}=this,o=!0===this.lights||null!==this.lightsNode?this.setupLights(e):null;let r=zd.rgb;if(o&&!1!==o.hasLight){const t=this.setupLightingModel(e);r=FI(o,t,i,n)}else null!==i&&(r=ed(null!==n?au(r,i,n):i));return(s&&!0===s.isNode||t.emissive&&!0===t.emissive.isColor)&&(r=r.add(ed(s||Qu))),r}setupOutput(e,t){const i=e.renderer,n=e.toneMappingNode;if(n&&(t=sd(n.context({color:t.rgb}),t.a)),!0===this.fog){const i=e.fogNode;i&&(t=sd(i.mixAssign(t.rgb),t.a))}if(!0===this.colorSpace){const e=i.getRenderTarget();let n;n=null!==e?Array.isArray(e.texture)?e.texture[0].colorSpace:e.texture.colorSpace:i.outputColorSpace,n!==Pe&&n!==Ke&&(t=t.linearToColorSpace(n))}return t}setDefaultValues(e){for(const i in e){const t=e[i];void 0===this[i]&&(this[i]=t,t&&t.clone&&(this[i]=t.clone()))}Object.assign(this.defines,e.defines);const t=Object.getOwnPropertyDescriptors(e.constructor.prototype);for(const i in t)void 0===Object.getOwnPropertyDescriptor(this.constructor.prototype,i)&&void 0!==t[i].get&&Object.defineProperty(this.constructor.prototype,i,t[i])}toJSON(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{},nodes:{}});const i=An.prototype.toJSON.call(this,e),n=Lg(this);i.inputNodes={};for(const{property:o,childNode:r}of n)i.inputNodes[o]=r.toJSON(e).uuid;function s(e){const t=[];for(const i in e){const n=e[i];delete n.metadata,t.push(n)}return t}if(t){const t=s(e.textures),n=s(e.images),o=s(e.nodes);t.length>0&&(i.textures=t),n.length>0&&(i.images=n),o.length>0&&(i.nodes=o)}return i}copy(e){return this.lightsNode=e.lightsNode,this.envNode=e.envNode,this.colorNode=e.colorNode,this.normalNode=e.normalNode,this.opacityNode=e.opacityNode,this.backdropNode=e.backdropNode,this.backdropAlphaNode=e.backdropAlphaNode,this.alphaTestNode=e.alphaTestNode,this.positionNode=e.positionNode,this.outputNode=e.outputNode,this.vertexNode=e.vertexNode,super.copy(e)}static fromMaterial(e){if(!0===e.isNodeMaterial)return e;const t=jI(e.type.replace("Material","NodeMaterial"));if(void 0===t)throw new Error(`NodeMaterial: Material "${e.type}" is not compatible.`);for(const i in e)t[i]=e[i];return t}}function jI(e){const t=QI.get(e);if(void 0!==t)return new t}!function(e,t){if("function"!=typeof t||!e)throw new Error(`Node material ${e} is not a class`);if(QI.has(e))throw new Error(`Redefinition of node material ${e}`);QI.set(e,t),t.type=e}("NodeMaterial",JI);class qI{constructor(e,t=null){this.name=e,this.value=t,this.boundary=0,this.itemSize=0,this.offset=0}setValue(e){this.value=e}getValue(){return this.value}}class $I extends qI{constructor(e,t=0){super(e,t),this.isFloatUniform=!0,this.boundary=4,this.itemSize=1}}class ep extends qI{constructor(e,t=new bt){super(e,t),this.isVector2Uniform=!0,this.boundary=8,this.itemSize=2}}class tp extends qI{constructor(e,t=new Qt){super(e,t),this.isVector3Uniform=!0,this.boundary=16,this.itemSize=3}}class ip extends qI{constructor(e,t=new Dt){super(e,t),this.isVector4Uniform=!0,this.boundary=16,this.itemSize=4}}class np extends qI{constructor(e,t=new In){super(e,t),this.isColorUniform=!0,this.boundary=16,this.itemSize=3}}class sp extends qI{constructor(e,t=new yt){super(e,t),this.isMatrix3Uniform=!0,this.boundary=48,this.itemSize=12}}class op extends qI{constructor(e,t=new Bi){super(e,t),this.isMatrix4Uniform=!0,this.boundary=64,this.itemSize=16}}class rp extends $I{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class ap extends ep{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class lp extends tp{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class gp extends ip{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class cp extends np{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class dp extends sp{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class hp extends op{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class up extends kg{constructor(e,t,i=null){super(),this.condNode=e,this.ifNode=t,this.elseNode=i}getNodeType(e){const t=this.ifNode.getNodeType(e);if(null!==this.elseNode){const i=this.elseNode.getNodeType(e);if(e.getTypeLength(i)>e.getTypeLength(t))return i}return t}generate(e){const t=this.getNodeType(e),i={tempWrite:!1},{ifNode:n,elseNode:s}=this,o="void"!==n.getNodeType(e)||s&&"void"!==s.getNodeType(e),r=o?Hd(t).build(e):"",a=Gd(this.condNode).build(e,"bool");e.addFlowCode(`\n${e.tab}if ( ${a} ) {\n\n`).addFlowTab();let l=Gd(this.ifNode,i).build(e,t);if(l=o?r+" = "+l+";":l,e.removeFlowTab().addFlowCode(e.tab+"\t"+l+"\n\n"+e.tab+"}"),null!==s){e.addFlowCode(" else {\n\n").addFlowTab();let n=Gd(s,i).build(e,t);n=r?r+" = "+n+";":n,e.removeFlowTab().addFlowCode(e.tab+"\t"+n+"\n\n"+e.tab+"}\n\n")}else e.addFlowCode("\n\n");return r}}const Ip=zc(up);uc("cond",Ip),Og("CondNode",up);class pp extends kg{constructor(e=null){super(),this.nodes=[],this.outputNode=null,this.parent=e,this._currentCond=null,this.isStackNode=!0}getNodeType(e){return this.outputNode?this.outputNode.getNodeType(e):"void"}add(e){return this.nodes.push(e),this}if(e,t){const i=new Nc(t);return this._currentCond=Ip(e,i),this.add(this._currentCond)}elseif(e,t){const i=new Nc(t),n=Ip(e,i);return this._currentCond.elseNode=n,this._currentCond=n,this}else(e){return this._currentCond.elseNode=new Nc(e),this}build(e,...t){const i=Yc();Kc(this);for(const n of this.nodes)n.build(e,"void");return Kc(i),this.outputNode?this.outputNode.build(e,...t):super.build(e,...t)}}const mp=zc(pp);Og("StackNode",pp);const Ap=class extends Is{constructor(e=1,t={}){super(e,t),this.isCubeRenderTarget=!0}fromEquirectangularTexture(e,t){const i=t.minFilter,n=t.generateMipmaps;t.generateMipmaps=!0,this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const s=new ns(5,5,5),o=HI(iI),r=jI("MeshBasicNodeMaterial");r.colorNode=xu(t,o,0),r.side=c,r.blending=0;const a=new ts(s,r),l=new ra;l.add(a),t.minFilter===N&&(t.minFilter=W);return new hs(1,10,this).update(e,l),t.minFilter=i,t.currentGenerateMipmaps=n,a.geometry.dispose(),a.material.dispose(),this}},Cp=new Map([[2,"vec2"],[3,"vec3"],[4,"vec4"],[9,"mat3"],[16,"mat4"]]),fp=new Map([[Int8Array,"int"],[Int16Array,"int"],[Int32Array,"int"],[Uint8Array,"uint"],[Uint16Array,"uint"],[Uint32Array,"uint"],[Float32Array,"float"]]),bp=new Set([Int32Array,Uint32Array,Float32Array]),yp=e=>(e=Number(e))+(e%1?"":".0");const _p=class{constructor(e,t,i,n=null,s=null){this.object=e,this.material=s||e&&e.material||null,this.geometry=e&&e.geometry||null,this.renderer=t,this.parser=i,this.scene=n,this.nodes=[],this.updateNodes=[],this.updateBeforeNodes=[],this.hashNodes={},this.lightsNode=null,this.environmentNode=null,this.fogNode=null,this.toneMappingNode=null,this.vertexShader=null,this.fragmentShader=null,this.computeShader=null,this.flowNodes={vertex:[],fragment:[],compute:[]},this.flowCode={vertex:"",fragment:"",compute:[]},this.uniforms={vertex:[],fragment:[],compute:[],index:0},this.structs={vertex:[],fragment:[],compute:[],index:0},this.bindings={vertex:[],fragment:[],compute:[]},this.bindingsOffset={vertex:0,fragment:0,compute:0},this.bindingsArray=null,this.attributes=[],this.bufferAttributes=[],this.varyings=[],this.codes={},this.vars={},this.flow={code:""},this.chaining=[],this.stack=mp(),this.stacks=[],this.tab="\t",this.context={keywords:new Fd,material:this.material,getMIPLevelAlgorithmNode:(e,t)=>t.mul(LI(e))},this.cache=new xd,this.globalCache=this.cache,this.flowsData=new WeakMap,this.shaderStage=null,this.buildStage=null}getRenderTarget(e,t,i){return new Kt(e,t,i)}getCubeRenderTarget(e,t){return new Ap(e,t)}includes(e){return this.nodes.includes(e)}getBindings(){let e=this.bindingsArray;if(null===e){const t=this.bindings;this.bindingsArray=e=null!==this.material?[...t.vertex,...t.fragment]:t.compute}return e}setHashNode(e,t){this.hashNodes[t]=e}addNode(e){!1===this.nodes.includes(e)&&(this.nodes.push(e),this.setHashNode(e,e.getHash(this)))}buildUpdateNodes(){for(const e of this.nodes){const t=e.getUpdateType(),i=e.getUpdateBeforeType();t!==Zg&&this.updateNodes.push(e.getSelf()),i!==Zg&&this.updateBeforeNodes.push(e)}}get currentNode(){return this.chaining[this.chaining.length-1]}addChain(e){this.chaining.push(e)}removeChain(e){if(this.chaining.pop()!==e)throw new Error("NodeBuilder: Invalid node chaining!")}getMethod(e){return e}getNodeFromHash(e){return this.hashNodes[e]}addFlow(e,t){return this.flowNodes[e].push(t),t}setContext(e){this.context=e}getContext(){return this.context}setCache(e){this.cache=e}getCache(){return this.cache}isAvailable(){return!1}getVertexIndex(){console.warn("Abstract function.")}getInstanceIndex(){console.warn("Abstract function.")}getFrontFacing(){console.warn("Abstract function.")}getFragCoord(){console.warn("Abstract function.")}isFlipY(){return!1}getTexture(){console.warn("Abstract function.")}getTextureLevel(){console.warn("Abstract function.")}getConst(e,t=null){if(null===t&&("float"===e||"int"===e||"uint"===e?t=0:"bool"===e?t=!1:"color"===e?t=new In:"vec2"===e?t=new bt:"vec3"===e?t=new Qt:"vec4"===e&&(t=new Dt)),"float"===e)return yp(t);if("int"===e)return`${Math.round(t)}`;if("uint"===e)return t>=0?`${Math.round(t)}u`:"0u";if("bool"===e)return t?"true":"false";if("color"===e)return`${this.getType("vec3")}( ${yp(t.r)}, ${yp(t.g)}, ${yp(t.b)} )`;const i=this.getTypeLength(e),n=this.getComponentType(e),s=e=>this.getConst(n,e);if(2===i)return`${this.getType(e)}( ${s(t.x)}, ${s(t.y)} )`;if(3===i)return`${this.getType(e)}( ${s(t.x)}, ${s(t.y)}, ${s(t.z)} )`;if(4===i)return`${this.getType(e)}( ${s(t.x)}, ${s(t.y)}, ${s(t.z)}, ${s(t.w)} )`;if(i>4&&t&&(t.isMatrix3||t.isMatrix4))return`${this.getType(e)}( ${t.elements.map(s).join(", ")} )`;if(i>4)return`${this.getType(e)}()`;throw new Error(`NodeBuilder: Type '${e}' not found in generate constant attempt.`)}getType(e){return"color"===e?"vec3":e}generateMethod(e){return e}hasGeometryAttribute(e){return this.geometry&&void 0!==this.geometry.getAttribute(e)}getAttribute(e,t){const i=this.attributes;for(const s of i)if(s.name===e)return s;const n=new Zd(e,t);return i.push(n),n}getPropertyName(e){return e.name}isVector(e){return/vec\d/.test(e)}isMatrix(e){return/mat\d/.test(e)}isReference(e){return"void"===e||"property"===e||"sampler"===e||"texture"===e||"cubeTexture"===e}needsColorSpaceToLinear(){return!1}getTextureEncodingFromMap(e){return console.warn("THREE.NodeBuilder: Method .getTextureEncodingFromMap replaced by .getTextureColorSpaceFromMap in r152+."),this.getTextureColorSpaceFromMap(e)===Ye?De:Le}getTextureColorSpaceFromMap(e){let t;return t=e&&e.isTexture?e.colorSpace:e&&e.isWebGLRenderTarget?e.texture.colorSpace:Ke,t}getComponentType(e){if("float"===(e=this.getVectorType(e))||"bool"===e||"int"===e||"uint"===e)return e;const t=/(b|i|u|)(vec|mat)([2-4])/.exec(e);return null===t?null:"b"===t[1]?"bool":"i"===t[1]?"int":"u"===t[1]?"uint":"float"}getVectorType(e){return"color"===e?"vec3":"texture"===e?"vec4":e}getTypeFromLength(e,t="float"){if(1===e)return t;const i=Cp.get(e);return("float"===t?"":t[0])+i}getTypeFromArray(e){return fp.get(e.constructor)}getTypeFromAttribute(e){let t=e;e.isInterleavedBufferAttribute&&(t=e.data);const i=t.array,n=bp.has(i.constructor)?e.itemSize:t.stride||e.itemSize,s=e.normalized;let o;return e instanceof Gn||!0===s||(o=this.getTypeFromArray(i)),this.getTypeFromLength(n,o)}getTypeLength(e){const t=this.getVectorType(e),i=/vec([2-4])/.exec(t);return null!==i?Number(i[1]):"float"===t||"bool"===t||"int"===t||"uint"===t?1:!0===/mat3/.test(e)?9:!0===/mat4/.test(e)?16:0}getVectorFromMatrix(e){return e.replace("mat","vec")}changeComponentType(e,t){return this.getTypeFromLength(this.getTypeLength(e),t)}getIntegerType(e){const t=this.getComponentType(e);return"int"===t||"uint"===t?e:this.changeComponentType(e,"int")}addStack(){return this.stack=mp(this.stack),this.stacks.push(Yc()||this.stack),Kc(this.stack),this.stack}removeStack(){const e=this.stack;return this.stack=e.parent,Kc(this.stacks.pop()),e}getDataFromNode(e,t=this.shaderStage){const i=e.isGlobal(this)?this.globalCache:this.cache;let n=i.getNodeData(e);return void 0===n&&(n={},i.setNodeData(e,n)),void 0===n[t]&&(n[t]={}),n[t]}getNodeProperties(e,t="any"){const i=this.getDataFromNode(e,t);return i.properties||(i.properties={outputNode:null})}getBufferAttributeFromNode(e,t){const i=this.getDataFromNode(e);let n=i.bufferAttribute;if(void 0===n){const s=this.uniforms.index++;n=new Zd("nodeAttribute"+s,t,e),this.bufferAttributes.push(n),i.bufferAttribute=n}return n}getStructTypeFromNode(e,t=this.shaderStage,i=null){const n=this.getDataFromNode(e,t);if(void 0===n.structType){const i=this.structs.index++;e.name=`StructType${i}`,this.structs[t].push(e),n.structType=e}return e}getUniformFromNode(e,t,i=this.shaderStage,n=null){const s=this.getDataFromNode(e,i);let o=s.uniform;if(void 0===o){const r=this.uniforms.index++;o=new Vd(n||"nodeUniform"+r,t,e),this.uniforms[i].push(o),s.uniform=o}return o}getVarFromNode(e,t=null,i=e.getNodeType(this),n=this.shaderStage){const s=this.getDataFromNode(e,n);let o=s.variable;if(void 0===o){const e=this.vars[n]||(this.vars[n]=[]);null===t&&(t="nodeVar"+e.length),o=new Wd(t,i),e.push(o),s.variable=o}return o}getVaryingFromNode(e,t){const i=this.getDataFromNode(e,"any");let n=i.varying;if(void 0===n){const e=this.varyings,s=e.length;n=new Ed("nodeVarying"+s,t),e.push(n),i.varying=n}return n}getCodeFromNode(e,t,i=this.shaderStage){const n=this.getDataFromNode(e);let s=n.code;if(void 0===s){const e=this.codes[i]||(this.codes[i]=[]),o=e.length;s=new Nd("nodeCode"+o,t),e.push(s),n.code=s}return s}addLineFlowCode(e){return""===e||(e=this.tab+e,/;\s*$/.test(e)||(e+=";\n"),this.flow.code+=e),this}addFlowCode(e){return this.flow.code+=e,this}addFlowTab(){return this.tab+="\t",this}removeFlowTab(){return this.tab=this.tab.slice(0,-1),this}getFlowData(e){return this.flowsData.get(e)}flowNode(e){const t=e.getNodeType(this),i=this.flowChildNode(e,t);return this.flowsData.set(e,i),i}flowShaderNode(e){const t=e.layout;let i;if(e.isArrayInput){i=[];for(const e of t.inputs)i.push(new Pd(e.type,e.name))}else{i={};for(const e of t.inputs)i[e.name]=new Pd(e.type,e.name)}e.layout=null;const n=e.call(i),s=this.flowStagesNode(n,t.type);return e.layout=t,s}flowStagesNode(e,t=null){const i=this.flow,n=this.vars,s=this.buildStage,o={code:""};this.flow=o,this.vars={};for(const r of Fg)this.setBuildStage(r),o.result=e.build(this,t);return o.vars=this.getVars(this.shaderStage),this.flow=i,this.vars=n,this.setBuildStage(s),o}flowChildNode(e,t=null){const i=this.flow,n={code:""};return this.flow=n,n.result=e.build(this,t),this.flow=i,n}flowNodeFromShaderStage(e,t,i=null,n=null){const s=this.shaderStage;this.setShaderStage(e);const o=this.flowChildNode(t,i);return null!==n&&(o.code+=`${this.tab+n} = ${o.result};\n`),this.flowCode[e]=this.flowCode[e]+o.code,this.setShaderStage(s),o}getAttributesArray(){return this.attributes.concat(this.bufferAttributes)}getAttributes(){console.warn("Abstract function.")}getVaryings(){console.warn("Abstract function.")}getVar(e,t){return`${this.getType(e)} ${t}`}getVars(e){let t="";const i=this.vars[e];if(void 0!==i)for(const n of i)t+=`${this.getVar(n.type,n.name)}; `;return t}getUniforms(){console.warn("Abstract function.")}getCodes(e){const t=this.codes[e];let i="";if(void 0!==t)for(const n of t)i+=n.code+"\n";return i}getHash(){return this.vertexShader+this.fragmentShader+this.computeShader}setShaderStage(e){this.shaderStage=e}getShaderStage(){return this.shaderStage}setBuildStage(e){this.buildStage=e}getBuildStage(){return this.buildStage}buildCode(){console.warn("Abstract function.")}build(){for(const e of Fg){this.setBuildStage(e),this.context.vertex&&this.context.vertex.isNode&&this.flowNodeFromShaderStage("vertex",this.context.vertex);for(const t of Xg){this.setShaderStage(t);const i=this.flowNodes[t];for(const t of i)"generate"===e?this.flowNode(t):t.build(this)}}return this.setBuildStage(null),this.setShaderStage(null),this.buildCode(),this.buildUpdateNodes(),this}getNodeUniform(e,t){if("float"===t)return new rp(e);if("vec2"===t)return new ap(e);if("vec3"===t)return new lp(e);if("vec4"===t)return new gp(e);if("color"===t)return new cp(e);if("mat3"===t)return new dp(e);if("mat4"===t)return new hp(e);throw new Error(`Uniform "${t}" not declared.`)}createNodeMaterial(e){return jI(e)}getPrimitiveType(e){let t;return t="i"===e[0]?"int":"u"===e[0]?"uint":"float",t}format(e,t,i){if((t=this.getVectorType(t))===(i=this.getVectorType(i))||null===i||this.isReference(i))return e;const n=this.getTypeLength(t),s=this.getTypeLength(i);return n>4||s>4||0===s?e:n===s?`${this.getType(i)}( ${e} )`:n>s?this.format(`${e}.${"xyz".slice(0,s)}`,this.getTypeFromLength(s,this.getComponentType(t)),i):4===s&&n>1?`${this.getType(i)}( ${this.format(e,t,"vec3")}, 1.0 )`:2===n?`${this.getType(i)}( ${this.format(e,t,"vec2")}, 0.0 )`:(1===n&&s>1&&t[0]!==i[0]&&(e=`${this.getType(this.getPrimitiveType(i))}( ${e} )`),`${this.getType(i)}( ${e} )`)}getSignature(){return`// Three.js r${o} - NodeMaterial System\n`}};const vp=class{constructor(){this.time=0,this.deltaTime=0,this.frameId=0,this.renderId=0,this.startTime=null,this.updateMap=new WeakMap,this.updateBeforeMap=new WeakMap,this.renderer=null,this.material=null,this.camera=null,this.object=null,this.scene=null}_getMaps(e,t){let i=e.get(t);return void 0===i&&(i={renderMap:new WeakMap,frameMap:new WeakMap},e.set(t,i)),i}updateBeforeNode(e){const t=e.getUpdateBeforeType(),i=e.updateReference(this),{frameMap:n,renderMap:s}=this._getMaps(this.updateBeforeMap,i);t===Vg?n.get(e)!==this.frameId&&(n.set(e,this.frameId),e.updateBefore(this)):t===Wg?s.get(e)===this.renderId&&n.get(e)===this.frameId||(s.set(e,this.renderId),n.set(e,this.frameId),e.updateBefore(this)):t===Eg&&e.updateBefore(this)}updateNode(e){const t=e.getUpdateType(),i=e.updateReference(this),{frameMap:n,renderMap:s}=this._getMaps(this.updateMap,i);t===Vg?n.get(e)!==this.frameId&&(n.set(e,this.frameId),e.update(this)):t===Wg?s.get(e)===this.renderId&&n.get(e)===this.frameId||(s.set(e,this.renderId),n.set(e,this.frameId),e.update(this)):t===Eg&&e.update(this)}update(){this.frameId++,void 0===this.lastTime&&(this.lastTime=performance.now()),this.deltaTime=(performance.now()-this.lastTime)/1e3,this.lastTime=performance.now(),this.time+=this.deltaTime}};class xp{constructor(e,t,i=null,n="",s=!1){this.type=e,this.name=t,this.count=i,this.qualifier=n,this.isConst=s}}xp.isNodeFunctionInput=!0;const Bp=xp;const wp=class{parseFunction(){console.warn("Abstract function.")}};class Sp{constructor(e,t,i="",n=""){this.type=e,this.inputs=t,this.name=i,this.presicion=n}getCode(){console.warn("Abstract function.")}}Sp.isNodeFunction=!0;const Gp=Sp,Mp=/^\s*(highp|mediump|lowp)?\s*([a-z_0-9]+)\s*([a-z_0-9]+)?\s*\(([\s\S]*?)\)/i,Rp=/[a-z_0-9]+/gi,Tp="#pragma main";const Zp=class extends Gp{constructor(e){const{type:t,inputs:i,name:n,presicion:s,inputsCode:o,blockCode:r,headerCode:a}=(e=>{const t=(e=e.trim()).indexOf(Tp),i=-1!==t?e.slice(t+12):e,n=i.match(Mp);if(null!==n&&5===n.length){const s=n[4],o=[];let r=null;for(;null!==(r=Rp.exec(s));)o.push(r);const a=[];let l=0;for(;l<o.length;){const e="const"===o[l][0];!0===e&&l++;let t=o[l][0];"in"===t||"out"===t||"inout"===t?l++:t="";const i=o[l++][0];let n=Number.parseInt(o[l][0]);!1===Number.isNaN(n)?l++:n=null;const s=o[l++][0];a.push(new Bp(i,s,n,t,e))}const g=i.substring(n[0].length),c=void 0!==n[3]?n[3]:"";return{type:n[2],inputs:a,name:c,presicion:void 0!==n[1]?n[1]:"",inputsCode:s,blockCode:g,headerCode:-1!==t?e.slice(0,t):""}}throw new Error("FunctionNode: Function is not a GLSL code.")})(e);super(t,i,n,s),this.inputsCode=o,this.blockCode=r,this.headerCode=a}getCode(e=this.name){let t;const i=this.blockCode;if(""!==i){const{type:n,inputsCode:s,headerCode:o,presicion:r}=this;let a=`${n} ${e} ( ${s.trim()} )`;""!==r&&(a=`${r} ${a}`),t=o+a+i}else t="";return t}};const Vp=class extends wp{parseFunction(e){return new Zp(e)}};const Wp=class extends kg{constructor(e){super(e.nodeType),this.node=null,this.source=null,this.target=null,this.inclusionType="replace",Object.assign(this,e)}generate(e){return this.node.build(e,this.getNodeType(e))}},Ep=new vp;Ep.camera=new cs;const Np={LineBasicNodeMaterial:Ss.basic,MeshBasicNodeMaterial:Ss.basic,PointsNodeMaterial:Ss.points,MeshStandardNodeMaterial:Ss.standard,MeshPhysicalNodeMaterial:Ss.physical,MeshPhongNodeMaterial:Ss.phong},Fp={[mh.ATAN2]:"atan"},Xp={low:"lowp",medium:"mediump",high:"highp"};function Hp(e){return`#include <${e}>`}function zp(e){return`${e}Shader`}class Lp extends _p{constructor(e,t,i,n=null){super(e,t,new Vp,null,n),this.shader=i,this.slots={vertex:[],fragment:[]},this._parseShaderLib(),this._parseInclude("fragment","lights_physical_fragment","clearcoat_normal_fragment_begin","transmission_fragment"),this._parseObject(),this._sortSlotsToFlow()}getMethod(e){return Fp[e]||e}addSlot(e,t){this.slots[e].push(t)}_parseShaderLib(){const e=this.material;let t=e.type;if(e.isMeshPhysicalNodeMaterial?t="MeshPhysicalNodeMaterial":e.isMeshStandardNodeMaterial?t="MeshStandardNodeMaterial":e.isMeshPhongNodeMaterial?t="MeshPhongNodeMaterial":e.isMeshBasicNodeMaterial?t="MeshBasicNodeMaterial":e.isPointsNodeMaterial?t="PointsNodeMaterial":e.isLineBasicNodeMaterial&&(t="LineBasicNodeMaterial"),void 0!==Np[t]){const e=Np[t],i=this.shader;i.vertexShader=e.vertexShader,i.fragmentShader=e.fragmentShader,i.uniforms=as.merge([e.uniforms,ws.lights])}}_parseObject(){const{material:e,renderer:t}=this;this.addSlot("fragment",new Wp({node:zu,nodeType:"vec3",source:Hp("clipping_planes_fragment"),target:"vec3 TransformedNormalView = %RESULT%;",inclusionType:"append"})),t.toneMappingNode&&!0===t.toneMappingNode.isNode&&this.addSlot("fragment",new Wp({node:e.colorNode,nodeType:"vec4",source:Hp("tonemapping_fragment"),target:""})),e.colorNode&&e.colorNode.isNode&&this.addSlot("fragment",new Wp({node:e.colorNode,nodeType:"vec4",source:"vec4 diffuseColor = vec4( diffuse, opacity );",target:"vec4 diffuseColor = %RESULT%; diffuseColor.a *= opacity;"})),e.opacityNode&&e.opacityNode.isNode&&this.addSlot("fragment",new Wp({node:e.opacityNode,nodeType:"float",source:Hp("alphatest_fragment"),target:"diffuseColor.a = %RESULT%;",inclusionType:"append"})),e.normalNode&&e.normalNode.isNode&&this.addSlot("fragment",new Wp({node:e.normalNode,nodeType:"vec3",source:Hp("normal_fragment_begin"),target:"normal = %RESULT%;",inclusionType:"append"})),e.emissiveNode&&e.emissiveNode.isNode&&this.addSlot("fragment",new Wp({node:e.emissiveNode,nodeType:"vec3",source:Hp("emissivemap_fragment"),target:"totalEmissiveRadiance = %RESULT%;",inclusionType:"append"})),e.isMeshStandardNodeMaterial&&(e.metalnessNode&&e.metalnessNode.isNode&&this.addSlot("fragment",new Wp({node:e.metalnessNode,nodeType:"float",source:Hp("metalnessmap_fragment"),target:"metalnessFactor = %RESULT%;",inclusionType:"append"})),e.roughnessNode&&e.roughnessNode.isNode&&this.addSlot("fragment",new Wp({node:e.roughnessNode,nodeType:"float",source:Hp("roughnessmap_fragment"),target:"roughnessFactor = %RESULT%;",inclusionType:"append"})),e.isMeshPhysicalNodeMaterial&&(e.clearcoatNode&&e.clearcoatNode.isNode?(this.addSlot("fragment",new Wp({node:e.clearcoatNode,nodeType:"float",source:"material.clearcoat = clearcoat;",target:"material.clearcoat = %RESULT%;"})),e.clearcoatRoughnessNode&&e.clearcoatRoughnessNode.isNode&&this.addSlot("fragment",new Wp({node:e.clearcoatRoughnessNode,nodeType:"float",source:"material.clearcoatRoughness = clearcoatRoughness;",target:"material.clearcoatRoughness = %RESULT%;"})),e.clearcoatNormalNode&&e.clearcoatNormalNode.isNode&&this.addSlot("fragment",new Wp({node:e.clearcoatNormalNode,nodeType:"vec3",source:"vec3 clearcoatNormal = nonPerturbedNormal;",target:"vec3 clearcoatNormal = %RESULT%;"})),e.defines.USE_CLEARCOAT=""):delete e.defines.USE_CLEARCOAT,e.sheenNode&&e.sheenNode.isNode?(this.addSlot("fragment",new Wp({node:e.sheenNode,nodeType:"vec3",source:"material.sheenColor = sheenColor;",target:"material.sheenColor = %RESULT%;"})),e.sheenRoughnessNode&&e.sheenRoughnessNode.isNode&&this.addSlot("fragment",new Wp({node:e.sheenRoughnessNode,nodeType:"float",source:"material.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );",target:"material.sheenRoughness = clamp( %RESULT%, 0.07, 1.0 );"})),e.defines.USE_SHEEN=""):delete e.defines.USE_SHEEN,e.iridescenceNode&&e.iridescenceNode.isNode?(this.addSlot("fragment",new Wp({node:e.iridescenceNode,nodeType:"float",source:"material.iridescence = iridescence;",target:"material.iridescence = %RESULT%;"})),e.iridescenceIORNode&&e.iridescenceIORNode.isNode&&this.addSlot("fragment",new Wp({node:e.iridescenceIORNode,nodeType:"float",source:"material.iridescenceIOR = iridescenceIOR;",target:"material.iridescenceIOR = %RESULT%;"})),e.iridescenceThicknessNode&&e.iridescenceThicknessNode.isNode&&this.addSlot("fragment",new Wp({node:e.iridescenceThicknessNode,nodeType:"float",source:"material.iridescenceThickness = iridescenceThicknessMaximum;",target:"material.iridescenceThickness = %RESULT%;"})),e.defines.USE_IRIDESCENCE=""):delete e.defines.USE_IRIDESCENCE,e.iorNode&&e.iorNode.isNode&&this.addSlot("fragment",new Wp({node:e.iorNode,nodeType:"float",source:"material.ior = ior;",target:"material.ior = %RESULT%;"})),e.specularColorNode&&e.specularColorNode.isNode&&this.addSlot("fragment",new Wp({node:e.specularColorNode,nodeType:"vec3",source:"vec3 specularColorFactor = specularColor;",target:"vec3 specularColorFactor = %RESULT%;"})),e.specularIntensityNode&&e.specularIntensityNode.isNode&&this.addSlot("fragment",new Wp({node:e.specularIntensityNode,nodeType:"float",source:"float specularIntensityFactor = specularIntensity;",target:"float specularIntensityFactor = %RESULT%;"})),e.transmissionNode&&e.transmissionNode.isNode?(this.addSlot("fragment",new Wp({node:e.transmissionNode,nodeType:"float",source:"material.transmission = transmission;",target:"material.transmission = %RESULT%;"})),e.thicknessNode&&e.thicknessNode.isNode&&this.addSlot("fragment",new Wp({node:e.thicknessNode,nodeType:"float",source:"material.thickness = thickness;",target:"material.thickness = %RESULT%;"})),e.attenuationDistanceNode&&e.attenuationDistanceNode.isNode&&this.addSlot("fragment",new Wp({node:e.attenuationDistanceNode,nodeType:"float",source:"material.attenuationDistance = attenuationDistance;",target:"material.attenuationDistance = %RESULT%;"})),e.attenuationColorNode&&e.attenuationColorNode.isNode&&this.addSlot("fragment",new Wp({node:e.attenuationColorNode,nodeType:"vec3",source:"material.attenuationColor = attenuationColor;",target:"material.attenuationColor = %RESULT%;"})),e.transmission=1,e.defines.USE_TRANSMISSION=""):(e.transmission=0,delete e.defines.USE_TRANSMISSION))),e.positionNode&&e.positionNode.isNode&&this.addSlot("vertex",new Wp({node:e.positionNode,nodeType:"vec3",source:Hp("begin_vertex"),target:"transformed = %RESULT%;",inclusionType:"append"})),e.sizeNode&&e.sizeNode.isNode&&this.addSlot("vertex",new Wp({node:e.sizeNode,nodeType:"float",source:"gl_PointSize = size;",target:"gl_PointSize = %RESULT%;"}))}getTexture(e,t,i){return e.isTextureCube?`textureCube( ${t}, ${i} )`:`texture2D( ${t}, ${i} )`}getTextureBias(e,t,i,n){return void 0!==this.material.extensions&&(this.material.extensions.shaderTextureLOD=!0),`textureLod( ${t}, ${i}, ${n} )`}getUniforms(e){const t=this.uniforms[e];let i="";for(const n of t){if(/^(modelViewMatrix|projectionMatrix)$/.test(n.name))continue;let e=null;if("texture"===n.type)e=`sampler2D ${n.name}; `;else if("cubeTexture"===n.type)e=`samplerCube ${n.name}; `;else{e=`${this.getVectorType(n.type)} ${n.name}; `}const t=n.node.precision;e=null!==t?"uniform "+Xp[t]+" "+e:"uniform "+e,i+=e}return i}getAttributes(e){let t="";if("vertex"===e){const e=this.attributes;for(const i of e)/^(position|normal|uv[1-3]?)$/.test(i.name)||(t+=`attribute ${i.type} ${i.name}; `)}return t}getVaryings(e){let t="";const i=this.varyings;if("vertex"===e)for(const n of i)t+=`${n.needsInterpolation?"varying":"/*varying*/"} ${n.type} ${n.name}; `;else if("fragment"===e)for(const n of i)n.needsInterpolation&&(t+=`varying ${n.type} ${n.name}; `);return t}addCode(e,t,i,n=this){const s=zp(e);let o=n[s];const r=o.indexOf(t);if(-1!==r){const e=o.substring(0,r+t.length),n=o.substring(r+t.length);o=`${e}\n${i}\n${n}`}n[s]=o}replaceCode(e,t,i,n=this){const s=zp(e);n[s]=n[s].replaceAll(t,i)}getVertexIndex(){return"gl_VertexID"}getFrontFacing(){return"gl_FrontFacing"}getFragCoord(){return"gl_FragCoord"}isFlipY(){return!0}buildCode(){const e={};for(const t of Ng){const i=this.getUniforms(t),n=this.getAttributes(t),s=this.getVaryings(t),o=this.getVars(t),r=this.getCodes(t);e[t]=`${this.getSignature()}\n// <node_builder>\n\n// uniforms\n${i}\n\n// attributes\n${n}\n\n// varyings\n${s}\n\n// vars\n${o}\n\n// codes\n${r}\n\n// </node_builder>\n\n${this.shader[zp(t)]}\n`}this.vertexShader=e.vertex,this.fragmentShader=e.fragment}build(){return super.build(),this._addSnippets(),this._addUniforms(),this._updateUniforms(),this.shader.vertexShader=this.vertexShader,this.shader.fragmentShader=this.fragmentShader,this}_parseInclude(e,...t){for(const i of t){const t=Hp(i),n=Bs[i],s=zp(e);this.shader[s]=this.shader[s].replaceAll(t,n)}}_sortSlotsToFlow(){for(const e of Ng){const t=this.shader[zp(e)],i=this.slots[e].sort(((e,i)=>t.indexOf(e.source)>t.indexOf(i.source)?1:-1));for(const n of i)this.addFlow(e,n)}}_addSnippets(){for(const e of Ng){for(const t of this.slots[e]){const i=this.getFlowData(t),n=t.inclusionType,s=t.source,o=i.code+"\n\t"+t.target.replace("%RESULT%",i.result);"append"===n?this.addCode(e,s,o):"replace"===n?this.replaceCode(e,s,o):console.warn(`Inclusion type "${n}" not compatible.`)}this.addCode(e,"main() {","\n\t"+this.flowCode[e])}}_addUniforms(){for(const e of Ng)for(const t of this.uniforms[e])this.shader.uniforms[t.name]=t}_updateUniforms(){Ep.object=this.object,Ep.renderer=this.renderer;for(const e of this.updateNodes)Ep.updateNode(e)}}const Dp=new WeakMap,Kp=new vp;An.prototype.onBuild=function(e,t,i){if(Array.isArray(e.material))for(const n of e.material)!0===n.isNodeMaterial&&Dp.set(n,new Lp(e,i,t,n).build());else!0===e.material.isNodeMaterial&&Dp.set(e.material,new Lp(e,i,t).build())},An.prototype.onBeforeRender=function(e,t,i,n,s){const o=Dp.get(this);if(void 0!==o){Kp.material=this,Kp.camera=i,Kp.object=s,Kp.renderer=e;const t=o.updateNodes;if(t.length>0){e.state.useProgram(null);for(const e of t)Kp.updateNode(e)}}};const Yp=(e,t,i,n)=>{if((t||i)&&(e=e.replace("void main()",(t||"")+"void main()\n"+(i||""))),n){const t=e.lastIndexOf("}");e=e.substring(0,t),e+=n+"}"}return e};var Pp,kp,Op,Up="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},Qp={exports:{}};kp=Up,Op=function(){return function(){return function(e){var t=[];if(0===e.length)return"";if("string"!=typeof e[0])throw new TypeError("Url must be a string. Received "+e[0]);if(e[0].match(/^[^/:]+:\/*$/)&&e.length>1){var i=e.shift();e[0]=i+e[0]}e[0].match(/^file:\/\/\//)?e[0]=e[0].replace(/^([^/:]+):\/*/,"$1:///"):e[0]=e[0].replace(/^([^/:]+):\/*/,"$1://");for(var n=0;n<e.length;n++){var s=e[n];if("string"!=typeof s)throw new TypeError("Url must be a string. Received "+s);""!==s&&(n>0&&(s=s.replace(/^[\/]+/,"")),s=n<e.length-1?s.replace(/[\/]+$/,""):s.replace(/[\/]+$/,"/"),t.push(s))}var o=t.join("/"),r=(o=o.replace(/\/(\?|&|#[^!])/g,"$1")).split("?");return r.shift()+(r.length>0?"?":"")+r.join("&")}("object"==typeof arguments[0]?arguments[0]:[].slice.call(arguments))}},(Pp=Qp).exports?Pp.exports=Op():kp.urljoin=Op();const Jp=Qp.exports;var jp,qp={exports:{}},$p={exports:{}};var em,tm={exports:{}};
/*!
   * URI.js - Mutating URLs
   * IPv6 Support
   *
   * Version: 1.19.11
   *
   * Author: Rodney Rehm
   * Web: http://medialize.github.io/URI.js/
   *
   * Licensed under
   *   MIT License http://www.opensource.org/licenses/mit-license
   *
   */var im,nm={exports:{}};
/*!
   * URI.js - Mutating URLs
   * Second Level Domain (SLD) Support
   *
   * Version: 1.19.11
   *
   * Author: Rodney Rehm
   * Web: http://medialize.github.io/URI.js/
   *
   * Licensed under
   *   MIT License http://www.opensource.org/licenses/mit-license
   *
   */
/*!
   * URI.js - Mutating URLs
   *
   * Version: 1.19.11
   *
   * Author: Rodney Rehm
   * Web: http://medialize.github.io/URI.js/
   *
   * Licensed under
   *   MIT License http://www.opensource.org/licenses/mit-license
   *
   */
!function(e){var t,i;t=Up,i=function(e,t,i,n){var s=n&&n.URI;function o(e,t){var i=arguments.length>=1;if(!(this instanceof o))return i?arguments.length>=2?new o(e,t):new o(e):new o;if(void 0===e){if(i)throw new TypeError("undefined is not a valid argument for URI");e="undefined"!=typeof location?location.href+"":""}if(null===e&&i)throw new TypeError("null is not a valid argument for URI");return this.href(e),void 0!==t?this.absoluteTo(t):this}o.version="1.19.11";var r=o.prototype,a=Object.prototype.hasOwnProperty;function l(e){return e.replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")}function g(e){return void 0===e?"Undefined":String(Object.prototype.toString.call(e)).slice(8,-1)}function c(e){return"Array"===g(e)}function d(e,t){var i,n,s={};if("RegExp"===g(t))s=null;else if(c(t))for(i=0,n=t.length;i<n;i++)s[t[i]]=!0;else s[t]=!0;for(i=0,n=e.length;i<n;i++)(s&&void 0!==s[e[i]]||!s&&t.test(e[i]))&&(e.splice(i,1),n--,i--);return e}function h(e,t){var i,n;if(c(t)){for(i=0,n=t.length;i<n;i++)if(!h(e,t[i]))return!1;return!0}var s=g(t);for(i=0,n=e.length;i<n;i++)if("RegExp"===s){if("string"==typeof e[i]&&e[i].match(t))return!0}else if(e[i]===t)return!0;return!1}function u(e,t){if(!c(e)||!c(t))return!1;if(e.length!==t.length)return!1;e.sort(),t.sort();for(var i=0,n=e.length;i<n;i++)if(e[i]!==t[i])return!1;return!0}function I(e){return e.replace(/^\/+|\/+$/g,"")}function p(e){return escape(e)}function m(e){return encodeURIComponent(e).replace(/[!'()*]/g,p).replace(/\*/g,"%2A")}o._parts=function(){return{protocol:null,username:null,password:null,hostname:null,urn:null,port:null,path:null,query:null,fragment:null,preventInvalidHostname:o.preventInvalidHostname,duplicateQueryParameters:o.duplicateQueryParameters,escapeQuerySpace:o.escapeQuerySpace}},o.preventInvalidHostname=!1,o.duplicateQueryParameters=!1,o.escapeQuerySpace=!0,o.protocol_expression=/^[a-z][a-z0-9.+-]*$/i,o.idn_expression=/[^a-z0-9\._-]/i,o.punycode_expression=/(xn--)/i,o.ip4_expression=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,o.ip6_expression=/^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$/,o.find_uri_expression=/\b((?:[a-z][\w-]+:(?:\/{1,3}|[a-z0-9%])|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/gi,o.findUri={start:/\b(?:([a-z][a-z0-9.+-]*:\/\/)|www\.)/gi,end:/[\s\r\n]|$/,trim:/[`!()\[\]{};:'".,<>?«»“”„‘’]+$/,parens:/(\([^\)]*\)|\[[^\]]*\]|\{[^}]*\}|<[^>]*>)/g},o.leading_whitespace_expression=/^[\x00-\x20\u00a0\u1680\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]+/,o.ascii_tab_whitespace=/[\u0009\u000A\u000D]+/g,o.defaultPorts={http:"80",https:"443",ftp:"21",gopher:"70",ws:"80",wss:"443"},o.hostProtocols=["http","https"],o.invalid_hostname_characters=/[^a-zA-Z0-9\.\-:_]/,o.domAttributes={a:"href",blockquote:"cite",link:"href",base:"href",script:"src",form:"action",img:"src",area:"href",iframe:"src",embed:"src",source:"src",track:"src",input:"src",audio:"src",video:"src"},o.getDomAttribute=function(e){if(e&&e.nodeName){var t=e.nodeName.toLowerCase();if("input"!==t||"image"===e.type)return o.domAttributes[t]}},o.encode=m,o.decode=decodeURIComponent,o.iso8859=function(){o.encode=escape,o.decode=unescape},o.unicode=function(){o.encode=m,o.decode=decodeURIComponent},o.characters={pathname:{encode:{expression:/%(24|26|2B|2C|3B|3D|3A|40)/gi,map:{"%24":"$","%26":"&","%2B":"+","%2C":",","%3B":";","%3D":"=","%3A":":","%40":"@"}},decode:{expression:/[\/\?#]/g,map:{"/":"%2F","?":"%3F","#":"%23"}}},reserved:{encode:{expression:/%(21|23|24|26|27|28|29|2A|2B|2C|2F|3A|3B|3D|3F|40|5B|5D)/gi,map:{"%3A":":","%2F":"/","%3F":"?","%23":"#","%5B":"[","%5D":"]","%40":"@","%21":"!","%24":"$","%26":"&","%27":"'","%28":"(","%29":")","%2A":"*","%2B":"+","%2C":",","%3B":";","%3D":"="}}},urnpath:{encode:{expression:/%(21|24|27|28|29|2A|2B|2C|3B|3D|40)/gi,map:{"%21":"!","%24":"$","%27":"'","%28":"(","%29":")","%2A":"*","%2B":"+","%2C":",","%3B":";","%3D":"=","%40":"@"}},decode:{expression:/[\/\?#:]/g,map:{"/":"%2F","?":"%3F","#":"%23",":":"%3A"}}}},o.encodeQuery=function(e,t){var i=o.encode(e+"");return void 0===t&&(t=o.escapeQuerySpace),t?i.replace(/%20/g,"+"):i},o.decodeQuery=function(e,t){e+="",void 0===t&&(t=o.escapeQuerySpace);try{return o.decode(t?e.replace(/\+/g,"%20"):e)}catch(pb){return e}};var A,C={encode:"encode",decode:"decode"},f=function(e,t){return function(i){try{return o[t](i+"").replace(o.characters[e][t].expression,(function(i){return o.characters[e][t].map[i]}))}catch(pb){return i}}};for(A in C)o[A+"PathSegment"]=f("pathname",C[A]),o[A+"UrnPathSegment"]=f("urnpath",C[A]);var b=function(e,t,i){return function(n){var s;s=i?function(e){return o[t](o[i](e))}:o[t];for(var r=(n+"").split(e),a=0,l=r.length;a<l;a++)r[a]=s(r[a]);return r.join(e)}};function y(e){return function(t,i){return void 0===t?this._parts[e]||"":(this._parts[e]=t||null,this.build(!i),this)}}function _(e,t){return function(i,n){return void 0===i?this._parts[e]||"":(null!==i&&(i+="").charAt(0)===t&&(i=i.substring(1)),this._parts[e]=i,this.build(!n),this)}}o.decodePath=b("/","decodePathSegment"),o.decodeUrnPath=b(":","decodeUrnPathSegment"),o.recodePath=b("/","encodePathSegment","decode"),o.recodeUrnPath=b(":","encodeUrnPathSegment","decode"),o.encodeReserved=f("reserved","encode"),o.parse=function(e,t){var i;return t||(t={preventInvalidHostname:o.preventInvalidHostname}),(i=(e=(e=e.replace(o.leading_whitespace_expression,"")).replace(o.ascii_tab_whitespace,"")).indexOf("#"))>-1&&(t.fragment=e.substring(i+1)||null,e=e.substring(0,i)),(i=e.indexOf("?"))>-1&&(t.query=e.substring(i+1)||null,e=e.substring(0,i)),"//"===(e=(e=e.replace(/^(https?|ftp|wss?)?:+[/\\]*/i,"$1://")).replace(/^[/\\]{2,}/i,"//")).substring(0,2)?(t.protocol=null,e=e.substring(2),e=o.parseAuthority(e,t)):(i=e.indexOf(":"))>-1&&(t.protocol=e.substring(0,i)||null,t.protocol&&!t.protocol.match(o.protocol_expression)?t.protocol=void 0:"//"===e.substring(i+1,i+3).replace(/\\/g,"/")?(e=e.substring(i+3),e=o.parseAuthority(e,t)):(e=e.substring(i+1),t.urn=!0)),t.path=e,t},o.parseHost=function(e,t){e||(e="");var i,n,s=(e=e.replace(/\\/g,"/")).indexOf("/");if(-1===s&&(s=e.length),"["===e.charAt(0))i=e.indexOf("]"),t.hostname=e.substring(1,i)||null,t.port=e.substring(i+2,s)||null,"/"===t.port&&(t.port=null);else{var r=e.indexOf(":"),a=e.indexOf("/"),l=e.indexOf(":",r+1);-1!==l&&(-1===a||l<a)?(t.hostname=e.substring(0,s)||null,t.port=null):(n=e.substring(0,s).split(":"),t.hostname=n[0]||null,t.port=n[1]||null)}return t.hostname&&"/"!==e.substring(s).charAt(0)&&(s++,e="/"+e),t.preventInvalidHostname&&o.ensureValidHostname(t.hostname,t.protocol),t.port&&o.ensureValidPort(t.port),e.substring(s)||"/"},o.parseAuthority=function(e,t){return e=o.parseUserinfo(e,t),o.parseHost(e,t)},o.parseUserinfo=function(e,t){var i=e;-1!==e.indexOf("\\")&&(e=e.replace(/\\/g,"/"));var n,s=e.indexOf("/"),r=e.lastIndexOf("@",s>-1?s:e.length-1);return r>-1&&(-1===s||r<s)?(n=e.substring(0,r).split(":"),t.username=n[0]?o.decode(n[0]):null,n.shift(),t.password=n[0]?o.decode(n.join(":")):null,e=i.substring(r+1)):(t.username=null,t.password=null),e},o.parseQuery=function(e,t){if(!e)return{};if(!(e=e.replace(/&+/g,"&").replace(/^\?*&*|&+$/g,"")))return{};for(var i,n,s,r={},l=e.split("&"),g=l.length,c=0;c<g;c++)i=l[c].split("="),n=o.decodeQuery(i.shift(),t),s=i.length?o.decodeQuery(i.join("="),t):null,"__proto__"!==n&&(a.call(r,n)?("string"!=typeof r[n]&&null!==r[n]||(r[n]=[r[n]]),r[n].push(s)):r[n]=s);return r},o.build=function(e){var t="",i=!1;return e.protocol&&(t+=e.protocol+":"),e.urn||!t&&!e.hostname||(t+="//",i=!0),t+=o.buildAuthority(e)||"","string"==typeof e.path&&("/"!==e.path.charAt(0)&&i&&(t+="/"),t+=e.path),"string"==typeof e.query&&e.query&&(t+="?"+e.query),"string"==typeof e.fragment&&e.fragment&&(t+="#"+e.fragment),t},o.buildHost=function(e){var t="";return e.hostname?(o.ip6_expression.test(e.hostname)?t+="["+e.hostname+"]":t+=e.hostname,e.port&&(t+=":"+e.port),t):""},o.buildAuthority=function(e){return o.buildUserinfo(e)+o.buildHost(e)},o.buildUserinfo=function(e){var t="";return e.username&&(t+=o.encode(e.username)),e.password&&(t+=":"+o.encode(e.password)),t&&(t+="@"),t},o.buildQuery=function(e,t,i){var n,s,r,l,g="";for(s in e)if("__proto__"!==s&&a.call(e,s))if(c(e[s]))for(n={},r=0,l=e[s].length;r<l;r++)void 0!==e[s][r]&&void 0===n[e[s][r]+""]&&(g+="&"+o.buildQueryParameter(s,e[s][r],i),!0!==t&&(n[e[s][r]+""]=!0));else void 0!==e[s]&&(g+="&"+o.buildQueryParameter(s,e[s],i));return g.substring(1)},o.buildQueryParameter=function(e,t,i){return o.encodeQuery(e,i)+(null!==t?"="+o.encodeQuery(t,i):"")},o.addQuery=function(e,t,i){if("object"==typeof t)for(var n in t)a.call(t,n)&&o.addQuery(e,n,t[n]);else{if("string"!=typeof t)throw new TypeError("URI.addQuery() accepts an object, string as the name parameter");if(void 0===e[t])return void(e[t]=i);"string"==typeof e[t]&&(e[t]=[e[t]]),c(i)||(i=[i]),e[t]=(e[t]||[]).concat(i)}},o.setQuery=function(e,t,i){if("object"==typeof t)for(var n in t)a.call(t,n)&&o.setQuery(e,n,t[n]);else{if("string"!=typeof t)throw new TypeError("URI.setQuery() accepts an object, string as the name parameter");e[t]=void 0===i?null:i}},o.removeQuery=function(e,t,i){var n,s,r;if(c(t))for(n=0,s=t.length;n<s;n++)e[t[n]]=void 0;else if("RegExp"===g(t))for(r in e)t.test(r)&&(e[r]=void 0);else if("object"==typeof t)for(r in t)a.call(t,r)&&o.removeQuery(e,r,t[r]);else{if("string"!=typeof t)throw new TypeError("URI.removeQuery() accepts an object, string, RegExp as the first parameter");void 0!==i?"RegExp"===g(i)?!c(e[t])&&i.test(e[t])?e[t]=void 0:e[t]=d(e[t],i):e[t]!==String(i)||c(i)&&1!==i.length?c(e[t])&&(e[t]=d(e[t],i)):e[t]=void 0:e[t]=void 0}},o.hasQuery=function(e,t,i,n){switch(g(t)){case"String":break;case"RegExp":for(var s in e)if(a.call(e,s)&&t.test(s)&&(void 0===i||o.hasQuery(e,s,i)))return!0;return!1;case"Object":for(var r in t)if(a.call(t,r)&&!o.hasQuery(e,r,t[r]))return!1;return!0;default:throw new TypeError("URI.hasQuery() accepts a string, regular expression or object as the name parameter")}switch(g(i)){case"Undefined":return t in e;case"Boolean":return i===Boolean(c(e[t])?e[t].length:e[t]);case"Function":return!!i(e[t],t,e);case"Array":return!!c(e[t])&&(n?h:u)(e[t],i);case"RegExp":return c(e[t])?!!n&&h(e[t],i):Boolean(e[t]&&e[t].match(i));case"Number":i=String(i);case"String":return c(e[t])?!!n&&h(e[t],i):e[t]===i;default:throw new TypeError("URI.hasQuery() accepts undefined, boolean, string, number, RegExp, Function as the value parameter")}},o.joinPaths=function(){for(var e=[],t=[],i=0,n=0;n<arguments.length;n++){var s=new o(arguments[n]);e.push(s);for(var r=s.segment(),a=0;a<r.length;a++)"string"==typeof r[a]&&t.push(r[a]),r[a]&&i++}if(!t.length||!i)return new o("");var l=new o("").segment(t);return""!==e[0].path()&&"/"!==e[0].path().slice(0,1)||l.path("/"+l.path()),l.normalize()},o.commonPath=function(e,t){var i,n=Math.min(e.length,t.length);for(i=0;i<n;i++)if(e.charAt(i)!==t.charAt(i)){i--;break}return i<1?e.charAt(0)===t.charAt(0)&&"/"===e.charAt(0)?"/":"":("/"===e.charAt(i)&&"/"===t.charAt(i)||(i=e.substring(0,i).lastIndexOf("/")),e.substring(0,i+1))},o.withinString=function(e,t,i){i||(i={});var n=i.start||o.findUri.start,s=i.end||o.findUri.end,r=i.trim||o.findUri.trim,a=i.parens||o.findUri.parens,l=/[a-z0-9-]=["']?$/i;for(n.lastIndex=0;;){var g=n.exec(e);if(!g)break;var c=g.index;if(i.ignoreHtml){var d=e.slice(Math.max(c-3,0),c);if(d&&l.test(d))continue}for(var h=c+e.slice(c).search(s),u=e.slice(c,h),I=-1;;){var p=a.exec(u);if(!p)break;var m=p.index+p[0].length;I=Math.max(I,m)}if(!((u=I>-1?u.slice(0,I)+u.slice(I).replace(r,""):u.replace(r,"")).length<=g[0].length||i.ignore&&i.ignore.test(u))){var A=t(u,c,h=c+u.length,e);void 0!==A?(A=String(A),e=e.slice(0,c)+A+e.slice(h),n.lastIndex=c+A.length):n.lastIndex=h}}return n.lastIndex=0,e},o.ensureValidHostname=function(t,i){var n=!!t,s=!1;if(!!i&&(s=h(o.hostProtocols,i)),s&&!n)throw new TypeError("Hostname cannot be empty, if protocol is "+i);if(t&&t.match(o.invalid_hostname_characters)){if(!e)throw new TypeError('Hostname "'+t+'" contains characters other than [A-Z0-9.-:_] and Punycode.js is not available');if(e.toASCII(t).match(o.invalid_hostname_characters))throw new TypeError('Hostname "'+t+'" contains characters other than [A-Z0-9.-:_]')}},o.ensureValidPort=function(e){if(e){var t=Number(e);if(!(/^[0-9]+$/.test(t)&&t>0&&t<65536))throw new TypeError('Port "'+e+'" is not a valid port')}},o.noConflict=function(e){if(e){var t={URI:this.noConflict()};return n.URITemplate&&"function"==typeof n.URITemplate.noConflict&&(t.URITemplate=n.URITemplate.noConflict()),n.IPv6&&"function"==typeof n.IPv6.noConflict&&(t.IPv6=n.IPv6.noConflict()),n.SecondLevelDomains&&"function"==typeof n.SecondLevelDomains.noConflict&&(t.SecondLevelDomains=n.SecondLevelDomains.noConflict()),t}return n.URI===this&&(n.URI=s),this},r.build=function(e){return!0===e?this._deferred_build=!0:(void 0===e||this._deferred_build)&&(this._string=o.build(this._parts),this._deferred_build=!1),this},r.clone=function(){return new o(this)},r.valueOf=r.toString=function(){return this.build(!1)._string},r.protocol=y("protocol"),r.username=y("username"),r.password=y("password"),r.hostname=y("hostname"),r.port=y("port"),r.query=_("query","?"),r.fragment=_("fragment","#"),r.search=function(e,t){var i=this.query(e,t);return"string"==typeof i&&i.length?"?"+i:i},r.hash=function(e,t){var i=this.fragment(e,t);return"string"==typeof i&&i.length?"#"+i:i},r.pathname=function(e,t){if(void 0===e||!0===e){var i=this._parts.path||(this._parts.hostname?"/":"");return e?(this._parts.urn?o.decodeUrnPath:o.decodePath)(i):i}return this._parts.urn?this._parts.path=e?o.recodeUrnPath(e):"":this._parts.path=e?o.recodePath(e):"/",this.build(!t),this},r.path=r.pathname,r.href=function(e,t){var i;if(void 0===e)return this.toString();this._string="",this._parts=o._parts();var n=e instanceof o,s="object"==typeof e&&(e.hostname||e.path||e.pathname);if(e.nodeName&&(e=e[o.getDomAttribute(e)]||"",s=!1),!n&&s&&void 0!==e.pathname&&(e=e.toString()),"string"==typeof e||e instanceof String)this._parts=o.parse(String(e),this._parts);else{if(!n&&!s)throw new TypeError("invalid input");var r=n?e._parts:e;for(i in r)"query"!==i&&a.call(this._parts,i)&&(this._parts[i]=r[i]);r.query&&this.query(r.query,!1)}return this.build(!t),this},r.is=function(e){var t=!1,n=!1,s=!1,r=!1,a=!1,l=!1,g=!1,c=!this._parts.urn;switch(this._parts.hostname&&(c=!1,n=o.ip4_expression.test(this._parts.hostname),s=o.ip6_expression.test(this._parts.hostname),a=(r=!(t=n||s))&&i&&i.has(this._parts.hostname),l=r&&o.idn_expression.test(this._parts.hostname),g=r&&o.punycode_expression.test(this._parts.hostname)),e.toLowerCase()){case"relative":return c;case"absolute":return!c;case"domain":case"name":return r;case"sld":return a;case"ip":return t;case"ip4":case"ipv4":case"inet4":return n;case"ip6":case"ipv6":case"inet6":return s;case"idn":return l;case"url":return!this._parts.urn;case"urn":return!!this._parts.urn;case"punycode":return g}return null};var v=r.protocol,x=r.port,B=r.hostname;r.protocol=function(e,t){if(e&&!(e=e.replace(/:(\/\/)?$/,"")).match(o.protocol_expression))throw new TypeError('Protocol "'+e+"\" contains characters other than [A-Z0-9.+-] or doesn't start with [A-Z]");return v.call(this,e,t)},r.scheme=r.protocol,r.port=function(e,t){return this._parts.urn?void 0===e?"":this:(void 0!==e&&(0===e&&(e=null),e&&(":"===(e+="").charAt(0)&&(e=e.substring(1)),o.ensureValidPort(e))),x.call(this,e,t))},r.hostname=function(e,t){if(this._parts.urn)return void 0===e?"":this;if(void 0!==e){var i={preventInvalidHostname:this._parts.preventInvalidHostname};if("/"!==o.parseHost(e,i))throw new TypeError('Hostname "'+e+'" contains characters other than [A-Z0-9.-]');e=i.hostname,this._parts.preventInvalidHostname&&o.ensureValidHostname(e,this._parts.protocol)}return B.call(this,e,t)},r.origin=function(e,t){if(this._parts.urn)return void 0===e?"":this;if(void 0===e){var i=this.protocol();return this.authority()?(i?i+"://":"")+this.authority():""}var n=o(e);return this.protocol(n.protocol()).authority(n.authority()).build(!t),this},r.host=function(e,t){if(this._parts.urn)return void 0===e?"":this;if(void 0===e)return this._parts.hostname?o.buildHost(this._parts):"";if("/"!==o.parseHost(e,this._parts))throw new TypeError('Hostname "'+e+'" contains characters other than [A-Z0-9.-]');return this.build(!t),this},r.authority=function(e,t){if(this._parts.urn)return void 0===e?"":this;if(void 0===e)return this._parts.hostname?o.buildAuthority(this._parts):"";if("/"!==o.parseAuthority(e,this._parts))throw new TypeError('Hostname "'+e+'" contains characters other than [A-Z0-9.-]');return this.build(!t),this},r.userinfo=function(e,t){if(this._parts.urn)return void 0===e?"":this;if(void 0===e){var i=o.buildUserinfo(this._parts);return i?i.substring(0,i.length-1):i}return"@"!==e[e.length-1]&&(e+="@"),o.parseUserinfo(e,this._parts),this.build(!t),this},r.resource=function(e,t){var i;return void 0===e?this.path()+this.search()+this.hash():(i=o.parse(e),this._parts.path=i.path,this._parts.query=i.query,this._parts.fragment=i.fragment,this.build(!t),this)},r.subdomain=function(e,t){if(this._parts.urn)return void 0===e?"":this;if(void 0===e){if(!this._parts.hostname||this.is("IP"))return"";var i=this._parts.hostname.length-this.domain().length-1;return this._parts.hostname.substring(0,i)||""}var n=this._parts.hostname.length-this.domain().length,s=this._parts.hostname.substring(0,n),r=new RegExp("^"+l(s));if(e&&"."!==e.charAt(e.length-1)&&(e+="."),-1!==e.indexOf(":"))throw new TypeError("Domains cannot contain colons");return e&&o.ensureValidHostname(e,this._parts.protocol),this._parts.hostname=this._parts.hostname.replace(r,e),this.build(!t),this},r.domain=function(e,t){if(this._parts.urn)return void 0===e?"":this;if("boolean"==typeof e&&(t=e,e=void 0),void 0===e){if(!this._parts.hostname||this.is("IP"))return"";var i=this._parts.hostname.match(/\./g);if(i&&i.length<2)return this._parts.hostname;var n=this._parts.hostname.length-this.tld(t).length-1;return n=this._parts.hostname.lastIndexOf(".",n-1)+1,this._parts.hostname.substring(n)||""}if(!e)throw new TypeError("cannot set domain empty");if(-1!==e.indexOf(":"))throw new TypeError("Domains cannot contain colons");if(o.ensureValidHostname(e,this._parts.protocol),!this._parts.hostname||this.is("IP"))this._parts.hostname=e;else{var s=new RegExp(l(this.domain())+"$");this._parts.hostname=this._parts.hostname.replace(s,e)}return this.build(!t),this},r.tld=function(e,t){if(this._parts.urn)return void 0===e?"":this;if("boolean"==typeof e&&(t=e,e=void 0),void 0===e){if(!this._parts.hostname||this.is("IP"))return"";var n=this._parts.hostname.lastIndexOf("."),s=this._parts.hostname.substring(n+1);return!0!==t&&i&&i.list[s.toLowerCase()]&&i.get(this._parts.hostname)||s}var o;if(!e)throw new TypeError("cannot set TLD empty");if(e.match(/[^a-zA-Z0-9-]/)){if(!i||!i.is(e))throw new TypeError('TLD "'+e+'" contains characters other than [A-Z0-9]');o=new RegExp(l(this.tld())+"$"),this._parts.hostname=this._parts.hostname.replace(o,e)}else{if(!this._parts.hostname||this.is("IP"))throw new ReferenceError("cannot set TLD on non-domain host");o=new RegExp(l(this.tld())+"$"),this._parts.hostname=this._parts.hostname.replace(o,e)}return this.build(!t),this},r.directory=function(e,t){if(this._parts.urn)return void 0===e?"":this;if(void 0===e||!0===e){if(!this._parts.path&&!this._parts.hostname)return"";if("/"===this._parts.path)return"/";var i=this._parts.path.length-this.filename().length-1,n=this._parts.path.substring(0,i)||(this._parts.hostname?"/":"");return e?o.decodePath(n):n}var s=this._parts.path.length-this.filename().length,r=this._parts.path.substring(0,s),a=new RegExp("^"+l(r));return this.is("relative")||(e||(e="/"),"/"!==e.charAt(0)&&(e="/"+e)),e&&"/"!==e.charAt(e.length-1)&&(e+="/"),e=o.recodePath(e),this._parts.path=this._parts.path.replace(a,e),this.build(!t),this},r.filename=function(e,t){if(this._parts.urn)return void 0===e?"":this;if("string"!=typeof e){if(!this._parts.path||"/"===this._parts.path)return"";var i=this._parts.path.lastIndexOf("/"),n=this._parts.path.substring(i+1);return e?o.decodePathSegment(n):n}var s=!1;"/"===e.charAt(0)&&(e=e.substring(1)),e.match(/\.?\//)&&(s=!0);var r=new RegExp(l(this.filename())+"$");return e=o.recodePath(e),this._parts.path=this._parts.path.replace(r,e),s?this.normalizePath(t):this.build(!t),this},r.suffix=function(e,t){if(this._parts.urn)return void 0===e?"":this;if(void 0===e||!0===e){if(!this._parts.path||"/"===this._parts.path)return"";var i,n,s=this.filename(),r=s.lastIndexOf(".");return-1===r?"":(i=s.substring(r+1),n=/^[a-z0-9%]+$/i.test(i)?i:"",e?o.decodePathSegment(n):n)}"."===e.charAt(0)&&(e=e.substring(1));var a,g=this.suffix();if(g)a=e?new RegExp(l(g)+"$"):new RegExp(l("."+g)+"$");else{if(!e)return this;this._parts.path+="."+o.recodePath(e)}return a&&(e=o.recodePath(e),this._parts.path=this._parts.path.replace(a,e)),this.build(!t),this},r.segment=function(e,t,i){var n=this._parts.urn?":":"/",s=this.path(),o="/"===s.substring(0,1),r=s.split(n);if(void 0!==e&&"number"!=typeof e&&(i=t,t=e,e=void 0),void 0!==e&&"number"!=typeof e)throw new Error('Bad segment "'+e+'", must be 0-based integer');if(o&&r.shift(),e<0&&(e=Math.max(r.length+e,0)),void 0===t)return void 0===e?r:r[e];if(null===e||void 0===r[e])if(c(t)){r=[];for(var a=0,l=t.length;a<l;a++)(t[a].length||r.length&&r[r.length-1].length)&&(r.length&&!r[r.length-1].length&&r.pop(),r.push(I(t[a])))}else(t||"string"==typeof t)&&(t=I(t),""===r[r.length-1]?r[r.length-1]=t:r.push(t));else t?r[e]=I(t):r.splice(e,1);return o&&r.unshift(""),this.path(r.join(n),i)},r.segmentCoded=function(e,t,i){var n,s,r;if("number"!=typeof e&&(i=t,t=e,e=void 0),void 0===t){if(c(n=this.segment(e,t,i)))for(s=0,r=n.length;s<r;s++)n[s]=o.decode(n[s]);else n=void 0!==n?o.decode(n):void 0;return n}if(c(t))for(s=0,r=t.length;s<r;s++)t[s]=o.encode(t[s]);else t="string"==typeof t||t instanceof String?o.encode(t):t;return this.segment(e,t,i)};var w=r.query;return r.query=function(e,t){if(!0===e)return o.parseQuery(this._parts.query,this._parts.escapeQuerySpace);if("function"==typeof e){var i=o.parseQuery(this._parts.query,this._parts.escapeQuerySpace),n=e.call(this,i);return this._parts.query=o.buildQuery(n||i,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),this.build(!t),this}return void 0!==e&&"string"!=typeof e?(this._parts.query=o.buildQuery(e,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),this.build(!t),this):w.call(this,e,t)},r.setQuery=function(e,t,i){var n=o.parseQuery(this._parts.query,this._parts.escapeQuerySpace);if("string"==typeof e||e instanceof String)n[e]=void 0!==t?t:null;else{if("object"!=typeof e)throw new TypeError("URI.addQuery() accepts an object, string as the name parameter");for(var s in e)a.call(e,s)&&(n[s]=e[s])}return this._parts.query=o.buildQuery(n,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),"string"!=typeof e&&(i=t),this.build(!i),this},r.addQuery=function(e,t,i){var n=o.parseQuery(this._parts.query,this._parts.escapeQuerySpace);return o.addQuery(n,e,void 0===t?null:t),this._parts.query=o.buildQuery(n,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),"string"!=typeof e&&(i=t),this.build(!i),this},r.removeQuery=function(e,t,i){var n=o.parseQuery(this._parts.query,this._parts.escapeQuerySpace);return o.removeQuery(n,e,t),this._parts.query=o.buildQuery(n,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),"string"!=typeof e&&(i=t),this.build(!i),this},r.hasQuery=function(e,t,i){var n=o.parseQuery(this._parts.query,this._parts.escapeQuerySpace);return o.hasQuery(n,e,t,i)},r.setSearch=r.setQuery,r.addSearch=r.addQuery,r.removeSearch=r.removeQuery,r.hasSearch=r.hasQuery,r.normalize=function(){return this._parts.urn?this.normalizeProtocol(!1).normalizePath(!1).normalizeQuery(!1).normalizeFragment(!1).build():this.normalizeProtocol(!1).normalizeHostname(!1).normalizePort(!1).normalizePath(!1).normalizeQuery(!1).normalizeFragment(!1).build()},r.normalizeProtocol=function(e){return"string"==typeof this._parts.protocol&&(this._parts.protocol=this._parts.protocol.toLowerCase(),this.build(!e)),this},r.normalizeHostname=function(i){return this._parts.hostname&&(this.is("IDN")&&e?this._parts.hostname=e.toASCII(this._parts.hostname):this.is("IPv6")&&t&&(this._parts.hostname=t.best(this._parts.hostname)),this._parts.hostname=this._parts.hostname.toLowerCase(),this.build(!i)),this},r.normalizePort=function(e){return"string"==typeof this._parts.protocol&&this._parts.port===o.defaultPorts[this._parts.protocol]&&(this._parts.port=null,this.build(!e)),this},r.normalizePath=function(e){var t,i=this._parts.path;if(!i)return this;if(this._parts.urn)return this._parts.path=o.recodeUrnPath(this._parts.path),this.build(!e),this;if("/"===this._parts.path)return this;var n,s,r="";for("/"!==(i=o.recodePath(i)).charAt(0)&&(t=!0,i="/"+i),"/.."!==i.slice(-3)&&"/."!==i.slice(-2)||(i+="/"),i=i.replace(/(\/(\.\/)+)|(\/\.$)/g,"/").replace(/\/{2,}/g,"/"),t&&(r=i.substring(1).match(/^(\.\.\/)+/)||"")&&(r=r[0]);-1!==(n=i.search(/\/\.\.(\/|$)/));)0!==n?(-1===(s=i.substring(0,n).lastIndexOf("/"))&&(s=n),i=i.substring(0,s)+i.substring(n+3)):i=i.substring(3);return t&&this.is("relative")&&(i=r+i.substring(1)),this._parts.path=i,this.build(!e),this},r.normalizePathname=r.normalizePath,r.normalizeQuery=function(e){return"string"==typeof this._parts.query&&(this._parts.query.length?this.query(o.parseQuery(this._parts.query,this._parts.escapeQuerySpace)):this._parts.query=null,this.build(!e)),this},r.normalizeFragment=function(e){return this._parts.fragment||(this._parts.fragment=null,this.build(!e)),this},r.normalizeSearch=r.normalizeQuery,r.normalizeHash=r.normalizeFragment,r.iso8859=function(){var e=o.encode,t=o.decode;o.encode=escape,o.decode=decodeURIComponent;try{this.normalize()}finally{o.encode=e,o.decode=t}return this},r.unicode=function(){var e=o.encode,t=o.decode;o.encode=m,o.decode=unescape;try{this.normalize()}finally{o.encode=e,o.decode=t}return this},r.readable=function(){var t=this.clone();t.username("").password("").normalize();var i="";if(t._parts.protocol&&(i+=t._parts.protocol+"://"),t._parts.hostname&&(t.is("punycode")&&e?(i+=e.toUnicode(t._parts.hostname),t._parts.port&&(i+=":"+t._parts.port)):i+=t.host()),t._parts.hostname&&t._parts.path&&"/"!==t._parts.path.charAt(0)&&(i+="/"),i+=t.path(!0),t._parts.query){for(var n="",s=0,r=t._parts.query.split("&"),a=r.length;s<a;s++){var l=(r[s]||"").split("=");n+="&"+o.decodeQuery(l[0],this._parts.escapeQuerySpace).replace(/&/g,"%26"),void 0!==l[1]&&(n+="="+o.decodeQuery(l[1],this._parts.escapeQuerySpace).replace(/&/g,"%26"))}i+="?"+n.substring(1)}return i+=o.decodeQuery(t.hash(),!0)},r.absoluteTo=function(e){var t,i,n,s=this.clone(),r=["protocol","username","password","hostname","port"];if(this._parts.urn)throw new Error("URNs do not have any generally defined hierarchical components");if(e instanceof o||(e=new o(e)),s._parts.protocol)return s;if(s._parts.protocol=e._parts.protocol,this._parts.hostname)return s;for(i=0;n=r[i];i++)s._parts[n]=e._parts[n];return s._parts.path?(".."===s._parts.path.substring(-2)&&(s._parts.path+="/"),"/"!==s.path().charAt(0)&&(t=(t=e.directory())||(0===e.path().indexOf("/")?"/":""),s._parts.path=(t?t+"/":"")+s._parts.path,s.normalizePath())):(s._parts.path=e._parts.path,s._parts.query||(s._parts.query=e._parts.query)),s.build(),s},r.relativeTo=function(e){var t,i,n,s,r,a=this.clone().normalize();if(a._parts.urn)throw new Error("URNs do not have any generally defined hierarchical components");if(e=new o(e).normalize(),t=a._parts,i=e._parts,s=a.path(),r=e.path(),"/"!==s.charAt(0))throw new Error("URI is already relative");if("/"!==r.charAt(0))throw new Error("Cannot calculate a URI relative to another relative URI");if(t.protocol===i.protocol&&(t.protocol=null),t.username!==i.username||t.password!==i.password)return a.build();if(null!==t.protocol||null!==t.username||null!==t.password)return a.build();if(t.hostname!==i.hostname||t.port!==i.port)return a.build();if(t.hostname=null,t.port=null,s===r)return t.path="",a.build();if(!(n=o.commonPath(s,r)))return a.build();var l=i.path.substring(n.length).replace(/[^\/]*$/,"").replace(/.*?\//g,"../");return t.path=l+t.path.substring(n.length)||"./",a.build()},r.equals=function(e){var t,i,n,s,r,l=this.clone(),g=new o(e),d={};if(l.normalize(),g.normalize(),l.toString()===g.toString())return!0;if(n=l.query(),s=g.query(),l.query(""),g.query(""),l.toString()!==g.toString())return!1;if(n.length!==s.length)return!1;for(r in t=o.parseQuery(n,this._parts.escapeQuerySpace),i=o.parseQuery(s,this._parts.escapeQuerySpace),t)if(a.call(t,r)){if(c(t[r])){if(!u(t[r],i[r]))return!1}else if(t[r]!==i[r])return!1;d[r]=!0}for(r in i)if(a.call(i,r)&&!d[r])return!1;return!0},r.preventInvalidHostname=function(e){return this._parts.preventInvalidHostname=!!e,this},r.duplicateQueryParameters=function(e){return this._parts.duplicateQueryParameters=!!e,this},r.escapeQuerySpace=function(e){return this._parts.escapeQuerySpace=!!e,this},o},e.exports?e.exports=i((jp||(jp=1,function(e,t){!function(i){var n=t&&!t.nodeType&&t,s=e&&!e.nodeType&&e,o="object"==typeof Up&&Up;o.global!==o&&o.window!==o&&o.self!==o||(i=o);var r,a,l=2147483647,g=36,c=1,d=26,h=38,u=700,I=72,p=128,m="-",A=/^xn--/,C=/[^\x20-\x7E]/,f=/[\x2E\u3002\uFF0E\uFF61]/g,b={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},y=g-c,_=Math.floor,v=String.fromCharCode;function x(e){throw new RangeError(b[e])}function B(e,t){for(var i=e.length,n=[];i--;)n[i]=t(e[i]);return n}function w(e,t){var i=e.split("@"),n="";return i.length>1&&(n=i[0]+"@",e=i[1]),n+B((e=e.replace(f,".")).split("."),t).join(".")}function S(e){for(var t,i,n=[],s=0,o=e.length;s<o;)(t=e.charCodeAt(s++))>=55296&&t<=56319&&s<o?56320==(64512&(i=e.charCodeAt(s++)))?n.push(((1023&t)<<10)+(1023&i)+65536):(n.push(t),s--):n.push(t);return n}function G(e){return B(e,(function(e){var t="";return e>65535&&(t+=v((e-=65536)>>>10&1023|55296),e=56320|1023&e),t+v(e)})).join("")}function M(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function R(e,t,i){var n=0;for(e=i?_(e/u):e>>1,e+=_(e/t);e>y*d>>1;n+=g)e=_(e/y);return _(n+(y+1)*e/(e+h))}function T(e){var t,i,n,s,o,r,a,h,u,A,C,f=[],b=e.length,y=0,v=p,B=I;for((i=e.lastIndexOf(m))<0&&(i=0),n=0;n<i;++n)e.charCodeAt(n)>=128&&x("not-basic"),f.push(e.charCodeAt(n));for(s=i>0?i+1:0;s<b;){for(o=y,r=1,a=g;s>=b&&x("invalid-input"),((h=(C=e.charCodeAt(s++))-48<10?C-22:C-65<26?C-65:C-97<26?C-97:g)>=g||h>_((l-y)/r))&&x("overflow"),y+=h*r,!(h<(u=a<=B?c:a>=B+d?d:a-B));a+=g)r>_(l/(A=g-u))&&x("overflow"),r*=A;B=R(y-o,t=f.length+1,0==o),_(y/t)>l-v&&x("overflow"),v+=_(y/t),y%=t,f.splice(y++,0,v)}return G(f)}function Z(e){var t,i,n,s,o,r,a,h,u,A,C,f,b,y,B,w=[];for(f=(e=S(e)).length,t=p,i=0,o=I,r=0;r<f;++r)(C=e[r])<128&&w.push(v(C));for(n=s=w.length,s&&w.push(m);n<f;){for(a=l,r=0;r<f;++r)(C=e[r])>=t&&C<a&&(a=C);for(a-t>_((l-i)/(b=n+1))&&x("overflow"),i+=(a-t)*b,t=a,r=0;r<f;++r)if((C=e[r])<t&&++i>l&&x("overflow"),C==t){for(h=i,u=g;!(h<(A=u<=o?c:u>=o+d?d:u-o));u+=g)B=h-A,y=g-A,w.push(v(M(A+B%y,0))),h=_(B/y);w.push(v(M(h,0))),o=R(i,b,n==s),i=0,++n}++i,++t}return w.join("")}if(r={version:"1.3.2",ucs2:{decode:S,encode:G},decode:T,encode:Z,toASCII:function(e){return w(e,(function(e){return C.test(e)?"xn--"+Z(e):e}))},toUnicode:function(e){return w(e,(function(e){return A.test(e)?T(e.slice(4).toLowerCase()):e}))}},n&&s)if(e.exports==n)s.exports=r;else for(a in r)r.hasOwnProperty(a)&&(n[a]=r[a]);else i.punycode=r}(Up)}($p,$p.exports)),$p.exports),(em||(em=1,function(e){var t,i;t=Up,i=function(e){var t=e&&e.IPv6;return{best:function(e){var t,i,n=e.toLowerCase().split(":"),s=n.length,o=8;for(""===n[0]&&""===n[1]&&""===n[2]?(n.shift(),n.shift()):""===n[0]&&""===n[1]?n.shift():""===n[s-1]&&""===n[s-2]&&n.pop(),-1!==n[(s=n.length)-1].indexOf(".")&&(o=7),t=0;t<s&&""!==n[t];t++);if(t<o)for(n.splice(t,1,"0000");n.length<o;)n.splice(t,0,"0000");for(var r=0;r<o;r++){i=n[r].split("");for(var a=0;a<3&&"0"===i[0]&&i.length>1;a++)i.splice(0,1);n[r]=i.join("")}var l=-1,g=0,c=0,d=-1,h=!1;for(r=0;r<o;r++)h?"0"===n[r]?c+=1:(h=!1,c>g&&(l=d,g=c)):"0"===n[r]&&(h=!0,d=r,c=1);c>g&&(l=d,g=c),g>1&&n.splice(l,g,""),s=n.length;var u="";for(""===n[0]&&(u=":"),r=0;r<s&&(u+=n[r],r!==s-1);r++)u+=":";return""===n[s-1]&&(u+=":"),u},noConflict:function(){return e.IPv6===this&&(e.IPv6=t),this}}},e.exports?e.exports=i():t.IPv6=i(t)}(tm)),tm.exports),(im||(im=1,function(e){var t,i;t=Up,i=function(e){var t=e&&e.SecondLevelDomains,i={list:{ac:" com gov mil net org ",ae:" ac co gov mil name net org pro sch ",af:" com edu gov net org ",al:" com edu gov mil net org ",ao:" co ed gv it og pb ",ar:" com edu gob gov int mil net org tur ",at:" ac co gv or ",au:" asn com csiro edu gov id net org ",ba:" co com edu gov mil net org rs unbi unmo unsa untz unze ",bb:" biz co com edu gov info net org store tv ",bh:" biz cc com edu gov info net org ",bn:" com edu gov net org ",bo:" com edu gob gov int mil net org tv ",br:" adm adv agr am arq art ato b bio blog bmd cim cng cnt com coop ecn edu eng esp etc eti far flog fm fnd fot fst g12 ggf gov imb ind inf jor jus lel mat med mil mus net nom not ntr odo org ppg pro psc psi qsl rec slg srv tmp trd tur tv vet vlog wiki zlg ",bs:" com edu gov net org ",bz:" du et om ov rg ",ca:" ab bc mb nb nf nl ns nt nu on pe qc sk yk ",ck:" biz co edu gen gov info net org ",cn:" ac ah bj com cq edu fj gd gov gs gx gz ha hb he hi hl hn jl js jx ln mil net nm nx org qh sc sd sh sn sx tj tw xj xz yn zj ",co:" com edu gov mil net nom org ",cr:" ac c co ed fi go or sa ",cy:" ac biz com ekloges gov ltd name net org parliament press pro tm ",do:" art com edu gob gov mil net org sld web ",dz:" art asso com edu gov net org pol ",ec:" com edu fin gov info med mil net org pro ",eg:" com edu eun gov mil name net org sci ",er:" com edu gov ind mil net org rochest w ",es:" com edu gob nom org ",et:" biz com edu gov info name net org ",fj:" ac biz com info mil name net org pro ",fk:" ac co gov net nom org ",fr:" asso com f gouv nom prd presse tm ",gg:" co net org ",gh:" com edu gov mil org ",gn:" ac com gov net org ",gr:" com edu gov mil net org ",gt:" com edu gob ind mil net org ",gu:" com edu gov net org ",hk:" com edu gov idv net org ",hu:" 2000 agrar bolt casino city co erotica erotika film forum games hotel info ingatlan jogasz konyvelo lakas media news org priv reklam sex shop sport suli szex tm tozsde utazas video ",id:" ac co go mil net or sch web ",il:" ac co gov idf k12 muni net org ",in:" ac co edu ernet firm gen gov i ind mil net nic org res ",iq:" com edu gov i mil net org ",ir:" ac co dnssec gov i id net org sch ",it:" edu gov ",je:" co net org ",jo:" com edu gov mil name net org sch ",jp:" ac ad co ed go gr lg ne or ",ke:" ac co go info me mobi ne or sc ",kh:" com edu gov mil net org per ",ki:" biz com de edu gov info mob net org tel ",km:" asso com coop edu gouv k medecin mil nom notaires pharmaciens presse tm veterinaire ",kn:" edu gov net org ",kr:" ac busan chungbuk chungnam co daegu daejeon es gangwon go gwangju gyeongbuk gyeonggi gyeongnam hs incheon jeju jeonbuk jeonnam k kg mil ms ne or pe re sc seoul ulsan ",kw:" com edu gov net org ",ky:" com edu gov net org ",kz:" com edu gov mil net org ",lb:" com edu gov net org ",lk:" assn com edu gov grp hotel int ltd net ngo org sch soc web ",lr:" com edu gov net org ",lv:" asn com conf edu gov id mil net org ",ly:" com edu gov id med net org plc sch ",ma:" ac co gov m net org press ",mc:" asso tm ",me:" ac co edu gov its net org priv ",mg:" com edu gov mil nom org prd tm ",mk:" com edu gov inf name net org pro ",ml:" com edu gov net org presse ",mn:" edu gov org ",mo:" com edu gov net org ",mt:" com edu gov net org ",mv:" aero biz com coop edu gov info int mil museum name net org pro ",mw:" ac co com coop edu gov int museum net org ",mx:" com edu gob net org ",my:" com edu gov mil name net org sch ",nf:" arts com firm info net other per rec store web ",ng:" biz com edu gov mil mobi name net org sch ",ni:" ac co com edu gob mil net nom org ",np:" com edu gov mil net org ",nr:" biz com edu gov info net org ",om:" ac biz co com edu gov med mil museum net org pro sch ",pe:" com edu gob mil net nom org sld ",ph:" com edu gov i mil net ngo org ",pk:" biz com edu fam gob gok gon gop gos gov net org web ",pl:" art bialystok biz com edu gda gdansk gorzow gov info katowice krakow lodz lublin mil net ngo olsztyn org poznan pwr radom slupsk szczecin torun warszawa waw wroc wroclaw zgora ",pr:" ac biz com edu est gov info isla name net org pro prof ",ps:" com edu gov net org plo sec ",pw:" belau co ed go ne or ",ro:" arts com firm info nom nt org rec store tm www ",rs:" ac co edu gov in org ",sb:" com edu gov net org ",sc:" com edu gov net org ",sh:" co com edu gov net nom org ",sl:" com edu gov net org ",st:" co com consulado edu embaixada gov mil net org principe saotome store ",sv:" com edu gob org red ",sz:" ac co org ",tr:" av bbs bel biz com dr edu gen gov info k12 name net org pol tel tsk tv web ",tt:" aero biz cat co com coop edu gov info int jobs mil mobi museum name net org pro tel travel ",tw:" club com ebiz edu game gov idv mil net org ",mu:" ac co com gov net or org ",mz:" ac co edu gov org ",na:" co com ",nz:" ac co cri geek gen govt health iwi maori mil net org parliament school ",pa:" abo ac com edu gob ing med net nom org sld ",pt:" com edu gov int net nome org publ ",py:" com edu gov mil net org ",qa:" com edu gov mil net org ",re:" asso com nom ",ru:" ac adygeya altai amur arkhangelsk astrakhan bashkiria belgorod bir bryansk buryatia cbg chel chelyabinsk chita chukotka chuvashia com dagestan e-burg edu gov grozny int irkutsk ivanovo izhevsk jar joshkar-ola kalmykia kaluga kamchatka karelia kazan kchr kemerovo khabarovsk khakassia khv kirov koenig komi kostroma kranoyarsk kuban kurgan kursk lipetsk magadan mari mari-el marine mil mordovia mosreg msk murmansk nalchik net nnov nov novosibirsk nsk omsk orenburg org oryol penza perm pp pskov ptz rnd ryazan sakhalin samara saratov simbirsk smolensk spb stavropol stv surgut tambov tatarstan tom tomsk tsaritsyn tsk tula tuva tver tyumen udm udmurtia ulan-ude vladikavkaz vladimir vladivostok volgograd vologda voronezh vrn vyatka yakutia yamal yekaterinburg yuzhno-sakhalinsk ",rw:" ac co com edu gouv gov int mil net ",sa:" com edu gov med net org pub sch ",sd:" com edu gov info med net org tv ",se:" a ac b bd c d e f g h i k l m n o org p parti pp press r s t tm u w x y z ",sg:" com edu gov idn net org per ",sn:" art com edu gouv org perso univ ",sy:" com edu gov mil net news org ",th:" ac co go in mi net or ",tj:" ac biz co com edu go gov info int mil name net nic org test web ",tn:" agrinet com defense edunet ens fin gov ind info intl mincom nat net org perso rnrt rns rnu tourism ",tz:" ac co go ne or ",ua:" biz cherkassy chernigov chernovtsy ck cn co com crimea cv dn dnepropetrovsk donetsk dp edu gov if in ivano-frankivsk kh kharkov kherson khmelnitskiy kiev kirovograd km kr ks kv lg lugansk lutsk lviv me mk net nikolaev od odessa org pl poltava pp rovno rv sebastopol sumy te ternopil uzhgorod vinnica vn zaporizhzhe zhitomir zp zt ",ug:" ac co go ne or org sc ",uk:" ac bl british-library co cym gov govt icnet jet lea ltd me mil mod national-library-scotland nel net nhs nic nls org orgn parliament plc police sch scot soc ",us:" dni fed isa kids nsn ",uy:" com edu gub mil net org ",ve:" co com edu gob info mil net org web ",vi:" co com k12 net org ",vn:" ac biz com edu gov health info int name net org pro ",ye:" co com gov ltd me net org plc ",yu:" ac co edu gov org ",za:" ac agric alt bourse city co cybernet db edu gov grondar iaccess imt inca landesign law mil net ngo nis nom olivetti org pix school tm web ",zm:" ac co com edu gov net org sch ",com:"ar br cn de eu gb gr hu jpn kr no qc ru sa se uk us uy za ",net:"gb jp se uk ",org:"ae",de:"com "},has:function(e){var t=e.lastIndexOf(".");if(t<=0||t>=e.length-1)return!1;var n=e.lastIndexOf(".",t-1);if(n<=0||n>=t-1)return!1;var s=i.list[e.slice(t+1)];return!!s&&s.indexOf(" "+e.slice(n+1,t)+" ")>=0},is:function(e){var t=e.lastIndexOf(".");if(t<=0||t>=e.length-1)return!1;if(e.lastIndexOf(".",t-1)>=0)return!1;var n=i.list[e.slice(t+1)];return!!n&&n.indexOf(" "+e.slice(0,t)+" ")>=0},get:function(e){var t=e.lastIndexOf(".");if(t<=0||t>=e.length-1)return null;var n=e.lastIndexOf(".",t-1);if(n<=0||n>=t-1)return null;var s=i.list[e.slice(t+1)];return s?s.indexOf(" "+e.slice(n+1,t)+" ")<0?null:e.slice(n+1):null},noConflict:function(){return e.SecondLevelDomains===this&&(e.SecondLevelDomains=t),this}};return i},e.exports?e.exports=i():t.SecondLevelDomains=i(t)}(nm)),nm.exports)):t.URI=i(t.punycode,t.IPv6,t.SecondLevelDomains,t)}(qp);const sm=qp.exports;function om(e){return e&&"object"==typeof e&&!Array.isArray(e)}function rm(e){return!isNaN(e)&&null!==e&&!Array.isArray(e)}function am(e){return null!=e}function lm(e,t){return null!=e?e:t}function gm(e,...t){if(!t.length)return e;const i=t.shift();if(om(e)&&om(i))for(const n in i)om(i[n])&&i[n].constructor===Object?(e[n]||Object.assign(e,{[n]:{}}),gm(e[n],i[n])):Object.assign(e,{[n]:i[n]});return gm(e,...t)}function cm(e,t=!1){if(null===e||"object"!=typeof e)return e;const i=new e.constructor;for(const n in e)if(e.hasOwnProperty(n)){let s=e[n];t&&(s=cm(s,t)),i[n]=s}return i}function dm(e,t,i){i=lm(i,!1);const n={},s=am(e),o=am(t);let r,a,l;if(s)for(r in e)e.hasOwnProperty(r)&&(a=e[r],o&&i&&"object"==typeof a&&t.hasOwnProperty(r)?(l=t[r],n[r]="object"==typeof l?dm(a,l,i):a):n[r]=a);if(o)for(r in t)t.hasOwnProperty(r)&&!n.hasOwnProperty(r)&&(l=t[r],n[r]=l);return n}const hm=Object.freeze(Object.defineProperty({__proto__:null,isObject:om,isNumber:rm,defined:am,defaultValue:lm,deepMerge:gm,clone:cm,combine:dm},Symbol.toStringTag,{value:"Module"}));let um=null;function Im(){if(null!==um)return um;let e="";if(e="string"==typeof MAPV_BASE_URL?MAPV_BASE_URL:function(){let e=document.getElementsByTagName("script");for(let t=0,i=e.length;t<i;++t){let i=e[t].getAttribute("src"),n=pm.exec(i);if(null!==n)return n[1]}return}(),!e)throw new Error("Unable to determine base URL automatically, try defining a global variable called MAPV_BASE_URL.");return um=e,e}const pm=/((?:.*\/)|^)mapvthree(\.bmap)?\.(es|umd)\.js(?:\?|\#|$)/;function mm(...e){return Jp(Im(),...e)}function Am(e,t){let i;if("undefined"!=typeof document&&(i=document),!am(t)){if(void 0===i)return e;t=lm(i.baseURI,i.location.href)}const n=new sm(e);return""!==n.scheme()?n.toString():n.absoluteTo(t).toString()}function Cm(e){const t=new sm(e);t.normalize();let i=t.path(),n=i.lastIndexOf("/");return-1!==n&&(i=i.substr(n+1)),n=i.lastIndexOf("."),i=-1===n?"":i.substr(n+1),i}function fm(e,t){let i="";const n=e.lastIndexOf("/");return-1!==n&&(i=e.substring(0,n+1)),t?(0!==(e=new sm(e)).query().length&&(i+=`?${e.query()}`),0!==e.fragment().length&&(i+=`#${e.fragment()}`),i):i}const bm=Object.freeze(Object.defineProperty({__proto__:null,getBaseUrl:Im,getAssetUrl:mm,getAbsoluteUri:Am,getExtensionFromUri:Cm,getBaseUri:fm},Symbol.toStringTag,{value:"Module"}));class ym{constructor(e){if(!e||0===e.length)throw new Error("points is required");const t=e[0][1];t.isColor?this._isColorFormat=!0:t.isVector3&&(this._isVectorFormat=!0),this._points=e}lerp(e,t){if(e<=0)return this._points[0][1];if(e>=1)return this._points[this._points.length-1][1];let i=0;for(;i<this._points.length&&!(e<=this._points[i][0]);i++);if(e>this._points[this._points.length-1][0])return this._points[this._points.length-1][1];const[n,s]=this._points[i-1],[o,r]=this._points[i],a=(e-n)/(o-n);if(this._isVectorFormat){const e=s.x+(r.x-s.x)*a,i=s.y+(r.y-s.y)*a,n=s.z+(r.z-s.z)*a;return t||(t=new Qt),t.set(e,i,n),t}if(this._isColorFormat){const e=s.r+(r.r-s.r)*a,i=s.g+(r.g-s.g)*a,n=s.b+(r.b-s.b)*a;return t||(t=new In),t.set(e,i,n),t}return s+(r-s)*a}}class _m extends qr{constructor(e={}){super(),__publicField(this,"isEmptySky",!0),__publicField(this,"_addDefaultEnvMap",!1),__publicField(this,"_time",36e3),__publicField(this,"_timeRatio",10/24),__publicField(this,"_startTimestamp",(new Date).getTime()),__publicField(this,"_timeAnimation",!1),__publicField(this,"_timeAnimationSpeed",1),__publicField(this,"_skyLightIntensity",.1),__publicField(this,"_sunLightIntensity",5.5),__publicField(this,"_skyLightAttenuationRatio",.2),__publicField(this,"_sunIntensityBias",0),__publicField(this,"_sunIntensityScale",.8),__publicField(this,"_envLightIntensity",.2),__publicField(this,"_weather","partlyCloudy"),__publicField(this,"_timeChangedListeners",[]),__publicField(this,"_sunDirection",new Qt),__publicField(this,"_localSunDirection",new Qt),__publicField(this,"_sunLightColorDay",new In(16777215)),__publicField(this,"_sunLightColorSunset",new In(15090944)),__publicField(this,"_sunLightColorCurrent",new In(16777215)),__publicField(this,"_sunRadian",null),__publicField(this,"_skyLightColorDay",new In(16777215)),__publicField(this,"_skyLightColorNight",new In(16777215)),__publicField(this,"_groundLightColorDay",new In(16777215)),__publicField(this,"_groundLightColorNight",new In(16758093)),__publicField(this,"_lightNeedsUpdate",!0),__publicField(this,"_sunNeedsUpdate",!1),__publicField(this,"_affectWorld",!1),__publicField(this,"updateSunLightShadowCamera",(()=>{const e=this.engine;if(!e.renderer.shadowMap.enabled){const e=this.sunLight;return e.position.copy(this._sunDirection),e.target.position.set(0,0,0),e.updateMatrix(),e.updateMatrixWorld(),e.target.updateMatrix(),void e.target.updateMatrixWorld()}e.rendering.shadow.updateShadow(this.sunLight,this._sunDirection,this)}));const t=this.sunLight=new ig(16777215,.6),i=this.skyLight=new ng(16755200,this._skyLightIntensity);i.position.set(0,0,1),t.castShadow=!0,t.shadow.mapSize=new bt(1024,1024),t.shadow.bias=-1e-4,this.add(t),this.add(t.target),this.add(i),t.matrixAutoUpdate=!1,t.target.matrixAutoUpdate=!1,this.renderOrder=-100,this._sunLightGradientColorLerp=new ym([[0,new In("#395e8c")],[5.5/24,new In("#395e8c")],[.25,new In("#ff0000")],[6.5/24,new In("#fad277")],[.3125,new In("#ffffff")],[.5,new In("#ffffff")]]),this.envLightIntensity=.1,void 0!==e.time&&(this._time=e.time)}afterAddToEngine(e){if(this.engine=e,!this.isDynamicSky&&!this.isStaticSky&&this._addDefaultEnvMap){const t=(new Dl).load(mm("assets/textures/sky/partlyCloudy_default.jpg"));t.mapping=w,t.colorSpace=Ye,e.rendering.scene.environment=t}this.envLightIntensity=this._envLightIntensity,this.time=this._time}beforeRemoveFromEngine(e){this.dispose()}tickTime(){const e=(new Date).getTime()-this._startTimestamp,t=86400/this._timeAnimationSpeed;this.time=e%t/t*86400}onBeforeScenePrepareRender(){if(this._timeAnimation&&this.tickTime(),(this._timeChanged||this._lightNeedsUpdate)&&(this.updateLight(),this._lightNeedsUpdate=!1),this.updateSunLightShadowCamera(),this._timeChanged){this.onTimeChanged(this._time);for(const e of this._timeChangedListeners)e(this.time);this._timeChanged=!1}}updateLight(){this.sunLight.intensity=this._sunLightIntensity,this.isCustomStaticSky?this.skyLight.intensity=0:(this.skyLight.intensity=this._skyLightIntensity,this.skyLight.color.copy(this._skyLightColorDay)),this._sunLightColorCurrent=this._sunLightGradientColorLerp.lerp(this._timeRatio>.5?1-this._timeRatio:this._timeRatio),this.sunLight.color.copy(this._sunLightColorCurrent)}addTimeChangedListener(e){-1===this._timeChangedListeners.indexOf(e)&&this._timeChangedListeners.push(e)}removeTimeChangedListener(e){const t=this._timeChangedListeners.indexOf(e);-1!==t&&this._timeChangedListeners.splice(t,1)}onTimeChanged(e){}onWeatherChanged(e){}dispose(){}get time(){return this._time}set time(e){this._time=e,this._timeRatio=e/24/3600;if(this.engine&&this.engine.map.isGlobe){const t=this._sunRadian=(e/86400+.25)*Math.PI*2,i=Math.cos(t),n=Math.sin(t);this._sunDirection.set(i,-n,0),this._localSunDirection.set(-i,-n,0)}else{const t=(e/86400-.25)*Math.PI*2,i=Math.cos(t),n=Math.sin(t);this._localSunDirection.set(i,n,0),this._sunDirection.set(i,0,n),n<-.1&&this._sunDirection.negate()}this._timeChanged=!0}get weather(){return this._weather}set weather(e){this._weather=e,this.onWeatherChanged(e)}get timeAnimation(){return this._timeAnimation}set timeAnimation(e){e&&(this._startTimestamp=(new Date).getTime()-this.time/86400*(86400/this._timeAnimationSpeed)),this._timeAnimation=e}get timeAnimationSpeed(){return this._timeAnimationSpeed}set timeAnimationSpeed(e){this._timeAnimationSpeed=e}get sunIntensityBias(){return this._sunIntensityBias}set sunIntensityBias(e){this._sunIntensityBias=e,this._lightNeedsUpdate=!0}get sunIntensityScale(){return this._sunIntensityScale}set sunIntensityScale(e){this._sunIntensityScale=e,this._lightNeedsUpdate=!0}get sunLightIntensity(){return this._sunLightIntensity}set sunLightIntensity(e){this._sunLightIntensity=e,this._lightNeedsUpdate=!0}get skyLightIntensity(){return this._skyLightIntensity}set skyLightIntensity(e){this._skyLightIntensity=e,this._lightNeedsUpdate=!0}get skyLightAttenuationRatio(){return this._skyLightAttenuationRatio}set skyLightAttenuationRatio(e){this._skyLightAttenuationRatio=e,this._lightNeedsUpdate=!0}get sunDirection(){return this._sunDirection}get localSunDirection(){return this._localSunDirection}get affectWorld(){return this._affectWorld}get envLightIntensity(){return this._envLightIntensity}set envLightIntensity(e){this._envLightIntensity=e,this.engine&&(this.engine.renderer.envMapIntensity=e)}}class vm{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}const xm=new Es(-1,1,1,-1,0,1);const Bm=new class extends Fn{constructor(){super(),this.setAttribute("position",new Mn([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new Mn([0,2,0,0,2,0],2))}};class wm{constructor(e){this._mesh=new ts(Bm,e)}dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,xm)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}}const Sm={name:"CopyShader",uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform float opacity;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\t\t\tgl_FragColor = opacity * texel;\n\n\n\t\t}"},Gm="#define GLSLIFY 1\nvarying vec2 vUv;\nvoid main() {\n\n    vUv = uv;\n\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n}",Mm="#define GLSLIFY 1\nconst float PI = 3.14159265358;\n\n// Units are in megameters.\nconst float groundRadiusMM = 6.371 * 1.0;\nconst float atmosphereRadiusMM = 6.471 * 1.0;\nconst float maxSampleLength = 2.267;\n\nconst vec2 tLUTRes = vec2(256.0, 64.0)*1.;\nconst vec2 msLUTRes = vec2(32.0, 32.0)*1.;\nconst vec2 skyLUTRes = vec2(200.0, 200.0)*2.;\n\nconst vec3 groundAlbedo = vec3(0.1);\n\n// These are per megameter.\nconst vec3 rayleighScatteringBase = vec3(5.802, 13.558, 33.1);\nconst float rayleighAbsorptionBase = 0.0;\n\nconst float mieScatteringBase = 3.996;\nconst float mieAbsorptionBase = 4.4;\n\nconst vec3 ozoneAbsorptionBase = vec3(0.650, 1.881, .085);\n\n// Quality\nconst float sunTransmittanceSteps = 40.0;\nconst float mulScattSteps = 20.0;\nconst int sqrtSamples = 8;\n\nconst int numScatteringSteps = 16;\n\nuniform float altitude;\nuniform float viewHeight;\n/*\n * Animates the sun movement.\n */\nfloat getSunAltitude(float time)\n{\n    const float periodSec = 10.0;\n    return (PI)*time/periodSec - PI/24.;\n}\nvec3 getSunDir(float time)\n{\n    // float altitude = getSunAltitude(time);\n    // altitude = 2.8;\n    return normalize(vec3(cos(altitude), sin(altitude), 0.0));\n    // return normalize(vec3(0.0, sin(altitude), -cos(altitude)));\n\n}\n\n/* Animate camera */\nvec3 getViewPos(float time){\n\n    vec3 viewPos = vec3(0.0, groundRadiusMM + 0.0000 + viewHeight, 0.0);\n\n    // anything beyond about 7 falls apart because the skyview lut doesn't have enough resolution\n    float alt_range = 50.0;\n\n    // viewPos.y += (sin(time/10.0 - PI/2.)*.5+.5) * (atmosphereRadiusMM - groundRadiusMM) * alt_range;\n\n    return viewPos;\n}\n\nfloat getMiePhase(float cosTheta) {\n    const float g = 0.8;\n    const float scale = 3.0/(8.0*PI);\n\n    float num = (1.0-g*g)*(1.0+cosTheta*cosTheta);\n    float denom = (2.0+g*g)*pow((1.0 + g*g - 2.0*g*cosTheta), 1.5);\n\n    return scale*num/denom;\n}\n\nfloat getRayleighPhase(float cosTheta) {\n    const float k = 3.0/(16.0*PI);\n    return k*(1.0+cosTheta*cosTheta);\n}\n\nvoid getScatteringValues(vec3 pos,\n                         out vec3 rayleighScattering,\n                         out float mieScattering,\n                         out vec3 extinction) {\n    float altitudeKM = (length(pos)-groundRadiusMM)*1000.0;\n    // Note: Paper gets these switched up.\n    float rayleighDensity = exp(-altitudeKM/8.0);\n    float mieDensity = exp(-altitudeKM/1.2);\n\n    rayleighScattering = rayleighScatteringBase*rayleighDensity;\n    float rayleighAbsorption = rayleighAbsorptionBase*rayleighDensity;\n\n    mieScattering = mieScatteringBase*mieDensity;\n    float mieAbsorption = mieAbsorptionBase*mieDensity;\n\n    vec3 ozoneAbsorption = ozoneAbsorptionBase*max(0.0, 1.0 - abs(altitudeKM-25.0)/15.0);\n\n    extinction = rayleighScattering + rayleighAbsorption + mieScattering + mieAbsorption + ozoneAbsorption;\n}\n\nfloat safeacos(const float x) {\n    return acos(clamp(x, -1.0, 1.0));\n}\n\n// From https://gamedev.stackexchange.com/questions/96459/fast-ray-sphere-collision-code.\nfloat rayIntersectSphere(vec3 ro, vec3 rd, float rad) {\n    float b = dot(ro, rd);\n    float c = dot(ro, ro) - rad*rad;\n    if (c > 0.0 && b > 0.0) return -1.0;\n    float discr = b*b - c;\n    if (discr < 0.0) return -1.0;\n    // Special case: inside sphere, use far discriminant\n    if (discr > b*b) return (-b + sqrt(discr));\n    return -b - sqrt(discr);\n}\n\n// From https://www.shadertoy.com/view/wlBXWK\nvec2 rayIntersectSphere2D(\n    vec3 start, // starting position of the ray\n    vec3 dir, // the direction of the ray\n    float radius // and the sphere radius\n) {\n    // ray-sphere intersection that assumes\n    // the sphere is centered at the origin.\n    // No intersection when result.x > result.y\n    float a = dot(dir, dir);\n    float b = 2.0 * dot(dir, start);\n    float c = dot(start, start) - (radius * radius);\n    float d = (b*b) - 4.0*a*c;\n    if (d < 0.0) return vec2(1e5,-1e5);\n    return vec2(\n        (-b - sqrt(d))/(2.0*a),\n        (-b + sqrt(d))/(2.0*a)\n    );\n}\n\n/*\n * Same parameterization here.\n */\nvec3 getValFromTLUT(sampler2D tex, vec2 bufferRes, vec3 pos, vec3 sunDir) {\n    float height = length(pos);\n    vec3 up = pos / height;\n\tfloat sunCosZenithAngle = dot(sunDir, up);\n    vec2 uv = vec2(tLUTRes.x*clamp(0.5 + 0.5*sunCosZenithAngle, 0.0, 1.0),\n                   tLUTRes.y*max(0.0, min(1.0, (height - groundRadiusMM)/(atmosphereRadiusMM - groundRadiusMM))));\n    uv /= bufferRes;\n    // return pos;\n    return texture2D(tex, uv).rgb;\n}\nvec3 getValFromMultiScattLUT(sampler2D tex, vec2 bufferRes, vec3 pos, vec3 sunDir) {\n    float height = length(pos);\n    vec3 up = pos / height;\n\tfloat sunCosZenithAngle = dot(sunDir, up);\n    vec2 uv = vec2(msLUTRes.x*clamp(0.5 + 0.5*sunCosZenithAngle, 0.0, 1.0),\n                   msLUTRes.y*max(0.0, min(1.0, (height - groundRadiusMM)/(atmosphereRadiusMM - groundRadiusMM))));\n    uv /= bufferRes;\n    return texture2D(tex, uv).rgb;\n}\n\n/* \n * Do raymarching : builds skyview lut inside atmoshpere, raymarches directly outside atmosphere\n*/\n\nvec3 raymarchScattering(sampler2D TLUT, vec2 TLUT_size, sampler2D MSLUT, vec2 MSLUT_size,\n                              vec3 viewPos,\n                              vec3 rayDir,\n                              vec3 sunDir,\n                              float numSteps,\n                              float maxDistance) {\n                              \n                              \n    vec2 atmos_intercept = rayIntersectSphere2D(viewPos, rayDir, atmosphereRadiusMM);\n    float terra_intercept = rayIntersectSphere(viewPos, rayDir, groundRadiusMM);\n\n    float mindist, maxdist;\n\n    if (atmos_intercept.x < atmos_intercept.y){\n        // there is an atmosphere intercept!\n        // start at the closest atmosphere intercept\n        // trace the distance between the closest and farthest intercept\n        mindist = atmos_intercept.x > 0.0 ? atmos_intercept.x : 0.0;\n\t\tmaxdist = atmos_intercept.y > 0.0 ? atmos_intercept.y : 0.0;\n    } else {\n        // no atmosphere intercept means no atmosphere!\n        return vec3(0.0);\n    }\n\n    // if in the atmosphere start at the camera\n    if (length(viewPos) < atmosphereRadiusMM) mindist=0.0;\n\n    // if there's a terra intercept that's closer than the atmosphere one,\n    // use that instead!\n    if (terra_intercept > 0.0){ // confirm valid intercepts\t\t\t\n        maxdist = terra_intercept;\n    }\n\n    // start marching at the min dist\n    vec3 pos = viewPos + mindist * rayDir;\n\n    float cosTheta = dot(rayDir, sunDir);\n\n\tfloat miePhaseValue = getMiePhase(cosTheta);\n\tfloat rayleighPhaseValue = getRayleighPhase(-cosTheta);\n\n    float diff = maxdist - mindist;\n\n    diff = min((maxDistance - mindist), diff);\n\n    vec3 lum = vec3(0.0);\n    vec3 transmittance = vec3(1.0);\n    float t = 0.0;\n\n    // 最小采样数设置为numSteps / 2.0,因为采样数越小,增加采样点效果变化越大\n    float steps = max(numSteps / 2.0, floor(numSteps * (diff / maxSampleLength)));\n    for (int fi = 0; fi < 100; fi++) {\n        float i = float(fi);\n        if (i >= steps) break;\n\n        float newT = ((i + 0.3)/steps)*diff;\n        float dt = newT - t;\n        t = newT;\n\n        vec3 newPos = pos + t*rayDir;\n\n        vec3 rayleighScattering, extinction;\n        float mieScattering;\n        \n        getScatteringValues(newPos, rayleighScattering, mieScattering, extinction);\n\n        vec3 sampleTransmittance = exp(-dt*extinction);\n\n        vec3 sunTransmittance = getValFromTLUT(TLUT, TLUT_size, newPos, sunDir);\n        vec3 psiMS = getValFromMultiScattLUT(MSLUT, MSLUT_size, newPos, sunDir);\n\n        vec3 rayleighInScattering = rayleighScattering*(rayleighPhaseValue*sunTransmittance + psiMS);\n        vec3 mieInScattering = mieScattering*(miePhaseValue*sunTransmittance + psiMS);\n        vec3 inScattering = (rayleighInScattering + mieInScattering);\n\n        // Integrated scattering within path segment.\n        vec3 scatteringIntegral = (inScattering - inScattering * sampleTransmittance) / extinction;\n\n        lum += scatteringIntegral*transmittance;\n\n        transmittance *= sampleTransmittance;\n    }\n    return lum;\n}\n\nvec3 getValFromSkyLUT(sampler2D viewTexture, vec3 viewPos, vec3 rayDir, vec3 sunDir) {\n\n    float height = length(viewPos);\n    vec3 up = viewPos / height;\n\n    float horizonAngle = safeacos(sqrt(height * height - groundRadiusMM * groundRadiusMM) / height);\n    float altitudeAngle = horizonAngle - acos(dot(rayDir, up)); // Between -PI/2 and PI/2\n    float azimuthAngle; // Between 0 and 2*PI\n\n    vec3 right = cross(sunDir, up);\n    vec3 forward = cross(up, right);\n\n    vec3 projectedDir = normalize(rayDir - up*(dot(rayDir, up)));\n    float sinTheta = dot(projectedDir, right);\n    float cosTheta = dot(projectedDir, forward);\n    azimuthAngle = atan(sinTheta, cosTheta) + PI;\n\n    // Non-linear mapping of altitude angle. See Section 5.3 of the paper.\n    float v = 0.5 + 0.5*sign(altitudeAngle)*sqrt(abs(altitudeAngle)*2.0/PI);\n    vec2 uv = vec2(azimuthAngle / (2.0*PI), v);\n    // uv *= skyLUTRes;\n    // uv /= viewResolution.xy;\n\n    // return rayDir; // vec3(rayDir.x, 0.0, 0.0);;\n    return texture2D(viewTexture, uv).rgb;\n}\n\nvec3 jodieReinhardTonemap(vec3 c) {\n    // From: https://www.shadertoy.com/view/tdSXzD\n    float l = dot(c, vec3(0.2126, 0.7152, 0.0722));\n    vec3 tc = c / (c + 1.0);\n    return mix(c / (l + 1.0), tc, tc);\n}\n\nvec4 toLinear(vec4 sRGB) {\n    bvec4 cutoff = lessThan(sRGB, vec4(0.04045));\n    vec4 higher = pow((sRGB + vec4(0.055))/vec4(1.055), vec4(2.4));\n    vec4 lower = sRGB/vec4(12.92);\n\n    // return mix(higher, lower, cutoff);\n    // 使用条件操作符替代 mix 函数\n    return vec4(\n        cutoff.x ? lower.x : higher.x,\n        cutoff.y ? lower.y : higher.y,\n        cutoff.z ? lower.z : higher.z,\n        cutoff.w ? lower.w : higher.w\n    );\n}\n\nvec4 colorSpaceTransform(vec4 color) {\n    #ifdef USE_OPAQUE_POST_STAGE\n        return toLinear(color);\n    #else\n        return color;\n    #endif\n}",Rm={uniforms:{altitude:{value:2.8},transmittanceTexture:{value:null},transmittanceResolution:{value:[256,256]},scatteringTexture:{value:null},scatteringResolution:{value:[256,256]},viewTexture:{value:null},viewResolution:{value:[256,256]},cameraDirection:{value:new Qt(0,.27,-1)},viewHeight:{value:2e-4},upDirection:{value:new Qt(0,1,0)},tWeather:{value:null},mixGrayFactor:{value:0},isEmissive:{value:!1},uTime:{value:null},uStarVisible:{value:!0},uMoonMap:{value:null},isGlobe:{value:!1}},vertexShader:"#define GLSLIFY 1\nvarying vec3 vWorldPosition;\nvarying vec2 vUv;\nvoid main() {\n    vUv = uv;\n    //vWorldPosition = normalize(vec3(modelMatrix * vec4(position, 1.0)) - cameraPosition);\n    vWorldPosition = normalize(vec3(position.x, position.y, position.z));\n    // vWorldPosition = normalize(position);\n    // gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    // gl_Position = vec4(position.x * 2.0, position.y * 2.0, 1.0, 1.0);\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    gl_Position.z = gl_Position.w;\n}\n",fragmentShader:Mm+"\n#define GLSLIFY 1\n/*\n * Modified version of Andrew Helmer's https://www.shadertoy.com/view/slSXRW \n * implementation of Sebastian Hillare's Unreal engine sky-atmosphere\n * ... still doesn't implement aerial perspective lut, just makes space views possible\n * TODO: replace sunflare with something new that works\n        allow density profiles, and thicker atmospheres (fails beyond 7.1 right now)\n */\n\n/*\n * Final output basically looks up the value from the skyLUT, and then adds a sun on top,\n * does some tonemapping.\n */\n#include <common>\nvarying vec2 vUv;\nvarying vec3 vWorldPosition;\nuniform sampler2D transmittanceTexture;\nuniform vec2 transmittanceResolution;\nuniform sampler2D viewTexture;\nuniform vec2 viewResolution;\nuniform sampler2D scatteringTexture;\nuniform vec2 scatteringResolution;\nuniform vec2 iResolution;\nuniform vec3 cameraDirection;\nuniform vec3 upDirection;\nuniform float uTime;\nuniform bool uStarVisible;\nuniform sampler2D uMoonMap;\n\nconst int star_iterations = 10;\nconst vec3 col_star = vec3( .8, 0.8, 0.7 );\n\nconst vec3 grayColor = vec3(0.5, 0.5, 0.5);\n\nvec3 sunWithBloom(vec3 rayDir, vec3 sunDir) {\n    const float sunSolidAngle = 0.01*PI/180.0;\n    const float minSunCosTheta = cos(sunSolidAngle);\n\n    float cosTheta = dot(rayDir, sunDir);\n    if (cosTheta >= minSunCosTheta) return vec3(1.0);\n\n    float offset = minSunCosTheta - cosTheta;\n    float gaussianBloom = exp(-offset*50000.0)*0.5;\n    float invBloom = 1.0/(0.02 + offset*300.0)*0.01;\n    return vec3(gaussianBloom+invBloom);\n}\n\nfloat hash( float n ) { return fract(sin(n)*123.456789); }\n\nvec2 rotate( in vec2 uv, float a) {\n    float c = cos( a );\n    float s = sin( a );\n    return vec2( c * uv.x - s * uv.y, s * uv.x + c * uv.y );\n}\n\nfloat noise( in vec3 p ) {\n    vec3 fl = floor( p );\n    vec3 fr = fract( p );\n    fr = fr * fr * ( 3.0 - 2.0 * fr );\n\n    float n = fl.x + fl.y * 157.0 + 113.0 * fl.z;\n    return mix( mix( mix( hash( n +   0.0), hash( n +   1.0 ), fr.x ),\n                     mix( hash( n + 157.0), hash( n + 158.0 ), fr.x ), fr.y ),\n                mix( mix( hash( n + 113.0), hash( n + 114.0 ), fr.x ),\n                     mix( hash( n + 270.0), hash( n + 271.0 ), fr.x ), fr.y ), fr.z );\n}\n\nfloat fbm( in vec2 p, float t ) {\n    float f;\n    f  = 0.5000 * noise( vec3( p, t ) ); p *= 2.1;\n    f += 0.2500 * noise( vec3( p, t ) ); p *= 2.2;\n    f += 0.1250 * noise( vec3( p, t ) ); p *= 2.3;\n    f += 0.0625 * noise( vec3( p, t ) );\n    return f;\n}\n\nfloat fbmByTexture( vec2 p ) {\n    return 0.5000 * texture2D( uMoonMap, p * 1.00 ).x + \n        0.2500 * texture2D( uMoonMap, p * 2.02 ).x + \n        0.1250 * texture2D( uMoonMap, p * 4.03 ).x + \n        0.0625 * texture2D( uMoonMap, p * 8.04 ).x;\n}\n\n// moon\nvec3 moonWithBloom(vec3 rayDir, vec3 moonDir) {\n    const float sunSolidAngle = .6 * PI / 180.0;\n    const float minSunCosTheta = cos(sunSolidAngle);\n\n    float cosTheta = dot(rayDir, moonDir);\n    vec3 differ = rayDir - moonDir;\n    if (cosTheta >= minSunCosTheta) {\n        vec3 moon = vec3(0.98,0.97,0.95);\n        // 月球耀斑\n        moon *= (0.30 + 0.4 * fbmByTexture(vec2(1.0) + vec2(0.2 + differ.xz + differ.yx)));\n\n        return moon;\n    }\n\n    float offset = minSunCosTheta - cosTheta;\n    float gaussianBloom = exp(-offset * 50000.0) * 0.5;\n    float invBloom = 1.0 / (0.05 + offset * 300.0) * 0.01;\n    return vec3(gaussianBloom+invBloom);\n}\n\n// 星空背景\nvec3 doBackgroundStars( in vec3 dir ) {\n    vec3 n  = abs( dir );\n    vec2 uv = ( n.x > n.y && n.x > n.z ) ? dir.yz / dir.x: \n            ( n.y > n.x && n.y > n.z ) ? dir.zx / dir.y:\n                                        dir.xy / dir.z;\n    \n    float f = 0.0;\n    \n    for( int i = 0 ; i < star_iterations; ++i ) {\n        uv = rotate( 1.07 * uv + vec2( 0.7 ), 0.5 );\n        \n        float t = 10. * uv.x * uv.y + uTime;\n        vec2 u = cos( 100. * uv ) * fbm( 10. * uv, 0.0 );\n        f += smoothstep( 0.534, 0.535, u.x * u.y );\n    }\n    \n    return f * col_star;\n}\n\nvec3 render( in vec2 uv, mat3 m ) {\n    //create view ray\n    vec3 rd  = m * normalize( vec3( uv, 1.0 ) );\n    \n    // background stars\n    vec3 c = doBackgroundStars( rd );\n    return c;\n}\n\n// vec4 toLinear(vec4 sRGB) {\n//     bvec4 cutoff = lessThan(sRGB, vec4(0.04045));\n//     vec4 higher = pow((sRGB + vec4(0.055))/vec4(1.055), vec4(2.4));\n//     vec4 lower = sRGB/vec4(12.92);\n\n//     // return mix(higher, lower, cutoff);\n//     // 使用条件操作符替代 mix 函数\n//     return vec4(\n//         cutoff.x ? lower.x : higher.x,\n//         cutoff.y ? lower.y : higher.y,\n//         cutoff.z ? lower.z : higher.z,\n//         cutoff.w ? lower.w : higher.w\n//     );\n// }\n\nvoid main() {\n    vec3 sunDir = getSunDir(0.);\n    vec3 viewPos = getViewPos(0.);\n\n    vec3 camDir = normalize(cameraDirection);\n    float camFOVWidth = PI/3.0;\n    // vec2 iResolution = vec2(1102, 1246);\n    float camWidthScale = 2.0*tan(camFOVWidth/2.0);\n    float camHeightScale = camWidthScale*iResolution.y/iResolution.x;\n\n    vec3 camRight = normalize(cross(camDir, upDirection));\n    vec3 camUp = normalize(cross(camRight, camDir));\n\n    // camRight = viewMatrix[0].xzy;\n    // camUp = viewMatrix[1].xzy;\n    // camDir = viewMatrix[2].xzy;\n    // vec2 xy = 2.0 * vWorldPosition.xy; // 2.0 * (fragCoord.xy / iResolution.xy) - 1.0;\n    vec2 xy = vWorldPosition.xy; // 2.0 * (gl_FragCoord.xy / iResolution.xy / 2.0) - 1.0;\n    // vec3 rayDir = normalize(camDir + camRight*xy.x*camWidthScale + camUp*xy.y*camHeightScale);\n    vec3 rayDir = normalize(vWorldPosition.xzy);\n    vec3 lum;\n\n    if (length(viewPos) < atmosphereRadiusMM * 1.0){\n        lum = getValFromSkyLUT(viewTexture, viewPos, rayDir, sunDir);\n    } else {\n    \n        // As mentioned in section 7 of the paper, switch to direct raymarching outside atmosphere\n        lum = raymarchScattering(transmittanceTexture, transmittanceResolution.xy,\n                                scatteringTexture, scatteringResolution.xy,\n                                viewPos, rayDir, sunDir, float(numScatteringSteps), 10e5);\n        \n        // This little bit of red helps to debug when the rendering switches to pure raymarching\n        // lum += vec3(1e-3,0.0,0.0);\n    }\n\n    // Tonemapping and gamma. Super ad-hoc, probably a better way to do this.\n    lum *= 100.0;\n    lum = jodieReinhardTonemap(lum);\n    lum = pow(lum, vec3(1.0/2.2));\n\n    // lum += sunWithBloom(rayDir, sunDir);\n    // Bloom should be added at the end, but this is subtle and works well.\n    vec3 sunLum = sunWithBloom(rayDir, sunDir);\n    // Use smoothstep to limit the effect, so it drops off to actual zero.\n    sunLum = smoothstep(0.002, 1.0, sunLum);\n    if (length(sunLum) > 0.0) {\n        if (rayIntersectSphere(viewPos, rayDir, groundRadiusMM) >= 0.0) {\n            sunLum *= 0.0;\n        } else {\n            // If the sun value is applied to this pixel, we need to calculate the transmittance to obscure it.\n            sunLum *= getValFromTLUT(transmittanceTexture, transmittanceResolution.xy, viewPos, sunDir);\n        }\n    }\n    lum += sunLum;\n\n    if (sunDir.y < 0.0) {\n        vec2 uv = vUv - vec2(0.5);\n        \n        vec3 ww = normalize(vec3(1.04, 0.0, 2.628));\n        vec3 uu = normalize( cross( ww, vec3( 0.0, 1.0, 0.0 ) ) );\n        vec3 vv = normalize( cross( uu, ww ) );\n        mat3 m = mat3( uu, vv, ww );\n\n        // 星空\n        if (rayDir.y > 0.0 && uStarVisible) {\n            // 背景初始化颜色，渐变蓝黑色\n            lum += vec3( 0.035, 0.055, 0.085 );\n            lum += vec3( 0.02, 0.05, 0.15 ) * (1. - rayDir.y);\n\n            vec3 c = render( fract(uv * 30.0), m );\n\n            // c = pow( c, vec3( 0.4545 ) );\n\n            // 星空闪烁\n            float time = uTime / 20000.0;\n            float twinkle = sin((uv.x-time+cos(uv.y*20.+time))*20.);\n            twinkle *= cos((uv.y*.234-time*3.24+sin(uv.x*12.3+time*.243))*7.34);\n            twinkle = (twinkle + 1.)/2.;\n            lum += c * twinkle * (rayDir.y * 10.0) * (1.0 - pow(max(0.0, abs(-sunDir.y - 1.0) * 2.0 - 1.0), 2.0));\n        }\n\n        // 月亮\n        vec3 moonLum = moonWithBloom(rayDir, -sunDir) * 2.0;\n        if (length(moonLum) > 0.0) {\n            float alpha = clamp(smoothstep(0.0, 0.2, rayDir.y), 0.01, 1.0);\n            moonLum *= alpha;\n        }\n        lum += moonLum;\n\n    }\n\n    gl_FragColor = vec4(lum, 1.0);\n    gl_FragColor = toLinear(gl_FragColor);\n\n    // gl_FragColor.rgb = vWorldPosition;\n    // float viewDistance = sqrt(length(vec3(rayDir.x * 10., 0.1, rayDir.z * 10.)));\n    // vec2 cloudUV = rayDir.xz * viewDistance; //rayDir.xy * length(rayDir);\n    // // cloudUV *= mix(1., 10., clamp(sqrt(rayDir.x * rayDir.x + rayDir.y * rayDir.y), 0.0, 1.0));\n    // float cloudDensity = texture2D(tWeather, cloudUV * 10.0).x;\n    // gl_FragColor.xy = (rayDir.xy + 1.0) * 0.5;\n    // gl_FragColor.z += cloudDensity;\n    // Peek at the Transmittance LUT\n    // if (gl_FragCoord.x < skyLUTRes.x && gl_FragCoord.y < skyLUTRes.y) {\n        // gl_FragColor = vec4(8.*texture(viewTexture, gl_FragCoord.xy/skyLUTRes * 0.2).rgb,1.0);\n    // }\n    // fragColor = vec4(100.*texture(transmittanceTexture, fragCoord.xy/iResolution.xy).rgb,1.0);\n\n    // Peek at the Sky View LUT\n    // gl_FragColor = vec4(8.*texture(viewTexture, gl_FragCoord.xy/iResolution.xy / 2.).rgb,1.0);\n\n    // Peek at the Multiscattering LUT\n    // fragColor = vec4(100.*texture(scatteringTexture, fragCoord.xy/iResolution.xy).rgb,1.0);\n    // if (gl_FragCoord.x < msLUTRes.x && gl_FragCoord.y < msLUTRes.y) {\n    //     gl_FragColor = vec4(100.*texture(scatteringTexture, gl_FragCoord.xy/iResolution / 2.).rgb,1.0);\n    // }\n    // gl_FragColor = vec4(100.*texture(transmittanceTexture, gl_FragCoord.xy/transmittanceResolution * 0.1).rgb,1.0);\n    #include <tonemapping_fragment>\n    #include <colorspace_fragment>\n}\n"},Tm={uniforms:{altitude:{value:2.8},viewHeight:{value:2e-4}},vertexShader:Gm,fragmentShader:Mm+"\n#define GLSLIFY 1\n// Buffer A generates the Transmittance LUT. Each pixel coordinate corresponds to a height and sun zenith angle, and\n// the value is the transmittance from that point to sun, through the atmosphere.\nvarying vec2 vUv;\nvec3 getSunTransmittance(vec3 pos, vec3 sunDir) {\n    if (rayIntersectSphere(pos, sunDir, groundRadiusMM) > 0.0) {\n        return vec3(0.0);\n    }\n\n    float atmoDist = rayIntersectSphere(pos, sunDir, atmosphereRadiusMM);\n    float t = 0.0;\n\n    vec3 transmittance = vec3(1.0);\n    for (float i = 0.0; i < sunTransmittanceSteps; i += 1.0) {\n        float newT = ((i + 0.3)/sunTransmittanceSteps)*atmoDist;\n        float dt = newT - t;\n        t = newT;\n\n        vec3 newPos = pos + t*sunDir;\n\n        vec3 rayleighScattering, extinction;\n        float mieScattering;\n        getScatteringValues(newPos, rayleighScattering, mieScattering, extinction);\n\n        transmittance *= exp(-dt*extinction);\n    }\n    return transmittance;\n}\n\nvoid main() {\n    // if (gl_FragCoord.x >= (tLUTRes.x+1.5) || gl_FragCoord.y >= (tLUTRes.y+1.5)) {\n    //     return;\n    // }\n    float u = vUv.x; // clamp(gl_FragCoord.x, 0.0, tLUTRes.x-1.0)/tLUTRes.x;\n    float v = vUv.y; // clamp(gl_FragCoord.y, 0.0, tLUTRes.y-1.0)/tLUTRes.y;\n\n    float sunCosTheta = 2.0*u - 1.0;\n    float sunTheta = safeacos(sunCosTheta);\n    float height = mix(groundRadiusMM, atmosphereRadiusMM, v);\n\n    vec3 pos = vec3(0.0, height, 0.0);\n    vec3 sunDir = normalize(vec3(0.0, sunCosTheta, -sin(sunTheta)));\n\n    gl_FragColor = vec4(getSunTransmittance(pos, sunDir), 1.0);\n}\n"},Zm={uniforms:{altitude:{value:2.8},transmittanceTexture:{value:null},transmittanceResolution:{value:[256,256]},viewHeight:{value:2e-4}},vertexShader:Gm,fragmentShader:Mm+"\n#define GLSLIFY 1\n// Buffer B is the multiple-scattering LUT. Each pixel coordinate corresponds to a height and sun zenith angle, and\n// the value is the multiple scattering approximation (Psi_ms from the paper, Eq. 10).\nvarying vec2 vUv;\nuniform sampler2D transmittanceTexture;\nuniform vec2 transmittanceResolution;\nvec3 getSphericalDir(float theta, float phi) {\n     float cosPhi = cos(phi);\n     float sinPhi = sin(phi);\n     float cosTheta = cos(theta);\n     float sinTheta = sin(theta);\n     return vec3(sinPhi*sinTheta, cosPhi, sinPhi*cosTheta);\n}\n\n// Calculates Equation (5) and (7) from the paper.\nvoid getMulScattValues(vec3 pos, vec3 sunDir, out vec3 lumTotal, out vec3 fms) {\n    lumTotal = vec3(0.0);\n    fms = vec3(0.0);\n\n    float invSamples = 1.0/float(sqrtSamples*sqrtSamples);\n    for (int i = 0; i < sqrtSamples; i++) {\n        for (int j = 0; j < sqrtSamples; j++) {\n            // This integral is symmetric about theta = 0 (or theta = PI), so we\n            // only need to integrate from zero to PI, not zero to 2*PI.\n            float theta = PI * (float(i) + 0.5) / float(sqrtSamples);\n            float phi = safeacos(1.0 - 2.0*(float(j) + 0.5) / float(sqrtSamples));\n            vec3 rayDir = getSphericalDir(theta, phi);\n\n            float atmoDist = rayIntersectSphere(pos, rayDir, atmosphereRadiusMM);\n            float groundDist = rayIntersectSphere(pos, rayDir, groundRadiusMM);\n            float tMax = atmoDist;\n            if (groundDist > 0.0) {\n                tMax = groundDist;\n            }\n\n            float cosTheta = dot(rayDir, sunDir);\n\n            float miePhaseValue = getMiePhase(cosTheta);\n            float rayleighPhaseValue = getRayleighPhase(-cosTheta);\n\n            vec3 lum = vec3(0.0), lumFactor = vec3(0.0), transmittance = vec3(1.0);\n            float t = 0.0;\n            for (float stepI = 0.0; stepI < mulScattSteps; stepI += 1.0) {\n                float newT = ((stepI + 0.3)/mulScattSteps)*tMax;\n                float dt = newT - t;\n                t = newT;\n\n                vec3 newPos = pos + t*rayDir;\n\n                vec3 rayleighScattering, extinction;\n                float mieScattering;\n                getScatteringValues(newPos, rayleighScattering, mieScattering, extinction);\n\n                vec3 sampleTransmittance = exp(-dt*extinction);\n\n                // Integrate within each segment.\n                vec3 scatteringNoPhase = rayleighScattering + mieScattering;\n                vec3 scatteringF = (scatteringNoPhase - scatteringNoPhase * sampleTransmittance) / extinction;\n                lumFactor += transmittance*scatteringF;\n\n                // This is slightly different from the paper, but I think the paper has a mistake?\n                // In equation (6), I think S(x,w_s) should be S(x-tv,w_s).\n                vec3 sunTransmittance = getValFromTLUT(transmittanceTexture, transmittanceResolution.xy, newPos, sunDir);\n\n                vec3 rayleighInScattering = rayleighScattering*rayleighPhaseValue;\n                float mieInScattering = mieScattering*miePhaseValue;\n                vec3 inScattering = (rayleighInScattering + mieInScattering)*sunTransmittance;\n\n                // Integrated scattering within path segment.\n                vec3 scatteringIntegral = (inScattering - inScattering * sampleTransmittance) / extinction;\n\n                lum += scatteringIntegral*transmittance;\n                transmittance *= sampleTransmittance;\n            }\n\n            if (groundDist > 0.0) {\n                vec3 hitPos = pos + groundDist*rayDir;\n                if (dot(pos, sunDir) > 0.0) {\n                    hitPos = normalize(hitPos)*groundRadiusMM;\n                    lum += transmittance*groundAlbedo*getValFromTLUT(transmittanceTexture, transmittanceResolution.xy, hitPos, sunDir);\n                }\n            }\n\n            fms += lumFactor*invSamples;\n            lumTotal += lum*invSamples;\n        }\n    }\n}\n\nvoid main() {\n    // if (fragCoord.x >= (msLUTRes.x+1.5) || fragCoord.y >= (msLUTRes.y+1.5)) {\n    //     return;\n    // }\n    float u = vUv.x; // clamp(fragCoord.x, 0.0, msLUTRes.x-1.0)/msLUTRes.x;\n    float v = vUv.y; // clamp(fragCoord.y, 0.0, msLUTRes.y-1.0)/msLUTRes.y;\n\n    float sunCosTheta = 2.0*u - 1.0;\n    float sunTheta = safeacos(sunCosTheta);\n    float height = mix(groundRadiusMM, atmosphereRadiusMM, v);\n\n    vec3 pos = vec3(0.0, height, 0.0);\n    vec3 sunDir = normalize(vec3(0.0, sunCosTheta, -sin(sunTheta)));\n\n    vec3 lum, f_ms;\n    getMulScattValues(pos, sunDir, lum, f_ms);\n\n    // Equation 10 from the paper.\n    vec3 psi = lum  / (1.0 - f_ms);\n    gl_FragColor = vec4(1. * psi, 1.0);\n    // gl_FragColor = vec4(vUv/ 1., 0.0, 1.0);\n}\n"},Vm={uniforms:{altitude:{value:2.8},transmittanceTexture:{value:null},transmittanceResolution:{value:[256,256]},scatteringTexture:{value:null},scatteringResolution:{value:[256,256]},viewHeight:{value:2e-4},mixGrayFactor:{value:0}},vertexShader:Gm,fragmentShader:Mm+"\n#define GLSLIFY 1\n// Buffer C calculates the actual sky-view! It's a lat-long map (or maybe altitude-azimuth is the better term),\n// but the latitude/altitude is non-linear to get more resolution near the horizon.\nvarying vec2 vUv;\nuniform sampler2D transmittanceTexture;\nuniform vec2 transmittanceResolution;\nuniform sampler2D scatteringTexture;\nuniform vec2 scatteringResolution;\nuniform float mixGrayFactor;\n\nvoid main() {\n    // if (fragCoord.x >= (skyLUTRes.x+1.5) || fragCoord.y >= (skyLUTRes.y+1.5)) {\n    //     return;\n    // }\n    float u = vUv.x; // clamp(fragCoord.x, 0.0, skyLUTRes.x-1.0)/skyLUTRes.x;\n    float v = vUv.y; // clamp(fragCoord.y, 0.0, skyLUTRes.y-1.0)/skyLUTRes.y;\n\n    float azimuthAngle = (u - 0.5)*2.0*PI;\n\n    // Non-linear mapping of altitude. See Section 5.3 of the paper.\n\n    float adjV;\n    if (v < 0.5) {\n\t\tfloat coord = 1.0 - 2.0*v;\n\t\tadjV = -coord*coord;\n\t} else {\n\t\tfloat coord = v*2.0 - 1.0;\n\t\tadjV = coord*coord;\n\t}\n\n    vec3 viewPos = getViewPos(0.);\n\n    float height = length(viewPos); vec3 up = viewPos / height;\n    float horizonAngle = safeacos(sqrt(height * height - groundRadiusMM * groundRadiusMM) / height) - 0.5*PI;\n    float altitudeAngle = adjV*0.5*PI - horizonAngle;\n\n    float cosAltitude = cos(altitudeAngle);\n    vec3 rayDir = vec3(cosAltitude*sin(azimuthAngle), sin(altitudeAngle), -cosAltitude*cos(azimuthAngle));\n\n    float sunAltitude = (0.5*PI) - acos(dot(getSunDir(0.), up));\n    vec3 sunDir = vec3(0.0, sin(sunAltitude), -cos(sunAltitude));\n\n    vec3 lum = raymarchScattering(transmittanceTexture, transmittanceResolution.xy,\n                                  scatteringTexture, scatteringResolution.xy,\n                                  viewPos, rayDir, sunDir, float(numScatteringSteps), 10e5);\n    gl_FragColor = vec4(lum, 1.0);\n\n    if (mixGrayFactor > 0.0) {\n        lum = gl_FragColor.xyz;\n        vec3 gray = vec3((lum.x + lum.y + lum.z) / 3.0);\n        lum = mix(lum, gray, mixGrayFactor);\n        gl_FragColor = vec4(lum, 1.0);\n    }\n}\n"},Wm={uniforms:{tDiffuse:{value:null},tDepth:{value:null},tNormal:{value:null},tAtmosphere:{value:null},cameraNear:{value:.1},cameraFar:{value:1e3},projectionInverseMatrix:{value:new Bi},viewInverseMatrix:{value:new Bi},mvt_viewMatrix:{value:new Bi},cameraPosition:{value:new Qt},altitude:{value:2.8},viewHeight:{value:2e-4},transmittanceTexture:{value:null},transmittanceResolution:{value:[256,256]},scatteringTexture:{value:null},scatteringResolution:{value:[256,256]},viewTexture:{value:null},viewResolution:{value:[256,256]},resolution:{value:[256,256]},cameraDirection:{value:new Qt(0,.27,-1)},sunDirection:{value:new Qt(0,1,0)},upDirection:{value:new Qt(0,0,1)},isGlobe:{value:!1},fogDepthRange:{value:new bt(0,1)},rotationMatrix:{value:new yt}},fragmentShader:Mm+"\n#define GLSLIFY 1\n#include <mvt_depth_packing>\n#include <packing>\n\nvarying vec2 vUv;\nuniform sampler2D tDiffuse;\nuniform sampler2D tDepth;\n#if defined(MVT_USE_NORMAL_TEXTURE)\n    uniform sampler2D tNormal;\n#endif\nuniform sampler2D tAtmosphere;\nuniform float cameraNear;\nuniform float cameraFar;\nuniform mat4 projectionInverseMatrix;\nuniform mat4 viewInverseMatrix;\nuniform mat4 mvt_viewMatrix;\nuniform sampler2D transmittanceTexture;\nuniform vec2 transmittanceResolution;\nuniform sampler2D viewTexture;\nuniform vec2 viewResolution;\nuniform sampler2D scatteringTexture;\nuniform vec2 scatteringResolution;\nuniform vec2 resolution;\nuniform vec3 cameraDirection;\nuniform vec3 sunDirection;\nuniform bool isGlobe;\n// uniform vec3 upDirection;\nuniform vec2 fogDepthRange;\nuniform mat3 rotationMatrix;\n\nvec3 sunWithBloom(vec3 rayDir, vec3 sunDir) {\n    const float sunSolidAngle = 0.01*PI/180.0;\n    const float minSunCosTheta = cos(sunSolidAngle);\n\n    float cosTheta = dot(rayDir, sunDir);\n    if (cosTheta >= minSunCosTheta) return vec3(1.0);\n\n    float offset = minSunCosTheta - cosTheta;\n    float gaussianBloom = exp(-offset*50000.0)*0.5;\n    float invBloom = 1.0/(0.02 + offset*300.0)*0.01;\n    return vec3(gaussianBloom+invBloom);\n}\n\nvoid main() {\n    vec4 diffuse = texelFetch(tDiffuse, ivec2(gl_FragCoord.xy), 0);\n    float depthValue = texelFetch(tDepth, ivec2(gl_FragCoord), 0).x;\n    // gl_FragColor = diffuse;\n    // return;\n    float depth = mvtGetDepthFromTexture(tDepth, vUv, cameraNear, cameraFar);\n    bool isTranslucent = diffuse.a < 1.0;\n    if (diffuse.a < 1.0) {\n        // // 透明度小于0.99，使用深度值\n        // depthValue = 1.0;\n        // depth = 1.0;\n    }\n    vec3 worldPosition = mvtGetWorldPositionByDepth(depth, vUv, projectionInverseMatrix, viewInverseMatrix); \n    vec3 viewPosition = mvtGetViewPositionByDepth(depth, vUv, projectionInverseMatrix);\n    float viewDistance = length(viewPosition) / 100000.0;\n    vec3 viewFrom = vec3(cameraPosition);\n\n    vec3 viewTo = vec3(worldPosition.xy, 0.002);\n\n    vec3 viewDir = normalize(viewTo - viewFrom);\n\n    vec3 sunDir = sunDirection;\n    vec3 viewPos = getViewPos(0.);\n\n    float maxDistance = length(viewPosition) / 1000000.0;\n\n    float camFOVWidth = 35.0 / 180.0 * PI;\n\n    float camHeightScale = tan(camFOVWidth / 2.0);\n    float camWidthScale = camHeightScale * resolution.x / resolution.y;\n\n    vec3 camRight   = vec3( viewInverseMatrix[0][0],  viewInverseMatrix[0][1],  viewInverseMatrix[0][2]);\n    vec3 camUp      = vec3( viewInverseMatrix[1][0],  viewInverseMatrix[1][1],  viewInverseMatrix[1][2]);\n\tvec3 camDir = vec3(-viewInverseMatrix[2][0], -viewInverseMatrix[2][1], -viewInverseMatrix[2][2]);\n\n    vec2 nxy = vUv.xy * 2.0 - 1.0;\n    vec3 rayDir = normalize(camDir + camRight * nxy.x * camWidthScale  + camUp * nxy.y * camHeightScale).xzy;\n\n    vec3 lum;\n    bool isInSpace = length(viewPos) > atmosphereRadiusMM * 1.0;\n    float atmoFactor = 0.0;\n    if (length(viewPos) < atmosphereRadiusMM * 1.0){\n        // 禁止半透明像素参与计算raymarching\n        if (depthValue < 0.99 && !isTranslucent) {\n            lum = raymarchScattering(transmittanceTexture, transmittanceResolution.xy,\n                        scatteringTexture, scatteringResolution.xy,\n                        viewPos, rayDir, sunDir, float(numScatteringSteps), maxDistance);\n        }\n        else {\n            lum = getValFromSkyLUT(viewTexture, viewPos, rayDir, sunDir);\n        }\n        \n    } else {\n        // As mentioned in section 7 of the paper, switch to direct raymarching outside atmosphere\n        lum = raymarchScattering(transmittanceTexture, transmittanceResolution.xy,\n                                scatteringTexture, scatteringResolution.xy,\n                                viewPos, rayDir, sunDir, float(numScatteringSteps), 10e5);\n        atmoFactor = clamp(lum.x * 30.0, 0.0, 1.0);\n    }\n    atmoFactor = clamp(lum.x * 30.0, 0.0, 1.0);\n    lum *= 20.0;\n    lum = jodieReinhardTonemap(lum);\n    lum = pow(lum, vec3(1.0/2.2));\n\n    if (depthValue > 0.99) {\n        vec3 sunLum = vec3(0.0);\n        sunLum = sunWithBloom(rayDir, sunDir);\n        // Use smoothstep to limit the effect, so it drops off to actual zero.\n        sunLum = smoothstep(0.002, 1.0, sunLum);\n        if (length(sunLum) > 0.0) {\n            if (rayIntersectSphere(viewPos, rayDir, groundRadiusMM) >= 0.0) {\n                sunLum *= 0.0;\n            }\n        }\n        lum += sunLum;\n    }\n\n    vec4 atmo = colorSpaceTransform(vec4(lum, 1.0));\n    gl_FragColor = atmo;\n \n    // 从50km高度到100km高度，大气层逐渐变淡\n    float cameraHeight = cameraPosition.z;\n    if (isGlobe) {\n        cameraHeight = length(cameraPosition) - 6371000.0;\n    }\n    float ratio = 1.0 - clamp((cameraHeight - 50000.0) / 50000.0, 0.0, 1.0);\n    ratio = 1.0;\n\n    float viewRatio = 1.0;\n    if (!isGlobe){\n        viewRatio = 1.0 - dot(normalize(vec3(viewInverseMatrix[2])), vec3(0.0, 0.0, 1));\n        viewRatio = clamp((viewRatio - 0.3) * 1.5, 0.0, 1.0);\n    }\n\n    float depthThreshold = mix(0.996, 0.992, clamp(cameraHeight / 100000.0, 0.0, 1.0));\n    if (depthValue < depthThreshold && ratio > 0.0 && !isTranslucent) {\n\n        float fogDepth = depthValue;\n        float fogDensity = 1.;\n        float fogStart = mix(0.8, 0.95, ratio);\n        fogDepth = clamp((fogDepth - fogStart) / (1.0 - fogStart), 0.0, 1.0);\n        \n        float atmoFinalFactor = 0.0;\n        if (isGlobe) {\n            if (isInSpace) {\n                atmoFinalFactor = atmoFactor;\n            }\n            else {\n                float heightRatio = 1.0 - clamp(viewHeight * 10.0, 0.0, 1.0);\n                heightRatio = heightRatio * heightRatio;\n                float viewDepth = clamp((depthValue - fogDepthRange.x) / (fogDepthRange.y - fogDepthRange.x), 0.0, 1.0);\n                viewDepth = 1.0 - exp(- 2.0 * viewDepth * viewDepth);\n                atmoFinalFactor = mix(atmoFactor, viewDepth, heightRatio);\n            }\n        }\n        else {\n            atmoFinalFactor = fogDepth * ratio * viewRatio;\n        }\n        #if defined(MVT_DEBUG_INTENSITY)\n            gl_FragColor = vec4(atmoFinalFactor, 0.0, 0.0, 1.0);\n        #else\n            gl_FragColor = mix(diffuse, atmo, atmoFinalFactor);\n        #endif\n    } \n    else {\n        // 有颜色的区域必须都尝试去混合，需要考虑部分depthTest关闭的物体也需要显示\n        if (diffuse.a > 0.001) {\n            #if defined(MVT_DEBUG_INTENSITY)\n                gl_FragColor = vec4(diffuse.a, 0.0, 0.0, 1.0);\n            #else\n                gl_FragColor.rgb = mix(gl_FragColor.rgb, diffuse.rgb / diffuse.a, diffuse.a);\n            #endif\n            // gl_FragColor.a = diffuse.a;\n            // gl_FragColor = vec4(0.0, 1.0, 0.0, diffuse.a);\n            // gl_FragColor = vec4(lum, 1.0);\n        }\n        else {\n            // gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n        }\n        \n    }\n}"},Em={uniforms:{tDiffuse:{value:null},tDepth:{value:null},cameraNear:{value:.1},cameraFar:{value:1e3},viewInverseMatrix:{value:new Bi},cameraPosition:{value:new Qt},viewHeight:{value:2e-4},resolution:{value:[256,256]},cameraDirection:{value:new Qt(0,.27,-1)},sunDirection:{value:new Qt(0,1,0)},isGlobe:{value:!1},fogDepthRange:{value:new bt(0,1)},rotationMatrix:{value:new yt},projectionInverseMatrix:{value:new Bi},color:{value:new In},highColor:{value:new In}},fragmentShader:Mm+"\n#define GLSLIFY 1\n#include <mvt_depth_packing>\n#include <packing>\n\nuniform vec3 highColor;\nuniform vec3 color;\nvarying vec2 vUv;\nuniform float cameraNear;\nuniform float cameraFar;\nuniform sampler2D tDiffuse;\nuniform sampler2D tDepth;\nuniform vec2 resolution;\nuniform bool isGlobe;\nuniform vec2 fogDepthRange;\nuniform mat4 viewInverseMatrix;\nuniform mat4 projectionInverseMatrix;\nvoid main() {\n    // float depthValue = texture2D(tDepth, vUv).x;\n    // 按像素精确采样深度值\n    float depthValue = texelFetch(tDepth, ivec2(gl_FragCoord), 0).x;\n    float depth = mvtGetDepthFromTexture(tDepth, vUv, cameraNear, cameraFar);\n    vec3 viewPosition = mvtGetViewPositionByDepth(depth, vUv, projectionInverseMatrix);\n\n    float maxDistance = length(viewPosition) / 1000000.0;\n    vec4 diffuse = texture2D(tDiffuse, vUv);\n    bool isTranslucent = diffuse.a < 1.0;\n\n    vec3 viewPos = getViewPos(0.);\n\n    float cameraHeight = cameraPosition.z;\n\n    float camFOVWidth = 35.0 / 180.0 * PI;\n    float camHeightScale = tan(camFOVWidth / 2.0);\n    float camWidthScale = camHeightScale * resolution.x / resolution.y;\n\n    vec3 camRight   = vec3( viewInverseMatrix[0][0],  viewInverseMatrix[0][1],  viewInverseMatrix[0][2]);\n    vec3 camUp      = vec3( viewInverseMatrix[1][0],  viewInverseMatrix[1][1],  viewInverseMatrix[1][2]);\n\tvec3 camDir = vec3(-viewInverseMatrix[2][0], -viewInverseMatrix[2][1], -viewInverseMatrix[2][2]);\n\n    vec2 nxy = vUv.xy * 2.0 - 1.0;\n    vec3 rayDir = normalize(camDir + camRight * nxy.x * camWidthScale  + camUp * nxy.y * camHeightScale).xzy;\n\n    vec2 atmos_intercept = rayIntersectSphere2D(viewPos, rayDir, atmosphereRadiusMM);\n    float terra_intercept = rayIntersectSphere(viewPos, rayDir, groundRadiusMM);\n\n    float mindist, maxdist;\n    float dist = 0.0;\n    if (atmos_intercept.x < atmos_intercept.y){\n        mindist = atmos_intercept.x > 0.0 ? atmos_intercept.x : 0.0;\n        maxdist = atmos_intercept.y > 0.0 ? atmos_intercept.y : 0.0;\n    }\n    float height = length(viewPos);\n    if (height < atmosphereRadiusMM) mindist=0.0;\n    if (terra_intercept > 0.0){ // confirm valid intercepts\t\t\t\n        maxdist = terra_intercept;\n    }\n\n    float depthThreshold = mix(0.996, 0.992, clamp(cameraHeight / 100000.0, 0.0, 1.0));\n    float diff = maxdist - mindist;\n\n    float cosTheta = groundRadiusMM / atmosphereRadiusMM;\n    float cosRadians = acos(cosTheta);\n    float maxAtmosphereDist = atmosphereRadiusMM * sin(cosRadians);\n\n    float horizonDist = sqrt(height * height - groundRadiusMM * groundRadiusMM);\n    // float factor = diff / horizonDist;\n\n    // ratio用于取过渡颜色\n    // remappedRatio用于设置透明度(线性过渡颜色变化太大,用非线性变化)\n    // https://www.desmos.com/calculator/raytthuk1q?lang=zh-CN\n    float ratio;\n    float factor;\n    bool isInSpace = false;\n    float remappedRatio;\n    if (height < atmosphereRadiusMM) {\n        if (depthValue < depthThreshold && !isTranslucent) {\n            diff = min(maxDistance, maxdist) - mindist;\n        }\n        // 通过穿过大气的路径和从当前视点出发能够经过的最长路径的比值作为ratio\n        ratio = clamp(1.0 - cos((PI / 2.0) * (diff / (maxAtmosphereDist + horizonDist))), 0.0, 1.0);\n        remappedRatio = 1.0 - exp(-50.0 * ratio);\n        if (terra_intercept > 0.0) factor = diff / horizonDist;\n    }\n    else {\n        // 通过穿过大气的路径计算高度，利用高度得到ratio\n        isInSpace = true;\n        float halfDiff = diff * 0.5;\n        float sinTheta = halfDiff / atmosphereRadiusMM;\n        float sinRadians = asin(sinTheta);\n        float atmospherHeight = atmosphereRadiusMM - groundRadiusMM;\n        ratio = 1.0 - cos((PI / 2.0) * (diff / (maxAtmosphereDist * 2.0)));\n\n        float ratioScale = min(max((atmospherHeight / viewHeight), 0.8), 1.0);\n        float ratioScaled = (1.0 - ratioScale) * ratio + ratioScale;\n\n        // 随着高度的上升透明度从非线性变为线性过渡\n        float unlinearRatio = (1.0 - exp(-(10.0) * ratio));\n        float h = min(max(((atmospherHeight * 2.0 - viewHeight) / atmospherHeight), 0.0) ,1.0);\n        remappedRatio = (unlinearRatio * h + ratio * (1.0 - h)) * ratioScaled;\n        if (terra_intercept > 0.0) factor = diff / maxAtmosphereDist;\n    }\n\n    float ratioValue = 1.0 - ratio;\n    vec3 outColor;\n    if (ratioValue <= 0.0) {\n        outColor = color;\n    }\n    else if (ratioValue < 0.3) {\n        float t = smoothstep(0.0, 1.0, (ratioValue / 0.3));\n        outColor = mix(color, highColor, t);\n    }\n    else {\n        outColor = highColor;\n    }\n\n    vec3 outputColor;\n    if (terra_intercept > 0.0) {\n        // 如果和地球相交，使用底部颜色\n        outputColor = color * factor;\n    }\n    else {\n        outputColor = outColor * remappedRatio;\n    }\n\n    float viewRatio = 1.0;\n    if (isGlobe) {\n        // viewRatio = 1.0 - clamp(dot(normalize(vec3(viewInverseMatrix[2])), upDirection), 0.0, 1.0);\n        // viewRatio = clamp((viewRatio - 0.3) * 1.5, 0.0, 1.0);\n        // viewRatio = 1.;\n    }\n    else {\n        viewRatio = 1.0 - dot(normalize(vec3(viewInverseMatrix[2])), vec3(0.0, 0.0, 1));\n        viewRatio = clamp((viewRatio - 0.3) * 1.5, 0.0, 1.0);\n    }\n\n    outputColor = colorSpaceTransform(vec4(outputColor, 1.0)).rgb;\n\n    float atmoFactor = diff / maxAtmosphereDist;\n    if (depthValue < depthThreshold && ratio >= 0.0 && !isTranslucent) {\n        vec4 atmo = colorSpaceTransform(vec4(color, 1.0));\n        float fogDepth = depthValue;\n\n        float fogDensity = 1.;\n        float fogStart = mix(0.8, 0.95, ratio);\n        fogDepth = clamp((fogDepth - fogStart) / (1.0 - fogStart), 0.0, 1.0);\n\n        float atmoFinalFactor = 0.0;\n        if (isGlobe) {\n            if (isInSpace) {\n                atmoFinalFactor = atmoFactor;\n            }\n            else {\n                float heightRatio = 1.0 - clamp(viewHeight * 10.0, 0.0, 1.0);\n                heightRatio = heightRatio * heightRatio;\n                // float maxDistance = 0.5 + heightRatio * 2.0;\n                float viewDepth = clamp((depthValue - fogDepthRange.x) / (fogDepthRange.y - fogDepthRange.x), 0.0, 1.0);\n                viewDepth = 1.0 - exp(- 2.0 * viewDepth * viewDepth);\n                atmoFinalFactor = mix(atmoFactor, viewDepth, heightRatio);\n            }\n        }\n        else {\n            atmoFinalFactor = fogDepth * ratio * viewRatio;\n        }\n\n        atmoFinalFactor *= atmoFinalFactor;\n\n        gl_FragColor = mix(diffuse, atmo, atmoFinalFactor);\n    }\n    else {\n        gl_FragColor = vec4(outputColor, 1.0);\n\n        float t = abs(dot(rayDir, -viewPos));\n        float distanceToGlobeCenter = sqrt(height * height - t * t);\n        \n        if (rayDir.y < 0.0 && distanceToGlobeCenter < groundRadiusMM) {\n            gl_FragColor = colorSpaceTransform(vec4(color, 1.0)); \n        }\n\n        if (diffuse.a > 0.001) {\n            gl_FragColor.rgb = mix(gl_FragColor.rgb, diffuse.rgb / diffuse.a, diffuse.a);\n        }\n    }\n\n    gl_FragColor.a = 1.0;\n\n}"},Nm=new Qt,Fm=new Qt;function Xm(e,t,i,n,s){const o=e.x,r=e.y,a=e.z,l=t.x,g=t.y,c=t.z,d=o*o*l*l,h=r*r*g*g,u=a*a*c*c,I=d+h+u,p=Math.sqrt(1/I),m=Nm.copy(e).multiplyScalar(p);if(I<n)return s||(s=new Qt),isFinite(p)?s.copy(m):void 0;const A=i.x,C=i.y,f=i.z,b=Fm;b.x=m.x*A*2,b.y=m.y*C*2,b.z=m.z*f*2;let y,_,v,x,B,w,S,G,M,R,T,Z=(1-p)*e.length()/(.5*b.length()),V=0;do{Z-=V,v=1/(1+Z*A),x=1/(1+Z*C),B=1/(1+Z*f),w=v*v,S=x*x,G=B*B,M=w*v,R=S*x,T=G*B,y=d*w+h*S+u*G-1,_=d*M*A+h*R*C+u*T*f,V=y/(-2*_)}while(Math.abs(y)>1e-12);return s?(s.x=o*v,s.y=r*x,s.z=a*B,s):new Qt(o*v,r*x,a*B)}function Hm(e){return null!=e}function zm(e,t){return null!=e?e:t}function Lm(e){let t;this.name="DeveloperError",this.message=e;try{throw new Error}catch(pb){t=pb.stack}this.stack=t}zm.EMPTY_OBJECT=Object.freeze({}),Hm(Object.create)&&(Lm.prototype=Object.create(Error.prototype),Lm.prototype.constructor=Lm),Lm.prototype.toString=function(){let e=this.name+": "+this.message;return Hm(this.stack)&&(e+="\n"+this.stack.toString()),e},Lm.throwInstantiationError=function(){throw new Lm("This function defines an interface and should not be called directly.")};const Dm=class{static equalsEpsilon(e,t,i,n){i=zm(i,0),n=zm(n,i);const s=Math.abs(e-t);return s<=n||s<=i*Math.max(Math.abs(e),Math.abs(t))}static toRadians(e){return ft.degToRad(e)}static clamp(e,t,i){return e<t?t:e>i?i:e}static acosClamped(e){return Math.acos(Dm.clamp(e,-1,1))}static asinClamped(e){return Math.asin(Dm.clamp(e,-1,1))}static sign(e){return Math.sign(e)}static zeroToTwoPi(e){if(e>=0&&e<=Dm.TWO_PI)return e;const t=Dm.mod(e,Dm.TWO_PI);return Math.abs(t)<Dm.EPSILON14&&Math.abs(e)>Dm.EPSILON14?Dm.TWO_PI:t}static mod(e,t){return Dm.sign(e)===Dm.sign(t)&&Math.abs(e)<Math.abs(t)?e:(e%t+t)%t}static chordLength(e,t){return 2*t*Math.sin(.5*e)}static negativePiToPi(e){if(!Hm(e))throw new Lm("angle is required.");return e>=-Dm.PI&&e<=Dm.PI?e:Dm.zeroToTwoPi(e+Dm.PI)-Dm.PI}static normalize(e,t,i){return 0===(i=Math.max(i-t,0))?0:Dm.clamp((e-t)/i,0,1)}};let Km=Dm;__publicField(Km,"EPSILON1",.1),__publicField(Km,"EPSILON2",.01),__publicField(Km,"EPSILON3",.001),__publicField(Km,"EPSILON4",1e-4),__publicField(Km,"EPSILON5",1e-5),__publicField(Km,"EPSILON6",1e-6),__publicField(Km,"EPSILON7",1e-7),__publicField(Km,"EPSILON8",1e-8),__publicField(Km,"EPSILON9",1e-9),__publicField(Km,"EPSILON10",1e-10),__publicField(Km,"EPSILON11",1e-11),__publicField(Km,"EPSILON12",1e-12),__publicField(Km,"EPSILON13",1e-13),__publicField(Km,"EPSILON14",1e-14),__publicField(Km,"EPSILON15",1e-15),__publicField(Km,"EPSILON16",1e-16),__publicField(Km,"EPSILON17",1e-17),__publicField(Km,"EPSILON18",1e-18),__publicField(Km,"EPSILON19",1e-19),__publicField(Km,"EPSILON20",1e-20),__publicField(Km,"EPSILON21",1e-21),__publicField(Km,"PI",Math.PI),__publicField(Km,"ONE_OVER_PI",1/Math.PI),__publicField(Km,"PI_OVER_TWO",Math.PI/2),__publicField(Km,"PI_OVER_THREE",Math.PI/3),__publicField(Km,"PI_OVER_FOUR",Math.PI/4),__publicField(Km,"PI_OVER_SIX",Math.PI/6),__publicField(Km,"THREE_PI_OVER_TWO",3*Math.PI/2),__publicField(Km,"TWO_PI",2*Math.PI),__publicField(Km,"ONE_OVER_TWO_PI",1/(2*Math.PI)),__publicField(Km,"RADIANS_PER_DEGREE",Math.PI/180);const Ym=new Qt;let Pm=new Qt,km=new Qt;const Om=new Qt(40680631590769,40680631590769,40408299984661.445),Um=new Qt,Qm=new Qt,Jm=class{constructor(){__publicField(this,"COLUMN0ROW0",0),__publicField(this,"COLUMN0ROW1",1),__publicField(this,"COLUMN0ROW2",2),__publicField(this,"COLUMN1ROW0",3),__publicField(this,"COLUMN1ROW1",4),__publicField(this,"COLUMN1ROW2",5),__publicField(this,"COLUMN2ROW0",6),__publicField(this,"COLUMN2ROW1",7),__publicField(this,"COLUMN2ROW2",8)}static clone(e,t){if(e)return t.copy(e),t}static equals(e,t){return!(!Hm(e)||!Hm(t))&&e.equals(t)}static normalize(e,t){return e===t?(e.normalize(),e):(t.copy(e),t.normalize(),t)}static add(e,t,i){return i||(i=new Qt),i.addVectors(e,t)}static dot(e,t){return e.dot(t)}static cross(e,t,i){return i||(i=new Qt),i.crossVectors(e,t),i}static magnitudeSquared(e){return e.lengthSq()}static multiplyByScalar(e,t,i){return i||(i=new Qt),i.copy(e).multiplyScalar(t),i}static divideByScalar(e,t,i){return i||(i=new Qt),i.x=e.x/t,i.y=e.y/t,i.z=e.z/t,i}static subtract(e,t,i){return i||(i=new Qt),i.subVectors(e,t),i}static distance(e,t){return e.distanceTo(t)}static negate(e,t){return t||(t=new Qt),t.copy(e),t.negate(),t}static multiplyComponents(e,t,i){return i||(i=new Qt),i.multiplyVectors(e,t),i}static magnitude(e){return e.length()}static equalsEpsilon(e,t,i,n){return e===t||Hm(e)&&Hm(t)&&Km.equalsEpsilon(e.x,t.x,i,n)&&Km.equalsEpsilon(e.y,t.y,i,n)&&Km.equalsEpsilon(e.z,t.z,i,n)}static fromCartesian4(e,t){return t||(t=new Qt),t.set(e.x,e.y,e.z),t}static fromElements(e,t,i,n){return n||(n=new Qt),n.set(e,t,i),n}static fromRadians(e,t,i,n,s){i=zm(i,0);const o=Hm(n)?n.radiiSquared:Om,r=Math.cos(t);Pm.x=r*Math.cos(e),Pm.y=r*Math.sin(e),Pm.z=Math.sin(t),Pm=Jm.normalize(Pm,Pm),Jm.multiplyComponents(o,Pm,km);const a=Math.sqrt(Jm.dot(Pm,km));return km=Jm.divideByScalar(km,a,km),Pm=Jm.multiplyByScalar(Pm,i,Pm),Hm(s)||(s=new Qt),Jm.add(km,Pm,s)}static angleBetween(e,t){Jm.normalize(e,Um),Jm.normalize(t,Qm);const i=Jm.dot(Um,Qm),n=Jm.magnitude(Jm.cross(Um,Qm,Um));return Math.atan2(n,i)}static fromDegrees(e,t,i,n,s){return e=Km.toRadians(e),t=Km.toRadians(t),Jm.fromRadians(e,t,i,n,s)}};let jm=Jm;__publicField(jm,"ZERO",Object.freeze(new Qt)),__publicField(jm,"UNIT_X",Object.freeze(new Qt(1,0,0))),__publicField(jm,"UNIT_Y",Object.freeze(new Qt(0,1,0))),__publicField(jm,"UNIT_Z",Object.freeze(new Qt(0,0,1))),__publicField(jm,"abs",(function(e,t){return t.x=Math.abs(e.x),t.y=Math.abs(e.y),t.z=Math.abs(e.z),t})),__publicField(jm,"mostOrthogonalAxis",(function(e,t){const i=Jm.normalize(e,Ym);return Jm.abs(i,i),t=i.x<=i.y?i.x<=i.z?Jm.clone(Jm.UNIT_X,t):Jm.clone(Jm.UNIT_Z,t):i.y<=i.z?Jm.clone(Jm.UNIT_Y,t):Jm.clone(Jm.UNIT_Z,t)}));const qm=new Qt,$m=new Qt;class eA{constructor(e,t,i){this._radii=new Qt(e,t,i),this._radiiSquared=new Qt(e*e,t*t,i*i),this._radiiToTheFourth=new Qt(e*e*e*e,t*t*t*t,i*i*i*i),this._oneOverRadii=new Qt(0===e?0:1/e,0===t?0:1/t,0===i?0:1/i),this._oneOverRadiiSquared=new Qt(0===e?0:1/(e*e),0===t?0:1/(t*t),0===i?0:1/(i*i)),this._minimumRadius=Math.min(e,t,i),this._maximumRadius=Math.max(e,t,i),this._centerToleranceSquared=.1,0!==this._radiiSquared.z&&(this._squaredXOverSquaredZ=this._radiiSquared.x/this._radiiSquared.z)}static fromCartesian3(e){return new eA(e.x,e.y,e.z)}geodeticSurfaceNormalCartographic(e,t){t||(t=new Qt);const i=e.x,n=e.y,s=Math.cos(n),o=s*Math.cos(i),r=s*Math.sin(i),a=Math.sin(n);return t.set(o,r,a),t.normalize(),t}cartographicDegreeToCartesian(e,t){return qm.set(ft.degToRad(e.x),ft.degToRad(e.y),e.z),this.cartographicToCartesian(qm,t)}cartographicToCartesian(e,t){const i=this.geodeticSurfaceNormalCartographic(e);t||(t=new Qt),t.multiplyVectors(this._radiiSquared,i);const n=Math.sqrt(i.clone().dot(t));return t.divideScalar(n),i.multiplyScalar(e.z),t.add(i),t}cartesianToCartographicDegree(e,t){const i=this.cartesianToCartographic(e,t);if(i)return(t=i).x=ft.radToDeg(t.x),t.y=ft.radToDeg(t.y),t}scaleToGeodeticSurface(e,t){return Xm(e,this._oneOverRadii,this._oneOverRadiiSquared,this._centerToleranceSquared,t)}scaleToGeocentricSurface(e,t){t||(t=new Qt);const i=e.x,n=e.y,s=e.z,o=this._oneOverRadiiSquared,r=1/Math.sqrt(i*i*o.x+n*n*o.y+s*s*o.z);return t.copy(e).multiplyScalar(r)}cartesianToCartographic(e,t){const i=this.scaleToGeodeticSurface(e,$m);if(!i)return;const n=this.geodeticSurfaceNormal(i),s=e.clone();s.sub(i);const o=Math.atan2(n.y,n.x),r=Math.asin(n.z),a=Math.sign(s.dot(e))*s.length();return t||(t=new Qt),t.set(o,r,a),t}geodeticSurfaceNormal(e,t){return Hm(t)||(t=new Qt),t.multiplyVectors(e,this._oneOverRadiiSquared),t.normalize(),t}getSurfaceNormalIntersectionWithZAxis(e,t,i){t=zm(t,0);const n=this._squaredXOverSquaredZ;if(Hm(i)||(i=new Qt),i.x=0,i.y=0,i.z=e.z*(1-n),!(Math.abs(i.z)>=this._radii.z-t))return i}transformPositionToScaledSpace(e,t){return jm.multiplyComponents(e,this._oneOverRadii,t)}static clone(e,t){if(!e)return;const i=e._radii;return t?(jm.clone(i,t._radii),jm.clone(e._radiiSquared,t._radiiSquared),jm.clone(e._radiiToTheFourth,t._radiiToTheFourth),jm.clone(e._oneOverRadii,t._oneOverRadii),jm.clone(e._oneOverRadiiSquared,t._oneOverRadiiSquared),t._minimumRadius=e._minimumRadius,t._maximumRadius=e._maximumRadius,t._centerToleranceSquared=e._centerToleranceSquared,t):new eA(i.x,i.y,i.z)}get radii(){return this._radii}get radiiSquared(){return this._radiiSquared}get radiiToTheFourth(){return this.radiiToTheFourth}get oneOverRadii(){return this._oneOverRadii}get oneOverRadiiSquared(){return this._oneOverRadiiSquared}get maximumRadius(){return this._maximumRadius}get minimumRadius(){return this._minimumRadius}}function tA(e){this._ellipsoid=zm(e,eA.WGS84),this._semimajorAxis=this._ellipsoid.maximumRadius,this._oneOverSemimajorAxis=1/this._semimajorAxis}eA.WGS84=Object.freeze(new eA(6378137,6378137,6356752.314245179)),Object.defineProperties(tA.prototype,{ellipsoid:{get:function(){return this._ellipsoid}}}),tA.prototype.project=function(e,t){const i=this._semimajorAxis,n=e.x*i,s=e.y*i,o=e.z;return Hm(t)?(t.x=n,t.y=s,t.z=o,t):new Qt(n,s,o)},tA.prototype.unproject=function(e,t){if(!Hm(e))throw new Lm("cartesian is required");const i=this._oneOverSemimajorAxis,n=e.x*i,s=e.y*i,o=e.z;return Hm(t)?(t.x=n,t.y=s,t.z=o,t):new Qt(n,s,o)};const iA=new bt,nA=new bt,sA=class{static clone(e,t){return t.copy(e),t}static fromElements(e,t,i){return i||(i=new bt),i.set(e,t),i}static lerp(e,t,i,n){return n||(n=new bt),n.lerpVectors(e,t,i),n}static equalsEpsilon(e,t,i,n){return e===t||Hm(e)&&Hm(t)&&Km.equalsEpsilon(e.x,t.x,i,n)&&Km.equalsEpsilon(e.y,t.y,i,n)}static equals(e,t){return e.equals(t)}static dot(e,t){return e.dot(t)}static normalize(e,t){return e===t?(e.normalize(),e):(t.copy(e),t.normalize(),t)}static add(e,t,i){return i||(i=new bt),i.addVectors(e,t)}static multiplyByScalar(e,t,i){return i||(i=new bt),i.copy(e).multiplyScalar(t),i}static subtract(e,t,i){return i||(i=new bt),i.subVectors(e,t),i}static distance(e,t){return e.distanceTo(t)}static angleBetween(e,t){return sA.normalize(e,iA),sA.normalize(t,nA),Km.acosClamped(sA.dot(iA,nA))}};let oA=sA;__publicField(oA,"ZERO",new bt),oA.fromCartesian3=oA.clone,oA.fromCartesian4=oA.clone;class rA{static fromQuaternion(e,t){const i=e.x*e.x,n=e.x*e.y,s=e.x*e.z,o=e.x*e.w,r=e.y*e.y,a=e.y*e.z,l=e.y*e.w,g=e.z*e.z,c=e.z*e.w,d=e.w*e.w,h=i-r-g+d,u=2*(n-c),I=2*(s+l),p=2*(n+c),m=-i+r-g+d,A=2*(a-o),C=2*(s-l),f=2*(a+o),b=-i-r+g+d;return t||(t=new yt),t.set(h,u,I,p,m,A,C,f,b),t}static getColumn(e,t,i){const n=e.elements,s=3*t,o=n[s],r=n[s+1],a=n[s+2];return i.x=o,i.y=r,i.z=a,i}static multiplyByVector(e,t,i){return i||(i=new Qt),i.copy(t),i.applyMatrix3(e),i}static multiplyByScale(e,t,i){i||(i=new yt);const n=i.elements,s=e.elements;return n[0]=s[0]*t.x,n[1]=s[1]*t.x,n[2]=s[2]*t.x,n[3]=s[3]*t.y,n[4]=s[4]*t.y,n[5]=s[5]*t.y,n[6]=s[6]*t.z,n[7]=s[7]*t.z,n[8]=s[8]*t.z,i}static transpose(e,t){return t||(t=new yt),t.copy(e).transpose(),t}static fromScale(e,t){t||(t=new yt);const i=t.elements;return i[0]=e.x,i[1]=0,i[2]=0,i[3]=0,i[4]=e.y,i[5]=0,i[6]=0,i[7]=0,i[8]=e.z,t}static multiply(e,t,i){i||(i=new yt);const n=e.elements,s=t.elements,o=i.elements,r=n[0],a=n[3],l=n[6],g=n[1],c=n[4],d=n[7],h=n[2],u=n[5],I=n[8],p=s[0],m=s[3],A=s[6],C=s[1],f=s[4],b=s[7],y=s[2],_=s[5],v=s[8];return o[0]=r*p+a*C+l*y,o[3]=r*m+a*f+l*_,o[6]=r*A+a*b+l*v,o[1]=g*p+c*C+d*y,o[4]=g*m+c*f+d*_,o[7]=g*A+c*b+d*v,o[2]=h*p+u*C+I*y,o[5]=h*m+u*f+I*_,o[8]=h*A+u*b+I*v,i}static clone(e,t){if(Hm(e))return Hm(t)?(t.clone(e),t):new yt(e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8])}static setColumn(e,t,i,n){const s=(n=rA.clone(e,n)).elements,o=3*t;return s[o]=i.x,s[o+1]=i.y,s[o+2]=i.z,n}}rA.ZERO=yt.ZERO=Object.freeze(new yt(0,0,0,0,0,0,0,0,0)),rA.COLUMN0ROW0=0,rA.COLUMN0ROW1=1,rA.COLUMN0ROW2=2,rA.COLUMN1ROW0=3,rA.COLUMN1ROW1=4,rA.COLUMN1ROW2=5,rA.COLUMN2ROW0=6,rA.COLUMN2ROW1=7,rA.COLUMN2ROW2=8;class aA{static clone(e,t){return t.copy(e),t}static inverseTransformation(e,t){return t.copy(e).invert(),t}static multiplyByPoint(e,t,i){const n=e.elements,s=t.x,o=t.y,r=t.z,a=n[0]*s+n[4]*o+n[8]*r+n[12],l=n[1]*s+n[5]*o+n[9]*r+n[13],g=n[2]*s+n[6]*o+n[10]*r+n[14];return i.x=a,i.y=l,i.z=g,i}static multiplyByPointAsVector(e,t,i){const n=e.elements,s=t.x,o=t.y,r=t.z,a=n[0]*s+n[4]*o+n[8]*r,l=n[1]*s+n[5]*o+n[9]*r,g=n[2]*s+n[6]*o+n[10]*r;return i.x=a,i.y=l,i.z=g,i}static computeViewportTransformation(e,t,i,n){Hm(n)||(n=new Bi),e=zm(e,zm.EMPTY_OBJECT);const s=zm(e.x,0),o=zm(e.y,0),r=zm(e.width,0),a=zm(e.height,0);t=zm(t,0);const l=.5*r,g=.5*a,c=.5*((i=zm(i,1))-t),d=l,h=g,u=c,I=s+l,p=o+g,m=t+c,A=n.elements;return A[0]=d,A[1]=0,A[2]=0,A[3]=0,A[4]=0,A[5]=h,A[6]=0,A[7]=0,A[8]=0,A[9]=0,A[10]=u,A[11]=0,A[12]=I,A[13]=p,A[14]=m,A[15]=1,n}static equals(e,t){return e.equals(t)}static multiplyByVector(e,t,i){return i||(i=new Dt),i.copy(t),i.applyMatrix4(e),i}static getColumn(e,t,i){const n=e.elements,s=4*t,o=n[s],r=n[s+1],a=n[s+2],l=n[s+3];return i.x=o,i.y=r,i.z=a,i.w=l,i}static fromTranslationQuaternionRotationScale(e,t,i,n){n||(n=new Bi);const s=i.x,o=i.y,r=i.z,a=t.x*t.x,l=t.x*t.y,g=t.x*t.z,c=t.x*t.w,d=t.y*t.y,h=t.y*t.z,u=t.y*t.w,I=t.z*t.z,p=t.z*t.w,m=t.w*t.w,A=a-d-I+m,C=2*(l-p),f=2*(g+u),b=2*(l+p),y=-a+d-I+m,_=2*(h-c),v=2*(g-u),x=2*(h+c),B=-a-d+I+m,w=n.elements;return w[0]=A*s,w[1]=b*s,w[2]=v*s,w[3]=0,w[4]=C*o,w[5]=y*o,w[6]=x*o,w[7]=0,w[8]=f*r,w[9]=_*r,w[10]=B*r,w[11]=0,w[12]=e.x,w[13]=e.y,w[14]=e.z,w[15]=1,n}}__publicField(aA,"IDENTITY",Object.freeze(new Bi)),aA.ZERO=Object.freeze(new Bi(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0));let lA=new Ut,gA=new Ut,cA=new Ut,dA=new Ut,hA=new Qt;class uA{static fromAxisAngle(e,t,i){return i||(i=new Ut),hA.copy(e),hA.normalize(),i.setFromAxisAngle(hA,t),i}static multiply(e,t,i){return i||(i=new Ut),i.multiplyQuaternions(e,t),i}static fromHeadingPitchRoll(e,t){return dA=uA.fromAxisAngle(jm.UNIT_X,e.roll,lA),cA=uA.fromAxisAngle(jm.UNIT_Y,-e.pitch,t),t=uA.multiply(cA,dA,cA),gA=uA.fromAxisAngle(jm.UNIT_Z,-e.heading,lA),uA.multiply(gA,t,t)}}class IA{constructor(e,t,i,n){this.west=e||0,this.south=t||0,this.east=i||0,this.north=n||0}get width(){return IA.computeWidth(this)}get height(){return IA.computeHeight(this)}}IA.fromDegrees=function(e,t,i,n,s){return e=ft.degToRad(zm(e,0)),t=ft.degToRad(zm(t,0)),i=ft.degToRad(zm(i,0)),n=ft.degToRad(zm(n,0)),Hm(s)?(s.west=e,s.south=t,s.east=i,s.north=n,s):new IA(e,t,i,n)},IA.computeWidth=function(e){let t=e.east;const i=e.west;return t<i&&(t+=Km.TWO_PI),t-i},IA.computeHeight=function(e){return e.north-e.south},IA.clone=function(e,t){if(Hm(e))return Hm(t)?(t.west=e.west,t.south=e.south,t.east=e.east,t.north=e.north,t):new IA(e.west,e.south,e.east,e.north)},IA.southwest=function(e,t){return Hm(t)?(t.x=e.west,t.y=e.south,t.z=0,t):new Qt(e.west,e.south)},IA.northeast=function(e,t){return Hm(t)?(t.x=e.east,t.y=e.north,t.z=0,t):new Qt(e.east,e.north)},IA.southeast=function(e,t){return Hm(t)?(t.x=e.east,t.y=e.south,t.z=0,t):new Qt(e.east,e.south)},IA.northwest=function(e,t){return Hm(t)?(t.x=e.west,t.y=e.north,t.z=0,t):new Qt(e.west,e.north)},IA.center=function(e,t){let i=e.east;const n=e.west;i<n&&(i+=Km.TWO_PI);const s=Km.negativePiToPi(.5*(n+i)),o=.5*(e.south+e.north);return Hm(t)?(t.x=s,t.y=o,t.z=0,t):new Qt(s,o)},IA.contains=function(e,t){let i=t.x;const n=t.y,s=e.west;let o=e.east;return o<s&&(o+=Km.TWO_PI,i<0&&(i+=Km.TWO_PI)),(i>s||Km.equalsEpsilon(i,s,Km.EPSILON14))&&(i<o||Km.equalsEpsilon(i,o,Km.EPSILON14))&&n>=e.south&&n<=e.north};const pA=Math.PI+1e-5,mA=-Math.PI-1e-5,AA=Km.PI_OVER_TWO+1e-5,CA=-Km.PI_OVER_TWO-1e-5;IA.fromBox=function(e,t,i=!1){const n=e.min,s=e.max;let o=n.x/180*Math.PI,r=n.y/180*Math.PI,a=s.x/180*Math.PI,l=s.y/180*Math.PI;return i&&(o<mA&&(o=-Math.PI),o>pA&&(o=Math.PI),r<CA&&(r=-Km.PI_OVER_TWO),r>AA&&(r=Km.PI_OVER_TWO),a>pA&&(a=Math.PI),a<mA&&(a=-Math.PI),l>AA&&(l=Km.PI_OVER_TWO),l<CA&&(l=-Km.PI_OVER_TWO)),Hm(t)?(t.west=o,t.south=r,t.east=a,t.north=l,t):new IA(o,r,a,l)},IA.MAX_VALUE=Object.freeze(new IA(-Math.PI,-Km.PI_OVER_TWO,Math.PI,Km.PI_OVER_TWO));class fA{constructor(e,t,i){this.heading=zm(e,0),this.pitch=zm(t,0),this.range=zm(i,0)}clone(e,t){if(Hm(e))return Hm(t)||(t=new fA),t.heading=e.heading,t.pitch=e.pitch,t.range=e.range,t}}const bA={},yA=new Ut,_A=new Qt(1,1,1),vA=new Bi,xA={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}};let BA={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},wA={},SA={east:new Qt,north:new Qt,up:new Qt,west:new Qt,south:new Qt,down:new Qt},GA=new Qt,MA=new Qt,RA=new Qt;const TA=e=>void 0!==e,ZA=new Qt,VA=new Qt,WA=new Qt,EA=function(e,t,i=0,n){const s=new Qt(40680631590769,40680631590769,40408299984661.445),o=Math.cos(t);VA.x=o*Math.cos(e),VA.y=o*Math.sin(e),VA.z=Math.sin(t),VA.normalize(),WA.multiplyVectors(s,VA);const r=Math.sqrt(VA.dot(WA));return WA.divideScalar(r),VA.multiplyScalar(i),TA(n)||(n=new Qt),n.addVectors(WA,VA)};function NA(e,t){this.start=zm(e,0),this.stop=zm(t,0)}bA.lnglatToEcef=(e,t,i=0,n)=>EA(e*Math.PI/180,t*Math.PI/180,i,n),bA.radianToEcef=EA,bA.localFrameToFixedFrameGenerator=function(e,t){if(!xA.hasOwnProperty(e)||!xA[e].hasOwnProperty(t))throw new Error("firstAxis and secondAxis must be east, north, up, west, south or down.");let i,n=xA[e][t],s=e+t;return TA(wA[s])?i=wA[s]:(i=function(i,s,o){if(!TA(i))throw new Error("origin is required.");if(TA(o)||(o=new Bi),i.equals(ZA))GA.fromArray(BA[e]),MA.fromArray(BA[t]),RA.fromArray(BA[n]);else if(Math.abs(i.x)<1e-14&&Math.abs(i.y)<1e-14){let s=0==(r=+(r=i.z))?r:r>0?1:-1;GA.fromArray(BA[e]),"east"!==e&&"west"!==e&&GA.multiplyScalar(s),MA.fromArray(BA[t]),"east"!==t&&"west"!==t&&MA.multiplyScalar(s),RA.fromArray(BA[n]),"east"!==n&&"west"!==n&&RA.multiplyScalar(s)}else{(s=s||eA.WGS84).geodeticSurfaceNormal(i,SA.up);let o=SA.up,r=SA.east;r.x=-i.y,r.y=i.x,r.z=0,SA.east.copy(r).normalize(),SA.north.crossVectors(o,r),SA.down.copy(SA.up).multiplyScalar(-1),SA.west.copy(SA.east).multiplyScalar(-1),SA.south.copy(SA.north).multiplyScalar(-1),GA=SA[e],MA=SA[t],RA=SA[n]}var r;const a=o.elements;return a[0]=GA.x,a[1]=GA.y,a[2]=GA.z,a[3]=0,a[4]=MA.x,a[5]=MA.y,a[6]=MA.z,a[7]=0,a[8]=RA.x,a[9]=RA.y,a[10]=RA.z,a[11]=0,a[12]=i.x,a[13]=i.y,a[14]=i.z,a[15]=1,o},wA[s]=i),i},bA.eastNorthUpToFixedFrame=bA.localFrameToFixedFrameGenerator("east","north"),bA.headingPitchRollToFixedFrame=function(e,t,i,n,s){n=n||bA.eastNorthUpToFixedFrame;const o=uA.fromHeadingPitchRoll(t,yA),r=aA.fromTranslationQuaternionRotationScale(jm.ZERO,o,_A,vA);return(s=n(e,i,s)).multiply(r)},bA.northEastDownToFixedFrame=bA.localFrameToFixedFrameGenerator("north","east"),bA.northUpEastToFixedFrame=bA.localFrameToFixedFrameGenerator("north","up"),bA.northWestUpToFixedFrame=bA.localFrameToFixedFrameGenerator("north","west");var FA={};function XA(e,t,i){var n=e+t;return Km.sign(e)!==Km.sign(t)&&Math.abs(n/Math.max(Math.abs(e),Math.abs(t)))<i?0:n}FA.computeDiscriminant=function(e,t,i){if("number"!=typeof e)throw new Lm("a is a required number.");if("number"!=typeof t)throw new Lm("b is a required number.");if("number"!=typeof i)throw new Lm("c is a required number.");return t*t-4*e*i},FA.computeRealRoots=function(e,t,i){if("number"!=typeof e)throw new Lm("a is a required number.");if("number"!=typeof t)throw new Lm("b is a required number.");if("number"!=typeof i)throw new Lm("c is a required number.");var n;if(0===e)return 0===t?[]:[-i/t];if(0===t){if(0===i)return[0,0];var s=Math.abs(i),o=Math.abs(e);if(s<o&&s/o<Km.EPSILON14)return[0,0];if(s>o&&o/s<Km.EPSILON14)return[];if((n=-i/e)<0)return[];var r=Math.sqrt(n);return[-r,r]}if(0===i)return(n=-t/e)<0?[n,0]:[0,n];var a=XA(t*t,-(4*e*i),Km.EPSILON14);if(a<0)return[];var l=-.5*XA(t,Km.sign(t)*Math.sqrt(a),Km.EPSILON14);return t>0?[l/e,i/l]:[i/l,l/e]};var HA={};function zA(e,t,i,n){var s,o,r=e,a=t/3,l=i/3,g=n,c=r*l,d=a*g,h=a*a,u=l*l,I=r*l-h,p=r*g-a*l,m=a*g-u,A=4*I*m-p*p;if(A<0){var C,f,b;h*d>=c*u?(C=r,f=I,b=-2*a*I+r*p):(C=g,f=m,b=-g*p+2*l*m);var y=-(b<0?-1:1)*Math.abs(C)*Math.sqrt(-A),_=(o=-b+y)/2,v=_<0?-Math.pow(-_,1/3):Math.pow(_,1/3),x=o===y?-v:-f/v;return s=f<=0?v+x:-b/(v*v+x*x+f),h*d>=c*u?[(s-a)/r]:[-g/(s+l)]}var B=I,w=-2*a*I+r*p,S=m,G=-g*p+2*l*m,M=Math.sqrt(A),R=Math.sqrt(3)/2,T=Math.abs(Math.atan2(r*M,-w)/3);s=2*Math.sqrt(-B);var Z=Math.cos(T);o=s*Z;var V=s*(-Z/2-R*Math.sin(T)),W=o+V>2*a?o-a:V-a,E=r,N=W/E;T=Math.abs(Math.atan2(g*M,-G)/3);var F=-g,X=(o=(s=2*Math.sqrt(-S))*(Z=Math.cos(T)))+(V=s*(-Z/2-R*Math.sin(T)))<2*l?o+l:V+l,H=F/X,z=-W*X-E*F,L=(l*z-a*(W*F))/(-a*z+l*(E*X));return N<=L?N<=H?L<=H?[N,L,H]:[N,H,L]:[H,N,L]:N<=H?[L,N,H]:L<=H?[L,H,N]:[H,L,N]}HA.computeDiscriminant=function(e,t,i,n){if("number"!=typeof e)throw new Lm("a is a required number.");if("number"!=typeof t)throw new Lm("b is a required number.");if("number"!=typeof i)throw new Lm("c is a required number.");if("number"!=typeof n)throw new Lm("d is a required number.");var s=t*t,o=i*i;return 18*e*t*i*n+s*o-27*(e*e)*(n*n)-4*(e*o*i+s*t*n)},HA.computeRealRoots=function(e,t,i,n){if("number"!=typeof e)throw new Lm("a is a required number.");if("number"!=typeof t)throw new Lm("b is a required number.");if("number"!=typeof i)throw new Lm("c is a required number.");if("number"!=typeof n)throw new Lm("d is a required number.");var s,o;if(0===e)return FA.computeRealRoots(t,i,n);if(0===t){if(0===i){if(0===n)return[0,0,0];var r=(o=-n/e)<0?-Math.pow(-o,1/3):Math.pow(o,1/3);return[r,r,r]}return 0===n?0===(s=FA.computeRealRoots(e,0,i)).Length?[0]:[s[0],0,s[1]]:zA(e,0,i,n)}return 0===i?0===n?(o=-t/e)<0?[o,0,0]:[0,0,o]:zA(e,t,0,n):0===n?0===(s=FA.computeRealRoots(e,t,i)).length?[0]:s[1]<=0?[s[0],s[1],0]:s[0]>=0?[0,s[0],s[1]]:[s[0],0,s[1]]:zA(e,t,i,n)};var LA={};function DA(e,t,i,n){var s=e*e,o=t-3*s/8,r=i-t*e/2+s*e/8,a=n-i*e/4+t*s/16-3*s*s/256,l=HA.computeRealRoots(1,2*o,o*o-4*a,-r*r);if(l.length>0){var g=-e/4,c=l[l.length-1];if(Math.abs(c)<Km.EPSILON14){var d=FA.computeRealRoots(1,o,a);if(2===d.length){var h,u=d[0],I=d[1];if(u>=0&&I>=0){var p=Math.sqrt(u),m=Math.sqrt(I);return[g-m,g-p,g+p,g+m]}if(u>=0&&I<0)return[g-(h=Math.sqrt(u)),g+h];if(u<0&&I>=0)return[g-(h=Math.sqrt(I)),g+h]}return[]}if(c>0){var A=Math.sqrt(c),C=(o+c-r/A)/2,f=(o+c+r/A)/2,b=FA.computeRealRoots(1,A,C),y=FA.computeRealRoots(1,-A,f);return 0!==b.length?(b[0]+=g,b[1]+=g,0!==y.length?(y[0]+=g,y[1]+=g,b[1]<=y[0]?[b[0],b[1],y[0],y[1]]:y[1]<=b[0]?[y[0],y[1],b[0],b[1]]:b[0]>=y[0]&&b[1]<=y[1]?[y[0],b[0],b[1],y[1]]:y[0]>=b[0]&&y[1]<=b[1]?[b[0],y[0],y[1],b[1]]:b[0]>y[0]&&b[0]<y[1]?[y[0],b[0],y[1],b[1]]:[b[0],y[0],b[1],y[1]]):b):0!==y.length?(y[0]+=g,y[1]+=g,y):[]}}return[]}function KA(e,t,i,n){var s=e*e,o=-2*t,r=i*e+t*t-4*n,a=s*n-i*t*e+i*i,l=HA.computeRealRoots(1,o,r,a);if(l.length>0){var g,c,d,h,u,I,p=l[0],m=t-p,A=m*m,C=e/2,f=m/2,b=A-4*n,y=A+4*Math.abs(n),_=s-4*p,v=s+4*Math.abs(p);if(p<0||b*v<_*y){var x=Math.sqrt(_);g=x/2,c=0===x?0:(e*f-i)/x}else{var B=Math.sqrt(b);g=0===B?0:(e*f-i)/B,c=B/2}0===C&&0===g?(d=0,h=0):Km.sign(C)===Km.sign(g)?h=p/(d=C+g):d=p/(h=C-g),0===f&&0===c?(u=0,I=0):Km.sign(f)===Km.sign(c)?I=n/(u=f+c):u=n/(I=f-c);var w=FA.computeRealRoots(1,d,u),S=FA.computeRealRoots(1,h,I);if(0!==w.length)return 0!==S.length?w[1]<=S[0]?[w[0],w[1],S[0],S[1]]:S[1]<=w[0]?[S[0],S[1],w[0],w[1]]:w[0]>=S[0]&&w[1]<=S[1]?[S[0],w[0],w[1],S[1]]:S[0]>=w[0]&&S[1]<=w[1]?[w[0],S[0],S[1],w[1]]:w[0]>S[0]&&w[0]<S[1]?[S[0],w[0],S[1],w[1]]:[w[0],S[0],w[1],S[1]]:w;if(0!==S.length)return S}return[]}LA.computeDiscriminant=function(e,t,i,n,s){if("number"!=typeof e)throw new Lm("a is a required number.");if("number"!=typeof t)throw new Lm("b is a required number.");if("number"!=typeof i)throw new Lm("c is a required number.");if("number"!=typeof n)throw new Lm("d is a required number.");if("number"!=typeof s)throw new Lm("e is a required number.");var o=e*e,r=t*t,a=r*t,l=i*i,g=l*i,c=n*n,d=c*n,h=s*s;return r*l*c-4*a*d-4*e*g*c+18*e*t*i*d-27*o*c*c+256*(o*e)*(h*s)+s*(18*a*i*n-4*r*g+16*e*l*l-80*e*t*l*n-6*e*r*c+144*o*i*c)+h*(144*e*r*i-27*r*r-128*o*l-192*o*t*n)},LA.computeRealRoots=function(e,t,i,n,s){if("number"!=typeof e)throw new Lm("a is a required number.");if("number"!=typeof t)throw new Lm("b is a required number.");if("number"!=typeof i)throw new Lm("c is a required number.");if("number"!=typeof n)throw new Lm("d is a required number.");if("number"!=typeof s)throw new Lm("e is a required number.");if(Math.abs(e)<Km.EPSILON15)return HA.computeRealRoots(t,i,n,s);var o=t/e,r=i/e,a=n/e,l=s/e,g=o<0?1:0;switch(g+=r<0?g+1:g,g+=a<0?g+1:g,g+=l<0?g+1:g){case 0:case 3:case 4:case 6:case 7:case 9:case 10:case 12:case 13:case 14:case 15:return DA(o,r,a,l);case 1:case 2:case 5:case 8:case 11:return KA(o,r,a,l);default:return}};var YA={rayPlane:function(e,t,i){if(!Hm(e))throw new Lm("ray is required.");if(!Hm(t))throw new Lm("plane is required.");Hm(i)||(i=new Qt);var n=e.origin,s=e.direction,o=t.normal,r=jm.dot(o,s);if(!(Math.abs(r)<Km.EPSILON15)){var a=(-t.constant-jm.dot(o,n))/r;if(!(a<0))return i=jm.multiplyByScalar(s,a,i),jm.add(n,i,i)}}},PA=new Qt,kA=new Qt,OA=new Qt,UA=new Qt,QA=new Qt;YA.rayTriangleParametric=function(e,t,i,n,s){if(!Hm(e))throw new Lm("ray is required.");if(!Hm(t))throw new Lm("p0 is required.");if(!Hm(i))throw new Lm("p1 is required.");if(!Hm(n))throw new Lm("p2 is required.");s=zm(s,!1);var o,r,a,l,g,c=e.origin,d=e.direction,h=jm.subtract(i,t,PA),u=jm.subtract(n,t,kA),I=jm.cross(d,u,OA),p=jm.dot(h,I);if(s){if(p<Km.EPSILON6)return;if(o=jm.subtract(c,t,UA),(a=jm.dot(o,I))<0||a>p)return;if(r=jm.cross(o,h,QA),(l=jm.dot(d,r))<0||a+l>p)return;g=jm.dot(u,r)/p}else{if(Math.abs(p)<Km.EPSILON6)return;var m=1/p;if(o=jm.subtract(c,t,UA),(a=jm.dot(o,I)*m)<0||a>1)return;if(r=jm.cross(o,h,QA),(l=jm.dot(d,r)*m)<0||a+l>1)return;g=jm.dot(u,r)*m}return g},YA.rayTriangle=function(e,t,i,n,s,o){var r=YA.rayTriangleParametric(e,t,i,n,s);if(Hm(r)&&!(r<0))return Hm(o)||(o=new Qt),jm.multiplyByScalar(e.direction,r,o),jm.add(e.origin,o,o)};var JA=new xi;YA.lineSegmentTriangle=function(e,t,i,n,s,o,r){if(!Hm(e))throw new Lm("v0 is required.");if(!Hm(t))throw new Lm("v1 is required.");if(!Hm(i))throw new Lm("p0 is required.");if(!Hm(n))throw new Lm("p1 is required.");if(!Hm(s))throw new Lm("p2 is required.");var a=JA;jm.clone(e,a.origin),jm.subtract(t,e,a.direction),jm.normalize(a.direction,a.direction);var l=YA.rayTriangleParametric(a,i,n,s,o);if(!(!Hm(l)||l<0||l>jm.distance(e,t)))return Hm(r)||(r=new Qt),jm.multiplyByScalar(a.direction,l,r),jm.add(a.origin,r,r)};var jA={root0:0,root1:0};function qA(e,t,i){Hm(i)||(i=new NA);var n=e.origin,s=e.direction,o=t.center,r=t.radius*t.radius,a=jm.subtract(n,o,OA),l=function(e,t,i,n){var s=t*t-4*e*i;if(!(s<0)){if(s>0){var o=1/(2*e),r=Math.sqrt(s),a=(-t+r)*o,l=(-t-r)*o;return a<l?(n.root0=a,n.root1=l):(n.root0=l,n.root1=a),n}var g=-t/(2*e);if(0!==g)return n.root0=n.root1=g,n}}(jm.dot(s,s),2*jm.dot(s,a),jm.magnitudeSquared(a)-r,jA);if(Hm(l))return i.start=l.root0,i.stop=l.root1,i}YA.raySphere=function(e,t,i){if(!Hm(e))throw new Lm("ray is required.");if(!Hm(t))throw new Lm("sphere is required.");if(Hm(i=qA(e,t,i))&&!(i.stop<0))return i.start=Math.max(i.start,0),i};var $A=new xi;YA.lineSegmentSphere=function(e,t,i,n){if(!Hm(e))throw new Lm("p0 is required.");if(!Hm(t))throw new Lm("p1 is required.");if(!Hm(i))throw new Lm("sphere is required.");var s=$A;jm.clone(e,s.origin);var o=jm.subtract(t,e,s.direction),r=jm.magnitude(o);if(jm.normalize(o,o),!(!Hm(n=qA(s,i,n))||n.stop<0||n.start>r))return n.start=Math.max(n.start,0),n.stop=Math.min(n.stop,r),n};var eC=new Qt,tC=new Qt;function iC(e,t,i){var n=e+t;return Km.sign(e)!==Km.sign(t)&&Math.abs(n/Math.max(Math.abs(e),Math.abs(t)))<i?0:n}YA.rayEllipsoid=function(e,t){if(!Hm(e))throw new Lm("ray is required.");if(!Hm(t))throw new Lm("ellipsoid is required.");var i,n,s,o,r,a=t.oneOverRadii,l=jm.multiplyComponents(a,e.origin,eC),g=jm.multiplyComponents(a,e.direction,tC),c=jm.magnitudeSquared(l),d=jm.dot(l,g);if(c>1){if(d>=0)return;var h=d*d;if(i=c-1,h<(s=(n=jm.magnitudeSquared(g))*i))return;if(h>s){o=d*d-s;var u=(r=-d+Math.sqrt(o))/n,I=i/r;return u<I?new NA(u,I):{start:I,stop:u}}var p=Math.sqrt(i/n);return new NA(p,p)}return c<1?(i=c-1,o=d*d-(s=(n=jm.magnitudeSquared(g))*i),new NA(0,(r=-d+Math.sqrt(o))/n)):d<0?new NA(0,-d/(n=jm.magnitudeSquared(g))):void 0};var nC=new Qt,sC=new Qt,oC=new Qt,rC=new Qt,aC=new Qt,lC=new yt,gC=new yt,cC=new yt,dC=new yt,hC=new yt,uC=new yt,IC=new yt,pC=new Qt,mC=new Qt,AC=new Qt;YA.grazingAltitudeLocation=function(e,t){if(!Hm(e))throw new Lm("ray is required.");if(!Hm(t))throw new Lm("ellipsoid is required.");var i=e.origin,n=e.direction;if(!jm.equals(i,jm.ZERO)){var s=t.geodeticSurfaceNormal(i,nC);if(jm.dot(n,s)>=0)return i}var o=Hm(this.rayEllipsoid(e,t)),r=t.transformPositionToScaledSpace(n,nC),a=jm.normalize(r,r),l=jm.mostOrthogonalAxis(r,rC),g=jm.normalize(jm.cross(l,a,sC),sC),c=jm.normalize(jm.cross(a,g,oC),oC),d=lC;d[0]=a.x,d[1]=a.y,d[2]=a.z,d[3]=g.x,d[4]=g.y,d[5]=g.z,d[6]=c.x,d[7]=c.y,d[8]=c.z;var h=rA.transpose(d,gC),u=rA.fromScale(t.radii,cC),I=rA.fromScale(t.oneOverRadii,dC),p=hC;p[0]=0,p[1]=-n.z,p[2]=n.y,p[3]=n.z,p[4]=0,p[5]=-n.x,p[6]=-n.y,p[7]=n.x,p[8]=0;var m,A,C=rA.multiply(rA.multiply(h,I,uC),p,uC),f=rA.multiply(rA.multiply(C,u,IC),d,IC),b=rA.multiplyByVector(C,i,aC),y=function(e,t,i,n,s){var o,r=n*n,a=s*s,l=(e[rA.COLUMN1ROW1]-e[rA.COLUMN2ROW2])*a,g=s*(n*iC(e[rA.COLUMN1ROW0],e[rA.COLUMN0ROW1],Km.EPSILON15)+t.y),c=e[rA.COLUMN0ROW0]*r+e[rA.COLUMN2ROW2]*a+n*t.x+i,d=a*iC(e[rA.COLUMN2ROW1],e[rA.COLUMN1ROW2],Km.EPSILON15),h=s*(n*iC(e[rA.COLUMN2ROW0],e[rA.COLUMN0ROW2])+t.z),u=[];if(0===h&&0===d){if(0===(o=FA.computeRealRoots(l,g,c)).length)return u;var I=o[0],p=Math.sqrt(Math.max(1-I*I,0));if(u.push(new Qt(n,s*I,s*-p)),u.push(new Qt(n,s*I,s*p)),2===o.length){var m=o[1],A=Math.sqrt(Math.max(1-m*m,0));u.push(new Qt(n,s*m,s*-A)),u.push(new Qt(n,s*m,s*A))}return u}var C=h*h,f=d*d,b=h*d,y=l*l+f,_=2*(g*l+b),v=2*c*l+g*g-f+C,x=2*(c*g-b),B=c*c-C;if(0===y&&0===_&&0===v&&0===x)return u;var w=(o=LA.computeRealRoots(y,_,v,x,B)).length;if(0===w)return u;for(var S=0;S<w;++S){var G=o[S],M=G*G,R=Math.max(1-M,0),T=Math.sqrt(R),Z=(Km.sign(l)===Km.sign(c)?iC(l*M+c,g*G,Km.EPSILON12):Km.sign(c)===Km.sign(g*G)?iC(l*M,g*G+c,Km.EPSILON12):iC(l*M+g*G,c,Km.EPSILON12))*iC(d*G,h,Km.EPSILON15);Z<0?u.push(new Qt(n,s*G,s*T)):Z>0?u.push(new Qt(n,s*G,s*-T)):0!==T?(u.push(new Qt(n,s*G,s*-T)),u.push(new Qt(n,s*G,s*T)),++S):u.push(new Qt(n,s*G,s*T))}return u}(f,jm.negate(b,nC),0,0,1),_=y.length;if(_>0){for(var v=jm.clone(jm.ZERO,mC),x=Number.NEGATIVE_INFINITY,B=0;B<_;++B){m=rA.multiplyByVector(u,rA.multiplyByVector(d,y[B],pC),pC);var w=jm.normalize(jm.subtract(m,i,rC),rC),S=jm.dot(w,n);S>x&&(x=S,v=jm.clone(m,v))}var G=t.cartesianToCartographic(v,AC);return x=Km.clamp(x,0,1),A=jm.magnitude(jm.subtract(v,i,rC))*Math.sqrt(1-x*x),A=o?-A:A,G.z=A,t.cartographicToCartesian(G,new Qt)}};var CC=new Qt;YA.lineSegmentPlane=function(e,t,i,n){if(!Hm(e))throw new Lm("endPoint0 is required.");if(!Hm(t))throw new Lm("endPoint1 is required.");if(!Hm(i))throw new Lm("plane is required.");Hm(n)||(n=new Qt);var s=jm.subtract(t,e,CC),o=i.normal,r=jm.dot(o,s);if(!(Math.abs(r)<Km.EPSILON6)){var a=jm.dot(o,e),l=-(i.constant+a)/r;if(!(l<0||l>1))return jm.multiplyByScalar(s,l,n),jm.add(e,n,n),n}},YA.trianglePlaneIntersection=function(e,t,i,n){if(!(Hm(e)&&Hm(t)&&Hm(i)&&Hm(n)))throw new Lm("p0, p1, p2, and plane are required.");var s,o,r=n.normal,a=n.constant,l=jm.dot(r,e)+a<0,g=jm.dot(r,t)+a<0,c=jm.dot(r,i)+a<0,d=0;if(d+=l?1:0,d+=g?1:0,1!==(d+=c?1:0)&&2!==d||(s=new Qt,o=new Qt),1===d){if(l)return YA.lineSegmentPlane(e,t,n,s),YA.lineSegmentPlane(e,i,n,o),{positions:[e,t,i,s,o],indices:[0,3,4,1,2,4,1,4,3]};if(g)return YA.lineSegmentPlane(t,i,n,s),YA.lineSegmentPlane(t,e,n,o),{positions:[e,t,i,s,o],indices:[1,3,4,2,0,4,2,4,3]};if(c)return YA.lineSegmentPlane(i,e,n,s),YA.lineSegmentPlane(i,t,n,o),{positions:[e,t,i,s,o],indices:[2,3,4,0,1,4,0,4,3]}}else if(2===d){if(!l)return YA.lineSegmentPlane(t,e,n,s),YA.lineSegmentPlane(i,e,n,o),{positions:[e,t,i,s,o],indices:[1,2,4,1,4,3,0,3,4]};if(!g)return YA.lineSegmentPlane(i,t,n,s),YA.lineSegmentPlane(e,t,n,o),{positions:[e,t,i,s,o],indices:[2,0,4,2,4,3,1,3,4]};if(!c)return YA.lineSegmentPlane(e,i,n,s),YA.lineSegmentPlane(t,i,n,o),{positions:[e,t,i,s,o],indices:[0,1,4,0,4,3,2,3,4]}}};class fC{static getPoint(e,t,i){return i||(i=new Qt),i.copy(e.direction).multiplyScalar(t).add(e.origin),i}}const bC={MORPHING:0,COLUMBUS_VIEW:1,SCENE2D:2,SCENE3D:3,getMorphTime:function(e){return e===bC.SCENE3D?1:e!==bC.MORPHING?0:void 0}},yC=Object.freeze(bC),_C={ROTATE:0,INFINITE_SCROLL:1};Object.freeze(_C);const vC=new Qt,xC=new Qt,BC=new Qt,wC=new Qt(1/6378137,1/6378137,1/6356752.314245179),SC=new Qt(1/40680631590769,1/40680631590769,1/40408299984661.445),GC=Km.EPSILON1,MC=class{static fromRadians(e,t,i,n){return i=zm(i,0),Hm(n)?(n.x=e,n.y=t,n.z=i,n):new Qt(e,t,i)}static fromDegrees(e,t,i,n){return e=Km.toRadians(e),t=Km.toRadians(t),MC.fromRadians(e,t,i,n)}static fromCartesian(e,t,i){const n=Hm(t)?t.oneOverRadii:wC,s=Hm(t)?t.oneOverRadiiSquared:SC,o=Xm(e,n,s,Hm(t)?t._centerToleranceSquared:GC,xC);if(!Hm(o))return;let r=jm.multiplyComponents(o,s,vC);r=jm.normalize(r,r);const a=jm.subtract(e,o,BC),l=Math.atan2(r.y,r.x),g=Math.asin(r.z),c=Km.sign(jm.dot(a,e))*jm.magnitude(a);return Hm(i)?(i.x=l,i.y=g,i.z=c,i):new Qt(l,g,c)}static toCartesian(e,t,i){return jm.fromRadians(e.x,e.y,e.z,t,i)}static clone(e,t){if(Hm(e))return Hm(t)?(t.x=e.x,t.y=e.y,t.z=e.z,t):new Qt(e.x,e.y,e.z)}static equals(e,t){return e===t||Hm(e)&&Hm(t)&&e.x===t.x&&e.y===t.y&&e.z===t.z}static equalsEpsilon(e,t,i){return i=zm(i,0),e===t||Hm(e)&&Hm(t)&&Km.equalsEpsilon(e.x,t.x,i)&&Km.equalsEpsilon(e.y,t.y,i)&&Km.equalsEpsilon(e.z,t.z,i)}};let RC=MC;function TC(e,t,i,n,s,o,r){const a=function(e,t){return e*t*(4+e*(4-3*t))/16}(e,i);return(1-a)*e*t*(n+a*s*(r+a*o*(2*r*r-1)))}__publicField(RC,"fromRadians",(function(e,t,i,n){return i=zm(i,0),Hm(n)?(n.x=e,n.y=t,n.z=i,n):new Qt(e,t,i)})),__publicField(RC,"fromDegrees",(function(e,t,i,n){return e=Km.toRadians(e),t=Km.toRadians(t),MC.fromRadians(e,t,i,n)})),__publicField(RC,"ZERO",Object.freeze(new Qt(0,0,0)));const ZC=new Qt,VC=new Qt;function WC(e,t,i,n){jm.normalize(n.cartographicToCartesian(t,VC),ZC),jm.normalize(n.cartographicToCartesian(i,VC),VC),function(e,t,i,n,s,o,r){const a=(t-i)/t,l=o-n,g=Math.atan((1-a)*Math.tan(s)),c=Math.atan((1-a)*Math.tan(r)),d=Math.cos(g),h=Math.sin(g),u=Math.cos(c),I=Math.sin(c),p=d*u,m=d*I,A=h*I,C=h*u;let f,b,y,_,v,x=l,B=Km.TWO_PI,w=Math.cos(x),S=Math.sin(x);do{w=Math.cos(x),S=Math.sin(x);const e=m-C*w;let t;y=Math.sqrt(u*u*S*S+e*e),b=A+p*w,f=Math.atan2(y,b),0===y?(t=0,_=1):(t=p*S/y,_=1-t*t),B=x,v=b-2*A/_,isFinite(v)||(v=0),x=l+TC(a,t,_,f,y,b,v)}while(Math.abs(x-B)>Km.EPSILON12);const G=_*(t*t-i*i)/(i*i),M=G*(256+G*(G*(74-47*G)-128))/1024,R=v*v,T=i*(1+G*(4096+G*(G*(320-175*G)-768))/16384)*(f-M*y*(v+M*(b*(2*R-1)-M*v*(4*y*y-3)*(4*R-3)/6)/4)),Z=Math.atan2(u*S,m-C*w),V=Math.atan2(d*S,m*w-C);e._distance=T,e._startHeading=Z,e._endHeading=V,e._uSquared=G}(e,n.maximumRadius,n.minimumRadius,t.x,t.y,i.x,i.y),e._start=RC.clone(t,e._start),e._end=RC.clone(i,e._end),e._start.z=0,e._end.z=0,function(e){const t=e._uSquared,i=e._ellipsoid.maximumRadius,n=e._ellipsoid.minimumRadius,s=(i-n)/i,o=Math.cos(e._startHeading),r=Math.sin(e._startHeading),a=(1-s)*Math.tan(e._start.y),l=1/Math.sqrt(1+a*a),g=l*a,c=Math.atan2(a,o),d=l*r,h=d*d,u=1-h,I=Math.sqrt(u),p=t/4,m=p*p,A=m*p,C=m*m,f=1+p-3*m/4+5*A/4-175*C/64,b=1-p+15*m/8-35*A/8,y=1-3*p+35*m/4,_=1-5*p,v=f*c-b*Math.sin(2*c)*p/2-y*Math.sin(4*c)*m/16-_*Math.sin(6*c)*A/48-5*Math.sin(8*c)*C/512,x=e._constants;x.a=i,x.b=n,x.f=s,x.cosineHeading=o,x.sineHeading=r,x.tanU=a,x.cosineU=l,x.sineU=g,x.sigma=c,x.sineAlpha=d,x.sineSquaredAlpha=h,x.cosineSquaredAlpha=u,x.cosineAlpha=I,x.u2Over4=p,x.u4Over16=m,x.u6Over64=A,x.u8Over256=C,x.a0=f,x.a1=b,x.a2=y,x.a3=_,x.distanceRatio=v}(e)}function EC(e,t,i){const n=zm(i,eA.WGS84);this._ellipsoid=n,this._start=new Qt,this._end=new Qt,this._constants={},this._startHeading=void 0,this._endHeading=void 0,this._distance=void 0,this._uSquared=void 0,Hm(e)&&Hm(t)&&WC(this,e,t,n)}Object.defineProperties(EC.prototype,{ellipsoid:{get:function(){return this._ellipsoid}},surfaceDistance:{get:function(){return this._distance}},start:{get:function(){return this._start}},end:{get:function(){return this._end}},startHeading:{get:function(){return this._startHeading}},endHeading:{get:function(){return this._endHeading}}}),EC.prototype.setEndPoints=function(e,t){WC(this,e,t,this._ellipsoid)},EC.prototype.interpolateUsingFraction=function(e,t){return this.interpolateUsingSurfaceDistance(this._distance*e,t)},EC.prototype.interpolateUsingSurfaceDistance=function(e,t){const i=this._constants,n=i.distanceRatio+e/i.b,s=Math.cos(2*n),o=Math.cos(4*n),r=Math.cos(6*n),a=Math.sin(2*n),l=Math.sin(4*n),g=Math.sin(6*n),c=Math.sin(8*n),d=n*n,h=n*d,u=i.u8Over256,I=i.u2Over4,p=i.u6Over64,m=i.u4Over16;let A=2*h*u*s/3+n*(1-I+7*m/4-15*p/4+579*u/64-(m-15*p/4+187*u/16)*s-(5*p/4-115*u/16)*o-29*u*r/16)+(I/2-m+71*p/32-85*u/16)*a+(5*m/16-5*p/4+383*u/96)*l-d*((p-11*u/2)*a+5*u*l/2)+(29*p/96-29*u/16)*g+539*u*c/1536;const C=Math.asin(Math.sin(A)*i.cosineAlpha),f=Math.atan(i.a/i.b*Math.tan(C));A-=i.sigma;const b=Math.cos(2*i.sigma+A),y=Math.sin(A),_=Math.cos(A),v=i.cosineU*_,x=i.sineU*y,B=Math.atan2(y*i.sineHeading,v-x*i.cosineHeading)-TC(i.f,i.sineAlpha,i.cosineSquaredAlpha,A,y,_,b);return Hm(t)?(t.x=this._start.x+B,t.y=f,t.z=0,t):new Qt(this._start.x+B,f,0)};const NC=e=>(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2),FC=e=>--e*e*e+1,XC=new Qt;new Qt;const HC=new Qt;new Qt,new ys;const zC={};function LC(e,t){return Km.equalsEpsilon(e,Km.TWO_PI,Km.EPSILON11)&&(e=0),t>e+Math.PI?e+=Km.TWO_PI:t<e-Math.PI&&(e-=Km.TWO_PI),e}const DC=new Qt,KC=new Qt;function YC(e,t,i,n,s,o){let r=s;const a=Math.max(i,n);if(!r)if(o){const i=e.position,n=t,s=e.up,o=e.right,a=e.frustum,l=HC.subVectors(n,i),g=DC.copy(s).multiplyScalar(s.dot(l)).length(),c=KC.copy(o).multiplyScalar(o.dot(l)).length();r=Math.min(.2*function(e,t,i){let n,s,o;const r=Math.tan(.5*Km.toRadians(e.fov));return n=e.near,s=e.near*r,o=e.aspect*s,Math.max(t*n/o,i*n/s)}(a,g,c),1e9)}else{const i=e.position,n=t,s=HC.subVectors(n,i),o=Math.hypot(s.x,s.y);r=.2*o}if(a<r){const e=8,t=1e6,s=-Math.pow((r-i)*t,1/e),o=Math.pow((r-n)*t,1/e);return function(i){const n=i*(o-s)+s;return-Math.pow(n,e)/t+r}}return function(e){return(1-e)*i+e*n}}function PC(e,t,i,n){const s=i(.5);if(Hm(n)&&i(.5)>n){const n=i(0),o=i(1),r=s-n,a=s-o;return function(s){const l=i(s);if(s<.5){const t=(l-n)/r;return(1-t)*e+t*-Km.PI_OVER_TWO}const g=(l-o)/a;return(1-g)*-Km.PI_OVER_TWO+g*t}}return function(i){return(1-i)*e+i*t}}const kC=new Qt;function OC(e,t,i,n,s,o,r,a,l,g){const c=e._ellipsoidCamera,d=kC.copy(c.position),h=LC(c.heading,n),u=c.frustum.right-c.frustum.left,I=YC(c,i,u,i.z,r);return function(e){const s=e.time/t;c.setView({orientation:{heading:Km.lerp(h,n,s)}}),oA.lerp(d,i,s,c.position);const o=I(s),r=c.frustum,a=r.top/r.right,l=(o-(r.right-r.left))/2;r.right+=l,r.left-=l,r.top=r.right*a,r.bottom=-r.top}}function UC(e,t,i,n,s,o,r,a,l,g){const c=e._ellipsoidCamera,d=e.mapProjection.ellipsoid,h=XC.copy(c.positionCartographic),u=c.pitch,I=LC(c.heading,n),p=LC(c.roll,o),m=d.cartesianToCartographic(i);h.x=Km.zeroToTwoPi(h.x),m.x=Km.zeroToTwoPi(m.x),function(e,t){const i=e.x-t.x;i<-Km.PI?e.x+=Km.TWO_PI:i>Km.PI&&(t.x+=Km.TWO_PI)}(h,m);const A=YC(c,i,h.z,m.z,r,!0),C=PC(u,s,A,g);return function(){const e=h.x,i=m.x,s=h.y,r=m.y;return function(a){const l=a.easingFunction;let g=a.time/t;l&&(g=l(g));const h=jm.fromRadians(ft.lerp(e,i,g),ft.lerp(s,r,g),A(g),d);c.setView({destination:h,orientation:{heading:ft.lerp(I,n,g),pitch:C(g),roll:ft.lerp(p,o,g)}})}}()}function QC(e,t,i,n,s,o,r,a,l,g){const c=e._engine,d=c.camera,h=kC.copy(d.position),u=ft.degToRad(e.getPitch()),I=LC(ft.degToRad(e.getHeading()),n),p=YC(d,i,h.z,i.z,r,!1),m=PC(u,s,p,g);return function(){const s=h.x,o=i.x,r=h.y,a=i.y;return function(i){const l=i.easingFunction;let g=i.time/t;l&&(g=l(g));const d=new Qt(ft.lerp(s,o,g),ft.lerp(r,a,g),p(g));e.lookAt(c.map.unprojectArrayCoordinate(d.toArray()),{heading:ft.radToDeg(ft.lerp(I,n,g)),pitch:ft.radToDeg(m(g))})}}()}function JC(e){return function(){"function"==typeof e&&e()}}function jC(e,t){return function(){"function"==typeof t&&t(),e.enableInputs=!0}}function qC(e,t){return{startObject:{},stopObject:{},duration:0,complete:e,cancel:t}}function $C(){}function ef(e){!function(e,t,i,n,s){const o=s.elements;o[0]=n.x,o[1]=i.x,o[2]=-t.x,o[3]=0,o[4]=n.y,o[5]=i.y,o[6]=-t.y,o[7]=0,o[8]=n.z,o[9]=i.z,o[10]=-t.z,o[11]=0,o[12]=-n.dot(e),o[13]=-i.dot(e),o[14]=t.dot(e),o[15]=1}(e._position,e._direction,e._up,e._right,e._viewMatrix),e._viewMatrix.multiplyMatrices(e._viewMatrix,e._actualInvTransform),e._invViewMatrix.copy(e._viewMatrix).invert()}zC.createTweenColumbus=function(e,t){let i=(t=t||zm.EMPTY_OBJECT).destination;const n=e.mode;if(n===yC.MORPHING)return qC();const s=t.maximumHeight,o=(t.flyOverLongitude,t.flyOverLongitudeWeight,t.pitchAdjustHeight);let r=t.easingFunction;const a=e._engine.camera;let l=t.duration;l||(l=Math.ceil(jm.distance(a.position,i)/1e6)+2,l=1e3*Math.min(l,3));const g=zm(t.heading,0),c=zm(t.pitch,0),d=JC(t.complete),h=JC(t.cancel);let u=jm.equalsEpsilon(i,a.position,Km.EPSILON10);const I=ft.degToRad(e.getHeading()),p=ft.degToRad(e.getPitch());if(u=u&&Km.equalsEpsilon(Km.negativePiToPi(g),Km.negativePiToPi(I),Km.EPSILON10)&&Km.equalsEpsilon(Km.negativePiToPi(c),Km.negativePiToPi(p),Km.EPSILON10),u)return qC(d,h);const m=new Array(4);m[yC.SCENE2D]=OC,m[yC.SCENE3D]=UC,m[yC.COLUMBUS_VIEW]=QC;const A=QC(e,l,i,g,c,0,s,0,0,o);if(!Hm(r)){const e=a.position.z;r=e>(n===i.z)&&e>11500?FC:NC}return{duration:l,easingFunction:r,startObject:{time:0},stopObject:{time:l},update:A,complete:d,cancel:h}},zC.createTween=function(e,t){return e.mode===yC.SCENE3D?zC.createTween3D(e,t):zC.createTweenColumbus(e,t)},zC.createTween3D=function(e,t){let i=(t=t||zm.EMPTY_OBJECT).destination;const n=e.mode;if(n===yC.MORPHING)return qC();zm(t.convert,!0);const s=e.mapProjection.ellipsoid,o=t.maximumHeight,r=t.flyOverLongitude,a=t.flyOverLongitudeWeight,l=t.pitchAdjustHeight;let g=t.easingFunction;const c=e.camera,d=e._ellipsoidCamera;let h=t.duration;h||(h=Math.ceil(jm.distance(c.position,i)/1e6)+2,h=1e3*Math.min(h,3));const u=zm(t.heading,0),I=zm(t.pitch,-Km.PI_OVER_TWO),p=zm(t.roll,0),m=e._controller;m.enableInputs=!1;const A=jC(m,t.complete),C=jC(m,t.cancel);d.frustum;let f=n===yC.SCENE2D;if(f=f&&oA.equalsEpsilon(c.position,i,Km.EPSILON6),f=f||n!==yC.SCENE2D&&jm.equalsEpsilon(i,c.position,Km.EPSILON10),f=f&&Km.equalsEpsilon(Km.negativePiToPi(u),Km.negativePiToPi(d.heading),Km.EPSILON10)&&Km.equalsEpsilon(Km.negativePiToPi(I),Km.negativePiToPi(d.pitch),Km.EPSILON10)&&Km.equalsEpsilon(Km.negativePiToPi(p),Km.negativePiToPi(d.roll),Km.EPSILON10),f)return qC(A,C);const b=new Array(4);b[yC.SCENE2D]=OC,b[yC.SCENE3D]=UC,b[yC.COLUMBUS_VIEW]=QC;const y=b[e.mode](e,h,i,u,I,p,o,r,a,l);if(!Hm(g)){const e=d.positionCartographic.z;g=e>(n===yC.SCENE3D?s.cartesianToCartographic(i).z:i.z)&&e>11500?FC:NC}return{duration:h,easingFunction:g,startObject:{time:0},stopObject:{time:h},update:y,complete:A,cancel:C}};const tf=new Qt;function nf(e){let t=e._position;const i=!jm.equals(t,e.position)||!1;i&&(t=jm.clone(e.position,e._position));let n=e._direction;const s=!jm.equals(n,e.direction);s&&(e.direction.normalize(),n=jm.clone(e.direction,e._direction));let o=e._up;const r=!jm.equals(o,e.up);r&&(jm.normalize(e.up,e.up),o=jm.clone(e.up,e._up));let a=e._right;const l=!jm.equals(a,e.right);l&&(jm.normalize(e.right,e.right),a=jm.clone(e.right,e._right));const g=e._transformChanged;e._transformChanged=!1,g&&(aA.inverseTransformation(e._transform,e._invTransform),aA.clone(e._transform,e._actualTransform),aA.inverseTransformation(e._actualTransform,e._actualInvTransform));const c=e._actualTransform;if((i||g)&&(e._positionWC=aA.multiplyByPoint(c,t,e._positionWC),e._positionCartographic=e._ellipsoid.cartesianToCartographic(e._positionWC,e._positionCartographic)),s||r||l){const t=jm.dot(n,jm.cross(o,a,tf));if(Math.abs(1-t)>.02){const t=1/jm.magnitudeSquared(o),i=jm.dot(o,n)*t,s=jm.multiplyByScalar(n,i,tf);o=jm.normalize(jm.subtract(o,s,e._up),e._up),jm.clone(o,e.up),a=jm.cross(n,o,e._right),jm.clone(a,e.right)}}(s||g)&&(e._directionWC=aA.multiplyByPointAsVector(c,n,e._directionWC),jm.normalize(e._directionWC,e._directionWC)),(r||g)&&(e._upWC=aA.multiplyByPointAsVector(c,o,e._upWC),jm.normalize(e._upWC,e._upWC)),(l||g)&&(e._rightWC=aA.multiplyByPointAsVector(c,a,e._rightWC),jm.normalize(e._rightWC,e._rightWC)),(i||s||r||l||g)&&ef(e)}function sf(e,t){let i;return i=Km.equalsEpsilon(Math.abs(e.z),1,Km.EPSILON3)?Math.atan2(t.y,t.x)-Km.PI_OVER_TWO:Math.atan2(e.y,e.x)-Km.PI_OVER_TWO,Km.TWO_PI-Km.zeroToTwoPi(i)}function of(e){return Km.PI_OVER_TWO-Km.acosClamped(e.z)}function rf(e,t,i){let n=0;return Km.equalsEpsilon(Math.abs(e.z),1,Km.EPSILON3)||(n=Math.atan2(-i.z,t.z),n=Km.zeroToTwoPi(n+Km.TWO_PI)),n}const af=new Bi,lf=new Bi,gf=new Qt,cf=new Qt,df=new Qt,hf=new Qt,uf=new Bi,If=new Bi,pf=new Ut,mf=new yt,Af=new Qt;const Cf=new Bi,ff=new Bi,bf=new Qt,yf=new Ut,_f=new Ut,vf=new yt;const xf=new Qt,Bf=new Qt,wf=new Qt;function Sf(e,t,i,n){const s=jm.clone(i.direction,xf),o=jm.clone(i.up,Bf),r=e._ellipsoid,a=bA.eastNorthUpToFixedFrame(t,r,af),l=aA.inverseTransformation(a,lf);aA.multiplyByPointAsVector(l,s,s),aA.multiplyByPointAsVector(l,o,o);const g=jm.cross(s,o,wf);return n.heading=sf(s,o),n.pitch=of(s),n.roll=rf(s,o,g),n}const Gf=new Qt,Mf={destination:void 0,heading:void 0,pitch:void 0,roll:void 0,duration:void 0,complete:void 0,cancel:void 0,endTransform:void 0,maximumHeight:void 0,easingFunction:void 0},Rf={destination:void 0,orientation:{direction:void 0,up:void 0,heading:void 0,pitch:void 0,roll:void 0},convert:void 0,endTransform:void 0},Tf={},Zf=new Qt;var Vf=new Qt,Wf=new Qt,Ef=new Qt;var Nf=new xi;var Ff=new Ut,Xf=new yt,Hf=new Ut,zf=new yt,Lf=new Qt,Df=new Qt,Kf=new Qt,Yf=new Qt;function Pf(e,t){var i=e.position;if(Hm(e.constrainedAxis)&&!jm.equalsEpsilon(e.position,jm.ZERO,Km.EPSILON2)){var n=jm.normalize(i,Lf),s=jm.equalsEpsilon(n,e.constrainedAxis,Km.EPSILON2),o=jm.equalsEpsilon(n,jm.negate(e.constrainedAxis,Yf),Km.EPSILON2);if(s||o)(s&&t<0||o&&t>0)&&e.rotate(e.right,t);else{var r=jm.normalize(e.constrainedAxis,Df),a=jm.dot(n,r),l=Km.acosClamped(a);t>0&&t>l&&(t=l-Km.EPSILON4),a=jm.dot(n,jm.negate(r,Yf)),l=Km.acosClamped(a),t<0&&-t>l&&(t=-l+Km.EPSILON4);var g=jm.cross(r,n,Kf);e.rotate(g,t)}}else e.rotate(e.right,t)}function kf(e,t){Hm(e.constrainedAxis)?e.rotate(e.constrainedAxis,t):e.rotate(e.up,t)}const Of=class{constructor(e){__publicField(this,"_setTransform",(e=>{const t=jm.clone(this.positionWC,gf),i=jm.clone(this.upWC,cf),n=jm.clone(this.directionWC,df);aA.clone(e,this._transform),this._transformChanged=!0,nf(this);const s=this._actualInvTransform;aA.multiplyByPoint(s,t,this.position),aA.multiplyByPointAsVector(s,n,this.direction),aA.multiplyByPointAsVector(s,i,this.up),jm.cross(this.direction,this.up,this.right),nf(this)})),this._scene=e,this._camera=e.camera,this._ellipsoid=e._ellipsoid,this._transform=new Bi,this._invTransform=new Bi,this._actualTransform=new Bi,this._actualInvTransform=new Bi,this._transformChanged=!1,this.position=new Qt,this._position=new Qt,this._positionWC=new Qt,this._positionCartographic=new Qt,this._oldPositionWC=void 0,this.positionWCDeltaMagnitude=0,this.positionWCDeltaMagnitudeLastFrame=0,this.timeSinceMoved=0,this._lastMovedTimestamp=0,this.direction=new Qt,this._direction=new Qt,this._directionWC=new Qt,this.up=new Qt,this._up=new Qt,this._upWC=new Qt,this.right=new Qt,this._right=new Qt,this._rightWC=new Qt,this.defaultMoveAmount=1e5,this.defaultLookAmount=Math.PI/60,this.defaultRotateAmount=Math.PI/3600,this.defaultZoomAmount=1e5,this.constrainedAxis=void 0,this.maximumZoomFactor=1.5,this._moveStart=new $C,this._moveEnd=new $C,this._changed=new $C,this._changedPosition=void 0,this._changedDirection=void 0,this._changedFrustum=void 0,this.percentageChanged=.5,this._viewMatrix=new Bi,this._invViewMatrix=new Bi,ef(this),this._mode=bC.SCENE3D,this._modeChanged=!0;const t=e.mapProjection;this._projection=t,this._maxCoord=t.project(new Qt(Math.PI,Km.PI_OVER_TWO,0)),this._max2Dfrustum=void 0,lb(this,Of.DEFAULT_VIEW_RECTANGLE,this.position,!0);let i=jm.magnitude(this.position);i+=i*Of.DEFAULT_VIEW_FACTOR,jm.normalize(this.position,this.position),jm.multiplyByScalar(this.position,i,this.position)}canPreloadFlight(){return Hm(this._currentFlight)}setView(e){e=zm(e,{});let t=zm(e.orientation,zm.EMPTY_OBJECT);const i=this._mode;if(i===bC.MORPHING)return;Hm(e.endTransform)&&this._setTransform(e.endTransform);let n=zm(e.convert,!0),s=zm(e.destination,jm.clone(this.positionWC,hf));Hm(s)&&Hm(s.west)&&(s=this.getRectangleCameraCoordinates(s,hf),n=!1),Hm(t.direction)&&(t=Sf(this,s,t,Rf.orientation)),Tf.heading=zm(t.heading,0),Tf.pitch=zm(t.pitch,-Km.PI_OVER_TWO),Tf.roll=zm(t.roll,0),i===bC.SCENE3D?function(e,t,i){const n=aA.clone(e.transform,uf),s=bA.eastNorthUpToFixedFrame(t,e._ellipsoid,If);e._setTransform(s),jm.clone(jm.ZERO,e.position),i.heading=i.heading-Km.PI_OVER_TWO;const o=uA.fromHeadingPitchRoll(i,pf),r=rA.fromQuaternion(o,mf);rA.getColumn(r,0,e.direction),rA.getColumn(r,2,e.up),jm.cross(e.direction,e.up,e.right),e._setTransform(n)}(this,s,Tf):i===bC.SCENE2D?function(e,t,i,n){const s=aA.clone(e.transform,uf);if(e._setTransform(aA.IDENTITY),!jm.equals(t,e.positionWC)){if(n){const i=e._projection,n=i.ellipsoid.cartesianToCartographic(t,Af);t=i.project(n,hf)}oA.clone(t,e.position);const i=.5*-t.z,s=-i,o=e.frustum;if(s>i){const e=o.top/o.right;o.right=s,o.left=i,o.top=o.right*e,o.bottom=-o.top}}if(e._scene.mapMode2D===_C.ROTATE){i.heading=i.heading-Km.PI_OVER_TWO,i.pitch=-Km.PI_OVER_TWO,i.roll=0;const t=Ut.fromHeadingPitchRoll(i,pf),n=rA.fromQuaternion(t,mf);rA.getColumn(n,2,e.up),jm.cross(e.direction,e.up,e.right)}e._setTransform(s)}(this,s,Tf,n):function(e,t,i,n){const s=aA.clone(e.transform,uf);if(e._setTransform(aA.IDENTITY),!jm.equals(t,e.positionWC)){if(n){const i=e._projection,n=i.ellipsoid.cartesianToCartographic(t,Af);t=i.project(n,hf)}jm.clone(t,e.position)}i.heading=i.heading-Km.PI_OVER_TWO;const o=Ut.fromHeadingPitchRoll(i,pf),r=rA.fromQuaternion(o,mf);rA.getColumn(r,0,e.direction),rA.getColumn(r,2,e.up),jm.cross(e.direction,e.up,e.right),e._setTransform(s)}(this,s,Tf,n)}lookAt(e,t){if(!Hm(e))throw new Lm("target is required");if(!Hm(t))throw new Lm("offset is required");if(this._mode===bC.MORPHING)throw new Lm("lookAt is not supported while morphing.");(t=zm(t,zm.EMPTY_OBJECT)).heading=zm(t.heading,0),t.pitch=zm(t.pitch,-Km.PI_OVER_TWO),t.range=t.range||.01;const i=aA.clone(this.transform,Cf);var n=bA.eastNorthUpToFixedFrame(e,eA.WGS84,ff);this.lookAtTransform(n,t),this._mode===bC.SCENE3D&&this._setTransform(i)}lookAtTransform(e,t){if(!Hm(e))throw new Lm("transform is required");if(this._mode===bC.MORPHING)throw new Lm("lookAtTransform is not supported while morphing.");if(this._setTransform(e),!Hm(t))return;let i;if(i=Hm(t.heading)?function(e,t,i){t=Km.clamp(t,-Km.PI_OVER_TWO,Km.PI_OVER_TWO),e=Km.zeroToTwoPi(e)-Km.PI_OVER_TWO;const n=uA.fromAxisAngle(jm.UNIT_Y,-t,yf),s=uA.fromAxisAngle(jm.UNIT_Z,-e,_f),o=uA.multiply(s,n,s),r=rA.fromQuaternion(o,vf),a=jm.clone(jm.UNIT_X,bf);return rA.multiplyByVector(r,a,a),jm.negate(a,a),jm.multiplyByScalar(a,i,a),a}(t.heading,t.pitch,t.range):t,this._mode===bC.SCENE2D){oA.clone(oA.ZERO,this.position),jm.negate(i,this.up),this.up.z=0,jm.magnitudeSquared(this.up)<Km.EPSILON10&&jm.clone(jm.UNIT_Y,this.up),jm.normalize(this.up,this.up),this._setTransform(aA.IDENTITY),jm.negate(jm.UNIT_Z,this.direction),jm.cross(this.direction,this.up,this.right),jm.normalize(this.right,this.right);const t=this.frustum,n=t.top/t.right;return t.right=.5*jm.magnitude(i),t.left=-t.right,t.top=n*t.right,t.bottom=-t.top,void this._setTransform(e)}jm.clone(i,this.position),jm.negate(this.position,this.direction),jm.normalize(this.direction,this.direction),jm.cross(this.direction,jm.UNIT_Z,this.right),jm.magnitudeSquared(this.right)<Km.EPSILON10&&jm.clone(jm.UNIT_X,this.right),jm.normalize(this.right,this.right),jm.cross(this.right,this.direction,this.up),jm.normalize(this.up,this.up)}move(e,t){const i=this.position;jm.multiplyByScalar(e,t,Zf),jm.add(i,Zf,i)}moveForward(e){e=zm(e,this.defaultMoveAmount),this.move(this.direction,e)}moveBackward(e){e=zm(e,this.defaultMoveAmount),this.move(this.direction,-e)}moveUp(e){e=zm(e,this.defaultMoveAmount),this.move(this.up,e)}moveDown(e){e=zm(e,this.defaultMoveAmount),this.move(this.up,-e)}moveRight(e){e=zm(e,this.defaultMoveAmount),this.move(this.right,e)}moveLeft(e){e=zm(e,this.defaultMoveAmount),this.move(this.right,-e)}rotateAroundPoint(e,t,i){const n=new Qt;jm.subtract(this.position,e,n);const s=zm(i,this.defaultRotateAmount),o=uA.fromAxisAngle(t,-s,Ff),r=rA.fromQuaternion(o,Xf);rA.multiplyByVector(r,n,n),rA.multiplyByVector(r,this.direction,this.direction),rA.multiplyByVector(r,this.up,this.up),rA.multiplyByVector(r,this.right,this.right),jm.add(n,e,this.position)}zoomIn(e){!function(e,t){e.move(e.direction,t)}(this,e=zm(e,this.defaultZoomAmount))}rotate(e,t){var i=zm(t,this.defaultRotateAmount),n=uA.fromAxisAngle(e,-i,Ff),s=rA.fromQuaternion(n,Xf);rA.multiplyByVector(s,this.position,this.position),rA.multiplyByVector(s,this.direction,this.direction),rA.multiplyByVector(s,this.up,this.up),jm.cross(this.direction,this.up,this.right),jm.cross(this.right,this.direction,this.up)}rotateDown(e){Pf(this,e=zm(e,this.defaultRotateAmount))}rotateUp(e){Pf(this,-(e=zm(e,this.defaultRotateAmount)))}rotateRight(e){kf(this,-(e=zm(e,this.defaultRotateAmount)))}rotateLeft(e){kf(this,e=zm(e,this.defaultRotateAmount))}look(e,t){var i=zm(t,this.defaultLookAmount),n=uA.fromAxisAngle(e,-i,Hf),s=rA.fromQuaternion(n,zf),o=this.direction,r=this.up,a=this.right;rA.multiplyByVector(s,o,o),rA.multiplyByVector(s,r,r),rA.multiplyByVector(s,a,a)}lookLeft(e){e=zm(e,this.defaultLookAmount),this._mode!==bC.SCENE2D&&this.look(this.up,-e)}lookRight(e){e=zm(e,this.defaultLookAmount),this._mode!==bC.SCENE2D&&this.look(this.up,e)}lookUp(e){e=zm(e,this.defaultLookAmount),this._mode!==bC.SCENE2D&&this.look(this.right,-e)}lookDown(e){e=zm(e,this.defaultLookAmount),this._mode!==bC.SCENE2D&&this.look(this.right,e)}getPickRay(e,t){if(!Hm(e))throw new Lm("windowPosition is required.");return Hm(t)||(t=new xi),function(e,t,i){var n=e._scene.canvas,s=n.clientWidth,o=n.clientHeight,r=Math.tan(.5*ft.degToRad(e._camera.fov)),a=e._camera.aspect*r,l=e._camera.near,g=2/s*t.x-1,c=2/o*(o-t.y)-1,d=e.positionWC;jm.clone(d,i.origin);var h=jm.multiplyByScalar(e.directionWC,l,Vf);jm.add(d,h,h);var u=jm.multiplyByScalar(e.rightWC,g*l*a,Wf),I=jm.multiplyByScalar(e.upWC,c*l*r,Ef),p=jm.add(h,u,i.direction);return jm.add(p,I,p),jm.subtract(p,d,p),jm.normalize(p,p),i}(this,e,t)}pickEllipsoid(e,t,i){return Hm(i)||(i=new Qt),i=function(e,t,i,n){i=zm(i,eA.WGS84);var s=e.getPickRay(t,Nf),o=YA.rayEllipsoid(s,i);if(o){var r=o.start>0?o.start:o.stop;return fC.getPoint(s,r,n)}}(this,e,t=zm(t,eA.WGS84),i),i}worldToCameraCoordinates(e,t){return Hm(t)||(t=new Dt(0,0,0,0)),nf(this),aA.multiplyByVector(this._actualInvTransform,e,t)}worldToCameraCoordinatesPoint(e,t){if(!Hm(e))throw new Lm("cartesian is required.");return Hm(t)||(t=new Qt),nf(this),aA.multiplyByPoint(this._actualInvTransform,e,t)}cancelFlight(){if(Hm(this._currentFlight)){const e=this._currentFlight.listener;this._scene._engine.removePrepareRenderListener(e),this._currentFlight=void 0}}completeFlight(){if(Hm(this._currentFlight)){const e=this._currentFlight.listener;this._scene._engine.removePrepareRenderListener(e);const t={destination:void 0,orientation:{heading:void 0,pitch:void 0,roll:void 0}};t.destination=Mf.destination,t.orientation.heading=Mf.heading,t.orientation.pitch=Mf.pitch,t.orientation.roll=Mf.roll,this.setView(t),Hm(this._currentFlight.complete)&&this._currentFlight.complete(),this._currentFlight=void 0}}flyTo(e){let t=(e=zm(e,{})).destination;if(this._mode===bC.MORPHING)return;this.cancelFlight();const i=t instanceof IA;i&&(t=this.getRectangleCameraCoordinates(t,Gf));let n=zm(e.orientation,zm.EMPTY_OBJECT);if(Hm(n.direction)&&(n=Sf(this,t,n,Rf.orientation)),Hm(e.duration)&&e.duration<=0){const t=Rf;return t.destination=e.destination,t.orientation.heading=n.heading,t.orientation.pitch=n.pitch,t.orientation.roll=n.roll,t.convert=e.convert,t.endTransform=e.endTransform,this.setView(t),void("function"==typeof e.complete&&e.complete())}const s=this;Mf.destination=t,Mf.heading=n.heading,Mf.pitch=n.pitch,Mf.roll=n.roll,Mf.duration=e.duration,Mf.complete=function(){s._currentFlight=void 0,Hm(e.complete)&&e.complete()},Mf.cancel=e.cancel,Mf.endTransform=e.endTransform,Mf.convert=!i&&e.convert,Mf.maximumHeight=e.maximumHeight,Mf.pitchAdjustHeight=e.pitchAdjustHeight,Mf.flyOverLongitude=e.flyOverLongitude,Mf.flyOverLongitudeWeight=e.flyOverLongitudeWeight,Mf.easingFunction=e.easingFunction;const o=this._scene,r=zC.createTween(o,Mf);if(0===r.duration)return void("function"==typeof r.complete&&r.complete());const a=o._engine;let l=performance.now();function g(e){const t=performance.now()-l,{duration:i,complete:n,update:s,easingFunction:o}=r;if(t>=i)return s({time:i,easingFunction:o}),a.removePrepareRenderListener(g),void n();s({time:t,easingFunction:o}),a.map.map._syncFromEllipsoidCamera(),a.requestRender()}a.addPrepareRenderListener(g),r.listener=g,this._currentFlight=r}flyHome(e){let t=new Qt,i=this._mode;if(i===bC.MORPHING&&this._scene.completeMorph(),i===bC.SCENE2D)this.flyTo({destination:Of.DEFAULT_VIEW_RECTANGLE,duration:e,endTransform:aA.IDENTITY});else if(i===bC.SCENE3D){let t=this.getRectangleCameraCoordinates(Of.DEFAULT_VIEW_RECTANGLE),i=jm.magnitude(t);i+=i*Of.DEFAULT_VIEW_FACTOR,jm.normalize(t,t),jm.multiplyByScalar(t,i,t),this.flyTo({destination:t,duration:e,endTransform:aA.IDENTITY}),this._scene._engine.requestRender()}else if(i===bC.COLUMBUS_VIEW){let i=this._projection.ellipsoid.maximumRadius,n=new Qt(0,-1,1);n=jm.multiplyByScalar(jm.normalize(n,n),5*i,n),this.flyTo({destination:n,duration:e,orientation:{heading:0,pitch:-Math.acos(jm.normalize(n,t).z),roll:0},endTransform:aA.IDENTITY,convert:!1})}}getRectangleCameraCoordinates(e,t){const i=this._mode;if(Hm(t)||(t=new Qt),i===bC.SCENE3D)return lb(this,e,t)}update(){}_adjustOrthographicFrustum(e){}clone(e,t){return Hm(t)||(t=new Of(e._scene)),jm.clone(e.position,t.position),jm.clone(e.direction,t.direction),jm.clone(e.up,t.up),jm.clone(e.right,t.right),aA.clone(e._transform,t.transform),t._transformChanged=!0,t.frustum=e.frustum.clone(),t}getLocalTransform(){const e=this._ellipsoid,t=aA.clone(this._transform,af),i=bA.eastNorthUpToFixedFrame(this.positionWC,e,lf);this._setTransform(i);const n=new Bi;return n.set(this.right.x,this.up.x,-this.direction.x,0,this.right.y,this.up.y,-this.direction.y,0,this.right.z,this.up.z,-this.direction.z,0,0,0,0,1),this._setTransform(t),n}get transform(){return this._transform}get inverseTransform(){return nf(this),this._invTransform}get viewMatrix(){return nf(this),this._viewMatrix}get inverseViewMatrix(){return nf(this),this._invViewMatrix}get positionCartographic(){return nf(this),this._positionCartographic}get positionWC(){return nf(this),this._positionWC}get directionWC(){return nf(this),this._directionWC}get upWC(){return nf(this),this._upWC}get rightWC(){return nf(this),this._rightWC}get heading(){const e=this._ellipsoid,t=aA.clone(this._transform,af),i=bA.eastNorthUpToFixedFrame(this.positionWC,e,lf);this._setTransform(i);const n=sf(this.direction,this.up);return this._setTransform(t),n}get pitch(){const e=this._ellipsoid,t=aA.clone(this._transform,af),i=bA.eastNorthUpToFixedFrame(this.positionWC,e,lf);this._setTransform(i);const n=of(this.direction);return this._setTransform(t),n}get roll(){const e=this._ellipsoid,t=aA.clone(this._transform,af),i=bA.eastNorthUpToFixedFrame(this.positionWC,e,lf);this._setTransform(i);const n=rf(this.direction,this.up,this.right);return this._setTransform(t),n}get moveStart(){return this._moveStart}get moveEnd(){return this._moveEnd}get changed(){return this._changed}};let Uf=Of;__publicField(Uf,"DEFAULT_VIEW_RECTANGLE",IA.fromDegrees(73,-5,140,70)),__publicField(Uf,"DEFAULT_VIEW_FACTOR",.5),__publicField(Uf,"DEFAULT_OFFSET",new fA(0,Math.PI/4,0));const Qf=new Qt,Jf=new Qt,jf=new Qt,qf=new Qt,$f=new Qt,eb=new Qt,tb=new Qt,ib=new Qt,nb=new Qt,sb=new Qt,ob={direction:new Qt,right:new Qt,up:new Qt};let rb;function ab(e,t,i,n){return Math.abs(jm.dot(t,i))/n-jm.dot(e,i)}function lb(e,t,i,n){const s=e._projection.ellipsoid,o=n?e:ob,r=t.north,a=t.south;let l=t.east;const g=t.west;g>l&&(l+=Km.TWO_PI);const c=.5*(g+l);let d;if(a<-Km.PI_OVER_TWO+Km.RADIANS_PER_DEGREE&&r>Km.PI_OVER_TWO-Km.RADIANS_PER_DEGREE)d=0;else{const e=Qf;e.x=c,e.y=r,e.z=0;const t=Jf;t.x=c,t.y=a,t.z=0;let i=rb;Hm(i)&&i.ellipsoid===s||(rb=i=new EC(void 0,void 0,s)),i.setEndPoints(e,t),d=i.interpolateUsingFraction(.5,Qf).y}const h=Qf;h.x=c,h.y=d,h.z=0;const u=s.cartographicToCartesian(h,nb),I=Qf;I.x=l,I.y=r;const p=s.cartographicToCartesian(I,jf);I.x=g;const m=s.cartographicToCartesian(I,$f);I.x=c;const A=s.cartographicToCartesian(I,tb);I.y=a;const C=s.cartographicToCartesian(I,ib);I.x=l;const f=s.cartographicToCartesian(I,eb);I.x=g;const b=s.cartographicToCartesian(I,qf);jm.subtract(m,u,m),jm.subtract(f,u,f),jm.subtract(p,u,p),jm.subtract(b,u,b),jm.subtract(A,u,A),jm.subtract(C,u,C);const y=s.geodeticSurfaceNormal(u,o.direction);jm.negate(y,y);const _=jm.cross(y,jm.UNIT_Z,o.right);jm.normalize(_,_);const v=jm.cross(_,y,o.up);let x;const B=Math.tan(.5*ft.degToRad(e._camera.fov)),w=e._camera.aspect*B;if(x=Math.max(ab(y,v,m,B),ab(y,v,f,B),ab(y,v,p,B),ab(y,v,b,B),ab(y,v,A,B),ab(y,v,C,B),ab(y,_,m,w),ab(y,_,f,w),ab(y,_,p,w),ab(y,_,b,w),ab(y,_,A,w),ab(y,_,C,w)),a<0&&r>0){const e=Qf;e.x=g,e.y=0,e.z=0;let t=s.cartographicToCartesian(e,sb);jm.subtract(t,u,t),x=Math.max(x,ab(y,v,t,B),ab(y,_,t,w)),e.x=l,t=s.cartographicToCartesian(e,sb),jm.subtract(t,u,t),x=Math.max(x,ab(y,v,t,B),ab(y,_,t,w))}return jm.add(u,jm.multiplyByScalar(y,-x,sb),i)}const gb=new Qt,cb=new Qt(0,0,1);class db extends vm{constructor(){super(),this.uniforms=as.clone(Em.uniforms),this.material=new ls({defines:{MVT_USE_NORMAL_TEXTURE:!1},uniforms:this.uniforms,vertexShader:Sm.vertexShader,fragmentShader:Em.fragmentShader,depthTest:!1,depthWrite:!1,transparent:!0}),this.needsSwap=!0,this.fsQuad=new wm(null),this.needsDepthTexture=!0,this.needsNormalTextureWhenMRT=!0}render(e,t,i){const n=this.sky;if(!n)return;const s=this.rendering,o=s.camera,r=s._engine,a=r.map.isGlobe,l=this.uniforms;l.tDiffuse.value=i.texture,l.tDepth.value=s.main.sceneRendering.depthTexture,l.isGlobe.value=a,l.viewInverseMatrix.value.copy(o.matrixWorld),l.projectionInverseMatrix.value.copy(o.projectionMatrixInverse),l.cameraNear.value=o.near,l.cameraFar.value=o.far,l.color.value.copy(n.color),l.highColor.value.copy(n.highColor),l.cameraPosition.value.copy(o.position);let g=r.map.getViewHeight();g=a?Math.max(g/1e6,2e-4):2e-4,l.viewHeight.value=g,l.resolution=s.uniforms.resolution,l.sunDirection.value.copy(n.localSunDirection);let c=0,d=1;if("earth"===s._engine.map.mapType){let e=s._engine.map._map._ellipsoidCamera;if(!this._sphereCamera){const e=new eA(6371e3,6371e3,6371e3);this._sphereCamera=new Uf({_ellipsoid:e,mapProjection:new tA(e),camera:o})}const t=this._sphereCamera;t.position.copy(e.position),t.direction.copy(e.direction),t.up.copy(e.up),t.right.copy(e.right),e=t,l.viewInverseMatrix.value.copy(e.getLocalTransform());const i=l.viewInverseMatrix.value.elements;gb.set(i[8],i[9],i[10]);const n=ft.clamp(gb.dot(cb),.1,1),r=1e6*l.viewHeight.value/n,a=ft.mapLinear(Math.sqrt(10*l.viewHeight.value),0,1,20,2),g=Math.max(r+100,r*a);c=s.renderState.getDepthByDistance(r),d=s.renderState.getDepthByDistance(g)}l.fogDepthRange.value.set(c,d);const h=e.autoClear,u=e.getRenderTarget();e.autoClear=!1,this.fsQuad.material=this.material,e.setRenderTarget(this.renderToScreen?null:t),e.clear(!0,!1,!1),this.fsQuad.render(e),e.autoClear=h,e.setRenderTarget(u)}dispose(){this.material.dispose(),this.fsQuad.dispose()}}class hb extends _m{constructor(){super(...arguments),__publicField(this,"isDefaultSky",!0),__publicField(this,"name","DefaultSky"),__publicField(this,"_postPass",null),__publicField(this,"_engine",null)}afterAddToEngine(e){super.afterAddToEngine(e),this._engine=e,this._color=new In(1,1,1,1),this._highColor=new In(.6,.8,1),this.initEnv()}beforeRemoveFromEngine(e){e.rendering.main.postprocessings.remove(this._postPass),super.beforeRemoveFromEngine(e)}initEnv(){const e=this._engine,t=this._postPass=new db;t.renderOrder=50,t.sky=this,e.rendering.main.opaquePostprocessings.add(t)}get highColor(){return this._highColor}set highColor(e){e.isColor&&this._highColor.copy(e)}get color(){return this._color}set color(e){e.isColor&&this._color.copy(e)}get enablePostPass(){return this._postPass.enabled||!1}set enablePostPass(e){this._postPass&&(this._postPass.enabled=e)}dispose(){super.dispose()}}
/*!
  * Proton v1.1.4
  * https://github.com/JackXie60/shader-particle-system
  * Copyright 2022-2025, JackXie60
  * Licensed under the MIT license
  * http://www.opensource.org/licenses/mit-license
  *
  */var ub,Ib,pb,mb={types:{Boolean:"boolean",STRING:"string",NUMBER:"number",OBJECT:"object"},ensureTypedArg:function(e,t,i){return typeof e===t?e:i},ensureArrayTypedArg:function(e,t,i){if(Array.isArray(e)){for(var n=e.length-1;n>=0;--n)if(typeof e[n]!==t)return i;return e}return this.ensureTypedArg(e,t,i)},ensureInstanceOf:function(e,t,i){return void 0!==e?e:i},ensureArrayInstanceOf:function(e,t,i){if(Array.isArray(e)){for(var n=e.length-1;n>=0;--n)if(void 0!==t&&e[n]instanceof t==0)return i;return e}return this.ensureInstanceOf(e,t,i)},ensureValueOverLifetimeCompliance:function(e,t,i){t=t||3,i=i||3,!1===Array.isArray(e._value)&&(e._value=[e._value]),!1===Array.isArray(e._spread)&&(e._spread=[e._spread]);var n=this.clamp(e._value.length,t,i),s=this.clamp(e._spread.length,t,i),o=Math.max(n,s);e._value.length!==o&&(e._value=this.interpolateArray(e._value,o)),e._spread.length!==o&&(e._spread=this.interpolateArray(e._spread,o))},interpolateArray:function(e,t){for(var i=e.length,n=["function"==typeof e[0].clone?e[0].clone():e[0]],s=(i-1)/(t-1),o=1;o<t-1;++o){var r=o*s,a=Math.floor(r),l=Math.ceil(r),g=r-a;n[o]=this.lerpTypeAgnostic(e[a],e[l],g)}return n.push("function"==typeof e[i-1].clone?e[i-1].clone():e[i-1]),n},clamp:function(e,t,i){return Math.max(t,Math.min(e,i))},zeroToEpsilon:function(e,t){var i=1e-5,n=e;return n=t?Math.random()*i*10:i,e<0&&e>-1e-5&&(n=-n),n},lerpTypeAgnostic:function(e,t,i){var n,s=this.types;return typeof e===s.NUMBER&&typeof t===s.NUMBER?e+(t-e)*i:e instanceof bt&&t instanceof bt?((n=e.clone()).x=this.lerp(e.x,t.x,i),n.y=this.lerp(e.y,t.y,i),n):e instanceof Qt&&t instanceof Qt?((n=e.clone()).x=this.lerp(e.x,t.x,i),n.y=this.lerp(e.y,t.y,i),n.z=this.lerp(e.z,t.z,i),n):e instanceof Dt&&t instanceof Dt?((n=e.clone()).x=this.lerp(e.x,t.x,i),n.y=this.lerp(e.y,t.y,i),n.z=this.lerp(e.z,t.z,i),n.w=this.lerp(e.w,t.w,i),n):e instanceof In&&t instanceof In?((n=e.clone()).r=this.lerp(e.r,t.r,i),n.g=this.lerp(e.g,t.g,i),n.b=this.lerp(e.b,t.b,i),n):void console.warn("Invalid argument types, or argument types do not match:",e,t)},lerp:function(e,t,i){return e+(t-e)*i},roundToNearestMultiple:function(e,t){var i;return 0===t||0==(i=Math.abs(e)%t)?e:e<0?-(Math.abs(e)-i):e+t-i},arrayValuesAreEqual:function(e){for(var t=0;t<e.length-1;++t)if(e[t]!==e[t+1])return!1;return!0},randomFloat:function(e,t){return e+t*(Math.random()-.5)},randomVector3:function(e,t,i,n,s){var o=i.x+(Math.random()*n.x-.5*n.x),r=i.y+(Math.random()*n.y-.5*n.y),a=i.z+(Math.random()*n.z-.5*n.z);s&&(o=.5*-s.x+this.roundToNearestMultiple(o,s.x),r=.5*-s.y+this.roundToNearestMultiple(r,s.y),a=.5*-s.z+this.roundToNearestMultiple(a,s.z)),e.typedArray.setVec3Components(t,o,r,a)},randomColor:function(e,t,i,n){var s=i.r+Math.random()*n.x,o=i.g+Math.random()*n.y,r=i.b+Math.random()*n.z;s=this.clamp(s,0,1),o=this.clamp(o,0,1),r=this.clamp(r,0,1),e.typedArray.setVec3Components(t,s,o,r)},randomColorAsHex:(Ib=new In,function(e,t,i,n){for(var s=i.length,o=[],r=0;r<s;++r){var a=n[r];Ib.copy(i[r]),Ib.r+=Math.random()*a.x-.5*a.x,Ib.g+=Math.random()*a.y-.5*a.y,Ib.b+=Math.random()*a.z-.5*a.z,Ib.r=this.clamp(Ib.r,0,1),Ib.g=this.clamp(Ib.g,0,1),Ib.b=this.clamp(Ib.b,0,1),o.push(Ib.getHex())}e.typedArray.setVec4Components(t,o[0],o[1],o[2],o[3])}),randomVector3OnLine:function(e,t,i,n){var s=i.clone();s.lerp(n,Math.random()),e.typedArray.setVec3Components(t,s.x,s.y,s.z)},randomVector3OnSphere:function(e,t,i,n,s,o,r,a){var l=2*Math.random()-1,g=6.2832*Math.random(),c=Math.sqrt(1-l*l),d=this.randomFloat(n,s),h=0,u=0,I=0;r&&(d=Math.round(d/r)*r),h=c*Math.cos(g)*d,u=c*Math.sin(g)*d,I=l*d,h*=o.x,u*=o.y,I*=o.z,h+=i.x,u+=i.y,I+=i.z,e.typedArray.setVec3Components(t,h,u,I)},seededRandom:function(e){var t=1e4*Math.sin(e);return t-(0|t)},randomVector3OnDisc:function(e,t,i,n,s,o,r){var a=6.2832*Math.random(),l=Math.abs(this.randomFloat(n,s)),g=0,c=0,d=0;r&&(l=Math.round(l/r)*r),g=Math.cos(a)*l,c=Math.sin(a)*l,g*=o.x,c*=o.y,g+=i.x,c+=i.y,d+=i.z,e.typedArray.setVec3Components(t,g,c,d)},randomDirectionVector3OnSphere:(ub=new Qt,function(e,t,i,n,s,o,r,a){ub.copy(o),ub.x-=i,ub.y-=n,ub.z-=s,ub.normalize().multiplyScalar(-this.randomFloat(r,a)),e.typedArray.setVec3Components(t,ub.x,ub.y,ub.z)}),randomDirectionVector3OnDisc:(pb=new Qt,function(e,t,i,n,s,o,r,a){pb.copy(o),pb.x-=i,pb.y-=n,pb.z-=s,pb.normalize().multiplyScalar(-this.randomFloat(r,a)),e.typedArray.setVec3Components(t,pb.x,pb.y,0)}),getPackedRotationAxis:function(){var e=new Qt,t=new Qt,i=new In,n=new Qt(1,1,1);return function(s,o){return e.copy(s).normalize(),t.copy(o).normalize(),e.x+=.5*-o.x+Math.random()*o.x,e.y+=.5*-o.y+Math.random()*o.y,e.z+=.5*-o.z+Math.random()*o.z,e.normalize().add(n).multiplyScalar(.5),i.setRGB(e.x,e.y,e.z),i.getHex()}}()},Ab={BOX:1,SPHERE:2,DISC:3,LINE:4},Cb=4,fb=function(){function e(e,t,i,n){this.componentSize=i||1,this.size=t||1,this.TypedArrayConstructor=e||Float32Array,this.array=new e(t*this.componentSize),this.indexOffset=n||0}var t=e.prototype;return t.setSize=function(e,t){var i=this.array.length;return t||(e*=this.componentSize),e<i?this.shrink(e):e>i?this.grow(e):void console.info("TypedArray is already of size:",e+".","Will not resize.")},t.shrink=function(e){return this.array=this.array.subarray(0,e),this.size=e,this},t.grow=function(e){var t=new this.TypedArrayConstructor(e);return t.set(this.array),this.array=t,this.size=e,this},t.splice=function(e,t){for(var i=e*this.componentSize,n=t*this.componentSize,s=[],o=this.array.length,r=0;r<o;++r)(r<i||r>n)&&s.push(this.array[r]);return this.setFromArray(0,s),this},t.setFromArray=function(e,t){var i=e+t.length;return i>this.array.length?this.grow(i):i<this.array.length&&this.shrink(i),this.array.set(t,this.indexOffset+e),this},t.setVec2=function(e,t){return this.setVec2Components(e,t.x,t.y)},t.setVec2Components=function(e,t,i){var n=this.array,s=this.indexOffset+e*this.componentSize;return n[s]=t,n[s+1]=i,this},t.setVec3=function(e,t){return this.setVec3Components(e,t.x,t.y,t.z)},t.setVec3Components=function(e,t,i,n){var s=this.array,o=this.indexOffset+e*this.componentSize;return s[o]=t,s[o+1]=i,s[o+2]=n,this},t.setVec4=function(e,t){return this.setVec4Components(e,t.x,t.y,t.z,t.w)},t.setVec4Components=function(e,t,i,n,s){var o=this.array,r=this.indexOffset+e*this.componentSize;return o[r]=t,o[r+1]=i,o[r+2]=n,o[r+3]=s,this},t.setMat3=function(e,t){return this.setFromArray(this.indexOffset+e*this.componentSize,t.elements)},t.setMat4=function(e,t){return this.setFromArray(this.indexOffset+e*this.componentSize,t.elements)},t.setColor=function(e,t){return this.setVec3Components(e,t.r,t.g,t.b)},t.setNumber=function(e,t){return this.array[this.indexOffset+e*this.componentSize]=t,this},t.getValueAtIndex=function(e){return this.array[this.indexOffset+e]},t.getComponentValueAtIndex=function(e){return this.array.subarray(this.indexOffset+e*this.componentSize)},e}(),bb=function(){function e(t,i,n){var s=e.typeSizeMap;this.type="string"==typeof t&&s.hasOwnProperty(t)?t:"f",this.componentSize=s[this.type],this.arrayType=n||Float32Array,this.typedArray=null,this.bufferAttribute=null,this.dynamicBuffer=!!i,this.updateMin=0,this.updateMax=0}var t=e.prototype;return t.setUpdateRange=function(e,t){this.updateMin=Math.min(e*this.componentSize,this.updateMin*this.componentSize),this.updateMax=Math.max(t*this.componentSize,this.updateMax*this.componentSize)},t.flagUpdate=function(){var e=this.bufferAttribute,t=e.updateRange;t.offset=this.updateMin,t.count=Math.min(this.updateMax-this.updateMin+this.componentSize,this.typedArray.array.length),e.needsUpdate=!0},t.resetUpdateRange=function(){this.updateMin=0,this.updateMax=0},t.resetDynamic=function(){this.bufferAttribute.useage=this.dynamicBuffer?et:$e},t.splice=function(e,t){this.typedArray.splice(e,t),this.forceUpdateAll()},t.forceUpdateAll=function(){this.bufferAttribute.array=this.typedArray.array,this.bufferAttribute.updateRange.offset=0,this.bufferAttribute.updateRange.count=-1,this.bufferAttribute.usage=$e,this.bufferAttribute.needsUpdate=!0},t._ensureTypedArray=function(e){null!==this.typedArray&&this.typedArray.size===e*this.componentSize||(null!==this.typedArray&&this.typedArray.size!==e?this.typedArray.setSize(e):null===this.typedArray&&(this.typedArray=new fb(this.arrayType,e,this.componentSize)))},t._createBufferAttribute=function(e){if(this._ensureTypedArray(e),null!==this.bufferAttribute)return this.bufferAttribute.array=this.typedArray.array,this.bufferAttribute.count=this.bufferAttribute.array.length/this.bufferAttribute.itemSize,void(this.bufferAttribute.needsUpdate=!0);this.bufferAttribute=new Bn(this.typedArray.array,this.componentSize),this.bufferAttribute.usage=this.dynamicBuffer?et:$e},t.getLength=function(){return null===this.typedArray?0:this.typedArray.array.length},e}();bb.typeSizeMap={f:1,v2:2,v3:3,v4:4,c:3,m3:9,m4:16};var yb={defines:["#define PACKED_COLOR_SIZE 256.0","#define PACKED_COLOR_DIVISOR 255.0"].join("\n"),uniforms:["uniform float deltaTime;","uniform float runTime;","uniform sampler2D tex;","uniform vec4 textureAnimation;","uniform float scale;"].join("\n"),attributes:["attribute vec4 acceleration;","attribute vec3 velocity;","attribute vec4 rotation;","attribute vec3 rotationCenter;","attribute vec4 params;","attribute vec4 size;","attribute vec4 angle;","attribute vec4 color;","attribute vec4 opacity;"].join("\n"),varyings:["varying vec4 vColor;","#ifdef SHOULD_ROTATE_TEXTURE","    varying float vAngle;","#endif","#ifdef SHOULD_CALCULATE_SPRITE","    varying vec4 vSpriteSheet;","#endif"].join("\n"),branchAvoidanceFunctions:["float when_gt(float x, float y) {","    return max(sign(x - y), 0.0);","}","float when_lt(float x, float y) {","    return min( max(1.0 - sign(x - y), 0.0), 1.0 );","}","float when_eq( float x, float y ) {","    return 1.0 - abs( sign( x - y ) );","}","float when_ge(float x, float y) {","  return 1.0 - when_lt(x, y);","}","float when_le(float x, float y) {","  return 1.0 - when_gt(x, y);","}","float and(float a, float b) {","    return a * b;","}","float or(float a, float b) {","    return min(a + b, 1.0);","}"].join("\n"),unpackColor:["vec3 unpackColor( in float hex ) {","   vec3 c = vec3( 0.0 );","   float r = mod( (hex / PACKED_COLOR_SIZE / PACKED_COLOR_SIZE), PACKED_COLOR_SIZE );","   float g = mod( (hex / PACKED_COLOR_SIZE), PACKED_COLOR_SIZE );","   float b = mod( hex, PACKED_COLOR_SIZE );","   c.r = r / PACKED_COLOR_DIVISOR;","   c.g = g / PACKED_COLOR_DIVISOR;","   c.b = b / PACKED_COLOR_DIVISOR;","   return c;","}"].join("\n"),unpackRotationAxis:["vec3 unpackRotationAxis( in float hex ) {","   vec3 c = vec3( 0.0 );","   float r = mod( (hex / PACKED_COLOR_SIZE / PACKED_COLOR_SIZE), PACKED_COLOR_SIZE );","   float g = mod( (hex / PACKED_COLOR_SIZE), PACKED_COLOR_SIZE );","   float b = mod( hex, PACKED_COLOR_SIZE );","   c.r = r / PACKED_COLOR_DIVISOR;","   c.g = g / PACKED_COLOR_DIVISOR;","   c.b = b / PACKED_COLOR_DIVISOR;","   c *= vec3( 2.0 );","   c -= vec3( 1.0 );","   return c;","}"].join("\n"),floatOverLifetime:["float getFloatOverLifetime( in float positionInTime, in vec4 attr ) {","    highp float value = 0.0;","    float deltaAge = positionInTime * float( VALUE_OVER_LIFETIME_LENGTH - 1 );","    float fIndex = 0.0;","    float shouldApplyValue = 0.0;","    value += attr[ 0 ] * when_eq( deltaAge, 0.0 );","","    for( int i = 0; i < VALUE_OVER_LIFETIME_LENGTH - 1; ++i ) {","       fIndex = float( i );","       shouldApplyValue = and( when_gt( deltaAge, fIndex ), when_le( deltaAge, fIndex + 1.0 ) );","       value += shouldApplyValue * mix( attr[ i ], attr[ i + 1 ], deltaAge - fIndex );","    }","","    return value;","}"].join("\n"),colorOverLifetime:["vec3 getColorOverLifetime( in float positionInTime, in vec3 color1, in vec3 color2, in vec3 color3, in vec3 color4 ) {","    vec3 value = vec3( 0.0 );","    value.x = getFloatOverLifetime( positionInTime, vec4( color1.x, color2.x, color3.x, color4.x ) );","    value.y = getFloatOverLifetime( positionInTime, vec4( color1.y, color2.y, color3.y, color4.y ) );","    value.z = getFloatOverLifetime( positionInTime, vec4( color1.z, color2.z, color3.z, color4.z ) );","    return value;","}"].join("\n"),paramFetchingFunctions:["float getAlive() {","   return params.x;","}","float getAge() {","   return params.y;","}","float getMaxAge() {","   return params.z;","}","float getWiggle() {","   return params.w;","}"].join("\n"),forceFetchingFunctions:["vec4 getPosition( in float age ) {","   return modelViewMatrix * vec4( position, 1.0 );","}","vec3 getVelocity( in float age ) {","   return velocity * age;","}","vec3 getAcceleration( in float age ) {","   return acceleration.xyz * age;","}"].join("\n"),rotationFunctions:["#ifdef SHOULD_ROTATE_PARTICLES","   mat4 getRotationMatrix( in vec3 axis, in float angle) {","       axis = normalize(axis);","       float s = sin(angle);","       float c = cos(angle);","       float oc = 1.0 - c;","","       return mat4(oc * axis.x * axis.x + c,           oc * axis.x * axis.y - axis.z * s,  oc * axis.z * axis.x + axis.y * s,  0.0,","                   oc * axis.x * axis.y + axis.z * s,  oc * axis.y * axis.y + c,           oc * axis.y * axis.z - axis.x * s,  0.0,","                   oc * axis.z * axis.x - axis.y * s,  oc * axis.y * axis.z + axis.x * s,  oc * axis.z * axis.z + c,           0.0,","                   0.0,                                0.0,                                0.0,                                1.0);","   }","","   vec3 getRotation( in vec3 pos, in float positionInTime ) {","      if( rotation.y == 0.0 ) {","           return pos;","      }","","      vec3 axis = unpackRotationAxis( rotation.x );","      vec3 center = rotationCenter;","      vec3 translated;","      mat4 rotationMatrix;","      float angle = 0.0;","      angle += when_eq( rotation.z, 0.0 ) * rotation.y;","      angle += when_gt( rotation.z, 0.0 ) * mix( 0.0, rotation.y, positionInTime );","      translated = rotationCenter - pos;","      rotationMatrix = getRotationMatrix( axis, angle );","      return center - vec3( rotationMatrix * vec4( translated, 0.0 ) );","   }","#endif"].join("\n"),rotateTexture:["    vec2 vUv = vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y );","","    #ifdef SHOULD_ROTATE_TEXTURE","       float x = gl_PointCoord.x - 0.5;","       float y = 1.0 - gl_PointCoord.y - 0.5;","       float c = cos( -vAngle );","       float s = sin( -vAngle );","       vUv = vec2( c * x + s * y + 0.5, c * y - s * x + 0.5 );","    #endif","","    #ifdef SHOULD_CALCULATE_SPRITE","        float framesX = vSpriteSheet.x;","        float framesY = vSpriteSheet.y;","        float columnNorm = vSpriteSheet.z;","        float rowNorm = vSpriteSheet.w;","        vUv.x = gl_PointCoord.x * framesX + columnNorm;","        vUv.y = 1.0 - (gl_PointCoord.y * framesY + rowNorm);","    #endif","","    vec4 rotatedTexture = texture2D( tex, vUv );"].join("\n")},_b={vertex:[yb.defines,yb.uniforms,yb.attributes,yb.varyings,Bs.common,Bs.logdepthbuf_pars_vertex,Bs.fog_pars_fragment,yb.branchAvoidanceFunctions,yb.unpackColor,yb.unpackRotationAxis,yb.floatOverLifetime,yb.colorOverLifetime,yb.paramFetchingFunctions,yb.forceFetchingFunctions,yb.rotationFunctions,"void main() {","    highp float age = getAge();","    highp float alive = getAlive();","    highp float maxAge = getMaxAge();","    highp float positionInTime = (age / maxAge);","    highp float isAlive = when_gt( alive, 0.0 );","    #ifdef SHOULD_WIGGLE_PARTICLES","        float wiggleAmount = positionInTime * getWiggle();","        float wiggleSin = isAlive * sin( wiggleAmount );","        float wiggleCos = isAlive * cos( wiggleAmount );","    #endif","    vec3 vel = getVelocity( age );","    vec3 accel = getAcceleration( age );","    vec3 force = vec3( 0.0 );","    vec3 pos = vec3( position );","    float drag = 1.0 - (positionInTime * 0.5) * acceleration.w;","    force += vel;","    force *= drag;","    force += accel * age;","    pos += force;","    #ifdef SHOULD_WIGGLE_PARTICLES","        pos.x += wiggleSin;","        pos.y += wiggleCos;","        pos.z += wiggleSin;","    #endif","    #ifdef SHOULD_ROTATE_PARTICLES","        pos = getRotation( pos, positionInTime );","    #endif","    vec4 mvPosition = modelViewMatrix * vec4( pos, 1.0 );","    highp float pointSize = getFloatOverLifetime( positionInTime, size ) * isAlive;","    #ifdef HAS_PERSPECTIVE","        float perspective = scale / length( mvPosition.xyz );","    #else","        float perspective = 1.0;","    #endif","    float pointSizePerspective = pointSize * perspective;","    #ifdef COLORIZE","       vec3 c = isAlive * getColorOverLifetime(","           positionInTime,","           unpackColor( color.x ),","           unpackColor( color.y ),","           unpackColor( color.z ),","           unpackColor( color.w )","       );","    #else","       vec3 c = vec3(1.0);","    #endif","    float o = isAlive * getFloatOverLifetime( positionInTime, opacity );","    vColor = vec4( c, o );","    #ifdef SHOULD_ROTATE_TEXTURE","        vAngle = isAlive * getFloatOverLifetime( positionInTime, angle );","    #endif","    #ifdef SHOULD_CALCULATE_SPRITE","        float framesX = textureAnimation.x;","        float framesY = textureAnimation.y;","        float loopCount = textureAnimation.w;","        float totalFrames = textureAnimation.z;","        float frameNumber = mod( (positionInTime * loopCount) * totalFrames, totalFrames );","        float column = floor(mod( frameNumber, framesX ));","        float row = floor( (frameNumber - column) / framesX );","        float columnNorm = column / framesX;","        float rowNorm = row / framesY;","        vSpriteSheet.x = 1.0 / framesX;","        vSpriteSheet.y = 1.0 / framesY;","        vSpriteSheet.z = columnNorm;","        vSpriteSheet.w = rowNorm;","    #endif","    gl_PointSize = pointSizePerspective;","    gl_Position = projectionMatrix * mvPosition;",Bs.logdepthbuf_vertex,"}"].join("\n"),fragment:[yb.uniforms,Bs.common,Bs.fog_pars_fragment,Bs.logdepthbuf_pars_fragment,yb.varyings,yb.branchAvoidanceFunctions,"void main() {","    vec3 outgoingLight = vColor.xyz;","    ","    #ifdef ALPHATEST","       if ( vColor.w < float(ALPHATEST) ) discard;","    #endif",yb.rotateTexture,Bs.logdepthbuf_fragment,"    outgoingLight = vColor.xyz * rotatedTexture.xyz;","    gl_FragColor = vec4( outgoingLight.xyz, rotatedTexture.w * vColor.w );",Bs.fog_fragment,"}"].join("\n")},vb=function(){function e(e){var t=mb.types,i=Cb;for(var n in(e=mb.ensureTypedArg(e,t.OBJECT,{})).position=mb.ensureTypedArg(e.position,t.OBJECT,{}),e.velocity=mb.ensureTypedArg(e.velocity,t.OBJECT,{}),e.acceleration=mb.ensureTypedArg(e.acceleration,t.OBJECT,{}),e.radius=mb.ensureTypedArg(e.radius,t.OBJECT,{}),e.drag=mb.ensureTypedArg(e.drag,t.OBJECT,{}),e.rotation=mb.ensureTypedArg(e.rotation,t.OBJECT,{}),e.color=mb.ensureTypedArg(e.color,t.OBJECT,{}),e.opacity=mb.ensureTypedArg(e.opacity,t.OBJECT,{}),e.size=mb.ensureTypedArg(e.size,t.OBJECT,{}),e.angle=mb.ensureTypedArg(e.angle,t.OBJECT,{}),e.wiggle=mb.ensureTypedArg(e.wiggle,t.OBJECT,{}),e.maxAge=mb.ensureTypedArg(e.maxAge,t.OBJECT,{}),e.onParticleSpawn&&console.warn("onParticleSpawn has been removed. Please set properties directly to alter values at runtime."),this.uuid=ft.generateUUID(),this.type=mb.ensureTypedArg(e.type,t.NUMBER,Ab.BOX),this.position={_value:mb.ensureInstanceOf(e.position.value,Qt,new Qt),_spread:mb.ensureInstanceOf(e.position.spread,Qt,new Qt),_spreadClamp:mb.ensureInstanceOf(e.position.spreadClamp,Qt,new Qt),_distribution:mb.ensureTypedArg(e.position.distribution,t.NUMBER,this.type),_randomise:mb.ensureTypedArg(e.position.randomise,t.BOOLEAN,!1),_radius:mb.ensureTypedArg(e.position.radius,t.NUMBER,10),_radiusScale:mb.ensureInstanceOf(e.position.radiusScale,Qt,new Qt(1,1,1)),_distributionClamp:mb.ensureTypedArg(e.position.distributionClamp,t.NUMBER,0)},this.velocity={_value:mb.ensureInstanceOf(e.velocity.value,Qt,new Qt),_spread:mb.ensureInstanceOf(e.velocity.spread,Qt,new Qt),_distribution:mb.ensureTypedArg(e.velocity.distribution,t.NUMBER,this.type),_randomise:mb.ensureTypedArg(e.position.randomise,t.BOOLEAN,!1)},this.acceleration={_value:mb.ensureInstanceOf(e.acceleration.value,Qt,new Qt),_spread:mb.ensureInstanceOf(e.acceleration.spread,Qt,new Qt),_distribution:mb.ensureTypedArg(e.acceleration.distribution,t.NUMBER,this.type),_randomise:mb.ensureTypedArg(e.position.randomise,t.BOOLEAN,!1)},this.drag={_value:mb.ensureTypedArg(e.drag.value,t.NUMBER,0),_spread:mb.ensureTypedArg(e.drag.spread,t.NUMBER,0),_randomise:mb.ensureTypedArg(e.position.randomise,t.BOOLEAN,!1)},this.wiggle={_value:mb.ensureTypedArg(e.wiggle.value,t.NUMBER,0),_spread:mb.ensureTypedArg(e.wiggle.spread,t.NUMBER,0)},this.rotation={_axis:mb.ensureInstanceOf(e.rotation.axis,Qt,new Qt(0,1,0)),_axisSpread:mb.ensureInstanceOf(e.rotation.axisSpread,Qt,new Qt),_angle:mb.ensureTypedArg(e.rotation.angle,t.NUMBER,0),_angleSpread:mb.ensureTypedArg(e.rotation.angleSpread,t.NUMBER,0),_static:mb.ensureTypedArg(e.rotation.static,t.BOOLEAN,!1),_center:mb.ensureInstanceOf(e.rotation.center,Qt,this.position._value.clone()),_randomise:mb.ensureTypedArg(e.position.randomise,t.BOOLEAN,!1)},this.maxAge={_value:mb.ensureTypedArg(e.maxAge.value,t.NUMBER,2),_spread:mb.ensureTypedArg(e.maxAge.spread,t.NUMBER,0)},this.color={_value:mb.ensureArrayInstanceOf(e.color.value,In,new In),_spread:mb.ensureArrayInstanceOf(e.color.spread,Qt,new Qt),_randomise:mb.ensureTypedArg(e.position.randomise,t.BOOLEAN,!1)},this.opacity={_value:mb.ensureArrayTypedArg(e.opacity.value,t.NUMBER,1),_spread:mb.ensureArrayTypedArg(e.opacity.spread,t.NUMBER,0),_randomise:mb.ensureTypedArg(e.position.randomise,t.BOOLEAN,!1)},this.size={_value:mb.ensureArrayTypedArg(e.size.value,t.NUMBER,1),_spread:mb.ensureArrayTypedArg(e.size.spread,t.NUMBER,0),_randomise:mb.ensureTypedArg(e.position.randomise,t.BOOLEAN,!1)},this.angle={_value:mb.ensureArrayTypedArg(e.angle.value,t.NUMBER,0),_spread:mb.ensureArrayTypedArg(e.angle.spread,t.NUMBER,0),_randomise:mb.ensureTypedArg(e.position.randomise,t.BOOLEAN,!1)},this.particleCount=mb.ensureTypedArg(e.particleCount,t.NUMBER,100),this.duration=mb.ensureTypedArg(e.duration,t.NUMBER,null),this.isStatic=mb.ensureTypedArg(e.isStatic,t.BOOLEAN,!1),this.activeMultiplier=mb.ensureTypedArg(e.activeMultiplier,t.NUMBER,1),this.direction=mb.ensureTypedArg(e.direction,t.NUMBER,1),this.alive=mb.ensureTypedArg(e.alive,t.BOOLEAN,!0),this.particlesPerSecond=0,this.activationIndex=0,this.attributeOffset=0,this.attributeEnd=0,this.age=0,this.activeParticleCount=0,this.group=null,this.attributes=null,this.paramsArray=null,this.resetFlags={position:mb.ensureTypedArg(e.position.randomise,t.BOOLEAN,!1)||mb.ensureTypedArg(e.radius.randomise,t.BOOLEAN,!1),velocity:mb.ensureTypedArg(e.velocity.randomise,t.BOOLEAN,!1),acceleration:mb.ensureTypedArg(e.acceleration.randomise,t.BOOLEAN,!1)||mb.ensureTypedArg(e.drag.randomise,t.BOOLEAN,!1),rotation:mb.ensureTypedArg(e.rotation.randomise,t.BOOLEAN,!1),rotationCenter:mb.ensureTypedArg(e.rotation.randomise,t.BOOLEAN,!1),size:mb.ensureTypedArg(e.size.randomise,t.BOOLEAN,!1),color:mb.ensureTypedArg(e.color.randomise,t.BOOLEAN,!1),opacity:mb.ensureTypedArg(e.opacity.randomise,t.BOOLEAN,!1),angle:mb.ensureTypedArg(e.angle.randomise,t.BOOLEAN,!1)},this.updateFlags={},this.updateCounts={},this.updateMap={maxAge:"params",position:"position",velocity:"velocity",acceleration:"acceleration",drag:"acceleration",wiggle:"params",rotation:"rotation",size:"size",color:"color",opacity:"opacity",angle:"angle"},this.updateMap)this.updateMap.hasOwnProperty(n)&&(this.updateCounts[this.updateMap[n]]=0,this.updateFlags[this.updateMap[n]]=!1,this._createGetterSetters(this[n],n));this.bufferUpdateRanges={},this.attributeKeys=null,this.attributeCount=0,mb.ensureValueOverLifetimeCompliance(this.color,i,i),mb.ensureValueOverLifetimeCompliance(this.opacity,i,i),mb.ensureValueOverLifetimeCompliance(this.size,i,i),mb.ensureValueOverLifetimeCompliance(this.angle,i,i)}var t=e.prototype;return t._createGetterSetters=function(e,t){var i=this;Object.keys(e).forEach((function(n){var s=n.replace("_","");Object.defineProperty(e,s,{get:function(){return this[n]},set:function(e){var s=i.updateMap[t],o=this[n],r=Cb;"_rotationCenter"===n?(i.updateFlags.rotationCenter=!0,this.updateCounts.rotationCenter=0):"_randomise"===n?i.resetFlags[s]=e:(i.updateFlags[s]=!0,i.updateCounts[s]=0),i.group._updateDefines(),this[n]=e,Array.isArray(o)&&mb.ensureValueOverLifetimeCompliance(i[t],r,r)}})}))},t._setBufferUpdateRanges=function(e){this.attributeKeys=e,this.attributeCount=e.length;for(var t=this.attributeCount-1;t>=0;--t)this.bufferUpdateRanges[e[t]]={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY}},t._calculatePPSValue=function(e){var t=this.particleCount;this.duration?this.particlesPerSecond=t/(e<this.duration?e:this.duration):this.particlesPerSecond=t/e},t._setAttributeOffset=function(e){this.attributeOffset=e,this.activationIndex=e,this.activationEnd=e+this.particleCount},t._assignValue=function(e,t){switch(e){case"position":this._assignPositionValue(t);break;case"velocity":case"acceleration":this._assignForceValue(t,e);break;case"size":case"opacity":this._assignAbsLifetimeValue(t,e);break;case"angle":this._assignAngleValue(t);break;case"params":this._assignParamsValue(t);break;case"rotation":this._assignRotationValue(t);break;case"color":this._assignColorValue(t)}},t._assignPositionValue=function(e){var t=Ab,i=this.position,n=this.attributes.position,s=i._value,o=i._spread;switch(i.distribution){case t.BOX:mb.randomVector3(n,e,s,o,i._spreadClamp);break;case t.SPHERE:mb.randomVector3OnSphere(n,e,s,i._radius,i._spread.x,i._radiusScale,i._spreadClamp.x,i._distributionClamp||this.particleCount);break;case t.DISC:mb.randomVector3OnDisc(n,e,s,i._radius,i._spread.x,i._radiusScale,i._spreadClamp.x);break;case t.LINE:mb.randomVector3OnLine(n,e,s,o)}},t._assignForceValue=function(e,t){var i,n,s,o,r,a=Ab,l=this[t],g=l._value,c=l._spread;switch(l._distribution){case a.BOX:mb.randomVector3(this.attributes[t],e,g,c);break;case a.SPHERE:n=(i=this.attributes.position.typedArray.array)[r=3*e],s=i[r+1],o=i[r+2],mb.randomDirectionVector3OnSphere(this.attributes[t],e,n,s,o,this.position._value,l._value.x,l._spread.x);break;case a.DISC:n=(i=this.attributes.position.typedArray.array)[r=3*e],s=i[r+1],o=i[r+2],mb.randomDirectionVector3OnDisc(this.attributes[t],e,n,s,o,this.position._value,l._value.x,l._spread.x);break;case a.LINE:mb.randomVector3OnLine(this.attributes[t],e,g,c)}if("acceleration"===t){var d=mb.clamp(mb.randomFloat(this.drag._value,this.drag._spread),0,1);this.attributes.acceleration.typedArray.array[4*e+3]=d}},t._assignAbsLifetimeValue=function(e,t){var i,n=this.attributes[t].typedArray,s=this[t];mb.arrayValuesAreEqual(s._value)&&mb.arrayValuesAreEqual(s._spread)?(i=Math.abs(mb.randomFloat(s._value[0],s._spread[0])),n.setVec4Components(e,i,i,i,i)):n.setVec4Components(e,Math.abs(mb.randomFloat(s._value[0],s._spread[0])),Math.abs(mb.randomFloat(s._value[1],s._spread[1])),Math.abs(mb.randomFloat(s._value[2],s._spread[2])),Math.abs(mb.randomFloat(s._value[3],s._spread[3])))},t._assignAngleValue=function(e){var t,i=this.attributes.angle.typedArray,n=this.angle;mb.arrayValuesAreEqual(n._value)&&mb.arrayValuesAreEqual(n._spread)?(t=mb.randomFloat(n._value[0],n._spread[0]),i.setVec4Components(e,t,t,t,t)):i.setVec4Components(e,mb.randomFloat(n._value[0],n._spread[0]),mb.randomFloat(n._value[1],n._spread[1]),mb.randomFloat(n._value[2],n._spread[2]),mb.randomFloat(n._value[3],n._spread[3]))},t._assignParamsValue=function(e){this.attributes.params.typedArray.setVec4Components(e,this.isStatic?1:0,0,Math.abs(mb.randomFloat(this.maxAge._value,this.maxAge._spread)),mb.randomFloat(this.wiggle._value,this.wiggle._spread))},t._assignRotationValue=function(e){this.attributes.rotation.typedArray.setVec3Components(e,mb.getPackedRotationAxis(this.rotation._axis,this.rotation._axisSpread),mb.randomFloat(this.rotation._angle,this.rotation._angleSpread),this.rotation._static?0:1),this.attributes.rotationCenter.typedArray.setVec3(e,this.rotation._center)},t._assignColorValue=function(e){mb.randomColorAsHex(this.attributes.color,e,this.color._value,this.color._spread)},t._resetParticle=function(e){for(var t,i,n=this.resetFlags,s=this.updateFlags,o=this.updateCounts,r=this.attributeKeys,a=this.attributeCount-1;a>=0;--a)i=s[t=r[a]],!0!==n[t]&&!0!==i||(this._assignValue(t,e),this._updateAttributeUpdateRange(t,e),!0===i&&o[t]===this.particleCount?(s[t]=!1,o[t]=0):!0===i&&++o[t])},t._updateAttributeUpdateRange=function(e,t){var i=this.bufferUpdateRanges[e];i.min=Math.min(t,i.min),i.max=Math.max(t,i.max)},t._resetBufferRanges=function(){for(var e,t=this.bufferUpdateRanges,i=this.bufferUpdateKeys,n=this.bufferUpdateCount-1;n>=0;--n)t[e=i[n]].min=Number.POSITIVE_INFINITY,t[e].max=Number.NEGATIVE_INFINITY},t._onRemove=function(){this.particlesPerSecond=0,this.attributeOffset=0,this.activationIndex=0,this.activeParticleCount=0,this.group=null,this.attributes=null,this.paramsArray=null,this.age=0},t._decrementParticleCount=function(){--this.activeParticleCount},t._incrementParticleCount=function(){++this.activeParticleCount},t._checkParticleAges=function(e,t,i,n){for(var s,o,r,a,l=t-1;l>=e;--l)0!==(a=i[s=4*l])&&(r=i[s+1],o=i[s+2],1===this.direction?(r+=n)>=o&&(r=0,a=0,this._decrementParticleCount()):(r-=n)<=0&&(r=o,a=0,this._decrementParticleCount()),i[s]=a,i[s+1]=r,this._updateAttributeUpdateRange("params",l))},t._activateParticles=function(e,t,i,n){for(var s,o,r=this.direction,a=e;a<t;++a)0!==i[s=4*a]&&1!==this.particleCount||(this._incrementParticleCount(),i[s]=1,this._resetParticle(a),o=n*(a-e),i[s+1]=-1===r?i[s+2]-o:o,this._updateAttributeUpdateRange("params",a))},t.update=function(e){if(!this.isStatic){null===this.paramsArray&&(this.paramsArray=this.attributes.params.typedArray.array);var t=this.attributeOffset,i=t+this.particleCount,n=this.paramsArray,s=this.particlesPerSecond*this.activeMultiplier*e,o=this.activationIndex;if(this._resetBufferRanges(),this._checkParticleAges(t,i,n,e),!1!==this.alive){if(null!==this.duration&&this.age>this.duration)return this.alive=!1,void(this.age=0);var r=1===this.particleCount?o:0|o,a=Math.min(r+s,this.activationEnd),l=a-this.activationIndex|0,g=l>0?e/l:0;this._activateParticles(r,a,n,g),this.activationIndex+=s,this.activationIndex>i&&(this.activationIndex=t),this.age+=e}else this.age=0}},t.reset=function(e){if(this.age=0,this.alive=!1,!0===e){for(var t,i=this.attributeOffset,n=i+this.particleCount,s=this.paramsArray,o=this.attributes.params.bufferAttribute,r=n-1;r>=i;--r)s[t=4*r]=0,s[t+1]=0;o.updateRange.offset=0,o.updateRange.count=-1,o.needsUpdate=!0}return this},t.enable=function(){return this.alive=!0,this},t.disable=function(){return this.alive=!1,this},t.remove=function(){return null!==this.group?this.group.removeEmitter(this):console.error("Emitter does not belong to a group, cannot remove."),this},e}(),xb=function(){function e(e){var t=mb.types;(e=mb.ensureTypedArg(e,t.OBJECT,{})).texture=mb.ensureTypedArg(e.texture,t.OBJECT,{}),this.uuid=ft.generateUUID(),this.fixedTimeStep=mb.ensureTypedArg(e.fixedTimeStep,t.NUMBER,.0167),this.texture=e.texture.value||null,this.textureFrames=e.texture.frames||new bt(1,1),this.textureFrameCount=mb.ensureTypedArg(e.texture.frameCount,t.NUMBER,this.textureFrames.x*this.textureFrames.y),this.textureLoop=mb.ensureTypedArg(e.texture.loop,t.NUMBER,1),this.textureFrames.max(new bt(1,1)),this.hasPerspective=mb.ensureTypedArg(e.hasPerspective,t.BOOLEAN,!0),this.colorize=mb.ensureTypedArg(e.colorize,t.BOOLEAN,!0),this.maxParticleCount=mb.ensureTypedArg(e.maxParticleCount,t.NUMBER,null),this.blending=mb.ensureTypedArg(e.blending,t.NUMBER,2),this.transparent=mb.ensureTypedArg(e.transparent,t.BOOLEAN,!0),this.alphaTest=parseFloat(mb.ensureTypedArg(e.alphaTest,t.NUMBER,0)),this.depthWrite=mb.ensureTypedArg(e.depthWrite,t.BOOLEAN,!1),this.depthTest=mb.ensureTypedArg(e.depthTest,t.BOOLEAN,!0),this.fog=mb.ensureTypedArg(e.fog,t.BOOLEAN,!0),this.scale=mb.ensureTypedArg(e.scale,t.NUMBER,300),this.emitters=[],this.emitterIDs=[],this._pool=[],this._poolCreationSettings=null,this._createNewWhenPoolEmpty=0,this._attributesNeedRefresh=!1,this._attributesNeedDynamicReset=!1,this.particleCount=0,this.uniforms={tex:{type:"t",value:this.texture},textureAnimation:{type:"v4",value:new Dt(this.textureFrames.x,this.textureFrames.y,this.textureFrameCount,Math.max(Math.abs(this.textureLoop),1))},fogColor:{type:"c",value:this.fog?new In:null},fogNear:{type:"f",value:10},fogFar:{type:"f",value:200},fogDensity:{type:"f",value:.5},deltaTime:{type:"f",value:0},runTime:{type:"f",value:0},scale:{type:"f",value:this.scale}},this.defines={HAS_PERSPECTIVE:this.hasPerspective,COLORIZE:this.colorize,VALUE_OVER_LIFETIME_LENGTH:Cb,SHOULD_ROTATE_TEXTURE:!1,SHOULD_ROTATE_PARTICLES:!1,SHOULD_WIGGLE_PARTICLES:!1,SHOULD_CALCULATE_SPRITE:this.textureFrames.x>1||this.textureFrames.y>1},this.attributes={position:new bb("v3",!0),acceleration:new bb("v4",!0),velocity:new bb("v3",!0),rotation:new bb("v4",!0),rotationCenter:new bb("v3",!0),params:new bb("v4",!0),size:new bb("v4",!0),angle:new bb("v4",!0),color:new bb("v4",!0),opacity:new bb("v4",!0)},this.attributeKeys=Object.keys(this.attributes),this.attributeCount=this.attributeKeys.length,this.material=new ls({uniforms:this.uniforms,vertexShader:_b.vertex,fragmentShader:_b.fragment,blending:this.blending,transparent:this.transparent,alphaTest:this.alphaTest,depthWrite:this.depthWrite,depthTest:this.depthTest,defines:this.defines,fog:this.fog}),this.geometry=new Fn,this.mesh=new Ja(this.geometry,this.material),null===this.maxParticleCount&&console.warn("Group: No maxParticleCount specified. Adding emitters after rendering will probably cause errors.")}var t=e.prototype;return t._updateDefines=function(){for(var e,t=this.emitters,i=this.defines,n=t.length-1;n>=0;--n)e=t[n],i.SHOULD_CALCULATE_SPRITE||(i.SHOULD_ROTATE_TEXTURE=i.SHOULD_ROTATE_TEXTURE||!!Math.max(Math.max.apply(null,e.angle.value),Math.max.apply(null,e.angle.spread))),i.SHOULD_ROTATE_PARTICLES=i.SHOULD_ROTATE_PARTICLES||!!Math.max(e.rotation.angle,e.rotation.angleSpread),i.SHOULD_WIGGLE_PARTICLES=i.SHOULD_WIGGLE_PARTICLES||!!Math.max(e.wiggle.value,e.wiggle.spread);this.material.needsUpdate=!0},t._applyAttributesToGeometry=function(){var e,t,i=this.attributes,n=this.geometry,s=n.attributes;Object.keys(i).forEach((function(o){e=i[o],(t=s[o])?t.array=e.typedArray.array:n.setAttribute(o,e.bufferAttribute),e.bufferAttribute.needsUpdate=!0})),this.geometry.setDrawRange(0,this.particleCount)},t.addEmitter=function(e){if(e instanceof vb!=0)if(this.emitterIDs.indexOf(e.uuid)>-1)console.error("Emitter already exists in this group. Will not add again.");else{if(null===e.group){var t=this.attributes,i=this.particleCount,n=i+e.particleCount;for(var s in this.particleCount=n,null!==this.maxParticleCount&&this.particleCount>this.maxParticleCount&&console.warn("Group: maxParticleCount exceeded. Requesting",this.particleCount,"particles, can support only",this.maxParticleCount),e._calculatePPSValue(e.maxAge._value+e.maxAge._spread),e._setBufferUpdateRanges(this.attributeKeys),e._setAttributeOffset(i),e.group=this,e.attributes=this.attributes,t)t.hasOwnProperty(s)&&t[s]._createBufferAttribute(null!==this.maxParticleCount?this.maxParticleCount:this.particleCount);for(var o=i;o<n;++o)e._assignPositionValue(o),e._assignForceValue(o,"velocity"),e._assignForceValue(o,"acceleration"),e._assignAbsLifetimeValue(o,"opacity"),e._assignAbsLifetimeValue(o,"size"),e._assignAngleValue(o),e._assignRotationValue(o),e._assignParamsValue(o),e._assignColorValue(o);return this._applyAttributesToGeometry(),this.emitters.push(e),this.emitterIDs.push(e.uuid),this._updateDefines(e),this.material.needsUpdate=!0,this.geometry.needsUpdate=!0,this._attributesNeedRefresh=!0,this}console.error("Emitter already belongs to another group. Will not add to requested group.")}else console.error("`emitter` argument must be instance of Emitter. Was provided with:",e)},t.removeEmitter=function(e){var t=this.emitterIDs.indexOf(e,this.uuid);if(e instanceof vb!=0)if(-1!==t){for(var i=e.attributeOffset,n=i+e.particleCount,s=this.attributes.params.typedArray,o=i;o<n;++o)s.array[4*o]=0,s.array[4*o+1]=0;for(var r in this.emitters.splice(t,1),this.emitterIDs.splice(t,1),this.attributes)this.attributes.hasOwnProperty(r)&&this.attributes[r].splice(i,n);this.particleCount-=e.particleCount,e._onRemove(),this._attributesNeedRefresh=!0}else console.error("Emitter does not exist in this group. Will not remove.");else console.error("`emitter` argument must be instance of Emitter. Was provided with:",e)},t.getFromPool=function(){var e=this._pool,t=this._createNewWhenPoolEmpty;if(e.length)return e.pop();if(t){var i=new vb(this._poolCreationSettings);return this.addEmitter(i),i}return null},t.releaseIntoPool=function(e){if(e instanceof vb!=0)return e.reset(),this._pool.unshift(e),this;console.error("Argument is not instanceof Emitter:",e)},t.getPool=function(){return this._pool},t.addPool=function(e,t,i){var n;this._poolCreationSettings=t,this._createNewWhenPoolEmpty=!!i;for(var s=0;s<e;++s)n=Array.isArray(t)?new vb(t[s]):new vb(t),this.addEmitter(n),this.releaseIntoPool(n);return this},t._triggerSingleEmitter=function(e){var t=this.getFromPool(),i=this;if(null!==t)return e instanceof Qt&&(t.position.value.copy(e),t.position.value=t.position.value),t.enable(),setTimeout((function(){t.disable(),i.releaseIntoPool(t)}),1e3*Math.max(t.duration,t.maxAge.value+t.maxAge.spread)),this;console.log("Group pool ran out.")},t.triggerPoolEmitter=function(e,t){if("number"==typeof e&&e>1)for(var i=0;i<e;++i)this._triggerSingleEmitter(t);else this._triggerSingleEmitter(t);return this},t._updateUniforms=function(e){this.uniforms.runTime.value+=e,this.uniforms.deltaTime.value=e},t._resetBufferRanges=function(){for(var e=this.attributeKeys,t=this.attributes,i=this.attributeCount-1;i>=0;--i)t[e[i]].resetUpdateRange()},t._updateBuffers=function(e){for(var t,i,n,s=this.attributeKeys,o=this.attributes,r=e.bufferUpdateRanges,a=this.attributeCount-1;a>=0;--a)i=r[t=s[a]],(n=o[t]).setUpdateRange(i.min,i.max),n.flagUpdate()},t.update=function(e){var t,i=this.emitters,n=i.length,s=e||this.fixedTimeStep,o=this.attributeKeys,r=this.attributes;if(this._updateUniforms(s),this._resetBufferRanges(),0!==n||!1!==this._attributesNeedRefresh||!1!==this._attributesNeedDynamicReset){for(var a,l=0;l<n;++l)(a=i[l]).update(s),this._updateBuffers(a);if(!0===this._attributesNeedDynamicReset){for(t=this.attributeCount-1;t>=0;--t)r[o[t]].resetDynamic();this._attributesNeedDynamicReset=!1}if(!0===this._attributesNeedRefresh){for(t=this.attributeCount-1;t>=0;--t)r[o[t]].forceUpdateAll();this._attributesNeedRefresh=!1,this._attributesNeedDynamicReset=!0}}},t.dispose=function(){return this.geometry.dispose(),this.material.dispose(),this},e}();class Bb extends Ji{constructor(e,t){super(),__publicField(this,"update",(()=>{this._system.update(this._clock.getDelta())})),__publicField(this,"createSnow",(()=>(new Dl).load(mm("assets/textures/sky/others/snow.png")))),__publicField(this,"createEmitter",(()=>new vb({maxAge:{value:10},position:{value:new Qt(0,100,150),spread:new Qt(1e3,1e3,500)},acceleration:{value:new Qt(0,0,-10),spread:new Qt(3,3,0)},velocity:{value:new Qt(0,0,-10),spread:new Qt(5,5,0)},size:{value:10},particleCount:1e4}))),this._renderer=e,this._camera=t,this._clock=new ag;const i=this._system=new xb({texture:{value:this.createSnow()},maxParticleCount:1e4}),n=this._emitter=this.createEmitter(t,e);i.addEmitter(n),this.add(i.mesh)}dispose(){}}class wb extends Ji{constructor(e,t){super(),__publicField(this,"update",(()=>{this._system.update(this._clock.getDelta())})),__publicField(this,"createRain",(()=>(new Dl).load(mm("assets/textures/sky/others/trace_01.png")))),__publicField(this,"createEmitter",(()=>new vb({maxAge:{value:10},position:{value:new Qt(0,100,250),spread:new Qt(1e3,1e3,500)},acceleration:{value:new Qt(0,0,-50),spread:new Qt(3,3,0)},velocity:{value:new Qt(0,10,-50),spread:new Qt(3,3,0)},size:{value:60},particleCount:2e4}))),this._clock=new ag;const i=this._system=new xb({texture:{value:this.createRain()},maxParticleCount:2e4}),n=this._emitter=this.createEmitter(t,e);i.addEmitter(n),this.add(i.mesh)}dispose(){}}class Sb extends Ji{constructor(e){super(),__publicField(this,"_engine"),__publicField(this,"_sky"),__publicField(this,"_snow"),__publicField(this,"_rain"),__publicField(this,"_weather",""),__publicField(this,"_currentConverageTextureType",null),__publicField(this,"_tCoverageIntensity",null),__publicField(this,"_skyGroundColorBlue",new In(1657983)),__publicField(this,"_skyGroundColorGray",new In(11184810)),__publicField(this,"_weatherChangedListeners",[]),__publicField(this,"_sunLightScale",1),__publicField(this,"_skyLightScale",1),__publicField(this,"transitionDuration",1e3),__publicField(this,"_transitionStartTime",0),__publicField(this,"_transitionStartState",{}),__publicField(this,"_transitionEndState",{}),__publicField(this,"_inTransition",!1),__publicField(this,"_modifyCount",0),__publicField(this,"beforeRemoveFromEngine",(e=>{this._sky.sunLightIntensity=1,this._sky.skyLightIntensity=.5,this._sky.cloudIntensity=.2,this._sky.mixGrayFactor=0,this._engine.rendering.fog.density=0,this._engine.rendering.composition.coverageIntensity=0,e.removePrepareRenderListener(this.handleBeforeRender)})),__publicField(this,"handleBeforeRender",(e=>{if(this._snow){const e=this._engine.camera.position;this._snow.position.copy(e),this._snow.update()}if(this._rain){const e=this._engine.camera.position;this._rain.position.copy(e),this._rain.update()}if(this._modifyCount>0&&(this._modifyCount=0,this._transitionStartTime=Date.now(),this._inTransition=!0,this._transitionStartState={sunLightIntensity:this._sky.sunLightIntensity/this._sunLightScale,cloudIntensity:this._sky.cloudIntensity,skyLightIntensity:this._sky.skyLightIntensity/this._skyLightScale,coverageIntensity:0,fogDensity:this._engine.rendering.fog.density,mixGrayFactor:this._sky.mixGrayFactor}),this._inTransition){const t=(Date.now()-this._transitionStartTime)/this.transitionDuration;t>1&&(this._inTransition=!1),this._updateWeatherTransitionState(t),e.requestRender()}})),__publicField(this,"_updateWeatherTransitionState",(e=>{e<0&&(e=0),e>1&&(e=1);const t=this._transitionStartState,i=this._transitionEndState;this._sky.sunLightIntensity=ft.lerp(t.sunLightIntensity,i.sunLightIntensity,e)*this._sunLightScale,this._sky.skyLightIntensity=ft.lerp(t.skyLightIntensity,i.skyLightIntensity,e)*this._skyLightScale,this._sky.cloudCoverage=ft.lerp(t.cloudIntensity,i.cloudIntensity,e),this._engine.rendering.fog.density=ft.lerp(t.fogDensity,i.fogDensity,e),this._sky.mixGrayFactor=ft.lerp(t.mixGrayFactor,i.mixGrayFactor,e),this._engine.rendering.composition.coverageIntensity=ft.lerp(t.coverageIntensity,i.coverageIntensity,e)})),this._sky=e}get weather(){return this._weather}set weather(e){if(e&&e!==this._weather){this._weather=e,this.updateWeather(e);for(const t of this._weatherChangedListeners)t(e)}}afterAddToEngine(e){this._engine=e,e.addPrepareRenderListener(this.handleBeforeRender),this.updateWeather(this._weather)}getCoverageTexture(e){if(null===this._tCoverageIntensity||e!==this._currentConverageTextureType){this._tCoverageIntensity&&this._tCoverageIntensity.dispose();let t="assets/textures/realistic/TexturesCom_Snow_Plain_3x3_512_noise.jpg";"rain"===e&&(t="assets/textures/realistic/TexturesCom_Ground_MudWet_512_roughness.jpg"),this._tCoverageIntensity=(new Dl).load(mm(t),(()=>{this._engine.requestRender()}))}return this._tCoverageIntensity}updateWeather(e){const t=this._engine;let i=1,n=.2,s=.5,o=0,r=null,a=0,l=0,g=!1,c=!1;if(this._transitionStartState={sunLightIntensity:this._sky.sunLightIntensity/this._sunLightScale,cloudIntensity:this._sky.cloudCoverage,skyLightIntensity:this._sky.skyLightIntensity/this._skyLightScale,coverageIntensity:0,fogDensity:this._engine.rendering.fog.density,mixGrayFactor:this._sky.mixGrayFactor},this._transitionEndState=this._transitionStartState,"clear"===e)i=1.2,n=0,s=.8,a=0,l=.1;else if("partlyCloudy"===e)i=1,n=.46,s=.9,a=.05,l=.2;else if("cloudy"===e)i=0,n=.53,s=1,a=.5,l=.3;else if("overcast"===e)i=0,n=.7,s=.4,a=.75,l=.4;else if("foggy"===e)i=0,n=0,s=.4,a=1,l=1;else if("rainy"===e)i=0,n=0,s=.4,c=!0,a=1,l=.5;else{if("snowy"!==e)return;i=0,n=0,s=.4,o=1,r=this.getCoverageTexture("snow"),g=!0,a=1,l=.5}if(this._transitionEndState={sunLightIntensity:i,cloudIntensity:n,skyLightIntensity:s,coverageIntensity:o,fogDensity:l,mixGrayFactor:a},this.tCoverageIntensity=r,this._sky.isStaticSky&&(["overcast","foggy","rainy","snowy"].includes(e)?this._sky.weather="overcast":this._sky.weather=e),g){if(!this._snow){const e=this._snow=new Bb(t.renderer,t.camera);this.add(e)}}else this._snow&&(this.remove(this._snow),this._snow.dispose(),this._snow=null);if(c){if(!this._rain){const e=this._rain=new wb(t.renderer,t.camera);this.add(e)}}else this._rain&&(this.remove(this._rain),this._rain.dispose(),this._rain=null);this.transitionDuration<=0?this._updateWeatherTransitionState(1):(this._transitionStartTime=Date.now(),this._inTransition=!0,t.requestRender())}addWeatherChangedListener(e){-1===this._weatherChangedListeners.indexOf(e)&&this._weatherChangedListeners.push(e)}removeWeatherChangedListener(e){const t=this._weatherChangedListeners.indexOf(e);-1!==t&&this._weatherChangedListeners.splice(t,1)}get sunLightIntensity(){return this._transitionEndState.sunLightIntensity}set sunLightIntensity(e){this._modifyCount++,this._transitionEndState.sunLightIntensity=e}get cloudIntensity(){return this._transitionEndState.cloudIntensity}set cloudIntensity(e){this._modifyCount++,this._transitionEndState.cloudIntensity=e}get skyLightIntensity(){return this._transitionEndState.skyLightIntensity}set skyLightIntensity(e){this._modifyCount++,this._transitionEndState.skyLightIntensity=e}get groundColor(){return this._sky.groundColor}set groundColor(e){this._sky.groundColor=e}get mixGrayFactor(){return this._transitionEndState.mixGrayFactor}set mixGrayFactor(e){this._modifyCount++,this._transitionEndState.mixGrayFactor=e}get coverageIntensity(){return this._transitionEndState.coverageIntensity}set coverageIntensity(e){this._modifyCount++,this._transitionEndState.coverageIntensity=e}get tCoverageIntensity(){return this._engine.rendering.composition.tCoverageIntensity}set tCoverageIntensity(e){this._engine.rendering.composition.tCoverageIntensity=e}get tRelectionEnhancement(){return this._engine.rendering.ssr.tEnhancement}set tRelectionEnhancement(e){this._engine.rendering.ssr.tEnhancement=e}set fogDensity(e){this._modifyCount++,this._transitionEndState.fogDensity=e}get fogDensity(){return this._transitionEndState.fogDensity}get skyLightScale(){return this._skyLightScale}set skyLightScale(e){this._skyLightScale=e}get sunLightScale(){return this._sunLightScale}set sunLightScale(e){this._sunLightScale=e}}const Gb=[[0,-.33333333333333337],[-.5,.33333333333333326],[.5,-.7777777777777778],[-.75,-.11111111111111116],[.25,.5555555555555554],[-.25,-.5555555555555556],[.75,.11111111111111116],[-.875,.7777777777777777],[.125,-.9259259259259259],[-.375,-.2592592592592593],[.625,.40740740740740744],[-.625,-.7037037037037037],[.375,-.03703703703703709],[-.125,.6296296296296293],[.875,-.4814814814814815],[-.9375,.18518518518518512]];class Mb{constructor(e){__publicField(this,"_lastTextureRequirementsKey",-1),__publicField(this,"_inited",!1),__publicField(this,"_useFastEmissiveMethod",!0),__publicField(this,"_jitterOffsets",Gb),__publicField(this,"_jitterIndex",0),this._rendering=e}beginFrame(){if(!this._inited)return this._init(),void(this._inited=!0);this._rendering.main.requirements.isTextureRequirementsChanged()&&this._onTextureRequirementsChanged()}updateRenderTargetSamples(e){}_onTextureRequirementsChanged(){this.dispose(),this._init()}_init(){}render(){}endFrame(){}dispose(){}get useFastEmissiveMethod(){return this._useFastEmissiveMethod}set useFastEmissiveMethod(e){this._useFastEmissiveMethod=e}}const Rb="EPSG:4326",Tb="EPSG:3857",Zb="EPSG:4978",Vb="BD:MERCATOR",Wb="SCREEN_PIXEL";class Eb extends Mb{constructor(){super(...arguments),__publicField(this,"isDirectSceneRendering",!0)}_init(){this._rendering.main,this._onTextureRequirementsChanged()}beginFrame(){if(!this._inited)return this._init(),void(this._inited=!0);this._rendering.main.requirements.isTextureRequirementsChanged()&&this._onTextureRequirementsChanged()}_onTextureRequirementsChanged(){const e=this._rendering,t=e.resolution,i=e.pixelRatio;e.main.requirements.needsEmissiveTexture?(this._emissiveRenderTarget=new Yt(t.x*i,t.y*i),this._emissiveRenderTarget.name="EmissiveRenderTarget"):this._disposeEmissiveRenderTarget()}render(){const e=this._rendering,t=e.renderState,i=e.stats,n=e.main,s=e.renderer,o=e._renderer.xr.isPresenting?e.xr.camera:e.camera,r=e.scene,a=e.resolution;e.pixelRatio;const l=n.requirements;if(!t.viewChanged&&l.enableRenderingJitter){let[e,t]=this._jitterOffsets[void 0!==this._debugEngineJitterIndex?this._debugEngineJitterIndex:this._jitterIndex];o.setViewOffset(a.x,a.y,e/2,t/2,a.x,a.y),this._jitterIndex=(this._jitterIndex+1)%this._jitterOffsets.length}if(s.extraProgramCacheKey=l.currentShaderKey,this.renderTarget){if(!this._sceneRenderTarget||l.isRenderTargetTypeChanged()){this._sceneRenderTarget&&(this._sceneRenderTarget.dispose(),this._sceneRenderTarget=null);const t=e.resolution,i=e.pixelRatio,n=this._tDepth=new ta;n.generateMipmaps=!1,this._sceneRenderTarget=new Yt(t.x*i,t.y*i,{type:l.getRenderTargetType()}),this._sceneRenderTarget.name="SceneRenderTarget",l.enableStencilBuffer&&(n.format=j,n.type=O,this._sceneRenderTarget.stencilBuffer=!0),this._sceneRenderTarget.depthTexture=n,this._sceneRenderTarget.samples=e.features.antialias.samples}s.setRenderTarget(this._sceneRenderTarget)}else s.getRenderTarget()&&s.getRenderTarget().isXRRenderTarget||s.setRenderTarget(null),this._sceneRenderTarget&&(this._sceneRenderTarget.dispose(),this._sceneRenderTarget=null);if(i.beginTimeStatsItem("renderScene"),s.render(r,o),i.endTimeStatsItem("renderScene"),this.renderTarget?(this._fsQuad||(this._fsQuad=new wm(new ls({name:"DirectSceneRenderingCopy",vertexShader:Sm.vertexShader,fragmentShader:Sm.fragmentShader,blending:0,depthTest:!1,uniforms:{tDiffuse:{value:this._sceneRenderTarget.texture},opacity:{value:1}}}))),this._fsQuad.material.uniforms.tDiffuse.value=this._sceneRenderTarget.texture,s.setRenderTarget(this.renderTarget),this._fsQuad.render(s)):this._fsQuad&&(this._fsQuad.dispose(),this._fsQuad=null),e.opaquePostprocessings.hide(),l.needsEmissiveTexture){t.stage=11,s.extraProgramCacheKey=l.currentShaderKey+",emissive";const e=new Set,n=new Set;let a=null;r.traverseVisible((t=>{if(a=t.material,a){if(this._useFastEmissiveMethod&&!this._isEmissiveMaterial(a))return t.visible=!1,void e.add(t);a.defines||(a.defines={}),a.defines.MVT_MODE_EMISSIVE=!0,n.add(t)}})),this._useFastEmissiveMethod?this._emissiveRenderTarget.depthTexture=this._sceneRenderTarget.depthTexture:this._emissiveRenderTarget.depthTexture&&(this._emissiveRenderTarget.depthTexture=null),i.beginTimeStatsItem("renderEmissiveTexture"),s.setRenderTarget(this._emissiveRenderTarget);const g=s.autoClear;this._useFastEmissiveMethod&&(s.autoClear=!1,s.clear(!0,!1,!0));const c=r.background;r.background=null;const d=s.shadowMap.enabled;s.shadowMap.enabled=!1,s.render(r,o),r.background=c,s.autoClear=g,s.shadowMap.enabled=d,i.endTimeStatsItem("renderEmissiveTexture");for(const t of n)t.material.defines.MVT_MODE_EMISSIVE=!1;if(this._useFastEmissiveMethod)for(const t of e)t.visible=!0;s.extraProgramCacheKey="",s.setRenderTarget(this.renderTarget)}o.setViewOffset(a.x,a.y,0,0,a.x,a.y)}updateRenderTargetSamples(e){const t=this._sceneRenderTarget;t&&(t.samples=e)}_isBlackColor(e){return 0===e.r&&0===e.g&&0===e.b}_isEmissiveMaterial(e){return!e.disableEmissive&&(!(!e.isShaderMaterial&&!e.isRawShaderMaterial)||(e.isMeshBasicMaterial?e.emissive&&!this._isBlackColor(e.emissive):e.isMeshStandardMaterial||e.isMeshPhongMaterial||e.isMeshLambertMaterial||e.isMeshToonMaterial?e.emissive&&!this._isBlackColor(e.emissive)||!!e.emissiveMap:void 0))}_disposeEmissiveRenderTarget(){this._emissiveRenderTarget&&(this._sceneRenderTarget&&this._emissiveRenderTarget.depthTexture===this._sceneRenderTarget.depthTexture&&(this._emissiveRenderTarget.depthTexture=null),this._emissiveRenderTarget.dispose(),this._emissiveRenderTarget=null)}dispose(){const e=this._rendering.stats;e.removeTimeStatsItem("renderScene"),e.removeTimeStatsItem("renderEmissiveTexture"),this._disposeEmissiveRenderTarget(),this._fsQuad&&(this._fsQuad.dispose(),this._fsQuad=null)}setSize(e,t){const i=this._rendering;i.resolution;const n=i.pixelRatio;this._emissiveRenderTarget&&this._emissiveRenderTarget.setSize(e*n,t*n),this._sceneRenderTarget&&this._sceneRenderTarget.setSize(e*n,t*n)}get emissiveTexture(){return this._emissiveRenderTarget&&this._emissiveRenderTarget.texture}get depthTexture(){return this._sceneRenderTarget&&this._sceneRenderTarget.depthTexture}get diffuseTexture(){return this._sceneRenderTarget&&this._sceneRenderTarget.texture}}class Nb extends Mb{constructor(){super(...arguments),__publicField(this,"isMRTSceneRendering",!0)}_init(){const e=this._rendering,t=e.resolution,i=e.main.requirements;let n=1,s={},o="";i.needsEmissiveTexture&&(s.emissive=n,o+=`#define MVT_MRT_OUT_EMISSIVE ${n}\n`,n++),(i.needsNormalTextureWhenMRT||i.needsNormalTexture)&&(s.normal=n,o+=`#define MVT_MRT_OUT_NORMAL ${n}\n`,n++),i.needsMetallicRoughTexture&&(s.metallicRough=n,o+=`#define MVT_MRT_OUT_METALLICROUGH ${n}\n`,n++),this._textureChannelNameMap=s,o+="#include <mvt_mrt_output_pars_fragment>\n",this._fragBeforeMainStart=o,this._fragBeforeMainEnd="#include <mvt_mrt_output_fragment>\n";const r=this._mainMrt=new Ot(t.x*e.pixelRatio,t.y*e.pixelRatio,n,{samples:e.features.antialias.samples}),a=this._tDepth=new ta;a.generateMipmaps=!1,i.enableStencilBuffer&&(a.format=j,a.type=O,r.stencilBuffer=!0),r.depthTexture=a,r.depthBuffer=!0;for(let l=0,g=r.texture.length;l<g;l++)r.texture[l].minFilter=T,r.texture[l].magFilter=T,r.texture[l].format=U;r.texture.isTexture=!0,this._fsQuad||(this._fsQuad=new wm(new ls({name:Sm.name,vertexShader:Sm.vertexShader,fragmentShader:Sm.fragmentShader,uniforms:{tDiffuse:{value:r.texture[0]},opacity:{value:1}}})))}render(){const e=this._rendering,t=e.stats,i=e.renderer,n=e.main.requirements;i.extraProgramCacheKey="mrt-"+n.currentTextureRequirementsKey+n.currentShaderKey,i.setRenderTarget(this._mainMrt),t.beginTimeStatsItem("renderMRTScene"),i.render(e.scene,e.camera),t.endTimeStatsItem("renderMRTScene"),i.extraProgramCacheKey="",i.setRenderTarget(this.renderTarget),this._fsQuad.render(i)}updateRenderTargetSamples(e){this._mainMrt.samples=e}modifyFragmentShader(e){return Yp(e,this._fragBeforeMainStart,null,this._fragBeforeMainEnd)}dispose(){this._rendering.stats.removeTimeStatsItem("renderMRTScene"),this._tDepth&&(this._tDepth.dispose(),this._tDepth=null),this._mainMrt&&(this._mainMrt.dispose(),this._mainMrt=null),this._fsQuad&&(this._fsQuad.dispose(),this._fsQuad=null)}setSize(e,t){const i=this._rendering,n=this._mainMrt;n&&n.setSize(e*i.pixelRatio,t*i.pixelRatio)}get emissiveTexture(){return this._mainMrt&&this._mainMrt.texture[this._textureChannelNameMap.emissive]}get normalTexture(){return this._mainMrt&&this._mainMrt.texture[this._textureChannelNameMap.normal]}get metallicRoughTexture(){return this._mainMrt&&this._mainMrt.texture[this._textureChannelNameMap.metallicRough]}get depthTexture(){return this._tDepth}get diffuseTexture(){return this._mainMrt&&this._mainMrt.texture[0]}get highPDepthTexture(){return this._mainMrt&&this._mainMrt.texture[this._textureChannelNameMap.depth]}}class Fb{constructor(e){__publicField(this,"needsEmissiveTexture",!1),__publicField(this,"needsNormalTexture",!1),__publicField(this,"needsNormalTextureWhenMRT",!1),__publicField(this,"needsDepthTexture",!1),__publicField(this,"needsMetallicRoughTexture",!1),__publicField(this,"enableStencilBuffer",!1),__publicField(this,"enableRenderingJitter",!1),__publicField(this,"needsFloatRenderTarget",!1),__publicField(this,"_lastNeedsFloatRenderTarget",null),__publicField(this,"_lastTextureRequirementsKey",-1),__publicField(this,"_currentTextureRequirementsKey",-1),__publicField(this,"featuresShaderKey",""),this._rendering=e,this._renderingMain=e.main}beginFrame(){this._resetTextureRequirements(),this._updateRequirements(),this._currentTextureRequirementsKey=this._updateTextureRequirementsKey()}_updateRequirements(){const e=this._renderingMain,t=e.features,i=e.postprocessings;this._rendering.useHighPrecisionBuffer&&(this.needsFloatRenderTarget=!0),t.updateReqirements(this),i.updateReqirements(this)}_resetTextureRequirements(){this.needsEmissiveTexture=!1,this.needsNormalTexture=!1,this.needsNormalTextureWhenMRT=!1,this.needsDepthTexture=!1,this.needsMetallicRoughTexture=!1,this.enableStencilBuffer=!0,this.enableRenderingJitter=!1,this.needsFloatRenderTarget=!1}_updateTextureRequirementsKey(){let e=0;return this.needsEmissiveTexture&&(e|=1),this.needsNormalTexture&&(e|=2),this.needsDepthTexture&&(e|=4),this.needsMetallicRoughTexture&&(e|=8),this.enableStencilBuffer&&(e|=16),e}isTextureRequirementsChanged(){return this._lastTextureRequirementsKey!==this._currentTextureRequirementsKey}isRenderTargetTypeChanged(){return this._lastNeedsFloatRenderTarget!==this.needsFloatRenderTarget}getRenderTargetType(){return this.needsFloatRenderTarget?Y:F}endFrame(){this._lastTextureRequirementsKey=this._currentTextureRequirementsKey,this._lastNeedsFloatRenderTarget=this.needsFloatRenderTarget}get currentTextureRequirementsKey(){return this._currentTextureRequirementsKey}get currentShaderKey(){return this.featuresShaderKey}}class Xb extends vm{constructor(e,t){super(),this.textureID=void 0!==t?t:"tDiffuse",e instanceof ls?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=as.clone(e.uniforms),this.material=new ls({name:void 0!==e.name?e.name:"unspecified",defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.fsQuad=new wm(this.material)}render(e,t,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}const Hb={name:"OutputShader",uniforms:{tDiffuse:{value:null},toneMappingExposure:{value:1}},vertexShader:"\n\t\tprecision highp float;\n\n\t\tuniform mat4 modelViewMatrix;\n\t\tuniform mat4 projectionMatrix;\n\n\t\tattribute vec3 position;\n\t\tattribute vec2 uv;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\t\n\t\tprecision highp float;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\t#include <tonemapping_pars_fragment>\n\t\t#include <colorspace_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tgl_FragColor = texture2D( tDiffuse, vUv );\n\n\t\t\t// tone mapping\n\n\t\t\t#ifdef LINEAR_TONE_MAPPING\n\n\t\t\t\tgl_FragColor.rgb = LinearToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( REINHARD_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = ReinhardToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( CINEON_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = OptimizedCineonToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( ACES_FILMIC_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = ACESFilmicToneMapping( gl_FragColor.rgb );\n\n\t\t\t#endif\n\n\t\t\t// color space\n\n\t\t\t#ifdef SRGB_TRANSFER\n\n\t\t\t\tgl_FragColor = sRGBTransferOETF( gl_FragColor );\n\n\t\t\t#endif\n\n\t\t}"};class zb extends vm{constructor(){super();const e=Hb;this.uniforms=as.clone(e.uniforms),this.material=new ul({name:e.name,uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader}),this.fsQuad=new wm(this.material),this._outputColorSpace=null,this._toneMapping=null}render(e,t,i){this.uniforms.tDiffuse.value=i.texture,this.uniforms.toneMappingExposure.value=e.toneMappingExposure,this._outputColorSpace===e.outputColorSpace&&this._toneMapping===e.toneMapping||(this._outputColorSpace=e.outputColorSpace,this._toneMapping=e.toneMapping,this.material.defines={},Zt.getTransfer(this._outputColorSpace)===Qe&&(this.material.defines.SRGB_TRANSFER=""),this._toneMapping===C?this.material.defines.LINEAR_TONE_MAPPING="":this._toneMapping===f?this.material.defines.REINHARD_TONE_MAPPING="":this._toneMapping===b?this.material.defines.CINEON_TONE_MAPPING="":this._toneMapping===y&&(this.material.defines.ACES_FILMIC_TONE_MAPPING=""),this.material.needsUpdate=!0),!0===this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}class Lb extends vm{constructor(e){super(),this.name="UIPass",this.needsSwap=!1,this.rendering=e,this.camera=e.camera,this._outputColorSpace=null,this._toneMapping=null,this._uiScene=null,this.material=new ls(Sm),this.material.name="UIPassCopyShader",this.fsQuad=new wm(this.material)}render(e,t,i){const n=this._uiScene=this.rendering.uiScene;n.visible=!0,e.setRenderTarget(i),this._outputColorSpace===e.outputColorSpace&&this._toneMapping===e.toneMapping||(this._outputColorSpace=e.outputColorSpace,this._toneMapping=e.toneMapping,n.traverse((e=>{const t=e.material;t&&(Zt.getTransfer(this._outputColorSpace)===Qe&&(t.uniforms.srgbTransformer={value:!0}),this._toneMapping===C?t.uniforms.isLinearToneMapping={value:!0}:this._toneMapping===f?t.uniforms.isReinhardToneMapping={value:!0}:this._toneMapping===b?t.uniforms.isCineonToneMapping={value:!0}:this._toneMapping===y&&(t.uniforms.isACESFilmicToneMapping={value:!0}))}))),e.autoClear=!1,e.render(n,this.camera),e.autoClear=!0,!0===this.renderToScreen&&(e.setRenderTarget(null),this.material.uniforms.tDiffuse.value=i.texture,this.fsQuad.render(e)),n.visible=!1}dispose(){this.material.dispose(),this.material=null,this.fsQuad.dispose(),this.fsQuad=null}}class Db{constructor(e){__publicField(this,"_postprocessings",[]),__publicField(this,"_validCount",0),__publicField(this,"_composer",null),__publicField(this,"_outputPass",null),__publicField(this,"_samples",0),this._rendering=e}setSize(e,t){this._composer&&this._composer.setSize(e,t);for(const i of this._postprocessings)i.setSize&&i.setSize(e,t)}beginFrame(){if(this._outputPass||(this._outputPass=new zb,this._outputPass.renderOrder=200,this.add(this._outputPass)),!this._uiPass){const e=this._uiPass=new Lb(this._rendering);e.material.transparent=!0,e.renderOrder=3e3,this.add(e)}const e=this._rendering.uiScene.children.length>0;this._uiPass.enabled=e,this._updatePostprocessings()}_updatePostprocessings(){let e=0;for(let t=0,i=this._postprocessings.length;t<i;t++){this._postprocessings[t].enabled&&e++}this._validCount=e}add(e){-1===this._postprocessings.indexOf(e)&&(e.rendering=this._rendering,this._postprocessings.push(e)),this._postprocessings.sort(((e,t)=>(e.renderOrder||0)-(t.renderOrder||0)))}remove(e){const t=this._postprocessings.indexOf(e);-1!==t&&this._postprocessings.splice(t,1)}render(){if(this._validCount<=0)return;const e=this._rendering,t=e.sharedFullScreenRenderTargets,i=e.stats;i.beginTimeStatsItem("postprocessingRender");let n=e.renderer.getRenderTarget(),s=t.getAvailableRenderTarget();const o=e.renderState.deltaTime/1e3;let r=this._validCount-1,a=0;for(let l=0,g=this._postprocessings.length;l<g;l++){const t=this._postprocessings[l];if(t.enabled){if(t.renderToScreen=r===a,t.render(e.renderer,s,n,o),t.needsSwap&&r!==a){let e=n;n=s,s=e}a++}}t.releaseRenderTarget(n),i.endTimeStatsItem("postprocessingRender")}updateReqirements(e){for(const t of this._postprocessings)t.enabled&&(t.needsEmissiveTexture&&(e.needsEmissiveTexture=!0),t.needsNormalTexture&&(e.needsNormalTexture=!0),t.needsNormalTextureWhenMRT&&(e.needsNormalTextureWhenMRT=!0),t.needsDepthTexture&&(e.needsDepthTexture=!0),t.needsMetallicRoughTexture&&(e.needsMetallicRoughTexture=!0),t.enableStencilBuffer&&(e.enableStencilBuffer=!0),t.enableRenderingJitter&&(e.enableRenderingJitter=!0))}endFrame(){}dispose(){this._postprocessingRenderTarget1&&(this._postprocessingRenderTarget1.dispose(),this._postprocessingRenderTarget1=null)}get renderTarget1(){return this._postprocessingRenderTarget1}get validCount(){return this._validCount}get postprocessings(){return this._postprocessings}}class Kb extends Db{constructor(e){super(e),__publicField(this,"_handleMeshBeforeRender",((e,t,i)=>{if(10!==this._rendering.renderState.stage)return;if(this._validCount<=0)return;const n=this._rendering.sharedFullScreenRenderTargets;let s=e.getRenderTarget();const o=s;this._updateMultisampleRenderTarget(e,s);let r=n.getAvailableRenderTarget();const a=r;let l=null;const g=this._postprocessings;let c=this._validCount-1,d=0;for(let h=0,u=g.length;h<u;h++){const t=g[h];if(t.enabled){if(t.render(e,r,s),c!==d&&t.needsSwap)if(s===o)s=r,r=n.getAvailableRenderTarget(),l=r;else{let e=s;s=r,r=e}d++}}this._mesh.material.uniforms.tDiffuse.value=r.texture,n.releaseRenderTarget(a),l&&n.releaseRenderTarget(l),e.setRenderTarget(o)})),this._postprocessings=[],this._testRenderTarget=new Yt(1,1,{}),this._testScene=new ts(new ns(1,1,1),new Cn({})),this._testScene.frustumCulled=!1}beginFrame(){if(this._updatePostprocessings(),this._rendering,this._validCount>0){if(!this._mesh){const e=this._geometry=new Fn;e.setAttribute("position",new Mn([-1,3,0,-1,-1,0,3,-1,0],3)),e.setAttribute("uv",new Mn([0,2,0,0,2,0],2));const t=this._material=new ls({depthTest:!1,name:"OpaquePostprocessingsCopy",uniforms:{tDiffuse:{value:null}},vertexShader:"\n                        varying vec2 vUv;\n                        void main() {\n                            vUv = uv;\n                            gl_Position = vec4(position, 1.0);\n                        }\n                    ",fragmentShader:"\n                        uniform sampler2D tDiffuse;\n                        varying vec2 vUv;\n\n                        void main() {\n                            vec4 color = texture2D(tDiffuse, vUv);\n                            gl_FragColor = color;\n                            // gl_FragColor = vec4(1.0, .0, .0, 1.0);\n                        }\n                    "}),i=this._mesh=new ts(e,t);i.isFSQuad=!0,i.frustumCulled=!1,i.renderOrder=1e9,i.onBeforeRender=this._handleMeshBeforeRender,this._rendering.add(i)}this._mesh.visible=!0}else this._mesh&&(this._mesh.visible=!1)}add(e){super.add(e);const t=e.material;t.defines?t.defines.USE_OPAQUE_POST_STAGE=!0:t.defines={USE_OPAQUE_POST_STAGE:!0},t.needsUpdate=!0}_useMultisampledRTT(e,t){const i=e.properties,n=e.extensions,s=e.capabilities.isWebGL2,o=i.get(t);return s&&t.samples>0&&!0===n.has("WEBGL_multisampled_render_to_texture")&&!1!==o.__useRenderToTexture}_updateMultisampleRenderTarget(e,t){if(e.capabilities.isWebGL2&&t.samples>0&&!1===this._useMultisampledRTT(e,t)){const i=e.getContext(),n=e.state,s=e.properties,o=t.isWebGLMultipleRenderTargets?t.texture:[t.texture],r=t.width,a=t.height;let l=i.COLOR_BUFFER_BIT;const g=[],c=t.stencilBuffer?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT,d=s.get(t),h=!0===t.isWebGLMultipleRenderTargets;if(h)for(let e=0;e<o.length;e++)n.bindFramebuffer(i.FRAMEBUFFER,d.__webglMultisampledFramebuffer),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+e,i.RENDERBUFFER,null),n.bindFramebuffer(i.FRAMEBUFFER,d.__webglFramebuffer),i.framebufferTexture2D(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0+e,i.TEXTURE_2D,null,0);n.bindFramebuffer(i.READ_FRAMEBUFFER,d.__webglMultisampledFramebuffer),n.bindFramebuffer(i.DRAW_FRAMEBUFFER,d.__webglFramebuffer);for(let e=0;e<o.length;e++){g.push(i.COLOR_ATTACHMENT0+e),t.depthBuffer&&g.push(c);const n=void 0!==d.__ignoreDepthValues&&d.__ignoreDepthValues;if(!1===n&&t.depthBuffer&&(l|=i.DEPTH_BUFFER_BIT),h&&i.framebufferRenderbuffer(i.READ_FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.RENDERBUFFER,d.__webglColorRenderbuffer[e]),!0===n&&(i.invalidateFramebuffer(i.READ_FRAMEBUFFER,[c]),i.invalidateFramebuffer(i.DRAW_FRAMEBUFFER,[c])),h){const t=s.get(o[e]).__webglTexture;i.framebufferTexture2D(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,t,0)}i.blitFramebuffer(0,0,r,a,0,0,r,a,l,i.NEAREST)}if(n.bindFramebuffer(i.READ_FRAMEBUFFER,null),n.bindFramebuffer(i.DRAW_FRAMEBUFFER,null),h)for(let e=0;e<o.length;e++){n.bindFramebuffer(i.FRAMEBUFFER,d.__webglMultisampledFramebuffer),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+e,i.RENDERBUFFER,d.__webglColorRenderbuffer[e]);const t=s.get(o[e]).__webglTexture;n.bindFramebuffer(i.FRAMEBUFFER,d.__webglFramebuffer),i.framebufferTexture2D(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0+e,i.TEXTURE_2D,t,0)}n.bindFramebuffer(i.DRAW_FRAMEBUFFER,d.__webglMultisampledFramebuffer)}}_updatePostprocessings(){let e=0;for(let t=0,i=this._postprocessings.length;t<i;t++){this._postprocessings[t].enabled&&e++}this._validCount=e}render(){}endFrame(){}setSize(e,t){}show(){this._mesh&&(this._mesh.visible=!0)}hide(){this._mesh&&(this._mesh.visible=!1)}dispose(){this._renderTarget&&(this._renderTarget.dispose(),this._renderTarget=null),this._mesh&&(this._rendering.remove(this._mesh),this._mesh.geometry.dispose(),this._mesh.material.dispose(),this._mesh=null)}}const Yb={name:"LuminosityHighPassShader",shaderID:"luminosityHighPass",uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new In(0)},defaultOpacity:{value:0}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform vec3 defaultColor;\n\t\tuniform float defaultOpacity;\n\t\tuniform float luminosityThreshold;\n\t\tuniform float smoothWidth;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\n\t\t\tvec3 luma = vec3( 0.299, 0.587, 0.114 );\n\n\t\t\tfloat v = dot( texel.xyz, luma );\n\n\t\t\tvec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );\n\n\t\t\tfloat alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );\n\n\t\t\tgl_FragColor = mix( outputColor, texel, alpha );\n\n\t\t}"};class Pb extends vm{constructor(e,t,i,n){super(),this.strength=void 0!==t?t:1,this.radius=i,this.threshold=n,this.resolution=void 0!==e?new bt(e.x,e.y):new bt(256,256),this.clearColor=new In(0,0,0),this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;let s=Math.round(this.resolution.x/2),o=Math.round(this.resolution.y/2);this.renderTargetBright=new Yt(s,o,{type:Y}),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(let g=0;g<this.nMips;g++){const e=new Yt(s,o,{type:Y});e.texture.name="UnrealBloomPass.h"+g,e.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(e);const t=new Yt(s,o,{type:Y});t.texture.name="UnrealBloomPass.v"+g,t.texture.generateMipmaps=!1,this.renderTargetsVertical.push(t),s=Math.round(s/2),o=Math.round(o/2)}const r=Yb;this.highPassUniforms=as.clone(r.uniforms),this.highPassUniforms.luminosityThreshold.value=n,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new ls({uniforms:this.highPassUniforms,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader}),this.separableBlurMaterials=[];const a=[3,5,7,9,11];s=Math.round(this.resolution.x/2),o=Math.round(this.resolution.y/2);for(let g=0;g<this.nMips;g++)this.separableBlurMaterials.push(this.getSeperableBlurMaterial(a[g])),this.separableBlurMaterials[g].uniforms.invSize.value=new bt(1/s,1/o),s=Math.round(s/2),o=Math.round(o/2);this.compositeMaterial=this.getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=t,this.compositeMaterial.uniforms.bloomRadius.value=.1;this.compositeMaterial.uniforms.bloomFactors.value=[1,.8,.6,.4,.2],this.bloomTintColors=[new Qt(1,1,1),new Qt(1,1,1),new Qt(1,1,1),new Qt(1,1,1),new Qt(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors;const l=Sm;this.copyUniforms=as.clone(l.uniforms),this.blendMaterial=new ls({uniforms:this.copyUniforms,vertexShader:l.vertexShader,fragmentShader:l.fragmentShader,blending:2,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this._oldClearColor=new In,this.oldClearAlpha=1,this.basic=new Cn,this.fsQuad=new wm(null)}dispose(){for(let e=0;e<this.renderTargetsHorizontal.length;e++)this.renderTargetsHorizontal[e].dispose();for(let e=0;e<this.renderTargetsVertical.length;e++)this.renderTargetsVertical[e].dispose();this.renderTargetBright.dispose();for(let e=0;e<this.separableBlurMaterials.length;e++)this.separableBlurMaterials[e].dispose();this.compositeMaterial.dispose(),this.blendMaterial.dispose(),this.basic.dispose(),this.fsQuad.dispose()}setSize(e,t){let i=Math.round(e/2),n=Math.round(t/2);this.renderTargetBright.setSize(i,n);for(let s=0;s<this.nMips;s++)this.renderTargetsHorizontal[s].setSize(i,n),this.renderTargetsVertical[s].setSize(i,n),this.separableBlurMaterials[s].uniforms.invSize.value=new bt(1/i,1/n),i=Math.round(i/2),n=Math.round(n/2)}render(e,t,i,n,s){e.getClearColor(this._oldClearColor),this.oldClearAlpha=e.getClearAlpha();const o=e.autoClear;e.autoClear=!1,e.setClearColor(this.clearColor,0),s&&e.state.buffers.stencil.setTest(!1),this.renderToScreen&&(this.fsQuad.material=this.basic,this.basic.map=i.texture,e.setRenderTarget(null),e.clear(),this.fsQuad.render(e)),this.highPassUniforms.tDiffuse.value=i.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this.fsQuad.material=this.materialHighPassFilter,e.setRenderTarget(this.renderTargetBright),e.clear(),this.fsQuad.render(e);let r=this.renderTargetBright;for(let a=0;a<this.nMips;a++)this.fsQuad.material=this.separableBlurMaterials[a],this.separableBlurMaterials[a].uniforms.colorTexture.value=r.texture,this.separableBlurMaterials[a].uniforms.direction.value=Pb.BlurDirectionX,e.setRenderTarget(this.renderTargetsHorizontal[a]),e.clear(),this.fsQuad.render(e),this.separableBlurMaterials[a].uniforms.colorTexture.value=this.renderTargetsHorizontal[a].texture,this.separableBlurMaterials[a].uniforms.direction.value=Pb.BlurDirectionY,e.setRenderTarget(this.renderTargetsVertical[a]),e.clear(),this.fsQuad.render(e),r=this.renderTargetsVertical[a];this.fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,e.setRenderTarget(this.renderTargetsHorizontal[0]),e.clear(),this.fsQuad.render(e),this.fsQuad.material=this.blendMaterial,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,s&&e.state.buffers.stencil.setTest(!0),this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(i),this.fsQuad.render(e)),e.setClearColor(this._oldClearColor,this.oldClearAlpha),e.autoClear=o}getSeperableBlurMaterial(e){const t=[];for(let i=0;i<e;i++)t.push(.39894*Math.exp(-.5*i*i/(e*e))/e);return new ls({defines:{KERNEL_RADIUS:e},uniforms:{colorTexture:{value:null},invSize:{value:new bt(.5,.5)},direction:{value:new bt(.5,.5)},gaussianCoefficients:{value:t}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform vec2 invSize;\n\t\t\t\tuniform vec2 direction;\n\t\t\t\tuniform float gaussianCoefficients[KERNEL_RADIUS];\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tfloat weightSum = gaussianCoefficients[0];\n\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv ).rgb * weightSum;\n\t\t\t\t\tfor( int i = 1; i < KERNEL_RADIUS; i ++ ) {\n\t\t\t\t\t\tfloat x = float(i);\n\t\t\t\t\t\tfloat w = gaussianCoefficients[i];\n\t\t\t\t\t\tvec2 uvOffset = direction * invSize * x;\n\t\t\t\t\t\tvec3 sample1 = texture2D( colorTexture, vUv + uvOffset ).rgb;\n\t\t\t\t\t\tvec3 sample2 = texture2D( colorTexture, vUv - uvOffset ).rgb;\n\t\t\t\t\t\tdiffuseSum += (sample1 + sample2) * w;\n\t\t\t\t\t\tweightSum += 2.0 * w;\n\t\t\t\t\t}\n\t\t\t\t\tgl_FragColor = vec4(diffuseSum/weightSum, 1.0);\n\t\t\t\t}"})}getCompositeMaterial(e){return new ls({defines:{NUM_MIPS:e},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\n\t\t\t\tuniform sampler2D blurTexture1;\n\t\t\t\tuniform sampler2D blurTexture2;\n\t\t\t\tuniform sampler2D blurTexture3;\n\t\t\t\tuniform sampler2D blurTexture4;\n\t\t\t\tuniform sampler2D blurTexture5;\n\t\t\t\tuniform float bloomStrength;\n\t\t\t\tuniform float bloomRadius;\n\t\t\t\tuniform float bloomFactors[NUM_MIPS];\n\t\t\t\tuniform vec3 bloomTintColors[NUM_MIPS];\n\n\t\t\t\tfloat lerpBloomFactor(const in float factor) {\n\t\t\t\t\tfloat mirrorFactor = 1.2 - factor;\n\t\t\t\t\treturn mix(factor, mirrorFactor, bloomRadius);\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tgl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );\n\t\t\t\t}"})}}Pb.BlurDirectionX=new bt(1,0),Pb.BlurDirectionY=new bt(0,1);class kb{constructor(e,t={}){__publicField(this,"_enabled",!1),__publicField(this,"name",""),__publicField(this,"needsShaderKey",!1),this._options=t,this._enabled=!!t.enabled,this._rendering=e}beginFrame(){}render(){}endFrame(){}getCurrentShaderKey(){return""}get enabled(){return this._enabled}set enabled(e){this._enabled=!!e}}class Ob extends kb{constructor(){super(...arguments),__publicField(this,"name","bloom"),__publicField(this,"_lastEnabled",!1),__publicField(this,"_strength",.1),__publicField(this,"_threshold",1),__publicField(this,"_radius",0),__publicField(this,"needsFloatRenderTarget",!0)}beginFrame(){this._lastEnabled===this.enabled?this.enabled:this.enabled?this._init():this.dispose()}_init(){const e=this._rendering,t=e.resolution,i=e.main,n=e.pixelRatio;this._bloomRenderTarget=new Yt(t.x*n,t.y*n,{type:Y}),this._bloomRenderTarget.name="bloomRenderTarget";const s=new bt;s.set(t.x*n,t.y*n);const o=this._bloomRenderPass=new Pb(s,this._strength,this._radius,this._threshold);o.renderOrder=70,i.postprocessings.add(o),i.useMRT}afterRender(){if(this.enabled){const e=this._rendering;e.main,e.stats}}getCurrentUsedTextures(){if(this.enabled)return[this._bloomRenderTarget.texture]}endFrame(){this._lastEnabled=this.enabled}dispose(){if(this._rendering.stats,this._bloomRenderPass){this._rendering.main.postprocessings.remove(this._bloomRenderPass),this._bloomRenderPass.dispose(),this._bloomRenderPass=null}}get strength(){return this._strength}set strength(e){this._strength=e,this._bloomRenderPass&&(this._bloomRenderPass.strength=e)}get radius(){return this._radius}set radius(e){this._radius=e,this._bloomRenderPass&&(this._bloomRenderPass.radius=e)}get threshold(){return this._threshold}set threshold(e){this._threshold=e,this._bloomRenderPass&&(this._bloomRenderPass.threshold=e)}}class Ub extends vm{constructor(){super();const e=Sm;this.uniforms={tDiffuse:{value:null},textureInfos:{value:null},maps:{value:null}},this._lastTextureCount=1,this.material=new ls({defines:{MVT_TEXTURE_COUNT:1},uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:"\nstruct TextureInfo {\n    vec2 offset;\n    vec2 scale;\n};\nuniform sampler2D maps[MVT_TEXTURE_COUNT];\nuniform sampler2D tDiffuse;\nvarying vec2 vUv;\n\nuniform TextureInfo textureInfos[MVT_TEXTURE_COUNT];\n\nvoid addTextureColor(sampler2D map, TextureInfo textureInfo) {\n    vec2 transformedUv = (vUv - textureInfo.offset) * textureInfo.scale;\n    if (transformedUv.x >= 0.0 && transformedUv.x <= 1.0 && transformedUv.y >= 0.0 && transformedUv.y <= 1.0) {\n        // gl_FragColor += texture2D(map, transformedUv);\n        vec4 sampleColor = texture2D(map, transformedUv);\n        gl_FragColor.rgb = mix(sampleColor.rgb, gl_FragColor.rgb, 1.0 - sampleColor.a);\n        gl_FragColor.a += sampleColor.a;\n        // gl_FragColor = sampleColor + gl_FragColor;\n    }\n}\nvoid main() {\n\n    gl_FragColor = texture2D(tDiffuse, vUv);\n    // gl_FragColor = vec4(0.5, 0, 0, 0.5);\n    #if MVT_TEXTURE_COUNT > 0\n        addTextureColor(maps[0], textureInfos[0]);\n    #endif\n\n    #if MVT_TEXTURE_COUNT > 1\n        addTextureColor(maps[1], textureInfos[1]);\n    #endif\n\n    #if MVT_TEXTURE_COUNT > 2\n        addTextureColor(maps[2], textureInfos[2]);\n    #endif\n\n    #if MVT_TEXTURE_COUNT > 3\n        addTextureColor(maps[3], textureInfos[3]);\n    #endif\n\n    #if MVT_TEXTURE_COUNT > 4\n        addTextureColor(maps[4], textureInfos[4]);\n    #endif\n\n    #if MVT_TEXTURE_COUNT > 5\n        addTextureColor(maps[5], textureInfos[5]);\n    #endif\n\n    #if MVT_TEXTURE_COUNT > 6\n        addTextureColor(maps[6], textureInfos[6]);\n    #endif\n\n    #if MVT_TEXTURE_COUNT > 7\n        addTextureColor(maps[7], textureInfos[7]);\n    #endif\n\n    #if MVT_TEXTURE_COUNT > 8\n        addTextureColor(maps[8], textureInfos[8]);\n    #endif\n}\n",depthTest:!1,depthWrite:!1}),this.needsSwap=!0,this.fsQuad=new wm(null)}render(e,t,i){const n=e.autoClear;e.autoClear=!1,this.fsQuad.material=this.material,this.material.uniforms.tDiffuse.value=i.texture,e.setRenderTarget(this.renderToScreen?null:t),e.clear(),this.fsQuad.render(e),e.autoClear=n}updateTextures(e,t){e.length===t.length?(this.uniforms.maps.value=e,this.uniforms.textureInfos.value=t,this._lastTextureCount!==t.length&&(this.material.defines.MVT_TEXTURE_COUNT=t.length,this.material.needsUpdate=!0,this._lastTextureCount=t.length)):console.warn("textures and infos length must be equal")}dispose(){this.material.dispose(),this.fsQuad.dispose()}}class Qb extends kb{constructor(){super(...arguments),__publicField(this,"name","stats"),__publicField(this,"_lastEnabled",!1),__publicField(this,"_canvasWidth",600),__publicField(this,"_canvasHeight",320),__publicField(this,"_canvasPadding",10),__publicField(this,"_lastUpdateTime",0)}beginFrame(){this._lastEnabled===this.enabled?this.enabled&&this._updateTexture():this.enabled?this._init():this.dispose()}_init(){const e=this._rendering,t=e.pixelRatio,i=this._canvas=document.createElement("canvas");this._context=i.getContext("2d"),i.width=this._canvasWidth*t,i.height=this._canvasHeight*t,this._texture=new il(i),this._texture.generateMipmaps=!1;const n=this._renderPass=new Ub;n.renderOrder=10100,n.material.uniforms.textureInfos.value=[{offset:[.2,.2],scale:[2.5,2.5]}],n.material.uniforms.maps.value=[this._texture],e.main.postprocessings.add(this._renderPass)}_updateTexture(){const e=this._rendering,t=e.renderState;if(t.time-this._lastUpdateTime<100)return;this._lastUpdateTime=t.time;const i=e.renderer,n=e.stats,s=this._context,o=e.pixelRatio;n.beginTimeStatsItem("updateStatsTexture"),s.save(),s.scale(o,o),s.clearRect(0,0,this._canvasWidth,this._canvasHeight),s.fillStyle="rgba(0, 0, 0, .6)",s.fillRect(0,0,this._canvasWidth,this._canvasHeight),s.font="14px sans-serif",s.textAlign="right",s.fillStyle="rgb(220,220,220)";const r=n.getSortedTimeStatsItems(),a=Math.min(r.length,10);let l=this._canvasPadding+100,g=this._canvasPadding+20;s.fillText("average",l+150,g),s.fillText("lastValue",l+230,g),s.fillText("count",l+310,g),s.fillText("total",l+450,g),s.strokeStyle="rgb(130,130,130)";for(let p=0;p<a;p++){l=this._canvasPadding+100,g=this._canvasPadding+50+20*p;const e=r[p];s.fillText(e.name,l+50,g),s.fillText(e.average.toFixed(2),l+150,g),s.fillText(e.lastValue.toFixed(2),l+230,g),s.fillText(e.count.toFixed(0),l+310,g),s.fillText(e.total.toFixed(2),l+450,g),g+=5,s.beginPath(),s.moveTo(this._canvasPadding,g),s.lineTo(this._canvasWidth-this._canvasPadding,g),s.stroke()}const c=i.info;s.font="13px sans-serif",s.textAlign="left",l=this._canvasPadding,g=270,s.fillText("frame: "+c.render.frame,l,g),l+=160,s.fillText("calls: "+c.render.calls,l,g),l+=160,s.fillText("triangles: "+c.render.triangles,l,g),l+=160,s.fillText("points: "+c.render.points,l,g),l=this._canvasPadding,g+=20,s.fillText("lines: "+c.render.lines,l,g),l+=160,s.fillText("geometries: "+c.memory.geometries,l,g),l+=160,s.fillText("textures: "+c.memory.textures,l,g),l+=160,s.fillText("programs: "+c.programs.length,l,g),l=this._canvasPadding,g+=20,s.fillText("postprocessing: "+e.main.postprocessings.validCount,l,g);const d=e.main.features.features;let h="";for(const p of d)p.enabled&&(h+=p.name+" ");l+=160,s.fillText("features: "+h,l,g),l+=160,s.fillText("tasks: "+e.taskScheduler.taskCount,l,g),s.restore(),n.endTimeStatsItem("updateStatsTexture"),this._texture.needsUpdate=!0;const u=e.resolution,I=this._renderPass;I.material.uniforms.textureInfos.value[0].offset=[.5-this._canvasWidth/2/u.x,.5-this._canvasHeight/2/u.y],I.material.uniforms.textureInfos.value[0].scale=[1/(this._canvasWidth/u.x),1/(this._canvasHeight/u.y)]}afterRender(){}endFrame(){this._lastEnabled=this.enabled}dispose(){const e=this._rendering;e.stats.removeTimeStatsItem("updateStatsTexture"),e.main.postprocessings.remove(this._renderPass),this._renderPass&&this._renderPass.dispose(),this._texture&&this._texture.dispose()}}const Jb=new ls({uniforms:{numFrames:{value:0},tLastFrame:{value:null},height:{value:1},width:{value:1},tDiffuse:{value:null},opacity:{value:1}},transparent:!0,blending:2,depthTest:!1,depthWrite:!1,vertexShader:"\n    varying vec2 Uv;\n\n    void main() {\n        Uv = uv;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    }",fragmentShader:"\n    // uniform float opacity;\n    uniform float numFrames;\n    uniform float height;\n    uniform float width;\n    uniform sampler2D tDiffuse;\n    // uniform sampler2D tMotion;\n    uniform sampler2D tLastFrame;\n    varying vec2 Uv;\n\n    void main() {\n        vec4 texel = texture2D(tDiffuse, Uv);\n        // vec4 pixelMovement = texture2D(tMotion, Uv);\n        // vec2 oldPixelUv = Uv - ((pixelMovement.xy * 2.0) - 1.0);\n        vec4 oldTexel = texture2D(tLastFrame, Uv);\n\n        // Use simple neighbor clamping\n        vec4 maxNeighbor = vec4(0.0, 0.0, 0.0, 1.0);\n        vec4 minNeighbor = vec4(1.0);\n        vec4 average = vec4(0.0);\n\n        for (int x = -1; x <= 1; x++) {\n            for (int y = -1; y <= 1; y++) {\n                vec2 neighborUv = Uv + vec2(float(x) / width, float(y) / height);\n                vec4 neighborTexel = texture2D(tDiffuse, neighborUv);\n\n                maxNeighbor = max(maxNeighbor, neighborTexel);\n                minNeighbor = min(minNeighbor, neighborTexel);\n                average += neighborTexel / 9.0;\n            }\n        }\n\n\n        oldTexel = clamp(oldTexel, minNeighbor, maxNeighbor);\n\n        // UE Method to get rid of flickering. Weight frame mixing amount\n        // based on local contrast.\n        float contrast = distance(average, texel);\n        // # fix float type color range\n        contrast = clamp(contrast, 0.0, 0.1);\n        float weight = 0.1 * contrast;\n        vec4 compositeColor = mix(oldTexel, texel, weight);\n\n        gl_FragColor = compositeColor;\n    }"});class jb extends vm{constructor(){super(),__publicField(this,"enableRenderingJitter",!0),__publicField(this,"getCurrentUsedTextures",(()=>{const e=[];return this._scratchBuffer&&e.push(this._scratchBuffer.texture),this._oldFrameTarget&&e.push(this._oldFrameTarget.texture),e}));const e=Sm;this._oldClearColor=new In,this.uniforms={tDiffuse:{value:null},opacity:{value:1}},this._reprojectionMaterial=Jb.clone(),this.material=new ls({uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,depthTest:!1,depthWrite:!1}),this.needsSwap=!0,this.fsQuad=new wm(null),this._isFirstFrame=!0}render(e,t,i){const n=this.rendering.resolution,s=this.rendering.pixelRatio,o=this.rendering.renderState,r=e.autoClear;e.autoClear=!1;let a=null;this._oldFrameTarget||(this._oldFrameTarget=new Yt(n.x*s,n.y*s,{})),o.viewChanged||this._isFirstFrame||this._debugEngineForceRender?(a=this.material.uniforms,a.tDiffuse.value=i.texture,a.opacity.value=1,this.fsQuad.material=this.material,e.setRenderTarget(this._oldFrameTarget),e.clear(),this.fsQuad.render(e)):(this._scratchBuffer||(this._scratchBuffer=new Yt(n.x*s,n.y*s,{})),a=this._reprojectionMaterial.uniforms,a.tLastFrame.value=this._oldFrameTarget.texture,a.height.value=i.height,a.width.value=i.width,a.tDiffuse.value=i.texture,this.fsQuad.material=this._reprojectionMaterial,e.setRenderTarget(this._scratchBuffer),e.clear(),this.fsQuad.render(e),a=this.material.uniforms,a.tDiffuse.value=this._scratchBuffer.texture,a.opacity.value=1,this.fsQuad.material=this.material,e.setRenderTarget(this._oldFrameTarget),e.clear(),this.fsQuad.render(e),o.viewStableFrameCount<32&&this.rendering.requestRender()),a=this.material.uniforms,a.tDiffuse.value=o.viewChanged?i.texture:this._oldFrameTarget.texture,a.opacity.value=1,this.fsQuad.material=this.material,e.setRenderTarget(this.renderToScreen?null:t),e.clear(),this.fsQuad.render(e),e.autoClear=r,this._isFirstFrame=!1}dispose(){this._reprojectionMaterial.dispose(),this.material.dispose(),this.fsQuad.dispose(),this._scratchBuffer&&this._scratchBuffer.dispose(),this._oldFrameTarget&&this._oldFrameTarget.dispose()}}const qb={name:"FXAAShader",uniforms:{tDiffuse:{value:null},resolution:{value:new bt(1/1024,1/512)}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\tprecision highp float;\n\n\tuniform sampler2D tDiffuse;\n\n\tuniform vec2 resolution;\n\n\tvarying vec2 vUv;\n\n\t// FXAA 3.11 implementation by NVIDIA, ported to WebGL by Agost Biro (biro@archilogic.com)\n\n\t//----------------------------------------------------------------------------------\n\t// File:        es3-keplerFXAAassetsshaders/FXAA_DefaultES.frag\n\t// SDK Version: v3.00\n\t// Email:       gameworks@nvidia.com\n\t// Site:        http://developer.nvidia.com/\n\t//\n\t// Copyright (c) 2014-2015, NVIDIA CORPORATION. All rights reserved.\n\t//\n\t// Redistribution and use in source and binary forms, with or without\n\t// modification, are permitted provided that the following conditions\n\t// are met:\n\t//  * Redistributions of source code must retain the above copyright\n\t//    notice, this list of conditions and the following disclaimer.\n\t//  * Redistributions in binary form must reproduce the above copyright\n\t//    notice, this list of conditions and the following disclaimer in the\n\t//    documentation and/or other materials provided with the distribution.\n\t//  * Neither the name of NVIDIA CORPORATION nor the names of its\n\t//    contributors may be used to endorse or promote products derived\n\t//    from this software without specific prior written permission.\n\t//\n\t// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ''AS IS'' AND ANY\n\t// EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\n\t// IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR\n\t// PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR\n\t// CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,\n\t// EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,\n\t// PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n\t// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY\n\t// OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n\t// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n\t// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n\t//\n\t//----------------------------------------------------------------------------------\n\n\t#ifndef FXAA_DISCARD\n\t\t\t//\n\t\t\t// Only valid for PC OpenGL currently.\n\t\t\t// Probably will not work when FXAA_GREEN_AS_LUMA = 1.\n\t\t\t//\n\t\t\t// 1 = Use discard on pixels which don't need AA.\n\t\t\t//     For APIs which enable concurrent TEX+ROP from same surface.\n\t\t\t// 0 = Return unchanged color on pixels which don't need AA.\n\t\t\t//\n\t\t\t#define FXAA_DISCARD 0\n\t#endif\n\n\t/*--------------------------------------------------------------------------*/\n\t#define FxaaTexTop(t, p) texture2D(t, p, -100.0)\n\t#define FxaaTexOff(t, p, o, r) texture2D(t, p + (o * r), -100.0)\n\t/*--------------------------------------------------------------------------*/\n\n\t#define NUM_SAMPLES 5\n\n\t// assumes colors have premultipliedAlpha, so that the calculated color contrast is scaled by alpha\n\tfloat contrast( vec4 a, vec4 b ) {\n\t\t\tvec4 diff = abs( a - b );\n\t\t\treturn max( max( max( diff.r, diff.g ), diff.b ), diff.a );\n\t}\n\n\t/*============================================================================\n\n\t\t\t\t\t\t\t\t\tFXAA3 QUALITY - PC\n\n\t============================================================================*/\n\n\t/*--------------------------------------------------------------------------*/\n\tvec4 FxaaPixelShader(\n\t\t\tvec2 posM,\n\t\t\tsampler2D tex,\n\t\t\tvec2 fxaaQualityRcpFrame,\n\t\t\tfloat fxaaQualityEdgeThreshold,\n\t\t\tfloat fxaaQualityinvEdgeThreshold\n\t) {\n\t\t\tvec4 rgbaM = FxaaTexTop(tex, posM);\n\t\t\tvec4 rgbaS = FxaaTexOff(tex, posM, vec2( 0.0, 1.0), fxaaQualityRcpFrame.xy);\n\t\t\tvec4 rgbaE = FxaaTexOff(tex, posM, vec2( 1.0, 0.0), fxaaQualityRcpFrame.xy);\n\t\t\tvec4 rgbaN = FxaaTexOff(tex, posM, vec2( 0.0,-1.0), fxaaQualityRcpFrame.xy);\n\t\t\tvec4 rgbaW = FxaaTexOff(tex, posM, vec2(-1.0, 0.0), fxaaQualityRcpFrame.xy);\n\t\t\t// . S .\n\t\t\t// W M E\n\t\t\t// . N .\n\n\t\t\tbool earlyExit = max( max( max(\n\t\t\t\t\tcontrast( rgbaM, rgbaN ),\n\t\t\t\t\tcontrast( rgbaM, rgbaS ) ),\n\t\t\t\t\tcontrast( rgbaM, rgbaE ) ),\n\t\t\t\t\tcontrast( rgbaM, rgbaW ) )\n\t\t\t\t\t< fxaaQualityEdgeThreshold;\n\t\t\t// . 0 .\n\t\t\t// 0 0 0\n\t\t\t// . 0 .\n\n\t\t\t#if (FXAA_DISCARD == 1)\n\t\t\t\t\tif(earlyExit) FxaaDiscard;\n\t\t\t#else\n\t\t\t\t\tif(earlyExit) return rgbaM;\n\t\t\t#endif\n\n\t\t\tfloat contrastN = contrast( rgbaM, rgbaN );\n\t\t\tfloat contrastS = contrast( rgbaM, rgbaS );\n\t\t\tfloat contrastE = contrast( rgbaM, rgbaE );\n\t\t\tfloat contrastW = contrast( rgbaM, rgbaW );\n\n\t\t\tfloat relativeVContrast = ( contrastN + contrastS ) - ( contrastE + contrastW );\n\t\t\trelativeVContrast *= fxaaQualityinvEdgeThreshold;\n\n\t\t\tbool horzSpan = relativeVContrast > 0.;\n\t\t\t// . 1 .\n\t\t\t// 0 0 0\n\t\t\t// . 1 .\n\n\t\t\t// 45 deg edge detection and corners of objects, aka V/H contrast is too similar\n\t\t\tif( abs( relativeVContrast ) < .3 ) {\n\t\t\t\t\t// locate the edge\n\t\t\t\t\tvec2 dirToEdge;\n\t\t\t\t\tdirToEdge.x = contrastE > contrastW ? 1. : -1.;\n\t\t\t\t\tdirToEdge.y = contrastS > contrastN ? 1. : -1.;\n\t\t\t\t\t// . 2 .      . 1 .\n\t\t\t\t\t// 1 0 2  ~=  0 0 1\n\t\t\t\t\t// . 1 .      . 0 .\n\n\t\t\t\t\t// tap 2 pixels and see which ones are \"outside\" the edge, to\n\t\t\t\t\t// determine if the edge is vertical or horizontal\n\n\t\t\t\t\tvec4 rgbaAlongH = FxaaTexOff(tex, posM, vec2( dirToEdge.x, -dirToEdge.y ), fxaaQualityRcpFrame.xy);\n\t\t\t\t\tfloat matchAlongH = contrast( rgbaM, rgbaAlongH );\n\t\t\t\t\t// . 1 .\n\t\t\t\t\t// 0 0 1\n\t\t\t\t\t// . 0 H\n\n\t\t\t\t\tvec4 rgbaAlongV = FxaaTexOff(tex, posM, vec2( -dirToEdge.x, dirToEdge.y ), fxaaQualityRcpFrame.xy);\n\t\t\t\t\tfloat matchAlongV = contrast( rgbaM, rgbaAlongV );\n\t\t\t\t\t// V 1 .\n\t\t\t\t\t// 0 0 1\n\t\t\t\t\t// . 0 .\n\n\t\t\t\t\trelativeVContrast = matchAlongV - matchAlongH;\n\t\t\t\t\trelativeVContrast *= fxaaQualityinvEdgeThreshold;\n\n\t\t\t\t\tif( abs( relativeVContrast ) < .3 ) { // 45 deg edge\n\t\t\t\t\t\t\t// 1 1 .\n\t\t\t\t\t\t\t// 0 0 1\n\t\t\t\t\t\t\t// . 0 1\n\n\t\t\t\t\t\t\t// do a simple blur\n\t\t\t\t\t\t\treturn mix(\n\t\t\t\t\t\t\t\t\trgbaM,\n\t\t\t\t\t\t\t\t\t(rgbaN + rgbaS + rgbaE + rgbaW) * .25,\n\t\t\t\t\t\t\t\t\t.4\n\t\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\thorzSpan = relativeVContrast > 0.;\n\t\t\t}\n\n\t\t\tif(!horzSpan) rgbaN = rgbaW;\n\t\t\tif(!horzSpan) rgbaS = rgbaE;\n\t\t\t// . 0 .      1\n\t\t\t// 1 0 1  ->  0\n\t\t\t// . 0 .      1\n\n\t\t\tbool pairN = contrast( rgbaM, rgbaN ) > contrast( rgbaM, rgbaS );\n\t\t\tif(!pairN) rgbaN = rgbaS;\n\n\t\t\tvec2 offNP;\n\t\t\toffNP.x = (!horzSpan) ? 0.0 : fxaaQualityRcpFrame.x;\n\t\t\toffNP.y = ( horzSpan) ? 0.0 : fxaaQualityRcpFrame.y;\n\n\t\t\tbool doneN = false;\n\t\t\tbool doneP = false;\n\n\t\t\tfloat nDist = 0.;\n\t\t\tfloat pDist = 0.;\n\n\t\t\tvec2 posN = posM;\n\t\t\tvec2 posP = posM;\n\n\t\t\tint iterationsUsed = 0;\n\t\t\tint iterationsUsedN = 0;\n\t\t\tint iterationsUsedP = 0;\n\t\t\tfor( int i = 0; i < NUM_SAMPLES; i++ ) {\n\t\t\t\t\titerationsUsed = i;\n\n\t\t\t\t\tfloat increment = float(i + 1);\n\n\t\t\t\t\tif(!doneN) {\n\t\t\t\t\t\t\tnDist += increment;\n\t\t\t\t\t\t\tposN = posM + offNP * nDist;\n\t\t\t\t\t\t\tvec4 rgbaEndN = FxaaTexTop(tex, posN.xy);\n\t\t\t\t\t\t\tdoneN = contrast( rgbaEndN, rgbaM ) > contrast( rgbaEndN, rgbaN );\n\t\t\t\t\t\t\titerationsUsedN = i;\n\t\t\t\t\t}\n\n\t\t\t\t\tif(!doneP) {\n\t\t\t\t\t\t\tpDist += increment;\n\t\t\t\t\t\t\tposP = posM - offNP * pDist;\n\t\t\t\t\t\t\tvec4 rgbaEndP = FxaaTexTop(tex, posP.xy);\n\t\t\t\t\t\t\tdoneP = contrast( rgbaEndP, rgbaM ) > contrast( rgbaEndP, rgbaN );\n\t\t\t\t\t\t\titerationsUsedP = i;\n\t\t\t\t\t}\n\n\t\t\t\t\tif(doneN || doneP) break;\n\t\t\t}\n\n\n\t\t\tif ( !doneP && !doneN ) return rgbaM; // failed to find end of edge\n\n\t\t\tfloat dist = min(\n\t\t\t\t\tdoneN ? float( iterationsUsedN ) / float( NUM_SAMPLES - 1 ) : 1.,\n\t\t\t\t\tdoneP ? float( iterationsUsedP ) / float( NUM_SAMPLES - 1 ) : 1.\n\t\t\t);\n\n\t\t\t// hacky way of reduces blurriness of mostly diagonal edges\n\t\t\t// but reduces AA quality\n\t\t\tdist = pow(dist, .5);\n\n\t\t\tdist = 1. - dist;\n\n\t\t\treturn mix(\n\t\t\t\t\trgbaM,\n\t\t\t\t\trgbaN,\n\t\t\t\t\tdist * .5\n\t\t\t);\n\t}\n\n\tvoid main() {\n\t\t\tconst float edgeDetectionQuality = .2;\n\t\t\tconst float invEdgeDetectionQuality = 1. / edgeDetectionQuality;\n\n\t\t\tgl_FragColor = FxaaPixelShader(\n\t\t\t\t\tvUv,\n\t\t\t\t\ttDiffuse,\n\t\t\t\t\tresolution,\n\t\t\t\t\tedgeDetectionQuality, // [0,1] contrast needed, otherwise early discard\n\t\t\t\t\tinvEdgeDetectionQuality\n\t\t\t);\n\n\t}\n\t"},$b={name:"SMAAEdgesShader",defines:{SMAA_THRESHOLD:"0.1"},uniforms:{tDiffuse:{value:null},resolution:{value:new bt(1/1024,1/512)}},vertexShader:"\n\n\t\tuniform vec2 resolution;\n\n\t\tvarying vec2 vUv;\n\t\tvarying vec4 vOffset[ 3 ];\n\n\t\tvoid SMAAEdgeDetectionVS( vec2 texcoord ) {\n\t\t\tvOffset[ 0 ] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 ); // WebGL port note: Changed sign in W component\n\t\t\tvOffset[ 1 ] = texcoord.xyxy + resolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 ); // WebGL port note: Changed sign in W component\n\t\t\tvOffset[ 2 ] = texcoord.xyxy + resolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 ); // WebGL port note: Changed sign in W component\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\n\t\t\tSMAAEdgeDetectionVS( vUv );\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\t\tvarying vec4 vOffset[ 3 ];\n\n\t\tvec4 SMAAColorEdgeDetectionPS( vec2 texcoord, vec4 offset[3], sampler2D colorTex ) {\n\t\t\tvec2 threshold = vec2( SMAA_THRESHOLD, SMAA_THRESHOLD );\n\n\t\t\t// Calculate color deltas:\n\t\t\tvec4 delta;\n\t\t\tvec3 C = texture2D( colorTex, texcoord ).rgb;\n\n\t\t\tvec3 Cleft = texture2D( colorTex, offset[0].xy ).rgb;\n\t\t\tvec3 t = abs( C - Cleft );\n\t\t\tdelta.x = max( max( t.r, t.g ), t.b );\n\n\t\t\tvec3 Ctop = texture2D( colorTex, offset[0].zw ).rgb;\n\t\t\tt = abs( C - Ctop );\n\t\t\tdelta.y = max( max( t.r, t.g ), t.b );\n\n\t\t\t// We do the usual threshold:\n\t\t\tvec2 edges = step( threshold, delta.xy );\n\n\t\t\t// Then discard if there is no edge:\n\t\t\tif ( dot( edges, vec2( 1.0, 1.0 ) ) == 0.0 )\n\t\t\t\tdiscard;\n\n\t\t\t// Calculate right and bottom deltas:\n\t\t\tvec3 Cright = texture2D( colorTex, offset[1].xy ).rgb;\n\t\t\tt = abs( C - Cright );\n\t\t\tdelta.z = max( max( t.r, t.g ), t.b );\n\n\t\t\tvec3 Cbottom  = texture2D( colorTex, offset[1].zw ).rgb;\n\t\t\tt = abs( C - Cbottom );\n\t\t\tdelta.w = max( max( t.r, t.g ), t.b );\n\n\t\t\t// Calculate the maximum delta in the direct neighborhood:\n\t\t\tfloat maxDelta = max( max( max( delta.x, delta.y ), delta.z ), delta.w );\n\n\t\t\t// Calculate left-left and top-top deltas:\n\t\t\tvec3 Cleftleft  = texture2D( colorTex, offset[2].xy ).rgb;\n\t\t\tt = abs( C - Cleftleft );\n\t\t\tdelta.z = max( max( t.r, t.g ), t.b );\n\n\t\t\tvec3 Ctoptop = texture2D( colorTex, offset[2].zw ).rgb;\n\t\t\tt = abs( C - Ctoptop );\n\t\t\tdelta.w = max( max( t.r, t.g ), t.b );\n\n\t\t\t// Calculate the final maximum delta:\n\t\t\tmaxDelta = max( max( maxDelta, delta.z ), delta.w );\n\n\t\t\t// Local contrast adaptation in action:\n\t\t\tedges.xy *= step( 0.5 * maxDelta, delta.xy );\n\n\t\t\treturn vec4( edges, 0.0, 0.0 );\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tgl_FragColor = SMAAColorEdgeDetectionPS( vUv, vOffset, tDiffuse );\n\n\t\t}"},ey={name:"SMAAWeightsShader",defines:{SMAA_MAX_SEARCH_STEPS:"8",SMAA_AREATEX_MAX_DISTANCE:"16",SMAA_AREATEX_PIXEL_SIZE:"( 1.0 / vec2( 160.0, 560.0 ) )",SMAA_AREATEX_SUBTEX_SIZE:"( 1.0 / 7.0 )"},uniforms:{tDiffuse:{value:null},tArea:{value:null},tSearch:{value:null},resolution:{value:new bt(1/1024,1/512)}},vertexShader:"\n\n\t\tuniform vec2 resolution;\n\n\t\tvarying vec2 vUv;\n\t\tvarying vec4 vOffset[ 3 ];\n\t\tvarying vec2 vPixcoord;\n\n\t\tvoid SMAABlendingWeightCalculationVS( vec2 texcoord ) {\n\t\t\tvPixcoord = texcoord / resolution;\n\n\t\t\t// We will use these offsets for the searches later on (see @PSEUDO_GATHER4):\n\t\t\tvOffset[ 0 ] = texcoord.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 ); // WebGL port note: Changed sign in Y and W components\n\t\t\tvOffset[ 1 ] = texcoord.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 ); // WebGL port note: Changed sign in Y and W components\n\n\t\t\t// And these for the searches, they indicate the ends of the loops:\n\t\t\tvOffset[ 2 ] = vec4( vOffset[ 0 ].xz, vOffset[ 1 ].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( SMAA_MAX_SEARCH_STEPS );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\n\t\t\tSMAABlendingWeightCalculationVS( vUv );\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\t#define SMAASampleLevelZeroOffset( tex, coord, offset ) texture2D( tex, coord + float( offset ) * resolution, 0.0 )\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform sampler2D tArea;\n\t\tuniform sampler2D tSearch;\n\t\tuniform vec2 resolution;\n\n\t\tvarying vec2 vUv;\n\t\tvarying vec4 vOffset[3];\n\t\tvarying vec2 vPixcoord;\n\n\t\t#if __VERSION__ == 100\n\t\tvec2 round( vec2 x ) {\n\t\t\treturn sign( x ) * floor( abs( x ) + 0.5 );\n\t\t}\n\t\t#endif\n\n\t\tfloat SMAASearchLength( sampler2D searchTex, vec2 e, float bias, float scale ) {\n\t\t\t// Not required if searchTex accesses are set to point:\n\t\t\t// float2 SEARCH_TEX_PIXEL_SIZE = 1.0 / float2(66.0, 33.0);\n\t\t\t// e = float2(bias, 0.0) + 0.5 * SEARCH_TEX_PIXEL_SIZE +\n\t\t\t//     e * float2(scale, 1.0) * float2(64.0, 32.0) * SEARCH_TEX_PIXEL_SIZE;\n\t\t\te.r = bias + e.r * scale;\n\t\t\treturn 255.0 * texture2D( searchTex, e, 0.0 ).r;\n\t\t}\n\n\t\tfloat SMAASearchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {\n\t\t\t/**\n\t\t\t\t* @PSEUDO_GATHER4\n\t\t\t\t* This texcoord has been offset by (-0.25, -0.125) in the vertex shader to\n\t\t\t\t* sample between edge, thus fetching four edges in a row.\n\t\t\t\t* Sampling with different offsets in each direction allows to disambiguate\n\t\t\t\t* which edges are active from the four fetched ones.\n\t\t\t\t*/\n\t\t\tvec2 e = vec2( 0.0, 1.0 );\n\n\t\t\tfor ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) { // WebGL port note: Changed while to for\n\t\t\t\te = texture2D( edgesTex, texcoord, 0.0 ).rg;\n\t\t\t\ttexcoord -= vec2( 2.0, 0.0 ) * resolution;\n\t\t\t\tif ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;\n\t\t\t}\n\n\t\t\t// We correct the previous (-0.25, -0.125) offset we applied:\n\t\t\ttexcoord.x += 0.25 * resolution.x;\n\n\t\t\t// The searches are bias by 1, so adjust the coords accordingly:\n\t\t\ttexcoord.x += resolution.x;\n\n\t\t\t// Disambiguate the length added by the last step:\n\t\t\ttexcoord.x += 2.0 * resolution.x; // Undo last step\n\t\t\ttexcoord.x -= resolution.x * SMAASearchLength(searchTex, e, 0.0, 0.5);\n\n\t\t\treturn texcoord.x;\n\t\t}\n\n\t\tfloat SMAASearchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {\n\t\t\tvec2 e = vec2( 0.0, 1.0 );\n\n\t\t\tfor ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) { // WebGL port note: Changed while to for\n\t\t\t\te = texture2D( edgesTex, texcoord, 0.0 ).rg;\n\t\t\t\ttexcoord += vec2( 2.0, 0.0 ) * resolution;\n\t\t\t\tif ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;\n\t\t\t}\n\n\t\t\ttexcoord.x -= 0.25 * resolution.x;\n\t\t\ttexcoord.x -= resolution.x;\n\t\t\ttexcoord.x -= 2.0 * resolution.x;\n\t\t\ttexcoord.x += resolution.x * SMAASearchLength( searchTex, e, 0.5, 0.5 );\n\n\t\t\treturn texcoord.x;\n\t\t}\n\n\t\tfloat SMAASearchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {\n\t\t\tvec2 e = vec2( 1.0, 0.0 );\n\n\t\t\tfor ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) { // WebGL port note: Changed while to for\n\t\t\t\te = texture2D( edgesTex, texcoord, 0.0 ).rg;\n\t\t\t\ttexcoord += vec2( 0.0, 2.0 ) * resolution; // WebGL port note: Changed sign\n\t\t\t\tif ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;\n\t\t\t}\n\n\t\t\ttexcoord.y -= 0.25 * resolution.y; // WebGL port note: Changed sign\n\t\t\ttexcoord.y -= resolution.y; // WebGL port note: Changed sign\n\t\t\ttexcoord.y -= 2.0 * resolution.y; // WebGL port note: Changed sign\n\t\t\ttexcoord.y += resolution.y * SMAASearchLength( searchTex, e.gr, 0.0, 0.5 ); // WebGL port note: Changed sign\n\n\t\t\treturn texcoord.y;\n\t\t}\n\n\t\tfloat SMAASearchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {\n\t\t\tvec2 e = vec2( 1.0, 0.0 );\n\n\t\t\tfor ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) { // WebGL port note: Changed while to for\n\t\t\t\te = texture2D( edgesTex, texcoord, 0.0 ).rg;\n\t\t\t\ttexcoord -= vec2( 0.0, 2.0 ) * resolution; // WebGL port note: Changed sign\n\t\t\t\tif ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;\n\t\t\t}\n\n\t\t\ttexcoord.y += 0.25 * resolution.y; // WebGL port note: Changed sign\n\t\t\ttexcoord.y += resolution.y; // WebGL port note: Changed sign\n\t\t\ttexcoord.y += 2.0 * resolution.y; // WebGL port note: Changed sign\n\t\t\ttexcoord.y -= resolution.y * SMAASearchLength( searchTex, e.gr, 0.5, 0.5 ); // WebGL port note: Changed sign\n\n\t\t\treturn texcoord.y;\n\t\t}\n\n\t\tvec2 SMAAArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {\n\t\t\t// Rounding prevents precision errors of bilinear filtering:\n\t\t\tvec2 texcoord = float( SMAA_AREATEX_MAX_DISTANCE ) * round( 4.0 * vec2( e1, e2 ) ) + dist;\n\n\t\t\t// We do a scale and bias for mapping to texel space:\n\t\t\ttexcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );\n\n\t\t\t// Move to proper place, according to the subpixel offset:\n\t\t\ttexcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;\n\n\t\t\treturn texture2D( areaTex, texcoord, 0.0 ).rg;\n\t\t}\n\n\t\tvec4 SMAABlendingWeightCalculationPS( vec2 texcoord, vec2 pixcoord, vec4 offset[ 3 ], sampler2D edgesTex, sampler2D areaTex, sampler2D searchTex, ivec4 subsampleIndices ) {\n\t\t\tvec4 weights = vec4( 0.0, 0.0, 0.0, 0.0 );\n\n\t\t\tvec2 e = texture2D( edgesTex, texcoord ).rg;\n\n\t\t\tif ( e.g > 0.0 ) { // Edge at north\n\t\t\t\tvec2 d;\n\n\t\t\t\t// Find the distance to the left:\n\t\t\t\tvec2 coords;\n\t\t\t\tcoords.x = SMAASearchXLeft( edgesTex, searchTex, offset[ 0 ].xy, offset[ 2 ].x );\n\t\t\t\tcoords.y = offset[ 1 ].y; // offset[1].y = texcoord.y - 0.25 * resolution.y (@CROSSING_OFFSET)\n\t\t\t\td.x = coords.x;\n\n\t\t\t\t// Now fetch the left crossing edges, two at a time using bilinear\n\t\t\t\t// filtering. Sampling at -0.25 (see @CROSSING_OFFSET) enables to\n\t\t\t\t// discern what value each edge has:\n\t\t\t\tfloat e1 = texture2D( edgesTex, coords, 0.0 ).r;\n\n\t\t\t\t// Find the distance to the right:\n\t\t\t\tcoords.x = SMAASearchXRight( edgesTex, searchTex, offset[ 0 ].zw, offset[ 2 ].y );\n\t\t\t\td.y = coords.x;\n\n\t\t\t\t// We want the distances to be in pixel units (doing this here allow to\n\t\t\t\t// better interleave arithmetic and memory accesses):\n\t\t\t\td = d / resolution.x - pixcoord.x;\n\n\t\t\t\t// SMAAArea below needs a sqrt, as the areas texture is compressed\n\t\t\t\t// quadratically:\n\t\t\t\tvec2 sqrt_d = sqrt( abs( d ) );\n\n\t\t\t\t// Fetch the right crossing edges:\n\t\t\t\tcoords.y -= 1.0 * resolution.y; // WebGL port note: Added\n\t\t\t\tfloat e2 = SMAASampleLevelZeroOffset( edgesTex, coords, ivec2( 1, 0 ) ).r;\n\n\t\t\t\t// Ok, we know how this pattern looks like, now it is time for getting\n\t\t\t\t// the actual area:\n\t\t\t\tweights.rg = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.y ) );\n\t\t\t}\n\n\t\t\tif ( e.r > 0.0 ) { // Edge at west\n\t\t\t\tvec2 d;\n\n\t\t\t\t// Find the distance to the top:\n\t\t\t\tvec2 coords;\n\n\t\t\t\tcoords.y = SMAASearchYUp( edgesTex, searchTex, offset[ 1 ].xy, offset[ 2 ].z );\n\t\t\t\tcoords.x = offset[ 0 ].x; // offset[1].x = texcoord.x - 0.25 * resolution.x;\n\t\t\t\td.x = coords.y;\n\n\t\t\t\t// Fetch the top crossing edges:\n\t\t\t\tfloat e1 = texture2D( edgesTex, coords, 0.0 ).g;\n\n\t\t\t\t// Find the distance to the bottom:\n\t\t\t\tcoords.y = SMAASearchYDown( edgesTex, searchTex, offset[ 1 ].zw, offset[ 2 ].w );\n\t\t\t\td.y = coords.y;\n\n\t\t\t\t// We want the distances to be in pixel units:\n\t\t\t\td = d / resolution.y - pixcoord.y;\n\n\t\t\t\t// SMAAArea below needs a sqrt, as the areas texture is compressed\n\t\t\t\t// quadratically:\n\t\t\t\tvec2 sqrt_d = sqrt( abs( d ) );\n\n\t\t\t\t// Fetch the bottom crossing edges:\n\t\t\t\tcoords.y -= 1.0 * resolution.y; // WebGL port note: Added\n\t\t\t\tfloat e2 = SMAASampleLevelZeroOffset( edgesTex, coords, ivec2( 0, 1 ) ).g;\n\n\t\t\t\t// Get the area for this direction:\n\t\t\t\tweights.ba = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.x ) );\n\t\t\t}\n\n\t\t\treturn weights;\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tgl_FragColor = SMAABlendingWeightCalculationPS( vUv, vPixcoord, vOffset, tDiffuse, tArea, tSearch, ivec4( 0.0 ) );\n\n\t\t}"},ty={name:"SMAABlendShader",uniforms:{tDiffuse:{value:null},tColor:{value:null},resolution:{value:new bt(1/1024,1/512)}},vertexShader:"\n\n\t\tuniform vec2 resolution;\n\n\t\tvarying vec2 vUv;\n\t\tvarying vec4 vOffset[ 2 ];\n\n\t\tvoid SMAANeighborhoodBlendingVS( vec2 texcoord ) {\n\t\t\tvOffset[ 0 ] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 ); // WebGL port note: Changed sign in W component\n\t\t\tvOffset[ 1 ] = texcoord.xyxy + resolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 ); // WebGL port note: Changed sign in W component\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\n\t\t\tSMAANeighborhoodBlendingVS( vUv );\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform sampler2D tColor;\n\t\tuniform vec2 resolution;\n\n\t\tvarying vec2 vUv;\n\t\tvarying vec4 vOffset[ 2 ];\n\n\t\tvec4 SMAANeighborhoodBlendingPS( vec2 texcoord, vec4 offset[ 2 ], sampler2D colorTex, sampler2D blendTex ) {\n\t\t\t// Fetch the blending weights for current pixel:\n\t\t\tvec4 a;\n\t\t\ta.xz = texture2D( blendTex, texcoord ).xz;\n\t\t\ta.y = texture2D( blendTex, offset[ 1 ].zw ).g;\n\t\t\ta.w = texture2D( blendTex, offset[ 1 ].xy ).a;\n\n\t\t\t// Is there any blending weight with a value greater than 0.0?\n\t\t\tif ( dot(a, vec4( 1.0, 1.0, 1.0, 1.0 )) < 1e-5 ) {\n\t\t\t\treturn texture2D( colorTex, texcoord, 0.0 );\n\t\t\t} else {\n\t\t\t\t// Up to 4 lines can be crossing a pixel (one through each edge). We\n\t\t\t\t// favor blending by choosing the line with the maximum weight for each\n\t\t\t\t// direction:\n\t\t\t\tvec2 offset;\n\t\t\t\toffset.x = a.a > a.b ? a.a : -a.b; // left vs. right\n\t\t\t\toffset.y = a.g > a.r ? -a.g : a.r; // top vs. bottom // WebGL port note: Changed signs\n\n\t\t\t\t// Then we go in the direction that has the maximum weight:\n\t\t\t\tif ( abs( offset.x ) > abs( offset.y )) { // horizontal vs. vertical\n\t\t\t\t\toffset.y = 0.0;\n\t\t\t\t} else {\n\t\t\t\t\toffset.x = 0.0;\n\t\t\t\t}\n\n\t\t\t\t// Fetch the opposite color and lerp by hand:\n\t\t\t\tvec4 C = texture2D( colorTex, texcoord, 0.0 );\n\t\t\t\ttexcoord += sign( offset ) * resolution;\n\t\t\t\tvec4 Cop = texture2D( colorTex, texcoord, 0.0 );\n\t\t\t\tfloat s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );\n\n\t\t\t\t// WebGL port note: Added gamma correction\n\t\t\t\tC.xyz = pow(C.xyz, vec3(2.2));\n\t\t\t\tCop.xyz = pow(Cop.xyz, vec3(2.2));\n\t\t\t\tvec4 mixed = mix(C, Cop, s);\n\t\t\t\tmixed.xyz = pow(mixed.xyz, vec3(1.0 / 2.2));\n\n\t\t\t\treturn mixed;\n\t\t\t}\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tgl_FragColor = SMAANeighborhoodBlendingPS( vUv, vOffset, tColor, tDiffuse );\n\n\t\t}"};class iy extends vm{constructor(e,t){super(),this.edgesRT=new Yt(e,t,{depthBuffer:!1,type:Y}),this.edgesRT.texture.name="SMAAPass.edges",this.weightsRT=new Yt(e,t,{depthBuffer:!1,type:Y}),this.weightsRT.texture.name="SMAAPass.weights";const i=this,n=new Image;n.src=this.getAreaTexture(),n.onload=function(){i.areaTexture.needsUpdate=!0},this.areaTexture=new Lt,this.areaTexture.name="SMAAPass.area",this.areaTexture.image=n,this.areaTexture.minFilter=W,this.areaTexture.generateMipmaps=!1,this.areaTexture.flipY=!1;const s=new Image;s.src=this.getSearchTexture(),s.onload=function(){i.searchTexture.needsUpdate=!0},this.searchTexture=new Lt,this.searchTexture.name="SMAAPass.search",this.searchTexture.image=s,this.searchTexture.magFilter=T,this.searchTexture.minFilter=T,this.searchTexture.generateMipmaps=!1,this.searchTexture.flipY=!1,this.uniformsEdges=as.clone($b.uniforms),this.uniformsEdges.resolution.value.set(1/e,1/t),this.materialEdges=new ls({defines:Object.assign({},$b.defines),uniforms:this.uniformsEdges,vertexShader:$b.vertexShader,fragmentShader:$b.fragmentShader}),this.uniformsWeights=as.clone(ey.uniforms),this.uniformsWeights.resolution.value.set(1/e,1/t),this.uniformsWeights.tDiffuse.value=this.edgesRT.texture,this.uniformsWeights.tArea.value=this.areaTexture,this.uniformsWeights.tSearch.value=this.searchTexture,this.materialWeights=new ls({defines:Object.assign({},ey.defines),uniforms:this.uniformsWeights,vertexShader:ey.vertexShader,fragmentShader:ey.fragmentShader}),this.uniformsBlend=as.clone(ty.uniforms),this.uniformsBlend.resolution.value.set(1/e,1/t),this.uniformsBlend.tDiffuse.value=this.weightsRT.texture,this.materialBlend=new ls({uniforms:this.uniformsBlend,vertexShader:ty.vertexShader,fragmentShader:ty.fragmentShader}),this.fsQuad=new wm(null)}render(e,t,i){this.uniformsEdges.tDiffuse.value=i.texture,this.fsQuad.material=this.materialEdges,e.setRenderTarget(this.edgesRT),this.clear&&e.clear(),this.fsQuad.render(e),this.fsQuad.material=this.materialWeights,e.setRenderTarget(this.weightsRT),this.clear&&e.clear(),this.fsQuad.render(e),this.uniformsBlend.tColor.value=i.texture,this.fsQuad.material=this.materialBlend,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(),this.fsQuad.render(e))}setSize(e,t){this.edgesRT.setSize(e,t),this.weightsRT.setSize(e,t),this.materialEdges.uniforms.resolution.value.set(1/e,1/t),this.materialWeights.uniforms.resolution.value.set(1/e,1/t),this.materialBlend.uniforms.resolution.value.set(1/e,1/t)}getAreaTexture(){return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAAIwCAIAAACOVPcQAACBeklEQVR42u39W4xlWXrnh/3WWvuciIzMrKxrV8/0rWbY0+SQFKcb4owIkSIFCjY9AC1BT/LYBozRi+EX+cV+8IMsYAaCwRcBwjzMiw2jAWtgwC8WR5Q8mDFHZLNHTarZGrLJJllt1W2qKrsumZWZcTvn7L3W54e1vrXX3vuciLPPORFR1XE2EomorB0nVuz//r71re/y/1eMvb4Cb3N11xV/PP/2v4UBAwJG/7H8urx6/25/Gf8O5hypMQ0EEEQwAqLfoN/Z+97f/SW+/NvcgQk4sGBJK6H7N4PFVL+K+e0N11yNfkKvwUdwdlUAXPHHL38oa15f/i/46Ih6SuMSPmLAYAwyRKn7dfMGH97jaMFBYCJUgotIC2YAdu+LyW9vvubxAP8kAL8H/koAuOKP3+q6+xGnd5kdYCeECnGIJViwGJMAkQKfDvB3WZxjLKGh8VSCCzhwEWBpMc5/kBbjawT4HnwJfhr+pPBIu7uu+OOTo9vsmtQcniMBGkKFd4jDWMSCRUpLjJYNJkM+IRzQ+PQvIeAMTrBS2LEiaiR9b/5PuT6Ap/AcfAFO4Y3dA3DFH7/VS+M8k4baEAQfMI4QfbVDDGIRg7GKaIY52qAjTAgTvGBAPGIIghOCYAUrGFNgzA7Q3QhgCwfwAnwe5vDejgG44o/fbm1C5ZlYQvQDARPAIQGxCWBM+wWl37ZQESb4gImexGMDouhGLx1Cst0Saa4b4AqO4Hk4gxo+3DHAV/nx27p3JziPM2pVgoiia5MdEzCGULprIN7gEEeQ5IQxEBBBQnxhsDb5auGmAAYcHMA9eAAz8PBol8/xij9+C4Djlim4gJjWcwZBhCBgMIIYxGAVIkH3ZtcBuLdtRFMWsPGoY9rN+HoBji9VBYdwD2ZQg4cnO7OSq/z4rU5KKdwVbFAjNojCQzTlCLPFSxtamwh2jMUcEgg2Wm/6XgErIBhBckQtGN3CzbVacERgCnfgLswhnvqf7QyAq/z4rRZm1YglYE3affGITaZsdIe2FmMIpnOCap25I6jt2kCwCW0D1uAD9sZctNGXcQIHCkINDQgc78aCr+zjtw3BU/ijdpw3zhCwcaONwBvdeS2YZKkJNJsMPf2JKEvC28RXxxI0ASJyzQCjCEQrO4Q7sFArEzjZhaFc4cdv+/JFdKULM4px0DfUBI2hIsy06BqLhGTQEVdbfAIZXYMPesq6VoCHICzUyjwInO4Y411//LYLs6TDa9wvg2CC2rElgAnpTBziThxaL22MYhzfkghz6GAs2VHbbdM91VZu1MEEpupMMwKyVTb5ij9+u4VJG/5EgEMMmFF01cFai3isRbKbzb+YaU/MQbAm2XSMoUPAmvZzbuKYRIFApbtlrfFuUGd6vq2hXNnH78ZLh/iFhsQG3T4D1ib7k5CC6vY0DCbtrohgLEIClXiGtl10zc0CnEGIhhatLBva7NP58Tvw0qE8yWhARLQ8h4+AhQSP+I4F5xoU+VilGRJs6wnS7ruti/4KvAY/CfdgqjsMy4pf8fodQO8/gnuX3f/3xi3om1/h7THr+co3x93PP9+FBUfbNUjcjEmhcrkT+8K7ml7V10Jo05mpIEFy1NmCJWx9SIKKt+EjAL4Ez8EBVOB6havuT/rByPvHXK+9zUcfcbb254+9fydJknYnRr1oGfdaiAgpxu1Rx/Rek8KISftx3L+DfsLWAANn8Hvw0/AFeAGO9DFV3c6D+CcWbL8Dj9e7f+T1k8AZv/d7+PXWM/Z+VvdCrIvuAKO09RpEEQJM0Ci6+B4xhTWr4cZNOvhktabw0ta0rSJmqz3Yw5/AKXwenod7cAhTmBSPKf6JBdvH8IP17h95pXqw50/+BFnj88fev4NchyaK47OPhhtI8RFSvAfDSNh0Ck0p2gLxGkib5NJj/JWCr90EWQJvwBzO4AHcgztwAFN1evHPUVGwfXON+0debT1YeGON9Yy9/63X+OguiwmhIhQhD7l4sMqlG3D86Suc3qWZ4rWjI1X7u0Ytw6x3rIMeIOPDprfe2XzNgyj6PahhBjO4C3e6puDgXrdg+/5l948vF3bqwZetZ+z9Rx9zdIY5pInPK4Nk0t+l52xdK2B45Qd87nM8fsD5EfUhIcJcERw4RdqqH7Yde5V7m1vhNmtedkz6EDzUMF/2jJYWbC+4fzzA/Y+/8PPH3j9dcBAPIRP8JLXd5BpAu03aziOL3VVHZzz3CXWDPWd+SH2AnxIqQoTZpo9Ckc6HIrFbAbzNmlcg8Ag8NFDDAhbJvTBZXbC94P7t68EXfv6o+21gUtPETU7bbkLxvNKRFG2+KXzvtObonPP4rBvsgmaKj404DlshFole1Glfh02fE7bYR7dZ82oTewIBGn1Md6CG6YUF26X376oevOLzx95vhUmgblI6LBZwTCDY7vMq0op5WVXgsObOXJ+1x3qaBl9j1FeLxbhU9w1F+Wiba6s1X/TBz1LnUfuYDi4r2C69f1f14BWfP+p+W2GFKuC9phcELMYRRLur9DEZTUdEH+iEqWdaM7X4WOoPGI+ZYD2+wcQ+y+ioHUZ9dTDbArzxmi/bJI9BND0Ynd6lBdve/butBw8+f/T9D3ABa3AG8W3VPX4hBin+bj8dMMmSpp5pg7fJ6xrBFE2WQQEWnV8Qg3FbAWzYfM1rREEnmvkN2o1+acG2d/9u68GDzx91v3mAjb1zkpqT21OipPKO0b9TO5W0nTdOmAQm0TObts3aBKgwARtoPDiCT0gHgwnbArzxmtcLc08HgF1asN0C4Ms/fvD5I+7PhfqyXE/b7RbbrGyRQRT9ARZcwAUmgdoz0ehJ9Fn7QAhUjhDAQSw0bV3T3WbNa59jzmiP6GsWbGXDX2ytjy8+f9T97fiBPq9YeLdBmyuizZHaqXITnXiMUEEVcJ7K4j3BFPurtB4bixW8wTpweL8DC95szWMOqucFYGsWbGU7p3TxxxefP+r+oTVktxY0v5hbq3KiOKYnY8ddJVSBxuMMVffNbxwIOERShst73HZ78DZrHpmJmH3K6sGz0fe3UUj0eyRrSCGTTc+rjVNoGzNSv05srAxUBh8IhqChiQgVNIIBH3AVPnrsnXQZbLTm8ammv8eVXn/vWpaTem5IXRlt+U/LA21zhSb9cye6jcOfCnOwhIAYXAMVTUNV0QhVha9xjgA27ODJbLbmitt3tRN80lqG6N/khgot4ZVlOyO4WNg3OIMzhIZQpUEHieg2im6F91hB3I2tubql6BYNN9Hj5S7G0G2tahslBWKDnOiIvuAEDzakDQKDNFQT6gbn8E2y4BBubM230YIpBnDbMa+y3dx0n1S0BtuG62lCCXwcY0F72T1VRR3t2ONcsmDjbmzNt9RFs2LO2hQNyb022JisaI8rAWuw4HI3FuAIhZdOGIcdjLJvvObqlpqvWTJnnQbyi/1M9O8UxWhBs//H42I0q1Yb/XPGONzcmm+ri172mHKvZBpHkJaNJz6v9jxqiklDj3U4CA2ugpAaYMWqNXsdXbmJNd9egCnJEsphXNM+MnK3m0FCJ5S1kmJpa3DgPVbnQnPGWIDspW9ozbcO4K/9LkfaQO2KHuqlfFXSbdNzcEcwoqNEFE9zcIXu9/6n/ym/BC/C3aJLzEKPuYVlbFnfhZ8kcWxV3dbv4bKl28566wD+8C53aw49lTABp9PWbsB+knfc/Li3eVizf5vv/xmvnPKg5ihwKEwlrcHqucuVcVOxEv8aH37E3ZqpZypUulrHEtIWKUr+txHg+ojZDGlwnqmkGlzcVi1dLiNSJiHjfbRNOPwKpx9TVdTn3K05DBx4psIk4Ei8aCkJahRgffk4YnEXe07T4H2RR1u27E6wfQsBDofUgjFUFnwC2AiVtA+05J2zpiDK2Oa0c5fmAecN1iJzmpqFZxqYBCYhFTCsUNEmUnIcZ6aEA5rQVhEywG6w7HSW02XfOoBlQmjwulOFQAg66SvJblrTEX1YtJ3uG15T/BH1OfOQeuR8g/c0gdpT5fx2SKbs9EfHTKdM8A1GaJRHLVIwhcGyydZsbifAFVKl5EMKNU2Hryo+06BeTgqnxzYjThVySDikbtJPieco75lYfKAJOMEZBTjoITuWHXXZVhcUDIS2hpiXHV9Ku4u44bN5OYLDOkJo8w+xJSMbhBRHEdEs9JZUCkQrPMAvaHyLkxgkEHxiNkx/x2YB0mGsQ8EUWj/stW5YLhtS5SMu+/YBbNPDCkGTUybN8krRLBGPlZkVOA0j+a1+rkyQKWGaPHPLZOkJhioQYnVZ2hS3zVxMtgC46KuRwbJNd9nV2PHgb36F194ecf/Yeu2vAFe5nm/bRBFrnY4BauE8ERmZRFUn0k8hbftiVYSKMEme2dJCJSCGYAlNqh87bXOPdUkGy24P6d1ll21MBqqx48Fvv8ZHH8HZFY7j/uAq1xMJUFqCSUlJPmNbIiNsmwuMs/q9CMtsZsFO6SprzCS1Z7QL8xCQClEelpjTduDMsmWD8S1PT152BtvmIGvUeDA/yRn83u/x0/4qxoPHjx+PXY9pqX9bgMvh/Nz9kpP4pOe1/fYf3axUiMdHLlPpZCNjgtNFAhcHEDxTumNONhHrBduW+vOyY++70WWnPXj98eA4kOt/mj/5E05l9+O4o8ePx67HFqyC+qSSnyselqjZGaVK2TadbFLPWAQ4NBhHqDCCV7OTpo34AlSSylPtIdd2AJZlyzYQrDJ5lcWGNceD80CunPLGGzsfD+7wRb95NevJI5docQ3tgCyr5bGnyaPRlmwNsFELViOOx9loebGNq2moDOKpHLVP5al2cymWHbkfzGXL7kfRl44H9wZy33tvt+PB/Xnf93e+nh5ZlU18wCiRUa9m7kib9LYuOk+hudQNbxwm0AQqbfloimaB2lM5fChex+ylMwuTbfmXQtmWlenZljbdXTLuOxjI/fDDHY4Hjx8/Hrse0zXfPFxbUN1kKqSCCSk50m0Ajtx3ub9XHBKHXESb8iO6E+qGytF4nO0OG3SXzbJlhxBnKtKyl0NwybjvYCD30aMdjgePHz8eu56SVTBbgxJMliQ3Oauwg0QHxXE2Ez/EIReLdQj42Gzb4CLS0YJD9xUx7bsi0vJi5mUbW1QzL0h0PFk17rtiIPfJk52MB48fPx67npJJwyrBa2RCCQRTbGZSPCxTPOiND4G2pYyOQ4h4jINIJh5wFU1NFZt+IsZ59LSnDqBjZ2awbOku+yInunLcd8VA7rNnOxkPHj9+PGY9B0MWJJNozOJmlglvDMXDEozdhQWbgs/U6oBanGzLrdSNNnZFjOkmbi5bNt1lX7JLLhn3vXAg9/h4y/Hg8ePHI9dzQMEkWCgdRfYykYKnkP7D4rIujsujaKPBsB54vE2TS00ccvFY/Tth7JXeq1hz+qgVy04sAJawTsvOknHfCwdyT062HA8eP348Zj0vdoXF4pilKa2BROed+9fyw9rWRXeTFXESMOanvDZfJuJaSXouQdMdDJZtekZcLLvEeK04d8m474UDuaenW44Hjx8/Xns9YYqZpszGWB3AN/4VHw+k7WSFtJ3Qicuqb/NlVmgXWsxh570xg2UwxUw3WfO6B5nOuO8aA7lnZxuPB48fPx6znm1i4bsfcbaptF3zNT78eFPtwi1OaCNOqp1x3zUGcs/PN++AGD1+fMXrSVm2baTtPhPahbPhA71wIHd2bXzRa69nG+3CraTtPivahV/55tXWg8fyRY/9AdsY8VbSdp8V7cKrrgdfM//z6ILQFtJ2nxHtwmuoB4/kf74+gLeRtvvMaBdeSz34+vifx0YG20jbfTa0C6+tHrwe//NmOG0L8EbSdp8R7cLrrQe/996O+ai3ujQOskpTNULa7jOjXXj99eCd8lHvoFiwsbTdZ0a78PrrwTvlo966pLuRtB2fFe3Cm6oHP9kNH/W2FryxtN1nTLvwRurBO+Kj3pWXHidtx2dFu/Bm68Fb81HvykuPlrb7LGkX3mw9eGs+6h1Y8MbSdjegXcguQLjmevDpTQLMxtJ2N6NdyBZu9AbrwVvwUW+LbteULUpCdqm0HTelXbhNPe8G68Gb8lFvVfYfSNuxvrTdTWoXbozAzdaDZzfkorOj1oxVxlIMlpSIlpLrt8D4hrQL17z+c3h6hU/wv4Q/utps4+bm+6P/hIcf0JwQ5oQGPBL0eKPTYEXTW+eL/2DKn73J9BTXYANG57hz1cEMviVf/4tf5b/6C5pTQkMIWoAq7hTpOJjtAM4pxKu5vg5vXeUrtI09/Mo/5H+4z+Mp5xULh7cEm2QbRP2tFIKR7WM3fPf/jZ3SWCqLM2l4NxID5zB72HQXv3jj/8mLR5xXNA5v8EbFQEz7PpRfl1+MB/hlAN65qgDn3wTgH13hK7T59bmP+NIx1SHHU84nLOITt3iVz8mNO+lPrjGAnBFqmioNn1mTyk1ta47R6d4MrX7tjrnjYUpdUbv2rVr6YpVfsGG58AG8Ah9eyUN8CX4WfgV+G8LVWPDGb+Zd4cU584CtqSbMKxauxTg+dyn/LkVgA+IR8KHtejeFKRtTmLLpxN6mYVLjYxwXf5x2VofiZcp/lwKk4wGOpYDnoIZPdg/AAbwMfx0+ge9dgZvYjuqKe4HnGnykYo5TvJbG0Vj12JagRhwKa44H95ShkZa5RyLGGdfYvG7aw1TsF6iapPAS29mNS3NmsTQZCmgTzFwgL3upCTgtBTRwvGMAKrgLn4evwin8+afJRcff+8izUGUM63GOOuAs3tJkw7J4kyoNreqrpO6cYLQeFUd7TTpr5YOTLc9RUUogUOVJQ1GYJaFLAW0oTmKyYS46ZooP4S4EON3xQ5zC8/CX4CnM4c1PE8ApexpoYuzqlP3d4S3OJP8ZDK7cKWNaTlqmgDiiHwl1YsE41w1zT4iRTm3DBqxvOUsbMKKDa/EHxagtnta072ejc3DOIh5ojvh8l3tk1JF/AV6FU6jh3U8HwEazLgdCLYSQ+MYiAI2ltomkzttUb0gGHdSUUgsIYjTzLG3mObX4FBRaYtpDVNZrih9TgTeYOBxsEnN1gOCTM8Bsw/ieMc75w9kuAT6A+/AiHGvN/+Gn4KRkiuzpNNDYhDGFndWRpE6SVfm8U5bxnSgVV2jrg6JCKmneqey8VMFgq2+AM/i4L4RUbfSi27lNXZ7R7W9RTcq/q9fk4Xw3AMQd4I5ifAZz8FcVtm9SAom/dyN4lczJQW/kC42ZrHgcCoIf1oVMKkVItmMBi9cOeNHGLqOZk+QqQmrbc5YmYgxELUUN35z2iohstgfLIFmcMV7s4CFmI74L9+EFmGsi+tGnAOD4Yk9gIpo01Y4cA43BWGygMdr4YZekG3OBIUXXNukvJS8tqa06e+lSDCtnqqMFu6hWHXCF+WaYt64m9QBmNxi7Ioy7D+fa1yHw+FMAcPt7SysFLtoG4PXAk7JOA3aAxBRqUiAdU9Yp5lK3HLSRFtOim0sa8euEt08xvKjYjzeJ2GU7YawexrnKI9tmobInjFXCewpwriY9+RR4aaezFhMhGCppKwom0ChrgFlKzyPKkGlTW1YQrE9HJqu8hKGgMc6hVi5QRq0PZxNfrYNgE64utmRv6KKHRpxf6VDUaOvNP5jCEx5q185My/7RKz69UQu2im5k4/eownpxZxNLwiZ1AZTO2ZjWjkU9uaB2HFn6Q3u0JcsSx/qV9hTEApRzeBLDJQXxYmTnq7bdLa3+uqFrxLJ5w1TehnNHx5ECvCh2g2c3hHH5YsfdaSKddztfjQ6imKFGSyFwlLzxEGPp6r5IevVjk1AMx3wMqi1NxDVjLBiPs9tbsCkIY5we5/ML22zrCScFxnNtzsr9Wcc3CnD+pYO+4VXXiDE0oc/vQQ/fDK3oPESJMYXNmJa/DuloJZkcTpcYE8lIH8Dz8DJMiynNC86Mb2lNaaqP/+L7f2fcE/yP7/Lde8xfgSOdMxvOixZf/9p3+M4hT1+F+zApxg9XfUvYjc8qX2lfOOpK2gNRtB4flpFu9FTKCp2XJRgXnX6olp1zyYjTKJSkGmLE2NjUr1bxFM4AeAAHBUFIeSLqXR+NvH/M9fOnfHzOD2vCSyQJKzfgsCh+yi/Mmc35F2fUrw7miW33W9hBD1vpuUojFphIyvg7aTeoymDkIkeW3XLHmguMzbIAJejN6B5MDrhipE2y6SoFRO/AK/AcHHZHNIfiWrEe/C6cr3f/yOvrQKB+zMM55/GQdLDsR+ifr5Fiuu+/y+M78LzOE5dsNuXC3PYvYWd8NXvphLSkJIasrlD2/HOqQ+RjcRdjKTGWYhhVUm4yxlyiGPuMsZR7sMCHUBeTuNWA7if+ifXgc/hovftHXs/DV+Fvwe+f8shzMiMcweFgBly3//vwJfg5AN4450fn1Hd1Rm1aBLu22Dy3y3H2+OqMemkbGZ4jozcDjJf6596xOLpC0eMTHbKnxLxH27uZ/bMTGs2jOaMOY4m87CfQwF0dw53oa1k80JRuz/XgS+8fX3N9Af4qPIMfzKgCp4H5TDGe9GGeFPzSsZz80SlPTxXjgwJmC45njzgt2vbQ4b4OAdUK4/vWhO8d8v6EE8fMUsfakXbPpFJeLs2ubM/qdm/la3WP91uWhxXHjoWhyRUq2iJ/+5mA73zwIIo+LoZ/SgvIRjAd1IMvvn98PfgOvAJfhhm8scAKVWDuaRaK8aQ9f7vuPDH6Bj47ZXau7rqYJ66mTDwEDU6lLbCjCK0qTXyl5mnDoeNRxanj3FJbaksTk0faXxHxLrssgPkWB9LnA/MFleXcJozzjwsUvUG0X/QCve51qkMDXp9mtcyOy3rwBfdvVJK7D6/ACSzg3RoruIq5UDeESfEmVclDxnniU82vxMLtceD0hGZWzBNPMM/jSPne2OVatiTKUpY5vY7gc0LdUAWeWM5tH+O2I66AOWw9xT2BuyRVLGdoDHUsVRXOo/c+ZdRXvFfnxWyIV4upFLCl9eAL7h8Zv0QH8Ry8pA2cHzQpGesctVA37ZtklBTgHjyvdSeKY/RZw/kJMk0Y25cSNRWSigQtlULPTw+kzuJPeYEkXjQRpoGZobYsLF79pyd1dMRHInbgFTZqNLhDqiIsTNpoex2WLcy0/X6rHcdMMQvFSd5dWA++4P7xv89deACnmr36uGlL69bRCL6BSZsS6c0TU2TKK5gtWCzgAOOwQcurqk9j8whvziZSMLcq5hbuwBEsYjopUBkqw1yYBGpLA97SRElEmx5MCInBY5vgLk94iKqSWmhIGmkJ4Bi9m4L645J68LyY4wsFYBfUg5feP/6gWWm58IEmKQM89hq7KsZNaKtP5TxxrUZZVkNmMJtjbKrGxLNEbHPJxhqy7lAmbC32ZqeF6lTaknRWcYaFpfLUBh/rwaQycCCJmW15Kstv6jRHyJFry2C1ahkkIW0LO75s61+owxK1y3XqweX9m5YLM2DPFeOjn/iiqCKJ+yKXF8t5Yl/kNsqaSCryxPq5xWTFIaP8KSW0RYxqupaUf0RcTNSSdJZGcKYdYA6kdtrtmyBckfKXwqk0pHpUHlwWaffjNRBYFPUDWa8e3Lt/o0R0CdisKDM89cX0pvRHEfM8ca4t0s2Xx4kgo91MPQJ/0c9MQYq0co8MBh7bz1fio0UUHLR4aAIOvOmoYO6kwlEVODSSTliWtOtH6sPkrtctF9ZtJ9GIerBskvhdVS5cFNv9s1BU0AbdUgdK4FG+dRnjFmDTzniRMdZO1QhzMK355vigbdkpz9P6qjUGE5J2qAcXmwJ20cZUiAD0z+pGMx6xkzJkmEf40Hr4qZfVg2XzF9YOyoV5BjzVkUJngKf8lgNYwKECEHrCNDrWZzMlflS3yBhr/InyoUgBc/lKT4pxVrrC6g1YwcceK3BmNxZcAtz3j5EIpqguh9H6wc011YN75cKDLpFDxuwkrPQmUwW4KTbj9mZTwBwLq4aQMUZbHm1rylJ46dzR0dua2n3RYCWZsiHROeywyJGR7mXKlpryyCiouY56sFkBWEnkEB/raeh/Sw4162KeuAxMQpEkzy5alMY5wamMsWKKrtW2WpEWNnReZWONKWjrdsKZarpFjqCslq773PLmEhM448Pc3+FKr1+94vv/rfw4tEcu+lKTBe4kZSdijBrykwv9vbCMPcLQTygBjzVckSLPRVGslqdunwJ4oegtFOYb4SwxNgWLCmD7T9kVjTv5YDgpo0XBmN34Z/rEHp0sgyz7lngsrm4lvMm2Mr1zNOJYJ5cuxuQxwMGJq/TP5emlb8fsQBZviK4t8hFL+zbhtlpwaRSxQRWfeETjuauPsdGxsBVdO7nmP4xvzSoT29pRl7kGqz+k26B3Oy0YNV+SXbbQas1ctC/GarskRdFpKczVAF1ZXnLcpaMuzVe6lZ2g/1ndcvOVgRG3sdUAY1bKD6achijMPdMxV4muKVorSpiDHituH7rSTs7n/4y5DhRXo4FVBN4vO/zbAcxhENzGbHCzU/98Mcx5e7a31kWjw9FCe/zNeYyQjZsWb1uc7U33pN4Mji6hCLhivqfa9Ss6xLg031AgfesA/l99m9fgvnaF9JoE6bYKmkGNK3aPbHB96w3+DnxFm4hs0drLsk7U8kf/N/CvwQNtllna0rjq61sH8L80HAuvwH1tvBy2ChqWSCaYTaGN19sTvlfzFD6n+iKTbvtayfrfe9ueWh6GJFoxLdr7V72a5ZpvHcCPDzma0wTO4EgbLyedxstO81n57LYBOBzyfsOhUKsW1J1BB5vr/tz8RyqOFylQP9Tvst2JALsC5lsH8PyQ40DV4ANzYa4dedNiKNR1s+x2wwbR7q4/4cTxqEk4LWDebfisuo36JXLiWFjOtLrlNWh3K1rRS4xvHcDNlFnNmWBBAl5SWaL3oPOfnvbr5pdjVnEaeBJSYjuLEkyLLsWhKccadmOphZkOPgVdalj2QpSmfOsADhMWE2ZBu4+EEJI4wKTAuCoC4xwQbWXBltpxbjkXJtKxxabo9e7tyhlgb6gNlSbUpMh+l/FaqzVwewGu8BW1Zx7pTpQDJUjb8tsUTW6+GDXbMn3mLbXlXJiGdggxFAoUrtPS3wE4Nk02UZG2OOzlk7fRs7i95QCLo3E0jtrjnM7SR3uS1p4qtS2nJ5OwtQVHgOvArLBFijZUV9QtSl8dAY5d0E0hM0w3HS2DpIeB6m/A1+HfhJcGUq4sOxH+x3f5+VO+Ds9rYNI7zPXOYWPrtf8bYMx6fuOAX5jzNR0PdsuON+X1f7EERxMJJoU6GkTEWBvVolVlb5lh3tKCg6Wx1IbaMDdJ+9sUCc5KC46hKGCk3IVOS4TCqdBNfUs7Kd4iXf2RjnT/LLysJy3XDcHLh/vde3x8DoGvwgsa67vBk91G5Pe/HbOe7xwym0NXbtiuuDkGO2IJDh9oQvJ4cY4vdoqLDuoH9Zl2F/ofsekn8lkuhIlhQcffUtSjytFyp++p6NiE7Rqx/lodgKVoceEp/CP4FfjrquZaTtj2AvH5K/ywpn7M34K/SsoYDAdIN448I1/0/wveW289T1/lX5xBzc8N5IaHr0XMOQdHsIkDuJFifj20pBm5jzwUv9e2FhwRsvhAbalCIuIw3bhJihY3p6nTFFIZgiSYjfTf3aXuOjmeGn4bPoGvwl+CFzTRczBIuHBEeImHc37/lGfwZR0cXzVDOvaKfNHvwe+suZ771K/y/XcBlsoN996JpBhoE2toYxOznNEOS5TJc6Id5GEXLjrWo+LEWGNpPDU4WAwsIRROu+1vM+0oW37z/MBN9kqHnSArwPfgFJ7Cq/Ai3Ie7g7ncmI09v8sjzw9mzOAEXoIHxURueaAce5V80f/DOuuZwHM8vsMb5wBzOFWM7wymTXPAEvm4vcFpZ2ut0VZRjkiP2MlmLd6DIpbGSiHOjdnUHN90hRYmhTnmvhzp1iKDNj+b7t5hi79lWGwQ+HN9RsfFMy0FXbEwhfuczKgCbyxYwBmcFhhvo/7a44v+i3XWcwDP86PzpGQYdWh7csP5dBvZ1jNzdxC8pBGuxqSW5vw40nBpj5JhMwvOzN0RWqERHMr4Lv1kWX84xLR830G3j6yqZ1a8UstTlW+qJPOZ+sZ7xZPKTJLhiNOAFd6tk+jrTH31ncLOxid8+nzRb128HhUcru/y0Wn6iT254YPC6FtVSIMoW2sk727AhvTtrWKZTvgsmckfXYZWeNRXx/3YQ2OUxLDrbHtN11IwrgXT6c8dATDwLniYwxzO4RzuQqTKSC5gAofMZ1QBK3zQ4JWobFbcvJm87FK+6JXrKahLn54m3p+McXzzYtP8VF/QpJuh1OwieElEoI1pRxPS09FBrkq2tWCU59+HdhNtTIqKm8EBrw2RTOEDpG3IKo2Y7mFdLm3ZeVjYwVw11o/oznceMve4CgMfNym/utA/d/ILMR7gpXzRy9eDsgLcgbs8O2Va1L0zzIdwGGemTBuwROHeoMShkUc7P+ISY3KH5ZZeWqO8mFTxQYeXTNuzvvK5FGPdQfuu00DwYFY9dyhctEt+OJDdnucfpmyhzUJzfsJjr29l8S0bXBfwRS9ZT26tmMIdZucch5ZboMz3Nio3nIOsYHCGoDT4kUA9MiXEp9Xsui1S8th/kbWIrMBxDGLodWUQIWcvnXy+9M23xPiSMOiRPqM+YMXkUN3gXFrZJwXGzUaMpJfyRS9ZT0lPe8TpScuRlbMHeUmlaKDoNuy62iWNTWNFYjoxFzuJs8oR+RhRx7O4SVNSXpa0ZJQ0K1LAHDQ+D9IepkMXpcsq5EVCvClBUIzDhDoyKwDw1Lc59GbTeORivugw1IcuaEOaGWdNm+Ps5fQ7/tm0DjMegq3yM3vb5j12qUId5UZD2oxDSEWOZMSqFl/W+5oynWDa/aI04tJRQ2eTXusg86SQVu/nwSYwpW6wLjlqIzwLuxGIvoAvul0PS+ZNz0/akp/pniO/8JDnGyaCkzbhl6YcqmK/69prxPqtpx2+Km9al9sjL+rwMgHw4jE/C8/HQ3m1vBuL1fldbzd8mOueVJ92syqdEY4KJjSCde3mcRw2TA6szxedn+zwhZMps0XrqEsiUjnC1hw0TELC2Ek7uAAdzcheXv1BYLagspxpzSAoZZUsIzIq35MnFQ9DOrlNB30jq3L4pkhccKUAA8/ocvN1Rzx9QyOtERs4CVsJRK/DF71kPYrxYsGsm6RMh4cps5g1DOmM54Ly1ii0Hd3Y/BMk8VWFgBVmhqrkJCPBHAolwZaWzLR9Vb7bcWdX9NyUYE+uB2BKfuaeBUcjDljbYVY4DdtsVWvzRZdWnyUzDpjNl1Du3aloAjVJTNDpcIOVVhrHFF66lLfJL1zJr9PQ2nFJSBaKoDe+sAvLufZVHVzYh7W0h/c6AAZ+7Tvj6q9j68G/cTCS/3n1vLKHZwNi+P+pS0WkZNMBMUl+LDLuiE4omZy71r3UFMwNJV+VJ/GC5ixVUkBStsT4gGKh0Gm4Oy3qvq7Lbmq24nPdDuDR9deR11XzP4vFu3TYzfnIyiSVmgizUYGqkIXNdKTY9pgb9D2Ix5t0+NHkVzCdU03suWkkVZAoCONCn0T35gAeW38de43mf97sMOpSvj4aa1KYUm58USI7Wxxes03bAZdRzk6UtbzMaCQ6IxO0dy7X+XsjoD16hpsBeGz9dfzHj+R/Hp8nCxZRqkEDTaCKCSywjiaoMJ1TITE9eg7Jqnq8HL6gDwiZb0u0V0Rr/rmvqjxKuaLCX7ZWXTvAY+uvm3z8CP7nzVpngqrJpZKwWnCUjIviYVlirlGOzPLI3SMVyp/elvBUjjDkNhrtufFFErQ8pmdSlbK16toBHlt/HV8uHMX/vEGALkV3RJREiSlopxwdMXOZPLZ+ix+kAHpMKIk8UtE1ygtquttwxNhphrIZ1IBzjGF3IIGxGcBj6q8bHJBG8T9vdsoWrTFEuebEZuVxhhClH6P5Zo89OG9fwHNjtNQTpD0TG9PJLEYqvEY6Rlxy+ZZGfL0Aj62/bnQCXp//eeM4KzfQVJbgMQbUjlMFIm6TpcfWlZje7NBSV6IsEVmumWIbjiloUzQX9OzYdo8L1wjw2PrrpimONfmfNyzKklrgnEkSzT5QWYQW40YShyzqsRmMXbvVxKtGuYyMKaU1ugenLDm5Ily4iT14fP11Mx+xJv+zZ3MvnfdFqxU3a1W/FTB4m3Qfsyc1XUcdVhDeUDZXSFHHLQj/Y5jtC7ZqM0CXGwB4bP11i3LhOvzPGygYtiUBiwQV/4wFO0majijGsafHyRLu0yG6q35cL1rOpVxr2s5cM2jJYMCdc10Aj6q/blRpWJ//+dmm5psMl0KA2+AFRx9jMe2WbC4jQxnikd4DU8TwUjRVacgdlhmr3bpddzuJ9zXqr2xnxJfzP29RexdtjDVZqzkqa6PyvcojGrfkXiJ8SEtml/nYskicv0ivlxbqjemwUjMw5evdg8fUX9nOiC/lf94Q2i7MURk9nW1MSj5j8eAyV6y5CN2S6qbnw3vdA1Iwq+XOSCl663udN3IzLnrt+us25cI1+Z83SXQUldqQq0b5XOT17bGpLd6ssN1VMPf8c+jG8L3NeCnMdF+Ra3fRa9dft39/LuZ/3vwHoHrqGmQFafmiQw6eyzMxS05K4bL9uA+SKUQzCnSDkqOGokXyJvbgJ/BHI+qvY69//4rl20NsmK2ou2dTsyIALv/91/8n3P2Aao71WFGi8KKv1fRC5+J67Q/507/E/SOshqN5TsmYIjVt+kcjAx98iz/4SaojbIV1rexE7/C29HcYD/DX4a0rBOF5VTu7omsb11L/AWcVlcVZHSsqGuXLLp9ha8I//w3Mv+T4Ew7nTBsmgapoCrNFObIcN4pf/Ob/mrvHTGqqgAupL8qWjWPS9m/31jAe4DjA+4+uCoQoT/zOzlrNd3qd4SdphFxsUvYwGWbTWtISc3wNOWH+kHBMfc6kpmpwPgHWwqaSUG2ZWWheYOGQGaHB+eQ/kn6b3pOgLV+ODSn94wDvr8Bvb70/LLuiPPEr8OGVWfDmr45PZyccEmsVXZGe1pRNX9SU5+AVQkNTIVPCHF/jGmyDC9j4R9LfWcQvfiETmgMMUCMN1uNCakkweZsowdYobiMSlnKA93u7NzTXlSfe+SVbfnPQXmg9LpYAQxpwEtONyEyaueWM4FPjjyjG3uOaFmBTWDNgBXGEiQpsaWhnAqIijB07Dlsy3fUGeP989xbWkyf+FF2SNEtT1E0f4DYYVlxFlbaSMPIRMk/3iMU5pME2SIWJvjckciebkQuIRRyhUvkHg/iUljG5kzVog5hV7vIlCuBrmlhvgPfNHQM8lCf+FEGsYbMIBC0qC9a0uuy2wLXVbLBaP5kjHokCRxapkQyzI4QEcwgYHRZBp+XEFTqXFuNVzMtjXLJgX4gAid24Hjwc4N3dtVSe+NNiwTrzH4WVUOlDobUqr1FuAgYllc8pmzoVrELRHSIW8ViPxNy4xwjBpyR55I6J220qQTZYR4guvUICJiSpr9gFFle4RcF/OMB7BRiX8sSfhpNSO3lvEZCQfLUVTKT78Ek1LRLhWN+yLyTnp8qWUZ46b6vxdRGXfHVqx3eI75YaLa4iNNiK4NOW7wPW6lhbSOF9/M9qw8e/aoB3d156qTzxp8pXx5BKAsYSTOIIiPkp68GmTq7sZtvyzBQaRLNxIZ+paozHWoLFeExIhRBrWitHCAHrCF7/thhD8JhYz84wg93QRV88wLuLY8zF8sQ36qF1J455bOlgnELfshKVxYOXKVuKx0jaj22sczTQqPqtV/XDgpswmGTWWMSDw3ssyUunLLrVPGjYRsH5ggHeHSWiV8kT33ycFSfMgkoOK8apCye0J6VW6GOYvffgU9RWsukEi2kUV2nl4dOYUzRik9p7bcA4ggdJ53LxKcEe17B1R8eqAd7dOepV8sTXf5lhejoL85hUdhDdknPtKHFhljOT+bdq0hxbm35p2nc8+Ja1Iw+tJykgp0EWuAAZYwMVwac5KzYMslhvgHdHRrxKnvhTYcfKsxTxtTETkjHO7rr3zjoV25lAQHrqpV7bTiy2aXMmUhTBnKS91jhtR3GEoF0oLnWhWNnYgtcc4N0FxlcgT7yz3TgNIKkscx9jtV1ZKpWW+Ub1tc1eOv5ucdgpx+FJy9pgbLE7xDyXb/f+hLHVGeitHOi6A7ybo3sF8sS7w7cgdk0nJaOn3hLj3uyD0Zp5pazFIUXUpuTTU18d1EPkDoX8SkmWTnVIozEdbTcZjoqxhNHf1JrSS/AcvHjZ/SMHhL/7i5z+POsTUh/8BvNfYMTA8n+yU/MlTZxSJDRStqvEuLQKWwDctMTQogUDyQRoTQG5Kc6oQRE1yV1jCA7ri7jdZyK0sYTRjCR0Hnnd+y7nHxNgTULqw+8wj0mQKxpYvhjm9uSUxg+TTy7s2GtLUGcywhXSKZN275GsqlclX90J6bRI1aouxmgL7Q0Nen5ziM80SqMIo8cSOo+8XplT/5DHNWsSUr/6lLN/QQ3rDyzLruEW5enpf7KqZoShEduuSFOV7DLX7Ye+GmXb6/hnNNqKsVXuMDFpb9Y9eH3C6NGEzuOuI3gpMH/I6e+zDiH1fXi15t3vA1czsLws0TGEtmPEJdiiFPwlwKbgLHAFk4P6ZyPdymYYHGE0dutsChQBl2JcBFlrEkY/N5bQeXQ18gjunuMfMfsBlxJSx3niO485fwO4fGD5T/+3fPQqkneWVdwnw/3bMPkW9Wbqg+iC765Zk+xcT98ibKZc2EdgHcLoF8cSOo/Oc8fS+OyEULF4g4sJqXVcmfMfsc7A8v1/yfGXmL9I6Fn5pRwZhsPv0TxFNlAfZCvG+Oohi82UC5f/2IsJo0cTOm9YrDoKhFPEUr/LBYTUNht9zelHXDqwfPCIw4owp3mOcIQcLttWXFe3VZ/j5H3cIc0G6oPbCR+6Y2xF2EC5cGUm6wKC5tGEzhsWqw5hNidUiKX5gFWE1GXh4/Qplw4sVzOmx9QxU78g3EF6wnZlEN4FzJ1QPSLEZz1KfXC7vd8ssGdIbNUYpVx4UapyFUHzJoTOo1McSkeNn1M5MDQfs4qQuhhX5vQZFw8suwWTcyYTgioISk2YdmkhehG4PkE7w51inyAGGaU+uCXADabGzJR1fn3lwkty0asIo8cROm9Vy1g0yDxxtPvHDAmpu+PKnM8Ix1wwsGw91YJqhteaWgjYBmmQiebmSpwKKzE19hx7jkzSWOm66oPbzZ8Yj6kxVSpYjVAuvLzYMCRo3oTQecOOjjgi3NQ4l9K5/hOGhNTdcWVOTrlgYNkEXINbpCkBRyqhp+LdRB3g0OU6rMfW2HPCFFMV9nSp+uB2woepdbLBuJQyaw/ZFysXrlXwHxI0b0LovEkiOpXGA1Ijagf+KUNC6rKNa9bQnLFqYNkEnMc1uJrg2u64ELPBHpkgWbmwKpJoDhMwNbbGzAp7Yg31wS2T5rGtzit59PrKhesWG550CZpHEzpv2NGRaxlNjbMqpmEIzygJqQfjypycs2pg2cS2RY9r8HUqkqdEgKTWtWTKoRvOBPDYBltja2SO0RGjy9UHtxwRjA11ujbKF+ti5cIR9eCnxUg6owidtyoU5tK4NLji5Q3HCtiyF2IqLGYsHViOXTXOYxucDqG0HyttqYAKqYo3KTY1ekyDXRAm2AWh9JmsVh/ccg9WJ2E8YjG201sPq5ULxxX8n3XLXuMInbft2mk80rRGjCGctJ8/GFdmEQ9Ug4FlE1ll1Y7jtiraqm5Fe04VV8lvSVBL8hiPrfFVd8+7QH3Qbu2ipTVi8cvSGivc9cj8yvH11YMHdNSERtuOslM97feYFOPKzGcsI4zW0YGAbTAOaxCnxdfiYUmVWslxiIblCeAYr9VYR1gM7GmoPrilunSxxeT3DN/2eBQ9H11+nk1adn6VK71+5+Jfct4/el10/7KBZfNryUunWSCPxPECk1rdOv1WVSrQmpC+Tl46YD3ikQYcpunSQgzVB2VHFhxHVGKDgMEY5GLlQnP7FMDzw7IacAWnO6sBr12u+XanW2AO0wQ8pknnFhsL7KYIqhkEPmEXFkwaN5KQphbkUmG72wgw7WSm9RiL9QT925hkjiVIIhphFS9HKI6/8QAjlpXqg9W2C0apyaVDwKQwrwLY3j6ADR13ZyUNByQXHQu6RY09Hu6zMqXRaNZGS/KEJs0cJEe9VH1QdvBSJv9h09eiRmy0V2uJcqHcShcdvbSNg5fxkenkVprXM9rDVnX24/y9MVtncvbKY706anNl3ASll9a43UiacVquXGhvq4s2FP62NGKfQLIQYu9q1WmdMfmUrDGt8eDS0cXozH/fjmUH6Jruvm50hBDSaEU/2Ru2LEN/dl006TSc/g7tfJERxGMsgDUEr104pfWH9lQaN+M4KWQjwZbVc2rZVNHsyHal23wZtIs2JJqtIc/WLXXRFCpJkfE9jvWlfFbsNQ9pP5ZBS0zKh4R0aMFj1IjTcTnvi0Zz2rt7NdvQb2mgbju1plsH8MmbnEk7KbK0b+wC2iy3aX3szW8xeZvDwET6hWZYwqTXSSG+wMETKum0Dq/q+x62gt2ua2ppAo309TRk9TPazfV3qL9H8z7uhGqGqxNVg/FKx0HBl9OVUORn8Q8Jx9gFttGQUDr3tzcXX9xGgN0EpzN9mdZ3GATtPhL+CjxFDmkeEU6x56kqZRusLzALXVqkCN7zMEcqwjmywDQ6OhyUe0Xao1Qpyncrg6wKp9XfWDsaZplElvQ/b3sdweeghorwBDlHzgk1JmMc/wiERICVy2VJFdMjFuLQSp3S0W3+sngt2njwNgLssFGVQdJ0tu0KH4ky1LW4yrbkuaA6Iy9oz/qEMMXMMDWyIHhsAyFZc2peV9hc7kiKvfULxCl9iddfRK1f8kk9qvbdOoBtOg7ZkOZ5MsGrSHsokgLXUp9y88smniwWyuFSIRVmjplga3yD8Uij5QS1ZiM4U3Qw5QlSm2bXjFe6jzzBFtpg+/YBbLAWG7OPynNjlCw65fukGNdkJRf7yM1fOxVzbxOJVocFoYIaGwH22mIQkrvu1E2nGuebxIgW9U9TSiukPGU+Lt++c3DJPKhyhEEbXCQLUpae2exiKy6tMPe9mDRBFCEMTWrtwxN8qvuGnt6MoihKWS5NSyBhbH8StXoAz8PLOrRgLtOT/+4vcu+7vDLnqNvztOq7fmd8sMmY9Xzn1zj8Dq8+XVdu2Nv0IIySgEdQo3xVHps3Q5i3fLFsV4aiqzAiBhbgMDEd1uh8qZZ+lwhjkgokkOIv4xNJmyncdfUUzgB4oFMBtiu71Xumpz/P+cfUP+SlwFExwWW62r7b+LSPxqxn/gvMZ5z9C16t15UbNlq+jbGJtco7p8wbYlL4alSyfWdeuu0j7JA3JFNuVAwtst7F7FhWBbPFNKIUORndWtLraFLmMu7KFVDDOzqkeaiN33YAW/r76wR4XDN/yN1z7hejPau06EddkS/6XThfcz1fI/4K736fO48vlxt2PXJYFaeUkFS8U15XE3428xdtn2kc8GQlf1vkIaNRRnOMvLTWrZbElEHeLWi1o0dlKPAh1MVgbbVquPJ5+Cr8LU5/H/+I2QlHIU2ClXM9G8v7Rr7oc/hozfUUgsPnb3D+I+7WF8kNO92GY0SNvuxiE+2Bt8prVJTkzE64sfOstxuwfxUUoyk8VjcTlsqe2qITSFoSj6Epd4KsT6BZOWmtgE3hBfir8IzZDwgV4ZTZvD8VvPHERo8v+vL1DASHTz/i9OlKueHDjK5Rnx/JB1Vb1ioXdBra16dmt7dgik10yA/FwJSVY6XjA3oy4SqM2frqDPPSRMex9qs3XQtoWxMj7/Er8GWYsXgjaVz4OYumP2+9kbxvny/6kvWsEBw+fcb5bInc8APdhpOSs01tEqIkoiZjbAqKMruLbJYddHuHFRIyJcbdEdbl2sVLaySygunutBg96Y2/JjKRCdyHV+AEFtTvIpbKIXOamknYSiB6KV/0JetZITgcjjk5ZdaskBtWO86UF0ap6ozGXJk2WNiRUlCPFir66lzdm/SLSuK7EUdPz8f1z29Skq6F1fXg8+5UVR6bszncP4Tn4KUkkdJ8UFCY1zR1i8RmL/qQL3rlei4THG7OODlnKko4oI01kd3CaM08Ia18kC3GNoVaO9iDh+hWxSyTXFABXoau7Q6q9OxYg/OVEMw6jdbtSrJ9cBcewGmaZmg+bvkUnUUaGr+ZfnMH45Ivevl61hMcXsxYLFTu1hTm2zViCp7u0o5l+2PSUh9bDj6FgYypufBDhqK2+oXkiuHFHR3zfj+9PtA8oR0xnqX8qn+sx3bFODSbbF0X8EUvWQ8jBIcjo5bRmLOljDNtcqNtOe756h3l0VhKa9hDd2l1eqmsnh0MNMT/Cqnx6BInumhLT8luljzQ53RiJeA/0dxe5NK0o2fA1+GLXr6eNQWHNUOJssQaTRlGpLHKL9fD+IrQzTOMZS9fNQD4AnRNVxvTdjC+fJdcDDWQcyB00B0t9BDwTxXgaAfzDZ/DBXzRnfWMFRwuNqocOmX6OKNkY63h5n/fFcB28McVHqnXZVI27K0i4rDLNE9lDKV/rT+udVbD8dFFu2GGZ8mOt0kAXcoX3ZkIWVtw+MNf5NjR2FbivROHmhV1/pj2egv/fMGIOWTIWrV3Av8N9imV9IWml36H6cUjqEWNv9aNc+veb2sH46PRaHSuMBxvtW+twxctq0z+QsHhux8Q7rCY4Ct8lqsx7c6Sy0dl5T89rIeEuZKoVctIk1hNpfavER6yyH1Vvm3MbsUHy4ab4hWr/OZPcsRBphnaV65/ZcdYPNNwsjN/djlf9NqCw9U5ExCPcdhKxUgLSmfROpLp4WSUr8ojdwbncbvCf+a/YzRaEc6QOvXcGO256TXc5Lab9POvB+AWY7PigWYjzhifbovuunzRawsO24ZqQQAqguBtmpmPB7ysXJfyDDaV/aPGillgz1MdQg4u5MYaEtBNNHFjkRlSpd65lp4hd2AVPTfbV7FGpyIOfmNc/XVsPfg7vzaS/3nkvLL593ANLvMuRMGpQIhiF7kUEW9QDpAUbTWYBcbp4WpacHHY1aacqQyjGZS9HI3yCBT9kUZJhVOD+zUDvEH9ddR11fzPcTDQ5TlgB0KwqdXSavk9BC0pKp0WmcuowSw07VXmXC5guzSa4p0UvRw2lbDiYUx0ExJJRzWzi6Gm8cnEkfXXsdcG/M/jAJa0+bmCgdmQ9CYlNlSYZOKixmRsgiFxkrmW4l3KdFKv1DM8tk6WxPYJZhUUzcd8Kdtgrw/gkfXXDT7+avmfVak32qhtkg6NVdUS5wgkru1YzIkSduTW1FDwVWV3JQVJVuieTc0y4iDpFwc7/BvSalvKdQM8sv662cevz/+8sQVnjVAT0W2wLllw1JiMhJRxgDjCjLQsOzSFSgZqx7lAW1JW0e03yAD3asC+GD3NbQhbe+mN5GXH1F83KDOM4n/e5JIuH4NpdQARrFPBVptUNcjj4cVMcFSRTE2NpR1LEYbYMmfWpXgP9KejaPsLUhuvLCsVXznAG9dfx9SR1ud/3hZdCLHb1GMdPqRJgqDmm76mHbvOXDtiO2QPUcKo/TWkQ0i2JFXpBoo7vij1i1Lp3ADAo+qvG3V0rM//vFnnTE4hxd5Ka/Cor5YEdsLVJyKtDgVoHgtW11pWSjolPNMnrlrVj9Fv2Qn60twMwKPqr+N/wvr8z5tZcDsDrv06tkqyzESM85Ycv6XBWA2birlNCXrI6VbD2lx2L0vQO0QVTVVLH4SE67fgsfVXv8n7sz7/85Z7cMtbE6f088wSaR4kCkCm10s6pKbJhfqiUNGLq+0gLWC6eUAZFPnLjwqtKd8EwGvWX59t7iPW4X/eAN1svgRVSY990YZg06BD1ohLMtyFTI4pKTJsS9xREq9EOaPWiO2gpms7397x6nQJkbh+Fz2q/rqRROX6/M8bJrqlVW4l6JEptKeUFuMYUbtCQ7CIttpGc6MY93x1r1vgAnRXvY5cvwWPqb9uWQm+lP95QxdNMeWhOq1x0Db55C7GcUv2ZUuN6n8iKzsvOxibC//Yfs9Na8r2Rlz02vXXDT57FP/zJi66/EJSmsJKa8QxnoqW3VLQ+jZVUtJwJ8PNX1NQCwfNgdhhHD9on7PdRdrdGPF28rJr1F+3LBdeyv+8yYfLoMYet1vX4upNAjVvwOUWnlNXJXlkzk5Il6kqeoiL0C07qno+/CYBXq/+utlnsz7/Mzvy0tmI4zm4ag23PRN3t/CWryoUVJGm+5+K8RJ0V8Hc88/XHUX/HfiAq7t+BH+x6v8t438enWmdJwFA6ZINriLGKv/95f8lT9/FnyA1NMVEvQyaXuu+gz36f/DD73E4pwqpLcvm/o0Vle78n//+L/NPvoefp1pTJye6e4A/D082FERa5/opeH9zpvh13cNm19/4v/LDe5xMWTi8I0Ta0qKlK27AS/v3/r+/x/2GO9K2c7kVMonDpq7//jc5PKCxeNPpFVzaRr01wF8C4Pu76hXuX18H4LduTr79guuFD3n5BHfI+ZRFhY8w29TYhbbLi/bvBdqKE4fUgg1pBKnV3FEaCWOWyA+m3WpORZr/j+9TKJtW8yBTF2/ZEODI9/QavHkVdGFp/Pjn4Q+u5hXapsP5sOH+OXXA1LiKuqJxiMNbhTkbdJTCy4llEt6NnqRT4dhg1V3nbdrm6dYMecA1yTOL4PWTE9L5VzPFlLBCvlG58AhehnN4uHsAYinyJ+AZ/NkVvELbfOBUuOO5syBIEtiqHU1k9XeISX5bsimrkUUhnGDxourN8SgUsCZVtKyGbyGzHXdjOhsAvOAswSRyIBddRdEZWP6GZhNK/yjwew9ehBo+3jEADu7Ay2n8mDc+TS7awUHg0OMzR0LABhqLD4hJEh/BEGyBdGlSJoXYXtr+3HS4ijzVpgi0paWXtdruGTknXBz+11qT1Q2inxaTzQCO46P3lfLpyS4fou2PH/PupwZgCxNhGlj4IvUuWEsTkqMWm6i4xCSMc9N1RDQoCVcuGItJ/MRWefais+3synowi/dESgJjkilnWnBTGvRWmaw8oR15257t7CHmCf8HOn7cwI8+NQBXMBEmAa8PMRemrNCEhLGEhDQKcGZWS319BX9PFBEwGTbRBhLbDcaV3drFcDqk5kCTd2JF1Wp0HraqBx8U0wwBTnbpCadwBA/gTH/CDrcCs93LV8E0YlmmcyQRQnjBa8JESmGUfIjK/7fkaDJpmD2QptFNVJU1bbtIAjjWQizepOKptRjbzR9Kag6xZmMLLjHOtcLT3Tx9o/0EcTT1XN3E45u24AiwEypDJXihKjQxjLprEwcmRKclaDNZCVqr/V8mYWyFADbusiY5hvgFoU2vio49RgJLn5OsReRFN6tabeetiiy0V7KFHT3HyZLx491u95sn4K1QQSPKM9hNT0wMVvAWbzDSVdrKw4zRjZMyJIHkfq1VAVCDl/bUhNKlGq0zGr05+YAceXVPCttVk0oqjVwMPt+BBefx4yPtGVkUsqY3CHDPiCM5ngupUwCdbkpd8kbPrCWHhkmtIKLEetF2499eS1jZlIPGYnlcPXeM2KD9vLS0bW3ktYNqUllpKLn5ZrsxlIzxvDu5eHxzGLctkZLEY4PgSOg2IUVVcUONzUDBEpRaMoXNmUc0tFZrTZquiLyKxrSm3DvIW9Fil+AkhXu5PhEPx9mUNwqypDvZWdKlhIJQY7vn2OsnmBeOWnYZ0m1iwbbw1U60by5om47iHRV6fOgzjMf/DAZrlP40Z7syxpLK0lJ0gqaAK1c2KQKu7tabTXkLFz0sCftuwX++MyNeNn68k5Buq23YQhUh0SNTJa1ioQ0p4nUG2y0XilF1JqODqdImloPS4Bp111DEWT0jJjVv95uX9BBV7eB3bUWcu0acSVM23YZdd8R8UbQUxJ9wdu3oMuhdt929ME+mh6JXJ8di2RxbTi6TbrDquqV4aUKR2iwT6aZbyOwEXN3DUsWr8Hn4EhwNyHuXHh7/pdaUjtR7vnDh/d8c9xD/s5f501eQ1+CuDiCvGhk1AN/4Tf74RfxPwD3toLarR0zNtsnPzmS64KIRk861dMWCU8ArasG9T9H0ZBpsDGnjtAOM2+/LuIb2iIUGXNgl5ZmKD/Tw8TlaAuihaFP5yrw18v4x1898zIdP+DDAX1bM3GAMvPgRP/cJn3zCW013nrhHkrITyvYuwOUkcHuKlRSW5C6rzIdY4ppnF7J8aAJbQepgbJYBjCY9usGXDKQxq7RZfh9eg5d1UHMVATRaD/4BHK93/1iAgYZ/+jqPn8Dn4UExmWrpa3+ZOK6MvM3bjwfzxNWA2dhs8+51XHSPJiaAhGSpWevEs5xHLXcEGFXYiCONySH3fPWq93JIsBiSWvWyc3CAN+EcXoT7rCSANloPPoa31rt/5PUA/gp8Q/jDD3hyrjzlR8VkanfOvB1XPubt17vzxAfdSVbD1pzAnfgyF3ycadOTOTXhpEUoLC1HZyNGW3dtmjeXgr2r56JNmRwdNNWaQVBddd6rh4MhviEB9EFRD/7RGvePvCbwAL4Mx/D6M541hHO4D3e7g6PafdcZVw689z7NGTwo5om7A8sPhccT6qKcl9NJl9aM/9kX+e59Hh1yPqGuCCZxuITcsmNaJ5F7d0q6J3H48TO1/+M57085q2icdu2U+W36Ldllz9Agiv4YGljoEN908EzvDOrBF98/vtJwCC/BF2AG75xxEmjmMIcjxbjoaxqOK3/4hPOZzhMPBpYPG44CM0dTVm1LjLtUWWVz1Bcf8tEx0zs8O2A2YVHRxKYOiy/aOVoAaMu0i7ubu43njjmd4ibMHU1sIDHaQNKrZND/FZYdk54oCXetjq7E7IVl9eAL7t+oHnwXXtLx44czzoRFHBztYVwtH1d+NOMkupZ5MTM+gUmq90X+Bh9zjRlmaQ+m7YMqUL/veemcecAtOJ0yq1JnVlN27di2E0+Klp1tAJ4KRw1eMI7aJjsO3R8kPSI3fUFXnIOfdQe86sIIVtWDL7h//Ok6vj8vwDk08NEcI8zz7OhBy+WwalzZeZ4+0XniRfst9pAJqQHDGLzVQ2pheZnnv1OWhwO43/AgcvAEXEVVpa4db9sGvNK8wjaENHkfFQ4Ci5i7dqnQlPoLQrHXZDvO3BIXZbJOBrOaEbML6sFL798I4FhKihjHMsPjBUZYCMFr6nvaArxqXPn4lCa+cHfSa2cP27g3Z3ziYTRrcbQNGLQmGF3F3cBdzzzX7AILx0IB9rbwn9kx2G1FW3Inic+ZLIsVvKR8Zwfj0l1fkqo8LWY1M3IX14OX3r9RKTIO+d9XzAI8qRPGPn/4NC2n6o4rN8XJ82TOIvuVA8zLKUHRFgBCetlDZlqR1gLKjS39xoE7Bt8UvA6BxuEDjU3tFsEijgA+615tmZkXKqiEENrh41iLDDZNq4pKTWR3LZfnos81LOuNa15cD956vLMsJd1rqYp51gDUQqMYm2XsxnUhD2jg1DM7SeuJxxgrmpfISSXVIJIS5qJJSvJPEQ49DQTVIbYWJ9QWa/E2+c/oPK1drmC7WSfJRNKBO5Yjvcp7Gc3dmmI/Xh1kDTEuiSnWqQf37h+fTMhGnDf6dsS8SQfQWlqqwXXGlc/PEZ/SC5mtzIV0nAshlQdM/LvUtYutrEZ/Y+EAFtq1k28zQhOwLr1AIeANzhF8t9qzTdZf2qRKO6MWE9ohBYwibbOmrFtNmg3mcS+tB28xv2uKd/agYCvOP+GkSc+0lr7RXzyufL7QbkUpjLjEWFLqOIkAGu2B0tNlO9Eau2W1qcOUvVRgKzypKIQZ5KI3q0MLzqTNRYqiZOqmtqloIRlmkBHVpHmRYV6/HixbO6UC47KOFJnoMrVyr7wYz+SlW6GUaghYbY1I6kkxA2W1fSJokUdSh2LQ1GAimRGm0MT+uu57H5l7QgOWxERpO9moLRPgTtquWCfFlGlIjQaRly9odmzMOWY+IBO5tB4sW/0+VWGUh32qYk79EidWKrjWuiLpiVNGFWFRJVktyeXWmbgBBzVl8anPuXyNJlBJOlKLTgAbi/EYHVHxWiDaVR06GnHQNpJcWcK2jJtiCfG2sEHLzuI66sGrMK47nPIInPnu799935aOK2cvmvubrE38ZzZjrELCmXM2hM7UcpXD2oC3+ECVp7xtIuxptJ0jUr3sBmBS47TVxlvJ1Sqb/E0uLdvLj0lLr29ypdd/eMX3f6lrxGlKwKQxEGvw0qHbkbwrF3uHKwVENbIV2wZ13kNEF6zD+x24aLNMfDTCbDPnEikZFyTNttxWBXDaBuM8KtI2rmaMdUY7cXcUPstqTGvBGSrFWIpNMfbdea990bvAOC1YX0qbc6smDS1mPxSJoW4fwEXvjMmhlijDRq6qale6aJEuFGoppYDoBELQzLBuh/mZNx7jkinv0EtnUp50lO9hbNK57lZaMAWuWR5Yo9/kYwcYI0t4gWM47Umnl3YmpeBPqSyNp3K7s2DSAS/39KRuEN2bS4xvowV3dFRMx/VFcp2Yp8w2nTO9hCXtHG1kF1L4KlrJr2wKfyq77R7MKpFKzWlY9UkhYxyHWW6nBWPaudvEAl3CGcNpSXPZ6R9BbBtIl6cHL3gIBi+42CYXqCx1gfGWe7Ap0h3luyXdt1MKy4YUT9xSF01G16YEdWsouW9mgDHd3veyA97H+Ya47ZmEbqMY72oPztCGvK0onL44AvgC49saZKkWRz4veWljE1FHjbRJaWv6ZKKtl875h4CziFCZhG5rx7tefsl0aRT1bMHZjm8dwL/6u7wCRysaQblQoG5yAQN5zpatMNY/+yf8z+GLcH/Qn0iX2W2oEfXP4GvwQHuIL9AYGnaO3zqAX6946nkgqZNnUhx43DIdQtMFeOPrgy/y3Yd85HlJWwjLFkU3kFwq28xPnuPhMWeS+tDLV9Otllq7pQCf3uXJDN9wFDiUTgefHaiYbdfi3b3u8+iY6TnzhgehI1LTe8lcd7s1wJSzKbahCRxKKztTLXstGAiu3a6rPuQs5pk9TWAan5f0BZmGf7Ylxzzk/A7PAs4QPPPAHeFQ2hbFHszlgZuKZsJcUmbDC40sEU403cEjczstOEypa+YxevL4QBC8oRYqWdK6b7sK25tfE+oDZgtOQ2Jg8T41HGcBE6fTWHn4JtHcu9S7uYgU5KSCkl/mcnq+5/YBXOEr6lCUCwOTOM1taOI8mSxx1NsCXBEmLKbMAg5MkwbLmpBaFOPrNSlO2HnLiEqW3tHEwd8AeiQLmn+2gxjC3k6AxREqvKcJbTEzlpLiw4rNZK6oJdidbMMGX9FULKr0AkW+2qDEPBNNm5QAt2Ik2nftNWHetubosHLo2nG4vQA7GkcVCgVCgaDixHqo9UUn1A6OshapaNR/LPRYFV8siT1cCtJE0k/3WtaNSuUZYKPnsVIW0xXWnMUxq5+En4Kvw/MqQmVXnAXj9Z+9zM98zM/Agy7F/qqj2Nh67b8HjFnPP3iBn/tkpdzwEJX/whIcQUXOaikeliCRGUk7tiwF0rItwMEhjkZ309hikFoRAmLTpEXWuHS6y+am/KB/fM50aLEhGnSMwkpxzOov4H0AvgovwJ1iGzDLtJn/9BU+fAINfwUe6FHSLhu83viV/+/HrOePX+STT2B9uWGbrMHHLldRBlhS/CJQmcRxJFqZica01XixAZsYiH1uolZxLrR/SgxVIJjkpQP4PE9sE59LKLr7kltSBogS5tyszzH8Fvw8/AS8rNOg0xUS9fIaHwb+6et8Q/gyvKRjf5OusOzGx8evA/BP4IP11uN/grca5O0lcsPLJ5YjwI4QkJBOHa0WdMZYGxPbh2W2nR9v3WxEWqgp/G3+6VZbRLSAAZ3BhdhAaUL33VUSw9yjEsvbaQ9u4A/gGXwZXoEHOuU1GSj2chf+Mo+f8IcfcAxfIKVmyunRbYQVnoevwgfw3TXXcw++xNuP4fhyueEUNttEduRVaDttddoP0eSxLe2LENk6itYxlrxBNBYrNNKSQmeaLcm9c8UsaB5WyO6675yyQIAWSDpBVoA/gxmcwEvwoDv0m58UE7gHn+fJOa8/Ywan8EKRfjsopF83eCglX/Sfr7OeaRoQfvt1CGvIDccH5BCvw1sWIzRGC/66t0VTcLZQZtm6PlAasbOJ9iwWtUo7biktTSIPxnR24jxP1ZKaqq+2RcXM9OrBAm/AAs7hDJ5bNmGb+KIfwCs8a3jnjBrOFeMjHSCdbKr+2uOLfnOd9eiA8Hvvwwq54VbP2OqwkB48Ytc4YEOiH2vTXqodabfWEOzso4qxdbqD5L6tbtNPECqbhnA708DZH4QOJUXqScmUlks7Ot6FBuZw3n2mEbaUX7kDzxHOOQk8nKWMzAzu6ZZ8sOFw4RK+6PcuXo9tB4SbMz58ApfKDXf3szjNIIbGpD5TKTRxGkEMLjLl+K3wlWXBsCUxIDU+jbOiysESqAy1MGUJpXgwbTWzNOVEziIXZrJ+VIztl1PUBxTSo0dwn2bOmfDRPD3TRTGlfbCJvO9KvuhL1hMHhB9wPuPRLGHcdOWG2xc0U+5bQtAJT0nRTewXL1pgk2+rZAdeWmz3jxAqfNQQdzTlbF8uJ5ecEIWvTkevAHpwz7w78QujlD/Lr491bD8/1vhM2yrUQRrWXNQY4fGilfctMWYjL72UL/qS9eiA8EmN88nbNdour+PBbbAjOjIa4iBhfFg6rxeKdEGcL6p3EWR1Qq2Qkhs2DrnkRnmN9tG2EAqmgPw6hoL7Oza7B+3SCrR9tRftko+Lsf2F/mkTndN2LmzuMcKTuj/mX2+4Va3ki16+nnJY+S7MefpkidxwnV+4wkXH8TKnX0tsYzYp29DOOoSW1nf7nTh2akYiWmcJOuTidSaqESrTYpwjJJNVGQr+rLI7WsqerHW6Kp/oM2pKuV7T1QY9gjqlZp41/WfKpl56FV/0kvXQFRyeQ83xaTu5E8p5dNP3dUF34ihyI3GSpeCsywSh22ZJdWto9winhqifb7VRvgktxp13vyjrS0EjvrRfZ62uyqddSWaWYlwTPAtJZ2oZ3j/Sgi/mi+6vpzesfAcWNA0n8xVyw90GVFGuZjTXEQy+6GfLGLMLL523f5E0OmxVjDoOuRiH91RKU+vtoCtH7TgmvBLvtFXWLW15H9GTdVw8ow4IlRLeHECN9ym1e9K0I+Cbnhgv4Yu+aD2HaQJ80XDqOzSGAV4+4yCqBxrsJAX6ZTIoX36QnvzhhzzMfFW2dZVLOJfo0zbce5OvwXMFaZ81mOnlTVXpDZsQNuoYWveketKb5+6JOOsgX+NTm7H49fUTlx+WLuWL7qxnOFh4BxpmJx0p2gDzA/BUARuS6phR+pUsY7MMboAHx5xNsSVfVZcYSwqCKrqon7zM+8ecCkeS4nm3rINuaWvVNnMRI1IRpxTqx8PZUZ0Br/UEduo3B3hNvmgZfs9gQPj8vIOxd2kndir3awvJ6BLvoUuOfFWNYB0LR1OQJoUySKb9IlOBx74q1+ADC2G6rOdmFdJcD8BkfualA+BdjOOzP9uUhGUEX/TwhZsUduwRr8wNuXKurCixLBgpQI0mDbJr9dIqUuV+92ngkJZ7xduCk2yZKbfWrH1VBiTg9VdzsgRjW3CVXCvAwDd+c1z9dWw9+B+8MJL/eY15ZQ/HqvTwVdsZn5WQsgRRnMaWaecu3jFvMBEmgg+FJFZsnSl0zjB9OqPYaBD7qmoVyImFvzi41usesV0julaAR9dfR15Xzv9sEruRDyk1nb+QaLU67T885GTls6YgcY+UiMa25M/pwGrbCfzkvR3e0jjtuaFtnwuagHTSb5y7boBH119HXhvwP487jJLsLJ4XnUkHX5sLbS61dpiAXRoZSCrFJ+EjpeU3puVfitngYNo6PJrAigKktmwjyQdZpfq30mmtulaAx9Zfx15Xzv+cyeuiBFUs9zq8Kq+XB9a4PVvph3GV4E3y8HENJrN55H1X2p8VyqSKwVusJDKzXOZzplWdzBUFK9e+B4+uv468xvI/b5xtSAkBHQaPvtqWzllVvEOxPbuiE6+j2pvjcKsbvI7txnRErgfH7LdXqjq0IokKzga14GzQ23SSbCQvO6r+Or7SMIr/efOkkqSdMnj9mBx2DRsiY29Uj6+qK9ZrssCKaptR6HKURdwUYeUWA2kPzVKQO8ku2nU3Anhs/XWkBx3F/7wJtCTTTIKftthue1ty9xvNYLY/zo5KSbIuKbXpbEdSyeRyYdAIwKY2neyoc3+k1XUaufYga3T9daMUx/r8z1s10ITknIO0kuoMt+TB8jK0lpayqqjsJ2qtXAYwBU932zinimgmd6mTRDnQfr88q36NAI+tv24E8Pr8zxtasBqx0+xHH9HhlrwsxxNUfKOHQaZBITNf0uccj8GXiVmXAuPEAKSdN/4GLHhs/XWj92dN/uetNuBMnVR+XWDc25JLjo5Mg5IZIq226tmCsip2zZliL213YrTlL2hcFjpCduyim3M7/eB16q/blQsv5X/esDRbtJeabLIosWy3ycavwLhtxdWzbMmHiBTiVjJo6lCLjXZsi7p9PEPnsq6X6wd4bP11i0rD5fzPm/0A6brrIsllenZs0lCJlU4abakR59enZKrKe3BZihbTxlyZ2zl1+g0wvgmA166/bhwDrcn/7Ddz0eWZuJvfSESug6NzZsox3Z04FIxz0mUjMwVOOVTq1CQ0AhdbBGVdjG/CgsfUX7esJl3K/7ytWHRv683praW/8iDOCqWLLhpljDY1ZpzK75QiaZoOTpLKl60auHS/97oBXrv+umU9+FL+5+NtLFgjqVLCdbmj7pY5zPCPLOHNCwXGOcLquOhi8CmCWvbcuO73XmMUPab+ug3A6/A/78Bwe0bcS2+tgHn4J5pyS2WbOck0F51Vq3LcjhLvZ67p1ABbaL2H67bg78BfjKi/jr3+T/ABV3ilLmNXTI2SpvxWBtt6/Z//D0z/FXaGbSBgylzlsEGp+5//xrd4/ae4d8DUUjlslfIYS3t06HZpvfQtvv0N7AHWqtjP2pW08QD/FLy//da38vo8PNlKHf5y37Dxdfe/oj4kVIgFq3koLReSR76W/bx//n9k8jonZxzWTANVwEniDsg87sOSd/z7//PvMp3jQiptGVWFX2caezzAXwfgtzYUvbr0iozs32c3Uge7varH+CNE6cvEYmzbPZ9hMaYDdjK4V2iecf6EcEbdUDVUARda2KzO/JtCuDbNQB/iTeL0EG1JSO1jbXS+nLxtPMDPw1fh5+EPrgSEKE/8Gry5A73ui87AmxwdatyMEBCPNOCSKUeRZ2P6Myb5MRvgCHmA9ywsMifU+AYXcB6Xa5GibUC5TSyerxyh0j6QgLVpdyhfArRTTLqQjwe4HOD9s92D4Ap54odXAPBWLAwB02igG5Kkc+piN4lvODIFGAZgT+EO4Si1s7fjSR7vcQETUkRm9O+MXyo9OYhfe4xt9STQ2pcZRLayCV90b4D3jR0DYAfyxJ+eywg2IL7NTMXna7S/RpQ63JhWEM8U41ZyQGjwsVS0QBrEKLu8xwZsbi4wLcCT+OGidPIOCe1PiSc9Qt+go+vYqB7cG+B9d8cAD+WJPz0Am2gxXgU9IneOqDpAAXOsOltVuMzpdakJXrdPCzXiNVUpCeOos5cxnpQT39G+XVLhs1osQVvJKPZyNq8HDwd4d7pNDuWJPxVX7MSzqUDU6gfadKiNlUFTzLeFHHDlzO4kpa7aiKhBPGKwOqxsBAmYkOIpipyXcQSPlRTf+Tii0U3EJGaZsDER2qoB3h2hu0qe+NNwUooYU8y5mILbJe6OuX+2FTKy7bieTDAemaQyQ0CPthljSWO+xmFDIYiESjM5xKd6Ik5lvLq5GrQ3aCMLvmCA9wowLuWJb9xF59hVVP6O0CrBi3ZjZSNOvRy+I6klNVRJYRBaEzdN+imiUXQ8iVF8fsp+W4JXw7WISW7fDh7lptWkCwZ4d7QTXyBPfJMYK7SijjFppGnlIVJBJBYj7eUwtiP1IBXGI1XCsjNpbjENVpSAJ2hq2LTywEly3hUYazt31J8w2+aiLx3g3fohXixPfOMYm6zCGs9LVo9MoW3MCJE7R5u/WsOIjrqBoHUO0bJE9vxBpbhsd3+Nb4/vtPCZ4oZYCitNeYuC/8UDvDvy0qvkiW/cgqNqRyzqSZa/s0mqNGjtKOoTm14zZpUauiQgVfqtQiZjq7Q27JNaSK5ExRcrGCXO1FJYh6jR6CFqK7bZdQZ4t8g0rSlPfP1RdBtqaa9diqtzJkQ9duSryi2brQXbxDwbRUpFMBHjRj8+Nt7GDKgvph9okW7LX47gu0SpGnnFQ1S1lYldOsC7hYteR574ZuKs7Ei1lBsfdz7IZoxzzCVmmVqaSySzQbBVAWDek+N4jh9E/4VqZrJjPwiv9BC1XcvOWgO8275CVyBPvAtTVlDJfZkaZGU7NpqBogAj/xEHkeAuJihWYCxGN6e8+9JtSegFXF1TrhhLGP1fak3pebgPz192/8gB4d/6WT7+GdYnpH7hH/DJzzFiYPn/vjW0SgNpTNuPIZoAEZv8tlGw4+RLxy+ZjnKa5NdFoC7UaW0aduoYse6+bXg1DLg6UfRYwmhGEjqPvF75U558SANrElK/+MdpXvmqBpaXOa/MTZaa1DOcSiLaw9j0NNNst3c+63c7EKTpkvKHzu6bPbP0RkuHAVcbRY8ijP46MIbQeeT1mhA+5PV/inyDdQipf8LTvMXbwvoDy7IruDNVZKTfV4CTSRUYdybUCnGU7KUTDxLgCknqUm5aAW6/1p6eMsOYsphLzsHrE0Y/P5bQedx1F/4yPHnMB3/IOoTU9+BL8PhtjuFKBpZXnYNJxTuv+2XqolKR2UQgHhS5novuxVySJhBNRF3SoKK1XZbbXjVwWNyOjlqWJjrWJIy+P5bQedyldNScP+HZ61xKSK3jyrz+NiHG1hcOLL/+P+PDF2gOkekKGiNWKgJ+8Z/x8Iv4DdQHzcpZyF4v19I27w9/yPGDFQvmEpKtqv/TLiWMfn4sofMm9eAH8Ao0zzh7h4sJqYtxZd5/D7hkYPneDzl5idlzNHcIB0jVlQ+8ULzw/nc5/ojzl2juE0apD7LRnJxe04dMz2iOCFNtGFpTuXA5AhcTRo8mdN4kz30nVjEC4YTZQy4gpC7GlTlrePKhGsKKgeXpCYeO0MAd/GH7yKQUlXPLOasOH3FnSphjHuDvEu4gB8g66oNbtr6eMbFIA4fIBJkgayoXriw2XEDQPJrQeROAlY6aeYOcMf+IVYTU3XFlZufMHinGywaW3YLpObVBAsbjF4QJMsVUSayjk4voPsHJOQfPWDhCgDnmDl6XIRerD24HsGtw86RMHOLvVSHrKBdeVE26gKB5NKHzaIwLOmrqBWJYZDLhASG16c0Tn+CdRhWDgWXnqRZUTnPIHuMJTfLVpkoYy5CzylHVTGZMTwkGAo2HBlkQplrJX6U+uF1wZz2uwS1SQ12IqWaPuO4baZaEFBdukksJmkcTOm+YJSvoqPFzxFA/YUhIvWxcmSdPWTWwbAKVp6rxTtPFUZfKIwpzm4IoMfaYQLWgmlG5FME2gdBgm+J7J+rtS/XBbaVLsR7bpPQnpMFlo2doWaVceHk9+MkyguZNCJ1He+kuHTWyQAzNM5YSUg/GlTk9ZunAsg1qELVOhUSAK0LABIJHLKbqaEbHZLL1VA3VgqoiOKXYiS+HRyaEKgsfIqX64HYWbLRXy/qWoylIV9gudL1OWBNgBgTNmxA6b4txDT4gi3Ri7xFSLxtXpmmYnzAcWDZgY8d503LFogz5sbonDgkKcxGsWsE1OI+rcQtlgBBCSOKD1mtqYpIU8cTvBmAT0yZe+zUzeY92fYjTtGipXLhuR0ePoHk0ofNWBX+lo8Z7pAZDk8mEw5L7dVyZZoE/pTewbI6SNbiAL5xeygW4xPRuLCGbhcO4RIeTMFYHEJkYyEO9HmJfXMDEj/LaH781wHHZEtqSQ/69UnGpzH7LKIAZEDSPJnTesJTUa+rwTepI9dLJEawYV+ZkRn9g+QirD8vF8Mq0jFQ29js6kCS3E1+jZIhgPNanHdHFqFvPJLHqFwQqbIA4jhDxcNsOCCQLDomaL/dr5lyJaJU6FxPFjO3JOh3kVMcROo8u+C+jo05GjMF3P3/FuDLn5x2M04xXULPwaS6hBYki+MrMdZJSgPHlcB7nCR5bJ9Kr5ACUn9jk5kivdd8tk95SOGrtqu9lr2IhK65ZtEl7ZKrp7DrqwZfRUSN1el7+7NJxZbywOC8neNKTch5vsTEMNsoCCqHBCqIPRjIPkm0BjvFODGtto99rCl+d3wmHkW0FPdpZtC7MMcVtGFQjJLX5bdQ2+x9ypdc313uj8xlsrfuLgWXz1cRhZvJYX0iNVBRcVcmCXZs6aEf3RQF2WI/TcCbKmGU3IOoDJGDdDub0+hYckt6PlGu2BcxmhbTdj/klhccLGJMcqRjMJP1jW2ETqLSWJ/29MAoORluJ+6LPffBZbi5gqi5h6catQpmOT7/OFf5UorRpLzCqcMltBLhwd1are3kztrSzXO0LUbXRQcdLh/RdSZ+swRm819REDrtqzC4es6Gw4JCKlSnjYVpo0xeq33PrADbFLL3RuCmObVmPN+24kfa+AojDuM4umKe2QwCf6EN906HwjujaitDs5o0s1y+k3lgbT2W2i7FJdnwbLXhJUBq/9liTctSmFC/0OqUinb0QddTWamtjbHRFuWJJ6NpqZ8vO3fZJ37Db+2GkaPYLGHs7XTTdiFQJ68SkVJFVmY6McR5UycflNCsccHFaV9FNbR4NttLxw4pQ7wJd066Z0ohVbzihaxHVExd/ay04oxUKWt+AsdiQ9OUyZ2krzN19IZIwafSTFgIBnMV73ADj7V/K8u1MaY2sJp2HWm0f41tqwajEvdHWOJs510MaAqN4aoSiPCXtN2KSi46dUxHdaMquar82O1x5jqhDGvqmoE9LfxcY3zqA7/x3HA67r9ZG4O6Cuxu12/+TP+eLP+I+HErqDDCDVmBDO4larujNe7x8om2rMug0MX0rL1+IWwdwfR+p1TNTyNmVJ85ljWzbWuGv8/C7HD/izjkHNZNYlhZcUOKVzKFUxsxxN/kax+8zPWPSFKw80rJr9Tizyj3o1gEsdwgWGoxPezDdZ1TSENE1dLdNvuKL+I84nxKesZgxXVA1VA1OcL49dFlpFV5yJMhzyCmNQ+a4BqusPJ2bB+xo8V9u3x48VVIEPS/mc3DvAbXyoYr6VgDfh5do5hhHOCXMqBZUPhWYbWZECwVJljLgMUWOCB4MUuMaxGNUQDVI50TQ+S3kFgIcu2qKkNSHVoM0SHsgoZxP2d5HH8B9woOk4x5bPkKtAHucZsdykjxuIpbUrSILgrT8G7G5oCW+K0990o7E3T6AdW4TilH5kDjds+H64kS0mz24grtwlzDHBJqI8YJQExotPvoC4JBq0lEjjQkyBZ8oH2LnRsQ4Hu1QsgDTJbO8fQDnllitkxuVskoiKbRF9VwzMDvxHAdwB7mD9yCplhHFEyUWHx3WtwCbSMMTCUCcEmSGlg4gTXkHpZXWQ7kpznK3EmCHiXInqndkQjunG5kxTKEeGye7jWz9cyMR2mGiFQ15ENRBTbCp+Gh86vAyASdgmJq2MC6hoADQ3GosP0QHbnMHjyBQvQqfhy/BUbeHd5WY/G/9LK/8Ka8Jd7UFeNWEZvzPb458Dn8DGLOe3/wGL/4xP+HXlRt+M1PE2iLhR8t+lfgxsuh7AfO2AOf+owWhSZRYQbd622hbpKWKuU+XuvNzP0OseRDa+mObgDHJUSc/pKx31QdKffQ5OIJpt8GWjlgTwMc/w5MPCR/yl1XC2a2Yut54SvOtMev55Of45BOat9aWG27p2ZVORRvnEk1hqWMVUmqa7S2YtvlIpspuF1pt0syuZS2NV14mUidCSfzQzg+KqvIYCMljIx2YK2AO34fX4GWdu5xcIAb8MzTw+j/lyWM+Dw/gjs4GD6ehNgA48kX/AI7XXM/XAN4WHr+9ntywqoCakCqmKP0rmQrJJEErG2Upg1JObr01lKQy4jskWalKYfJ/EDLMpjNSHFEUAde2fltaDgmrNaWQ9+AAb8I5vKjz3L1n1LriB/BXkG/wwR9y/oRX4LlioHA4LzP2inzRx/DWmutRweFjeP3tNeSGlaE1Fde0OS11yOpmbIp2u/jF1n2RRZviJM0yBT3IZl2HWImKjQOxIyeU325b/qWyU9Moj1o07tS0G7qJDoGHg5m8yeCxMoEH8GU45tnrNM84D2l297DQ9t1YP7jki/7RmutRweEA77/HWXOh3HCxkRgldDQkAjNTMl2Iloc1qN5JfJeeTlyTRzxURTdn1Ixv2uKjs12AbdEWlBtmVdk2k7FFwj07PCZ9XAwW3dG+8xKzNFr4EnwBZpy9Qzhh3jDXebBpYcpuo4fQ44u+fD1dweEnHzI7v0xuuOALRUV8rXpFyfSTQYkhd7IHm07jpyhlkCmI0ALYqPTpUxXS+z4jgDj1Pflvmz5ecuItpIBxyTHpSTGWd9g1ApfD/bvwUhL4nT1EzqgX7cxfCcNmb3mPL/qi9SwTHJ49oj5ZLjccbTG3pRmlYi6JCG0mQrAt1+i2UXTZ2dv9IlQpN5naMYtviaXlTrFpoMsl3bOAFEa8sqPj2WCMrx3Yjx99qFwO59Aw/wgx+HlqNz8oZvA3exRDvuhL1jMQHPaOJ0+XyA3fp1OfM3qObEVdhxjvynxNMXQV4+GJyvOEFqeQBaIbbO7i63rpxCltdZShPFxkjM2FPVkn3TG+Rp9pO3l2RzFegGfxGDHIAh8SteR0C4HopXzRF61nheDw6TFN05Ebvq8M3VKKpGjjO6r7nhudTEGMtYM92HTDaR1FDMXJ1eThsbKfywyoWwrzRSXkc51flG3vIid62h29bIcFbTGhfV+faaB+ohj7dPN0C2e2lC96+XouFByen9AsunLDJZ9z7NExiUc0OuoYW6UZkIyx2YUR2z6/TiRjyKMx5GbbjLHvHuf7YmtKghf34LJfx63Yg8vrvN2zC7lY0x0tvKezo4HmGYDU+Gab6dFL+KI761lDcNifcjLrrr9LWZJctG1FfU1uwhoQE22ObjdfkSzY63CbU5hzs21WeTddH2BaL11Gi7lVdlxP1nkxqhnKhVY6knS3EPgVGg1JpN5cP/hivujOelhXcPj8HC/LyI6MkteVjlolBdMmF3a3DbsuAYhL44dxzthWSN065xxUd55Lmf0wRbOYOqH09/o9WbO2VtFdaMb4qBgtFJoT1SqoN8wPXMoXLb3p1PUEhxfnnLzGzBI0Ku7FxrKsNJj/8bn/H8fPIVOd3rfrklUB/DOeO+nkghgSPzrlPxluCMtOnDL4Yml6dK1r3vsgMxgtPOrMFUZbEUbTdIzii5beq72G4PD0DKnwjmBULUVFmy8t+k7fZ3pKc0Q4UC6jpVRqS9Umv8bxw35flZVOU1X7qkjnhZlsMbk24qQ6Hz7QcuL6sDC0iHHki96Uh2UdvmgZnjIvExy2TeJdMDZNSbdZyAHe/Yd1xsQhHiKzjh7GxQ4yqMPaywPkjMamvqrYpmO7Knad+ZQC5msCuAPWUoxrxVhrGv7a+KLXFhyONdTMrZ7ke23qiO40ZJUyzgYyX5XyL0mV7NiUzEs9mjtbMN0dERqwyAJpigad0B3/zRV7s4PIfXSu6YV/MK7+OrYe/JvfGMn/PHJe2fyUdtnFrKRNpXV0Y2559aWPt/G4BlvjTMtXlVIWCnNyA3YQBDmYIodFz41PvXPSa6rq9lWZawZ4dP115HXV/M/tnFkkrBOdzg6aP4pID+MZnTJ1SuuB6iZlyiox4HT2y3YBtkUKWooacBQUDTpjwaDt5poBHl1/HXltwP887lKKXxNUEyPqpGTyA699UqY/lt9yGdlUKra0fFWS+36iylVWrAyd7Uw0CZM0z7xKTOduznLIjG2Hx8cDPLb+OvK6Bv7n1DYci4CxUuRxrjBc0bb4vD3rN5Zz36ntLb83eVJIB8LiIzCmn6SMPjlX+yNlTjvIGjs+QzHPf60Aj62/jrzG8j9vYMFtm1VoRWCJdmw7z9N0t+c8cxZpPeK4aTRicS25QhrVtUp7U578chk4q04Wx4YoQSjFryUlpcQ1AbxZ/XVMknIU//OGl7Q6z9Zpxi0+3yFhSkjUDpnCIUhLWVX23KQ+L9vKvFKI0ZWFQgkDLvBoylrHNVmaw10zwCPrr5tlodfnf94EWnQ0lFRWy8pW9LbkLsyUVDc2NSTHGDtnD1uMtchjbCeb1mpxFP0YbcClhzdLu6lfO8Bj6q+bdT2sz/+8SZCV7VIxtt0DUn9L7r4cLYWDSXnseEpOGFuty0qbOVlS7NNzs5FOGJUqQpl2Q64/yBpZf90sxbE+//PGdZ02HSipCbmD6NItmQ4Lk5XUrGpDMkhbMm2ZVheNYV+VbUWTcv99+2NyX1VoafSuC+AN6q9bFIMv5X/eagNWXZxEa9JjlMwNWb00akGUkSoepp1/yRuuqHGbUn3UdBSTxBU6SEVklzWRUkPndVvw2PrrpjvxOvzPmwHc0hpmq82npi7GRro8dXp0KXnUQmhZbRL7NEVp1uuZmO45vuzKsHrktS3GLWXODVjw+vXXLYx4Hf7njRPd0i3aoAGX6W29GnaV5YdyDj9TFkakje7GHYzDoObfddHtOSpoi2SmzJHrB3hM/XUDDEbxP2/oosszcRlehWXUvzHv4TpBVktHqwenFo8uLVmy4DKLa5d3RtLrmrM3aMFr1183E4sewf+85VWeg1c5ag276NZrM9IJVNcmLEvDNaV62aq+14IAOGFsBt973Ra8Xv11YzXwNfmft7Jg2oS+XOyoC8/cwzi66Dhmgk38kUmP1CUiYWOX1bpD2zWXt2FCp7uq8703APAa9dfNdscR/M/bZLIyouVxqJfeWvG9Je+JVckHQ9+CI9NWxz+blX/KYYvO5n2tAP/vrlZ7+8/h9y+9qeB/Hnt967e5mevX10rALDWK//FaAT5MXdBXdP0C/BAes792c40H+AiAp1e1oH8HgH94g/Lttx1gp63op1eyoM/Bvw5/G/7xFbqJPcCXnmBiwDPb/YKO4FX4OjyCb289db2/Noqicw4i7N6TVtoz8tNwDH+8x/i6Ae7lmaQVENzJFb3Di/BFeAwz+Is9SjeQySpPqbLFlNmyz47z5a/AF+AYFvDmHqibSXTEzoT4Gc3OALaqAP4KPFUJ6n+1x+rGAM6Zd78bgJ0a8QN4GU614vxwD9e1Amy6CcskNrczLx1JIp6HE5UZD/DBHrFr2oNlgG4Odv226BodoryjGJ9q2T/AR3vQrsOCS0ctXZi3ruLlhpFDJYl4HmYtjQCP9rhdn4suySLKDt6wLcC52h8xPlcjju1fn+yhuw4LZsAGUuo2b4Fx2UwQu77uqRHXGtg92aN3tQCbFexc0uk93vhTXbct6y7MulLycoUljx8ngDMBg1tvJjAazpEmOtxlzclvj1vQf1Tx7QlPDpGpqgtdSKz/d9/hdy1vTfFHSmC9dGDZbLiezz7Ac801HirGZsWjydfZyPvHXL/Y8Mjzg8BxTZiuwKz4Eb8sBE9zznszmjvFwHKPIWUnwhqfVRcd4Ck0K6ate48m1oOfrX3/yOtvAsJ8zsPAM89sjnddmuLuDPjX9Bu/L7x7xpMzFk6nWtyQfPg278Gn4Aekz2ZgOmU9eJ37R14vwE/BL8G3aibCiWMWWDQ0ZtkPMnlcGeAu/Ag+8ZyecU5BPuy2ILD+sQqyZhAKmn7XZd+jIMTN9eBL7x95xVLSX4On8EcNlXDqmBlqS13jG4LpmGbkF/0CnOi3H8ETOIXzmnmtb0a16Tzxj1sUvQCBiXZGDtmB3KAefPH94xcUa/6vwRn80GOFyjEXFpba4A1e8KQfFF+259tx5XS4egYn8fQsLGrqGrHbztr+uByTahWuL1NUGbDpsnrwBfePPwHHIf9X4RnM4Z2ABWdxUBlqQ2PwhuDxoS0vvqB1JzS0P4h2nA/QgTrsJFn+Y3AOjs9JFC07CGWX1oNX3T/yHOzgDjwPn1PM3g9Jk9lZrMEpxnlPmBbjyo2+KFXRU52TJM/2ALcY57RUzjObbjqxVw++4P6RAOf58pcVsw9Daje3htriYrpDOonre3CudSe6bfkTEgHBHuDiyu5MCsc7BHhYDx7ePxLjqigXZsw+ijMHFhuwBmtoTPtOxOrTvYJDnC75dnUbhfwu/ZW9AgYd+peL68HD+0emKquiXHhWjJg/UrkJYzuiaL3E9aI/ytrCvAd4GcYZMCkSQxfUg3v3j8c4e90j5ZTPdvmJJGHnOCI2nHS8081X013pHuBlV1gB2MX1YNmWLHqqGN/TWmG0y6clJWthxNUl48q38Bi8vtMKyzzpFdSDhxZ5WBA5ZLt8Jv3895DduBlgbPYAj8C4B8hO68FDkoh5lydC4FiWvBOVqjYdqjiLv92t8yPDjrDaiHdUD15qkSURSGmXJwOMSxWAXYwr3zaAufJ66l+94vv3AO+vPcD7aw/w/toDvL/2AO+vPcD7aw/wHuD9tQd4f+0B3l97gPfXHuD9tQd4f+0B3l97gG8LwP8G/AL8O/A5OCq0Ys2KIdv/qOIXG/4mvFAMF16gZD+2Xvu/B8as5+8bfllWyg0zaNO5bfXj6vfhhwD86/Aq3NfRS9t9WPnhfnvCIw/CT8GLcFTMnpntdF/z9V+PWc/vWoIH+FL3Znv57PitcdGP4R/C34avw5fgRVUInCwbsn1yyA8C8zm/BH8NXoXnVE6wVPjdeCI38kX/3+Ct9dbz1pTmHFRu+Hm4O9Ch3clr99negxfwj+ER/DR8EV6B5+DuQOnTgUw5rnkY+FbNU3gNXh0o/JYTuWOvyBf9FvzX663HH/HejO8LwAl8Hl5YLTd8q7sqA3wbjuExfAFegQdwfyDoSkWY8swzEf6o4Qyewefg+cHNbqMQruSL/u/WWc+E5g7vnnEXgDmcDeSGb/F4cBcCgT+GGRzDU3hZYburAt9TEtHgbM6JoxJ+6NMzzTcf6c2bycv2+KK/f+l6LBzw5IwfqZJhA3M472pWT/ajKxnjv4AFnMEpnBTPND6s2J7qHbPAqcMK74T2mZ4VGB9uJA465It+/eL1WKhYOD7xHOkr1ajK7d0C4+ke4Hy9qXZwpgLr+Znm/uNFw8xQOSy8H9IzjUrd9+BIfenYaylf9FsXr8fBAadnPIEDna8IBcwlxnuA0/Wv6GAWPd7dDIKjMdSWueAsBj4M7TOd06qBbwDwKr7oleuxMOEcTuEZTHWvDYUO7aHqAe0Bbq+HEFRzOz7WVoTDQkVds7A4sIIxfCQdCefFRoIOF/NFL1mPab/nvOakSL/Q1aFtNpUb/nFOVX6gzyg/1nISyDfUhsokIzaBR9Kxm80s5mK+6P56il1jXic7nhQxsxSm3OwBHl4fFdLqi64nDQZvqE2at7cWAp/IVvrN6/BFL1mPhYrGMBfOi4PyjuSGf6wBBh7p/FZTghCNWGgMzlBbrNJoPJX2mW5mwZfyRffXo7OFi5pZcS4qZUrlViptrXtw+GQoyhDPS+ANjcGBNRiLCQDPZPMHuiZfdFpPSTcQwwKYdRNqpkjm7AFeeT0pJzALgo7g8YYGrMHS0iocy+YTm2vyRUvvpXCIpQ5pe666TJrcygnScUf/p0NDs/iAI/nqDHC8TmQT8x3NF91l76oDdQGwu61Z6E0ABv7uO1dbf/37Zlv+Zw/Pbh8f1s4Avur6657/+YYBvur6657/+YYBvur6657/+YYBvur6657/+aYBvuL6657/+VMA8FXWX/f8zzcN8BXXX/f8zzcNMFdbf93zP38KLPiK6697/uebtuArrr/u+Z9vGmCusP6653/+1FjwVdZf9/zPN7oHX339dc//fNMu+irrr3v+50+Bi+Zq6697/uebA/jz8Pudf9ht/fWv517J/XUzAP8C/BAeX9WCDrUpZ3/dEMBxgPcfbtTVvsYV5Yn32u03B3Ac4P3b8I+vxNBKeeL9dRMAlwO83959qGO78sT769oB7g3w/vGVYFzKE++v6wV4OMD7F7tckFkmT7y/rhHgpQO8b+4Y46XyxPvrugBeNcB7BRiX8sT767oAvmCA9woAHsoT76+rBJjLBnh3txOvkifeX1dswZcO8G6N7sXyxPvr6i340gHe3TnqVfLE++uKAb50gHcXLnrX8sR7gNdPRqwzwLu7Y/FO5Yn3AK9jXCMGeHdgxDuVJ75VAI8ljP7PAb3/RfjcZfePHBB+79dpfpH1CanN30d+mT1h9GqAxxJGM5LQeeQ1+Tb+EQJrElLb38VHQ94TRq900aMIo8cSOo+8Dp8QfsB8zpqE1NO3OI9Zrj1h9EV78PqE0WMJnUdeU6E+Jjyk/hbrEFIfeWbvId8H9oTRFwdZaxJGvziW0Hn0gqYB/wyZ0PwRlxJST+BOw9m77Amj14ii1yGM/txYQudN0qDzGe4EqfA/5GJCagsHcPaEPWH0esekSwmjRxM6b5JEcZ4ww50ilvAOFxBSx4yLW+A/YU8YvfY5+ALC6NGEzhtmyZoFZoarwBLeZxUhtY4rc3bKnjB6TKJjFUHzJoTOozF2YBpsjcyxDgzhQ1YRUse8+J4wenwmaylB82hC5w0zoRXUNXaRBmSMQUqiWSWkLsaVqc/ZE0aPTFUuJWgeTei8SfLZQeMxNaZSIzbII4aE1Nmr13P2hNHjc9E9guYNCZ032YlNwESMLcZiLQHkE4aE1BFg0yAR4z1h9AiAGRA0jyZ03tyIxWMajMPWBIsxYJCnlITU5ShiHYdZ94TR4wCmSxg9jtB5KyPGYzymAYexWEMwAPIsAdYdV6aObmNPGD0aYLoEzaMJnTc0Ygs+YDw0GAtqxBjkuP38bMRWCHn73xNGjz75P73WenCEJnhwyVe3AEe8TtKdJcYhBl97wuhNAObK66lvD/9J9NS75v17wuitAN5fe4D31x7g/bUHeH/tAd5fe4D3AO+vPcD7aw/w/toDvL/2AO+vPcD7aw/w/toDvAd4f/24ABzZ8o+KLsSLS+Pv/TqTb3P4hKlQrTGh+fbIBT0Axqznnb+L/V2mb3HkN5Mb/nEHeK7d4IcDld6lmDW/iH9E+AH1MdOw/Jlu2T1xNmY98sv4wHnD7D3uNHu54WUuOsBTbQuvBsPT/UfzNxGYzwkP8c+Yz3C+r/i6DcyRL/rZ+utRwWH5PmfvcvYEt9jLDS/bg0/B64DWKrQM8AL8FPwS9beQCe6EMKNZYJol37jBMy35otdaz0Bw2H/C2Smc7+WGB0HWDELBmOByA3r5QONo4V+DpzR/hFS4U8wMW1PXNB4TOqYz9urxRV++ntWCw/U59Ty9ebdWbrgfRS9AYKKN63ZokZVygr8GZ/gfIhZXIXPsAlNjPOLBby5c1eOLvmQ9lwkOy5x6QV1j5TYqpS05JtUgUHUp5toHGsVfn4NX4RnMCe+AxTpwmApTYxqMxwfCeJGjpXzRF61nbcHhUBPqWze9svwcHJ+S6NPscKrEjug78Dx8Lj3T8D4YxGIdxmJcwhi34fzZUr7olevZCw5vkOhoClq5zBPZAnygD/Tl9EzDh6kl3VhsHYcDEb+hCtJSvuiV69kLDm+WycrOTArHmB5/VYyP6jOVjwgGawk2zQOaTcc1L+aLXrKeveDwZqlKrw8U9Y1p66uK8dEzdYwBeUQAY7DbyYNezBfdWQ97weEtAKYQg2xJIkuveAT3dYeLGH+ShrWNwZgN0b2YL7qznr3g8JYAo5bQBziPjx7BPZ0d9RCQp4UZbnFdzBddor4XHN4KYMrB2qHFRIzzcLAHQZ5the5ovui94PCWAPefaYnxIdzRwdHCbuR4B+tbiy96Lzi8E4D7z7S0mEPd+eqO3cT53Z0Y8SV80XvB4Z0ADJi/f7X113f+7p7/+UYBvur6657/+YYBvur6657/+aYBvuL6657/+aYBvuL6657/+aYBvuL6657/+aYBvuL6657/+VMA8FXWX/f8z58OgK+y/rrnf75RgLna+uue//lTA/CV1V/3/M837aKvvv6653++UQvmauuve/7nTwfAV1N/3fM/fzr24Cuuv+75nz8FFnxl9dc9//MOr/8/glixwRuUfM4AAAAASUVORK5CYII="}getSearchTexture(){return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAAAhCAAAAABIXyLAAAAAOElEQVRIx2NgGAWjYBSMglEwEICREYRgFBZBqDCSLA2MGPUIVQETE9iNUAqLR5gIeoQKRgwXjwAAGn4AtaFeYLEAAAAASUVORK5CYII="}dispose(){this.edgesRT.dispose(),this.weightsRT.dispose(),this.areaTexture.dispose(),this.searchTexture.dispose(),this.materialEdges.dispose(),this.materialWeights.dispose(),this.materialBlend.dispose(),this.fsQuad.dispose()}}class ny extends kb{constructor(e,t){super(e,t),__publicField(this,"name","AA"),__publicField(this,"_method","msaa"),__publicField(this,"_lastMethod","msaa"),__publicField(this,"_lastEnabled",!1),__publicField(this,"_lastUseMRT",!1),__publicField(this,"_samples",0),this.enabled=t.enabled,this._method=t.method}beginFrame(){this._lastEnabled===this.enabled?this.enabled&&this._lastMethod!==this._method&&(this._disableOldMethod(),this._enableNewMethod()):this.enabled?this._enableNewMethod():this._disableOldMethod()}_disableOldMethod(){const e=this._lastMethod,t=this._rendering;"msaa"===e?(t.updateContextParameters({antialias:!1}),t.main.sceneRendering.updateRenderTargetSamples(0),this._samples=0):"fxaa"===e?(this._fxaaPass&&t.main.postprocessings.remove(this._fxaaPass),this._fxaaPass=null):"taa"===e?(this._taaPass&&t.main.postprocessings.remove(this._taaPass),this._taaPass=null):"smaa"===e&&(this._smaaPass&&t.main.postprocessings.remove(this._smaaPass),this._smaaPass=null)}_enableNewMethod(){const e=this._method,t=this._rendering;if("msaa"===e)t.updateContextParameters({antialias:!0}),t.main.sceneRendering.updateRenderTargetSamples(4),this._samples=4;else if("fxaa"===e){const e=this._fxaaPass=new Xb(qb),i=t.resolution,n=t.pixelRatio;e.uniforms.resolution.value.set(1/i.x/n,1/i.y/n),e.renderOrder=80,t.main.postprocessings.add(e)}else if("taa"===e){const e=this._taaPass=new jb;e.rendering=t,e.renderOrder=80,t.main.postprocessings.add(e)}else if("smaa"===e){const e=t.resolution,i=t.pixelRatio,n=this._smaaPass=new iy(e.x*i,e.y*i);n.renderOrder=80,t.main.postprocessings.add(n)}else console.warn("Unknown antialias method:",e)}afterRender(){}endFrame(){this._lastEnabled=this.enabled,this._lastMethod=this._method}dispose(){this.enabled&&"msaa"!==this._method&&this._disableOldMethod()}get method(){return this._method}set method(e){this._method=e}get samples(){return this._samples}}class sy extends kb{constructor(e,t={}){super(e,t),__publicField(this,"name","bufferView"),__publicField(this,"_lastEnabled",!1),__publicField(this,"_offset",0),__publicField(this,"_currentFrameTextures",[]),this._offset=t.offset||0}beginFrame(){this._lastEnabled===this.enabled||(this.enabled?this._init():this.dispose())}_init(){const e=this._rendering,t=this._renderPass=new Ub;t.renderOrder=10900,t.material.uniforms.textureInfos.value=[{offset:[.2,.2],scale:[2.5,2.5]}],t.material.uniforms.maps.value=[],e.main.postprocessings.add(this._renderPass)}afterRender(){if(!this.enabled)return;const e=[],t=this._rendering,i=t.main.sceneRendering;i.diffuseTexture&&e.push(i.diffuseTexture),i.emissiveTexture&&e.push(i.emissiveTexture),i.normalTexture&&e.push(i.normalTexture),i.depthTexture&&e.push(i.depthTexture),i.metallicRoughTexture&&e.push(i.metallicRoughTexture);const n=t.main.features.features||[];for(let a=0;a<n.length;a++){const t=n[a];if(t.enabled&&t.getCurrentUsedTextures){const i=t.getCurrentUsedTextures();i&&e.push(...i)}}const s=t.main.postprocessings.postprocessings||[];for(let a=0;a<s.length;a++){const t=s[a];if(t.getCurrentUsedTextures){const i=t.getCurrentUsedTextures();i&&e.push(...i)}}this._currentFrameTextures.length>0&&e.push(...this._currentFrameTextures);const o=[],r=e.slice(this._offset,this._offset+4);if(0!==r.length){for(let e=0;e<r.length;e++)o.push({offset:[.25*e,.25*Math.floor(e/4)],scale:[4,4]});this._renderPass.updateTextures(r,o)}}endFrame(){this._lastEnabled=this.enabled,this._currentFrameTextures.length=0}addCurrentFrameTexture(e){this.enabled&&this._currentFrameTextures.push(e)}dispose(){this._rendering.main.postprocessings.remove(this._renderPass),this._renderPass&&this._renderPass.dispose()}get offset(){return this._offset}set offset(e){this._offset=e}}class oy{constructor(e=Math){this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(let t=0;t<256;t++)this.p[t]=Math.floor(256*e.random());this.perm=[];for(let t=0;t<512;t++)this.perm[t]=this.p[255&t];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]}dot(e,t,i){return e[0]*t+e[1]*i}dot3(e,t,i,n){return e[0]*t+e[1]*i+e[2]*n}dot4(e,t,i,n,s){return e[0]*t+e[1]*i+e[2]*n+e[3]*s}noise(e,t){let i,n,s;const o=(e+t)*(.5*(Math.sqrt(3)-1)),r=Math.floor(e+o),a=Math.floor(t+o),l=(3-Math.sqrt(3))/6,g=(r+a)*l,c=e-(r-g),d=t-(a-g);let h,u;c>d?(h=1,u=0):(h=0,u=1);const I=c-h+l,p=d-u+l,m=c-1+2*l,A=d-1+2*l,C=255&r,f=255&a,b=this.perm[C+this.perm[f]]%12,y=this.perm[C+h+this.perm[f+u]]%12,_=this.perm[C+1+this.perm[f+1]]%12;let v=.5-c*c-d*d;v<0?i=0:(v*=v,i=v*v*this.dot(this.grad3[b],c,d));let x=.5-I*I-p*p;x<0?n=0:(x*=x,n=x*x*this.dot(this.grad3[y],I,p));let B=.5-m*m-A*A;return B<0?s=0:(B*=B,s=B*B*this.dot(this.grad3[_],m,A)),70*(i+n+s)}noise3d(e,t,i){let n,s,o,r;const a=(e+t+i)*(1/3),l=Math.floor(e+a),g=Math.floor(t+a),c=Math.floor(i+a),d=1/6,h=(l+g+c)*d,u=e-(l-h),I=t-(g-h),p=i-(c-h);let m,A,C,f,b,y;u>=I?I>=p?(m=1,A=0,C=0,f=1,b=1,y=0):u>=p?(m=1,A=0,C=0,f=1,b=0,y=1):(m=0,A=0,C=1,f=1,b=0,y=1):I<p?(m=0,A=0,C=1,f=0,b=1,y=1):u<p?(m=0,A=1,C=0,f=0,b=1,y=1):(m=0,A=1,C=0,f=1,b=1,y=0);const _=u-m+d,v=I-A+d,x=p-C+d,B=u-f+2*d,w=I-b+2*d,S=p-y+2*d,G=u-1+.5,M=I-1+.5,R=p-1+.5,T=255&l,Z=255&g,V=255&c,W=this.perm[T+this.perm[Z+this.perm[V]]]%12,E=this.perm[T+m+this.perm[Z+A+this.perm[V+C]]]%12,N=this.perm[T+f+this.perm[Z+b+this.perm[V+y]]]%12,F=this.perm[T+1+this.perm[Z+1+this.perm[V+1]]]%12;let X=.6-u*u-I*I-p*p;X<0?n=0:(X*=X,n=X*X*this.dot3(this.grad3[W],u,I,p));let H=.6-_*_-v*v-x*x;H<0?s=0:(H*=H,s=H*H*this.dot3(this.grad3[E],_,v,x));let z=.6-B*B-w*w-S*S;z<0?o=0:(z*=z,o=z*z*this.dot3(this.grad3[N],B,w,S));let L=.6-G*G-M*M-R*R;return L<0?r=0:(L*=L,r=L*L*this.dot3(this.grad3[F],G,M,R)),32*(n+s+o+r)}noise4d(e,t,i,n){const s=this.grad4,o=this.simplex,r=this.perm,a=(Math.sqrt(5)-1)/4,l=(5-Math.sqrt(5))/20;let g,c,d,h,u;const I=(e+t+i+n)*a,p=Math.floor(e+I),m=Math.floor(t+I),A=Math.floor(i+I),C=Math.floor(n+I),f=(p+m+A+C)*l,b=e-(p-f),y=t-(m-f),_=i-(A-f),v=n-(C-f),x=(b>y?32:0)+(b>_?16:0)+(y>_?8:0)+(b>v?4:0)+(y>v?2:0)+(_>v?1:0),B=o[x][0]>=3?1:0,w=o[x][1]>=3?1:0,S=o[x][2]>=3?1:0,G=o[x][3]>=3?1:0,M=o[x][0]>=2?1:0,R=o[x][1]>=2?1:0,T=o[x][2]>=2?1:0,Z=o[x][3]>=2?1:0,V=o[x][0]>=1?1:0,W=o[x][1]>=1?1:0,E=o[x][2]>=1?1:0,N=o[x][3]>=1?1:0,F=b-B+l,X=y-w+l,H=_-S+l,z=v-G+l,L=b-M+2*l,D=y-R+2*l,K=_-T+2*l,Y=v-Z+2*l,P=b-V+3*l,k=y-W+3*l,O=_-E+3*l,U=v-N+3*l,Q=b-1+4*l,J=y-1+4*l,j=_-1+4*l,q=v-1+4*l,$=255&p,ee=255&m,te=255&A,ie=255&C,ne=r[$+r[ee+r[te+r[ie]]]]%32,se=r[$+B+r[ee+w+r[te+S+r[ie+G]]]]%32,oe=r[$+M+r[ee+R+r[te+T+r[ie+Z]]]]%32,re=r[$+V+r[ee+W+r[te+E+r[ie+N]]]]%32,ae=r[$+1+r[ee+1+r[te+1+r[ie+1]]]]%32;let le=.6-b*b-y*y-_*_-v*v;le<0?g=0:(le*=le,g=le*le*this.dot4(s[ne],b,y,_,v));let ge=.6-F*F-X*X-H*H-z*z;ge<0?c=0:(ge*=ge,c=ge*ge*this.dot4(s[se],F,X,H,z));let ce=.6-L*L-D*D-K*K-Y*Y;ce<0?d=0:(ce*=ce,d=ce*ce*this.dot4(s[oe],L,D,K,Y));let de=.6-P*P-k*k-O*O-U*U;de<0?h=0:(de*=de,h=de*de*this.dot4(s[re],P,k,O,U));let he=.6-Q*Q-J*J-j*j-q*q;return he<0?u=0:(he*=he,u=he*he*this.dot4(s[ae],Q,J,j,q)),27*(g+c+d+h+u)}}new bt,new Bi,new Bi;const ry={name:"SSAOBlurShader",uniforms:{tDiffuse:{value:null},resolution:{value:new bt}},vertexShader:"varying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"uniform sampler2D tDiffuse;\n\n\t\tuniform vec2 resolution;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec2 texelSize = ( 1.0 / resolution );\n\t\t\tfloat result = 0.0;\n\n\t\t\tfor ( int i = - 2; i <= 2; i ++ ) {\n\n\t\t\t\tfor ( int j = - 2; j <= 2; j ++ ) {\n\n\t\t\t\t\tvec2 offset = ( vec2( float( i ), float( j ) ) ) * texelSize;\n\t\t\t\t\tresult += texture2D( tDiffuse, vUv + offset ).r;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tgl_FragColor = vec4( vec3( result / ( 5.0 * 5.0 ) ), 1.0 );\n\n\t\t}"},ay={defines:{PERSPECTIVE_CAMERA:1,KERNEL_SIZE:32},uniforms:{tDiffuse:{value:null},tNormal:{value:null},tDepth:{value:null},tNoise:{value:null},kernel:{value:null},cameraNear:{value:null},cameraFar:{value:null},resolution:{value:new bt},cameraProjectionMatrix:{value:new Bi},cameraInverseProjectionMatrix:{value:new Bi},kernelRadius:{value:.1},minDistance:{value:1e-4},maxDistance:{value:1e3},intensity:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform sampler2D tNormal;\n\t\tuniform sampler2D tDepth;\n\t\tuniform sampler2D tNoise;\n\n\t\tuniform vec3 kernel[ KERNEL_SIZE ];\n\n\t\tuniform vec2 resolution;\n\n\t\tuniform float cameraNear;\n\t\tuniform float cameraFar;\n\t\tuniform mat4 cameraProjectionMatrix;\n\t\tuniform mat4 cameraInverseProjectionMatrix;\n\n\t\tuniform float kernelRadius;\n\t\tuniform float minDistance; // avoid artifacts caused by neighbour fragments with minimal depth difference\n\t\tuniform float maxDistance; // avoid the influence of fragments which are too far away\n        uniform float intensity;\n\t\tvarying vec2 vUv;\n\n\t\t#include <packing>\n\n        float linearize_depth(in float depth){\n            float a = cameraFar / (cameraFar - cameraNear);\n            float b = cameraFar * cameraNear / (cameraNear - cameraFar);\n            return a + b / depth;\n        }\n\n        float reconstruct_depth(const in vec2 uv){\n            float depth = texture2D(tDepth, uv).x;\n            return pow(2.0, depth * log2(cameraFar + 1.0)) - 1.0;\n        }\n\n        float getDepth(vec2 uv) {\n            #if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n                return linearize_depth(reconstruct_depth(uv));\n            #else\n                return texture2D(tDepth, uv).x;\n            #endif\n        }\n\t\t// float getDepth( const in vec2 screenPosition ) {\n\n\t\t// \treturn texture2D( tDepth, screenPosition ).x;\n\n\t\t// }\n\n\t\tfloat getLinearDepth( const in vec2 screenPosition ) {\n\n\t\t\t#if PERSPECTIVE_CAMERA == 1\n\n\t\t\t\t// float fragCoordZ = texture2D( tDepth, screenPosition ).x;\n                float fragCoordZ = getDepth(screenPosition);\n\t\t\t\tfloat viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );\n\t\t\t\treturn viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );\n\n\t\t\t#else\n\n\t\t\t\treturn texture2D( tDepth, screenPosition ).x;\n\n\t\t\t#endif\n\n\t\t}\n\n\t\tfloat getViewZ( const in float depth ) {\n\n\t\t\t#if PERSPECTIVE_CAMERA == 1\n\n\t\t\t\treturn perspectiveDepthToViewZ( depth, cameraNear, cameraFar );\n\n\t\t\t#else\n\n\t\t\t\treturn orthographicDepthToViewZ( depth, cameraNear, cameraFar );\n\n\t\t\t#endif\n\n\t\t}\n\n\t\tvec3 getViewPosition( const in vec2 screenPosition, const in float depth, const in float viewZ ) {\n\n\t\t\tfloat clipW = cameraProjectionMatrix[2][3] * viewZ + cameraProjectionMatrix[3][3];\n\n\t\t\tvec4 clipPosition = vec4( ( vec3( screenPosition, depth ) - 0.5 ) * 2.0, 1.0 );\n\n\t\t\tclipPosition *= clipW; // unprojection.\n\n\t\t\treturn ( cameraInverseProjectionMatrix * clipPosition ).xyz;\n\n\t\t}\n\n\t\tvec3 getViewNormal( const in vec2 screenPosition ) {\n\n\t\t\treturn unpackRGBToNormal( texture2D( tNormal, screenPosition ).xyz );\n\n\t\t}\n\n\t\tvoid main() {\n\n            vec3 sampleNormal = texture2D( tNormal, vUv ).xyz;\n            if (length(sampleNormal) < 0.5) {\n                gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);\n                return;\n            }\n            vec3 viewNormal = unpackRGBToNormal(sampleNormal);\n\n\t\t\tfloat depth = getDepth( vUv );\n\t\t\tfloat viewZ = getViewZ( depth );\n            // float depth = texture2D( tDepth, vUv ).x;\n            // float logDepthBufFC = 2.0 / ( log( cameraFar + 1.0 ) / log(2.0) );\n            // float viewZ = -1.0 * (exp2(depth / (logDepthBufFC * 0.5)) - 1.0);\n\n\t\t\tvec3 viewPosition = getViewPosition( vUv, depth, viewZ );\n\n\t\t\tvec2 noiseScale = vec2( resolution.x / 4.0, resolution.y / 4.0 );\n\t\t\tvec3 random = vec3( texture2D( tNoise, vUv * noiseScale ).r );\n\n\t\t\t// compute matrix used to reorient a kernel vector\n\n\t\t\tvec3 tangent = normalize( random - viewNormal * dot( random, viewNormal ) );\n\t\t\tvec3 bitangent = cross( viewNormal, tangent );\n\t\t\tmat3 kernelMatrix = mat3( tangent, bitangent, viewNormal );\n\n\t\t float occlusion = 0.0;\n\n\t\t for ( int i = 0; i < KERNEL_SIZE; i ++ ) {\n\n\t\t\t\tvec3 sampleVector = kernelMatrix * kernel[ i ]; // reorient sample vector in view space\n\t\t\t\tvec3 samplePoint = viewPosition + ( sampleVector * kernelRadius ); // calculate sample point\n\n\t\t\t\tvec4 samplePointNDC = cameraProjectionMatrix * vec4( samplePoint, 1.0 );\n                // project point and calculate NDC\n\t\t\t\tsamplePointNDC /= samplePointNDC.w;\n\n\t\t\t\tvec2 samplePointUv = samplePointNDC.xy * 0.5 + 0.5; // compute uv coordinates\n\n\t\t\t\tfloat realDepth = getLinearDepth( samplePointUv ); // get linear depth from depth texture\n\t\t\t\tfloat sampleDepth = viewZToOrthographicDepth( samplePoint.z, cameraNear, cameraFar );\n\n                // realDepth = getDepth(samplePointUv);\n                // // realDepth = reconstruct_depth(samplePointUv);\n                // sampleDepth = viewZToPerspectiveDepth(samplePoint.z, cameraNear, cameraFar);\n\n                // sampleDepth = log2(sampleDepth + 1.0) / log2(cameraFar + 1.0);\n                // compute linear depth of the sample view Z value\n\t\t\t\tfloat delta = sampleDepth - realDepth;\n\n\t\t\t\tif ( delta > minDistance && delta < maxDistance ) {\n                // if ( delta > 0.00001 && delta < 0.0001) {\n                    // if fragment is before sample point, increase occlusion\n\n                    // occlusion += 1.0;\n\t\t\t\t\tocclusion += 1.0 * length(sampleVector) * intensity;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tocclusion = clamp( occlusion / float( KERNEL_SIZE ), 0.0, 1.0 );\n\n\t\t\tgl_FragColor = vec4( vec3((1.0 - occlusion) ), 1.0 );\n\n\t\t}"};class ly extends vm{constructor(e,t){super(),this.width=void 0!==e?e:512,this.height=void 0!==t?t:512,this.clear=!0,this.kernelRadius=.5,this.kernelSize=32,this.kernel=[],this.noiseTexture=null,this.intensity=1,this.minDistance=1e-5,this.maxDistance=1e-4,this.generateSampleKernel(),this.generateRandomKernelRotations(),this.ssaoMaterial=new ls({defines:Object.assign({},ay.defines),uniforms:as.clone(ay.uniforms),vertexShader:ay.vertexShader,fragmentShader:ay.fragmentShader,blending:0}),this.ssaoMaterial.uniforms.tNoise.value=this.noiseTexture,this.ssaoMaterial.uniforms.kernel.value=this.kernel,this.blurMaterial=new ls({defines:Object.assign({},ry.defines),uniforms:as.clone(ry.uniforms),vertexShader:ry.vertexShader,fragmentShader:ry.fragmentShader}),this.copyMaterial=new ls({uniforms:as.clone(Sm.uniforms),vertexShader:Sm.vertexShader,fragmentShader:Sm.fragmentShader,transparent:!0,depthTest:!1,depthWrite:!1,blendSrc:208,blendDst:h,blendEquation:d,blendSrcAlpha:206,blendDstAlpha:h,blendEquationAlpha:d}),this.fsQuad=new wm(null),this.originalClearColor=new In,this.needsNormalTexture=!0,this.needsDepthTexture=!0}dispose(){this.ssaoRenderTarget.dispose(),this.blurRenderTarget.dispose(),this.normalMaterial.dispose(),this.blurMaterial.dispose(),this.copyMaterial.dispose(),this.depthRenderMaterial.dispose(),this.fsQuad.dispose()}render(e,t,i){!1===e.capabilities.isWebGL2&&(this.noiseTexture.format=Q),this.ssaoRenderTarget||(this.ssaoRenderTarget=new Yt(i.width,i.height,{})),this.blurRenderTarget||(this.blurRenderTarget=new Yt(i.width,i.height,{}));const n=this.rendering,s=n.main.sceneRendering.normalTexture,o=n.main.sceneRendering.depthTexture;this.ssaoMaterial.uniforms.tDiffuse.value=i.texture,this.ssaoMaterial.uniforms.tNormal.value=s,this.ssaoMaterial.uniforms.tDepth.value=o,this.ssaoMaterial.uniforms.cameraNear.value=n.camera.near,this.ssaoMaterial.uniforms.cameraFar.value=n.camera.far,this.ssaoMaterial.uniforms.resolution.value.set(i.width,i.height),this.ssaoMaterial.uniforms.cameraProjectionMatrix.value.copy(n.camera.projectionMatrix),this.ssaoMaterial.uniforms.cameraInverseProjectionMatrix.value.copy(n.camera.projectionMatrixInverse),this.ssaoMaterial.uniforms.kernelRadius.value=this.kernelRadius,this.ssaoMaterial.uniforms.minDistance.value=this.minDistance,this.ssaoMaterial.uniforms.maxDistance.value=this.maxDistance,this.ssaoMaterial.uniforms.intensity.value=this.intensity,this.renderPass(e,this.ssaoMaterial,this.ssaoRenderTarget),this.blurMaterial.uniforms.resolution.value.set(i.width,i.height),this.blurMaterial.uniforms.tDiffuse.value=this.ssaoRenderTarget.texture,this.renderPass(e,this.blurMaterial,this.blurRenderTarget),this.copyMaterial.uniforms.tDiffuse.value=i.texture,this.copyMaterial.blending=0,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t),this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget.texture,this.copyMaterial.blending=5,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t)}renderPass(e,t,i,n,s){e.getClearColor(this.originalClearColor);const o=e.getClearAlpha(),r=e.autoClear;e.setRenderTarget(i),e.autoClear=!1,null!=n&&(e.setClearColor(n),e.setClearAlpha(s||0),e.clear()),this.fsQuad.material=t,this.fsQuad.render(e),e.autoClear=r,e.setClearColor(this.originalClearColor),e.setClearAlpha(o)}setSize(e,t){this.width=e,this.height=t,this.ssaoRenderTarget.setSize(e,t),this.blurRenderTarget.setSize(e,t)}generateSampleKernel(){const e=this.kernelSize,t=this.kernel;for(let i=0;i<e;i++){const n=new Qt;n.x=2*Math.random()-1,n.y=2*Math.random()-1,n.z=Math.random(),n.normalize();let s=i/e;s=ft.lerp(.1,1,s*s),n.multiplyScalar(s),t.push(n)}}generateRandomKernelRotations(){const e=new oy,t=new Float32Array(16);for(let i=0;i<16;i++){const n=2*Math.random()-1,s=2*Math.random()-1,o=0;t[i]=e.noise3d(n,s,o)}this.noiseTexture=new ya(t,4,4,q,K),this.noiseTexture.wrapS=G,this.noiseTexture.wrapT=G,this.noiseTexture.needsUpdate=!0}}class gy extends kb{constructor(e,t){super(e,t),__publicField(this,"name","AO"),__publicField(this,"_method","ssao"),__publicField(this,"_ssaoKernelRadius",.5),__publicField(this,"_ssaoMinDistance",1e-5),__publicField(this,"_ssaoMaxDistance",1e-4),__publicField(this,"_ssaoIntensity",1),__publicField(this,"_lastMethod","ssao"),__publicField(this,"_lastEnabled",!1),this.enabled=t.enabled,this._method=t.method}beginFrame(){this._lastEnabled===this.enabled?this.enabled&&this._lastMethod!==this._method&&(this._disableOldMethod(),this._enableNewMethod()):this.enabled?this._enableNewMethod():this._disableOldMethod()}_disableOldMethod(){const e=this._lastMethod,t=this._rendering;"ssao"===e&&(this._ssaoPass&&t.main.postprocessings.remove(this._ssaoPass),this._ssaoPass=null)}_enableNewMethod(){const e=this._method,t=this._rendering;if("ssao"===e){const e=this._ssaoPass=new ly;e.kernelRadius=this._ssaoKernelRadius,e.minDistance=this._ssaoMinDistance,e.maxDistance=this._ssaoMaxDistance,e.intensity=this._ssaoIntensity,e.renderOrder=900,e.rendering=t,t.main.postprocessings.add(e)}}afterRender(){}endFrame(){this._lastEnabled=this.enabled,this._lastMethod=this._method}dispose(){this.enabled&&this._disableOldMethod()}get method(){return this._method}set method(e){this._method=e}get ssaoKernelRadius(){return this._ssaoKernelRadius}set ssaoKernelRadius(e){this._ssaoKernelRadius=e,this._ssaoPass&&(this._ssaoPass.kernelRadius=e)}get ssaoMinDistance(){return this._ssaoMinDistance}set ssaoMinDistance(e){this._ssaoMinDistance=e,this._ssaoPass&&(this._ssaoPass.minDistance=e)}get ssaoMaxDistance(){return this._ssaoMaxDistance}set ssaoMaxDistance(e){this._ssaoMaxDistance=e,this._ssaoPass&&(this._ssaoPass.maxDistance=e)}get ssaoIntensity(){return this._ssaoIntensity}set ssaoIntensity(e){this._ssaoIntensity=e,this._ssaoPass&&(this._ssaoPass.intensity=e)}}function cy(e){let t=uy(e).toArray(),i=void 0===t[3]?1:t[3];return[t[0],t[1],t[2],i]}function dy(e){let t=uy(e).toArray(),i=void 0===t[3]?1:t[3];return[255*t[0],255*t[1],255*t[2],i]}function hy(e){const t=cy(e);return new In(t[0],t[1],t[2])}function uy(e){if(!e)return new In(1,1,1);if(e.isColor)return e;if("string"==typeof e){const t=/^#([0-9A-Fa-f]{8})/,i=e.match(t);if(i){const e=i[1],t=`#${e.slice(0,6)}`,n=parseInt(e.slice(6,8),16)/255,s=new In(t);return new Dt(s.r,s.g,s.b,n)}const n=/rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*([\d.]+)\s*\)/,s=e.match(n);if(s){const e=parseInt(s[1],10),t=parseInt(s[2],10),i=parseInt(s[3],10),n=parseFloat(s[4]),o=new In(`rgb(${e}, ${t}, ${i})`);return new Dt(o.r,o.g,o.b,n)}const o=/hsla\s*\(\s*(\d+)\s*,\s*(\d+)%\s*,\s*(\d+)%\s*,\s*([\d.]+)\s*\)/,r=e.match(o);if(r){const e=parseInt(r[1],10)/360,t=parseInt(r[2],10)/100,i=parseInt(r[3],10)/100,n=parseFloat(r[4]),s=(new In).setHSL(e,t,i);return new Dt(s.r,s.g,s.b,n)}}return new In(e)}function Iy(e){const t=e>>11,i=e>>5&63,n=31&e;return[Math.round(t/31*255),Math.round(i/63*255),Math.round(n/31*255)]}const py=Object.freeze(Object.defineProperty({__proto__:null,colorToArr4:cy,colorToRgbaArr:dy,normalizeColor:hy,convertSRGBColor:uy,rgb565torgb:Iy},Symbol.toStringTag,{value:"Module"})),my={mvt_emissive:{value:null},mvt_emissiveIntensity:{value:1}},Ay={selectedObjectColor:{value:[1,1,0,.5]},selectedObjectIndex:{value:-1},selectedObjectColorMode:{value:0}},Cy={keepSize:{value:!1},zoomUnits:{value:1}},fy=(e,t=[])=>{for(let i of t)Object.defineProperty(e,i,{get:function(){return this.uniforms[i].value},set:function(e){this.uniforms[i].value=e}})},by=(e,t=[])=>{for(let i of t)Object.defineProperty(e,i,{get:function(){return this.uniforms[i].value},set:function(e){this.uniforms[i].value=hy(e)}})},yy=(e,t=[])=>{for(let[i,n,s]of t)Object.defineProperty(e,i,{get:function(){return this.uniforms[n].value},set:function(e){this.uniforms[n].value=s?s(e):e}})},_y=(e,t=[])=>{for(let[i,n]of t)Object.defineProperty(e,i,{get:function(){return!!this.defines[n]},set:function(e){this[i]!==e&&(e?this.defines[n]=!0:delete this.defines[n],this.needsUpdate=!0)}})},vy=e=>{Object.defineProperties(e,{selectedObjectColor:{get:function(){return this.uniforms.selectedObjectColor.value},set:function(e){this.uniforms.selectedObjectColor.value=e}},selectedObjectColorMode:{get:function(){return this.uniforms.selectedObjectColorMode.value},set:function(e){this.uniforms.selectedObjectColorMode.value=e}},selectedObjectIndex:{get:function(){return this.uniforms.selectedObjectIndex.value},set:function(e){this.uniforms.selectedObjectIndex.value=e}},selective:{get:function(){return!!this.defines.MVT_ENABLE_SELECTIVE},set:function(e){this.selective!==e&&(e?this.defines.MVT_ENABLE_SELECTIVE=!0:delete this.defines.MVT_ENABLE_SELECTIVE,this.needsUpdate=!0)}}})},xy=e=>{Object.defineProperties(e,{keepSize:{get:function(){return this.uniforms.keepSize.value},set:function(e){this.uniforms.keepSize.value=e}},zoomUnits:{get:function(){return this.uniforms.zoomUnits.value},set:function(e){this.uniforms.zoomUnits.value=e}},zoomUnitsUniform:{get:function(){return this.uniforms.zoomUnits},set:function(e){this.uniforms.zoomUnits=e}}})},By=e=>{Object.defineProperties(e,{emissiveEnabled:{get:function(){return this.defines.MVT_EMISSIVE_UNIFORM||!1},set:function(e){e?this.defines.MVT_EMISSIVE_UNIFORM=!0:delete this.defines.MVT_EMISSIVE_UNIFORM}},emissive:{get:function(){return this.uniforms.mvt_emissive.value},set:function(e){e?this.defines.MVT_EMISSIVE_COLOR=!0:delete this.defines.MVT_EMISSIVE_COLOR,this.uniforms.mvt_emissive.value=e}},emissiveIntensity:{get:function(){return this.uniforms.mvt_emissiveIntensity.value},set:function(e){this.uniforms.mvt_emissiveIntensity.value=e}}})},wy={tDiffuse:{value:null},tNormal:{value:null},tMetalness:{value:null},tEnhancement:{value:null},tEnhancementScale:{value:new bt(20,20)},tDepth:{value:null},cameraNear:{value:null},cameraFar:{value:null},resolution:{value:new bt},cameraProjectionMatrix:{value:new Bi},cameraInverseProjectionMatrix:{value:new Bi},mvt_viewInverseMatrix:{value:new Bi},mvt_normalInverseMatrix:{value:new yt},opacity:{value:.5},maxDistance:{value:180},cameraRange:{value:0},thickness:{value:.018},logDepthBufFC:{value:1},threshold:{value:.6}};class Sy extends ls{constructor(e){super(),this.vertexShader="#define GLSLIFY 1\nvarying vec2 vUv;\n\nvoid main() {\n\n    vUv = uv;\n\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n}",this.fragmentShader='precision highp sampler2D;\n#define GLSLIFY 1\nvarying vec2 vUv;\nuniform sampler2D tDepth;\nuniform sampler2D tNormal;\nuniform sampler2D tMetalness;\nuniform sampler2D tDiffuse;\n\n#if defined(MVT_SSR_USE_ENHANCEMENT_MAP)\nuniform sampler2D tEnhancement;\nuniform vec2 tEnhancementScale;\nuniform mat4 mvt_viewInverseMatrix;\nuniform mat3 mvt_normalInverseMatrix;\n#endif\n\nuniform float cameraRange;\nuniform vec2 resolution;\nuniform float opacity;\nuniform float cameraNear;\nuniform float cameraFar;\nuniform float maxDistance;\nuniform float thickness;\nuniform mat4 cameraProjectionMatrix;\nuniform mat4 cameraInverseProjectionMatrix;\nuniform float threshold; // 控制反射最低阈值，低于此致的不计算，可提高性能\n\n#include <packing>\nfloat pointToLineDistance(vec3 x0, vec3 x1, vec3 x2) {\n    //x0: point, x1: linePointA, x2: linePointB\n    //https://mathworld.wolfram.com/Point-LineDistance3-Dimensional.html\n    return length(cross(x0 - x1, x0 - x2)) / length(x2 - x1);\n}\nfloat pointPlaneDistance(vec3 point, vec3 planePoint, vec3 planeNormal) {\n    // https://mathworld.wolfram.com/Point-PlaneDistance.html\n    //// https://en.wikipedia.org/wiki/Plane_(geometry)\n    //// http://paulbourke.net/geometry/pointlineplane/\n    float a = planeNormal.x, b = planeNormal.y, c = planeNormal.z;\n    float x0 = point.x, y0 = point.y, z0 = point.z;\n    float x = planePoint.x, y = planePoint.y, z = planePoint.z;\n    float d = -(a * x + b * y + c * z);\n    float distance = (a * x0 + b * y0 + c * z0 + d) / sqrt(a * a + b * b + c * c);\n    return distance;\n}\n// https://stackoverflow.com/questions/40373184/world-space-position-from-logarithmic-depth-buffer\nfloat linearize_depth(in float depth) {\n    float a = cameraFar / (cameraFar - cameraNear);\n    float b = cameraFar * cameraNear / (cameraNear - cameraFar);\n    return a + b / depth;\n}\n\nfloat reconstruct_depth(const in vec2 uv) {\n    float depth = texture2D(tDepth, uv).x;\n    return pow(2.0, depth * log2(cameraFar + 1.0)) - 1.0;\n}\n\nfloat get_logarithmic_depth(const in vec2 uv) {\n    float depth = texture2D(tDepth, uv).x;\n    float logDepthBufFC = 2.0 / ( log( cameraFar + 1.0 ) / log(2.0) );\n    float invViewZ = exp2(depth / (logDepthBufFC * 0.5)) - 1.0;\n    return viewZToPerspectiveDepth(-invViewZ, cameraNear, cameraFar);\n}\nfloat getDepth(const in vec2 uv) {\n    #if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n    // return linearize_depth(reconstruct_depth(uv)); //exp2(logDepth * 2.0 / logDepthBufFC) - 1.0;\n    return get_logarithmic_depth(uv);\n    #else\n    return texture2D(tDepth, uv).x;\n    #endif\n\n}\nfloat getViewZ(const in float depth) {\n    #ifdef PERSPECTIVE_CAMERA\n    return perspectiveDepthToViewZ(depth, cameraNear, cameraFar);\n    #else\n    return orthographicDepthToViewZ(depth, cameraNear, cameraFar);\n    #endif\n}\nvec3 getViewPosition(const in vec2 uv, const in float depth/*clip space*/, const in float clipW) {\n    vec4 clipPosition = vec4((vec3(uv, depth) - 0.5) * 2.0, 1.0);//ndc\n    clipPosition *= clipW; //clip\n    return (cameraInverseProjectionMatrix * clipPosition).xyz;//view\n}\n#if defined(MVT_SSR_USE_ENHANCEMENT_MAP)\nvec3 getWorldPositionFromDepth(float depth) {\n    float z = depth * 2.0 - 1.0;\n    vec4 clipSpacePosition = vec4(vUv * 2.0 - 1.0, z, 1.0);\n    vec4 viewSpacePosition = cameraInverseProjectionMatrix * clipSpacePosition;\n    vec4 worldSpacePosition = mvt_viewInverseMatrix * viewSpacePosition;\n    return worldSpacePosition.xyz / worldSpacePosition.w;\n}\n#endif\nvec3 getViewNormal(const in vec2 uv) {\n    return unpackRGBToNormal(texture2D(tNormal, uv).xyz);\n}\nvec2 viewPositionToXY(vec3 viewPosition) {\n    vec2 xy;\n    vec4 clip = cameraProjectionMatrix * vec4(viewPosition, 1);\n    xy = clip.xy;//clip\n    float clipW = clip.w;\n    xy /= clipW;//NDC\n    xy = (xy + 1.) / 2.;//uv\n    xy *= resolution;//screen\n    return xy;\n}\nvoid main() {\n\n    gl_FragColor = texture2D(tDiffuse, vUv);\n   \n    vec3 sampleNormal = texture2D(tNormal, vUv).xyz;\n    if (length(sampleNormal) < 0.9) {\n        return;\n    }\n\n    vec3 viewNormal = unpackRGBToNormal(sampleNormal);\n    float depth = getDepth(vUv);\n    #ifdef SELECTIVE\n    // 完全没反射的表面直接剔除\n    float intensity = texture2D(tMetalness, vUv).x;\n\n    #if defined(MVT_SSR_USE_ENHANCEMENT_MAP)\n        float dirAlpha = dot(viewNormal * mvt_normalInverseMatrix, vec3(0.0, 0.0, 1.0));\n        if (dirAlpha > 0.5) {\n            vec3 worldSpacePosition = getWorldPositionFromDepth(depth);\n            vec2 enhancementUv = vec2(mod(worldSpacePosition.x, tEnhancementScale.x) / tEnhancementScale.x, \n                    mod(worldSpacePosition.y, tEnhancementScale.y) / tEnhancementScale.y);\n            float enhancement = texture2D(tEnhancement, enhancementUv).x;\n            intensity += (1.0 - enhancement);\n        }\n        // gl_FragColor = vec4(enhancement, 0.0, 0.0, 1.0);\n        // return;\n    #endif\n\n         \n    if(intensity < threshold)\n        return;\n    intensity -= threshold;\n    intensity *= 1.0 / (1.0 - threshold);\n    #endif\n\n    \n    float viewZ = getViewZ(depth);\n    // z值已经超过相机远端距离\n    if(-viewZ >= cameraFar)\n        return;\n\n    float clipW = cameraProjectionMatrix[2][3] * viewZ + cameraProjectionMatrix[3][3];\n    // 相机视图下的当前片元坐标\n    vec3 viewPosition = getViewPosition(vUv, depth, clipW);\n\n    // 起点的屏幕坐标\n    vec2 d0 = gl_FragCoord.xy;\n    vec2 d1;\n\n    #ifdef PERSPECTIVE_CAMERA\n    // 入射光方向，相机在原点，方向即为坐标的单位向量\n    vec3 viewIncidentDir = normalize(viewPosition);\n    // 反射光方向\n    vec3 viewReflectDir = reflect(viewIncidentDir, viewNormal);\n    #else\n    vec3 viewIncidentDir = vec3(0, 0, -1);\n    vec3 viewReflectDir = reflect(viewIncidentDir, viewNormal);\n    #endif\n\n    // 反射光线最长距离由输入的最大反射距离和入射角决定\n    float maxReflectRayLen = maxDistance / dot(-viewIncidentDir, viewNormal);\n    // dot(a,b)==length(a)*length(b)*cos(theta) // https://www.mathsisfun.com/algebra/vectors-dot-product.html\n    // if(a.isNormalized&&b.isNormalized) dot(a,b)==cos(theta)\n    // maxDistance/maxReflectRayLen=cos(theta)\n    // maxDistance/maxReflectRayLen==dot(a,b)\n    // maxReflectRayLen==maxDistance/dot(a,b)\n\n    // 反射最远距离下的坐标点\n    vec3 d1viewPosition = viewPosition + viewReflectDir * maxReflectRayLen;\n    #ifdef PERSPECTIVE_CAMERA\n    if(d1viewPosition.z > -cameraNear) {\n            //https://tutorial.math.lamar.edu/Classes/CalcIII/EqnsOfLines.aspx\n        // 应该是处理反射点溢出相机视野外的情况\n        float t = (-cameraNear - viewPosition.z) / viewReflectDir.z;\n        d1viewPosition = viewPosition + viewReflectDir * t;\n    }\n    #endif\n    // 反射最远点在屏幕上的位置\n    d1 = viewPositionToXY(d1viewPosition);\n\n    // 屏幕像素距离\n    float totalLen = length(d1 - d0);\n    float xLen = d1.x - d0.x;\n    float yLen = d1.y - d0.y;\n    // 最大步数取xy方向较大的一个方向，每次步进一个像素\n    float totalStep = max(abs(xLen), abs(yLen));\n    // x方向每次步进的大小\n    float xSpan = xLen / totalStep;\n    // y方向每次步进的大小\n    float ySpan = yLen / totalStep;\n    // 步进次数最大是屏幕对角线距离（应该是横向或者纵向的最大值），实际次数要远小于这个\n    for(float i = 0.; i < float(MAX_STEP); i += 4.0) {\n        if(i >= totalStep)\n            break;\n        // march到的当前屏幕像素\n        vec2 xy = vec2(d0.x + i * xSpan, d0.y + i * ySpan);\n        // 跑到屏幕外march失败\n        if(xy.x < 0. || xy.x > resolution.x || xy.y < 0. || xy.y > resolution.y)\n            break;\n        // 当前百分比\n        float s = length(xy - d0) / totalLen;\n        // 当前uv\n        vec2 uv = xy / resolution;\n        // 计算当前点的各项参数，和一开始一样\n        float d = getDepth(uv);\n        float vZ = getViewZ(d);\n        // gl_FragColor = vec4(-vZ / 1000., 0.0, 0.0, 1.0);\n        // return;\n        if(-vZ >= cameraFar)\n            continue;\n        float cW = cameraProjectionMatrix[2][3] * vZ + cameraProjectionMatrix[3][3];\n        // 得到当前点的viewposition\n        vec3 vP = getViewPosition(uv, d, cW);\n\n        // 得到当前反射线的z\n        #ifdef PERSPECTIVE_CAMERA\n            // https://comp.nus.edu.sg/~lowkl/publications/lowk_persp_interp_techrep.pdf\n        float recipVPZ = 1. / viewPosition.z;\n        float viewReflectRayZ = 1. / (recipVPZ + s * (1. / d1viewPosition.z - recipVPZ));\n        #else\n        float viewReflectRayZ = viewPosition.z + s * (d1viewPosition.z - viewPosition.z);\n        #endif\n\n        // if(viewReflectRayZ>vZ) continue; // will cause "npm run make-screenshot webgl_postprocessing_ssr" high probability hang.\n        // https://github.com/mrdoob/three.js/pull/21539#issuecomment-821061164\n        // 反射线的z小于当前点的z,否则就是被遮挡住了\n        if(viewReflectRayZ <= vZ) {\n\n            bool hit;\n            #ifdef INFINITE_THICK\n            hit = true;\n            #else\n            // 点到射线的距离\n            float away = pointToLineDistance(vP, viewPosition, d1viewPosition);\n\n            // minThickness没看懂，和横向邻接点的viewx差值，大约代表了此处一个像素和实际距离的比例，乘3.0？\n            float minThickness;\n            vec2 xyNeighbor = xy;\n            xyNeighbor.x += 1.;\n            vec2 uvNeighbor = xyNeighbor / resolution;\n            vec3 vPNeighbor = getViewPosition(uvNeighbor, d, cW);\n            minThickness = vPNeighbor.x - vP.x;\n            minThickness *= 3.;\n            float tk = max(minThickness, thickness);\n            // 当距离小于阈值时才算是真正相交\n            hit = away <= tk;\n            #endif\n\n            if(hit) {\n                vec3 vN = getViewNormal(uv);\n                // 相交到物体的反面了，march无效\n                if(dot(viewReflectDir, vN) >= 0.)\n                    continue;\n                float distance = pointPlaneDistance(vP, viewPosition, viewNormal);\n                // march距离超过最大\n                if(distance > maxDistance)\n                    break;\n                float op = opacity;\n                // 随着距离减弱反射，防止反射突然消失\n                #ifdef DISTANCE_ATTENUATION\n                float ratio = 1. - (distance / maxDistance);\n                float attenuation = ratio * ratio;\n                op = opacity * attenuation;\n                #endif\n                // 菲涅尔反射定律，与视野角度偏离越大，颜色权重越大\n                #ifdef FRESNEL\n                float fresnelCoe = (dot(viewIncidentDir, viewReflectDir) + 1.) / 2.;\n                op *= fresnelCoe;\n                #endif\n                // 读取反射颜色赋给当前片元\n                gl_FragColor = texture2D(tDiffuse, vUv);\n                vec4 reflectColor = texture2D(tDiffuse, uv);\n                reflectColor.a = op;\n                #ifdef SELECTIVE\n                reflectColor.a *= intensity;\n                #endif\n                gl_FragColor.rgb = mix(gl_FragColor.rgb, reflectColor.rgb, reflectColor.a);\n                // gl_FragColor = vec4(1.0, 0, 0, 1.0);\n                return;\n                \n                // break;\n            }\n        }\n    }\n    // gl_FragColor = texture2D(tDiffuse, vUv);\n}',this.uniforms=as.clone(wy),this.defines={MAX_STEP:0,PERSPECTIVE_CAMERA:!0,DISTANCE_ATTENUATION:!0,FRESNEL:!0,INFINITE_THICK:!1,SELECTIVE:!1},fy(this,["tDiffuse","tNormal","tDepth","tMetalness","cameraNear","cameraFar","threshold","thickness","opacity","tEnhancementScale"]),_y(this,[]),Object.defineProperties(this,{tEnhancement:{get:function(){return this.uniforms.tEnhancement.value},set:function(e){e?(this.uniforms.tEnhancement.value=e,this.defines.MVT_SSR_USE_ENHANCEMENT_MAP=!0):(this.uniforms.tEnhancement.value=null,delete this.defines.MVT_SSR_USE_ENHANCEMENT_MAP)}}}),this.setValues(e)}dispose(){let e=["tEnhancement","tDiffuse","tNormal","tDepth","tMetalness"];for(let t=0;t<e.length;t++){const i=e[t];this.uniforms[i]&&this.uniforms[i].value&&this.uniforms[i].value.dispose()}super.dispose()}}class Gy extends vm{constructor(){super();const e=this.material=new Sy;e.defines.DISTANCE_ATTENUATION=!0,e.defines.SELECTIVE=!0,this.fsQuad=new wm(null),this.needsSwap=!0,this.needsMetallicRoughTexture=!0,this.needsNormalTexture=!0,this.needsDepthTexture=!0}render(e,t,i){const n=this.rendering,s=n.main.sceneRendering,o=n.camera,r=this.material;r.uniforms.tDiffuse.value=i.texture,r.uniforms.tDepth.value=s.depthTexture,r.uniforms.tNormal.value=s.normalTexture,r.uniforms.tMetalness.value=s.metallicRoughTexture;const a=new bt(i.width,i.height);r.uniforms.resolution.value=a,r.defines.MAX_STEP=Math.min(512,Math.sqrt(a.x*a.x+a.y*a.y)),r.uniforms.cameraProjectionMatrix.value.copy(o.projectionMatrix),r.uniforms.cameraInverseProjectionMatrix.value.copy(o.projectionMatrixInverse),r.uniforms.mvt_viewInverseMatrix.value.copy(o.matrixWorld),r.uniforms.mvt_normalInverseMatrix.value.getNormalMatrix(o.matrixWorldInverse),r.uniforms.cameraNear.value=o.near,r.uniforms.cameraFar.value=o.far,this.fsQuad.material=r,e.setRenderTarget(this.renderToScreen?null:t),e.clear(),this.fsQuad.render(e)}dispose(){this.material.dispose(),this.fsQuad.dispose()}}class My extends kb{constructor(e,t){super(e,t),__publicField(this,"name","reflection"),__publicField(this,"_method","ssr"),__publicField(this,"_lastMethod","ssr"),__publicField(this,"_lastEnabled",!1),this.enabled=t.enabled,this._method=t.method}beginFrame(){this._lastEnabled===this.enabled?this.enabled&&this._lastMethod!==this._method&&(this._disableOldMethod(),this._enableNewMethod()):this.enabled?this._enableNewMethod():this._disableOldMethod()}_disableOldMethod(){const e=this._lastMethod,t=this._rendering;"ssr"===e&&(this._ssrPass&&t.main.postprocessings.remove(this._ssrPass),this._ssrPass=null)}_enableNewMethod(){const e=this._method,t=this._rendering;if("ssr"===e){const e=this._ssrPass=new Gy;e.renderOrder=800,e.rendering=t,t.main.postprocessings.add(e)}}afterRender(){}endFrame(){this._lastEnabled=this.enabled,this._lastMethod=this._method}dispose(){this.enabled&&this._disableOldMethod()}get method(){return this._method}set method(e){this._method=e}}const Ry=new Bi,Ty=new Qt,Zy=new qt,Vy=new Bi,Wy=new Bi,Ey=new Qt(0,1,0);class Ny{constructor(){__publicField(this,"maxFar",500),__publicField(this,"lightMargin",20),this.vertices={near:[new Qt,new Qt,new Qt,new Qt],far:[new Qt,new Qt,new Qt,new Qt]}}updateFromCameraProjectionMatrix(e,t=0){const i=e.projectionMatrixInverse;this.vertices.near[0].set(1,1,-1),this.vertices.near[1].set(1,-1,-1),this.vertices.near[2].set(-1,-1,-1),this.vertices.near[3].set(-1,1,-1),this.vertices.near.forEach((function(e){e.applyMatrix4(i)})),this.vertices.far[0].set(1,1,1),this.vertices.far[1].set(1,-1,1),this.vertices.far[2].set(-1,-1,1),this.vertices.far[3].set(-1,1,1);let n=Math.min(5*(e.position.z-t),this.maxFar);n=Math.max(n,50),this.vertices.far.forEach((e=>{e.applyMatrix4(i);const t=Math.abs(e.z);e.multiplyScalar(Math.min(n/t,1))}))}updateShadowBounds(e,t){const i=e.shadow.camera,n=this.vertices.near,s=this.vertices.far,o=s[0];let r;r=o.distanceTo(s[2])>o.distanceTo(n[2])?s[2]:n[2];let a=o.distanceTo(r);this.fade,i.left=-a/2,i.right=a/2,i.top=a/2,i.bottom=-a/2,i.updateProjectionMatrix()}updateLightPosition(e,t,i,n=1024,s=0){Vy.lookAt(new Qt,t,Ey),Wy.copy(Vy).invert();const o=e.shadow.camera,r=(o.right-o.left)/n,a=(o.top-o.bottom)/n;Ry.multiplyMatrices(Wy,i.matrixWorld);for(let c=0;c<4;c++)this.vertices.near[c].copy(this.vertices.near[c]).applyMatrix4(Ry),this.vertices.far[c].copy(this.vertices.far[c]).applyMatrix4(Ry);const l=this.vertices.near,g=this.vertices.far;Zy.makeEmpty();for(let c=0;c<4;c++)Zy.expandByPoint(l[c]),Zy.expandByPoint(g[c]);Zy.getCenter(Ty),Ty.z=Zy.max.z+this.lightMargin,Ty.x=Math.floor(Ty.x/r)*r,Ty.y=Math.floor(Ty.y/a)*a,Ty.applyMatrix4(Vy),e.position.copy(Ty),e.target.position.copy(Ty),e.target.position.x+=t.x,e.target.position.y+=t.y,e.target.position.z+=t.z}}class Fy{constructor(e){this._rendering=e,this._shadowFrustum=new Ny}update(e,t){const i=this._rendering._engine,[n,s]=i.map.getProjectionCenter();let o=i.map.getCameraDistance();const r=i.rendering.camera.position.z;let a=1e3;const l=a*t[0],g=a*t[1],c=a*t[2];e.position.set(n+l,s+g,c),e.target.position.set(n,s,0),e.shadow.camera.left=-o,e.shadow.camera.bottom=-o,e.shadow.camera.right=o,e.shadow.camera.top=o,e.shadow.camera.near=1,e.shadow.camera.far=r>1e3?2:2e3;const d=i.camera;this._shadowFrustum.updateFromCameraProjectionMatrix(d,i.rendering.shadow.baseHeight),this._shadowFrustum.updateShadowBounds(e,d),this._shadowFrustum.updateLightPosition(e,new Qt(-t.x,-t.y,-t.z),d,e.shadow.mapSize.x),e.updateMatrix(),e.updateMatrixWorld(),e.target.updateMatrix(),e.target.updateMatrixWorld(),e.shadow.camera.updateProjectionMatrix();const h=ft.mapLinear(r,1,1e4,-8e-5,-.5);e.shadow.bias=h<-.005?-.001:.2*h,this._currenLight=e}getCurrentUsedTextures(){if(this._currenLight)return[this._currenLight.shadow.map.texture]}dispose(){}}const Xy={lights_fragment_begin:"\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\n\nvec3 geometryClearcoatNormal = vec3( 0.0 );\n\n#ifdef USE_CLEARCOAT\n\n\tgeometryClearcoatNormal = clearcoatNormal;\n\n#endif\n\n#ifdef USE_IRIDESCENCE\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\tif ( material.iridescenceThickness == 0.0 ) {\n\t\tmaterial.iridescence = 0.0;\n\t} else {\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\t}\n\tif ( material.iridescence > 0.0 ) {\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\t\t// Iridescence F0 approximation\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\t}\n#endif\n\nIncidentLight directLight;\n\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\n\t\tpointLight = pointLights[ i ];\n\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tSpotLight spotLight;\n \tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n \n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\n\t\tspotLight = spotLights[ i ];\n\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\n  \t\t// spot lights are ordered [shadows with maps, shadows without maps, maps without shadows, none]\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct ) && defined( USE_CSM ) && defined( CSM_CASCADES )\n\n\tDirectionalLight directionalLight;\n\tfloat linearDepth = (vViewPosition.z) / (shadowFar - cameraNear);\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\n\t#if defined( USE_SHADOWMAP ) && defined( CSM_FADE )\n\tvec2 cascade;\n\tfloat cascadeCenter;\n\tfloat closestEdge;\n\tfloat margin;\n\tfloat csmx;\n\tfloat csmy;\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\n\t  \t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\t\t// NOTE: Depth gets larger away from the camera.\n\t\t\t// cascade.x is closer, cascade.y is further\n\t\t\tcascade = CSM_cascades[ i ];\n\t\t\tcascadeCenter = ( cascade.x + cascade.y ) / 2.0;\n\t\t\tclosestEdge = linearDepth < cascadeCenter ? cascade.x : cascade.y;\n\t\t\tmargin = 0.25 * pow( closestEdge, 2.0 );\n\t\t\tcsmx = cascade.x - margin / 2.0;\n\t\t\tcsmy = cascade.y + margin / 2.0;\n\t\t\tif( linearDepth >= csmx && ( linearDepth < csmy || UNROLLED_LOOP_INDEX == CSM_CASCADES - 1 ) ) {\n\n\t\t\t\tfloat dist = min( linearDepth - csmx, csmy - linearDepth );\n\t\t\t\tfloat ratio = clamp( dist / margin, 0.0, 1.0 );\n\n\t\t\t\tvec3 prevColor = directLight.color;\n\t\t\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\t\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\n\t\t\t\tbool shouldFadeLastCascade = UNROLLED_LOOP_INDEX == CSM_CASCADES - 1 && linearDepth > cascadeCenter;\n\t\t\t\tdirectLight.color = mix( prevColor, directLight.color, shouldFadeLastCascade ? ratio : 1.0 );\n\n\t\t\t\tReflectedLight prevLight = reflectedLight;\n\t\t\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t\t\t\tbool shouldBlend = UNROLLED_LOOP_INDEX != CSM_CASCADES - 1 || UNROLLED_LOOP_INDEX == CSM_CASCADES - 1 && linearDepth < cascadeCenter;\n\t\t\t\tfloat blendRatio = shouldBlend ? ratio : 1.0;\n\n\t\t\t\treflectedLight.directDiffuse = mix( prevLight.directDiffuse, reflectedLight.directDiffuse, blendRatio );\n\t\t\t\treflectedLight.directSpecular = mix( prevLight.directSpecular, reflectedLight.directSpecular, blendRatio );\n\t\t\t\treflectedLight.indirectDiffuse = mix( prevLight.indirectDiffuse, reflectedLight.indirectDiffuse, blendRatio );\n\t\t\t\treflectedLight.indirectSpecular = mix( prevLight.indirectSpecular, reflectedLight.indirectSpecular, blendRatio );\n\n\t\t\t}\n\t  \t#endif\n\n\t}\n\t#pragma unroll_loop_end\n\t#else\n\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\t\tdirectionalLight = directionalLights[ i ];\n\t\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\n\t\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\n\t\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\t\tif(linearDepth >= CSM_cascades[UNROLLED_LOOP_INDEX].x && linearDepth < CSM_cascades[UNROLLED_LOOP_INDEX].y) directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\n\t\t\tif(linearDepth >= CSM_cascades[UNROLLED_LOOP_INDEX].x && (linearDepth < CSM_cascades[UNROLLED_LOOP_INDEX].y || UNROLLED_LOOP_INDEX == CSM_CASCADES - 1)) RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t\t\t#endif\n\n\t\t}\n\t\t#pragma unroll_loop_end\n\n\t#endif\n\n\t#if ( NUM_DIR_LIGHTS > NUM_DIR_LIGHT_SHADOWS)\n\t\t// compute the lights not casting shadows (if any)\n\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = NUM_DIR_LIGHT_SHADOWS; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\t\tdirectionalLight = directionalLights[ i ];\n\n\t\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\n\t\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t\t}\n\t\t#pragma unroll_loop_end\n\n\t#endif\n\n#endif\n\n\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct ) && !defined( USE_CSM ) && !defined( CSM_CASCADES )\n\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tdirectionalLight = directionalLights[ i ];\n\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\n\tRectAreaLight rectAreaLight;\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if defined( RE_IndirectDiffuse )\n\n\tvec3 iblIrradiance = vec3( 0.0 );\n\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\n\t#if defined( USE_LIGHT_PROBES )\n\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\n\t#endif\n\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\n\t\t}\n\t\t#pragma unroll_loop_end\n\n\t#endif\n\n#endif\n\n#if defined( RE_IndirectSpecular )\n\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n\n#endif\n",lights_pars_begin:"\n#if defined( USE_CSM ) && defined( CSM_CASCADES )\nuniform vec2 CSM_cascades[CSM_CASCADES];\nuniform float cameraNear;\nuniform float shadowFar;\n#endif\n\t"+Bs.lights_pars_begin},Hy=new Bi;class zy{constructor(e){e=e||{},this.vertices={near:[new Qt,new Qt,new Qt,new Qt],far:[new Qt,new Qt,new Qt,new Qt]},void 0!==e.projectionMatrix&&this.setFromProjectionMatrix(e.projectionMatrix,e.maxFar||1e4)}setFromProjectionMatrix(e,t){const i=0===e.elements[11];return Hy.copy(e).invert(),this.vertices.near[0].set(1,1,-1),this.vertices.near[1].set(1,-1,-1),this.vertices.near[2].set(-1,-1,-1),this.vertices.near[3].set(-1,1,-1),this.vertices.near.forEach((function(e){e.applyMatrix4(Hy)})),this.vertices.far[0].set(1,1,1),this.vertices.far[1].set(1,-1,1),this.vertices.far[2].set(-1,-1,1),this.vertices.far[3].set(-1,1,1),this.vertices.far.forEach((function(e){e.applyMatrix4(Hy);const n=Math.abs(e.z);i?e.z*=Math.min(t/n,1):e.multiplyScalar(Math.min(t/n,1))})),this.vertices}split(e,t){for(;e.length>t.length;)t.push(new zy);t.length=e.length;for(let i=0;i<e.length;i++){const n=t[i];if(0===i)for(let e=0;e<4;e++)n.vertices.near[e].copy(this.vertices.near[e]);else for(let t=0;t<4;t++)n.vertices.near[t].lerpVectors(this.vertices.near[t],this.vertices.far[t],e[i-1]);if(i===e.length-1)for(let e=0;e<4;e++)n.vertices.far[e].copy(this.vertices.far[e]);else for(let t=0;t<4;t++)n.vertices.far[t].lerpVectors(this.vertices.near[t],this.vertices.far[t],e[i])}}toSpace(e,t){for(let i=0;i<4;i++)t.vertices.near[i].copy(this.vertices.near[i]).applyMatrix4(e),t.vertices.far[i].copy(this.vertices.far[i]).applyMatrix4(e)}}class Ly extends qr{constructor(e){super(),this.csm=e,this.displayFrustum=!0,this.displayPlanes=!0,this.displayShadowBounds=!0;const t=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),i=new Float32Array(24),n=new Fn;n.setIndex(new Bn(t,1)),n.setAttribute("position",new Bn(i,3,!1));const s=new Ka(n,new Wa);this.add(s),this.frustumLines=s,this.cascadeLines=[],this.cascadePlanes=[],this.shadowLines=[]}updateVisibility(){const e=this.displayFrustum,t=this.displayPlanes,i=this.displayShadowBounds,n=this.frustumLines,s=this.cascadeLines,o=this.cascadePlanes,r=this.shadowLines;for(let a=0,l=s.length;a<l;a++){const n=s[a],l=o[a],g=r[a];n.visible=e,l.visible=e&&t,g.visible=i}n.visible=e}update(){const e=this.csm,t=e.camera,i=e.cascades,n=e.mainFrustum,s=e.frustums,o=e.lights,r=this.frustumLines.geometry.getAttribute("position"),a=this.cascadeLines,l=this.cascadePlanes,g=this.shadowLines;for(this.position.copy(t.position),this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.updateMatrixWorld(!0);a.length>i;)this.remove(a.pop()),this.remove(l.pop()),this.remove(g.pop());for(;a.length<i;){const e=new Rg(new qt,16777215),t=new Cn({transparent:!0,opacity:.1,depthWrite:!1,side:2}),i=new ts(new xs,t),n=new qr,s=new Rg(new qt,16776960);n.add(s),this.add(e),this.add(i),this.add(n),a.push(e),l.push(i),g.push(n)}for(let h=0;h<i;h++){const e=s[h],t=o[h].shadow.camera,i=e.vertices.far,n=a[h],r=l[h],c=g[h],d=c.children[0];n.box.min.copy(i[2]),n.box.max.copy(i[0]),n.box.max.z+=1e-4,r.position.addVectors(i[0],i[2]),r.position.multiplyScalar(.5),r.scale.subVectors(i[0],i[2]),r.scale.z=1e-4,this.remove(c),c.position.copy(t.position),c.quaternion.copy(t.quaternion),c.scale.copy(t.scale),c.updateMatrixWorld(!0),this.attach(c),d.box.min.set(t.bottom,t.left,-t.far),d.box.max.set(t.top,t.right,-t.near)}const c=n.vertices.near,d=n.vertices.far;r.setXYZ(0,d[0].x,d[0].y,d[0].z),r.setXYZ(1,d[3].x,d[3].y,d[3].z),r.setXYZ(2,d[2].x,d[2].y,d[2].z),r.setXYZ(3,d[1].x,d[1].y,d[1].z),r.setXYZ(4,c[0].x,c[0].y,c[0].z),r.setXYZ(5,c[3].x,c[3].y,c[3].z),r.setXYZ(6,c[2].x,c[2].y,c[2].z),r.setXYZ(7,c[1].x,c[1].y,c[1].z),r.needsUpdate=!0}dispose(){const e=this.frustumLines,t=this.cascadeLines,i=this.cascadePlanes,n=this.shadowLines;e.geometry.dispose(),e.material.dispose();const s=this.csm.cascades;for(let o=0;o<s;o++){const e=t[o],s=i[o],r=n[o].children[0];e.dispose(),s.geometry.dispose(),s.material.dispose(),r.dispose()}}}const Dy=new Bi,Ky=new zy,Yy=new Qt,Py=new qt,ky=[],Oy=[],Uy=new Bi,Qy=new Bi,Jy=new Qt(0,0,1);const jy=[-5e-4,-8e-4,-.0015,-.004];class qy{constructor(e){__publicField(this,"_lights",null),__publicField(this,"_light",null),__publicField(this,"_parent",null),__publicField(this,"_cascades",4),__publicField(this,"_maxFar",1e3),__publicField(this,"_shadowMapSize",1024),__publicField(this,"_lightNear",1),__publicField(this,"_lightFar",1e3),__publicField(this,"_lightMargin",100),__publicField(this,"_shadowBias",-5e-4),__publicField(this,"_mainFrustum",null),__publicField(this,"_frustums",[]),__publicField(this,"_breaks",[]),__publicField(this,"_helper",null),__publicField(this,"_fade",!0),this._rendering=e,this._engine=e._engine,this._uniforms={CSM_cascades:{value:[]},cameraNear:{value:1},shadowFar:{value:1e3}}}init(){this._old_lights_fragment_begin=Bs.lights_fragment_begin,this._old_lights_pars_begin=Bs.lights_pars_begin,Bs.lights_fragment_begin=Xy.lights_fragment_begin,Bs.lights_pars_begin=Xy.lights_pars_begin}update(e,t,i){this._rendering._engine,this._light&&this._light!==e&&this._destroyLight(),this._light||(this._createLight(e,i),this._light=e);const n=new Qt(-t.x,-t.y,-t.z);this.updateFrame(e,n)}updateFrame(e,t){const i=this._engine.camera,n=this._frustums;Uy.lookAt(new Qt,t,Jy),Qy.copy(Uy).invert();for(let s=0;s<n.length;s++){const o=this._lights[s];o.color.copy(e.color),o.intensity=e.intensity;const r=o.shadow.camera,a=(r.right-r.left)/this._shadowMapSize,l=(r.top-r.bottom)/this._shadowMapSize;Dy.multiplyMatrices(Qy,i.matrixWorld),n[s].toSpace(Dy,Ky);const g=Ky.vertices.near,c=Ky.vertices.far;Py.makeEmpty();for(let e=0;e<4;e++)Py.expandByPoint(g[e]),Py.expandByPoint(c[e]);Py.getCenter(Yy),Yy.z=Py.max.z+this._lightMargin,Yy.x=Math.floor(Yy.x/a)*a,Yy.y=Math.floor(Yy.y/l)*l,Yy.applyMatrix4(Uy),o.position.copy(Yy),o.target.position.copy(Yy),o.target.position.x+=t.x,o.target.position.y+=t.y,o.target.position.z+=t.z}}_createLight(e,t){this._parent=t,this._lights=[],this._light=e,this._mainLightCastShadow=e.castShadow,e.castShadow=!1,e.visible=!1;for(let i=0;i<this._cascades;i++){const n=new ig(e.color,e.intensity);n.castShadow=!0,n.shadow.mapSize.width=this._shadowMapSize,n.shadow.mapSize.height=this._shadowMapSize,n.shadow.camera.near=this._lightNear,n.shadow.camera.far=this._lightFar,n.shadow.bias=this._shadowBias,n.shadow.bias=jy[i],n.shadow.normalBias=1e-4,t.add(n),t.add(n.target),this._lights.push(n)}this._mainFrustum=new zy,this._frustums=[],this.updateFrustums()}getBreaks(){const e=this._rendering._engine.camera,t=Math.min(e.far,this._maxFar);this._breaks.length=0,function(e,t,i,n,s){ky.length=0,Oy.length=0,function(e,t,i,n){for(let s=1;s<e;s++)n.push(t*(i/t)**(s/e)/i);n.push(1)}(e,t,i,Oy),function(e,t,i,n){for(let s=1;s<e;s++)n.push((t+(i-t)*s/e)/i);n.push(1)}(e,t,i,ky);for(let o=1;o<e;o++)s.push(ft.lerp(ky[o-1],Oy[o-1],n));s.push(1)}(this._cascades,e.near,t,.5,this._breaks),this._breaks=[.05,.2,.45,1],this.getExtendedBreaks(this._uniforms.CSM_cascades.value)}initCascades(){const e=this._rendering._engine.camera;this._mainFrustum.setFromProjectionMatrix(e.projectionMatrix,this._maxFar),this._mainFrustum.split(this._breaks,this._frustums)}updateShadowBounds(){const e=this._frustums;for(let t=0;t<e.length;t++){const i=this._lights[t].shadow.camera,n=e[t],s=n.vertices.near,o=n.vertices.far,r=o[0];let a;a=r.distanceTo(o[2])>r.distanceTo(s[2])?o[2]:s[2];let l=r.distanceTo(a);const g=this._engine.camera,c=Math.max(g.far,this._maxFar),d=n.vertices.far[0].z/(c-g.near);l+=2*(.25*Math.pow(d,2)*(c-g.near)),i.left=-l/2,i.right=l/2,i.top=l/2,i.bottom=-l/2,i.updateProjectionMatrix()}}updateUniforms(){const e=this._engine.camera,t=Math.min(e.far,this._maxFar),i=this._uniforms;i.cameraNear.value=e.near,i.shadowFar.value=t}getExtendedBreaks(e){for(;e.length<this._breaks.length;)e.push(new bt);e.length=this._breaks.length;for(let t=0;t<this._cascades;t++){const i=this._breaks[t],n=this._breaks[t-1]||0;e[t].x=n,e[t].y=i}}updateFrustums(){this.getBreaks(),this.initCascades(),this.updateShadowBounds(),this.updateUniforms()}updateCSMShadow(e,t){e.defines||(e.defines={}),this._fade&&(e.defines.CSM_FADE=""),e.defines.USE_CSM=1,e.defines.CSM_CASCADES=this._cascades,t.uniforms.CSM_cascades=this._uniforms.CSM_cascades,t.uniforms.cameraNear=this._uniforms.cameraNear,t.uniforms.shadowFar=this._uniforms.shadowFar}_destroyLight(){const e=this._light;e.castShadow=this._mainLightCastShadow,e.visible=!0,this._light=null;for(const t of this._lights)this._parent.remove(t),this._parent.remove(t.target)}dispose(){Bs.lights_fragment_begin=this._old_lights_fragment_begin,Bs.lights_pars_begin=this._old_lights_pars_begin,this._destroyLight()}getCurrentUsedTextures(){const e=[];for(const t of this._lights)e.push(t.shadow.map.texture);return e}get shadowBias(){return this._shadowBias}set shadowBias(e){this._shadowBias=e;for(const t of this._lights)t.shadow.bias=e}get showHelper(){return!!this._helper}set showHelper(e){e?(this._helper||(this._helper=new Ly(this._lights)),this._parent.add(this._helper)):(this._parent.remove(this._helper),this._helper=null)}}class $y extends kb{constructor(e,t){super(e,t),__publicField(this,"name","shadow"),__publicField(this,"_method","default"),__publicField(this,"_lastMethod","default"),__publicField(this,"_lastEnabled",!1),__publicField(this,"_baseHeight",0),__publicField(this,"needsShaderKey",!0),__publicField(this,"updateShadow",((e,t,i)=>{"default"===this._method?this._defaultShadow.update(e,t):"csm"===this._method&&this._csmShadow.update(e,t,i)})),__publicField(this,"getCurrentUsedTextures",(()=>{if(this.enabled)return"csm"===this._method?this._csmShadow.getCurrentUsedTextures():"default"===this._method?this._defaultShadow.getCurrentUsedTextures():void 0})),__publicField(this,"updateCSMShadow",((e,t)=>{"csm"===this._method&&this._csmShadow.updateCSMShadow(e,t)})),this.enabled=t.enabled,this._method=t.method}beginFrame(){this._lastEnabled===this.enabled?this.enabled&&this._lastMethod!==this._method&&(this._disableOldMethod(),this._enableNewMethod()):this.enabled?this._enableNewMethod():this._disableOldMethod()}_enableNewMethod(){const e=this._method,t=this._rendering;t.renderer.shadowMap.enabled=!0,"default"===e?(this._defaultShadow=new Fy(t),this._currentShaderKey="1"):"csm"===e&&(this._csmShadow=new qy(t),this._csmShadow.init(),this._currentShaderKey="2"),this._lastMethod=e}_disableOldMethod(){const e=this._lastMethod;this._rendering.renderer.shadowMap.enabled=!1,"default"===e?(this._defaultShadow.dispose(),this._defaultShadow=null):"csm"===e&&(this._csmShadow.dispose(),this._csmShadow=null),this._currentShaderKey="0"}getCurrentShaderKey(){return this._currentShaderKey}endFrame(){this._lastEnabled=this.enabled,this._lastMethod=this._method}set baseHeight(e){this._baseHeight=e}get baseHeight(){return this._baseHeight}get method(){return this._method}set method(e){this._method=e}}const e_=255/256,t_=new Dt(5.9371814131736755e-8,e_/65536,.0038909912109375,e_),i_=new Dt;class n_ extends kb{constructor(){super(...arguments),__publicField(this,"name","depthPicking"),__publicField(this,"_lastEnabled",!1),__publicField(this,"needsDepthTexture",!0)}beginFrame(){this._lastEnabled===this.enabled||(this.enabled?this._init():this.dispose())}_init(){const e=this._rendering,t=e.resolution,i=e.pixelRatio;this._depthColorRenderTarget=new Yt(t.x*i,t.y*i,{depthBuffer:!1}),this._fsQuad=new wm(new ls({name:Sm.name,vertexShader:Sm.vertexShader,fragmentShader:"\n#include <packing>\nuniform sampler2D tDiffuse;\nvarying vec2 vUv;\n\nvoid main() {\n\n    gl_FragColor = packDepthToRGBA(texture2D(tDiffuse, vUv).r);\n}\n",uniforms:{tDiffuse:{value:null},opacity:{value:1}}}))}_unpackRGBAToDepth(e){i_.set(e[0]/255,e[1]/255,e[2]/255,e[3]/255);return i_.dot(t_)}async pickDepth(e,t){const i=this._rendering,n=i.renderer,s=i.pixelRatio,o=new Uint8Array(4);n.readRenderTargetPixels(this._depthColorRenderTarget,e*s,t*s,1,1,o);let r=this._unpackRGBAToDepth(o);if(r>.99||r<1e-6)return null;const a=i.camera,l=a.far,g=a.near,c=2/(Math.log(l+1)/Math.log(2));let d=Math.pow(2,r/(.5*c))-1;return d=-d,r=(g+d)*l/((l-g)*d),r}afterRender(){if(!this.enabled)return;const e=this._rendering,t=e.main.sceneRendering;if(!t.depthTexture)return;this._fsQuad.material.uniforms.tDiffuse.value=t.depthTexture;const i=e.renderer,n=i.autoClear;i.autoClear=!1,i.setRenderTarget(this._depthColorRenderTarget),i.clear(),this._fsQuad.render(i),i.autoClear=n}endFrame(){this._lastEnabled=this.enabled}dispose(){this._fsQuad.material.dispose(),this._fsQuad.dispose(),this._depthColorRenderTarget.dispose(),this._depthColorRenderTarget=null,this._fsQuad=null}get viewTextures(){return this._depthColorRenderTarget?[this._depthColorRenderTarget.texture]:null}}class s_ extends vm{constructor(){super();const e=Sm;this.uniforms={tDiffuse:{value:null},saturation:{value:1},brightness:{value:0},contrast:{value:1}},this.material=new ls({uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:"\n\nuniform sampler2D tDiffuse;\nvarying vec2 vUv;\n\nuniform float saturation;\nuniform float brightness;\nuniform float contrast;\n\nvoid main() {\n    vec4 outColor = texture2D(tDiffuse, vUv);\n    vec3 grayscale = vec3(dot(outColor.xyz,  vec3(0.2126, 0.7152, 0.0722)));\n    outColor.xyz = mix(grayscale, outColor.xyz, 1.0 + saturation);\n\n    outColor.xyz = 0.5 + (1.0 + contrast) * (outColor.xyz - 0.5);\n    outColor.xyz = outColor.xyz + brightness;\n    gl_FragColor = outColor;\n}\n",depthTest:!1,depthWrite:!1}),this.needsSwap=!0,this.fsQuad=new wm(null)}render(e,t,i){const n=e.autoClear;e.autoClear=!1,this.fsQuad.material=this.material,this.material.uniforms.tDiffuse.value=i.texture,e.setRenderTarget(this.renderToScreen?null:t),e.clear(),this.fsQuad.render(e),e.autoClear=n}dispose(){this.material.dispose(),this.fsQuad.dispose()}get saturation(){return this.uniforms.saturation.value}set saturation(e){this.uniforms.saturation.value=e}get brightness(){return this.uniforms.brightness.value}set brightness(e){this.uniforms.brightness.value=e}get contrast(){return this.uniforms.contrast.value}set contrast(e){this.uniforms.contrast.value=e}}class o_ extends kb{constructor(e,t){super(e,t),__publicField(this,"name","ColorAdjustment"),__publicField(this,"_saturation",0),__publicField(this,"_brightness",0),__publicField(this,"_contrast",0),this.enabled=t.enabled,void 0!==t.saturation&&(this._saturation=t.saturation),void 0!==t.brightness&&(this._brightness=t.brightness),void 0!==t.contrast&&(this._contrast=t.contrast)}beginFrame(){if(this.enabled&&!this._renderPass){const e=this._renderPass=new s_;e.saturation=this._saturation,e.brightness=this._brightness,e.contrast=this._contrast,this._rendering.main.postprocessings.add(this._renderPass)}else!this.enabled&&this._renderPass&&(this._rendering.main.postprocessings.remove(this._renderPass),this._renderPass.dispose(),this._renderPass=null)}afterRender(){}endFrame(){}dispose(){this._renderPass&&(this._rendering.main.postprocessings.remove(this._renderPass),this._renderPass.dispose(),this._renderPass=null)}get saturation(){return this._saturation}set saturation(e){this._saturation=e,this._renderPass&&(this._renderPass.saturation=e)}get brightness(){return this._brightness}set brightness(e){this._brightness=e,this._renderPass&&(this._renderPass.brightness=e)}get contrast(){return this._contrast}set contrast(e){this._contrast=e,this._renderPass&&(this._renderPass.contrast=e)}}class r_ extends vm{constructor(e,t){super(),this.name="CameraFusionPass",this.needsSwap=!0,this._camera=t;const i=Sm;this.uniforms=as.merge([as.clone(i.uniforms),{tDepth:{value:null},tVideo:{value:e},projectionInverseMatrix:{value:new Bi},viewInverseMatrix:{value:new Bi},videoProjectionMatrix:{value:new Bi},videoViewMatrix:{value:new Bi},cameraNear:{value:null},cameraFar:{value:null},cameraPosition:{value:new Qt},opacity:{value:.5},k1:{value:0},k2:{value:0},k3:{value:0},p1:{value:0},p2:{value:0}}]),this.material=new ls({name:"VideoFusionMaterial",uniforms:this.uniforms,vertexShader:i.vertexShader,fragmentShader:"\nuniform sampler2D tDiffuse;\nuniform sampler2D tDepth;\nuniform sampler2D tVideo;\nuniform mat4 projectionInverseMatrix;\nuniform mat4 viewInverseMatrix;\nuniform mat4 videoProjectionMatrix;\nuniform mat4 videoViewMatrix;\nuniform float cameraNear;\nuniform float cameraFar;\nuniform float opacity;\n\nuniform float k1, k2, k3;\nuniform float p1, p2;\n\nvarying vec2 vUv;\n\n#include <packing>\n#include <mvt_depth_packing>\n\nbool visible(vec4 result) {\n    result.x /= result.w;\n    result.y /= result.w;\n    result.z /= result.w;\n\n    return result.x >= -1.0 && result.x <= 1.0 &&\n           result.y >= -1.0 && result.y <= 1.0 &&\n           result.z >= -1.0 && result.z <= 1.0;\n}\n\n// 畸变校正函数\nvec2 undistort(vec2 uv) {\n    // 将纹理坐标转换到[-1, 1]范围\n    vec2 uvNorm = uv * 2.0 - 1.0;\n\n    float r2 = uvNorm.x * uvNorm.x + uvNorm.y * uvNorm.y;\n    float radialDistortion = 1.0 + k1 * r2 + k2 * r2 * r2 + k3 * r2 * r2 * r2;\n    float tangentialDistortionX = 2.0 * p1 * uvNorm.x * uvNorm.y + p2 * (r2 + 2.0 * uvNorm.x * uvNorm.x);\n    float tangentialDistortionY = p1 * (r2 + 2.0 * uvNorm.y * uvNorm.y) + 2.0 * p2 * uvNorm.x * uvNorm.y;\n\n    uvNorm.x = uvNorm.x * radialDistortion + tangentialDistortionX;\n    uvNorm.y = uvNorm.y * radialDistortion + tangentialDistortionY;\n\n    // 将纹理坐标转换回[0, 1]范围\n    return (uvNorm + 1.0) / 2.0;\n}\n\nvoid main() {\n    vec4 diffuseColor = texture2D(tDiffuse, vUv);\n    vec4 outputColor = diffuseColor;\n\n    // 计算当前片元的世界坐标\n    float depth = mvtGetDepthFromTexture(tDepth, vUv, cameraNear, cameraFar);\n    vec3 worldPosition = mvtGetWorldPositionByDepth(depth, vUv, projectionInverseMatrix, viewInverseMatrix);\n\n    vec4 videoPos= videoProjectionMatrix * videoViewMatrix * vec4(worldPosition, 1.0);\n\n    // 在视野内的片元才进行融合\n    if (visible(videoPos) && depth <= 0.999999) {\n        vec4 gytyPosition = videoProjectionMatrix * videoViewMatrix * vec4(worldPosition.xyz, 1.0);\n        gytyPosition= gytyPosition / gytyPosition.w;\n        float s = (gytyPosition.s + 1.0) / 2.0;\n        float t = (gytyPosition.t + 1.0) / 2.0;\n        vec2 uv_depth = vec2(s, t);\n\n        // 对纹理坐标进行畸变校正\n        uv_depth = undistort(uv_depth);\n        if (uv_depth.x >= 0.0 && uv_depth.x <= 1.0 && uv_depth.y >= 0.0 && uv_depth.y <= 1.0) {\n            vec4 videoColor = texture2D(tVideo, uv_depth);\n            outputColor = mix(diffuseColor, videoColor, opacity);\n        }\n    }\n\n    gl_FragColor = outputColor;\n}\n"}),this.fsQuad=new wm(this.material)}render(e,t,i){const n=this.rendering.camera,s=this._camera,o=this.uniforms;o.tDiffuse.value=i.texture,o.tDepth.value=this.rendering.main.sceneRendering.depthTexture,o.projectionInverseMatrix.value.copy(n.projectionMatrixInverse),o.viewInverseMatrix.value.copy(n.matrixWorld),o.cameraNear.value=n.near,o.cameraFar.value=n.far,s&&(o.videoProjectionMatrix.value.copy(s.projectionMatrix),o.videoViewMatrix.value.copy(s.matrixWorldInverse)),!0===this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),e.clear(),this.fsQuad.render(e))}dispose(){this.material.dispose(),this.fsQuad.dispose()}set camera(e){this._camera=e}get camera(){return this._camera}set texture(e){this.uniforms.tVideo.value=e}get texture(){return this.uniforms.tVideo.value}set opacity(e){this.uniforms.opacity.value=e}get opacity(){return this.uniforms.opacity.value}}class a_ extends kb{constructor(){super(...arguments),__publicField(this,"name","CameraFusion"),__publicField(this,"_lastEnabled",!1),__publicField(this,"_camera",null),__publicField(this,"_texture",null),__publicField(this,"_opacity",.5)}beginFrame(){this._lastEnabled===this.enabled||(this.enabled?this._init():this.dispose())}_init(){const e=this._rendering,t=this._renderPass=new r_(this._texture,this._camera);t.opacity=this._opacity,t.renderOrder=600,e.main.postprocessings.add(this._renderPass)}afterRender(){}endFrame(){this._lastEnabled=this.enabled}dispose(){this._rendering.main.postprocessings.remove(this._renderPass),this._renderPass&&(this._renderPass.dispose(),this._renderPass=null)}set camera(e){e!==this._camera&&(this._camera&&this._rendering._engine.remove(this._camera),this._rendering._engine.add(e),this._renderPass&&(this._renderPass.camera=e),this._camera=e)}get camera(){return this._camera}set texture(e){this._texture=e,this._renderPass&&(this._renderPass.texture=e)}get texture(){return this._texture}set opacity(e){this._opacity=e,this._renderPass&&(this._renderPass.opacity=e)}get opacity(){return this._opacity}}class l_ extends kb{constructor(){super(...arguments),__publicField(this,"name","HDR"),__publicField(this,"_bufferType",F),__publicField(this,"_exposure",1),__publicField(this,"_lastEnabled",!1),__publicField(this,"needsFloatRenderTarget",!0)}beginFrame(){this._lastEnabled,this._enabled}endFrame(){this._lastEnabled=this.enabled}set enabled(e){this._enabled=!!e}get enabled(){return this._enabled}set exposure(e){this._exposure=e}get exposure(){return this._exposure}}class g_{constructor(e,t){__publicField(this,"_features",[]),this._rendering=e,this._bloom=new Ob(this._rendering,t.bloom),this._features.push(this._bloom),this._antialias=new ny(this._rendering,t.antialias),this._features.push(this._antialias),this._ao=new gy(this._rendering,t.ao),this._features.push(this._ao),this._reflection=new My(this._rendering,t.reflection),this._features.push(this._reflection),this._bufferView=new sy(this._rendering,t.bufferView),this._features.push(this._bufferView),this._stats=new Qb(this._rendering,t.stats),this._features.push(this._stats),this._shadow=new $y(this._rendering,t.shadow),this._features.push(this._shadow),this._depthPicking=new n_(this._rendering,t.depthPicking),this._features.push(this._depthPicking),this._colorAdjustment=new o_(this._rendering,t.colorAdjustment),this._features.push(this._colorAdjustment),this._cameraFusion=new a_(this._rendering),this._features.push(this._cameraFusion),this._hdr=new l_(this._rendering,t.hdr),this._features.push(this._hdr)}beginFrame(){for(const e of this._features)e.beginFrame()}afterRender(){for(const e of this._features)e.afterRender&&e.afterRender()}endFrame(){for(const e of this._features)e.endFrame()}updateReqirements(e){const t=[];for(const i of this._features)i.enabled&&(i.needsEmissiveTexture&&(e.needsEmissiveTexture=!0),i.needsNormalTexture&&(e.needsNormalTexture=!0),i.needsDepthTexture&&(e.needsDepthTexture=!0),i.needsMetallicRoughTexture&&(e.needsMetallicRoughTexture=!0),i.needsFloatRenderTarget&&(e.needsFloatRenderTarget=!0),i.needsShaderKey&&t.push(i.getCurrentShaderKey()));e.featuresShaderKey=t.join("")}get ao(){return this._ao}get bloom(){return this._bloom}get stats(){return this._stats}get bufferView(){return this._bufferView}get antialias(){return this._antialias}get reflection(){return this._reflection}get features(){return this._features}get shadow(){return this._shadow}get depthPicking(){return this._depthPicking}get colorAdjustment(){return this._colorAdjustment}get cameraFusion(){return this._cameraFusion}get hdr(){return this._hdr}}class c_{constructor(e){__publicField(this,"_renderTargets",[]),__publicField(this,"_locks",[]),__publicField(this,"_maxRenderTargets",10),this._rendering=e}beginFrame(){this._resetLocks(),this._rendering.main.requirements.isRenderTargetTypeChanged()&&this._disposeRenderTargets()}_disposeRenderTargets(){const e=this._renderTargets;for(let t=0;t<this._maxRenderTargets;t++)e[t]&&(e[t].dispose(),e[t]=null)}_resetLocks(){const e=this._locks;for(let t=0;t<this._maxRenderTargets;t++)e[t]=!1}getAvailableRenderTarget(){const e=this._renderTargets,t=this._locks,i=this._rendering,n=i.resolution,s=i.pixelRatio,o=i.main.requirements.getRenderTargetType();for(let r=0;r<this._maxRenderTargets;r++)if(e[r]||(e[r]=new Yt(n.x*s,n.y*s,{type:o,depthBuffer:!1,magFilter:T,minFilter:T,resolveDepthBuffer:!1,resolveStencilBuffer:!1}),e[r].name=`SharedFullScreenRenderTarget_${r}`),!t[r])return t[r]=!0,e[r];throw new Error("No available render target")}releaseRenderTarget(e){const t=this._renderTargets,i=this._locks;for(let n=0;n<this._maxRenderTargets;n++)if(t[n]===e)return void(i[n]=!1);console.warn("Invalid render target to release")}releaseRenderTargetByIndex(e){const t=this._locks;e<0||e>=this._maxRenderTargets?console.warn("Invalid render target to release"):t[e]=!1}lockRenderTarget(e){const t=this._renderTargets,i=this._locks;for(let n=0;n<this._maxRenderTargets;n++)if(t[n]===e)return void(i[n]=!0);console.warn("Invalid render target to lock")}setSize(e,t){const i=this._renderTargets,n=this._rendering.pixelRatio;for(let s=0;s<this._maxRenderTargets;s++)i[s]&&i[s].setSize(e*n,t*n)}endFrame(){}}class d_{constructor(e,t){__publicField(this,"_rendering"),__publicField(this,"_requirements"),__publicField(this,"_useMRT",!1),__publicField(this,"_lastUseMRT",null),__publicField(this,"_sceneRendering"),__publicField(this,"_features"),__publicField(this,"_postprocessings"),__publicField(this,"_opaquePostprocessings"),e._main=this,this._rendering=e,this._requirements=new Fb(e),this._features=new g_(e,t.features),this._postprocessings=new Db(e),this._opaquePostprocessings=new Kb(e),this._sharedFullScreenRenderTargets=new c_(e),e.postprocessings=this._postprocessings,e.opaquePostprocessings=this._opaquePostprocessings,e.sharedFullScreenRenderTargets=this._sharedFullScreenRenderTargets,e.features=this._features}beginFrame(){const e=this._rendering;if(e.isUseMRTChanged||!this._sceneRendering){let t=!0;this._sceneRendering&&(t=this._sceneRendering.useFastEmissiveMethod,this._sceneRendering.dispose()),e.useMRT?this._sceneRendering=new Nb(this._rendering):this._sceneRendering=new Eb(this._rendering),this._sceneRendering.useFastEmissiveMethod=t}this._features.beginFrame(),this._requirements.beginFrame(),this._sharedFullScreenRenderTargets.beginFrame(),this._sceneRendering.beginFrame(),this._opaquePostprocessings.beginFrame(),this._postprocessings.beginFrame()}render(){const e=this._rendering.renderState,t=this._sceneRendering,i=this._features,n=this._postprocessings,s=this._opaquePostprocessings,o=this._sharedFullScreenRenderTargets;let r=null;(this._rendering.useMRT||n.validCount>0||s.validCount>0)&&(r=o.getAvailableRenderTarget()),t.renderTarget=r,e.stage=10,s.show(),t.render(),s.hide(),e.stage=20,i.afterRender(),(this._rendering.useMRT||n.validCount>0)&&(e.stage=30,n.render())}endFrame(){this._requirements.endFrame(),this._features.endFrame(),this._sceneRendering.endFrame(),this._opaquePostprocessings.endFrame(),this._postprocessings.endFrame(),this._sharedFullScreenRenderTargets.endFrame()}setSize(e,t){this._rendering,this._sceneRendering&&this._sceneRendering.setSize(e,t),this._sharedFullScreenRenderTargets&&this._sharedFullScreenRenderTargets.setSize(e,t),this._opaquePostprocessings&&this._opaquePostprocessings.setSize(e,t),this._postprocessings&&this._postprocessings.setSize(e,t)}get sceneRendering(){return this._sceneRendering}get useFastEmissiveMethod(){return this._sceneRendering.useFastEmissiveMethod}set useFastEmissiveMethod(e){this._sceneRendering.useFastEmissiveMethod=e}get antialias(){return!0}get rendering(){return this._rendering}get requirements(){return this._requirements}get features(){return this._features}get postprocessings(){return this._postprocessings}get opaquePostprocessings(){return this._opaquePostprocessings}}new Qt;class h_{constructor(){__publicField(this,"isProjection",!0),__publicField(this,"isGeo",!1),__publicField(this,"isAxisAligned",!1)}projectCoordinate(e,t){throw new Error("projectCoordinate() must be implemented in derived classes")}unprojectCoordinate(e,t){throw new Error("unprojectCoordinate() must be implemented in derived classes")}geoBoxToProjectedBox(e,t){t||(t=new qt);const i=this.projectCoordinate(e.min),n=this.projectCoordinate(e.max);return t.min.copy(i),t.max.copy(n),t}getGeodeticSurfaceNormal(e,t){return t||(t=new Qt),t.set(0,0,1),t}getProjectedSurfaceNormal(e,t){return t||(t=new Qt),t.set(0,0,1),t}projectedBoxToGeoBox(e,t){t||(t=new qt);const i=this.unprojectCoordinate(e.min),n=this.unprojectCoordinate(e.max);return t.min.copy(i),t.max.copy(n),t}equals(e){return!!e&&this.name===e.name}getWorldBoundingBox(){const e=new qt(new Qt(-180,-90,-100),new Qt(180,90,100));return this.geoBoxToProjectedBox(e)}localFrameToFixedFrame(e,t){return t||(t=new Bi),t.identity(),t.setPosition(e),t}}const u_=(e,t,i,n)=>{if(Math.abs(e)<n)return t;return(e>0?1:-1)*(i*(1+(Math.abs(e)-n)/n))},I_=(e,t,i,n)=>{if(Math.abs(e)<i)return t;return(e>0?1:-1)*(n*(1+(Math.abs(e)-i)/i))},p_=Math.PI/180,m_=6378137,A_=20037508,C_=180/Math.PI,f_=85.0511287798;const b_=[0,0];class y_ extends h_{constructor(){super(...arguments),__publicField(this,"name",Tb),__publicField(this,"isAxisAligned",!0)}projectCoordinate(e,t){const i=function(e,t=null,i=!1){var n,s=Math.abs(e[0])<=180?e[0]:e[0]-360*((n=e[0])<0?-1:n>0?1:0);const o=t||[0,0];return o[0]=m_*s*p_,o[1]=m_*Math.log(Math.tan(.25*Math.PI+.5*e[1]*p_)),i?(o[0]=I_(e[0],o[0],180,A_),o[1]=I_(e[1],o[1],f_,A_)):(o[0]>A_&&(o[0]=A_),o[0]<-20037508&&(o[0]=-20037508),o[1]>A_&&(o[1]=A_),o[1]<-20037508&&(o[1]=-20037508)),o}([e.x,e.y],b_,!0);return t||(t=new Qt),t.x=i[0],t.y=i[1],t.z=e.z,t}unprojectCoordinate(e,t){const i=function(e,t,i=!1){const n=t||[0,0];return n[0]=e[0]*C_/m_,n[1]=(.5*Math.PI-2*Math.atan(Math.exp(-e[1]/m_)))*C_,i&&(n[0]=u_(e[0],n[0],180,A_),n[1]=u_(e[1],n[1],f_,A_)),n}([e.x,e.y],b_,!0);return t||(t=new Qt),t.x=i[0],t.y=i[1],t.z=e.z,t}}class __{static clone(e,t){return t||(t=new Dt),t.copy(e),t}static fromElements(e,t,i,n,s){return s||(s=new Dt),s.set(e,t,i,n),s}static lerp(e,t,i,n){return n||(n=new Dt),n.lerpVectors(e,t,i),n}static equals(e,t){return e.equals(t)}static normalize(e,t){return e===t?(e.normalize(),e):(t.copy(e),t.normalize(),t)}static add(e,t,i){return i||(i=new Dt),i.addVectors(e,t)}static multiplyByScalar(e,t,i){return i||(i=new Dt),i.copy(e).multiplyScalar(t),i}static subtract(e,t,i){return i||(i=new Dt),i.subVectors(e,t),i}static distance(e,t){return e.distanceTo(t)}}__publicField(__,"ZERO",new Dt(0,0,0,0)),__publicField(__,"UNIT_W",Object.freeze(new Dt(0,0,0,1)));const v_=new Qt,x_=new Qt,B_=new Bi,w_=new Dt(0,0,0,0),S_=new Qt;class G_{static fromPointNormal(e,t,i){return i||(i=new Cs),i.setFromNormalAndCoplanarPoint(t,e),i}static fromCartesian4(e,t){const i=jm.fromCartesian4(e,v_),n=e.w;if(!Km.equalsEpsilon(jm.magnitude(i),1,Km.EPSILON6))throw new Error("normal must be normalized.");return Hm(t)?(jm.clone(i,t.normal),t.constant=n,t):new G_(i,n)}static getPointDistance(e,t){return jm.dot(e.normal,t)+e.constant}static projectPointOntoPlane(e,t,i){Hm(i)||(i=new Qt);const n=G_.getPointDistance(e,t),s=jm.multiplyByScalar(e.normal,n,x_);return jm.subtract(t,s,i)}static transform(e,t,i){const n=e.normal,s=e.constant,o=Bi.inverseTranspose(t,B_);let r=__.fromElements(n.x,n.y,n.z,s,w_);r=Bi.multiplyByVector(o,r,r);const a=jm.fromCartesian4(r,S_);return r=__.divideByScalar(r,jm.magnitude(a),r),Cs.fromCartesian4(r,i)}static clone(e,t){return Hm(t)?(jm.clone(e.normal,t.normal),t.constant=e.constant,t):new G_(e.normal,e.constant)}static equals(e,t){return e.constant===t.constant&&jm.equals(e.normal,t.normal)}}Cs.ORIGIN_XY_PLANE=Object.freeze(new G_(jm.UNIT_Z,0)),Cs.ORIGIN_YZ_PLANE=Object.freeze(new G_(jm.UNIT_X,0)),Cs.ORIGIN_ZX_PLANE=Object.freeze(new G_(jm.UNIT_Y,0));const M_=new Dt(0,0,0,0),R_=new xi,T_=new Qt;class Z_{constructor(e,t){if(!Hm(e=(t=zm(t,eA.WGS84)).scaleToGeodeticSurface(e)))throw new Lm("origin must not be at the center of the ellipsoid.");const i=bA.eastNorthUpToFixedFrame(e,t);this._ellipsoid=t,this._origin=e,this._xAxis=jm.fromCartesian4(aA.getColumn(i,0,M_)),this._yAxis=jm.fromCartesian4(aA.getColumn(i,1,M_));const n=jm.fromCartesian4(aA.getColumn(i,2,M_));this._plane=G_.fromPointNormal(e,n)}static fromPoints(e,t){let i=e[0].x,n=e[0].y,s=e[0].z,o=e[0].x,r=e[0].y,a=e[0].z;for(let h=0;h<e.length;h++){const t=e[h],l=t.x,g=t.y,c=t.z;i=Math.min(l,i),o=Math.max(l,o),n=Math.min(g,n),r=Math.max(g,r),s=Math.min(c,s),a=Math.max(c,a)}const l=new Qt(i,n,s),g=new Qt(o,r,a),c=new qt(l,g);let d=new Qt;return d=c.getCenter(d),new Z_(d,t)}projectPointToNearestOnPlane(e,t){Hm(t)||(t=new oA);const i=R_;i.origin=e,jm.clone(this._plane.normal,i.direction);let n=YA.rayPlane(i,this._plane,T_);if(Hm(n)||(jm.negate(i.direction,i.direction),n=YA.rayPlane(i,this._plane,T_)),Hm(n)){const e=jm.subtract(n,this._origin,n),i=jm.dot(this._xAxis,e),s=jm.dot(this._yAxis,e);return Hm(t)?(t.x=i,t.y=s,t):new bt(i,s)}}projectPointsOntoPlane(e,t){Hm(t)||(t=[]);let i=0;const n=e.length;for(let s=0;s<n;s++){const n=this.projectPointOntoPlane(e[s],t[i]);n&&(t[i]=n,i++)}return t.length=i,t}projectPointOntoPlane(e,t){const i=R_;i.origin=e,jm.normalize(e,i.direction);let n=YA.rayPlane(i,this._plane,T_);if(Hm(n)||(jm.negate(i.direction,i.direction),n=YA.rayPlane(i,this._plane,T_)),Hm(n)){const e=jm.subtract(n,this._origin,n),i=jm.dot(this._xAxis,e),s=jm.dot(this._yAxis,e);return Hm(t)?(t.x=i,t.y=s,t):new bt(i,s)}}get ellipsoid(){return this._ellipsoid}get origin(){return this._origin}get plane(){return this._plane}get xAxis(){return this._xAxis}get yAxis(){return this._yAxis}get zAxis(){return this._plane.normal}}const V_=Object.freeze({OUTSIDE:-1,INTERSECTING:0,INSIDE:1});class W_{constructor(e,t){this.isOrientedBoundingBox=!0,this.center=jm.clone(zm(e,jm.ZERO),new Qt),this.halfAxes=rA.clone(zm(t,rA.ZERO))}intersectPlane(e){return W_.intersectPlane(this,e)}distanceSquaredTo(e){return W_.distanceSquaredTo(this,e)}computeCorners(e){return W_.computeCorners(this,e)}getCenter(e){return Hm(e)?(e.copy(this.center),e):this.center.clone()}intersectsObb(e){const t=this.center,i=e.center,n=this.halfAxes,s=e.halfAxes,o=(new Qt).subVectors(i,t),r=new Qt(n.elements[0],n.elements[1],n.elements[2]),a=new Qt(n.elements[3],n.elements[4],n.elements[5]),l=new Qt(n.elements[6],n.elements[7],n.elements[8]),g=new Qt(s.elements[0],s.elements[1],s.elements[2]),c=new Qt(s.elements[3],s.elements[4],s.elements[5]),d=new Qt(s.elements[6],s.elements[7],s.elements[8]),h=r.length(),u=a.length(),I=l.length();r.normalize(),a.normalize(),l.normalize();const p=g.length(),m=c.length(),A=d.length();let C,f,b;return g.normalize(),c.normalize(),d.normalize(),C=h,f=p*Math.abs(r.dot(g))+m*Math.abs(r.dot(c))+A*Math.abs(r.dot(d)),b=Math.abs(o.dot(r)),!(b>C+f)&&(C=u,f=p*Math.abs(a.dot(g))+m*Math.abs(a.dot(c))+A*Math.abs(a.dot(d)),b=Math.abs(o.dot(a)),!(b>C+f)&&(C=I,f=p*Math.abs(l.dot(g))+m*Math.abs(l.dot(c))+A*Math.abs(l.dot(d)),b=Math.abs(o.dot(l)),!(b>C+f)&&(C=h*Math.abs(g.dot(r))+u*Math.abs(g.dot(a))+I*Math.abs(g.dot(l)),f=p,b=Math.abs(o.dot(g)),!(b>C+f)&&(C=h*Math.abs(c.dot(r))+u*Math.abs(c.dot(a))+I*Math.abs(c.dot(l)),f=m,b=Math.abs(o.dot(c)),!(b>C+f)&&(C=h*Math.abs(d.dot(r))+u*Math.abs(d.dot(a))+I*Math.abs(d.dot(l)),f=A,b=Math.abs(o.dot(d)),!(b>C+f))))))}}const E_=new Qt,N_=new Qt;function F_(e,t,i,n,s,o,r,a,l,g,c){if(!(Hm(s)&&Hm(o)&&Hm(r)&&Hm(a)&&Hm(l)&&Hm(g)))throw new Lm("all extents (minimum/maximum X/Y/Z) are required.");Hm(c)||(c=new W_);const d=c.halfAxes;rA.setColumn(d,0,t,d),rA.setColumn(d,1,i,d),rA.setColumn(d,2,n,d);let h=E_;h.x=(s+o)/2,h.y=(r+a)/2,h.z=(l+g)/2;const u=N_;u.x=(o-s)/2,u.y=(a-r)/2,u.z=(g-l)/2;const I=c.center;return h=rA.multiplyByVector(d,h,h),jm.add(e,h,I),rA.multiplyByScale(d,u,d),c}const X_=new Qt,H_=new Qt,z_=new Qt,L_=new Qt,D_=new Qt,K_=new Qt,Y_=new Qt,P_=new Qt,k_=new Qt,O_=new Qt,U_=new Qt,Q_=new Qt,J_=new bt,j_=new bt,q_=new bt,$_=new bt,ev=new bt,tv=new Qt,iv=new Qt,nv=new Qt,sv=new Qt,ov=new bt,rv=new Qt,av=new Qt,lv=new Qt,gv=new Cs(new Qt(1,0,0),0);W_.fromRectangle=function(e,t,i,n,s){if(!Hm(e))throw new Lm("rectangle is required");if(e.width<0||e.width>Km.TWO_PI)throw new Lm("Rectangle width must be between 0 and 2 * pi");if(e.height<0||e.height>Km.PI)throw new Lm("Rectangle height must be between 0 and pi");if(Hm(n)&&!Km.equalsEpsilon(n.radii.x,n.radii.y,Km.EPSILON15))throw new Lm("Ellipsoid must be an ellipsoid of revolution (radii.x == radii.y)");let o,r,a,l,g,c,d;if(t=zm(t,0),i=zm(i,0),n=zm(n,eA.WGS84),e.width<=Km.PI){const h=IA.center(e,X_),u=n.cartographicToCartesian(h,H_),I=new Z_(u,n);d=I.plane;const p=h.x,m=e.south<0&&e.north>0?0:h.y,A=RC.fromRadians(p,e.north,i,z_),C=RC.fromRadians(e.west,e.north,i,L_),f=RC.fromRadians(e.west,m,i,D_),b=RC.fromRadians(e.west,e.south,i,K_),y=RC.fromRadians(p,e.south,i,Y_),_=n.cartographicToCartesian(A,P_);let v=n.cartographicToCartesian(C,k_);const x=n.cartographicToCartesian(f,O_);let B=n.cartographicToCartesian(b,U_);const w=n.cartographicToCartesian(y,Q_),S=I.projectPointToNearestOnPlane(_,J_),G=I.projectPointToNearestOnPlane(v,j_),M=I.projectPointToNearestOnPlane(x,q_),R=I.projectPointToNearestOnPlane(B,$_),T=I.projectPointToNearestOnPlane(w,ev);return o=Math.min(G.x,M.x,R.x),r=-o,l=Math.max(G.y,S.y),a=Math.min(R.y,T.y),C.z=b.z=t,v=n.cartographicToCartesian(C,k_),B=n.cartographicToCartesian(b,U_),g=Math.min(G_.getPointDistance(d,v),G_.getPointDistance(d,B)),c=i,F_(I.origin,I.xAxis,I.yAxis,I.zAxis,o,r,a,l,g,c,s)}const h=e.south>0,u=e.north<0,I=h?e.south:u?e.north:0,p=IA.center(e,X_).x,m=jm.fromRadians(p,I,i,n,tv);m.z=0;const A=Math.abs(m.x)<Km.EPSILON10&&Math.abs(m.y)<Km.EPSILON10?jm.UNIT_X:jm.normalize(m,iv),C=jm.UNIT_Z,f=jm.cross(A,C,nv);d=G_.fromPointNormal(m,A,gv);const b=jm.fromRadians(p+Km.PI_OVER_TWO,I,i,n,sv);r=jm.dot(G_.projectPointOntoPlane(d,b,ov),f),o=-r,l=jm.fromRadians(0,e.north,u?t:i,n,rv).z,a=jm.fromRadians(0,e.south,h?t:i,n,av).z;const y=jm.fromRadians(e.east,I,i,n,lv);return g=G_.getPointDistance(d,y),c=0,F_(m,f,C,A,o,r,a,l,g,c,s)};const cv=new Qt,dv=new Qt,hv=new Qt,uv=new Qt,Iv=new Qt,pv=new Qt;W_.distanceSquaredTo=function(e,t){if(!Hm(e))throw new Lm("box is required.");if(!Hm(t))throw new Lm("cartesian is required.");const i=jm.subtract(t,e.center,E_),n=e.halfAxes;let s=rA.getColumn(n,0,cv),o=rA.getColumn(n,1,dv),r=rA.getColumn(n,2,hv);const a=jm.magnitude(s),l=jm.magnitude(o),g=jm.magnitude(r);let c=!0,d=!0,h=!0;a>0?jm.divideByScalar(s,a,s):c=!1,l>0?jm.divideByScalar(o,l,o):d=!1,g>0?jm.divideByScalar(r,g,r):h=!1;const u=!c+!d+!h;let I,p,m;if(1===u){let e=s;I=o,p=r,d?h||(e=r,p=s):(e=o,I=s),m=jm.cross(I,p,Iv),e===s?s=m:e===o?o=m:e===r&&(r=m)}else if(2===u){I=s,d?I=o:h&&(I=r);let e=jm.UNIT_Y;jm.equalsEpsilon(e,I,Km.EPSILON3)&&(e=jm.UNIT_X),p=jm.cross(I,e,uv),jm.normalize(p,p),m=jm.cross(I,p,Iv),jm.normalize(m,m),I===s?(o=p,r=m):I===o?(r=p,s=m):I===r&&(s=p,o=m)}else 3===u&&(s=jm.UNIT_X,o=jm.UNIT_Y,r=jm.UNIT_Z);const A=pv;A.x=jm.dot(i,s),A.y=jm.dot(i,o),A.z=jm.dot(i,r);let C,f=0;return A.x<-a?(C=A.x+a,f+=C*C):A.x>a&&(C=A.x-a,f+=C*C),A.y<-l?(C=A.y+l,f+=C*C):A.y>l&&(C=A.y-l,f+=C*C),A.z<-g?(C=A.z+g,f+=C*C):A.z>g&&(C=A.z-g,f+=C*C),f},W_.intersectPlane=function(e,t){if(!Hm(e))throw new Lm("box is required.");if(!Hm(t))throw new Lm("plane is required.");const i=e.center,n=t.normal,s=e.halfAxes,o=n.x,r=n.y,a=n.z,l=s.elements,g=Math.abs(o*l[rA.COLUMN0ROW0]+r*l[rA.COLUMN0ROW1]+a*l[rA.COLUMN0ROW2])+Math.abs(o*l[rA.COLUMN1ROW0]+r*l[rA.COLUMN1ROW1]+a*l[rA.COLUMN1ROW2])+Math.abs(o*l[rA.COLUMN2ROW0]+r*l[rA.COLUMN2ROW1]+a*l[rA.COLUMN2ROW2]),c=jm.dot(n.clone(),i)+t.constant;return c<=-g?V_.OUTSIDE:c>=g?V_.INSIDE:V_.INTERSECTING};const mv=new Qt,Av=new Qt,Cv=new Qt;W_.computeCorners=function(e,t){Hm(t)||(t=[new Qt,new Qt,new Qt,new Qt,new Qt,new Qt,new Qt,new Qt]);const i=e.center,n=e.halfAxes,s=rA.getColumn(n,0,mv),o=rA.getColumn(n,1,Av),r=rA.getColumn(n,2,Cv);return jm.clone(i,t[0]),jm.subtract(t[0],s,t[0]),jm.subtract(t[0],o,t[0]),jm.subtract(t[0],r,t[0]),jm.clone(i,t[1]),jm.subtract(t[1],s,t[1]),jm.subtract(t[1],o,t[1]),jm.add(t[1],r,t[1]),jm.clone(i,t[2]),jm.subtract(t[2],s,t[2]),jm.add(t[2],o,t[2]),jm.subtract(t[2],r,t[2]),jm.clone(i,t[3]),jm.subtract(t[3],s,t[3]),jm.add(t[3],o,t[3]),jm.add(t[3],r,t[3]),jm.clone(i,t[4]),jm.add(t[4],s,t[4]),jm.subtract(t[4],o,t[4]),jm.subtract(t[4],r,t[4]),jm.clone(i,t[5]),jm.add(t[5],s,t[5]),jm.subtract(t[5],o,t[5]),jm.add(t[5],r,t[5]),jm.clone(i,t[6]),jm.add(t[6],s,t[6]),jm.add(t[6],o,t[6]),jm.subtract(t[6],r,t[6]),jm.clone(i,t[7]),jm.add(t[7],s,t[7]),jm.add(t[7],o,t[7]),jm.add(t[7],r,t[7]),t},W_.fromGeoBoundingBox=function(e,t){if(!Hm(e))throw new Lm("geoBoundingBox is required.");const i=e.min,n=e.max,s=IA.fromBox(e,null,!0);return W_.fromRectangle(s,i.z,n.z,null,t)};class fv extends h_{constructor(){super(...arguments),__publicField(this,"name",Zb)}projectCoordinate(e,t){return eA.WGS84.cartographicDegreeToCartesian(e,t)}unprojectCoordinate(e,t){return eA.WGS84.cartesianToCartographicDegree(e,t)}getGeodeticSurfaceNormal(e,t){t||(t=new Qt);return eA.WGS84.geodeticSurfaceNormalCartographic(e,t)}getProjectedSurfaceNormal(e,t){t||(t=new Qt);return eA.WGS84.geodeticSurfaceNormal(e,t)}geoBoxToProjectedBox(e,t){return t||(t=new W_),t=W_.fromGeoBoundingBox(e,t)}getLODSacleOfGeoBoundingBox(e){if(e.min.y>85||e.max.y<-85)return 0;const t=(e.min.y+e.max.y)/2;return Math.cos(ft.degToRad(t))}localFrameToFixedFrame(e,t){return t||(t=new Bi),bA.eastNorthUpToFixedFrame(e,null,t),t}}function bv(){}function yv(e,t){for(let i in t)e[i]=t[i]}function _v(e,t){this.lng=e,this.lat=t}function vv(e,t){this.x=e,this.y=t}yv(_v.prototype,{equals:function(e){return this.lat===e.lat&&this.lng===e.lng},clone:function(){return new _v(this.lat,this.lng)},getLngSpan:function(e){let t=this.lng,i=Math.abs(e-t);return i>180&&(i=360-i),i},sub:function(e){return new _v(this.lat-e.lat,this.lng-e.lng)},toString:function(){return"Point"}}),yv(bv,{EARTHRADIUS:6370996.81,MCBAND:[12890594.86,8362377.87,5591021,3481989.83,1678043.12,0],LLBAND:[75,60,45,30,15,0],MC2LL:[[1.410526172116255e-8,898305509648872e-20,-1.9939833816331,200.9824383106796,-187.2403703815547,91.6087516669843,-23.38765649603339,2.57121317296198,-.03801003308653,17337981.2],[-7.435856389565537e-9,8983055097726239e-21,-.78625201886289,96.32687599759846,-1.85204757529826,-59.36935905485877,47.40033549296737,-16.50741931063887,2.28786674699375,10260144.86],[-3.030883460898826e-8,898305509983578e-20,.30071316287616,59.74293618442277,7.357984074871,-25.38371002664745,13.45380521110908,-3.29883767235584,.32710905363475,6856817.37],[-1.981981304930552e-8,8983055099779535e-21,.03278182852591,40.31678527705744,.65659298677277,-4.44255534477492,.85341911805263,.12923347998204,-.04625736007561,4482777.06],[3.09191371068437e-9,8983055096812155e-21,6995724062e-14,23.10934304144901,-.00023663490511,-.6321817810242,-.00663494467273,.03430082397953,-.00466043876332,2555164.4],[2.890871144776878e-9,8983055095805407e-21,-3.068298e-8,7.47137025468032,-353937994e-14,-.02145144861037,-1234426596e-14,.00010322952773,-323890364e-14,826088.5]],LL2MC:[[-.0015702102444,111320.7020616939,0x60e374c3105a3,-0x24bb4115e2e164,0x5cc55543bb0ae8,-0x7ce070193f3784,0x5e7ca61ddf8150,-0x261a578d8b24d0,0x665d60f3742ca,82.5],[.0008277824516172526,111320.7020463578,647795574.6671607,-4082003173.641316,10774905663.51142,-15171875531.51559,12053065338.62167,-5124939663.577472,913311935.9512032,67.5],[.00337398766765,111320.7020202162,4481351.045890365,-23393751.19931662,79682215.47186455,-115964993.2797253,97236711.15602145,-43661946.33752821,8477230.501135234,52.5],[.00220636496208,111320.7020209128,51751.86112841131,3796837.749470245,992013.7397791013,-1221952.21711287,1340652.697009075,-620943.6990984312,144416.9293806241,37.5],[-.0003441963504368392,111320.7020576856,278.2353980772752,2485758.690035394,6070.750963243378,54821.18345352118,9540.606633304236,-2710.55326746645,1405.483844121726,22.5],[-.0003218135878613132,111320.7020701615,.00369383431289,823725.6402795718,.46104986909093,2351.343141331292,1.58060784298199,8.77738589078284,.37238884252424,7.45]],getDistanceByMC:function(e,t){if(!e||!t)return 0;let i,n,s,o;return(e=this.convertMC2LL(e))?(i=this.toRadians(e.lng),n=this.toRadians(e.lat),(t=this.convertMC2LL(t))?(s=this.toRadians(t.lng),o=this.toRadians(t.lat),this.getDistance(i,s,n,o)):0):0},getDistanceByLL:function(e,t){if(!e||!t)return 0;let i,n,s,o;return e.lng=this.getLoop(e.lng,-180,180),e.lat=this.getRange(e.lat,-74,74),t.lng=this.getLoop(t.lng,-180,180),t.lat=this.getRange(t.lat,-74,74),i=this.toRadians(e.lng),s=this.toRadians(e.lat),n=this.toRadians(t.lng),o=this.toRadians(t.lat),this.getDistance(i,n,s,o)},convertMC2LL:function(e){if(null==e)return new _v(0,0);if(e.lng<180&&e.lng>-180&&e.lat<90&&e.lat>-90)return e;let t,i;t=new _v(Math.abs(e.lng),Math.abs(e.lat));for(let s=0;s<this.MCBAND.length;s++)if(t.lat>=this.MCBAND[s]){i=this.MC2LL[s];break}let n=this.convertor(e,i);return e=new _v(n.lng.toFixed(6),n.lat.toFixed(6))},convertLL2MC:function(e){if(null==e)return new _v(0,0);if(e.lng>180||e.lng<-180||e.lat>90||e.lat<-90)return e;let t,i;if(e.lng=this.getLoop(e.lng,-180,180),e.lat=this.getRange(e.lat,-74,74),t=new _v(e.lng,e.lat),window.BMAPGL_84){var n={},s=6378137;n.lng=t.lng*Math.PI/180*s;var o=t.lat*Math.PI/180;return n.lat=3189068.5*Math.log((1+Math.sin(o))/(1-Math.sin(o))),new _v(Number(n.lng),Number(n.lat))}for(var r=0;r<this.LLBAND.length;r++)if(t.lat>=this.LLBAND[r]){i=this.LL2MC[r];break}if(!i)for(r=0;r<this.LLBAND.length;r++)if(t.lat<=-this.LLBAND[r]){i=this.LL2MC[r];break}let a=this.convertor(e,i);return e=new _v(Number(a.lng),Number(a.lat))},convertor:function(e,t){if(!e||!t)return;let i=t[0]+t[1]*Math.abs(e.lng),n=Math.abs(e.lat)/t[9],s=t[2]+t[3]*n+t[4]*n*n+t[5]*n*n*n+t[6]*n*n*n*n+t[7]*n*n*n*n*n+t[8]*n*n*n*n*n*n;return i*=e.lng<0?-1:1,s*=e.lat<0?-1:1,new _v(i,s)},getDistance:function(e,t,i,n){return this.EARTHRADIUS*Math.acos(Math.sin(i)*Math.sin(n)+Math.cos(i)*Math.cos(n)*Math.cos(t-e))},toRadians:function(e){return Math.PI*e/180},toDegrees:function(e){return 180*e/Math.PI},getRange:function(e,t,i){return null!=t&&(e=Math.max(e,t)),null!=i&&(e=Math.min(e,i)),e},getLoop:function(e,t,i){for(;e>i;)e-=i-t;for(;e<t;)e+=i-t;return e}}),yv(bv.prototype,{lngLatToMercator:function(e){return bv.convertLL2MC(e)},lngLatToPoint:function(e){let t=bv.convertLL2MC(e);return new vv(t.lng,t.lat)},mercatorToLngLat:function(e){return bv.convertMC2LL(e)},pointToLngLat:function(e){let t=new _v(e.x,e.y);return bv.convertMC2LL(t)},pointToPixel:function(e,t,i,n,s){if(!e)return;e=this.lngLatToMercator(e,s);let o=this.getZoomUnits(t);return new vv(Math.round((e.lng-i.lng)/o+n.width/2),Math.round((i.lat-e.lat)/o+n.height/2))},pixelToPoint:function(e,t,i,n,s){if(!e)return;let o=this.getZoomUnits(t),r=new _v(i.lng+o*(e.x-n.width/2),i.lat-o*(e.y-n.height/2));return this.mercatorToLngLat(r,s)},getZoomUnits:function(e){return Math.pow(2,18-e)}});const xv=20037724.16,Bv=85.05112877980659;class wv extends h_{constructor(){super(...arguments),__publicField(this,"name",Vb),__publicField(this,"isAxisAligned",!0),__publicField(this,"unprojectCoordinate",((e,t)=>{t||(t=new Qt);const i=bv.convertMC2LL({lng:e.x,lat:e.y});return t.set(Number(i.lng),Number(i.lat),e.z),t.x=u_(e.x,t.x,180,xv),t.y=u_(e.y,t.y,Bv,xv),t}))}projectCoordinate(e,t){t||(t=new Qt);const i=bv.convertLL2MC({lng:e.x,lat:e.y});return t.set(Number(i.lng),Number(i.lat),e.z),t.x=I_(e.x,t.x,180,xv),t.y=I_(e.y,t.y,Bv,xv),t}}const Sv=6378137*Math.PI/180;class Gv extends h_{constructor(){super(...arguments),__publicField(this,"name",Rb),__publicField(this,"isGeo",!0),__publicField(this,"isAxisAligned",!0)}projectCoordinate(e,t){return t||(t=new Qt),t.x=e.x*Sv,t.y=e.y*Sv,t.z=e.z,t}unprojectCoordinate(e,t){return t||(t=new Qt),t.x=e.x/Sv,t.y=e.y/Sv,t.z=e.z,t}}class Mv extends h_{constructor(){super(...arguments),__publicField(this,"name",Wb),__publicField(this,"isAxisAligned",!0)}projectCoordinate(e,t){return t||(t=new Qt),t.x=e.x,t.y=-e.y,t.z=e.z,t}unprojectCoordinate(e,t){return t||(t=new Qt),t.x=e.x,t.y=-e.y,t.z=e.z,t}}const Rv={},Tv=e=>{if(e=(e=>"EPSG:900913"===(e=e.toUpperCase().trim())?Tb:"GLOBE"===e||"ECEF"===e?Zb:e)(e),!Rv[e])switch(e){case Tb:Rv[e]=new y_;break;case Zb:Rv[e]=new fv;break;case Vb:Rv[e]=new wv;break;case Rb:Rv[e]=new Gv;break;case Wb:Rv[e]=new Mv;break;default:throw new Error(`Unsupported projection: ${e}`)}return Rv[e]},Zv=new Qt,Vv=new Qt,Wv=(e,t)=>{if(e)if(0===t)void 0===e[2]&&(e[2]=0);else for(const i of e)Wv(i,t-1)};function Ev(e,t){if(e)if("FeatureCollection"===e.type||e.features){const i=e.features;for(const e of i)Ev(e,t)}else if(Array.isArray(e)){const i=e;for(const e of i)Ev(e,t)}else if("Feature"===e.type||e.geometry){if(!e.geometry)return;if(Array.isArray(e.geometry.coordinates)){if(e.geometry[t.name])return;Xv(e);const i=Nv(e.geometry.coordinates,t);e.geometry[t.name]=i}}}function Nv(e,t){if(Array.isArray(e[0])){const i=[];for(let n of e)i.push(Nv(n,t));return i}if("number"==typeof e[0]||"string"==typeof e[0])return Zv.set(e[0],e[1],e[2]||0),t.projectCoordinate(Zv,Vv),[Vv.x,Vv.y,Vv.z]}function Fv(e,t){if(Array.isArray(e[0])){const i=[];for(let n of e)i.push(Fv(n,t));return i}if("number"==typeof e[0]||"string"==typeof e[0])return Zv.set(e[0],e[1],e[2]||0),t.unprojectCoordinate(Zv,Vv),[Vv.x,Vv.y,Vv.z]}function Xv(e){e.type||(e.type="Feature");const t=e.geometry.type,i={Point:0,MultiPoint:1,LineString:1,MultiLineString:2,Polygon:2,MultiPolygon:3};return Object.keys(i).includes(t)&&Wv(e.geometry.coordinates,i[t]),e}function Hv(e,t,i){if(null===e)return;let n,s,o,r,a,l,g,c,d=0,h=0,u=e.type,I="FeatureCollection"===u,p="Feature"===u,m=I?e.features.length:1;for(let A=0;A<m;A++){g=I?e.features[A].geometry:p?e.geometry:e,c=!!g&&"GeometryCollection"===g.type,a=c?g.geometries.length:1;for(let e=0;e<a;e++){let a=0,u=0;if(r=c?g.geometries[e]:g,null===r)continue;l=r.coordinates;let I=r.type;switch(d=!i||"Polygon"!==I&&"MultiPolygon"!==I?0:1,I){case null:break;case"Point":if(!1===t(l,h,A,a,u))return!1;h++,a++;break;case"LineString":case"MultiPoint":for(n=0;n<l.length;n++){if(!1===t(l[n],h,A,a,u))return!1;h++,"MultiPoint"===I&&a++}"LineString"===I&&a++;break;case"Polygon":case"MultiLineString":for(n=0;n<l.length;n++){for(s=0;s<l[n].length-d;s++){if(!1===t(l[n][s],h,A,a,u))return!1;h++}"MultiLineString"===I&&a++,"Polygon"===I&&u++}"Polygon"===I&&a++;break;case"MultiPolygon":for(n=0;n<l.length;n++){for(u=0,s=0;s<l[n].length;s++){for(o=0;o<l[n][s].length-d;o++){if(!1===t(l[n][s][o],h,A,a,u))return!1;h++}u++}a++}break;case"GeometryCollection":for(n=0;n<r.geometries.length;n++)if(!1===Hv(r.geometries[n],t,i))return!1;break;default:throw new Error("Unknown Geometry Type")}}}}function zv(e,t){let i,n,s,o,r,a,l,g,c,d,h=0,u="FeatureCollection"===e.type,I="Feature"===e.type,p=u?e.features.length:1;for(i=0;i<p;i++){for(a=u?e.features[i].geometry:I?e.geometry:e,g=u?e.features[i].properties:I?e.properties:{},c=u?e.features[i].bbox:I?e.bbox:void 0,d=u?e.features[i].id:I?e.id:void 0,l=!!a&&"GeometryCollection"===a.type,r=l?a.geometries.length:1,s=0;s<r;s++)if(o=l?a.geometries[s]:a,null!==o)switch(o.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":if(!1===t(o,h,g,c,d))return!1;break;case"GeometryCollection":for(n=0;n<o.geometries.length;n++)if(!1===t(o.geometries[n],h,g,c,d))return!1;break;default:throw new Error("Unknown Geometry Type")}else if(!1===t(null,h,g,c,d))return!1;h++}}function Lv(e,t,i){let n=i;return zv(e,(function(e,s,o,r,a){n=0===s&&void 0===i?e:t(n,e,s,o,r,a)})),n}function Dv(e,t={}){if(null!=e.bbox&&!0!==t.recompute)return e.bbox;const i=[1/0,1/0,-1/0,-1/0];return Hv(e,(e=>{i[0]>e[0]&&(i[0]=e[0]),i[1]>e[1]&&(i[1]=e[1]),i[2]<e[0]&&(i[2]=e[0]),i[3]<e[1]&&(i[3]=e[1])})),i}function Kv(e){if(Array.isArray(e))return e;if("Feature"===e.type){if(null!==e.geometry)return e.geometry.coordinates}else if(e.coordinates)return e.coordinates;throw new Error("coords must be GeoJSON Feature, Geometry Object or an Array")}function Yv(e){return"Feature"===e.type?e.geometry:e}function Pv(e,t){return t[0]<=e[0]&&t[1]<=e[1]&&t[2]>=e[0]&&t[3]>=e[1]}function kv(e,t){let i=0,n=0,s=0,o=0,r=0,a=0,l=0,g=0,c=null,d=null;const h=e[0],u=e[1],I=t.length;for(;i<I;i++){n=0;const I=t[i].length-1,p=t[i];if(c=p[0],c[0]!==p[I][0]&&c[1]!==p[I][1])throw new Error("First and last coordinates in a ring must be the same");for(r=c[0]-h,a=c[1]-u;n<I;n++)if(d=p[n+1],g=d[1]-u,a<0&&g<0||a>0&&g>0)c=d,a=g,r=c[0]-h;else{if(l=d[0]-e[0],g>0&&a<=0){if(o=r*g-l*a,o>0)s+=1;else if(0===o)return 0}else if(a>0&&g<=0){if(o=r*g-l*a,o<0)s+=1;else if(0===o)return 0}else if(0===g&&a<0){if(o=r*g-l*a,0===o)return 0}else if(0===a&&g<0){if(o=r*g-l*a,0===o)return 0}else if(0===a&&0===g){if(l<=0&&r>=0)return 0;if(r<=0&&l>=0)return 0}c=d,a=g,r=l}}return s%2!=0}function Ov(e,t,i={}){const n={type:"Feature"};return(0===i.id||i.id)&&(n.id=i.id),i.bbox&&(n.bbox=i.bbox),n.properties=t||{},n.geometry=e,n}function Uv(e,t,i={}){if(!e)throw new Error("coordinates is required");if(!Array.isArray(e))throw new Error("coordinates must be an Array");if(e.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!rm(e[0])||!rm(e[1]))throw new Error("coordinates must contain numbers");return Ov({type:"Point",coordinates:e},t,i)}function Qv(e){let t=0;if(e&&e.length>0){t+=Math.abs(Jv(e[0]));for(let i=1;i<e.length;i++)t-=Math.abs(Jv(e[i]))}return t}function Jv(e){let t,i,n,s,o,r,a,l=0;const g=e.length;if(g>2){for(a=0;a<g;a++)a===g-2?(s=g-2,o=g-1,r=0):a===g-1?(s=g-1,o=0,r=1):(s=a,o=a+1,r=a+2),t=e[s],i=e[o],n=e[r],l+=(bv.toRadians(n[0])-bv.toRadians(t[0]))*Math.sin(bv.toRadians(i[1]));l=6371008.8*l*6371008.8/2}return l}function jv(e){return e[0]>=-180&&e[0]<=180&&e[1]>=-90&&e[1]<=90}const qv=Object.freeze(Object.defineProperty({__proto__:null,getGeoFeatures:function(e,t){if(!e)return[];let i=null;return t&&Ev(e,t),i=e.features?e.features:Array.isArray(e)?e:[e],i},projectArrayCoordinates:Nv,unprojectArrayCoordinates:Fv,fixFeature:Xv,multiPointToPoints:function(e,t){if(!e.geometry)return[];if("Point"===e.geometry.type)return[e];if("MultiPoint"===e.geometry.type||"LineString"===e.geometry.type){const i=[],{type:n,geometry:s,...o}=e;for(let r=0;r<e.geometry.coordinates.length;r++){const n=e.geometry.coordinates[r];if(t){const s=e.geometry[t][r];i.push({type:"Feature",geometry:{type:"Point",coordinates:n,[t]:s},...o})}else i.push({type:"Feature",geometry:{type:"Point",coordinates:n},...o})}return i}return[]},multiLineStringToLineStrings:function(e,t){if(!e.geometry)return[];if("LineString"===e.geometry.type)return[e];if("MultiLineString"===e.geometry.type||"Polygon"===e.geometry.type){const i=[],{type:n,geometry:s,...o}=e;for(let r=0;r<e.geometry.coordinates.length;r++){const n=e.geometry.coordinates[r];if(t){const s=e.geometry[t][r];i.push({type:"Feature",geometry:{type:"LineString",coordinates:n,[t]:s},...o})}else i.push({type:"Feature",geometry:{type:"LineString",coordinates:n},...o})}return i}return[]},multiPolygonToPolygons:function(e,t){if(!e.geometry)return[];if("Polygon"===e.geometry.type)return[e];if("MultiPolygon"===e.geometry.type){const i=[],{type:n,geometry:s,...o}=e;for(let r=0;r<e.geometry.coordinates.length;r++){const n=e.geometry.coordinates[r];if(t){const s=e.geometry[t][r];i.push({type:"Feature",geometry:{type:"Polygon",coordinates:n,[t]:s},...o})}else i.push({type:"Feature",geometry:{type:"Polygon",coordinates:n},...o})}return i}return[]},convertLineString2Points:function(e){let t=this.getGeoFeatures(e),i=[];for(let n=0;n<t.length;n++){const e=t[n],s=this.multiLineStringToLineStrings(e);for(let t=0;t<s.length;t++){const e=s[t],n=this.multiPointToPoints(e);i.push(...n)}}return i},convertPolygon2LineString:function(e){let t=this.getGeoFeatures(e),i=[];for(let n=0;n<t.length;n++){const e=t[n],s=this.multiPolygonToPolygons(e);for(let t=0;t<s.length;t++){const e=s[t],n=this.multiLineStringToLineStrings(e);i.push(...n)}}return i},coordEach:Hv,geomEach:zv,featureEach:function(e,t){if("Feature"===e.type)t(e,0);else if("FeatureCollection"===e.type)for(let i=0;i<e.features.length&&!1!==t(e.features[i],i);i++);},geomReduce:Lv,getbbox:Dv,getCoord:Kv,getGeom:Yv,inBBox:Pv,booleanPointInPolygon:function(e,t,i={}){if(!e)throw new Error("point is required");if(!t)throw new Error("polygon is required");const n=Kv(e),s=Yv(t),o=s.type,r=t.bbox;let a=s.coordinates;if(r&&!1===Pv(n,r))return!1;"Polygon"===o&&(a=[a]);let l=!1;for(let g=0;g<a.length;++g){const e=kv(n,a[g]);if(0===e)return!i.ignoreBoundary;e&&(l=!0)}return l},feature:Ov,featureCollection:function(e,t={}){const i={type:"FeatureCollection"};return t.id&&(i.id=t.id),t.bbox&&(i.bbox=t.bbox),i.features=e,i},coordToPoint:Uv,coordToLineString:function(e,t,i={}){if(!e)throw new Error("coordinates is required");if(!Array.isArray(e))throw new Error("coordinates must be an Array");return Ov({type:"LineString",coordinates:e},t,i)},coordToPolygon:function(e,t,i={}){for(const n of e){if(n.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(n[n.length-1].length!==n[0].length)throw new Error("First and last Position are not equivalent.");for(let e=0;e<n[n.length-1].length;e++)if(n[n.length-1][e]!==n[0][e])throw new Error("First and last Position are not equivalent.")}return Ov({type:"Polygon",coordinates:e},t,i)},computeGeoJSONArea:function(e){return Lv(e,((e,t)=>e+function(e){let t,i=0;switch(e.type){case"Polygon":return Qv(e.coordinates);case"MultiPolygon":for(t=0;t<e.coordinates.length;t++)i+=Qv(e.coordinates[t]);return i;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0}return 0}(t)),0)},getcenter:function(e,t={}){const i=Dv(e);return Uv([(i[0]+i[2])/2,(i[1]+i[3])/2],t.properties,t)},isLngLatArrValid:jv},Symbol.toStringTag,{value:"Module"})),$v=function(e){return"string"==typeof e?e:"object"==typeof e?e.properties.name:null};class ex{constructor(e,t={},i=!1){__publicField(this,"_originalCoordinates"),__publicField(this,"_attributes"),__publicField(this,"_id"),__publicField(this,"_sourceProjectionName"),__publicField(this,"_coordinates"),__publicField(this,"_projectedCoordinates",{}),__publicField(this,"_type"),__publicField(this,"_isMulti",!1),__publicField(this,"_size",1),__publicField(this,"_isValid",!0),e||(console.warn("DataItem: feature is required"),this._isValid=!1);let n=null,s={};if(Array.isArray(e))this._type=1,this._originalCoordinates=e;else if(e.isVector3)this._type=1,this._originalCoordinates=[e.x,e.y,e.z];else if("object"==typeof e){const t=e.geometry;if(t){const e=(t.type||"").toUpperCase();"POINT"===e?this._type=1:"LINESTRING"===e?this._type=2:"POLYGON"===e?this._type=3:"MULTIPOINT"===e?(this._type=1,this._isMulti=!0,this._size=t.coordinates.length):"MULTILINESTRING"===e?(this._type=2,this._isMulti=!0,this._size=t.coordinates.length):"MULTIPOLYGON"===e?(this._type=3,this._isMulti=!0,this._size=t.coordinates.length):(this._isValid=!1,console.warn("DataItem: geometry is invalid")),this._originalCoordinates=t.coordinates}else console.warn("DataItem: geometry is required"),this._isValid=!1;e.crs&&(n=$v(e.crs)),e.properties&&Object.assign(s,e.properties)}else console.warn("DataItem: feature is invalid");Object.assign(s,t),this._attributes=s,void 0!==s.id&&(this._id=s.id),!n&&s.crs&&(n=$v(s.crs)),this._sourceProjectionName=n,!n||n===Rb&&!i?this._coordinates=this._originalCoordinates:this._projectedCoordinates[n]=this._originalCoordinates}getProjectedCoordinates(e,t=0){return this._projectedCoordinates[e.name]||(this._projectedCoordinates[e.name]=Nv(this.coordinates,e)),this._isMulti?this._projectedCoordinates[e.name][t]:this._projectedCoordinates[e.name]}toGeoJSON(){let e="Point";return 2===this._type?e="LineString":3===this._type&&(e="Polygon"),this._isMulti&&(e="Multi"+e),{type:"Feature",geometry:{type:e,coordinates:this.coordinates},properties:this._attributes}}setCoordinates(e,t){this._coordinates=null,this._projectedCoordinates={},this._isMulti&&(this._size=e.length),t?(this._sourceProjectionName=t.name,this._originalCoordinates=e,this._projectedCoordinates[t.name]=e):this._coordinates=e}setAttribute(e,t){this._attributes[e]=t}setAttributes(e){Object.assign(this._attributes,e)}get attributes(){return this._attributes}get id(){return this._id}set id(e){void 0===this._id?this._id=e:console.warn("DataItem: id is already set")}get coordinates(){if(!this._coordinates){const e=Tv(this._sourceProjectionName);this._coordinates=Fv(this._originalCoordinates,e)}return this._coordinates}get sourceProjectionName(){return this._sourceProjectionName}get type(){return this._type}get isMulti(){return this._isMulti}get size(){return this._size}get isValid(){return this._isValid}}function tx(e,t,i,n,s){return function(e,t){const i=1-e;return i*i*i*t}(e,t)+function(e,t){const i=1-e;return 3*i*i*e*t}(e,i)+function(e,t){return 3*(1-e)*e*e*t}(e,n)+function(e,t){return e*e*e*t}(e,s)}const ix=function(e,t){let i=e[0],n=e[1];return[(3*i+t[0])/4,(3*n+t[1])/4]},nx=function(e,t){let i=e[0],n=e[1],s=t[0],o=t[1];return Math.sqrt(Math.pow(i-s,2)+Math.pow(n-o,2))},sx=function(e,t,i=1){return[...ix(e,t),nx(e,t)/i]},ox=function(e,t,i,n,s){let o=[];return o.push(tx(e,t[0],i[0],n[0],s[0]),tx(e,t[1],i[1],n[1],s[1]),tx(e,t[2],i[2],n[2],s[2])),o};function rx(e,t=20){const i=e[0],n=e[e.length-1],s=sx(i,n,2),o=sx(n,i,2);let r=[];for(let a=0;a<=t;a++)r.push(ox(a/t,i,s,o,n));return r}class ax{constructor(e={}){__publicField(this,"_generatedIdIndex",1),__publicField(this,"_objects",[]),__publicField(this,"_data",{}),__publicField(this,"_userData",[]),__publicField(this,"_userDataNeedsUpdate",!1),__publicField(this,"_dataItems",[]),__publicField(this,"_attributeMap",new Map),__publicField(this,"_needsUpdate",!0),__publicField(this,"_idIndexMap",{}),__publicField(this,"_indexIdMap",{}),__publicField(this,"_queuedData",[]),__publicField(this,"_isCurve",!1),this._options=e,this._id=e.id||(new Date).valueOf(),e.attributes&&this.defineAttributes(e.attributes)}async load(e){if(e&&"string"==typeof e){try{const t=await fetch(e),i=await this._convertStreamingDataToObjectData(t);this._queuedData.push({operation:4,data:i}),this.needsUpdate=!0}catch(t){console.error("load data error",t)}return this}console.warn("url is required")}async _convertStreamingDataToObjectData(e){console.error("please implement _convertStreamingDataToObjectData method")}_parseObjectDataToDataItems(e){console.error("please implement _parseObjectDataToDataItems method")}defineAttribute(e,t){return t?this._attributeMap.set(e,t):this._attributeMap.set(e,e),this.needsUpdate=!0,this}setAttribute(e,t){return console.warn("setAttribute is deprecated, please use defineAttribute instead."),this.defineAttribute(e,t)}defineAttributes(e){let t=Object.keys(e);for(let i=0;i<t.length;i++){const n=t[i];this._attributeMap.set(n,e[n])}return this.needsUpdate=!0,this}setAttributes(e){return console.warn("setAttributes is deprecated, please use defineAttributes instead."),this.defineAttributes(e)}undefineAttribute(e){return this._attributeMap.delete(e),this.needsUpdate=!0,this}removeAttribute(e){return console.warn("removeAttribute is deprecated, please use undefineAttribute instead."),this.undefineAttribute(e)}undefineAllAttributes(){return this._attributeMap.clear(),this.needsUpdate=!0,this}removeAttributes(){return console.warn("removeAttributes is deprecated, please use undefineAllAttributes instead."),this.undefineAllAttributes()}add(e){return this._queuedData.push({operation:1,data:Array.isArray(e)?e:[e]}),this.needsUpdate=!0,this}remove(e){return this._queuedData.push({operation:2,data:Array.isArray(e)?e:[e]}),this.needsUpdate=!0,this}setAttributeValue(e,t,i){return this.setAttributeValues(e,{[t]:i})}setAttributeValues(e,t){Array.isArray(e)||(e=[e]);for(let i=0;i<e.length;i++){const n=e[i],s=this._idIndexMap[n];void 0!==s&&this._dataItems[s].setAttributes(t)}return this.needsUpdate=!0,this}setCoordinates(e,t,i){Array.isArray(e)||(e=[e]);for(let n=0;n<e.length;n++){const s=e[n],o=this._idIndexMap[s];void 0!==o&&this._dataItems[o].setCoordinates(t,i)}return this.needsUpdate=!0,this}get(e){let t={};if(this.data.position&&this.data.position.length&&void 0!==e&&!(e>=this.data.position.length)){for(const i in this.data)if(Object.hasOwnProperty.call(this.data,i)){const n=this.data[i];t[i]=n[e]}return t}}getDataItemIndex(e){return this.data.index[e]}getDataItem(e){const t=this.getDataItemIndex(e);if(void 0!==t)return this._dataItems[t]}exportToGeoJSON(){let e=[];for(let t=0;t<this._dataItems.length;t++){const i=this._dataItems[t];e.push(i.toGeoJSON())}return{type:"FeatureCollection",features:e}}_executeAddData(e){for(let t=0;t<e.length;t++){const i=e[t];i.id||(i.id="_gid_"+this._generatedIdIndex++);const n=i.id;if(void 0!==this._idIndexMap[n])continue;const s=this._dataItems.length;this._indexIdMap[s]=n,this._idIndexMap[n]=s,this._dataItems.push(i)}}_executeRemoveData(e){for(let t=0;t<e.length;t++){const i=e[t];let n;if(n=i instanceof ex||"[object Object]"===Array.prototype.toString.call(i)?i.id:i,void 0!==n){const e=this._idIndexMap[n];if(void 0===e)return void console.warn("remove fail1",e,n);const t=this._dataItems.length-1;if(e>t)return void console.warn("remove fail2",e,n);if(e<t){const i=this._indexIdMap[t];this._dataItems[e]=this._dataItems[t],this._indexIdMap[e]=i,this._idIndexMap[i]=e}delete this._idIndexMap[n],delete this._indexIdMap[t],this._dataItems.length=this._dataItems.length-1}}}_processData(e){this._templateDataLength=e.index.length;let t=null,i=0;for(let n=0;n<this._dataItems.length;n++)if(t=this._dataItems[n],t.isValid){i=t.isMulti?t.size:1;for(let s=0;s<i;s++){const i=t.getProjectedCoordinates(this.projection,s);e.position.push(i),e.index.push(n);for(const o of this._attributeMap.keys()){let i;const r=this._attributeMap.get(o);t.attributes&&void 0!==t.attributes[r]&&null!==t.attributes[r]?i=t.attributes[r]:r instanceof Function&&(i=r(t.attributes,t,s,n)),e[o].push(i)}}}}update(){if(this.isDirectBuffer)return void(this.needsUpdate=!1);const e=this._queuedData.length;if(e>0)for(let i=0;i<e;i++){const e=this._queuedData.shift();if(4===e.operation){const t=this._parseObjectDataToDataItems(e.data);this._executeAddData(t)}else 1===e.operation?this._executeAddData(e.data):2===e.operation&&this._executeRemoveData(e.data)}let t={position:[],index:[]};for(const i of this._attributeMap.keys())t[i]=[];if(this._processData(t,[]),this._isCurve&&t.position.length>0&&Array.isArray(t.position[0])&&Array.isArray(t.position[0][0])&&!Array.isArray(t.position[0][0][0]))for(let i=0;i<t.position.length;i++){const e=t.position[i];t.position[i]=rx(e)}this._data=t,this._userDataNeedsUpdate=!0,this.needsUpdate=!1}setData(e){this.clear(),this._queuedData.push({operation:4,data:e}),this.needsUpdate=!0}clear(){this._data={},this._userData=[],this._queuedData=[],this._dataItems=[],this.needsUpdate=!0,this._idIndexMap={},this._indexIdMap={},this.onClear()}onClear(){}_formatGeometry(e){return e?Array.isArray(e)?{type:"Point",coordinates:e}:e.isVector3?{type:"Point",coordinates:[e.x,e.y,e.z]}:e:null}dispose(){this.clear()}get dataItems(){return this._dataItems}get size(){return this.needsUpdate&&this.update(),this.data&&this.data.position&&this.data.position.length||0}get data(){return this._data}get userData(){if(!this._userDataNeedsUpdate)return this._userData;if(!this._data||!this._data.position||!this._data.position.length)return[];const e=[];let t=null;for(let i=0,n=this._data.position.length;i<n;i++){const n={position:this._data.position[i],index:this._data.index[i]};for(const e of this._attributeMap.keys())t=this._data[e]&&this._data[e][i],n[e]=t;e.push(n)}return this._userData=e,this._userDataNeedsUpdate=!1,this._userData}get needsUpdate(){return this._needsUpdate}set needsUpdate(e){this._needsUpdate=e}get objects(){return this._objects}set objects(e){this._objects=e}get isCurve(){return this._isCurve}set isCurve(e){this._isCurve=e,this.needsUpdate=!0}}class lx extends Ji{constructor(e){super(),__publicField(this,"_enableRtc",!0),__publicField(this,"_cachedRtc",[0,0,0]),__publicField(this,"makeMeshPositionOffset",(e=>{this._cachedRtc=[e[0],e[1],e[2]||0],this.updateTransform()})),__publicField(this,"makeGeometryOffsetPosition",((e,t)=>{if(!this._enableRtc)return;const i=e.boundingSphere&&e.boundingSphere.center;if(!i)return this._cachedRtc=[0,0,0],void this.updateTransform();const{x:n,y:s,z:o}=i;e.isCustomInstancedBufferGeometry?this.makePostionArrayOffset(e.attributes.instancedPosition.array,n,s,o,t):(this.makePostionArrayOffset(e.attributes.position.array,n,s,o,t),e.attributes.position.array.length),e.computeBoundingSphere(),this._cachedRtc=[n,s,o],this.updateTransform()})),__publicField(this,"makePostionArrayOffset",((e,t,i,n,s)=>{if(!e||e.length<3)return;let o=s||e;for(let r=0,a=e.length-2;r<a;r+=3)e[r]=o[r]-t,e[r+1]=o[r+1]-i,e[r+2]=o[r+2]-n})),__publicField(this,"updateTransform",(()=>{const[e,t,i]=this._cachedRtc;this.position.set(e,t,i),this.updateMatrixWorld(!0)})),Object.defineProperties(this,{enableRtc:{get:function(){return this._enableRtc},set:function(e){this._enableRtc=e}}})}defineGeometryProxyProperties(e=[]){for(let t=0;t<e.length;t++){const i=e[t];Object.defineProperty(this,i,{get:function(){return this.geometry[i]},set:function(e){this.geometry[i]=e}})}}defineGeometryUpdateProxyProperties(e=[]){for(let t=0;t<e.length;t++){const i=e[t];Object.defineProperty(this,i,{get:function(){return this.geometry[i]},set:function(e){this.geometry[i]=e,this.needsUpdate=!0}})}}defineMaterialProxyProperties(e=[]){for(let t=0;t<e.length;t++){const i=e[t];Object.defineProperty(this,i,{get:function(){return this.material[i]},set:function(e){this.material[i]=e}})}}defineMaterialUpdateProxyProperties(e=[]){for(let t=0;t<e.length;t++){const i=e[t];Object.defineProperty(this,i,{get:function(){return this.material[i]},set:function(e){this.material[i]=e,this.material.needsUpdate=!0}})}}defineMaterialColorProxyProperties(e=[]){for(let t=0;t<e.length;t++){const i=e[t];Object.defineProperty(this,i,{get:function(){return this.material[i]},set:function(e){this.material[i]=hy(e)}})}}raycast(e,t){this.visible&&super.raycast(e,t)}}class gx extends lx{constructor(){super(...arguments),__publicField(this,"isGeoObject",!0),__publicField(this,"dataAutoUpdate",!0),__publicField(this,"_parameters"),__publicField(this,"_dataSource"),__publicField(this,"_dataSourceUpdated"),__publicField(this,"_needsUpdate"),__publicField(this,"_zooms",[0,100]),__publicField(this,"_zoomVisibleCache"),__publicField(this,"engine"),__publicField(this,"travelFeatureLineCoordinate",((e,t,i)=>{const n=e.geometry;if(!n||!n[t]||!n.type)return;const s=n[t];if("LineString"===n.type)i&&i(s);else if("MultiLineString"===n.type||"Polygon"===n.type)for(let o of s)i&&i(o);else if("MultiPolygon"===n.type)for(let o of s)for(let e of o)i&&i(e)})),__publicField(this,"travelLineCoordinates",((e,t="coordinates",i,n=0)=>{if(Array.isArray(e)&&i)for(let s=0,o=e.length;s<o;s++){const o=e[s],r=n+s,a=o.geometry;if(!a||!a[t]||!a.type)continue;const l=a[t];if("LineString"===a.type)i&&i(l,o,r);else if("MultiLineString"===a.type||"Polygon"===a.type)for(let e of l)i&&i(e,o,r);else if("MultiPolygon"===a.type)for(let e of l)for(let t of e)i&&i(t,o,r)}})),__publicField(this,"travelPolygonCoordinates",((e,t="coordinates",i,n=0)=>{if(Array.isArray(e)&&i)for(let s=0,o=e.length;s<o;s++){const o=e[s],r=n+s,a=o.geometry;if(!a||!a[t]||!a.type)continue;const l=a[t];if("Polygon"===a.type)i&&i(l,o,r);else if("MultiPolygon"===a.type)for(let e of l)i&&i(e,o,r);else if("LineString"===a.type)i&&i([l],o,r);else if("MultiLineString"===a.type)for(let e of l)i&&i([e],o,r)}})),__publicField(this,"travelPointCoordinates",((e,t="coordinates",i,n=0)=>{if(Array.isArray(e)&&i)for(let s=0,o=e.length;s<o;s++){const o=e[s],r=n+s,a=o.geometry;if(!a||!a[t]||!a.type)continue;const l=a[t];"Point"===a.type&&i&&i(l,o,r)}})),__publicField(this,"getPointsBounding",((e,t="coordinates")=>{let i=1/0,n=1/0,s=1/0,o=-1/0,r=-1/0,a=-1/0;return this.travelPointCoordinates(e,t,(e=>{const[t,l,g=0]=e;t<i&&(i=t),t>o&&(o=t),l<n&&(n=l),l>r&&(r=l),g<s&&(s=g),g>a&&(a=g)})),isFinite(i)||(i=0),isFinite(o)||(o=0),isFinite(n)||(n=0),isFinite(r)||(r=0),isFinite(s)||(s=0),isFinite(a)||(a=0),[i,n,s,o,r,a]}))}get parameters(){return this._parameters}set parameters(e){this._parameters?this._parameters={...this._parameters,...e}:this._parameters={...this.getDefaultParams(),...e}}get dataSource(){return this._dataSource}set dataSource(e){this.setDataSource(e)}get needsUpdate(){return this._needsUpdate}set needsUpdate(e){this._needsUpdate=e}get zooms(){return this._zooms}set zooms(e){this._zooms=e}get inZoomsRange(){const e=this.engine;return!!e&&(e.map.getZoom()>=this.zooms[0]&&e.map.getZoom()<=this.zooms[1])}afterAddToEngine(e){this.engine=e,this.initObject(),this.isInstancedMesh&&this.material&&(this.material.defines?this.material.defines.IS_INSTANCE=!0:this.material.defines={IS_INSTANCE:!0})}beforeRemoveFromEngine(e){this.dispose()}initObject(){}getDefaultParams(){return{}}getEntityByIndex(e){const t=this.dataSource;if(!t)return;const i={index:e,value:t.getDataItem(e),itemIndex:t.getDataItemIndex(e),pairs:{}},n=t.data;for(const s of Object.keys(n))i.pairs[s]=n[s][e];return i}setDataSource(e){if(e)e.objects.indexOf(this)>-1||(this._dataSource=e,e.projection=this.engine.map.projection,e.objects.push(this),this.needsUpdate=!0,this.engine.requestRender());else if(this._dataSource){const e=this._dataSource.objects.indexOf(this);e>-1&&this._dataSource.objects.splice(e,1),this._dataSource=null,this.needsUpdate=!0,this.engine.requestRender()}}onBeforeScenePrepareRender(e,t,i,n){this.dataSource&&(this.dataSource.needsUpdate&&(this.dataSource.update(),this.needsUpdate=!0),this.dataAutoUpdate&&this.needsUpdate&&this._enableCollision&&(e.rendering.collision.needsUpdate=!0),this.onBeforeScenePrepareRenderHook&&this.onBeforeScenePrepareRenderHook(e,t,i,n),this.visible&&!this.inZoomsRange?(this._zoomVisibleCache=this.visible,this.visible=!1):!this.visible&&this._zoomVisibleCache&&this.inZoomsRange&&(this.visible=this._zoomVisibleCache,this._zoomVisibleCache=void 0))}onBeforeSceneRender(e,t,i,n){this.dataSource&&(this.dataAutoUpdate&&this.needsUpdate&&!this._enableCollision||this.dataAutoUpdate&&this.isGroundPrimitive&&this.isDynamic?this._updateData():this.dataAutoUpdate&&this._collisionUpdated?(this._updateData(),this._collisionUpdated=!1):this.geometry&&this.geometry.needsUpdate&&this.geometry.updateGeometry&&(this.geometry.updateGeometry(),this.afterGeometryUpdate&&this.afterGeometryUpdate()),this.onBeforeSceneRenderHook&&this.onBeforeSceneRenderHook(e,t,i,n))}_updateData(){}collisionTest(e){return{}}onDispose(){}dispose(){if(this.geometry&&this.geometry.dispose(),this.material)if(Array.isArray(this.material))for(let e=0;e<this.material.length;e++){this.material[e].dispose()}else this.material.dispose();this.onDispose()}bindTerrain(e){this._terrain=e}}class cx extends gx{constructor(){super(...arguments),__publicField(this,"isMesh",!0)}}const dx=new Qt,hx=new qt,ux=new qt,Ix=new Qt;class px extends Fn{constructor(e){super(e),this.parameters=e,this._drawRange=0,this._init=!1}setData(e){if(this._init)return void this.updateData(e);const{positions:t,indices:i,typesAndPIndices:n,uvs:s,whs:o,rotateZs:r,offsets:a,instanceRotationMatrices:l,styles:g,drawRange:c,fadeOpacityAndSince:d}=e;if(s.length>0&&this.setAttribute("uv",new Mn(s,2)),r.length>0&&this.setAttribute("rotateZ",new Mn(r,1)),a.length>0&&this.setAttribute("offset",new Mn(a,2)),l.length>0&&this.setAttribute("instanceRotationMatrix",new Mn(l,9)),d.length>0){const e=new aa(d,2);this.setAttribute("fadeOpacity",new ga(e,1,0)),this.setAttribute("fadeSince",new ga(e,1,1))}const h=new aa(o,4);this.setAttribute("wh",new ga(h,2,0)),this.setAttribute("size",new ga(h,2,2));const u=new aa(g,8);this.setAttribute("fillStyles",new ga(u,4,0)),this.setAttribute("strokeStyles",new ga(u,4,4)),this.setAttribute("position",new Mn(t,3));const I=new aa(n,2);this.setAttribute("pIndex",new ga(I,1,1)),this.setAttribute("type",new ga(I,1,0)),this.setIndex(i),this._drawRange=c,this._init=!0}updateData(e){const{positions:t,uvs:i,whs:n,rotateZs:s,offsets:o,instanceRotationMatrices:r,styles:a,typesAndPIndices:l,indices:g,drawRange:c,fadeOpacityAndSince:d}=e,h=c/3,u=this.getAttribute("position");for(let w=0;w<h;w++)u.setXYZ(w,t[3*w],t[3*w+1],t[3*w+2]);u.needsUpdate=!0;const I=this.getAttribute("uv");if(I)for(let w=0;w<h;w++)I.setXY(w,i[2*w],i[2*w+1]);I.needsUpdate=!0;const p=this.getAttribute("rotateZ");if(p)for(let w=0;w<h;w++)p.setX(w,s[w]);p.needsUpdate=!0;const m=this.getAttribute("offset");if(m)for(let w=0;w<h;w++)m.setXYZW(w,o[2*w],o[2*w+1]);m.needsUpdate=!0;const A=this.getAttribute("fadeOpacity"),C=this.getAttribute("fadeSince");if(A&&C)for(let w=0;w<h;w++)A.setX(w,d[2*w]),C.setX(w,d[2*w+1]);A.needsUpdate=!0,C.needsUpdate=!0;const f=this.getAttribute("instanceRotationMatrix");if(f)for(let w=0;w<h;w++){const e=9*w;f.set([r[e],r[e+1],r[e+2],r[e+3],r[e+4],r[e+5],r[e+6],r[e+7],r[e+8]],e)}f.needsUpdate=!0;const b=this.getAttribute("wh"),y=this.getAttribute("size");if(b&&y)for(let w=0;w<h;w++)b.setXY(w,n[4*w],n[4*w+1]),y.setXY(w,n[4*w+2],n[4*w+3]);b.needsUpdate=!0,y.needsUpdate=!0;const _=this.getAttribute("fillStyles"),v=this.getAttribute("strokeStyles");if(_&&v)for(let w=0;w<h;w++)_.setXYZW(w,a[8*w],a[8*w+1],a[8*w+2],a[8*w+3]),v.setXYZW(w,a[8*w+4],a[8*w+5],a[8*w+6],a[8*w+7]);_.needsUpdate=!0,v.needsUpdate=!0;const x=this.getAttribute("type"),B=this.getAttribute("pIndex");if(x&&B)for(let w=0;w<h;w++)x.setX(w,l[2*w]),B.setX(w,l[2*w+1]);x.needsUpdate=!0,B.needsUpdate=!0,this._drawRange=c,this.setIndex(g)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new mi);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),void this.boundingSphere.set(new Qt,1/0);if(e){const i=this.boundingSphere.center,n=e.array.slice(0,this._drawRange);if(hx.setFromArray(n),t)for(let e=0,o=t.length;e<o;e++){const i=t[e];ux.setFromBufferAttribute(i),this.morphTargetsRelative?(Ix.addVectors(hx.min,ux.min),hx.expandByPoint(Ix),Ix.addVectors(hx.max,ux.max),hx.expandByPoint(Ix)):(hx.expandByPoint(ux.min),hx.expandByPoint(ux.max))}hx.getCenter(i);let s=0;for(let e=0,t=n.length;e<t;e+=3)Ix.fromArray(n,e),s=Math.max(s,i.distanceToSquared(Ix));if(t)for(let o=0,r=t.length;o<r;o++){const n=t[o],r=this.morphTargetsRelative;for(let t=0,o=n.count;t<o;t++)Ix.fromBufferAttribute(n,t),r&&(dx.fromBufferAttribute(e,t),Ix.add(dx)),s=Math.max(s,i.distanceToSquared(Ix))}this.boundingSphere.radius=Math.sqrt(s),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}}class mx extends ls{constructor(e){super(),__publicField(this,"isCommonShaderMaterial",!0),__publicField(this,"setCommonUniforms",(e=>{for(const t of Object.keys(e))this.uniforms[t]=e[t]})),this.setValues(e)}}const Ax=as.merge([ws.fog,Ay,{spriteMap:{value:null},textMap:{value:null},map:{value:null},useMap:{value:!1},pixelOffset:{value:[0,0]},positionOffset:{value:[0,0,0]},opacity:{value:1},keepSize:{value:!0},depthTexture:{value:null},u_flat:{value:!1},cameraFar:{value:0},srgbTransformer:{value:!1},fadeDuration:{value:300}}]),Cx=new Dl;class fx extends mx{constructor(e){super(),this.name="SymbolMaterial",this.vertexShader="#define GLSLIFY 1\n#include <common>\nuniform vec2 pixelOffset;\nuniform vec3 positionOffset;\nuniform bool u_flat;\n\n#ifdef RENDER_IN_POSTPROCESS\n    uniform float cameraFar;\n#endif\n\n#ifdef IS_GLOBE\n    attribute mat3 instanceRotationMatrix;\n#endif\n\nattribute float pIndex;\nattribute vec2 wh;\nattribute vec2 size;\nattribute float rotateZ;\nattribute float type;\nattribute vec4 strokeStyles;\nattribute vec4 fillStyles;\nattribute vec2 offset;\n\nvarying vec2 v_uv;\nvarying float v_type;\nvarying float v_iconOpacity;\n\nvarying vec4 vStrokeStyles;\nvarying vec3 vFillStyles;\nvarying vec2 vSize;\n\n#ifdef RENDER_IN_POSTPROCESS\n    varying vec2 vClipSpacePosition;\n    varying float vLogDepth;\n#endif\n\nuniform float elapsedTime;\n#ifdef MVT_ENABLE_FADE\n    attribute float fadeOpacity;\n    attribute float fadeSince;\n    uniform float fadeDuration;\n    varying float vFadeOpacity;\n#endif\n\n// 仅仅text有的\n// offset, anchor, strokeStyles\n\nvec3 transformCoord(vec3 coord, vec2 size, float corner, float rotateZ) {\n    float x = coord.x;\n    float y = coord.y;\n    if (corner == 1.0) {\n        x += -size.x * cos(rotateZ) + size.y * sin(rotateZ);\n        y += size.y * cos(rotateZ) + size.x * sin(rotateZ);\n    } else if (corner == 2.0) {\n        x += size.x * cos(rotateZ) + size.y * sin(rotateZ);\n        y += size.y * cos(rotateZ) - size.x * sin(rotateZ);\n    } else if (corner == 3.0) {\n        x += size.x * cos(rotateZ) - size.y * sin(rotateZ);\n        y += -size.y * cos(rotateZ) - size.x * sin(rotateZ);\n    } else {\n        x += -size.x * cos(rotateZ) - size.y * sin(rotateZ);\n        y += -size.y * cos(rotateZ) + size.x * sin(rotateZ);\n    }\n    return vec3(x, y, coord.z);\n}\n\n#include <logdepthbuf_pars_vertex>\n#include <mvt_keepsize_pars_vertex>\n#include <mvt_extra_vertex_utils>\nvoid main() {\n    v_uv = uv;\n    v_type = type;\n\n    mat4 currentInstanceMatrix = mat4(1.0);\n    vec3 currentPosition = position;\n    #ifdef IS_GLOBE\n        currentInstanceMatrix = mat4(\n            vec4(instanceRotationMatrix[0], 0.0),\n            vec4(instanceRotationMatrix[1], 0.0),\n            vec4(instanceRotationMatrix[2], 0.0),\n            vec4(position, 1.0)\n        );\n\n        currentPosition = vec3(0.0, 0.0, 0.0);\n    #endif\n\n    vec4 worldPosition = (modelMatrix * currentInstanceMatrix * vec4(currentPosition, 1.0));\n\n    #ifdef RENDER_IN_POSTPROCESS\n        vec4 clipSpacePosition = projectionMatrix * viewMatrix * worldPosition;\n        vClipSpacePosition.xy = ((clipSpacePosition.xy / clipSpacePosition.w) + 1.0) / 2.0;\n\n        float fcoef = 1.0 / log2(cameraFar + 1.0);\n        float logDepth = log2(max(1e-6, 1.0 + clipSpacePosition.w)) * fcoef;\n        vLogDepth = logDepth;\n    #endif\n\n    if (type == 0.0) {\n        float iconRotateZ = rotateZ;\n        v_iconOpacity = fillStyles.w;\n        // vec4 worldPosition = modelMatrix * vec4(position, 1.0);\n        if (u_flat) {\n            float hw = wh.x * 0.5;\n            float hh = wh.y * 0.5;\n\n            if (keepSize) {\n                float pixelSize = getPixelSize(worldPosition.xyz);\n                hw *= pixelSize;\n                hh *= pixelSize;\n            }\n\n            vec3 current = transformCoord(currentPosition, vec2(hw, hh), pIndex, -iconRotateZ);\n\n            gl_Position = projectionMatrix * modelViewMatrix * currentInstanceMatrix * vec4(current, 1.0);\n        }\n        else {\n            worldPosition.x += positionOffset.x;\n            worldPosition.y += positionOffset.y;\n            worldPosition.z += positionOffset.z;\n            gl_Position = projectionMatrix * viewMatrix * worldPosition;\n            float w = gl_Position.w;\n            gl_Position /= w;\n\n            float hw = wh.x / resolution.x;\n            float hh = wh.y / resolution.y;\n\n            float pixelSize = getPixelSize(worldPosition.xyz);\n            float iconOffsetX = offset.x * 2.0 / resolution.x;\n            float iconOffsetY = offset.y * 2.0 / resolution.y;\n            if (!keepSize) {\n                hw = hw / pixelSize;\n                hh = hh / pixelSize;\n\n                iconOffsetX /= pixelSize;\n                iconOffsetY /= pixelSize;\n            }\n            gl_Position.x += pixelOffset.x / resolution.x;\n            gl_Position.y += pixelOffset.y / resolution.y;\n\n            if (pIndex == 1.0) {\n                gl_Position.x -= hw;\n                gl_Position.y += hh;\n            } else if (pIndex == 2.0) {\n                gl_Position.x += hw;\n                gl_Position.y += hh;\n            } else if (pIndex == 3.0) {\n                gl_Position.x += hw;\n                gl_Position.y -= hh;\n            } else {\n                gl_Position.x -= hw;\n                gl_Position.y -= hh;\n            }\n\n            gl_Position.x += iconOffsetX;\n            gl_Position.y += iconOffsetY;\n\n            gl_Position *= w;\n        }\n    }\n    else {\n        float textRotateZ = rotateZ;\n\n        // vec4 worldPosition = (modelMatrix * vec4(position, 1.0));\n        float scale = size.x / wh.y;\n\n        if (u_flat) {\n            // viewMatrix[0]表示相机的右方向，不管相机如何倾斜tilt，法向量都指向正北方向，正好可以用来计算和文字的夹角\n            mat4 localViewMatrix = viewMatrix * currentInstanceMatrix;\n            vec4 right = localViewMatrix[0];\n            float theta = dot(vec2(sin(textRotateZ), cos(textRotateZ)), vec2(-right.y, right.x));\n            if (theta < 0.0) {\n                textRotateZ += PI;\n            }\n            // TODO 支持offset\n            float hw = wh.x * 0.5 * scale;\n            float hh = wh.y * 0.5 * scale;\n\n            float pixelSize = getPixelSize(worldPosition.xyz);\n            float xOffset = offset.x;\n            float yOffset = offset.y;\n            if (keepSize) {\n                hw = hw * pixelSize;\n                hh = hh * pixelSize;\n\n                xOffset *= pixelSize;\n                yOffset *= pixelSize;\n            }\n\n            vec3 transformedPoint =  transformCoord(currentPosition, vec2(xOffset, yOffset), 2.0, -textRotateZ);\n\n            vec3 current = transformCoord(transformedPoint, vec2(hw, hh), pIndex, -textRotateZ);\n\n            gl_Position = projectionMatrix * modelViewMatrix * currentInstanceMatrix * vec4(current, 1.0);\n\n            // vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n        }\n        else {\n            // gl_Position = projectionMatrix * modelViewMatrix * vec4(position.x + positionOffsetX * pixelSize, position.y + positionOffsetY * pixelSize, position.z + positionOffsetZ * pixelSize, 1.0);\n            worldPosition.x += positionOffset.x;\n            worldPosition.y += positionOffset.y;\n            worldPosition.z += positionOffset.z;\n            vec4 pos = projectionMatrix * viewMatrix * worldPosition;\n            float w = pos.w;\n            vec3 screen = pos.xyz / w;\n\n            float hw = wh.x / resolution.x * scale;\n            float hh = wh.y / resolution.y * scale;\n\n            float textOffsetX = offset.x * 2.0 / resolution.x;\n            float textOffsetY = offset.y * 2.0 / resolution.y;\n            if (!keepSize) {\n                float pixelSize = getPixelSize(worldPosition.xyz);\n                hw = hw / pixelSize;\n                hh = hh / pixelSize;\n\n                textOffsetX /= pixelSize;\n                textOffsetY /= pixelSize;\n            }\n\n            screen.x += pixelOffset.x / resolution.x;\n            screen.y += pixelOffset.y / resolution.y;\n\n            vec3 current = transformCoord(screen.xyz, vec2(hw, hh), pIndex, -textRotateZ);\n\n            current = vec3(current.x + textOffsetX, current.y + textOffsetY, current.z);\n\n            gl_Position = vec4(current, 1.0);\n\n            gl_Position *= w;\n\n        }\n\n        vStrokeStyles = strokeStyles;\n        vFillStyles = fillStyles.xyz;\n        vSize = size;\n    }\n\n    #ifdef MVT_ENABLE_FADE\n        float fadeDiff = (elapsedTime - fadeSince) / fadeDuration;\n        if (fadeOpacity > 2.0) {\n            fadeDiff = clamp(fadeDiff, 0.0, 1.0);\n            vFadeOpacity = fadeOpacity - fadeDiff - 2.0;\n            // vFadeOpacity = vFadeOpacity * vFadeOpacity;\n        } else {\n            vFadeOpacity = fadeOpacity + fadeDiff;\n            // vFadeOpacity = sqrt(vFadeOpacity);\n        }\n        vFadeOpacity = clamp(vFadeOpacity, 0.0, 1.0);\n    #endif\n\n    #include <logdepthbuf_vertex>\n}",this.fragmentShader="#define GLSLIFY 1\n#ifdef USE_ICON\nuniform sampler2D spriteMap;\nuniform sampler2D map;\n#endif\n\n#ifdef USE_TEXT\nuniform sampler2D textMap;\n#endif\nuniform sampler2D depthTexture;\nuniform float pixelRatio;\nuniform bool useMap;\n\nvarying vec2 v_uv;\nvarying float v_type;\nvarying float v_iconOpacity;\nvarying vec3 vFillStyles;\nvarying vec4 vStrokeStyles;\nvarying vec2 vSize;\n\n#ifdef RENDER_IN_POSTPROCESS\n    varying vec2 vClipSpacePosition;\n    varying float vLogDepth;\n#endif\n\n#ifdef MVT_ENABLE_FADE\n    varying float vFadeOpacity;\n#endif\n\n#include <logdepthbuf_pars_fragment>\n#include <tonemapping_pars_fragment>\n#include <output_pars_fragment>\nvoid main() {\n    // #ifdef RENDER_IN_POSTPROCESS\n    //     float depthValue = texture2D(depthTexture, vClipSpacePosition).r;\n    //     float bias = 0.002; // 避免设置一个阈值，精度误差造成文字绘制不稳定\n    //     if (vLogDepth > depthValue + bias) {\n    //         discard;\n    //     }\n    // #endif\n    if (v_type == 0.0) {\n        #ifdef USE_ICON\n            if (useMap) {\n                gl_FragColor = texture2D(map, vec2(v_uv.x, 1.0 - v_uv.y));\n            }\n            else {\n                gl_FragColor = texture2D(spriteMap, vec2(v_uv.x, 1.0 - v_uv.y));\n            }\n\n            gl_FragColor.a *= v_iconOpacity;\n        #endif\n    }\n    else {\n        #ifdef USE_TEXT\n            float fontScale = vSize.y / 24.0;\n            float gamma = (0.105 / pixelRatio) / fontScale;\n            float buff = (256.0 - 64.0) / 256.0;\n\n            float distance = texture2D(textMap, vec2(v_uv.x, v_uv.y)).r;\n            float alpha = smoothstep(buff - gamma, buff + gamma, distance);\n            vec3 fontColor = vFillStyles;\n\n            if (vStrokeStyles.w > 0.0) {\n                float inFill = alpha;\n                float outlineBuffer = (6.0 - vStrokeStyles.w / fontScale) / 8.0;\n                float inBorder = smoothstep(outlineBuffer - gamma, outlineBuffer + gamma, distance);\n\n                fontColor = mix(vStrokeStyles.xyz, fontColor, smoothstep(0.0, 1.0, inFill * 1.5));\n                alpha = inBorder;\n            }\n\n            gl_FragColor = vec4(fontColor, alpha);\n        #endif\n\n    }\n\n    #ifdef MVT_ENABLE_FADE\n        gl_FragColor.a *= vFadeOpacity;\n    #endif\n\n    if (gl_FragColor.a <= 0.) {\n        discard;\n    }\n\n    #include <logdepthbuf_fragment>\n    #include <tonemapping_fragment>\n    #include <colorspace_fragment>\n\n    #include <output_fragment>\n}",this.transparent=!0,this.depthTest=!1,this._mapSrc="",Object.assign(this.uniforms,as.clone(Ax)),xy(this),yy(this,[["flat","u_flat"]]),_y(this,[["isRenderInPostprocess","RENDER_IN_POSTPROCESS"],["isGlobe","IS_GLOBE"],["useText","USE_TEXT"],["useIcon","USE_ICON"],["enableFade","MVT_ENABLE_FADE"]]),fy(this,["depthTexture","cameraFar","resolution","pixelOffset","positionOffset","opacity","fadeDuration"]),Object.defineProperties(this,{spriteTexture:{get:function(){return this.uniforms.spriteMap.value},set:function(e){this.uniforms.spriteMap.value=e||null}},textTexture:{get:function(){return this.uniforms.textMap.value},set:function(e){this.uniforms.textMap.value=e||null}},mapSrc:{get:function(){return this._mapSrc},set:function(e){if(this.mapSrc!==e){if(this.uniforms.map.value&&this.uniforms.map.value.dispose(),!e)return this.uniforms.map.value=null,void(this.uniforms.useMap.value=!1);Cx.load(e,(t=>{t.wrapS=t.wrapT=M,t.colorSpace=Ye,this.uniforms.map.value=t,this.uniforms.useMap.value=!0,this._mapSrc=e}))}}}}),this.setValues(e)}dispose(){this.uniforms.spriteMap.value&&this.uniforms.spriteMap.value.dispose(),this.uniforms.textMap.value&&this.uniforms.textMap.value.dispose(),super.dispose()}}const bx=1e20;class yx{constructor({fontSize:e=24,buffer:t=3,radius:i=8,cutoff:n=.25,fontFamily:s="sans-serif",fontWeight:o="normal",fontStyle:r="normal"}={}){this.buffer=t,this.cutoff=n,this.radius=i;const a=this.size=e+4*t,l=this._createCanvas(a),g=this.ctx=l.getContext("2d",{willReadFrequently:!0});g.font=`${r} ${o} ${e}px ${s}`,g.textBaseline="alphabetic",g.textAlign="left",g.fillStyle="black",this.gridOuter=new Float64Array(a*a),this.gridInner=new Float64Array(a*a),this.f=new Float64Array(a),this.z=new Float64Array(a+1),this.v=new Uint16Array(a)}_createCanvas(e){const t=document.createElement("canvas");return t.width=t.height=e,t}draw(e){const{width:t,actualBoundingBoxAscent:i,actualBoundingBoxDescent:n,actualBoundingBoxLeft:s,actualBoundingBoxRight:o}=this.ctx.measureText(e),r=Math.ceil(i),a=Math.min(this.size-this.buffer,Math.ceil(o-s)),l=Math.min(this.size-this.buffer,r+Math.ceil(n)),g=a+2*this.buffer,c=l+2*this.buffer,d=Math.max(g*c,0),h=new Uint8ClampedArray(d),u={data:h,width:g,height:c,glyphWidth:a,glyphHeight:l,glyphTop:r,glyphLeft:0,glyphAdvance:t};if(0===a||0===l)return u;const{ctx:I,buffer:p,gridInner:m,gridOuter:A}=this;I.clearRect(p,p,a,l),I.fillText(e,p,p+r);const C=I.getImageData(p,p,a,l);A.fill(bx,0,d),m.fill(0,0,d);for(let f=0;f<l;f++)for(let e=0;e<a;e++){const t=C.data[4*(f*a+e)+3]/255;if(0===t)continue;const i=(f+p)*g+e+p;if(1===t)A[i]=0,m[i]=bx;else{const e=.5-t;A[i]=e>0?e*e:0,m[i]=e<0?e*e:0}}_x(A,0,0,g,c,g,this.f,this.v,this.z),_x(m,p,p,a,l,g,this.f,this.v,this.z);for(let f=0;f<d;f++){const e=Math.sqrt(A[f])-Math.sqrt(m[f]);h[f]=Math.round(255-255*(e/this.radius+this.cutoff))}return u}}function _x(e,t,i,n,s,o,r,a,l){for(let g=t;g<t+n;g++)vx(e,i*o+g,o,s,r,a,l);for(let g=i;g<i+s;g++)vx(e,g*o+t,1,n,r,a,l)}function vx(e,t,i,n,s,o,r){o[0]=0,r[0]=-bx,r[1]=bx,s[0]=e[t];for(let a=1,l=0,g=0;a<n;a++){s[a]=e[t+a*i];const n=a*a;do{const e=o[l];g=(s[a]-s[e]+n-e*e)/(a-e)/2}while(g<=r[l]&&--l>-1);l++,o[l]=a,r[l]=g,r[l+1]=bx}for(let a=0,l=0;a<n;a++){for(;r[l+1]<a;)l++;const n=o[l],g=a-n;e[t+a*i]=s[n]+g*g}}const xx=32,Bx=[];function wx(e,t,i,n){var s;let o=0;for(let r=t;r<i;r++){o+=(null==(s=n[e[r]])?void 0:s.layoutWidth)||0}return o}function Sx(e,t,i,n,s,o){let r=t,a=0;for(let l=t;l<i;l++){const t=wx(e,l,l+1,s);a+t>n&&(r<l&&o.push(l),r=l,a=0),a+=t}return a}function Gx(e,t,i,n,s=0,o){void 0===o&&(o=e.length);const r=[];return"break-all"===t?Sx(e,s,o,i,n,r):function(e,t,i,n,s,o){let r=t,a=t,l=t,g=0;for(let c=t;c<i;c++)if(" "===e[c]?l=c+1:" "!==e[c+1]&&c+1!==i||(l=c+1),l>a){let t=wx(e,a,l,s);g+t>n&&(r<a&&(o.push(a),r=a,g=0),t>n&&(t=Sx(e,a,l,n,s,o),r=o[o.length-1])),a=l,g+=t}}(e,s,o,i,n,r),r}function Mx(e,t,i,n,s,o,r){let a=0,l=0;for(let g=t;g<i;g++){const t=n[e[g]];t?(l||(l=t.layoutHeight),s[g]=a+t.layoutWidth/2,a+=t.layoutWidth+r):(s[g]=a,a+=xx)}o[0]=a-r,o[1]=l}function Rx(e,t,i,n,s,o,r=0){var a,l;let g;g=Array.isArray(t)?t:Array.from(t);const c=g.length,d=new Array(c),h=new Array(c),u=new Array(c),I=("break-word"===n||"break-all"===n)&&isFinite(s)&&s>0,p=[0,0],m=[0,0],A=[];let C=0,f=0,b=0,y=0,_=1;for(let v=0;v<=c;v++){const t=e[v];if("\\"!==t&&v!==c||(y=v),y>b){const e=I?Gx(g,n,s,o,b,y):Bx;for(let t=0;t<=e.length;t++){const n=0===t?b:e[t-1],s=t<e.length?e[t]:y;Mx(g,n,s,o,d,m,r);for(let e=n;e<s;e++){const t=g[e],i=(null==(a=o[t])?void 0:a.layoutOffsetY)||0,n=(null==(l=o[t])?void 0:l.textHeight)||0;h[e]=f-i,u[e]=m[0],A.push(n),C+=n}f+=m[1]*i,p[0]=Math.max(p[0],m[0])}b=y}"\\"===t&&(d[b]=0,h[b]=0,u[b]=0,b++,_++)}return p[1]=f,{x:d,y:h,rowWidth:u,size:p,rowNum:_,heightSize:C,textHeights:A}}const Tx={};class Zx{constructor(e){__publicField(this,"triggerRemoveEvent",((e,t)=>{try{this.onRemove(t,e)}catch(pb){console.warn("error occurs when disposing tile",pb)}})),this.cache={},this.head=this.tail=null,this.length=0,this.max=e.max||1e3,this.maxAge=e.maxAge||0,this.onRemove=e.onRemove||(()=>{})}clear(){for(const e of Object.keys(this.cache)){const t=this.cache[e];this.triggerRemoveEvent(e,t.value)}this.cache={},this.head=this.tail=null,this.length=0}remove(e){if(!this.cache.hasOwnProperty(e))return;const t=this.cache[e];return delete this.cache[e],this._unlink(e,t.prev,t.next),t.value}_unlink(e,t,i){this.length--,0===this.length?this.head=this.tail=null:this.head===e?(this.head=t,this.cache[this.head].next=null):this.tail===e?(this.tail=i,this.cache[this.tail].prev=null):(this.cache[t].next=i,this.cache[i].prev=t)}peek(e){if(!this.cache.hasOwnProperty(e))return;const t=this.cache[e];return this._checkAge(e,t)?t.value:void 0}set(e,t){let i=null;if(this.cache.hasOwnProperty(e)){if(i=this.cache[e],i.value=t,this.maxAge&&(i.modified=Date.now()),e===this.head)return t;this._unlink(e,i.prev,i.next)}else i={value:t,modified:0,next:null,prev:null},this.maxAge&&(i.modified=Date.now()),this.cache[e]=i,this.length===this.max&&this.evict();return this.length++,i.next=null,i.prev=this.head,this.head&&(this.cache[this.head].next=e),this.head=e,this.tail||(this.tail=e),t}_checkAge(e,t){return!(this.maxAge&&Date.now()-t.modified>this.maxAge)||(this.remove(e),this.triggerRemoveEvent(t.value,e),!1)}has(e){return this.cache.hasOwnProperty(e)&&this._checkAge(e,this.cache[e])}get(e){if(!this.cache.hasOwnProperty(e))return;const t=this.cache[e];return this._checkAge(e,t)?(this.head!==e&&(e===this.tail?(this.tail=t.next,this.cache[this.tail].prev=null):this.cache[t.prev].next=t.next,this.cache[t.next].prev=t.prev,this.cache[this.head].next=e,t.prev=this.head,t.next=null,this.head=e),t.value):void 0}evict(){if(!this.tail)return;const e=this.tail,t=this.remove(this.tail);this.triggerRemoveEvent(e,t)}}const Vx=4096,Wx=4096,Ex={fontSize:48,buffer:6,radius:16};function Nx(e){let t;return t="string"==typeof e?new Set(Array.from(e)):new Set(e),t}const Fx=new Zx({max:2e3});class Xx{constructor(){__publicField(this,"props",{}),__publicField(this,"_entry",{}),__publicField(this,"_textureData",new Uint8Array(16777216)),__publicField(this,"_xOffset",0),__publicField(this,"_yOffset",0),__publicField(this,"_mapping",{}),__publicField(this,"_canvasHeight",0),__publicField(this,"_oldMapping",{}),__publicField(this,"_atlas"),__publicField(this,"_ctx")}get atlas(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}setProps(e={}){Object.assign(this.props,e);const t=Nx(this.props.characterSet);this._generateFontAtlas(t);const i=this._createTextureData(t);this._atlas=i}async setPropsAsync(e,t={},i=30){Object.assign(this.props,t);const n=Nx(this.props.characterSet),s=Array.from(n);this._prepareFontAtlas();let o=0;const r=s.length;return new Promise((t=>{const n=()=>{const a=Math.min(o+i,r),l=s.slice(o,a);this._generateFontAtlas(l);const g=this._processCharBatch(l);o=g?0:a,o<r?e.addTask((()=>Promise.resolve(n()))):(this._finalizeTextureData(),t())};e.addTask((()=>Promise.resolve(n())))}))}_prepareFontAtlas(){const e=document.createElement("canvas");var t,i,n;e.width=Vx,this._ctx=e.getContext("2d",{willReadFrequently:!0}),t=this._ctx,i=this.props.fontFamily,n=Ex.fontSize,t.font=`${n}px ${i}`,t.fillStyle="#000",t.textAlign="start",t.textBaseline="top"}_generateFontAtlas(e){var t;const{fontSize:i,buffer:n,radius:s}=Ex,{fontFamily:o,sdf:r}=this.props;if(r)for(const a of e){let e,r;"string"==typeof a?(e=this.props.fontWeight,r=a):(e=lm(a.fontWeight||(null==(t=a.textStyle)?void 0:t.fontWeight),this.props.fontWeight),r=a.char);const l=r+e;if(Fx.get(l))continue;let g=this._entry[e];g||(g=new yx({fontSize:i,buffer:n,radius:s,fontFamily:o,fontWeight:`${e}`}),g.ctx.textBaseline="top",this._entry[e]=g);const c=g.draw(r);Fx.set(l,c)}}_processCharBatch(e){const{fontWeight:t}=this.props,{buffer:i}=Ex,{mapping:n,canvasHeight:s,xOffset:o,yOffset:r}=function({characterSet:e,context:t,fontHeight:i,buffer:n,maxCanvasWidth:s,mapping:o={},xOffset:r=0,yOffset:a=0,defaultFontWeight:l}){let g=0,c=r,d=0;for(const u of e){const{char:e,fontWeight:r}=u,h=e+lm(r,l);if(!o[h]){const r=t.measureText(e),l=r.width;let u=r.actualBoundingBoxAscent+r.actualBoundingBoxDescent;0===u&&(u=l),u+=n,c+l+2*n>s&&(c=0,g++,d=0),d=Math.max(d,i+2*n),o[h]={x:c+n,y:a+g*d+n,width:l,height:d,layoutWidth:l,layoutHeight:i,textHeight:Math.max(u,l)},c+=l+2*n}}return{mapping:o,xOffset:c,yOffset:a+g*d,canvasHeight:(h=a+(g+1)*d,Math.pow(2,Math.ceil(Math.log2(h))))};var h}({characterSet:e,context:this._ctx,fontHeight:Ex.fontSize,buffer:i,maxCanvasWidth:Vx,mapping:this._mapping,xOffset:this._xOffset,yOffset:this._yOffset,defaultFontWeight:t});if(s>Wx)return this._mapping={},this._xOffset=0,this._yOffset=0,this._textureData.fill(0),this._oldMapping={},console.warn("too many characterSet"),!0;const a=this._ctx.canvas.width,l=this._textureData;for(const g of e){const e=("string"==typeof g?g:g.char)+("string"==typeof g?t:lm(g.fontWeight,t));if(this._oldMapping[e])continue;const{data:i,width:s,height:o,glyphTop:r}=Fx.get(e),c=n[e];c.layoutOffsetY=r;const d=Math.floor(c.y*a+c.x);for(let t=0;t<o;t++){const e=d+t*a,n=t*s;for(let t=0;t<s;t++)l[e+t]=i[n+t]}}Object.assign(this._oldMapping,n),this._xOffset=o,this._yOffset=r}_finalizeTextureData(){this._atlas={textureData:this._textureData,xOffset:this._xOffset,yOffset:this._yOffset,mapping:this._oldMapping,width:Vx,height:Wx}}_createTextureData(e){return this._prepareFontAtlas(),this._processCharBatch(Array.from(e)),this._finalizeTextureData(),this._atlas}}class Hx{constructor(){__publicField(this,"_fadeDuration",300),__publicField(this,"_idField","id"),__publicField(this,"_lastData",[]),__publicField(this,"_filterData",[]),__publicField(this,"_lastDataMap",{}),__publicField(this,"_fadeSinceField","fadeSince"),__publicField(this,"_fadeOpacityField","fadeOpacity"),__publicField(this,"_stableTime",0),__publicField(this,"_debugTrackLogId",null)}processId(e){return e}_dataToMap(e){if(!Array.isArray(e))return{};const t={};for(const i of e){const e=this.processId(i[this._idField]);void 0!==e&&(t[e]=i)}return t}isStable(e){return e>=this._stableTime}update(e,t,i=!1){Array.isArray(e)||(console.warn("data should be an array"),e=[]);let n=t;const s=this._dataToMap(e),o=i&&this._dataToMap(this.filterData),r=this._lastDataMap,a=this._lastData,l=this._fadeDuration,g=[];for(const c of e){const e=this.processId(c[this._idField]),i=e&&r[e];if(this._debugTrackLogId,i){const e=i[this._fadeOpacityField]||0,s=i[this._fadeSinceField];if(this._debugTrackLogId,e>2){this._debugTrackLogId;const e=t-s;c[this._fadeOpacityField]=.001,c[this._fadeSinceField]=t-(l-e),g.push(c),n=Math.max(n,t+l)}else this._debugTrackLogId,c[this._fadeOpacityField]=i[this._fadeOpacityField],c[this._fadeSinceField]=i[this._fadeSinceField],g.push(c),n=Math.max(n,s+l)}else this._debugTrackLogId,c[this._fadeSinceField]=t,c[this._fadeOpacityField]=.001,void 0===e&&(c[this._fadeOpacityField]=1),g.push(c),n=Math.max(n,t+l)}for(const c of a){const e=this.processId(c[this._idField]);if(void 0!==e&&(this._debugTrackLogId,(!i||o[e])&&!s[e])){const i=c[this._fadeOpacityField]||0,o=c[this._fadeSinceField],r=t-o;if(i<=1)this._debugTrackLogId,c[this._fadeOpacityField]=3,c[this._fadeSinceField]=r<l?t-(l-r):t,g.push(c),s[e]=c,n=Math.max(n,t+l);else{this._debugTrackLogId;let t=i-r/l-2;t=ft.clamp(t,0,1),t>0&&(g.push(c),s[e]=c,n=Math.max(n,o+l))}}}this._stableTime=n,this._lastData=g,this._lastDataMap=s}get filterData(){return this._filterData}set filterData(e){this._filterData=e}get data(){return this._lastData}get fadeDuration(){return this._fadeDuration}set fadeDuration(e){this._fadeDuration=e}}function zx(e){let t=0,i=0;for(const r of e)t+=r.w*r.h,i=Math.max(i,r.w);e.sort(((e,t)=>t.h-e.h));const n=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(t/.95)),i),h:1/0}];let s=0,o=0;for(const r of e)for(let e=n.length-1;e>=0;e--){const t=n[e];if(!(r.w>t.w||r.h>t.h)){if(r.x=t.x,r.y=t.y,o=Math.max(o,r.y+r.h),s=Math.max(s,r.x+r.w),r.w===t.w&&r.h===t.h){const t=n.pop();e<n.length&&(n[e]=t)}else r.h===t.h?(t.x+=r.w,t.w-=r.w):r.w===t.w?(t.y+=r.h,t.h-=r.h):(n.push({x:t.x+r.w,y:t.y,w:t.w-r.w,h:r.h}),t.y+=r.h,t.h-=r.h);break}}return{w:s,h:o,fill:t/(s*o)||0}}const Lx=(e,t,i,n,s,o=1,r=1)=>(e.font=`${r}px Microsoft Yahei`,e.textBaseline="top",e.measureText(i).width+t[1]+t[3]>=n||r*o+1*(o-1)+t[0]+t[2]>=s?r-1:Lx(e,t,i,n,s,o,r+1)),Dx=(e,t,i,n={})=>{let s=!1;const o=zx(e);let{fillStyle:r,fontSize:a,gap:l,padding:g,dpr:c,drawText:d=!0,textAlign:h}=n;const u=o.w,I=o.h;i.width===u&&i.height===I||(s=!0),i.width=u||1,i.height=I||1,t.save(),h&&(t.textAlign=h);for(let p=0;p<e.length;p++){const i=e[p],n=i.icon,s=i.text;if(t.drawImage(n,i.x+l[0]/2,i.y+l[1]/2,i.width,i.height),am(s)&&d){const e=`${String(s)}`.split("\\");e.forEach(((n,s)=>{"auto"===a&&(a=Lx(t,g,n,i.width,i.height,e.length)),t.font=`${a}px Microsoft Yahei`,t.fillStyle=r,t.textBaseline="top",t.fillText(n,i.x+l[0]/2+("center"===h?i.width/2:g[3]),i.y+l[1]/2+g[0]+(Number(a)+1)*s)}))}}return t.restore(),s},Kx=(e,t)=>{if("object"==typeof e)t(e);else{let i=new Image;i.crossOrigin="anonymous",i.onload=function(){let e=i.width,n=i.height,s=document.createElement("canvas");s.width=e,s.height=n,s.getContext("2d").drawImage(i,0,0,e,n),t(s)},i.onerror=function(){let e=document.createElement("canvas");e.width=20,e.height=40;let i=e.getContext("2d");i.fillStyle="red",i.beginPath(),i.lineTo(0,0),i.lineTo(20,0),i.lineTo(10,40),i.closePath(),i.fill(),t(e)},i.src=e}};let Yx;const Px=["left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"],kx=new Bi,Ox=new Qt,Ux=new yt,Qx={center:0,left:1,right:-1},Jx={fontSize:48,buffer:6,radius:16},jx="icon",qx="text",$x="icontext",eB=[0,1,0,0,1,0,1,1],tB=[0,0],iB=new Bi;class nB extends cx{constructor(e={}){super(e),__publicField(this,"parameters"),__publicField(this,"spriteTexture"),__publicField(this,"textTexture"),__publicField(this,"_maxChar",3e4),__publicField(this,"_version",0),__publicField(this,"oldMapTextureRes",new Map),__publicField(this,"iconUrlHash",new Zx({max:100,onRemove:(e,t)=>{this.boxHash.delete(t)}})),__publicField(this,"boxHash",new Map),__publicField(this,"gap",[4,4]),__publicField(this,"geometry"),__publicField(this,"material"),__publicField(this,"canvas"),__publicField(this,"ctx"),__publicField(this,"cachedTextData",[]),__publicField(this,"_collisionBoxCache",new Zx({max:1e3})),__publicField(this,"isRenderInPostprocess",!1),__publicField(this,"_bufferDataOffset",{positionsOffset:0,typesAndPIndicesOffset:0,rotateZsOffset:0,offsetsOffset:0,stylesOffset:0,uvsOffset:0,whsOffset:0,fadeOpacityAndSinceOffset:0,instanceRotationMatricesOffset:0}),__publicField(this,"_bufferData",{positions:new Float32Array(3*this._maxChar),typesAndPIndices:new Float32Array(2*this._maxChar),rotateZs:new Float32Array(this._maxChar),uvs:new Float32Array(2*this._maxChar),offsets:new Float32Array(2*this._maxChar),instanceRotationMatrices:new Float32Array(9*this._maxChar),whs:new Float32Array(4*this._maxChar),styles:new Float32Array(8*this._maxChar),fadeOpacityAndSince:new Float32Array(2*this._maxChar),indices:[]}),this.parameters=e,this.spriteTexture=e.spriteTexture,this.vertexIcons=e.vertexIcons,this.flat=lm(e.flat,!1),this.symbolType=lm(e.type,jx),this._enableFade=lm(e.enableFade,!1),this._enableFadeFilter=lm(e.enableFadeFilter,!0),this._textSize=lm(e.textSize,16),this._textFamily=lm(e.textFamily,"sans-serif"),e.textFillStyle?this._textFillStyle=Array.isArray(e.textFillStyle)?e.textFillStyle:dy(e.textFillStyle):this._textFillStyle=[255,255,255],e.textStrokeStyle?this._textStrokeStyle=Array.isArray(e.textStrokeStyle)?e.textStrokeStyle:dy(e.textStrokeStyle):this._textStrokeStyle=[0,0,0],this._textStrokeWidth=lm(e.textStrokeWidth,0),this._textAnchor=lm(e.textAnchor,"center"),this._textOffset=lm(e.textOffset,[0,0]),this._textWeight=lm(e.textWeight,"400"),this._rotateZ=lm(e.rotateZ,0),this._textPadding=lm(e.textPadding,[0,0]),this.textAlign=lm(this.parameters.textAlign,"center"),this.isRenderInPostprocess=this.parameters.isRenderInPostprocess||!1,this.symbolType===qx?(this._iconWidth=0,this._iconHeight=0):(this._iconWidth=lm(this.parameters.iconWidth,40),this._iconHeight=lm(this.parameters.iconHeight,40)),this._offset=lm(this.parameters.offset,[0,0]),this._fadeData=new Hx,this._fadeData.processId=e=>e&&e.split("_")[0];const t=new Xx;this.fontAtalasManager=t;const i=this.canvas=document.createElement("canvas");i.width=i.height=1;const n=this.ctx=i.getContext("2d");n.textAlign="start",n.textBaseline="top",this.vertexIcons&&(this.iconCanvas=document.createElement("canvas"),this.iconCanvas.width=this.iconCanvas.height=1,this.iconCtx=this.iconCanvas.getContext("2d"),this.spriteTexture=new il(this.iconCanvas),this.spriteTexture.colorSpace=Ye),this.defineMaterialProxyProperties(["mapSrc","transparent","depthTest","depthWrite","opacity","flat","keepSize","vertexColors","positionOffset","pixelOffset"]),this.boxes=[]}initObject(){const e=this.symbolType===qx||this.symbolType===$x,t=this.symbolType===jx||this.symbolType===$x,{fontFamily:i,fillStyle:n,strokeStyle:s,...o}=this.parameters;this.geometry=new px(this.parameters),this.material=new fx({useText:e,useIcon:t,...o});const r=this.engine.map.isGlobe;this.material.isGlobe=r,this.material.enableFade=this._enableFade,this.material.setCommonUniforms(this.engine.rendering.uniforms),this.material.spriteTexture=this.spriteTexture}collisionTest(e){const t=e.boundingBox,i=this.symbolType===qx&&this.flat;return t&&!i?t:this.computeBoundingBox(e)}computeBoundingBox(e){const t=this.symbolType,i=e.iconSize||[],n=lm(i[0],this._iconWidth),s=lm(i[1],this._iconHeight),o=e.tolerance||0;if(t===jx)return{width:n,height:s,tolerance:o};const r=lm(e.textAnchor,this._textAnchor),a=r?Px.indexOf(r)+1:0;if(t===qx){const t=this._getTextBox(e,this.flat),i=t.width,n=t.height;e.textBox=t;const{offsetX:s,offsetY:r}=this._getTextOrIconOffset(a,i,n);return{...t,width:i,height:n,offsetX:s,offsetY:r,textBox:t,tolerance:o}}if(t===$x){const t=this._getTextBox(e);e.textBox=t;const{offsetX:i,offsetY:r,width:l,height:g}=this._getTextIconOffset(t,a,n,s);return{width:l,height:g,offsetX:i,offsetY:r,textBox:t,tolerance:o}}}_getTextIconOffset(e,t,i,n){const s=this._textPadding,o=e.width,r=e.height;let a=0,l=0,g=0,c=0;switch(t){case 0:a=Math.max(o,i),l=Math.max(r,n);break;case 1:a=o+i+s[0],l=Math.max(r,i),g=(o+s[0])/2;break;case 2:a=o+i+s[0],l=Math.max(r,i),g=-(o+s[0])/2;break;case 3:a=Math.max(o,i),l=r+n+s[1],c=(r+s[1])/2;break;case 4:a=Math.max(o,i),l=r+n+s[1],c=-(r+s[1])/2;break;case 5:a=o+i+s[0],l=r+n+s[1],g=(o+s[0])/2,c=(r+s[1])/2;break;case 6:a=o+i+s[0],l=r+n+s[1],g=-(o+s[0])/2,c=(r+s[1])/2;break;case 7:a=o+i+s[0],l=r+n+s[1],g=(o+s[0])/2,c=-(r+s[1])/2;break;case 8:a=o+i+s[0],l=r+n+s[1],g=-(o+s[0])/2,c=-(r+s[1])/2}return{width:a,height:l,offsetX:g,offsetY:c}}_getTextOrIconOffset(e,t,i){let n=0,s=0;switch(e){case 0:break;case 1:n=t/2;break;case 2:n=-t/2;break;case 3:s=i/2;break;case 4:s=-i/2;break;case 5:n=t/2,s=i/2;break;case 6:n=-t/2,s=i/2;break;case 7:n=t/2,s=-i/2;break;case 8:n=-t/2,s=-i/2}return{offsetX:n,offsetY:s}}_updateData(){this._version++,this._clearBufferDataOffset();let e=this.dataSource.userData;this._enableCollision&&this._collisionData&&(e=this._collisionData),this._enableFade&&(this._fadeData.filterData=this.dataSource.userData,this._fadeData.update(e,this.engine.rendering.uniforms.elapsedTime.value,this._enableFadeFilter),e=this._fadeData.data),Yx=null,this.packBuffer(e),this.needsUpdate=!1}packBuffer(e){if(!e)return;const t=this._version,i=this.symbolType,n=this.engine.map.isGlobe;e=e.filter((e=>{if(e.checkVisible&&n){const t=e.position;Ox.fromArray(t);return this.engine.map.map.occluder.isPointVisible(Ox)}return!0}));let s=0;const o=this.engine.rendering.taskScheduler;i===jx?this.updateIconHash(e).then((()=>{this._version===t&&o.addTask((()=>new Promise((i=>{this._version===t&&(this.updateIconSprite(),s=this.packIconBuffer(e,s),this._commitBuffer(),i())}))))})):i===qx?this.updateTextSprite(e).then((()=>{this._version===t&&o.addTask((()=>new Promise((i=>{this._version===t&&(this.packTextBuffer(e,s),this._commitBuffer(),i())}))))})):i===$x&&this.updateTextSprite(e).then((()=>{this._version===t&&this.updateIconHash(e).then((()=>{this._version===t&&o.addTask((()=>new Promise((i=>{this._version===t&&(this.updateIconSprite(),s=this.packIconAndTextBuffer(e,s),this._commitBuffer(),i())}))))}))}))}_commitBuffer(){this._bufferData.drawRange=this._bufferDataOffset.positionsOffset,this.geometry.setData(this._bufferData),this._enableFade&&(this.material.fadeDuration=this._fadeData.fadeDuration),this.geometry.computeBoundingSphere(),this.makeGeometryOffsetPosition(this.geometry,this._bufferData.positions),this.engine.requestRender()}updateIconDataItem(e,t){const i=this.vertexIcons,n=this.iconCanvas,s=this._textPadding;if(i){const i=e.position,o=e.iconSize,r=e.offset||tB,a=e.textDrawOnIcon,l=e.icon,g=e.rotateZ,c=this.boxHash.get(l);if(!c)return;if(this.packPosition(i),this.packRotationMatrix(i),this.packRotateZ(g),a){let t;t=e.boundingBox&&e.boundingBox.textBox?e.boundingBox.textBox:e.textBox||this._getTextBox(e);const i=Math.ceil(t.width),n=Math.ceil(t.height),r=i+2*(5-s[0]),a=Math.max(n,o[1])+2*s[1];this.packWH(Math.round(r),Math.round(a/2),0,0)}else this.packWH(o[0],o[1],0,0);this.packOffset(r[0],r[1]),this.packTypeAndPIndex(0),this.packIconStyle(),this.packFade(e);const d=c.x/n.width,h=(c.x+c.w)/n.width,u=(c.y+c.h)/n.height,I=c.y/n.height,p=this._bufferDataOffset.uvsOffset;this._bufferData.uvs[p]=d,this._bufferData.uvs[p+1]=u,this._bufferData.uvs[p+2]=d,this._bufferData.uvs[p+3]=I,this._bufferData.uvs[p+4]=h,this._bufferData.uvs[p+5]=I,this._bufferData.uvs[p+6]=h,this._bufferData.uvs[p+7]=u,this._bufferDataOffset.uvsOffset+=8;const m=4*t;this._bufferData.indices.push(m,m+2,m+1,m,m+3,m+2)}else{const i=e.position,n=e.offset||tB;let s=e.iconUvs;const o=e.rotateZ,r=e.iconOpacity,a=e.iconSize||[],l=lm(a[0],this._iconWidth),g=lm(a[1],this._iconHeight);this.packPosition(i),this.packRotationMatrix(i),this.packRotateZ(o),this.packWH(l,g,0,0),this.packOffset(n[0],n[1]),s||(s=eB),this.packIconUV(s),this.packIconStyle(r),this.packTypeAndPIndex(0),this.packFade(e);const c=4*t;this._bufferData.indices.push(c,c+2,c+1,c,c+3,c+2)}return++t}packIconAndTextBuffer(e,t=0){const[i,n]=this.material.resolution||[];if(!(isNaN(i)||i<=0||isNaN(n)||n<=0)){for(let i=0;i<e.length;i++)t=this.updateIconDataItem(e[i],t),t=this.updateTextDataItem(e[i],t);return t}console.warn("resolution is invalid")}packIconBuffer(e,t=0){const[i,n]=this.material.resolution||[];if(!(isNaN(i)||i<=0||isNaN(n)||n<=0)){for(let i=0;i<e.length;i++)t=this.updateIconDataItem(e[i],t);return t}console.warn("resolution is invalid")}async updateIconHash(e){if(this.vertexIcons){const t=this.getTextureAndHash(e,"icon",0,0,!0);Array.isArray(t)&&await Promise.all(t)}}async updateTextSprite(e){const t=e;let i=new Map,n=!1,s={};this.fontAtalasManager&&this.fontAtalasManager.mapping&&(s=this.fontAtalasManager.mapping);for(let o=0;o<t.length;o++){const e=t[o],r=String(e.text),a=lm(e.textWeight,this._textWeight),l=Array.from(r);for(let t=0,o=l.length;t<o;t++){const e=l[t],o=e+a;i.set(o,{char:e,fontWeight:a}),s[o]||(n=!0)}}n&&await this.updateTextTexture(i.values())}getTextureAndHash(e,t,i,n,s){const o=this.iconUrlHash;if(!s&&this.oldMapTextureRes)return this.oldMapTextureRes;const r=e.map((e=>e.icon)).filter((e=>!am(o.get(e))));if(0===r.length)return this.oldMapTextureRes;r.forEach((e=>o.set(e,o.size)));return r.map((e=>new Promise((t=>{Kx(e,(i=>{o.set(e,i),t(e)}))}))))}updateIconSprite(){if(!this.iconCanvas)return this.oldMapTextureRes;const e=this.iconCtx,t=this.iconUrlHash,i=t.cache;for(let s in i)if(i.hasOwnProperty(s)){const e=i[s].value;if(!am(e)||"string"==typeof e||"number"==typeof e)continue;const t=this.boxes.findIndex((e=>e.key===s));if(t>=0){const[e]=this.boxes.splice(t,1);this.boxes.unshift(e);continue}const n=e.width,o=e.height,r=n+this.gap[0],a=o+this.gap[1];this.boxes.unshift({w:r,h:a,width:n,height:o,key:s,icon:e})}let n=!1;if(this.boxes.forEach((e=>{const t=e.key;this.boxHash.has(t)||(n=!0,this.boxHash.set(e.key,e))})),n){Dx(this.boxes,e,this.iconCanvas,{gap:this.gap,padding:[2,2],dpr:this.engine.rendering.pixelRatio})&&this.spriteTexture.dispose(),this.spriteTexture.needsUpdate=!0,this.material.spriteTexture=this.spriteTexture,this.material.isIconMap=!0}return this.oldMapTextureRes={texture:this.spriteTexture,iconUrlHash:t},this.oldMapTextureRes}async updateTextTexture(e){this._fontSettings={fontFamily:this._textFamily,fontWeight:"400",characterSet:e,sdf:!0,...Jx},await this.fontAtalasManager.setPropsAsync(this.engine.rendering.taskScheduler,this._fontSettings);const{textureData:t,width:i,height:n}=this.fontAtalasManager.atlas;if(!this.textTexture){const e=new Uint8Array(i*n);this.textTexture=new ya(e,i,n),this.textTexture.minFilter=this.textTexture.magFilter=W,this.textTexture.format=q,this.material.textTexture=this.textTexture}this.textTexture.image.data.set(t),this.textTexture.needsUpdate=!0}packTextBuffer(e,t=0){const[i,n]=this.material.resolution||[];if(!(isNaN(i)||i<=0||isNaN(n)||n<=0)){for(let i=0;i<e.length;i++)t=this.updateTextDataItem(e[i],t);return t}console.warn("resolution is invalid")}updateTextDataItem(e,t){const{mapping:i}=this.fontAtalasManager.atlas||{},n=e.position;let s;s=e.boundingBox&&e.boundingBox.textBox?e.boundingBox.textBox:e.textBox||this._getTextBox(e);const o=s.wrappedText,r=s.widthList,a=Math.max(...r);e.textSize=lm(e.textSize,this._textSize),e.textWeight=lm(e.textWeight,this._textWeight),e.textFillStyle?e.textFillStyle=Array.isArray(e.textFillStyle)?e.textFillStyle:dy(e.textFillStyle):e.textFillStyle=this._textFillStyle,e.textStrokeStyle?e.textStrokeStyle=Array.isArray(e.textStrokeStyle)?e.textStrokeStyle:dy(e.textStrokeStyle):e.textStrokeStyle=this._textStrokeStyle,e.textStrokeWidth=lm(e.textStrokeWidth,this._textStrokeWidth),e.textOffset=lm(e.textOffset,this._textOffset),e.textDrawOnIcon=lm(e.textDrawOnIcon,!1),e.icon=e.icon,e.iconSize=e.iconSize,e.rotateZ=lm(e.rotateZ,this._rotateZ);const l=e.textWeight,g=e.textSize,c=e.rotateZ,d=Rx(o,Array.from(o).map((e=>e+l)),1,"break-word",a*g,i),h=d.x.length,u=Array.from(o);let I=0;for(let p=0;p<h;p++){const s=u[p];if("\\"===s)continue;const o=i[s+l];if(!o)return;this.packPosition(n),this.packTextOffset(e,d,p),this.packTextUV(o),this.packTextWh(e,o),this.packTextStyle(e),this.packTypeAndPIndex(1),this.packRotateZ(c),this.packRotationMatrix(n),this.packFade(e);const r=4*(t+I);this._bufferData.indices.push(r,r+2,r+1,r,r+3,r+2),I++}return t+=I}packRotateZ(e){e=e||0;const t=this._bufferDataOffset.rotateZsOffset;this._bufferData.rotateZs[t]=e,this._bufferData.rotateZs[t+1]=e,this._bufferData.rotateZs[t+2]=e,this._bufferData.rotateZs[t+3]=e,this._bufferDataOffset.rotateZsOffset+=4}packRotationMatrix(e){if(this.engine.map.isGlobe){this._calculateTransform(e,kx),Ux.setFromMatrix4(kx);const t=Ux.elements;for(let e=0;e<4;e++){const e=this._bufferDataOffset.instanceRotationMatricesOffset;this._bufferData.instanceRotationMatrices[e]=t[0],this._bufferData.instanceRotationMatrices[e+1]=t[1],this._bufferData.instanceRotationMatrices[e+2]=t[2],this._bufferData.instanceRotationMatrices[e+3]=t[3],this._bufferData.instanceRotationMatrices[e+4]=t[4],this._bufferData.instanceRotationMatrices[e+5]=t[5],this._bufferData.instanceRotationMatrices[e+6]=t[6],this._bufferData.instanceRotationMatrices[e+7]=t[7],this._bufferData.instanceRotationMatrices[e+8]=t[8],this._bufferDataOffset.instanceRotationMatricesOffset+=9}}}packPosition(e){for(let t=0;t<4;t++)this._bufferData.positions.set(e,this._bufferDataOffset.positionsOffset),this._bufferDataOffset.positionsOffset+=3}packFade(e){if(this._enableFade){const{fadeOpacity:t,fadeSince:i}=e;for(let e=0;e<4;e++){const e=this._bufferDataOffset.fadeOpacityAndSinceOffset;this._bufferData.fadeOpacityAndSince[e]=t,this._bufferData.fadeOpacityAndSince[e+1]=i,this._bufferDataOffset.fadeOpacityAndSinceOffset+=2}}}packOffset(e,t){for(let i=0;i<4;i++){const i=this._bufferDataOffset.offsetsOffset;this._bufferData.offsets[i]=e,this._bufferData.offsets[i+1]=t,this._bufferDataOffset.offsetsOffset+=2}}packWH(e,t,i,n){for(let s=0;s<4;s++){const s=this._bufferDataOffset.whsOffset;this._bufferData.whs[s]=e,this._bufferData.whs[s+1]=t,this._bufferData.whs[s+2]=i,this._bufferData.whs[s+3]=n,this._bufferDataOffset.whsOffset+=4}}packTypeAndPIndex(e){const t=this._bufferDataOffset.typesAndPIndicesOffset;this._bufferData.typesAndPIndices[t]=e,this._bufferData.typesAndPIndices[t+1]=0,this._bufferData.typesAndPIndices[t+2]=e,this._bufferData.typesAndPIndices[t+3]=1,this._bufferData.typesAndPIndices[t+4]=e,this._bufferData.typesAndPIndices[t+5]=2,this._bufferData.typesAndPIndices[t+6]=e,this._bufferData.typesAndPIndices[t+7]=3,this._bufferDataOffset.typesAndPIndicesOffset+=8}packIconStyle(e=1){const t=this._bufferDataOffset.stylesOffset;this._bufferData.styles[t+3]=e,this._bufferData.styles[t+11]=e,this._bufferData.styles[t+19]=e,this._bufferData.styles[t+27]=e,this._bufferDataOffset.stylesOffset+=32}packIconUV(e){this._bufferData.uvs.set(e,this._bufferDataOffset.uvsOffset),this._bufferDataOffset.uvsOffset+=8}packTextStyle(e){let{textStrokeStyle:t,textStrokeWidth:i,textFillStyle:n}=e;for(let s=0;s<4;s++){const e=this._bufferDataOffset.stylesOffset;this._bufferData.styles[e]=n[0]/255,this._bufferData.styles[e+1]=n[1]/255,this._bufferData.styles[e+2]=n[2]/255,this._bufferData.styles[e+3]=1,this._bufferData.styles[e+4]=t[0]/255,this._bufferData.styles[e+5]=t[1]/255,this._bufferData.styles[e+6]=t[2]/255,this._bufferData.styles[e+7]=i,this._bufferDataOffset.stylesOffset+=8}}packTextWh(e,t){const{textSize:i}=e;let{width:n,height:s}=t;n+=2*this._fontSettings.buffer;const o=i*(s/this._fontSettings.fontSize);this.packWH(n,s,o,i)}packTextUV(e){const{width:t,height:i}=this.fontAtalasManager.atlas||{};let{x:n,y:s,width:o,height:r}=e;o+=2*this._fontSettings.buffer;const a=n/t,l=s/i,g=a+o/t,c=l+r/i,d=this._bufferDataOffset.uvsOffset;this._bufferData.uvs[d]=a,this._bufferData.uvs[d+1]=c,this._bufferData.uvs[d+2]=a,this._bufferData.uvs[d+3]=l,this._bufferData.uvs[d+4]=g,this._bufferData.uvs[d+5]=l,this._bufferData.uvs[d+6]=g,this._bufferData.uvs[d+7]=c,this._bufferDataOffset.uvsOffset+=8}packTextOffset(e,t,i){const{x:n,y:s,rowWidth:o,rowNum:r,size:[a,l]}=t,{textSize:g,textOffset:c,textAnchor:d=this._textAnchor,iconSize:h=[]}=e,u=lm(h[0],this._iconWidth),I=lm(h[1],this._iconHeight),p=this._textPadding;let m=-1*a/2+(1-Qx[this.textAlign])*(a-o[i])/2+n[i]+c[0],A=l/r*(r-1)/2-s[i]+c[1],C=0,f=0;switch(am(d)?Px.indexOf(d)+1:0){case 1:m+=a/2,C+=u/2+p[0];break;case 2:m-=a/2,C-=u/2+p[0];break;case 3:A-=l/2,f-=I/2+p[1];break;case 4:A+=l/2,f+=I/2+p[1];break;case 5:m+=a/2,C+=u/2+p[0],A-=l/2,f-=I/2+p[1];break;case 6:m-=a/2,C-=u/2+p[0],A-=l/2,f-=I/2+p[1];break;case 7:m+=a/2,C+=u/2+p[0],A+=a/2,C+=u/2+p[0];break;case 8:m-=a/2,C-=u/2+p[0],A+=a/2,C+=u/2+p[0]}const b=g/this._fontSettings.fontSize,y=e.offset||tB,_=m*b+C+y[0],v=A*b+f+y[1];this.packOffset(_,v)}_calculateRotation(e,t,i){const n=new Bi;n.multiplyMatrices(e,t);const s=n.elements[0],o=n.elements[1];return Math.sin(i)*-o+Math.cos(i)*s}_calculateTransform(e,t){return this.engine.map.isGlobe?(t||(t=new Bi),bA.eastNorthUpToFixedFrame(Ox.fromArray(e),null,t),t):iB}_getTextBox(e,t){const i=this.ctx,n=this.engine.rendering.pixelRatio,s=this._textSize,o=this._textFamily,r=this._textPadding;e.textSize=lm(e.textSize,this._textSize),e.textWeight=lm(e.textWeight,this._textWeight),e.textFillStyle?e.textFillStyle=Array.isArray(e.textFillStyle)?e.textFillStyle:dy(e.textFillStyle):e.textFillStyle=this._textFillStyle,e.textStrokeStyle?e.textStrokeStyle=Array.isArray(e.textStrokeStyle)?e.textStrokeStyle:dy(e.textStrokeStyle):e.textStrokeStyle=this._textStrokeStyle,e.textStrokeWidth=lm(e.textStrokeWidth,this._textStrokeWidth);let{text:a,textWeight:l,textSize:g,textStrokeWidth:c,maxWidth:d}=e;i.save(),i.scale(n,n),i.textBaseline="top";let h=s;if(this.getStrictStyleId(e)!==Yx?(i.font=l>=10&&l%10==0?l+" "+g+"px "+o:g+"px "+o,h=g,c>0&&(i.lineWidth=c)):i.font=s+"px "+o,am(d)&&a&&(a=function(e,t,i,n){const s=n+","+i+","+t;let o=Tx[s];if(!o){const i=t.split(" ");if(i.length>1){const t=e.measureText("M").width*n;let s="";const r=[];for(let n=0,o=i.length;n<o;++n){const o=i[n],a=s+(s?" ":"")+o;e.measureText(a).width<=t?s=a:(s&&r.push(s),s=o)}s&&r.push(s);for(let i=0,n=r.length;i<n&&n>1;++i){const s=r[i];if(e.measureText(s).width<.35*t){const t=e.measureText(r[i-1]).width,o=e.measureText(r[i+1]).width,a=i>0?t:1/0,l=i<n-1?o:1/0;r.splice(i,1),n-=1,a<l?(r[i-1]+=" "+s,i-=1):r[i]=s+" "+r[i]}}for(let i=0,n=r.length-1;i<n;++i){const s=r[i],o=r[i+1];if(e.measureText(s)>.7*t&&e.measureText(o)<.6*t){const a=s.split(" "),l=a.pop();e.measureText(l)<.2*t&&(r[i]=a.join(" "),r[i+1]=l+" "+o),n-=1}}o=r.join("\\")}else o=t;Tx[s]=o}return o}(i,a,i.font,d)),t){const t=e.rotateZ,i=this._processTextLayout(a,h),n=i.flat();this._calculateTransform(e.position,kx);const s=kx.extractRotation(kx),o=this._applyRotateZ(n,t,s),l=this._calculateWidths(i);return{width:Math.max(...l)+2*r[0],height:h*l.length+2*r[1],wrappedText:a,widthList:l,chars:o,rotationMatrix:s}}a=String(a);let u=a.split("\\");const I=u.map((e=>i.measureText(e).width));let p=Math.max(...I),m=h*u.length;const A=p+2*r[0],C=m+2*r[1];i.restore();return{width:A,height:C,wrappedText:a,widthList:I}}_calculateWidths(e){return e.map((e=>e.reduce(((e,t)=>e+t.width),0)))}_processTextLayout(e,t){const i=this.ctx,n=this._textPadding,s=String(e).split("\\"),o=-(t*s.length)/2;return s.map(((e,s)=>{const r=[];let a=0;for(let n=0;n<e.length;n++){const l=e[n],g=i.measureText(l).width;r.push({char:l,width:g,height:t,offsetX:0,offsetY:-(o+t/2+s*t)}),a+=g}let l=-a/2;for(let t=0;t<r.length;t++){const e=r[t];l+=e.width/2,e.offsetX=l,e.offsetY=e.offsetY,l+=e.width/2,e.width+=2*n[0]}return r}))}_applyRotateZ(e,t,i){const n=this.engine.camera.matrixWorld;return this._calculateRotation(n,i,t)<0&&(t+=Math.PI),e.map((e=>{const i=e.offsetX,n=e.offsetY;return{...e,offsetX:i*Math.cos(t)-n*Math.sin(t),offsetY:i*Math.sin(t)+n*Math.cos(t)}}))}onBeforeScenePrepareRenderHook(e,t,i){const n=e.rendering.main.sceneRendering.depthTexture;this.material.uniforms.depthTexture.value=n,this.material.uniforms.cameraFar.value=e.rendering.camera.far}onBeforeSceneRender(e,t,i,n){super.onBeforeSceneRender(e,t,i,n),this._enableFade&&!this._fadeData.isStable(n.elapsedTime)&&e.requestRender()}_clearBufferDataOffset(){Object.keys(this._bufferDataOffset).forEach((e=>{this._bufferDataOffset[e]=0})),this._bufferData.indices.length=0}getStrictStyleId(e){const{text:t,textSize:i,textWeight:n,textStrokeWidth:s,textFillStyle:o,textStrokeStyle:r}=e;return t+"_"+i+"_"+n+"_"+s+"_"+o.join("_")+"_"+r.join("_")}onDispose(){this.spriteTexture&&this.spriteTexture.dispose(),this.textTexture&&this.textTexture.dispose()}get enableFade(){return this._enableFade}set enableFade(e){this._enableFade=e,this.material.enableFade=e}}function sB(e){let t=e.reduce(((e,t)=>{let i=+t.split("-")[0];return Math.max(i,e)}),0);return(e=e.sort(((e,i)=>{const n=e.split("-"),s=i.split("-");let o=n[0],r=n[1],a=n[2],l=s[0],g=s[1],c=s[2];if(o!==t){const e=t-o;r*=Math.pow(2,e),a*=Math.pow(2,e)}if(l!==t){const e=t-l;g*=Math.pow(2,e),c*=Math.pow(2,e)}return r!==g?g-r:c-a}))).reverse(),e}class oB{constructor(e){__publicField(this,"_blocks",{}),__publicField(this,"_collisionLabels",{icon_text:{},text_flat:{},text_fix:{},icon_flat:{},icon:{}}),__publicField(this,"_timers",{}),__publicField(this,"_enabled",!1),__publicField(this,"_spriteTexture"),this._rendering=e}get enabled(){return this._enabled}set enabled(e){e!==this._enabled&&(this._enabled=e,e?this.init():this.dispose())}set spriteTexture(e){this._spriteTexture||(this._spriteTexture=e)}init(){this.initCollisionLabel(),this.initLabel()}initCollisionLabel(){const e=this._iconDataSource=new ax,t=this._icon=this._rendering.add(new nB({type:"icon",vertexIcons:!0,enableFade:!0,isRenderInPostprocess:!0}));e.defineAttributes({id:"id",icon:"icon",iconSize:"iconSize",boundingBox:"boundingBox",offset:"offset",checkVisible:"checkVisible",tolerance:"tolerance"}),t.dataSource=e;const i=this._iconUvDataSource=new ax,n=this._iconUv=this._rendering.add(new nB({spriteTexture:this._spriteTexture,transparent:!0,enableFade:!0,isRenderInPostprocess:!0,type:"icon"}));i.defineAttributes({id:"id",iconUvs:"iconUvs",iconSize:"iconSize",iconOpacity:"iconOpacity",boundingBox:"boundingBox",offset:"offset",checkVisible:"checkVisible",tolerance:"tolerance"}),n.dataSource=i;const s=this._iconFlatUvDataSource=new ax,o=this._iconFlatUv=this._rendering.add(new nB({spriteTexture:this._spriteTexture,transparent:!0,isRenderInPostprocess:!0,enableFade:!0,flat:!0,type:"icon"}));s.defineAttributes({id:"id",iconUvs:"iconUvs",iconSize:"iconSize",iconOpacity:"iconOpacity",rotateZ:"rotateZ",boundingBox:"boundingBox",checkVisible:"checkVisible",tolerance:"tolerance"}),o.dataSource=s;const r=this._textFlatDataSource=new ax,a=this._textFlat=this._rendering.add(new nB({type:"text",vertexRotateZs:!0,isRenderInPostprocess:!0,enableFade:!0,flat:!0}));r.defineAttributes({id:"id",text:"text",textSize:"textSize",textFillStyle:"textFillStyle",textStrokeStyle:"textStrokeStyle",textStrokeWidth:"textStrokeWidth",textAnchor:"textAnchor",rotateZ:"rotateZ",boundingBox:"boundingBox",checkVisible:"checkVisible",tolerance:"tolerance"}),a.dataSource=r;const l=this._textFixedDataSource=new ax,g=this._textFixed=this._rendering.add(new nB({type:"text",isRenderInPostprocess:!0,enableFade:!0,flat:!1}));l.defineAttributes({id:"id",text:"text",textSize:"textSize",textFillStyle:"textFillStyle",textStrokeStyle:"textStrokeStyle",textStrokeWidth:"textStrokeWidth",textAnchor:"textAnchor",boundingBox:"boundingBox",offset:"offset",checkVisible:"checkVisible",tolerance:"tolerance"}),g.dataSource=l;const c=this._iconTextDataSource=new ax,d=this._iconText=this._rendering.add(new nB({type:"icontext",vertexIcons:!0,enableFade:!0,isRenderInPostprocess:!0}));c.defineAttributes({id:"id",text:"text",textSize:"textSize",textFillStyle:"textFillStyle",textStrokeStyle:"textStrokeStyle",textStrokeWidth:"textStrokeWidth",textAnchor:"textAnchor",textDrawOnIcon:"textDrawOnIcon",icon:"icon",iconSize:"iconSize",direction:"direction",rotateZ:"rotateZ",boundingBox:"boundingBox",offset:"offset",checkVisible:"checkVisible",tolerance:"tolerance"}),d.dataSource=c;const h=this._iconTextUvDataSource=new ax,u=this._iconTextUv=this._rendering.add(new nB({type:"icontext",isRenderInPostprocess:!0,spriteTexture:this._spriteTexture,enableFade:!0,transparent:!0}));h.defineAttributes({id:"id",type:"type",text:"text",textSize:"textSize",textFillStyle:"textFillStyle",textStrokeStyle:"textStrokeStyle",textStrokeWidth:"textStrokeWidth",textOffset:"textOffset",textAnchor:"textAnchor",textDrawOnIcon:"textDrawOnIcon",rotateZ:"rotateZ",iconUvs:"iconUvs",iconSize:"iconSize",iconOpacity:"iconOpacity",boundingBox:"boundingBox",offset:"offset",checkVisible:"checkVisible",tolerance:"tolerance"}),u.dataSource=h,this._rendering.collision.setGroupOption("poi",{enabledBucketCache:!0,requireClip:!1,bucketSort:sB}),this._rendering.collision.add(t,{margin:[2,2]},"poi"),this._rendering.collision.add(n,{margin:[2,2]},"poi"),this._rendering.collision.add(o,{margin:[2,2]},"poi"),this._rendering.collision.add(a,{margin:[2,2]},"poi"),this._rendering.collision.add(g,{margin:[2,2]},"poi"),this._rendering.collision.add(d,{margin:[2,2]},"poi"),this._rendering.collision.add(u,{margin:[2,2]},"poi")}initLabel(){const e=this._labelIconDataSource=new ax,t=this._labelIcon=this._rendering.add(new nB({type:"icon",vertexIcons:!0,isRenderInPostprocess:!0}));e.defineAttributes({id:"id",icon:"icon",iconSize:"iconSize",offset:"offset"}),t.dataSource=e;const i=this._labelIconFlatDataSource=new ax,n=this._labelIconFlat=this._rendering.add(new nB({vertexIcons:!0,transparent:!0,isRenderInPostprocess:!0,flat:!0,type:"icon"}));i.defineAttributes({id:"id",icon:"icon",iconSize:"iconSize",offset:"offset",iconUvs:"iconUvs",iconOpacity:"iconOpacity",rotateZ:"rotateZ"}),n.dataSource=i;const s=this._labelTextFlatDataSource=new ax,o=this._labelTextFlat=this._rendering.add(new nB({type:"text",vertexRotateZs:!0,isRenderInPostprocess:!0,flat:!0}));s.defineAttributes({text:"text",textSize:"textSize",textFillStyle:"textFillStyle",textStrokeStyle:"textStrokeStyle",textStrokeWidth:"textStrokeWidth",textAnchor:"textAnchor",rotateZ:"rotateZ"}),o.dataSource=s;const r=this._labelTextFixedDataSource=new ax,a=this._labelTextFixed=this._rendering.add(new nB({type:"text",isRenderInPostprocess:!0,flat:!1}));r.defineAttributes({text:"text",textSize:"textSize",textFillStyle:"textFillStyle",textStrokeStyle:"textStrokeStyle",textStrokeWidth:"textStrokeWidth",textAnchor:"textAnchor",offset:"offset"}),a.dataSource=r;const l=this._labelIconTextDataSource=new ax,g=this._labelIconText=this._rendering.add(new nB({type:"icontext",vertexIcons:!0,isRenderInPostprocess:!0}));l.defineAttributes({text:"text",textSize:"textSize",textFillStyle:"textFillStyle",textStrokeStyle:"textStrokeStyle",textStrokeWidth:"textStrokeWidth",textAnchor:"textAnchor",textDrawOnIcon:"textDrawOnIcon",icon:"icon",iconSize:"iconSize",direction:"direction",rotateZ:"rotateZ",offset:"offset"}),g.dataSource=l}processLabel(e){let t=e.type;if(t)return e;const i=e.flat;let n=!1,s=!1;if(e.text&&(n=!0),e.mapSrc){const{width:t,height:i}=e;e.icon=e.mapSrc,e.iconSize=[t||40,i||40],s=!0}return n&&s?t="icon_text":n?t=i?"text_flat":"text_fix":s&&(t=i?"icon_flat":"icon"),e.type=t,e}_getCollisionLabel(e){let t=e.type;e instanceof ex&&(t=e.attributes&&e.attributes.type);let i=e.group||"default";e.attributes&&e.attributes.group&&(i=e.attributes.group);const n=this._collisionLabels[t];if(n[i])return n[i];let s;const o=new ax;return"icon_text"===t?(s=this._rendering.add(new nB({type:"icontext",vertexIcons:!0,isRenderInPostprocess:!0})),o.defineAttributes({text:"text",textSize:"textSize",textFillStyle:"textFillStyle",textStrokeStyle:"textStrokeStyle",textStrokeWidth:"textStrokeWidth",textAnchor:"textAnchor",textDrawOnIcon:"textDrawOnIcon",icon:"icon",iconSize:"iconSize",direction:"direction",rotateZ:"rotateZ",offset:"offset",tolerance:"tolerance",isCustom:"isCustom"})):"icon"===t?(s=this._rendering.add(new nB({type:"icon",vertexIcons:!0,isRenderInPostprocess:!0})),o.defineAttributes({id:"id",icon:"icon",iconSize:"iconSize",offset:"offset",tolerance:"tolerance",isCustom:"isCustom"})):"icon_flat"===t?(s=this._rendering.add(new nB({vertexIcons:!0,transparent:!0,isRenderInPostprocess:!0,flat:!0,type:"icon"})),o.defineAttributes({id:"id",icon:"icon",iconSize:"iconSize",offset:"offset",iconUvs:"iconUvs",iconOpacity:"iconOpacity",rotateZ:"rotateZ",tolerance:"tolerance",isCustom:"isCustom"})):"text_flat"===t?(s=this._rendering.add(new nB({type:"text",vertexRotateZs:!0,isRenderInPostprocess:!0,flat:!0})),o.defineAttributes({text:"text",textSize:"textSize",textFillStyle:"textFillStyle",textStrokeStyle:"textStrokeStyle",textStrokeWidth:"textStrokeWidth",textAnchor:"textAnchor",rotateZ:"rotateZ",tolerance:"tolerance",isCustom:"isCustom"})):"text_fix"===t&&(s=this._rendering.add(new nB({type:"text",isRenderInPostprocess:!0,flat:!1})),o.defineAttributes({text:"text",textSize:"textSize",textFillStyle:"textFillStyle",textStrokeStyle:"textStrokeStyle",textStrokeWidth:"textStrokeWidth",textAnchor:"textAnchor",offset:"offset",tolerance:"tolerance",isCustom:"isCustom"})),s.dataSource=o,n[i]=s,this._rendering.collision.add(s,{margin:[0,0]},i),s}addCollisionLabel(e){const t=this.computeBoundingBox(e);e.boundingBox=t;const i=e.type,n=!!i;n||this.processLabel(e);let s=e;if(!(e instanceof ex)&&"[object Object]"===Array.prototype.toString.call(e)){const{position:t,forceProjected:i,...o}=e;o.isCustom=!n,s=new ex(t,o,i)}if("icon_text"===i)this._iconTextDataSource.add(s);else if("icon_text_uv"===i)this._iconTextUvDataSource.add(s);else if("icon"===i)this._iconDataSource.add(s);else if("icon_uv"===i)this._iconUvDataSource.add(s);else if("icon_flat_uv"===i)this._iconFlatUvDataSource.add(s);else if("text_flat"===i||"labelp"===i)this._textFlatDataSource.add(s);else if("text_fix"===i)this._textFixedDataSource.add(s);else{this._getCollisionLabel(e).dataSource.add(s)}return s}addNormalLabel(e){let t=e;if(!(e instanceof ex)&&"[object Object]"===Array.prototype.toString.call(e)){const{position:i,forceProjected:n,...s}=e;t=new ex(i,s,n)}return"icon"===e.type?this._labelIconDataSource.add(t):"icon_flat"===e.type?this._labelIconFlatDataSource.add(t):"text_flat"===e.type?this._labelTextFlatDataSource.add(t):"text_fix"===e.type?this._labelTextFixedDataSource.add(t):"icon_text"===e.type&&this._labelIconTextDataSource.add(t),t}addLabel(e){this.enabled||(this.enabled=!0);if(!e.position)return void console.warn("need position");let t;return e.collision?t=this.addCollisionLabel(e):(this.processLabel(e),t=this.addNormalLabel(e)),t}addLabels(e,t){const i=this._rendering.taskScheduler.addTask(this._createLabelTask(e));t=t||(new Date).getTime()+Math.random().toString(36).slice(2),this._blocks[t]=i}_createLabelTask(e){return()=>new Promise(((t,i)=>{try{for(const t of e){const e=t.collision||!0;t.collision=e,e?this.addCollisionLabel(t):this.addNormalLabel(t)}this._rendering.requestRender(),t()}catch(n){i(n)}}))}computeBoundingBox(e){let t;return this.enabled||(this.enabled=!0),"icon_text"===e.type?t=this._iconText.computeBoundingBox(e):"icon_text_uv"===e.type?t=this._iconTextUv.computeBoundingBox(e):"icon"===e.type?t=this._icon.computeBoundingBox(e):"icon_uv"===e.type?t=this._iconUv.computeBoundingBox(e):"icon_flat_uv"===e.type?t=this._iconFlatUv.computeBoundingBox(e):"text_flat"===e.type||"labelp"===e.type?t=this._textFlat.computeBoundingBox(e):"text_fix"===e.type&&(t=this._textFixed.computeBoundingBox(e)),t}_checkRemoveCollisionLabel(e,t){if(1===e.dataSource.userData.length){this._rendering.remove(e);let i=t.type;t instanceof ex&&(i=t.attributes&&t.attributes.type);let n=t.group||"default";t.attributes&&t.attributes.group&&(n=t.attributes.group),this._collisionLabels[i]&&delete this._collisionLabels[i][n]}}removeCollisionLabel(e){if(e.attributes&&e.attributes.isCustom){const t=this._getCollisionLabel(e);return t.dataSource.remove(e),void this._checkRemoveCollisionLabel(t,e)}"icon_text"===e.type?this._iconTextDataSource.remove(e):"icon_text_uv"===e.type?this._iconTextUvDataSource.remove(e):"icon"===e.type?this._iconDataSource.remove(e):"icon_uv"===e.type?this._iconUvDataSource.remove(e):"icon_flat_uv"===e.type?this._iconFlatUvDataSource.remove(e):"text_flat"===e.type||"labelp"===e.type?this._textFlatDataSource.remove(e):"text_fix"===e.type&&this._textFixedDataSource.remove(e)}removeNormalLabel(e){const t=e.attributes;let i=e.type;t&&t.type&&(i=t.type),"icon"===i?this._labelIconDataSource.remove(e):"icon_flat"===i?this._labelIconFlatDataSource.remove(e):"text_flat"===i?this._labelTextFlatDataSource.remove(e):"text_fix"===i?this._labelTextFixedDataSource.remove(e):"icon_text"===i&&this._labelIconTextDataSource.remove(e)}removeLabel(e){let t=e.collision;t||(t=e.attributes&&e.attributes.collision),t?this.removeCollisionLabel(e):this.removeNormalLabel(e)}removeLabels(e,t){const i=this._blocks[t];if(i&&!i.isStart())return i.cancel(),void delete this._blocks[t];for(const n of e){const e=n.collision||!0;n.collision=e,this.removeLabel(n)}this._rendering.requestRender()}dispose(){this._rendering.collision.remove(this._fixText,"poi"),this._rendering.collision.remove(this._labelText,"poi"),this._rendering.collision.remove(this._flatText,"poi"),this._rendering.remove(this._fixText),this._rendering.remove(this._flatText),this._rendering.remove(this._labelText)}}function rB(e,t,i,n,s){aB(e,t,i||0,n||e.length-1,s||gB)}function aB(e,t,i,n,s){for(;n>i;){if(n-i>600){var o=n-i+1,r=t-i+1,a=Math.log(o),l=.5*Math.exp(2*a/3),g=.5*Math.sqrt(a*l*(o-l)/o)*(r-o/2<0?-1:1);aB(e,t,Math.max(i,Math.floor(t-r*l/o+g)),Math.min(n,Math.floor(t+(o-r)*l/o+g)),s)}var c=e[t],d=i,h=n;for(lB(e,i,t),s(e[n],c)>0&&lB(e,i,n);d<h;){for(lB(e,d,h),d++,h--;s(e[d],c)<0;)d++;for(;s(e[h],c)>0;)h--}0===s(e[i],c)?lB(e,i,h):lB(e,++h,n),h<=t&&(i=h+1),t<=h&&(n=h-1)}}function lB(e,t,i){var n=e[t];e[t]=e[i],e[i]=n}function gB(e,t){return e<t?-1:e>t?1:0}class cB{constructor(e=9){this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}all(){return this._all(this.data,[])}search(e){let t=this.data;const i=[];if(!yB(e,t))return i;const n=this.toBBox,s=[];for(;t;){for(let o=0;o<t.children.length;o++){const r=t.children[o],a=t.leaf?n(r):r;yB(e,a)&&(t.leaf?i.push(r):bB(e,a)?this._all(r,i):s.push(r))}t=s.pop()}return i}collides(e){let t=this.data;if(!yB(e,t))return!1;const i=[];for(;t;){for(let n=0;n<t.children.length;n++){const s=t.children[n],o=t.leaf?this.toBBox(s):s;if(yB(e,o)){if(t.leaf||bB(e,o))return!0;i.push(s)}}t=i.pop()}return!1}load(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(let t=0;t<e.length;t++)this.insert(e[t]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===t.height)this._splitRoot(this.data,t);else{if(this.data.height<t.height){const e=this.data;this.data=t,t=e}this._insert(t,this.data.height-t.height-1,!0)}else this.data=t;return this}insert(e){return e&&this._insert(e,this.data.height-1),this}clear(){return this.data=_B([]),this}remove(e,t){if(!e)return this;let i=this.data;const n=this.toBBox(e),s=[],o=[];let r,a,l;for(;i||s.length;){if(i||(i=s.pop(),a=s[s.length-1],r=o.pop(),l=!0),i.leaf){const n=dB(e,i.children,t);if(-1!==n)return i.children.splice(n,1),s.push(i),this._condense(s),this}l||i.leaf||!bB(i,n)?a?(r++,i=a.children[r],l=!1):i=null:(s.push(i),o.push(r),r=0,a=i,i=i.children[0])}return this}toBBox(e){return e}compareMinX(e,t){return e.minX-t.minX}compareMinY(e,t){return e.minY-t.minY}toJSON(){return this.data}fromJSON(e){return this.data=e,this}_all(e,t){const i=[];for(;e;)e.leaf?t.push(...e.children):i.push(...e.children),e=i.pop();return t}_build(e,t,i,n){const s=i-t+1;let o,r=this._maxEntries;if(s<=r)return o=_B(e.slice(t,i+1)),hB(o,this.toBBox),o;n||(n=Math.ceil(Math.log(s)/Math.log(r)),r=Math.ceil(s/Math.pow(r,n-1))),o=_B([]),o.leaf=!1,o.height=n;const a=Math.ceil(s/r),l=a*Math.ceil(Math.sqrt(r));vB(e,t,i,l,this.compareMinX);for(let g=t;g<=i;g+=l){const t=Math.min(g+l-1,i);vB(e,g,t,a,this.compareMinY);for(let i=g;i<=t;i+=a){const s=Math.min(i+a-1,t);o.children.push(this._build(e,i,s,n-1))}}return hB(o,this.toBBox),o}_chooseSubtree(e,t,i,n){for(;n.push(t),!t.leaf&&n.length-1!==i;){let i,n=1/0,r=1/0;for(let a=0;a<t.children.length;a++){const l=t.children[a],g=AB(l),c=(s=e,o=l,(Math.max(o.maxX,s.maxX)-Math.min(o.minX,s.minX))*(Math.max(o.maxY,s.maxY)-Math.min(o.minY,s.minY))-g);c<r?(r=c,n=g<n?g:n,i=l):c===r&&g<n&&(n=g,i=l)}t=i||t.children[0]}var s,o;return t}_insert(e,t,i){const n=i?e:this.toBBox(e),s=[],o=this._chooseSubtree(n,this.data,t,s);for(o.children.push(e),IB(o,n);t>=0&&s[t].children.length>this._maxEntries;)this._split(s,t),t--;this._adjustParentBBoxes(n,s,t)}_split(e,t){const i=e[t],n=i.children.length,s=this._minEntries;this._chooseSplitAxis(i,s,n);const o=this._chooseSplitIndex(i,s,n),r=_B(i.children.splice(o,i.children.length-o));r.height=i.height,r.leaf=i.leaf,hB(i,this.toBBox),hB(r,this.toBBox),t?e[t-1].children.push(r):this._splitRoot(i,r)}_splitRoot(e,t){this.data=_B([e,t]),this.data.height=e.height+1,this.data.leaf=!1,hB(this.data,this.toBBox)}_chooseSplitIndex(e,t,i){let n,s=1/0,o=1/0;for(let r=t;r<=i-t;r++){const t=uB(e,0,r,this.toBBox),a=uB(e,r,i,this.toBBox),l=fB(t,a),g=AB(t)+AB(a);l<s?(s=l,n=r,o=g<o?g:o):l===s&&g<o&&(o=g,n=r)}return n||i-t}_chooseSplitAxis(e,t,i){const n=e.leaf?this.compareMinX:pB,s=e.leaf?this.compareMinY:mB;this._allDistMargin(e,t,i,n)<this._allDistMargin(e,t,i,s)&&e.children.sort(n)}_allDistMargin(e,t,i,n){e.children.sort(n);const s=this.toBBox,o=uB(e,0,t,s),r=uB(e,i-t,i,s);let a=CB(o)+CB(r);for(let l=t;l<i-t;l++){const t=e.children[l];IB(o,e.leaf?s(t):t),a+=CB(o)}for(let l=i-t-1;l>=t;l--){const t=e.children[l];IB(r,e.leaf?s(t):t),a+=CB(r)}return a}_adjustParentBBoxes(e,t,i){for(let n=i;n>=0;n--)IB(t[n],e)}_condense(e){for(let t,i=e.length-1;i>=0;i--)0===e[i].children.length?i>0?(t=e[i-1].children,t.splice(t.indexOf(e[i]),1)):this.clear():hB(e[i],this.toBBox)}}function dB(e,t,i){if(!i)return t.indexOf(e);for(let n=0;n<t.length;n++)if(i(e,t[n]))return n;return-1}function hB(e,t){uB(e,0,e.children.length,t,e)}function uB(e,t,i,n,s){s||(s=_B(null)),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(let o=t;o<i;o++){const t=e.children[o];IB(s,e.leaf?n(t):t)}return s}function IB(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function pB(e,t){return e.minX-t.minX}function mB(e,t){return e.minY-t.minY}function AB(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function CB(e){return e.maxX-e.minX+(e.maxY-e.minY)}function fB(e,t){const i=Math.max(e.minX,t.minX),n=Math.max(e.minY,t.minY),s=Math.min(e.maxX,t.maxX),o=Math.min(e.maxY,t.maxY);return Math.max(0,s-i)*Math.max(0,o-n)}function bB(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function yB(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function _B(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function vB(e,t,i,n,s){const o=[t,i];for(;o.length;){if((i=o.pop())-(t=o.pop())<=n)continue;const r=t+Math.ceil((i-t)/n/2)*n;rB(e,r,t,i,s),o.push(t,r,r,i)}}const xB=new Bi,BB=new Qt,wB=new Dt,SB=new Dt,GB=new Dt;class MB{constructor(e){__publicField(this,"_groupObjectMap",{}),__publicField(this,"_groupDataMap",{}),__publicField(this,"_groupOptions",{}),__publicField(this,"_objectDataMap",new Map),__publicField(this,"_needsUpdate",!1),__publicField(this,"_restrictCount",1e4),__publicField(this,"_cacheBucketKeys",{}),__publicField(this,"_lastUpdateTime",0),__publicField(this,"_delayUpdateTime",200),__publicField(this,"_delayUpdateTimeHandler",null),__publicField(this,"_margin",[0,0]),__publicField(this,"_maxRenderDepth",1),__publicField(this,"_lastZoom",0),__publicField(this,"_viewMatrixWorld",new Bi),__publicField(this,"_projectionMatrix",new Bi),__publicField(this,"_viewChanged",!0),this._rendering=e}add(e,t={},i="_default"){e instanceof gx?e.dataSource?(this._groupObjectMap[i]||(this._groupObjectMap[i]=[],this._groupDataMap[i]=[]),this._groupObjectMap[i].push(e),void 0!==t.margin&&"number"==typeof t.margin&&(t.margin=[t.margin,t.margin]),e._enableCollision=!0,e._collisionOptions=t,e.dataSource.defineAttribute("rank","rank"),e.dataSource.defineAttribute("bucket","bucket"),e.dataSource.defineAttribute("distance","distance")):console.error("Object must have DataSource before it added to Collision!"):console.error("Collison Test only work with GeoObject.")}setGroupOption(e,t){this._groupOptions[e]=t}remove(e,t="_default"){if(!(e instanceof gx))return void console.error("Collison Test only work with GeoObject.");let i=this._groupObjectMap[t].indexOf(e);i>-1?(this._groupObjectMap[t].splice(i,1),delete e._enableCollision,delete e._collisionOptions,delete e._collisionData,delete e._collisionUpdated,e.dataSource.undefineAttribute("rank","rank")):console.error("remove error: cannot find object in this group.")}sortBucket(e){e&&e.length>0&&e.sort(((e,t)=>t.rank-e.rank||t.position[0]-e.position[0]||t.position[1]-e.position[1]))}sortBuckets(e,t){const i=this._groupOptions[t]||{},n=i.bucketSort,s=i.enabledBucketCache;let o=Object.keys(e);if(n&&(o=n(o)),s){this._cacheBucketKeys[t]||(this._cacheBucketKeys[t]=[]);const i=this._cacheBucketKeys[t];if(i&&i.length>0){const t=[],n=[];for(let e=0;e<i.length;e++){const n=i[e];o.includes(n)&&t.push(n)}for(let s=0;s<o.length;s++){const t=o[s];if(!i.includes(t)){const i=e[t][0]||{};n.push({key:t,distance:i.distance||Number.POSITIVE_INFINITY})}}n.sort(((e,t)=>e.distance-t.distance)),o=t.concat(n.map((e=>e.key)))}this._cacheBucketKeys[t]=o}const r=[];for(let a=0;a<o.length;a++){const t=e[o[a]];this.sortBucket(t),r.push(...t)}return this.sortBucket(r),r}sortData(){let e=Object.keys(this._groupObjectMap);for(let t=0;t<e.length;t++){const i=e[t],n=this._groupObjectMap[i];for(let e=0;e<n.length;e++){const t=n[e];t._collisionData=[],t._collisionUpdated=!0;let i=t.dataSource.userData;for(let e=0;e<i.length;e++)i[e]._objects=t.dataSource.objects}let s=[];for(let e=0;e<n.length;e++){const t=n[e];s=s.concat(t.dataSource.userData)}const o={};s.forEach((e=>{const t=e.bucket||"default";o[t]||(o[t]=[]),o[t].push(e)})),this._groupDataMap[i]=this.sortBuckets(o,i)}this._needsUpdate=!1}update(e){if(!Object.keys(this._groupDataMap).length)return;if(this._delayUpdateTimeHandler)return;const t=Date.now(),i=t-this._lastUpdateTime;i<this._delayUpdateTime?this._delayUpdateTimeHandler=setTimeout((()=>{clearTimeout(this._delayUpdateTimeHandler),this._delayUpdateTimeHandler=null,this._rendering.requestRender()}),this._delayUpdateTime-i+1):(this.needsUpdate?(this.sortData(),this._collisionTest()):(this._viewChanged=!e.viewMatrixWorld.equals(this._viewMatrixWorld)||!e.projectionMatrix.equals(this._projectionMatrix),this._viewChanged&&(this._collisionTest(),this._viewMatrixWorld.copy(e.viewMatrixWorld),this._projectionMatrix.copy(e.projectionMatrix))),this._lastUpdateTime=t)}_calculatePixelSize(e,t){const i=this._rendering.renderState.cameraOffset;t.sub(i);return((e,t,i)=>.2*Math.tan(t/2)*e/i*10)(e.position.distanceTo(t),e.fov*Math.PI/180,this._rendering.resolution.y)}_collisionTest(){let e=Object.keys(this._groupDataMap);const t=this._rendering.camera;xB.multiplyMatrices(t.projectionMatrix,this._rendering.renderState.viewMatrixWorldInverse);const i=this._rendering.resolution?this._rendering.resolution.toArray():[0,0],[n,s]=i;if(isNaN(n)||n<=0||isNaN(s)||s<=0)return console.warn("resolution is invalid"),!1;const o=this._rendering.stats,r=this._rendering.renderState.cameraOffset,a=this._objectDataMap;a.clear(),o.beginTimeStatsItem("labelCollision");let l=null;for(let g=0;g<e.length;g++){const i=e[g],o=this._groupDataMap[i];if(!o)continue;const c=new cB,d=this._groupOptions[i]||{};let h=!0;am(d.requireClip)&&(h=d.requireClip);for(let e=0;e<o.length;e++){const i=o[e],g=i._objects;for(let e=0;e<g.length;e++){const t=g[e];a.get(t)||a.set(t,[])}const d=g.filter((e=>e._enableCollision))[0],[u,I,p]=i.position;GB.set(u,I,p,1),GB.applyMatrix4(xB),GB.divideScalar(GB.w);const m=(GB.x+1)/2*n,A=(1-GB.y)/2*s;if(GB.z>this._maxRenderDepth)continue;let C=0,f=0;const b=d.collisionTest(i),y=b.tolerance||0;if(b&&b.chars){const e=BB.fromArray(i.position),o=this._calculatePixelSize(t,e),a=b.chars,g=b.rotationMatrix;let h=!1;const m=[];for(let i=0,c=a.length;i<c;i++){const c=a[i];let h=c.width,A=c.height;const C=c.offsetX,f=c.offsetY;if(!h||!A)continue;const b=wB.set(C*o,f*o,0,0).applyMatrix4(g),_=SB.set(u+b.x,I+b.y,p+b.z,1);e.copy(_).sub(r).sub(t.position);const v=e.applyMatrix4(g).normalize(),x=Math.max(Math.abs(v.z),.1);_.applyMatrix4(xB),_.divideScalar(_.w);const B=(_.x+1)/2*n,w=(1-_.y)/2*s;l=d._collisionOptions.margin||this.margin;const S=Math.hypot(h,A),G=l[0]+y,M=l[1]+y;h=S+2*Math.max(G,0),A=S*x+2*Math.max(M,0);const R=B-h/2,T=w-A/2,Z={minX:R,minY:T,maxX:R+h,maxY:T+A};m.push(Z)}for(let t=0;t<m.length;t++){const e=m[t];if(c.collides(e)){h=!0;break}}if(h)continue;for(let t=0;t<m.length;t++){const e=m[t];c.insert(e)}}else{let e=b.width,t=b.height;const i=b.offsetX||0,o=b.offsetY||0;if(!e||!t)continue;C=e,f=t,l=d._collisionOptions.margin||this.margin;const r=l[0]+y,a=l[1]+y;e+=2*Math.max(r,0),t+=2*Math.max(a,0);const g=m-e/2+i,u=A-t/2+o,I=g+e,p=u+t;if(h&&(I<0||p<0||g>n||u>s))continue;const _={minX:g,minY:u,maxX:I,maxY:p};if((r>=0||a>=0)&&c.collides(_))continue;c.insert(_)}let _={...i,w:C,h:f};for(let e=0;e<g.length;e++){const t=g[e];a.get(t).push(_)}}}Array.from(a.entries()).forEach((([e,t])=>{e._collisionData&&e._collisionData.length===t.length||(e._collisionData=t,e._collisionUpdated=!0)})),o.endTimeStatsItem("labelCollision")}set margin(e){"number"==typeof e?this._margin=[e,e]:e instanceof Array&&(this._margin=e)}get margin(){return this._margin}set maxRenderDepth(e){this._maxRenderDepth=e}set restrictCount(e){this._restrictCount=e}get restrictCount(){return this._restrictCount}get needsUpdate(){return this._needsUpdate}set needsUpdate(e){this._needsUpdate=e}}class RB{constructor(e){__publicField(this,"_rendering",null),__publicField(this,"_mixer",null),__publicField(this,"_customMixers",[]),this._rendering=e}update(e){this._mixer&&this._mixer.update(e.deltaSeconds);for(const t of this._customMixers)t.update(e.deltaSeconds)}addMixer(e){-1===this._customMixers.indexOf(e)&&this._customMixers.push(e)}removeMixer(e){let t=this._customMixers.indexOf(e);-1!==t&&this._customMixers.splice(t,1)}get mixer(){return this._mixer||(this._mixer=new fg(this._rendering.scene)),this._mixer}}class TB{static createButton(e){const t=document.createElement("button");function i(){t.style.display="",t.style.cursor="auto",t.style.left="calc(50% - 75px)",t.style.width="150px",t.onmouseenter=null,t.onmouseleave=null,t.onclick=null}function n(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="rgba(0,0,0,0.1)",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none",e.style.zIndex="999"}if("xr"in navigator)return t.id="VRButton",t.style.display="none",n(t),navigator.xr.isSessionSupported("immersive-vr").then((function(n){n?function(){let i=null;async function n(n){n.addEventListener("end",s),await e.xr.setSession(n),t.textContent="EXIT VR",i=n}function s(){i.removeEventListener("end",s),t.textContent="ENTER VR",i=null}t.style.display="",t.style.cursor="pointer",t.style.left="calc(50% - 50px)",t.style.width="100px",t.textContent="ENTER VR",t.onmouseenter=function(){t.style.opacity="1.0"},t.onmouseleave=function(){t.style.opacity="0.5"},t.onclick=function(){if(null===i){const e={optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]};navigator.xr.requestSession("immersive-vr",e).then(n)}else i.end()}}():(i(),t.textContent="VR NOT SUPPORTED"),n&&TB.xrSessionIsGranted&&t.click()})).catch((function(e){i(),console.warn("Exception when trying to call xr.isSessionSupported",e),t.textContent="VR NOT ALLOWED"})),t;{const e=document.createElement("a");return!1===window.isSecureContext?(e.href=document.location.href.replace(/^http:/,"https:"),e.innerHTML="WEBXR NEEDS HTTPS"):(e.href="https://immersiveweb.dev/",e.innerHTML="WEBXR NOT AVAILABLE"),e.style.left="calc(50% - 90px)",e.style.width="180px",e.style.textDecoration="none",n(e),e}}static registerSessionGrantedListener(){if("undefined"!=typeof navigator&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",(()=>{TB.xrSessionIsGranted=!0}))}}}TB.xrSessionIsGranted=!1,TB.registerSessionGrantedListener();class ZB{constructor(e){__publicField(this,"onSessionStart",(()=>{})),__publicField(this,"onSessionEnd",(()=>{})),this._rendering=e}init(){const e=this._rendering,t=e._renderer;if(e._useXR){e.useMrt=!1,e.enableAnimationLoop=!0,e.animationLoopFrameTime=16,e.autoOffsetRelativeCenter=!1;const i=e._camera,n=this.camera=i.clone();n.far=2e3,n.name="xrCamera";const s=this.xrCamera=new qr;s.name="xrCameraGroup",s.add(n),e._engine.add(s),s.rotation.set(Math.PI/2,0,0),document.body.appendChild(TB.createButton(t)),t.setAnimationLoop(e.render),t.xr.enabled=!0,t.xr.addEventListener("sessionstart",this.onSessionStart),t.xr.addEventListener("sessionend",this.onSessionEnd)}}dispose(){const e=this._rendering._renderer;e.xr.removeEventListener("sessionstart",this.onSessionStart),e.xr.removeEventListener("sessionend",this.onSessionEnd)}}class VB{constructor(e){__publicField(this,"_lastValue",0),__publicField(this,"_count",0),__publicField(this,"_total",0),__publicField(this,"_beginTime",0),__publicField(this,"_name"),this._name=e}begin(e){this._beginTime=e}end(e){this._lastValue=e-this._beginTime,this._total=this._total+this._lastValue,this._count++}add(e){this._total+=e,this._lastValue=e,this._count++}get total(){return this._total}get count(){return this._count}get average(){return 0===this._count?0:this._total/this._count}get lastValue(){return this._lastValue}get name(){return this._name}get beginTime(){return this._beginTime}}class WB{constructor(){__publicField(this,"_timeStatsItem",{})}addTimeStatsItem(e){const t=new VB(e);this._timeStatsItem[e]=t}removeTimeStatsItem(e){delete this._timeStatsItem[e]}beginTimeStatsItem(e,t){this._timeStatsItem[e]||this.addTimeStatsItem(e),null==t&&(t=performance.now()),this._timeStatsItem[e].begin(t)}endTimeStatsItem(e,t){this._timeStatsItem[e]||this.addTimeStatsItem(e),null==t&&(t=performance.now()),this._timeStatsItem[e].end(t)}addTimeStatsItemValue(e,t){this._timeStatsItem[e]||this.addTimeStatsItem(e),this._timeStatsItem[e].add(t)}getSortedTimeStatsItems(){let e=Object.values(this._timeStatsItem);const t=performance.now();return e=e.filter((e=>t-e.beginTime<5e3)),e.sort(((e,t)=>t.average-e.average)),e}printString(){let e="Stas:\n";const t=this.getSortedTimeStatsItems();for(const i of t)e+=`${i.name}:\n${i.average.toFixed(2)}\t ${i.lastValue.toFixed(2)}\t ${i.count}\t ${i.total.toFixed(2)}\n`;return e}}const EB=(e,t)=>e.distance-t.distance,NB=(e,t)=>{const i=e._listeners;if(void 0===i)return!1;let n=null;for(let s=0,o=t.length;s<o;s++)if(n=i[t[s]],n&&n.length>0)return!0;return!1},FB=(e,t,i,n,s,o,r,a)=>{let l=!0,g=!0;if(1&i&&((r=r||NB(e,o))||(g=!1)),!(2&i)||e.visible){if(n&&!n(e,t,s)&&(g=!1),g&&e.layers.test(t.layers)){!1===e.raycast(t,s)&&(l=!1)}if(!0===l&&!0===a){const a=e.children;for(let e=0,l=a.length;e<l;e++)FB(a[e],t,i,n,s,o,r,!0)}}};class XB extends yg{constructor(){super(),this.mouse=new bt}intersectFlagObjects(e,t,i,n=!0,s,o=[]){for(let r=0,a=e.length;r<a;r++)FB(e[r],this,t,s,o,i,!1,n);return o.sort(EB),o}}__publicField(XB,"CHECK_EVENT",1),__publicField(XB,"CHECK_VISIBLE",2);class HB{constructor(){__publicField(this,"isFlowEvent",!0)}execute(){}}class zB extends HB{constructor(e,t=0){super(),__publicField(this,"_currentIndex",0),__publicField(this,"_callbacks",[]),t>e.length-1&&(t=e.length-1),t<0&&(t=0),this._currentIndex=t,Array.isArray(e)?this._callbacks=e:console.warn("callbacks must be an array")}execute(e){const t=this._callbacks[this._currentIndex];t&&t(e,this._currentIndex),this._currentIndex++,this._currentIndex>this._callbacks.length-1&&(this._currentIndex=0)}}class LB{constructor(e,t,i){__publicField(this,"_engine",null),__publicField(this,"_originalEvent",null),__publicField(this,"_isPropagationStopped",!1),__publicField(this,"_entityProxy",null),__publicField(this,"_position"),__publicField(this,"_point"),__publicField(this,"target",null),__publicField(this,"currentTarget",null),__publicField(this,"intersection",null),this._engine=e,this._originalEvent=t,this.pixel=t&&t.pixel,this.event=t&&t.event,this._entityProxy=i}get originalEvent(){return this._originalEvent}stopPropagation(){this._isPropagationStopped=!0}get isPropagationStopped(){return this._isPropagationStopped}get entity(){return this._entityProxy?this._entityProxy.entity:null}get object(){return console.warn("EventParams.object is deprecated, use EventParams.currentTarget instead"),this.currentTarget}get directObject(){return console.warn("EventParams.directObject is deprecated, use EventParams.target instead"),this.target}get position(){if(void 0!==this._position)return this._position;if(this.intersection&&this.intersection.point){const e=this.intersection.point;this._position=[e.x,e.y,e.z]}else this._position=null;return this._position}set position(e){void 0===this._position?null!==e?e.isVector3?this._position=[e.x,e.y,e.z]:this._position=e:this._position=null:console.warn("EventParams.position is readonly after initialized")}get point(){if(void 0!==this._point)return this._point;const e=this.position;return this._point=null===e?null:this._engine.map.unprojectArrayCoordinate(e),this._point}}class DB{constructor(e,t){__publicField(this,"_hasComputed",!1),this._object=e,this._intersection=t}_computeEntity(){const e=this._object,t=this._intersection;if(e.getEntityByIntersection)return e.getEntityByIntersection(t);let i=-1;return void 0!==t.instanceId?i=t.instanceId:void 0!==t.face&&null!==t.face?e.getEntityIndexByFace&&(i=e.getEntityIndexByFace(t.faceIndex,t.face.a)):void 0!==t.index&&(i=t.index),i<0?null:e.getEntityByIndex(i)}get entity(){return this._hasComputed||(this._entity=this._computeEntity(),this._hasComputed=!0),this._entity}get intersection(){return this._intersection}}class KB{constructor(){this._eventToTriggerMap={},this._isBusy=!1,this._isEmpty=!0}restart(){this._eventToTriggerMap={}}putEvent(e,t){this._eventToTriggerMap[e]||(this._eventToTriggerMap[e]=t,this._isEmpty=!1)}async triggerEvents(e){if(this._isBusy)return;this._isBusy=!0;const t=this._eventToTriggerMap;this._eventToTriggerMap={},this._isEmpty=!0;try{await e(t)}catch(pb){console.error("error occurs when triggering event",pb)}finally{this._isBusy=!1}}get isEmpty(){return this._isEmpty}get isBusy(){return this._isBusy}}const YB=class{constructor(e){__publicField(this,"_mouse",new bt),__publicField(this,"_mousePosition",new bt),__publicField(this,"_intersections"),__publicField(this,"_engine",null),__publicField(this,"_currentMouseEnterLeaveObjects"),__publicField(this,"_handleTriggerEvents",(async e=>{await this._triggerEventOfObjects(e)&&this._triggerMouseLeaveEvents(e),this._lastMouseEnterLeaveObjects=this._currentMouseEnterLeaveObjects,this._engine.requestRender()})),__publicField(this,"_triggerEventOfObjects",(async e=>{const t=this._engine,i=Object.keys(e),n=e[i[0]];this._updateMouse(n);const s=this._currentMouseEnterLeaveObjects,o=s&&s.keys();let r=!1;o.forEach((e=>{r=r||NB(e,i)})),this._intersections=await t.rendering.picking.pickIntersectionsOfEventObjects(this._mousePosition,i);const a=this._currentMouseEnterLeaveObjects=new Map;if(0===this._intersections.length)return await this._triggerRootObjectEvents(e,null),r;const l=this._intersections[0];let g=l.object;const c=g,d={};let h=null,u=null;for(;g;){let t=!1;u=[];const n=g._listeners;for(const e of i)n&&n[e]&&0!==n[e].length&&u.push(e);const s=n&&Object.keys(n)||[];(s.includes(YB.EVENT_NAME_MOUSE_ENTER)||s.includes(YB.EVENT_NAME_MOUSE_LEAVE))&&(t=!0),h=g.isEventEntitySupported?new DB(g,l):null;let o=!1,r=!1,I=null;if(t)if(a.set(g,h),this._lastMouseEnterLeaveObjects.has(g)){const e=this._lastMouseEnterLeaveObjects.get(g);g.isEventEntitySupported&&!this._isSameEntity(h,e)&&(o=!0,r=!0,I=e)}else o=!0;for(const i of u){if(d[i])continue;if(i===YB.EVENT_NAME_MOUSE_ENTER&&!o)continue;if(i===YB.EVENT_NAME_MOUSE_LEAVE){if(!r)continue;I&&(h=I)}const t=e[i],n=g._listeners[i],s=new LB(this._engine,t,h);s.target=c,s.currentTarget=g,s.intersection=l,this._executeCallbacks(n,s),s.isPropagationStopped&&(d[i]=!0)}g=g.parent}return await this._triggerRootObjectEvents(e,l,d),r})),__publicField(this,"_isSameEntity",((e,t)=>{var i,n;const s=null==(i=null==e?void 0:e.entity)?void 0:i.index,o=null==(n=null==t?void 0:t.entity)?void 0:n.index;return void 0!==s&&s===o})),__publicField(this,"_handlePointerDown",(e=>{this._eventThrottle.putEvent(YB.EVENT_NAME_POINTER_DOWN,e),this._engine.requestRender()})),__publicField(this,"_handlePointerUp",(e=>{this._eventThrottle.putEvent(YB.EVENT_NAME_POINTER_UP,e),this._engine.requestRender()})),__publicField(this,"_handleClick",(e=>{this._eventThrottle.putEvent(YB.EVENT_NAME_CLICK,e),this._engine.requestRender()})),__publicField(this,"_handleDblClick",(e=>{this._eventThrottle.putEvent(YB.EVENT_NAME_DOUBLE_CLICK,e),this._engine.requestRender()})),__publicField(this,"_handleRightClick",(e=>{this._eventThrottle.putEvent(YB.EVENT_NAME_RIGHT_CLICK,e),this._engine.requestRender()})),__publicField(this,"_handleRightDblClick",(e=>{this._eventThrottle.putEvent(YB.EVENT_NAME_RIGHT_DOUBLE_CLICK,e),this._engine.requestRender()})),__publicField(this,"_handleMouseMove",(e=>{this._eventThrottle.putEvent(YB.EVENT_NAME_MOUSE_MOVE,e),this._eventThrottle.putEvent(YB.EVENT_NAME_MOUSE_ENTER,e),this._eventThrottle.putEvent(YB.EVENT_NAME_MOUSE_LEAVE,e),this._engine.requestRender()})),__publicField(this,"_updateMouse",(e=>{const t=this._engine,i=t.map.getResolution();let n=e.pixel[0],s=e.pixel[1];const o=t.map.map.control;o&&(n/=o.startScaleX||1,s/=o.startScaleY||1);const r=n/i.x,a=s/i.y;this._mouse.set(2*r-1,1-2*a),this._mousePosition.set(n,s)})),this._engine=e,this._eventThrottle=new KB,this._isEventHandleBusy=!1,this._currentMouseEnterLeaveObjects=new Map,this._lastMouseEnterLeaveObjects=new Map}beginFrame(){}endFrame(){const e=this._eventThrottle;e.isBusy||e.isEmpty||e.triggerEvents(this._handleTriggerEvents)}_triggerMouseLeaveEvents(e){const t=this._currentMouseEnterLeaveObjects,i=this._lastMouseEnterLeaveObjects;for(const[n,s]of i)if(!t.has(n)){const t=n._listeners;if(!t||!t[YB.EVENT_NAME_MOUSE_LEAVE]||0===t[YB.EVENT_NAME_MOUSE_LEAVE].length)continue;const i=e[YB.EVENT_NAME_MOUSE_MOVE],o=t[YB.EVENT_NAME_MOUSE_LEAVE],r=new LB(this._engine,i,s);r.target=n,r.currentTarget=n,r.intersection=s&&s.intersection,this._executeCallbacks(o,r)}}async _triggerRootObjectEvents(e,t,i){const n=this._engine.map,s=n._listeners;if(!s||0===Object.keys(s).length)return;const o=Object.keys(e);let r=null;t&&(r=t.point);let a=!0;for(const l of o){if(i&&i[l])continue;const o=s[l];if(!o||0===o.length)continue;if(!r&&a){a=!1;const e=this._engine.rendering.picking;r=await e.pickWorldPosition(this._mousePosition)}const g=e[l],c=new LB(this._engine,g,null);c.target=t&&t.object,c.currentTarget=n,c.intersection=t,c.position=r,this._executeCallbacks(o,c)}}_executeCallbacks(e,t){for(const n of e){if(!n)continue;const e=t.event;if(e&&(e.defaultPrevented||e.domEvent&&e.domEvent.defaultPrevented))return;try{n.isFlowEvent?n.execute(t):n(t)}catch(i){console.error("error occurs when triggering callback",i)}}}bind(e,t,i){"string"==typeof e&&(i=t,t=e,e=this._engine.map),console.warn("bind is deprecated, use object.addEventListener instead"),e.addEventListener(t,i)}unbind(e,t,i){"string"==typeof e&&(i=t,t=e,e=this._engine.map),console.warn("unbind is deprecated, use object.removeEventListener instead"),e.removeEventListener(t,i)}markEventProxy(e,t){console.warn("markEventProxy is deprecated, no need to call this method")}createMultipleToggleEvent(e,t=0){return new zB(e,t)}dispose(){}};let PB=YB;__publicField(PB,"EVENT_NAME_CLICK","click"),__publicField(PB,"EVENT_NAME_DOUBLE_CLICK","dblclick"),__publicField(PB,"EVENT_NAME_RIGHT_CLICK","rightclick"),__publicField(PB,"EVENT_NAME_RIGHT_DOUBLE_CLICK","rightdblclick"),__publicField(PB,"EVENT_NAME_MOUSE_MOVE","mousemove"),__publicField(PB,"EVENT_NAME_MOUSE_ENTER","mouseenter"),__publicField(PB,"EVENT_NAME_MOUSE_LEAVE","mouseleave"),__publicField(PB,"EVENT_NAME_POINTER_DOWN","pointerdown"),__publicField(PB,"EVENT_NAME_POINTER_UP","pointerup");const kB=new XB,OB=[PB.EVENT_NAME_CLICK,PB.EVENT_NAME_DOUBLE_CLICK,PB.EVENT_NAME_MOUSE_MOVE,PB.EVENT_NAME_POINTER_DOWN,PB.EVENT_NAME_POINTER_UP,PB.EVENT_NAME_MOUSE_ENTER,PB.EVENT_NAME_MOUSE_LEAVE],UB=class{constructor(e){__publicField(this,"_useDepthPicking",!1),__publicField(this,"_positionCache",{}),__publicField(this,"_seaLevelPositionCache",{}),__publicField(this,"_intersectionCache",{}),__publicField(this,"pixelToNdc",(e=>{const t=this._rendering.resolution;return new bt(e.x/t.x*2-1,1-e.y/t.y*2)})),__publicField(this,"ndcToPixel",(e=>{const t=this._rendering.resolution;return new bt((e.x+1)/2*t.x,(1-e.y)/2*t.y)})),this._rendering=e}init(){}dispose(){}beginFrame(){this._positionCache={},this._seaLevelPositionCache={},this._intersectionCache={[UB.PICK_INTERSECTION_TYPE_ALL]:{},[UB.PICK_INTERSECTION_TYPE_VISIBLE]:{},[UB.PICK_INTERSECTION_TYPE_EVENT]:{}},this._rendering.features.depthPicking.enabled=this._useDepthPicking}endFrame(){}onResolutionChange(){}async pickWorldPosition(e){let t=await this.pickSceneWorldPosition(e);return t||(t=this.pickSeaLevelWorldPosition(e)),t}async pickWorldPositionFromNdc(e){const t=this.ndcToPixel(e);return await this.pickWorldPosition(t)}async pickSceneWorldPosition(e){const t=`${Math.round(e.x)}_${Math.round(e.y)}`;if(void 0!==this._positionCache[t])return this._positionCache[t];let i=await this._pickSceneWorldPosition(e);return this._positionCache[t]=i,i}async pickSceneWorldPositionFromNdc(e){const t=this.ndcToPixel(e);return await this.pickSceneWorldPosition(t)}async _pickSceneWorldPosition(e){if(this._useDepthPicking){return await this._pickSceneWorldPositionFromDepth(e)}const t=await this.pickIntersectionsOfVisibleObjects(e);let i=null;for(let s=0,o=t.length;s<o;s++)if(!(t[s].object.isPoints||t[s].object.isLine||t[s].object.collisionDisabled||!1===t[s].object.visible)){i=t[s];break}if(null===i||!i.point)return null;let n=new Qt;return n.copy(i.point),n}async _pickSceneWorldPositionFromDepth(e){const t=this._rendering,i=t.features.depthPicking,n=this.pixelToNdc(e),s=await i.pickDepth(e.x,.5*(n.y+1)*t.resolution.y);if(null===s||s>.999999)return null;const o=new Qt(n.x,n.y,2*s-1),r=t.camera;return o.unproject(r),o}pickIntersections(e){return this._pickIntersectionByRayRasting(UB.PICK_INTERSECTION_TYPE_ALL,e)}async pickIntersectionsOfVisibleObjects(e){return this._pickIntersectionByRayRasting(UB.PICK_INTERSECTION_TYPE_VISIBLE,e,null)}async pickIntersectionsOfEventObjects(e,t=OB){return this._pickIntersectionByRayRasting(UB.PICK_INTERSECTION_TYPE_EVENT,e,t)}async _pickIntersectionByRayRasting(e,t,i=OB){const n=`${Math.round(t.x)}_${Math.round(t.y)}`,s=this._intersectionCache[e];if(void 0!==s[n])return s[n];const o=this._rendering.camera,r=this.pixelToNdc(t);kB.setFromCamera(r,o),kB.mouse.copy(r);let a=null;if(e===UB.PICK_INTERSECTION_TYPE_ALL)a=kB.intersectObjects(this._rendering.objectsScene.children,!0);else if(e===UB.PICK_INTERSECTION_TYPE_VISIBLE){const e=XB.CHECK_VISIBLE;a=kB.intersectFlagObjects(this._rendering.objectsScene.children,e,null,!0)}else if(e===UB.PICK_INTERSECTION_TYPE_EVENT){const e=XB.CHECK_EVENT|XB.CHECK_VISIBLE;a=kB.intersectFlagObjects(this._rendering.objectsScene.children,e,i,!0)}return s[n]=a,a}pickTerrainWorldPosition(e){const t=this._pickIntersectionsWithCheckCallback(e,((e,t)=>e.isMesh&&e.isTerrainTile));return t.length>0?t[0].point:null}_pickIntersectionsWithCheckCallback(e,t){kB.set(e.origin,e.direction);return kB.intersectFlagObjects(this._rendering.objectsScene.children,0,null,!0,t)}pickSeaLevelWorldPositionFromNdc(e){const t=this.ndcToPixel(e);return this.pickSeaLevelWorldPosition(t)}pickSeaLevelWorldPosition(e){const t=`${Math.round(e.x)}_${Math.round(e.y)}`;if(void 0!==this._seaLevelPositionCache[t])return this._seaLevelPositionCache[t];let i=this._rendering._engine.map.pickSeaLevelWorldPosition(e);return this._seaLevelPositionCache[t]=i,i}get useDepthPicking(){return this._useDepthPicking}set useDepthPicking(e){this._useDepthPicking=e}};let QB=UB;function JB(e,t,i=1e-10){i=lm(i,0);const n=e.elements,s=t.elements;return n===s||am(n)&&am(s)&&Math.abs(n[0]-s[0])<=i&&Math.abs(n[1]-s[1])<=i&&Math.abs(n[2]-s[2])<=i&&Math.abs(n[3]-s[3])<=i&&Math.abs(n[4]-s[4])<=i&&Math.abs(n[5]-s[5])<=i&&Math.abs(n[6]-s[6])<=i&&Math.abs(n[7]-s[7])<=i&&Math.abs(n[8]-s[8])<=i&&Math.abs(n[9]-s[9])<=i&&Math.abs(n[10]-s[10])<=i&&Math.abs(n[11]-s[11])<=i&&Math.abs(n[12]-s[12])<=i&&Math.abs(n[13]-s[13])<=i&&Math.abs(n[14]-s[14])<=i&&Math.abs(n[15]-s[15])<=i}__publicField(QB,"PICK_INTERSECTION_TYPE_ALL",1),__publicField(QB,"PICK_INTERSECTION_TYPE_VISIBLE",2),__publicField(QB,"PICK_INTERSECTION_TYPE_EVENT",3);class jB{constructor(e){__publicField(this,"_stage",null),__publicField(this,"_time",0),__publicField(this,"_startTime",0),__publicField(this,"_elapsedTime",0),__publicField(this,"_viewChanged",!1),__publicField(this,"_viewMatrixWorld",new Bi),__publicField(this,"_viewMatrixWorldInverse",new Bi),__publicField(this,"_projectionMatrix",new Bi),__publicField(this,"_cameraMatrix",new Bi),__publicField(this,"_cameraMatrixInverse",new Bi),__publicField(this,"_cameraOffsetX",0),__publicField(this,"_cameraOffsetY",0),__publicField(this,"_cameraOffset",new Qt),__publicField(this,"_frameCount",0),__publicField(this,"_viewStableFrameCount",0),__publicField(this,"_isRendererRecreated",!1),__publicField(this,"_cameraLocation",new Qt),this._rendering=e,this._startTime=(new Date).getTime(),this._time=this._startTime}beginFrame(e,t){this._deltaTime=t-this._time,this._deltaSeconds=this._deltaTime/1e3,this._time=t,this._elapsedTime=t-this._startTime;const i=e.renderer.info.render.frame;i<this._frameCount&&(this._isRendererRecreated=!0),this._frameCount=i;const n=e.camera,s=n.matrixWorld,o=n.projectionMatrix;JB(s,this._viewMatrixWorld,1e-8)&&JB(o,this._projectionMatrix,1e-8)?(this._viewChanged=!1,this._viewStableFrameCount++):(this._viewChanged=!0,this._viewStableFrameCount=0,e.requestRender()),this._viewMatrixWorld.copy(n.matrixWorld),this._viewMatrixWorldInverse.copy(n.matrixWorldInverse),this._projectionMatrix.copy(n.projectionMatrix)}endFrame(){this._isRendererRecreated=!1}updateCameraOffsetState(e,t,i,n){this._cameraMatrix.copy(e.matrixWorld),this._cameraMatrixInverse.copy(e.matrixWorldInverse),this._cameraOffsetX=t,this._cameraOffsetY=i,this._cameraOffset.set(t,i,n)}getDepthByDistance(e){const t=this._rendering.camera,i=t.far,n=t.near;return t.isPerspectiveCamera?this._rendering.renderer.capabilities.logarithmicDepthBuffer?Math.log(e+1)/Math.log(i+1):i*(e-n)/(e*(i-n)):(i-e)/(i-n)}get time(){return this._time}get viewChanged(){return this._viewChanged}get viewMatrixWorld(){return this._viewMatrixWorld}get viewMatrixWorldInverse(){return this._viewMatrixWorldInverse}get projectionMatrix(){return this._projectionMatrix}get cameraMatrix(){return this._cameraMatrix}get cameraMatrixInverse(){return this._cameraMatrixInverse}get cameraOffsetX(){return this._cameraOffsetX}get cameraOffsetY(){return this._cameraOffsetY}get deltaTime(){return this._deltaTime}get elapsedTime(){return this._elapsedTime}get deltaSeconds(){return this._deltaSeconds}get frameCount(){return this._frameCount}get viewStableFrameCount(){return this._viewStableFrameCount}get cameraOffset(){return this._cameraOffset}get isRendererRecreated(){return this._isRendererRecreated}set stage(e){this._stage=e}get stage(){return this._stage}}class qB{constructor(e,t=0){this.taskFunc=e,this.priority=t,this._isCancelled=!1,this._isStart=!1}execute(){this._isStart=!0,this.isCancelled()||this.taskFunc().catch((e=>console.error("Task failed:",e)))}cancel(){this._isCancelled=!0}isCancelled(){return this._isCancelled}isStart(){return this._isStart}}class $B{constructor(e){__publicField(this,"_frameDurationList",[]),__publicField(this,"_maxTaskCount",1e3),__publicField(this,"_taskQueue",[]),this._rendering=e}beginFrame(){if(this._frameStartTime=performance.now(),this._lastFrameStartTime){const e=this._frameStartTime-this._lastFrameStartTime;this._frameDurationList.push(e),this._frameDurationList.length>5&&this._frameDurationList.shift()}this._lastFrameStartTime=this._frameStartTime}endFrame(){if(this._frameDurationList.length<5)return;const e=performance.now(),t=e-this._frameStartTime,i=this._frameDurationList.reduce(((e,t)=>e+t),0)/this._frameDurationList.length;let n=Math.min(16,i)-t;const s=this._taskQueue;for(;s.length>0;){const{task:t}=this._taskQueue.shift();t.execute();if(performance.now()-e>=n&&s.length<=this._maxTaskCount)break}}addTask(e,t=0){const i=new qB(e,t);return this._taskQueue.push({task:i,priority:t}),this._taskQueue.sort(((e,t)=>t.priority-e.priority)),i}get maxTaskCount(){return this._maxTaskCount}set maxTaskCount(e){this._maxTaskCount=e}get taskCount(){return this._taskQueue.length}}const ew={};function tw(e){e in ew||(ew[e]=!0,console.warn(e))}const iw={};const nw=new Bi,sw=new mi,ow=new ys,rw=(e,t)=>e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.material.name!==t.material.name?e.material.name>t.material.name?1:-1:e.material.type!==t.material.type?e.material.type-t.material.type:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id,aw=(e,t)=>e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id,lw=[4886754,5289385,7184241,12888157,14191694,12017001,10189749];let gw=1;class cw{constructor(e,t={}){__publicField(this,"_engine"),__publicField(this,"_outputEncoding"),__publicField(this,"_enableAnimationLoop"),__publicField(this,"_animationLoopFrameTime"),__publicField(this,"_uniforms"),__publicField(this,"_main"),__publicField(this,"_bloom"),__publicField(this,"_ssr"),__publicField(this,"_composition"),__publicField(this,"_label"),__publicField(this,"_renderState"),__publicField(this,"_camera"),__publicField(this,"_canvas"),__publicField(this,"_context"),__publicField(this,"_renderer"),__publicField(this,"_scene"),__publicField(this,"_weather"),__publicField(this,"_useMRT",!1),__publicField(this,"_isUseMRTChanged",!1),__publicField(this,"_freezeUpdate",!1),__publicField(this,"_isRunning",!1),__publicField(this,"_needsRenderImmediately",!1),__publicField(this,"_needsRenderNext",!1),__publicField(this,"_beforeRenderListeners",[]),__publicField(this,"_prepareRenderListeners",[]),__publicField(this,"_startTime",0),__publicField(this,"_pixelRatio",window.devicePixelRatio),__publicField(this,"_resolution"),__publicField(this,"_sky",null),__publicField(this,"_debugShaderType",0),__publicField(this,"_beforeScenePrepareRenderObjects",new Set),__publicField(this,"_beforeSceneRenderObjects",new Set),__publicField(this,"_onRenderModeChangedObjects",new Set),__publicField(this,"_useClip"),__publicField(this,"_wireframe",!0),__publicField(this,"_debugMaterial",null),__publicField(this,"_debugMode",0),__publicField(this,"_autoOffsetRelativeCenter",!0),__publicField(this,"_clampCameraNearFar",!1),__publicField(this,"_options",{}),__publicField(this,"lastRenderTime",0),__publicField(this,"_contextParameters",{alpha:!0,stencil:!0,antialias:!1,powerPreference:"high-performance",preserveDrawingBuffer:!1,premultipliedAlpha:!1}),__publicField(this,"_needsReCreateRenderer",!1),__publicField(this,"_frameDuration",100),__publicField(this,"_useHighPrecisionBuffer",!1),__publicField(this,"handleShaderBeforeResolve",((e,t,i)=>{if(this._useMRT){const e=this._renderer.getRenderTarget();e&&e.isWebGLMultipleRenderTargets&&(t=this.convertMrtSupportedFragment(t))}else t=this.convertNMrtSupportedFragment(t,i.shaderID);return"basic"===i.shaderID&&(t="#define BASIC\nuniform vec3 emissive;\n"+t),{vertexShader:e=(e=>{const t="void main()",i=(e=e.replace(t,"#include <mvt_clip_pars_vertex>\n"+t)).indexOf(t),n=i+11+e.slice(i+11).indexOf("{")+1;return e.slice(0,n)+"\n    #include <mvt_clip_vertex>\n"+e.slice(n)})(e),fragmentShader:t=(e=>{const t="void main()",i=(e=e.replace(t,"#include <mvt_clip_pars_fragment>\n"+t)).indexOf(t),n=i+11+e.slice(i+11).indexOf("{")+1;return e.slice(0,n)+"\n    #include <mvt_clip_fragment>\n"+e.slice(n)})(t)}})),__publicField(this,"handleShaderBeforeCompile",((e,t,i)=>{if(e=Yp(e,"\nattribute float _tileEditableValue;\n",null,"\nif (_tileEditableValue == 1.0) {\n    gl_Position = vec4(-1.0, -1.0, -1.0, -1.0);\n}\n"),this._useMRT){const n=this._renderer.getRenderTarget();if(n&&n.isWebGLMultipleRenderTargets){i.isRawShaderMaterial&&i.glslVersion!==tt&&(e=["#version 300 es","precision mediump sampler2DArray;","#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+e,t=["#version 300 es","#define varying in","layout(location = 0) out highp vec4 pc_fragColor;","#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+t)}}return{vertexShader:e,fragmentShader:t}})),__publicField(this,"handleMaterialBeforeCompile",((e,t)=>{e.handleMaterialBeforeCompile&&e.handleMaterialBeforeCompile(this._engine,this),this.shadow.enabled&&"csm"===this.shadow.method&&this.shadow.updateCSMShadow(e,t)})),__publicField(this,"convertMrtSupportedFragment",(e=>this._main.sceneRendering.modifyFragmentShader(e))),__publicField(this,"convertNMrtSupportedFragment",((e,t)=>(e=>{let t=e;t=t.replace("void main() {","#include <mvt_nmrt_output_pars_fragment>\nvoid main() {");const i=t.lastIndexOf("}");return t=t.substring(0,i),t+="#include <mvt_nmrt_output_fragment>\n}",t})(e))),__publicField(this,"render",(()=>{if(!this._isRunning)return;this._beginFrame(),this._useXR||requestAnimationFrame(this.render);const e=(new Date).valueOf();if((this._needsRenderNext||this._enableAnimationLoop)&&this._animationLoopFrameTime<17&&(this._needsRenderImmediately=!0),!(this._needsRenderImmediately||(this._needsRenderNext||this._enableAnimationLoop)&&e-this.lastRenderTime>=this._animationLoopFrameTime))return void this._endFrame();let t=this._needsRenderImmediately?0:e-this.lastRenderTime-this._animationLoopFrameTime;t>this._animationLoopFrameTime-16&&(t=this._animationLoopFrameTime-16),this.lastRenderTime=e-t,this._needsRenderImmediately=!1,this._needsRenderNext=!1;const i=this._stats;i.beginTimeStatsItem("renderAll");try{this.renderScene(e)}catch(pb){console.error("renderScene error",pb)}finally{i.endTimeStatsItem("renderAll"),this._endFrame()}})),__publicField(this,"scaleZAtCurrentPosition",(()=>{const e=this._engine.map,t=e.getScaleAt(e.getCenter());this.scene.scale.z=t})),__publicField(this,"showCurrentViewFrustum",(()=>{this._currentViewCamera?this._currentViewCamera.copy(this._camera):this._currentViewCamera=this._camera.clone();const e=this._currentViewCameraHelper=new Gg(this._currentViewCamera);e.matrixAutoUpdate=!1,this.add(e)})),__publicField(this,"removeCurrentViewFrustum",(()=>{this._currentViewCameraHelper&&(this.remove(this._currentViewCameraHelper),this._currentViewCameraHelper=null,this._currentViewCamera=null)})),this._engine=e;const i=this._options=this.getInitialConfig(t);Object.assign(this._contextParameters,i.contextParameters),i.preserveDrawingBuffer&&(this._contextParameters.preserveDrawingBuffer=!0);const n=i.features.antialias;this._contextParameters.antialias=n.enabled&&"msaa"===n.method,this._enableAnimationLoop=i.enableAnimationLoop||!1,this._animationLoopFrameTime=i.animationLoopFrameTime||16,this._useMRT=i.useMRT||!1,this._useXR=i.useXR||!1,this._pixelRatio=i.pixelRatio||window.devicePixelRatio,this._resolution=t.resolution,this._uniforms={time:{value:0},elapsedTime:{value:0},pixelRatio:{value:this._pixelRatio},zoomUnits:{value:1},resolution:{value:new bt(i.resolution.x,i.resolution.y)}},Object.freeze(this._uniforms),this._stats=new WB(this),this._main=new d_(this,i),this._picking=new QB(this),this._label=new oB(this),this._collision=new MB(this),this._animation=new RB(this),this._xr=new ZB(this),this._renderState=new jB(this),this._taskScheduler=new $B(this)}getInitialConfig(e){return gm({useMRT:!1,enableAnimationLoop:!1,animationLoopFrameTime:16,useXR:!1,pixelRatio:window.devicePixelRatio,features:{antialias:{enabled:!0,method:"smaa"},bloom:{enabled:!1,strength:.1,threshold:1,radius:0},ao:{enabled:!1,method:"ssao"},reflection:{enabled:!1,method:"ssr"},shadow:{enabled:!1,method:"default"},depthPicking:{enabled:!1},colorAdjustment:{enabled:!1},hdr:{enabled:!1}}},e)}init(){const e=this._resolution;this._options.isOrthographicCamera?this._camera=new Es(-e.x/2,e.x/2,e.y/2,-e.y/2,.1,1e6):this._camera=new cs(35,e.x/e.y,1,100),this._camera.matrixAutoUpdate=!1;const t=this._scene=new ra,i=this.uiScene=new qr,n=this.objectsScene=new qr,s=this.environmentScene=new qr;n.add(i),t.add(n),t.add(s),t.matrixWorldAutoUpdate=!1,this._createRenderer(),this._uniforms.resolution.value[0]=e.x,this._uniforms.resolution.value[1]=e.y,this._picking.init(),this._xr.init();let o=this._options.sky;void 0===o&&(o=new hb),o&&this.add(o)}_createRenderer(){const e=this._resolution,n=this._engine;let s=!!this._renderer,o=1;s&&(o=this._renderer.envMapIntensity,n.map.releaseCanvas(),this._renderer.forceContextLoss(),this._renderer.dispose());const r=this._canvas=document.createElement("canvas");i(r,`${t}-canvas`),r.style.position="absolute",r.style.top="0",r.style.left="0",r.style.zIndex="2";const a=this._context=r.getContext("webgl2",this._contextParameters),l=this._renderer=new oa({canvas:r,context:a,logarithmicDepthBuffer:!0});l.setClearColor(16777215,0),l.setPixelRatio(this._pixelRatio),l.setSize(e.x,e.y),l.setOpaqueSort(rw),l.setTransparentSort(aw),l.info.autoReset=!1,this._renderer.extraProgramCacheKey="0",this._renderer.envMapIntensity=o,l.onShaderBeforeResolve=this.handleShaderBeforeResolve,l.onShaderBeforeCompile=this.handleShaderBeforeCompile,l.onMaterialBeforeCompile=this.handleMaterialBeforeCompile,s&&(n.map._map.canvas=r,n.map.bindCanvas())}addBeforeRenderListener(e){-1===this._beforeRenderListeners.indexOf(e)&&this._beforeRenderListeners.push(e)}removeBeforeRenderListener(e){const t=this._beforeRenderListeners.indexOf(e);t>-1&&this._beforeRenderListeners.splice(t,1)}addPrepareRenderListener(e){-1===this._prepareRenderListeners.indexOf(e)&&this._prepareRenderListeners.push(e)}removePrepareRenderListener(e){const t=this._prepareRenderListeners.indexOf(e);t>-1&&this._prepareRenderListeners.splice(t,1)}add(e){return e.traverse((e=>{e.afterAddToEngine&&!e.__initInEngine&&(e.__initInEngine=!0,e.afterAddToEngine(this._engine)),e instanceof _m?this.sky=e:e instanceof Sb&&(this.weather=e),this.addBeforePrepareRenderObject(e),this.addBeforeRenderObject(e),this.addOnRenderModeChangeObject(e)})),e.__isEnvironment?this.environmentScene.add(e):e.isRenderInPostprocess?this.uiScene.add(e):this.objectsScene.add(e),this._needsRenderImmediately=!0,e.userData.__debugObjectId||(e.userData.__debugObjectId=gw++),e}remove(e){e&&(e.traverse((e=>{e.beforeRemoveFromEngine&&(e.__initInEngine=void 0,e.beforeRemoveFromEngine(this._engine)),e instanceof _m?this._sky=null:e instanceof Sb&&(this._weather=null),this.removeBeforeRenderObject(e),this.removeBeforePrepareRenderObject(e),this.removeOnRenderModeChangeObject(e)})),e.__isEnvironment?this.environmentScene.remove(e):e.isRenderInPostprocess?this.uiScene.remove(e):this.objectsScene.remove(e),this._needsRenderImmediately=!0)}addBeforePrepareRenderObject(e){e.onBeforeScenePrepareRender&&this._beforeScenePrepareRenderObjects.add(e)}removeBeforePrepareRenderObject(e){this._beforeScenePrepareRenderObjects.delete(e)}addBeforeRenderObject(e){e.onBeforeSceneRender&&this._beforeSceneRenderObjects.add(e)}removeBeforeRenderObject(e){this._beforeSceneRenderObjects.delete(e)}addOnRenderModeChangeObject(e){e.onRenderModeChanged&&this._onRenderModeChangedObjects.add(e)}removeOnRenderModeChangeObject(e){e.onRenderModeChanged&&this._onRenderModeChangedObjects.delete(e)}startRenderLoop(){this._isRunning=!0,this._needsRenderImmediately=!0,this._startTime=(new Date).valueOf(),this.render()}stopRenderLoop(){this._isRunning=!1}updateCamera(){this._engine.map.updateCamera()}requestRender(){this._needsRenderImmediately=!0}renderScene(e){const t=this._engine,i=t.event,n=this._stats;e||(e=(new Date).valueOf()),this._uniforms.time.value=e,this._uniforms.elapsedTime.value=e-this._startTime,this._uniforms.zoomUnits.value=this._engine.map.getZoomUnits(),this.camera._isLocked||this.updateCamera();const s=this._camera,o=this._scene,r=this._renderer;this.environmentScene.visible=!1;const a=this._renderState;i.beginFrame(),a.beginFrame(this,e),this._picking.beginFrame(),this._main.beginFrame(),this._needsReCreateRenderer&&(this._needsReCreateRenderer=!1,this._createRenderer());a._viewChanged&&s.dispatchEvent({type:"viewchanged"}),n.beginTimeStatsItem("updateAnimation"),this._animation.update(a),n.endTimeStatsItem("updateAnimation");for(let m of this._prepareRenderListeners)m(this._engine,a);this._beforeScenePrepareRenderObjects.forEach((e=>{e.onBeforeScenePrepareRender(t,o,s,a)}));const l=s.position.clone();let g=0,c=0,d=0;const h=1e3,u=Math.floor(l.x/h)*h,I=Math.floor(l.y/h)*h,p=Math.floor(l.z/h)*h;if(g=l.x-u,c=l.y-I,d=l.z-p,this._autoOffsetRelativeCenter){if(r.xr.isPresenting){this._xr.xrCamera.position.set(u+g,I+c,p+d)}s.position.set(g,c,d),s.updateMatrix(),s.updateMatrixWorld(),o.position.set(-u,-I,-p),a.updateCameraOffsetState(s,u,I,p)}else{if(r.xr.isPresenting){this._xr.xrCamera.position.copy(l)}a.updateCameraOffsetState(s,0,0,0)}o.updateMatrix(),o.updateMatrixWorld(),this._clampCameraNearFar&&this._computeCameraNearFar(),r.info.reset(),n.beginTimeStatsItem("updateCollision"),this._collision.update(a),n.endTimeStatsItem("updateCollision"),this._beforeSceneRenderObjects.forEach((e=>{e.onBeforeSceneRender(t,o,s,a)}));for(let m of this._beforeRenderListeners)m(this._engine,a);if(n.beginTimeStatsItem("updateNodeMaterials"),Kp.update(),n.endTimeStatsItem("updateNodeMaterials"),n.beginTimeStatsItem("renderMain"),this._main.render(),n.endTimeStatsItem("renderMain"),this._autoOffsetRelativeCenter){if(r.xr.isPresenting){this._xr.xrCamera.position.copy(l)}s.position.copy(l),s.updateMatrix(),s.updateMatrixWorld(),o.position.set(0,0,0),o.updateMatrix(),o.updateMatrixWorld()}this._main.endFrame(),this._picking.endFrame(),a.endFrame(this),i.endFrame(),this._useMRTChanged=!1}_computeCameraNearFar(){const e=this._camera,t=this._scene;nw.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),ow.setFromProjectionMatrix(nw);const i=new bt(1/0,0);this._computeObjectNearFar(t,e,ow,i,[null,null]),i.x<.1&&(i.x=.1),e.near=i.x,e.far=i.y,e.updateProjectionMatrix()}_computeObjectNearFar(e,t,i,n,s){if(!1===e.visible)return;if(e.layers.test(t.layers)&&(e.isMesh||e.isLine||e.isPoints||e.isSprite)){if(e.isFSQuad)return;if(!e.frustumCulled||i.intersectsObject(e)){const i=e.geometry;if(i.boundingSphere||i.computeBoundingSphere(),!i.boundingSphere)return;if(sw.copy(i.boundingSphere),sw.applyMatrix4(e.matrixWorld),sw.radius>0){const i=sw.center.distanceTo(t.position),o=i-sw.radius,r=i+sw.radius;n.x>o&&(n.x=o,s[0]=e),n.y<r&&(n.y=r,s[1]=e)}}}const o=e.children;if(o)for(let r=0,a=o.length;r<a;r++)this._computeObjectNearFar(o[r],t,i,n,s)}_beginFrame(){this._taskScheduler.beginFrame()}_endFrame(){this._taskScheduler.endFrame()}updateContextParameters(e){const t=this._contextParameters;for(const i of Object.keys(e))t[i]!==e[i]&&(t[i]=e[i],this._needsReCreateRenderer=!0)}setResolution(e){this._resolution.copy(e),this._uniforms.resolution.value.copy(e),this._renderer.setSize(e.x,e.y),this._main.setSize(e.x,e.y),this._picking.onResolutionChange(),this._needsRenderNext=!0}dispose(){this.stopRenderLoop(),this._debugMaterial&&this._debugMaterial.dispose();const e=Array.from(this.objectsScene.children),t=Array.from(this.environmentScene.children);for(let n=e.length-1;n>=0;n--){const t=e[n];this.remove(t),t.dispose&&t.dispose()}for(let n=t.length-1;n>=0;n--){const e=t[n];this.remove(e),e.dispose&&e.dispose()}this._picking.dispose(),this._renderer.dispose();let i=this._context.getExtension("WEBGL_lose_context");i&&i.loseContext()}get engine(){return this._engine}get contextParameters(){return this._contextParameters}get sky(){return this._sky}set sky(e){this._sky&&console.warn("you are trying to set sky, but it has already been set.Please use `engine.remove(oldSky)` before setting a new sky."),this._sky=e}get weather(){return this._weather}set weather(e){this._weather&&console.warn("you are trying to set weather, but it has already been set.Please use `engine.remove(oldWeather)` before setting a new weather."),this._weather=e}get debugShaderType(){return this._debugShaderType}set debugShaderType(e){if(this._debugShaderType=e,!this._useMRT)return;e=parseInt(e,10);const t=this._composition;if(e&&0!==e)if(1===e)t.debugTextures=this._main.getTextures();else if(2===e){const e=[];this.objectsScene.traverse((t=>{t.isLight&&t.shadow&&t.shadow.map&&e.push(t.shadow.map.texture)})),t.debugTextures=e}else 3===e?t.debugTextures=this._bloom.getTextures():4===e?t.debugTextures=this._ssr.getTextures():5===e&&this._sky&&this._sky.getTextures&&(t.debugTextures=this._sky.getTextures());else t.debugTextures=null}get isUseMRTChanged(){return this._useMRTChanged}get useMrt(){return this.useMRT}set useMrt(e){this.useMRT=e}get useMRT(){return this._useMRT}set useMRT(e){this._useMRT!==e&&(this._useMRT=e,this._useMRTChanged=!0)}get main(){return this._main}get shadow(){return this._main.features.shadow}get bloom(){return this._main.features.bloom}get ssr(){return tw("deprecated, ssr has been removed"),{}}get composition(){return tw("deprecated, composition has been removed"),{}}get fog(){return tw("deprecated, fog has been removed"),{}}get postprocessing(){return tw("deprecated, postprocessing has been removed"),{}}get label(){return this._label}get colorAdjustment(){return this._main.features.colorAdjustment}get renderState(){return this._renderState}get pick(){return tw("`rendering.pick` is deprecated, use `.picking` instead"),this._picking}get picking(){return this._picking}get stats(){return this._stats}get collision(){return this._collision}get animation(){return this._animation}get xr(){return this._xr}get taskScheduler(){return this._taskScheduler}get enableAnimationLoop(){return this._enableAnimationLoop}set enableAnimationLoop(e){this._enableAnimationLoop=e}get animationLoopFrameTime(){return this._animationLoopFrameTime}set animationLoopFrameTime(e){this._animationLoopFrameTime=e}get resolution(){return this._resolution}set resolution(e){this._resolution=e}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio=e}get outputEncoding(){return this._outputEncoding}set outputEncoding(e){this._outputEncoding=e}get canvas(){return this._canvas}get renderer(){return this._renderer}get camera(){return this._camera}get scene(){return this._scene}get uniforms(){return this._uniforms}set wireframe(e){this._wireframe=e,this._debugMaterial&&(this._debugMaterial.wireframe=e)}get wireframe(){return this._wireframe}set debugMode(e){(e=parseInt(e,10))!==this._debugMode&&(this._debugMode=e,0!==e?(this._debugMaterial||(this._debugMaterial=new ls({uniforms:{color:{value:new In(35071)}},vertexShader:"\n    #include <common>\n    #include <logdepthbuf_pars_vertex>\n    void main() {\n        #include <begin_vertex>\n        #include <project_vertex>\n        #include <logdepthbuf_vertex>\n    }\n",fragmentShader:"\n    #include <common>\n    #include <logdepthbuf_pars_fragment>\n    uniform vec3 color;\n    void main() {\n        gl_FragColor = vec4( color, 1.0 );\n        #include <logdepthbuf_fragment>\n    }\n",wireframe:this._wireframe}),this._debugMaterial.onBeforeRender=(e,t,i,n,s,o)=>{let r=0;const a=this._debugMode;if(1===a)r=s.id;else if(2===a)r=s.material.id;else if(3===a){let e=s;do{if(e.userData.__debugObjectId){r=e.userData.__debugObjectId;break}}while(e.parent&&(e=e.parent))}let l=null;l=r?lw[r%lw.length]:13750737,this._debugMaterial.uniforms.color.value.set(l),this._debugMaterial.uniformsNeedUpdate=!0}),this._scene.overrideMaterial=this._debugMaterial):(this._scene.overrideMaterial=null,this._debugMaterial.dispose(),this._debugMaterial=null))}get debugMode(){return this._debugMode}get autoOffsetRelativeCenter(){return this._autoOffsetRelativeCenter}set autoOffsetRelativeCenter(e){this._autoOffsetRelativeCenter=e}get freezeUpdate(){return this._freezeUpdate}set freezeUpdate(e){!!e!==this._freezeUpdate&&(this._freezeUpdate=!!e,e?this.stopRenderLoop():this.startRenderLoop())}get useHighPrecisionBuffer(){return this._useHighPrecisionBuffer}set useHighPrecisionBuffer(e){this._useHighPrecisionBuffer=e}get clampCameraNearFar(){return this._clampCameraNearFar}set clampCameraNearFar(e){this._clampCameraNearFar=e}}const dw=new yg,hw=new Cs(new Qt(0,0,1),0),uw=new Qt,Iw=new Qt;class pw{constructor(e,t){this._engine=e,this._options=t}init(){}parsePointToArr(e){if(!e)return null;let t=[];if(Array.isArray(e))for(let i of e)t.push(parseFloat(i));else if("string"==typeof e){const i=e.split(",");for(let e=0;e<i.length;e++)t[e]=parseFloat(i[e])}else"object"==typeof e&&e.isVector3&&(t=[e.x,e.y,e.z]);return t}projectArrayCoordinate(e,t){return uw.set(e[0],e[1],e[2]||0),this.projection.projectCoordinate(uw,Iw),t||(t=[0,0,0]),t[0]=Iw.x,t[1]=Iw.y,t[2]=Iw.z,t}unprojectArrayCoordinate(e,t){return uw.set(e[0],e[1],e[2]||0),this.projection.unprojectCoordinate(uw,Iw),t||(t=[0,0,0]),t[0]=Iw.x,t[1]=Iw.y,t[2]=Iw.z,t}getViewHeight(){return this.camera.position.z}bindCanvas(){console.warn("bindCanvas must be implemented in subclass")}releaseCanvas(){console.warn("releaseCanvas must be implemented in subclass")}pickSeaLevelWorldPosition(e){const t=this._engine.camera,i=this._engine.rendering.picking.pixelToNdc(e);dw.setFromCamera(i,t);const n=new Qt;return dw.ray.intersectPlane(hw,n),n}dispose(){}}const mw=!!window.PointerEvent,Aw=/ipod|ipad|iphone|android/.test(navigator.userAgent.toLowerCase()),Cw=e=>e&&"touch"===e.pointerType,fw=(()=>{let e;return e=mw?{DOWN:"pointerdown",MOVE:"pointermove",UP:"pointerup",CANCEL:"pointercancel"}:Aw?{DOWN:"touchstart",MOVE:"touchmove",UP:"touchend",CANCEL:"touchcancel"}:{DOWN:"mousedown",MOVE:"mousemove",UP:"mouseup",CANCEL:"mousecancel"},e})(),bw=0,yw=1,_w=2,vw=new bt,xw=new yg,Bw=new Cs(new Qt(0,0,1),0);new Qt;const ww=new Qt,Sw=new Qt,Gw=new Qt,Mw=new cs;Mw.fov=35,new bt;class Rw{constructor(e){__publicField(this,"map"),__publicField(this,"currentAction"),__publicField(this,"startX"),__publicField(this,"startY"),__publicField(this,"startCenterX"),__publicField(this,"startCenterY"),__publicField(this,"startPitch"),__publicField(this,"startHeading"),__publicField(this,"startZoom"),__publicField(this,"startZoomUnits"),__publicField(this,"startAtTop"),__publicField(this,"mapWidth"),__publicField(this,"mapHeight"),__publicField(this,"startCamera",new cs),__publicField(this,"startCenter",new Qt),__publicField(this,"startNdc",new bt),__publicField(this,"startPoint",new Qt),__publicField(this,"startScaleX",1),__publicField(this,"startScaleY",1),__publicField(this,"startBoundX"),__publicField(this,"startBoundY"),__publicField(this,"_enabled",!1),__publicField(this,"minPitch",0),__publicField(this,"maxPitch",89),__publicField(this,"zoomSpeed",.005),__publicField(this,"headingSpeed",.4),__publicField(this,"pitchSpeed",.3),__publicField(this,"doubleClickTimer",null),__publicField(this,"clickInterval",200),__publicField(this,"init",(()=>{const e=this.map.domContainer;e.addEventListener(fw.DOWN,this.handleMouseDown),e.addEventListener("wheel",this.handleWheel),e.addEventListener("contextmenu",this.handleContextMenu),e.addEventListener(fw.MOVE,this.handleMouseMove)})),__publicField(this,"handleResize",(e=>{const[t,i]=this.map.getContainerSize();this.mapWidth=t,this.mapHeight=i;const n=this.map.domContainer.getBoundingClientRect();this.startBoundX=n.left,this.startBoundY=n.top,this.startScaleX=n.width/t,this.startScaleY=n.height/i})),__publicField(this,"handleMouseMove",(e=>{this.currentAction===bw&&this.onEventMouseMove&&this.onEventMouseMove(e)})),__publicField(this,"handleMouseDown",(e=>{let t=this.mapHeight,i=this.mapWidth;const n=this.map.domContainer.getBoundingClientRect();this.startBoundX=n.left,this.startBoundY=n.top,this.startScaleX=n.width/i,this.startScaleY=n.height/t;const s=(e.clientX-this.startBoundX)/this.startScaleX,o=(e.clientY-this.startBoundY)/this.startScaleY;if(0===e.button?(this.startZoomUnits=this.map.getZoomUnitsByZoom(this.map.zoom),this.setPanStartState(s,o),this.currentAction=yw):2===e.button?this.currentAction=_w:this.currentAction=bw,this.currentAction===bw)return;e&&this.onEventPointerDown&&(this.hasMoved||this.onEventPointerDown(e)),this.startX=s,this.startY=o;const r=this.map;this.startCenterX=r.center[0],this.startCenterY=r.center[1],this.startPitch=r.pitch,this.startHeading=r.heading,this.startZoom=r.zoom,this.startAtTop=o<t/2,document.addEventListener(fw.MOVE,this.handleMouseDragging),document.addEventListener(fw.UP,this.handleMouseUp)})),__publicField(this,"handleMouseDragging",(e=>{if(this.currentAction===bw)return;this.hasMoved=!0;const t=this.currentPixelX=(e.clientX-this.startBoundX)/this.startScaleX,i=this.currentPixelY=(e.clientY-this.startBoundY)/this.startScaleY;this.currentAction===yw?this.handlePan(t,i):this.currentAction===_w&&this.handleRotate(t,i)})),__publicField(this,"handleMouseUp",(e=>{this.currentAction=bw,document.removeEventListener(fw.MOVE,this.handleMouseDragging),document.removeEventListener(fw.UP,this.handleMouseUp),e&&this.onEventPointerUp&&this.onEventPointerUp(e),e&&this.onEventClick&&(this.hasMoved||this.onEventClick(e)),e&&this.onEventDblClick&&(!this.hasMoved&&this.waitSecondClick?(this.onEventDblClick(e),this.clearDoubleClickTimer()):this.waitSecondClick=!0),clearTimeout(this.doubleClickTimer),this.doubleClickTimer=setTimeout((()=>{this.clearDoubleClickTimer()}),this.clickInterval),this.hasMoved=!1})),__publicField(this,"clearDoubleClickTimer",(()=>{this.doubleClickTimer&&clearTimeout(this.doubleClickTimer),this.waitSecondClick=!1,this.doubleClickTimer=null})),__publicField(this,"handleContextMenu",(e=>{e.preventDefault()})),__publicField(this,"handleWheel",(e=>{e.preventDefault(),e.stopPropagation();const t=(e.clientX-this.startBoundX)/this.startScaleX,i=(e.clientY-this.startBoundY)/this.startScaleY;this.handleZoom({deltaX:e.deltaX,deltaY:e.deltaY,pixelX:t,pixelY:i})})),__publicField(this,"handlePan",((e,t)=>{const i=this.map;this.getNdc(e,t,vw),this.ndcToPoint(vw,this.startCamera,Gw),Gw.distanceTo(this.startCamera.position)>6e3*i.zoomUnits?this.handleMouseUp():(ww.subVectors(this.startCenter,Gw.sub(this.startPoint)),i.center=[ww.x,ww.y],i.updateView())})),__publicField(this,"setPanStartState",((e,t)=>{const i=this.map;this.startCamera.copy(i.camera),this.startCamera.updateMatrixWorld(),this.startCenter.set(i.center[0],i.center[1],0),this.getNdc(e,t,this.startNdc),this.ndcToPoint(this.startNdc,i.camera,this.startPoint)})),__publicField(this,"handleRotate",((e,t)=>{const i=this.map;let n=e-this.startX;const s=t-this.startY;this.startAtTop||(n*=-1);let o=this.startHeading+n*this.headingSpeed;o=this.makeHeadingSafe(o),i.heading=o;let r=this.startPitch+s*this.pitchSpeed;r=this.makePitchSafe(r),i.pitch=r,i.updateView()})),__publicField(this,"handleZoom",(e=>{const t=this.map;let i=t.zoom,n=i+e.deltaY*this.zoomSpeed*-1;if(i===n)return;if(n=this.makeZoomSafe(n),n<t.earthViewZoomMax)return this.map.zoom=n,void this.map.updateView();let s=this.mapWidth,o=this.mapHeight;const r=this.map.domContainer.getBoundingClientRect();this.startBoundX=r.left,this.startBoundY=r.top,this.startScaleX=r.width/s,this.startScaleY=r.height/o;let a=t.center,l=t.pitch,g=t.heading;this.getNdc(e.pixelX,e.pixelY,vw),ww.set(a[0],a[1],0),this.ndcToPoint(vw,t.camera,Sw),Sw.distanceTo(t.camera.position)>6e3*t.zoomUnits||(t.computeMapCameraMatrix(Mw,a,n,l,g),this.ndcToPoint(vw,Mw,Gw),ww.sub(Gw.sub(Sw)),this.map.center[0]=ww.x,this.map.center[1]=ww.y,this.map.zoom=n,this.map.updateView())})),__publicField(this,"makeZoomSafe",(e=>e>this.map.maxZoom?this.map.maxZoom:e<this.map.minZoom?this.map.minZoom:e)),__publicField(this,"makeHeadingSafe",(e=>((e%=360)<0&&(e+=360),e))),__publicField(this,"makePitchSafe",(e=>e<this.minPitch?this.minPitch:e>this.maxPitch?this.maxPitch:e)),__publicField(this,"dispose",(()=>{const e=this.map.domContainer;e.removeEventListener(fw.DOWN,this.handleMouseDown),e.removeEventListener("wheel",this.handleWheel),e.removeEventListener("contextmenu",this.handleContextMenu),document.removeEventListener(fw.MOVE,this.handleMouseDragging),document.removeEventListener(fw.UP,this.handleMouseUp),e.removeEventListener(fw.MOVE,this.handleMouseMove),this.clearDoubleClickTimer()})),this.map=e,this.enabled=!0,this.currentAction=bw}set enabled(e){e!==this._enabled&&(e?this.init():this.dispose(),this._enabled=e)}ndcToPoint(e,t,i){xw.setFromCamera(e,t),xw.ray.intersectPlane(Bw,i)}getNdc(e,t,i){i.x=e/this.mapWidth*2-1,i.y=1-t/this.mapHeight*2}}var Tw={},Zw={},Vw={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var t=1;e.default=function(){return"".concat(t++)}}(Vw);var Ww={},Ew={},Nw={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;e.default=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:60,i=null;return function(){for(var n=this,s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];clearTimeout(i),i=setTimeout((function(){e.apply(n,o)}),t)}}}(Nw);var Fw={};Object.defineProperty(Fw,"__esModule",{value:!0}),Fw.SensorTabIndex=Fw.SensorClassName=Fw.SizeSensorId=void 0;Fw.SizeSensorId="size-sensor-id";Fw.SensorClassName="size-sensor-object";Fw.SensorTabIndex="-1",Object.defineProperty(Ew,"__esModule",{value:!0}),Ew.createSensor=void 0;var Xw,Hw=(Xw=Nw)&&Xw.__esModule?Xw:{default:Xw},zw=Fw;Ew.createSensor=function(e){var t=void 0,i=[],n=(0,Hw.default)((function(){i.forEach((function(t){t(e)}))})),s=function(){t&&t.parentNode&&(t.contentDocument&&t.contentDocument.defaultView.removeEventListener("resize",n),t.parentNode.removeChild(t),t=void 0,i=[])};return{element:e,bind:function(s){t||(t=function(){"static"===getComputedStyle(e).position&&(e.style.position="relative");var t=document.createElement("object");return t.onload=function(){t.contentDocument.defaultView.addEventListener("resize",n),n()},t.style.display="block",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.height="100%",t.style.width="100%",t.style.overflow="hidden",t.style.pointerEvents="none",t.style.zIndex="-1",t.style.opacity="0",t.setAttribute("class",zw.SensorClassName),t.setAttribute("tabindex",zw.SensorTabIndex),t.type="text/html",e.appendChild(t),t.data="about:blank",t}()),-1===i.indexOf(s)&&i.push(s)},destroy:s,unbind:function(e){var n=i.indexOf(e);-1!==n&&i.splice(n,1),0===i.length&&t&&s()}}};var Lw={};Object.defineProperty(Lw,"__esModule",{value:!0}),Lw.createSensor=void 0;var Dw=function(e){return e&&e.__esModule?e:{default:e}}(Nw);Lw.createSensor=function(e){var t=void 0,i=[],n=(0,Dw.default)((function(){i.forEach((function(t){t(e)}))})),s=function(){t.disconnect(),i=[],t=void 0};return{element:e,bind:function(s){var o;t||((o=new ResizeObserver(n)).observe(e),n(),t=o),-1===i.indexOf(s)&&i.push(s)},destroy:s,unbind:function(e){var n=i.indexOf(e);-1!==n&&i.splice(n,1),0===i.length&&t&&s()}}},Object.defineProperty(Ww,"__esModule",{value:!0}),Ww.createSensor=void 0;var Kw=Ew,Yw="undefined"!=typeof ResizeObserver?Lw.createSensor:Kw.createSensor;Ww.createSensor=Yw,Object.defineProperty(Zw,"__esModule",{value:!0}),Zw.removeSensor=Zw.getSensor=void 0;var Pw=function(e){return e&&e.__esModule?e:{default:e}}(Vw),kw=Ww,Ow=Fw;var Uw={};Zw.getSensor=function(e){var t=e.getAttribute(Ow.SizeSensorId);if(t&&Uw[t])return Uw[t];var i=(0,Pw.default)();e.setAttribute(Ow.SizeSensorId,i);var n=(0,kw.createSensor)(e);return Uw[i]=n,n};Zw.removeSensor=function(e){var t=e.element.getAttribute(Ow.SizeSensorId);e.element.removeAttribute(Ow.SizeSensorId),e.destroy(),t&&Uw[t]&&delete Uw[t]},Object.defineProperty(Tw,"__esModule",{value:!0}),Tw.ver=jw=Tw.clear=Jw=Tw.bind=void 0;var Qw=Zw,Jw=Tw.bind=function(e,t){var i=(0,Qw.getSensor)(e);return i.bind(t),function(){i.unbind(t)}},jw=Tw.clear=function(e){var t=(0,Qw.getSensor)(e);(0,Qw.removeSensor)(t)};function qw(e,t,i){return Math.max(t,Math.min(i,e))}Tw.ver="1.0.1";class $w{constructor(e=0,t=0){$w.prototype.isVector2=!0,this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,i=this.y,n=e.elements;return this.x=n[0]*t+n[3]*i+n[6],this.y=n[1]*t+n[4]*i+n[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const i=this.dot(e)/t;return Math.acos(qw(i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y;return t*t+i*i}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const i=Math.cos(t),n=Math.sin(t),s=this.x-e.x,o=this.y-e.y;return this.x=s*i-o*n+e.x,this.y=s*n+o*i+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class eS{constructor(e=0,t=0,i=0,n=1){this.isQuaternion=!0,this._x=e,this._y=t,this._z=i,this._w=n}static slerpFlat(e,t,i,n,s,o,r){let a=i[n+0],l=i[n+1],g=i[n+2],c=i[n+3];const d=s[o+0],h=s[o+1],u=s[o+2],I=s[o+3];if(0===r)return e[t+0]=a,e[t+1]=l,e[t+2]=g,void(e[t+3]=c);if(1===r)return e[t+0]=d,e[t+1]=h,e[t+2]=u,void(e[t+3]=I);if(c!==I||a!==d||l!==h||g!==u){let e=1-r;const t=a*d+l*h+g*u+c*I,i=t>=0?1:-1,n=1-t*t;if(n>Number.EPSILON){const s=Math.sqrt(n),o=Math.atan2(s,t*i);e=Math.sin(e*o)/s,r=Math.sin(r*o)/s}const s=r*i;if(a=a*e+d*s,l=l*e+h*s,g=g*e+u*s,c=c*e+I*s,e===1-r){const e=1/Math.sqrt(a*a+l*l+g*g+c*c);a*=e,l*=e,g*=e,c*=e}}e[t]=a,e[t+1]=l,e[t+2]=g,e[t+3]=c}static multiplyQuaternionsFlat(e,t,i,n,s,o){const r=i[n],a=i[n+1],l=i[n+2],g=i[n+3],c=s[o],d=s[o+1],h=s[o+2],u=s[o+3];return e[t]=r*u+g*c+a*h-l*d,e[t+1]=a*u+g*d+l*c-r*h,e[t+2]=l*u+g*h+r*d-a*c,e[t+3]=g*u-r*c-a*d-l*h,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,i,n){return this._x=e,this._y=t,this._z=i,this._w=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t){const i=e._x,n=e._y,s=e._z,o=e._order,r=Math.cos,a=Math.sin,l=r(i/2),g=r(n/2),c=r(s/2),d=a(i/2),h=a(n/2),u=a(s/2);switch(o){case"XYZ":this._x=d*g*c+l*h*u,this._y=l*h*c-d*g*u,this._z=l*g*u+d*h*c,this._w=l*g*c-d*h*u;break;case"YXZ":this._x=d*g*c+l*h*u,this._y=l*h*c-d*g*u,this._z=l*g*u-d*h*c,this._w=l*g*c+d*h*u;break;case"ZXY":this._x=d*g*c-l*h*u,this._y=l*h*c+d*g*u,this._z=l*g*u+d*h*c,this._w=l*g*c-d*h*u;break;case"ZYX":this._x=d*g*c-l*h*u,this._y=l*h*c+d*g*u,this._z=l*g*u-d*h*c,this._w=l*g*c+d*h*u;break;case"YZX":this._x=d*g*c+l*h*u,this._y=l*h*c+d*g*u,this._z=l*g*u-d*h*c,this._w=l*g*c-d*h*u;break;case"XZY":this._x=d*g*c-l*h*u,this._y=l*h*c-d*g*u,this._z=l*g*u+d*h*c,this._w=l*g*c+d*h*u;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+o)}return!1!==t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const i=t/2,n=Math.sin(i);return this._x=e.x*n,this._y=e.y*n,this._z=e.z*n,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,i=t[0],n=t[4],s=t[8],o=t[1],r=t[5],a=t[9],l=t[2],g=t[6],c=t[10],d=i+r+c;if(d>0){const e=.5/Math.sqrt(d+1);this._w=.25/e,this._x=(g-a)*e,this._y=(s-l)*e,this._z=(o-n)*e}else if(i>r&&i>c){const e=2*Math.sqrt(1+i-r-c);this._w=(g-a)/e,this._x=.25*e,this._y=(n+o)/e,this._z=(s+l)/e}else if(r>c){const e=2*Math.sqrt(1+r-i-c);this._w=(s-l)/e,this._x=(n+o)/e,this._y=.25*e,this._z=(a+g)/e}else{const e=2*Math.sqrt(1+c-i-r);this._w=(o-n)/e,this._x=(s+l)/e,this._y=(a+g)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let i=e.dot(t)+1;return i<Number.EPSILON?(i=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=i):(this._x=0,this._y=-e.z,this._z=e.y,this._w=i)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=i),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(qw(this.dot(e),-1,1)))}rotateTowards(e,t){const i=this.angleTo(e);if(0===i)return this;const n=Math.min(1,t/i);return this.slerp(e,n),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const i=e._x,n=e._y,s=e._z,o=e._w,r=t._x,a=t._y,l=t._z,g=t._w;return this._x=i*g+o*r+n*l-s*a,this._y=n*g+o*a+s*r-i*l,this._z=s*g+o*l+i*a-n*r,this._w=o*g-i*r-n*a-s*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);const i=this._x,n=this._y,s=this._z,o=this._w;let r=o*e._w+i*e._x+n*e._y+s*e._z;if(r<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,r=-r):this.copy(e),r>=1)return this._w=o,this._x=i,this._y=n,this._z=s,this;const a=1-r*r;if(a<=Number.EPSILON){const e=1-t;return this._w=e*o+t*this._w,this._x=e*i+t*this._x,this._y=e*n+t*this._y,this._z=e*s+t*this._z,this.normalize(),this._onChangeCallback(),this}const l=Math.sqrt(a),g=Math.atan2(l,r),c=Math.sin((1-t)*g)/l,d=Math.sin(t*g)/l;return this._w=o*c+this._w*d,this._x=i*c+this._x*d,this._y=n*c+this._y*d,this._z=s*c+this._z*d,this._onChangeCallback(),this}slerpQuaternions(e,t,i){return this.copy(e).slerp(t,i)}random(){const e=Math.random(),t=Math.sqrt(1-e),i=Math.sqrt(e),n=2*Math.PI*Math.random(),s=2*Math.PI*Math.random();return this.set(t*Math.cos(n),i*Math.sin(s),i*Math.cos(s),t*Math.sin(n))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class tS{constructor(e=0,t=0,i=0){tS.prototype.isVector3=!0,this.x=e,this.y=t,this.z=i}set(e,t,i){return void 0===i&&(i=this.z),this.x=e,this.y=t,this.z=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(nS.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(nS.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,i=this.y,n=this.z,s=e.elements;return this.x=s[0]*t+s[3]*i+s[6]*n,this.y=s[1]*t+s[4]*i+s[7]*n,this.z=s[2]*t+s[5]*i+s[8]*n,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,i=this.y,n=this.z,s=e.elements,o=1/(s[3]*t+s[7]*i+s[11]*n+s[15]);return this.x=(s[0]*t+s[4]*i+s[8]*n+s[12])*o,this.y=(s[1]*t+s[5]*i+s[9]*n+s[13])*o,this.z=(s[2]*t+s[6]*i+s[10]*n+s[14])*o,this}applyQuaternion(e){const t=this.x,i=this.y,n=this.z,s=e.x,o=e.y,r=e.z,a=e.w,l=2*(o*n-r*i),g=2*(r*t-s*n),c=2*(s*i-o*t);return this.x=t+a*l+o*c-r*g,this.y=i+a*g+r*l-s*c,this.z=n+a*c+s*g-o*l,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,i=this.y,n=this.z,s=e.elements;return this.x=s[0]*t+s[4]*i+s[8]*n,this.y=s[1]*t+s[5]*i+s[9]*n,this.z=s[2]*t+s[6]*i+s[10]*n,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const i=e.x,n=e.y,s=e.z,o=t.x,r=t.y,a=t.z;return this.x=n*a-s*r,this.y=s*o-i*a,this.z=i*r-n*o,this}projectOnVector(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const i=e.dot(this)/t;return this.copy(e).multiplyScalar(i)}projectOnPlane(e){return iS.copy(this).projectOnVector(e),this.sub(iS)}reflect(e){return this.sub(iS.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const i=this.dot(e)/t;return Math.acos(qw(i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y,n=this.z-e.z;return t*t+i*i+n*n}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,i){const n=Math.sin(t)*e;return this.x=n*Math.sin(i),this.y=Math.cos(t)*e,this.z=n*Math.cos(i),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,i){return this.x=e*Math.sin(t),this.y=i,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),i=this.setFromMatrixColumn(e,1).length(),n=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=i,this.z=n,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=2*(Math.random()-.5),t=Math.random()*Math.PI*2,i=Math.sqrt(1-e**2);return this.x=i*Math.cos(t),this.y=i*Math.sin(t),this.z=e,this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const iS=new tS,nS=new eS;function sS(e,t,i=1e-6){return oS(e,t)<i}function oS(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow((e[2]||0)-(t[2]||0),2))}function rS(e,t,i){return i||(i=new $w),i.fromArray([t[0]-e[0],t[1]-e[1]]),i.normalize(),i}new tS,new tS,new tS,new tS,new tS,new tS,new tS,new tS,new tS,new tS;const aS=Km.EPSILON10;function lS(e,t,i){if(e===t)return!0;if(am(e)&&am(t)&&Array.isArray(e)&&Array.isArray(t)){let n=!0;return e.forEach(((s,o)=>{n=n&&Km.equalsEpsilon(e[o],t[o],i)})),n}return!1}function gS(e,t,i){if(!e)return;t=t||!1;const n=am(i),s=e.length;if(s<2)return e;let o,r,a,l=e[0],g=0,c=-1;for(o=1;o<s;++o)r=e[o],lS(l,r,aS)?(am(a)||(a=e.slice(0,o),g=o-1,c=0),n&&i.push(o)):(am(a)&&(a.push(r),g=o,n&&(c=i.length)),l=r);return t&&lS(e[0],e[s-1],aS)&&(n&&(am(a)?i.splice(c,0,g):i.push(s-1)),am(a)?a.length-=1:a=e.slice(0,-1)),am(a)?a:e}const cS=new Ut,dS=new Ut,hS=new yg,uS=new Cs(new Qt(0,0,1),0),IS=new bt;new Qt,new Bi,new Dt;const pS=new bt(-1,-1);new bt(-1,1),new bt(1,1);const mS=new bt(1,-1);new Qt,new Qt,new Qt,new Qt;const AS=new Qt,CS=class extends pw{constructor(e,t,i={}){super(e,i),__publicField(this,"isBlankMap",!0),__publicField(this,"MERCATOR_LENGTH",20037508.3427892),__publicField(this,"projectionName","_web_mercator"),__publicField(this,"origin",[0,0]),__publicField(this,"center",[0,0]),__publicField(this,"zoom",0),__publicField(this,"pitch",0),__publicField(this,"heading",0),__publicField(this,"bounds",[[-this.MERCATOR_LENGTH,-this.MERCATOR_LENGTH],[this.MERCATOR_LENGTH,this.MERCATOR_LENGTH]]),__publicField(this,"near",100),__publicField(this,"_far",38e3),__publicField(this,"fov",35),__publicField(this,"_cameraLocation",new Qt),__publicField(this,"handleViewChange",(()=>{this.onViewChanged&&this.onViewChanged()})),__publicField(this,"handleMapResize",(()=>{this.control&&this.control.handleResize(this.getResolution()),this.onResolutionChanged&&this.onResolutionChanged(this.getResolution())})),__publicField(this,"handleEventClick",(e=>{const t=this._engine.event,i=this._getPixelFromEvent(e);2===e.button?t._handleRightClick({pixel:i,event:e}):t._handleClick({pixel:i,event:e})})),__publicField(this,"handleEventDblClick",(e=>{const t=this._engine.event,i=this._getPixelFromEvent(e);2===e.button?t._handleRightDblClick({pixel:i,event:e}):t._handleDblClick({pixel:i,event:e})})),__publicField(this,"handleEventPointerDown",(e=>{const t=this._engine.event,i=this._getPixelFromEvent(e);t._handlePointerDown({pixel:i,event:e})})),__publicField(this,"handleEventPointerUp",(e=>{const t=this._engine.event,i=this._getPixelFromEvent(e);t._handlePointerUp({pixel:i,event:e})})),__publicField(this,"handleEventMouseMove",(e=>{const t=this._engine.event,i=this._getPixelFromEvent(e);t._handleMouseMove({pixel:i,event:e})})),__publicField(this,"_getPixelFromEvent",(e=>{const t=this._engine.rendering.canvas.getBoundingClientRect();return[e.clientX-t.left,e.clientY-t.top]})),this._engine=e,this.domContainer=t}afterInit(){this.camera.matrixAutoUpdate=!1,this.bindCanvas(),this.handleMapResize(),Jw(this.domContainer,this.handleMapResize),this.initControl(),this.resetHome()}resetHome(){this.lookAt(CS.DEFAULT_CENTER,{zoom:4.5,pitch:0,heading:0})}initControl(){this.control=new Rw(this),this.control.onEventPointerDown=this.handleEventPointerDown,this.control.onEventPointerUp=this.handleEventPointerUp,this.control.onEventClick=this.handleEventClick,this.control.onEventDblClick=this.handleEventDblClick,this.control.onEventMouseMove=this.handleEventMouseMove}bindCanvas(){this.domContainer.appendChild(this.canvas)}releaseCanvas(){this.domContainer.removeChild(this.canvas)}getContainerSize(){return[this.domContainer.clientWidth,this.domContainer.clientHeight]}getResolution(){return new bt(this.domContainer.clientWidth,this.domContainer.clientHeight)}getCenter(){return this.unprojectArrayCoordinate(this.center)}getZoom(){return this.zoom}getPitch(){return this.pitch}getZoomUnitsByZoom(e){return this.MERCATOR_LENGTH/128/Math.pow(2,e)}getCameraLocation(e){return e||(e=new Qt),e.copy(this._cameraLocation),e}getZoomByZoomUnits(e){return Math.log2(this.MERCATOR_LENGTH/128/e)}getZoomUnits(){return this.getZoomUnitsByZoom(this.zoom)}getHeading(){return this.heading}enableControl(){this.control.enabled=!0}disableControl(){this.control.enabled=!1}setCameraMatrix(){this.handleViewChange()}_updateCameraLocation(){this.projection.unprojectCoordinate(this.camera.position,this._cameraLocation)}updateCamera(){this.computeMapCameraMatrix(this.camera,this.center,this.zoom,this.pitch,this.heading),this._updateCameraLocation()}computeMapCameraMatrix(e,t,i,n,s){const[o,r]=this.getContainerSize();let a=this.zoomUnits=this.getZoomUnitsByZoom(i);if(o*a>this.bounds[1][0]-this.bounds[0][0]){let e=(this.bounds[1][0]-this.bounds[0][0])/o;a=this.zoomUnits=e,this.zoom=this.getZoomByZoomUnits(e)}if(r*a>this.bounds[1][1]-this.bounds[0][1]){let e=(this.bounds[1][1]-this.bounds[0][1])/r;a=this.zoomUnits=e,this.zoom=this.getZoomByZoomUnits(e)}t[0]-o/2*a<this.bounds[0][0]&&(t[0]=this.bounds[0][0]+o/2*a),t[0]+o/2*a>this.bounds[1][0]&&(t[0]=this.bounds[1][0]-o/2*a),t[1]-r/2*a<this.bounds[0][1]&&(t[1]=this.bounds[0][1]+r/2*a),t[1]+r/2*a>this.bounds[1][1]&&(t[1]=this.bounds[1][1]-r/2*a),this.center=t;const l=r/2/Math.tan(this.fov/2*Math.PI/180)*a;this.cameraDistance=l,e.position.set(0,0,0),e.quaternion.set(0,0,0,1),e.up.set(0,0,1),e.translateX(t[0]),e.translateY(t[1]),t[2]&&e.translateZ(t[2]),e.rotateOnAxis(new Qt(0,0,1),s*Math.PI/180),e.rotateOnAxis(new Qt(1,0,0),n*Math.PI/180),e.translateZ(l),e.updateMatrix(),e.updateMatrixWorld(),e.aspect=o/r;let g=a;g<1&&(g=1),e.near=Math.min(Math.max(e.position.z/1e4,.1),10),e.far=this._far*g,e.updateProjectionMatrix()}setCenter(e){const t=this.projectArrayCoordinate(e);t&&(this.center=t),this.setCameraMatrix()}setProjectionCenter(e){const t=this.unprojectArrayCoordinate(e);this.setCenter(t)}setZoom(e){isNaN(e)||(this.zoom=e),this.setCameraMatrix()}zoomIn(){this.setZoom(this.zoom+1)}zoomOut(){this.setZoom(this.zoom-1)}setHeading(e){this.heading=e,this.setCameraMatrix()}setPitch(e){this.pitch=e,this.setCameraMatrix()}setMaxRange(e){console.warn("setMaxRange is only compatible with 3DMap Control,\n            please set options 'map: {is3DControl: true}' when Engine is created")}lookAt(e,t={}){let i=[];e.isVector3?e.toArray(i):i=e;let n=this.projectArrayCoordinate(i);n&&(this.center=n),void 0!==t.heading&&(this.heading=t.heading),void 0!==t.pitch&&(this.pitch=t.pitch),void 0!==t.zoom&&(this.zoom=t.zoom),this.setCameraMatrix()}_getCameraQuaternion(e,t){cS.setFromAxisAngle(new Qt(0,0,1),e*Math.PI/180),dS.setFromAxisAngle(new Qt(1,0,0),t*Math.PI/180);const i=new Ut;return i.multiplyQuaternions(cS,dS),i}flyTo(e,t){this.cancelFlight();let i=[];e.isVector3?i=e.toArray():e.isVector2?i=[e.x,e.y,0]:e instanceof Array&&(i=[e[0],e[1],e[2]||0]),this.projectArrayCoordinate(i,i);const n=this._engine,s=n.map,o=this,r=lm(t.heading,n.map.getHeading()),a=lm(t.pitch,n.map.getPitch()),l=this._getCameraQuaternion(r,a),g=new Qt(0,0,-1).applyQuaternion(l).negate(),c=(new Qt).fromArray(i),d=t.range;isNaN(d)||c.add(g.multiplyScalar(d));const h={destination:c,heading:ft.degToRad(r),pitch:ft.degToRad(a),duration:t.duration,complete:function(){o._currentFlight=void 0,t.complete&&t.complete()},cancel:t.cancel},u=zC.createTween(s,h);if(0===u.duration)return void("function"==typeof u.complete&&u.complete());const I=performance.now();function p(){const e=performance.now()-I,{duration:t,complete:i,update:s,easingFunction:o}=u;if(e>=t)return s({time:t,easingFunction:o}),n.removePrepareRenderListener(p),void i();s({time:e,easingFunction:o}),n.requestRender()}n.addPrepareRenderListener(p),u.listener=p,this._currentFlight=u}cancelFlight(){if(this._currentFlight){const e=this._currentFlight.listener;this._engine.removePrepareRenderListener(e),this._currentFlight=void 0}}setBounds(e){this.bounds=[this.projectArrayCoordinate(e[0]),this.projectArrayCoordinate(e[1])]}getNdcYFactor(){const e=this.getPitch();if(e<45)return 1;const t=(e-45)/45,i=1-.5*Math.tan(t*Math.PI/2);return Math.max(-.1,Math.min(i,1))}getProjectionBounds(){const e=[],t=this.getNdcYFactor();hS.setFromCamera(pS,this.camera),hS.ray.intersectPlane(uS,AS);const i=AS.x,n=AS.y;hS.setFromCamera(mS,this.camera),hS.ray.intersectPlane(uS,AS);const s=AS.x,o=AS.y;IS.set(-1,t),hS.setFromCamera(IS,this.camera),hS.ray.intersectPlane(uS,AS);const r=AS.x,a=AS.y;IS.set(1,t),hS.setFromCamera(IS,this.camera),hS.ray.intersectPlane(uS,AS);const l=AS.x,g=AS.y;return e[0]=Math.min(i,s,r,l),e[1]=Math.min(n,o,a,g),e[2]=Math.max(i,s,r,l),e[3]=Math.max(n,o,a,g),new qt(new Qt(e[0],e[1],0),new Qt(e[2],e[3],0))}getBounds(){const e=this.getProjectionBounds(),t=this.unprojectArrayCoordinate([e.min.x,e.min.y]),i=this.unprojectArrayCoordinate([e.max.x,e.max.y]);return new qt(new Qt(t[0],t[1],0),new Qt(i[0],i[1],0))}updateView(){this.setCameraMatrix()}getCameraDistance(){return this.cameraDistance}getProjectionCenter(){return[this.center[0],this.center[1]]}dispose(){this.releaseCanvas(),jw(this.domContainer),this._engine.event,this.control.dispose(),super.dispose()}get far(){return this._far}set far(e){this._far=e}};let fS=CS;function bS(e){return new bt(-e.y,e.x)}function yS(e,t){let i=new bt;return i.addVectors(e,t),i.normalize(),bS(i)}function _S(e,t,i){const n=e.clone().sub(t),s=Math.cos(i),o=Math.sin(i),r=n.x*s+n.y*o,a=-n.x*o+n.y*s,l=new bt(r,a);return l.add(t),l}__publicField(fS,"EARTH_RADIUS",637e4),__publicField(fS,"DEFAULT_CENTER",[107.9,35.8]);const vS=new bt,xS=new bt;class BS{constructor(e={}){__publicField(this,"_lastTime",0),__publicField(this,"_lastPosition",new bt),__publicField(this,"_velocity",new bt),__publicField(this,"_acceleration",new bt),__publicField(this,"_resistance",.003),__publicField(this,"_inertiaSpeed",0),__publicField(this,"_inertiaDirection",new bt),void 0!==e.resistance&&(this._resistance=e.resistance)}start(e,t,i){this._lastPosition.set(e,t),this._velocity.set(0,0),this._acceleration.set(0,0),this._lastTime=void 0===i?performance.now():i}update(e,t,i){void 0===i&&(i=performance.now());const n=i-this._lastTime;vS.set(e,t);const s=vS.sub(this._lastPosition);xS.copy(s).divideScalar(n),this._acceleration.copy(xS).sub(this._velocity),this._lastPosition.set(e,t),this._velocity.copy(xS),this._lastTime=i}setInertiaState(e,t,i){this._inertiaSpeed=e,this._inertiaDirection.copy(t),this._lastTime=i}startInertia(){this._inertiaSpeed=this._velocity.length(),this._inertiaDirection.copy(this._velocity).normalize()}getInertiaPosition(e){void 0===e&&(e=performance.now());const t=e-this._lastTime,i=this._inertiaSpeed;let n=i-this._resistance*i*t;n<0&&(n=0);const s=this._inertiaDirection.clone().multiplyScalar(i*t).add(this._lastPosition);return this._inertiaSpeed=n,this._lastPosition.copy(s),this._lastTime=e,[s,n]}get inertiaDirection(){return this._inertiaDirection}}const wS=0,SS=1,GS=2,MS=3,RS=4,TS=0,ZS="wheel",VS="contextmenu",WS="dragging";new bt;const ES=new bt,NS=new yg,FS=new Cs(new Qt(0,0,1),0);new Qt,new Qt;const XS=new Qt,HS=new Qt,zS=new cs;new cs,zS.fov=35;const LS=new bt;class DS{constructor(e){__publicField(this,"map"),__publicField(this,"currentAction"),__publicField(this,"startX"),__publicField(this,"startY"),__publicField(this,"startCenterX"),__publicField(this,"startCenterY"),__publicField(this,"startPitch"),__publicField(this,"startHeading"),__publicField(this,"startZoom"),__publicField(this,"startZoomUnits"),__publicField(this,"startAtTop"),__publicField(this,"mapWidth"),__publicField(this,"mapHeight"),__publicField(this,"startCamera",new cs),__publicField(this,"startCenter",new Qt),__publicField(this,"startNdc",new bt),__publicField(this,"startPoint",new Qt),__publicField(this,"startScaleX",1),__publicField(this,"startScaleY",1),__publicField(this,"startBoundX"),__publicField(this,"startBoundY"),__publicField(this,"_enabled",!1),__publicField(this,"enableInertia",!0),__publicField(this,"minPitch",0),__publicField(this,"maxPitch",89),__publicField(this,"zoomSpeed",.005),__publicField(this,"headingSpeed",.4),__publicField(this,"pitchSpeed",.3),__publicField(this,"doubleClickTimer",null),__publicField(this,"clickInterval",200),__publicField(this,"_rotationMode",1),__publicField(this,"_buttonDown",{LEFT:!1,MIDDLE:!1,RIGHT:!1}),__publicField(this,"_primaryStartPosition",new bt),__publicField(this,"_primaryPosition",new bt),__publicField(this,"_primaryPreviousPosition",new bt),__publicField(this,"_positions",new Map),__publicField(this,"_previousPositions",new Map),__publicField(this,"_isPinching",!1),__publicField(this,"_isTouchHolding",!1),__publicField(this,"_lastPinchDist",0),__publicField(this,"_lastSeenTouchEvent",-800),__publicField(this,"_whichKindOfPinch"),__publicField(this,"_pinchConnectPosition",{position1:new bt,position2:new bt}),__publicField(this,"_pinchActionPosition",{position1:new bt,position2:new bt}),__publicField(this,"_pinchActionTimer"),__publicField(this,"_touchHoldTimer"),__publicField(this,"_clickPixelTolerance",5),__publicField(this,"_holdPixelTolerance",25),__publicField(this,"init",(()=>{const e=this.map.domContainer;e.addEventListener(fw.DOWN,this.handlePointerDownWithThrottle),e.addEventListener(ZS,this.handleWheelWithThrottle),e.addEventListener(VS,this.handleContextMenu),e.addEventListener(fw.MOVE,this.handlePointerMoveWithThrottle),this.initCursorAnchor()})),__publicField(this,"handlePointerDownWithThrottle",(e=>{this._eventThrottle.putEvent(fw.DOWN,e),this._tryToTriggerEvents()})),__publicField(this,"handleWheelWithThrottle",(e=>{this._eventThrottle.putEvent(ZS,e),this._tryToTriggerEvents()})),__publicField(this,"handlePointerMoveWithThrottle",(e=>{this._eventThrottle.putEvent(fw.MOVE,e),this._tryToTriggerEvents()})),__publicField(this,"handleMouseDraggingWithThrottle",(e=>{this._eventThrottle.putEvent(WS,e),this._tryToTriggerEvents()})),__publicField(this,"handlePointerUpWithThrottle",(e=>{this._eventThrottle.putEvent(fw.UP,e),this._tryToTriggerEvents()})),__publicField(this,"_tryToTriggerEvents",(async()=>{this._eventThrottle.isEmpty||this._eventThrottle.isBusy||await this._eventThrottle.triggerEvents(this._triggerEvents)})),__publicField(this,"_triggerEvents",(async e=>{e[fw.DOWN]&&await this.handlePointerDown(e[fw.DOWN]),e[ZS]&&await this.handleWheel(e[ZS]),e[fw.MOVE]&&await this.handlePointerMove(e[fw.MOVE]),e[WS]&&await this.handleMouseDragging(e[WS]),e[fw.UP]&&await this.handlePointerUp(e[fw.UP]),this._tryToTriggerEvents()})),__publicField(this,"initCursorAnchor",(()=>{const e=this.cursorAnchor=document.createElement("div");e.style.position="absolute",e.style.width="40px",e.style.height="40px",e.style.backgroundColor="rgba(255, 255, 255, 0.5)",e.style.zIndex=100,e.style.pointerEvents="none",e.style.display="none",this.map.domContainer.appendChild(e)})),__publicField(this,"showCursorAnchor",((e,t)=>{this._rotationMode<=1||(this.cursorAnchor.style.left=e-20+"px",this.cursorAnchor.style.top=t-20+"px",this.cursorAnchor.style.display="block")})),__publicField(this,"hideCursorAnchor",(()=>{this.cursorAnchor.style.display="none"})),__publicField(this,"handleResize",(e=>{const[t,i]=this.map.getContainerSize();this.mapWidth=t,this.mapHeight=i;const n=this.map.domContainer.getBoundingClientRect();this.startBoundX=n.left,this.startBoundY=n.top,this.startScaleX=n.width/t,this.startScaleY=n.height/i})),__publicField(this,"fireTouchEvents",(async e=>{const t=this.map;let i=this.mapWidth,n=this.mapHeight;const s=this._positions,o=s.size,r=this._isPinching;if(1!==o&&this._buttonDown[TS]){if(this._buttonDown[TS]=!1,this._touchHoldTimer&&(clearTimeout(this._touchHoldTimer),this._touchHoldTimer=void 0),e&&this.onEventPointerUp&&this.onEventPointerUp(e),0===o&&!this._isTouchHolding&&e&&this.onEventClick&&!this.hasMoved){KS(this._primaryStartPosition,Array.from(this._previousPositions.values())[0],this._clickPixelTolerance)&&this.onEventClick(e)}this._isTouchHolding=!1,this.hasMoved=!1,this.currentAction}if(o<=1&&r&&(this._pinchActionTimer&&(clearTimeout(this._pinchActionTimer),this._pinchActionTimer=void 0),this._isPinching=!1,this._whichKindOfPinch=void 0,this._lastPinchDist=0,this.currentAction),1===o&&!r){const o=Array.from(s.values())[0];this._primaryPosition.copy(o),this._primaryStartPosition.copy(o),this._primaryPreviousPosition.copy(o),this._buttonDown[TS]=!0;const r=this.map.domContainer.getBoundingClientRect();this.startBoundX=r.left,this.startBoundY=r.top,this.startScaleX=r.width/i,this.startScaleY=r.height/n;const a=o.x,l=o.y,g=new bt(a/i*2-1,1-2*l/n),c=await this._pickPosition(g);this.startCamera.copy(t.camera),this.startCamera.updateMatrixWorld(),FS.constant=-c.z,this.startPoint.copy(c),this.currentAction=SS,e&&this.onEventPointerDown&&this.onEventPointerDown(e),this.startX=a,this.startY=l,this.startAtTop=l<n/2,document.addEventListener(fw.UP,this.handlePointerUpWithThrottle),this._touchHoldTimer=setTimeout((function(){if(this._enabled&&(this._touchHoldTimer=void 0,this._isTouchHolding=!0,e&&this.onEventClick)){KS(this._primaryStartPosition,Array.from(this._previousPositions.values())[0],this._clickPixelTolerance)&&this.onEventClick(e)}}),this.touchHoldDelayMilliseconds),e.preventDefault()}if(2===o&&!r){const i=Array.from(s.values())[0],n=Array.from(s.values())[1];this._isPinching=!0;const o=t.getProjectionCenter();this.startPoint.set(o[0],o[1],o[2]);const r=t.decomposeRotation();this.startHeading=r.heading,this.startPitch=r.pitch,this.startDistance=t.camera.position.distanceTo(this.startPoint);const a=i.x,l=i.y;this.showCursorAnchor(a,l),this.currentAction=GS,this.startX=n.x,this.startY=n.y,this._lastPinchDist=i.distanceTo(n),this._pinchConnectPosition.position1.copy(i),this._pinchConnectPosition.position2.copy(n),this._pinchActionTimer=setTimeout((()=>{this._enabled&&(clearTimeout(this._pinchActionTimer),this._pinchActionTimer=void 0)}),150),e.preventDefault()}})),__publicField(this,"fireTouchMoveEvents",(async e=>{const t=this.map,i=this._positions;this._previousPositions;const n=i.size;if(this.currentAction!==wS){if(this.hasMoved=!0,this.onMouseDragging){if(!this.onMouseDragging())return}if(this.map.domContainer.style.cursor="grabbing",1===n&&this._buttonDown[TS]){const n=Array.from(i.values())[0],s=n.x,o=n.y;this._primaryPosition.copy(n);const r=this._primaryPreviousPosition;if(this.getNdc(s,o,ES),!this.ndcToPoint(ES,this.startCamera,HS)||HS.distanceTo(t.camera.position)>.8*t.camera.far)return void(await this.handlePointerUp());HS.sub(this.startPoint),HS.subVectors(this.startCamera.position,HS),t.camera.position.copy(HS),t.center=[HS.x,HS.y],e&&this.onEventMouseMove&&this.onEventMouseMove(e),r.copy(n),e.preventDefault()}else if(2===n&&this._isPinching){const e=t.camera,n=Array.from(i.values())[0],s=Array.from(i.values())[1];if(this._pinchActionTimer)return this._pinchActionPosition.position1.copy(n),void this._pinchActionPosition.position2.copy(s);if(void 0===this._whichKindOfPinch){const e=new bt,t=new bt,i=new bt;e.subVectors(this._pinchConnectPosition.position1,this._pinchConnectPosition.position2),e.normalize(),t.subVectors(this._pinchActionPosition.position1,this._pinchConnectPosition.position1),t.normalize(),i.subVectors(this._pinchActionPosition.position2,this._pinchConnectPosition.position2),i.normalize();const n=t.dot(i),s=e.dot(i);n>.8?this._whichKindOfPinch=MS:Math.abs(s)<.7?this._whichKindOfPinch=GS:this._whichKindOfPinch=RS}if(this._whichKindOfPinch===MS){const i=s.y-this.startY;let n=this.startPitch+i*this.pitchSpeed;if(n=this.makePitchSafe(n),this._rotationMode<=1)t._cameraLookAt(e,this.startPoint,{heading:this.startHeading,pitch:n,range:this.startDistance});else{t._cameraLookAt(zS,this.startPoint,{heading:this.startHeading,pitch:n,range:.2}),this.getNdc(this.startX,this.startY,ES),NS.setFromCamera(ES,zS);const i=NS.ray.direction.clone();ES.set(0,0),NS.setFromCamera(ES,zS);const s=NS.ray.direction.clone();i.angleTo(s);const o=new Qt;o.copy(i),o.normalize(),o.multiplyScalar(this.startDistance),e.position.copy(HS.copy(this.startPoint).sub(o)),e.quaternion.copy(zS.quaternion)}t.pitch=n}else if(this._whichKindOfPinch===RS){const i=n.distanceTo(s),o=2*(this._lastPinchDist-i),r=ft.clamp(o*this.zoomSpeed*-1,-.5,.5);this.getNdc((n.x+s.x)/2,(n.y+s.y)/2,ES);const a=await this._pickPosition(ES),l=e.position.distanceTo(a);if(l>.95*e.far)return;let g=r*ft.clamp(l,.5,1e7);g+.2>l?(g=l-.2,t.range=.2):t.range=l-g,t.maxRange&&t.maxRange<l&&r<0&&(g=0);const c=new Qt;c.subVectors(a,e.position),c.normalize();const d=new Qt;d.copy(c).multiplyScalar(g).add(e.position),e.position.copy(d),t.center=[d.x,d.y],this._lastPinchDist=i}else if(this._whichKindOfPinch===GS){const i=new bt;i.subVectors(this._pinchConnectPosition.position2,this._pinchConnectPosition.position1),i.normalize();const o=new bt;o.subVectors(s,n),o.normalize();let r=function(e,t){let i=e.x*t.x+e.y*t.y,n=Math.sqrt(e.x*e.x+e.y*e.y),s=Math.sqrt(t.x*t.x+t.y*t.y),o=Math.acos(i/(n*s));return e.x*t.y-t.x*e.y<0&&(o=2*Math.PI-o),o}(o,i),a=this.startHeading-r/Math.PI*180;a=this.makeHeadingSafe(a),t._cameraLookAt(e,this.startPoint,{heading:a,pitch:this.startPitch,range:this.startDistance})}}this.handleCameraBeforeRender(),this.map.updateView()}})),__publicField(this,"handlePointerMove",(async e=>{if(Cw(e)){const t=this._positions,i=e.pointerId;let n=t.get(i);if(!n)return;let s=this.getPixelPosition(e);n.set(s[0],s[1]),await this.fireTouchMoveEvents(e);this._previousPositions.get(i).copy(t.get(i))}else await this.handleMouseMove(e)})),__publicField(this,"handleMouseMove",(async e=>{this.onEventMouseMove&&this.onEventMouseMove(e)})),__publicField(this,"handlePointerDown",(async e=>{if(Cw(e)){const t=e.pointerId;let i=this.getPixelPosition(e);this._positions.set(t,new bt(i[0],i[1])),await this.fireTouchEvents(e),this._previousPositions.set(t,this._positions.get(t).clone())}else await this.handleMouseDown(e)})),__publicField(this,"handleMouseDown",(async e=>{const t=this.map;let i=this.mapWidth,n=this.mapHeight;const s=this.map.domContainer.getBoundingClientRect();this.startBoundX=s.left,this.startBoundY=s.top,this.startScaleX=s.width/i,this.startScaleY=s.height/n;const[o,r]=this.getPixelPosition(e),a=new bt(o/i*2-1,1-2*r/n);if(cancelAnimationFrame(this._inertiaAnimationHanlder),this._draggingMovementAggregator.start(o,r),0===e.button){const e=await this._pickPosition(a);this.startCamera.copy(t.camera),this.startCamera.updateMatrixWorld(),FS.constant=-e.z,this.startPoint.copy(e),this.currentAction=SS}else if(2===e.button){if(0===this._rotationMode){LS.set(0,0),NS.setFromCamera(LS,t.camera),NS.ray.intersectPlane(FS,XS),this.startPoint.copy(XS);const e=t.decomposeRotation();this.startHeading=e.heading,this.startPitch=e.pitch}else if(1===this._rotationMode){const e=await this._pickPosition(new bt);this.startPoint.copy(e);const i=t.decomposeRotation();this.startHeading=i.heading,this.startPitch=i.pitch}else{const e=await this._pickPosition(a);this.startCamera.copy(t.camera),this.startCamera.updateMatrixWorld();const i=new Qt;i.subVectors(e,this.startCamera.position),i.normalize(),this.startPoint.copy(e);const n=t.decomposeRotationFromDirection(i);this.startHeading=n.heading,this.startPitch=n.pitch}this.startDistance=t.camera.position.distanceTo(this.startPoint),this.currentAction=GS,this.showCursorAnchor(o,r)}else this.currentAction=wS;this.currentAction!==wS&&(e&&this.onEventPointerDown&&(this.hasMoved||this.onEventPointerDown(e)),this.startX=o,this.startY=r,this.startAtTop=r<n/2,document.addEventListener(fw.MOVE,this.handleMouseDraggingWithThrottle),document.addEventListener(fw.UP,this.handlePointerUpWithThrottle))})),__publicField(this,"_reactDragging",(async(e,t)=>{this.currentAction===SS?(this.map.domContainer.style.cursor="grabbing",await this.handlePan(e,t)):this.currentAction===GS&&(this.map.domContainer.style.cursor="grabbing",await this.handleRotate(e,t)),this.handleCameraBeforeRender(),this.map.updateView()})),__publicField(this,"handleMouseDragging",(async e=>{if(this.currentAction===wS)return;this.hasMoved=!0;const[t,i]=this.getPixelPosition(e);if(this._draggingMovementAggregator.update(t,i),this.onMouseDragging){if(!this.onMouseDragging())return}await this._reactDragging(t,i)})),__publicField(this,"handlePointerUp",(async e=>{if(Cw(e)){const t=e.pointerId;this._positions.delete(t),this.fireTouchEvents(e),this._previousPositions.delete(t)}else await this.handleMouseUp(e)})),__publicField(this,"_startInertiaAnimation",(()=>{const[e,t]=this._draggingMovementAggregator.getInertiaPosition();t>.1?(this._reactDragging(e.x,e.y),this._inertiaAnimationHanlder=requestAnimationFrame(this._startInertiaAnimation)):this.currentAction=wS})),__publicField(this,"handleMouseUp",(async e=>{this.enableInertia&&this.currentAction!==wS?(this._draggingMovementAggregator.startInertia(),this._startInertiaAnimation()):this.currentAction=wS,this.map.domContainer.style.cursor="default",this.hideCursorAnchor(),document.removeEventListener(fw.MOVE,this.handleMouseDraggingWithThrottle),document.removeEventListener(fw.UP,this.handlePointerUpWithThrottle),e&&this.onEventPointerUp&&this.onEventPointerUp(e),e&&this.onEventClick&&(this.hasMoved||this.onEventClick(e)),e&&this.onEventDblClick&&(!this.hasMoved&&this.waitSecondClick?(this.onEventDblClick(e),this.clearDoubleClickTimer()):this.waitSecondClick=!0),clearTimeout(this.doubleClickTimer),this.doubleClickTimer=setTimeout((()=>{this.clearDoubleClickTimer()}),this.clickInterval),this.hasMoved=!1})),__publicField(this,"clearDoubleClickTimer",(()=>{this.doubleClickTimer&&clearTimeout(this.doubleClickTimer),this.waitSecondClick=!1,this.doubleClickTimer=null})),__publicField(this,"handleContextMenu",(e=>{e.preventDefault()})),__publicField(this,"_reactZoom",(async(e,t,i,n)=>{await this.handleZoom({deltaX:e,deltaY:t,pixelX:i,pixelY:n}),this.handleCameraBeforeRender(),this.map.updateView()})),__publicField(this,"_startZoomInertiaAnimation",((e,t)=>{this._zoomInertiaAnimationHandler=requestAnimationFrame((()=>{const[i,n]=this._zoomMovementAggregator.getInertiaPosition();if(n>.1){const i=this._zoomMovementAggregator.inertiaDirection.y<0;this._reactZoom(0,i?-1*n:n,e,t),this._startZoomInertiaAnimation(e,t)}}))})),__publicField(this,"handleWheel",(async e=>{e.preventDefault(),e.stopPropagation();const[t,i]=this.getPixelPosition(e);if(cancelAnimationFrame(this._inertiaAnimationHanlder),cancelAnimationFrame(this._zoomInertiaAnimationHandler),this.enableInertia){const n=performance.now(),s=e.deltaY<0;let o=Math.abs(e.deltaY);o>20&&(o=20),this._zoomMovementAggregator.setInertiaState(o,new bt(0,s?-1:1),n),this._startZoomInertiaAnimation(t,i)}else this._reactZoom(0,e.deltaY,t,i)})),__publicField(this,"handlePan",(async(e,t)=>{const i=this.map;if(this.getNdc(e,t,ES),!this.ndcToPoint(ES,this.startCamera,HS)||HS.distanceTo(i.camera.position)>.9*i.camera.far)return this.currentAction=wS,void(await this.handlePointerUp());HS.sub(this.startPoint),HS.subVectors(this.startCamera.position,HS),i.camera.position.copy(HS),i.center=[HS.x,HS.y]})),__publicField(this,"handleRotate",(async(e,t)=>{const i=this.map,n=i.camera;let s=e-this.startX;const o=t-this.startY;this.startAtTop||(s*=-1);let r=this.startHeading+s*this.headingSpeed;r=this.makeHeadingSafe(r);let a=this.startPitch+o*this.pitchSpeed;if(a=this.makePitchSafe(a),this._rotationMode<=1)i._cameraLookAt(n,this.startPoint,{heading:r,pitch:a,range:this.startDistance});else{i._cameraLookAt(zS,this.startPoint,{heading:r,pitch:a,range:.2}),this.getNdc(this.startX,this.startY,ES),NS.setFromCamera(ES,zS);const e=NS.ray.direction.clone();ES.set(0,0),NS.setFromCamera(ES,zS);const t=NS.ray.direction.clone();e.angleTo(t);const s=new Qt;s.copy(e),s.normalize(),s.multiplyScalar(this.startDistance),n.position.copy(HS.copy(this.startPoint).sub(s)),n.quaternion.copy(zS.quaternion)}i.pitch=a,i.heading=r})),__publicField(this,"handleZoom",(async e=>{const t=this.map;let i=this.mapWidth,n=this.mapHeight;const s=this.map.domContainer.getBoundingClientRect();this.startBoundX=s.left,this.startBoundY=s.top,this.startScaleX=s.width/i,this.startScaleY=s.height/n;const o=t.camera,r=ft.clamp(e.deltaY*this.zoomSpeed*-1,-.5,.5);this.getNdc(e.pixelX,e.pixelY,ES);const a=await this._pickPosition(ES),l=o.position.distanceTo(a);if(l>.95*o.far)return;let g=r*ft.clamp(l,.5,1e7);g+.2>l?(g=l-.2,t.range=.2):t.range=l-g,t.maxRange&&t.maxRange<l&&r<0&&(g=0);const c=new Qt;c.subVectors(a,o.position),c.normalize();const d=new Qt;d.copy(c).multiplyScalar(g).add(o.position),o.position.copy(d),t.center=[d.x,d.y]})),__publicField(this,"makeHeadingSafe",(e=>((e%=360)<0&&(e+=360),e))),__publicField(this,"makePitchSafe",(e=>e<this.minPitch?this.minPitch:e>this.maxPitch?this.maxPitch:e)),__publicField(this,"dispose",(()=>{const e=this.map.domContainer;e.removeEventListener(fw.DOWN,this.handlePointerDownWithThrottle),e.removeEventListener(ZS,this.handleWheelWithThrottle),e.removeEventListener(VS,this.handleContextMenu),document.removeEventListener(fw.MOVE,this.handleMouseDraggingWithThrottle),document.removeEventListener(fw.UP,this.handlePointerUpWithThrottle),e.removeEventListener(fw.MOVE,this.handlePointerMoveWithThrottle),this.clearDoubleClickTimer(),this.cursorAnchor.remove()})),this.map=e,this.enabled=!0,this.currentAction=wS,this._eventThrottle=new KB,this._draggingMovementAggregator=new BS,this._zoomMovementAggregator=new BS({resistance:.005})}set enabled(e){e!==this._enabled&&(e?this.init():this.dispose(),this._enabled=e)}handleCameraBeforeRender(){this.map.camera.updateMatrix(),this.map.camera.updateMatrixWorld();let e=!0;this.onEventCameraChange&&(e=this.onEventCameraChange()),e?(this.originCamera=this.map.camera.clone(),this.originMap={center:this.map.center,pitch:this.map.pitch,heading:this.map.heading}):(this.map.camera.copy(this.originCamera,!0),this.map._engine.camera.copy(this.originCamera,!0),this.map.camera.updateMatrix(),this.map.camera.updateMatrixWorld(),this.map.camera.updateProjectionMatrix(),this.map.pitch=this.originMap.pitch,this.map.center=this.originMap.center,this.map.heading=this.originMap.heading)}getPixelPosition(e){let t=e.clientX,i=e.clientY;(e=>e.type.includes("touch"))(e)&&(t=e.changedTouches[0].clientX,i=e.changedTouches[0].clientY);return[this.currentPixelX=(t-this.startBoundX)/this.startScaleX,this.currentPixelY=(i-this.startBoundY)/this.startScaleY]}ndcToPoint(e,t,i){return NS.setFromCamera(e,t),!!NS.ray.intersectsPlane(FS)&&(NS.ray.intersectPlane(FS,i),!0)}getNdc(e,t,i){i.x=e/this.mapWidth*2-1,i.y=1-t/this.mapHeight*2}async _pickPosition(e){const t=this.map._engine.rendering.picking;return await t.pickWorldPositionFromNdc(e)}}function KS(e,t,i){const n=e.x-t.x,s=e.y-t.y;return Math.sqrt(n*n+s*s)<i}const YS=new Qt(0,0,-1),PS=new Qt(0,1,0),kS=new yg;kS.mouse=new bt;const OS=new Cs(new Qt(0,0,1),0),US=new Qt;new Bi;class QS extends fS{constructor(){super(...arguments),__publicField(this,"isBlankMap3D",!0),__publicField(this,"_viewStateDirty",!0),__publicField(this,"maxRange"),__publicField(this,"range"),__publicField(this,"bounds",[]),__publicField(this,"getPixelSize",(e=>{const[t,i]=this.getContainerSize();return Math.tan(ft.degToRad(this.fov/2))*e/i*2})),__publicField(this,"handleEventCameraChange",(()=>{const[e,t]=this.bounds;if(e&&t){const[i,n]=e,[s,o]=t,[r,a,l]=this.projectArrayCoordinate(this.getCenter());let g=!1;return Math.ceil(r)<i&&(g=!0),Math.ceil(a)<n&&(g=!0),Math.floor(r)>s&&(g=!0),Math.floor(a)>o&&(g=!0),!g}return!0}))}resetHome(){this.lookAt(fS.DEFAULT_CENTER,{range:1e7,pitch:0,heading:0})}initControl(){this.control=new DS(this),this.control.onEventPointerDown=this.handleEventPointerDown,this.control.onEventPointerUp=this.handleEventPointerUp,this.control.onEventClick=this.handleEventClick,this.control.onEventDblClick=this.handleEventDblClick,this.control.onEventMouseMove=this.handleEventMouseMove,this.control.onEventCameraChange=this.handleEventCameraChange}updateView(){this.handleViewChange()}getCenter(){return this.unprojectArrayCoordinate(this.getProjectionCenter())}getProjectionCenter(){return kS.setFromCamera(new bt,this.camera),kS.ray.intersectPlane(OS,US),[US.x,US.y,US.z]}getPitch(){return this.pitch}getHeading(){return this.heading}getRange(){return this.getCalcRange()}getCalcRange(){const e=this.getProjectionCenter();if("string"==typeof this.camera.position.z)throw new Error("camera.position.z is string");return this.camera.position.distanceTo(US.set(e[0],e[1],e[2]))}getZoom(){return this.getZoomByZoomUnits(this.getZoomUnits())}getZoomUnits(){const e=this.getRange();return this.getPixelSize(e)}getCameraDistance(e){if(this.range&&!e)return this.range;if(e){const e=this.getProjectionCenter(),t=this.camera.position.distanceTo(new Qt(e[0],e[1],e[2]));return this.range=t,this.range}return kS.setFromCamera(new bt,this.camera),kS.ray.intersectPlane(OS,US),this.range=this.camera.position.distanceTo(US),this.range}setCenter(e){this.setProjectionCenter(this.projectArrayCoordinate(e))}setProjectionCenter(e){const t=this.decomposeRotation();this._cameraLookAt(this.camera,e,{...t,height:this.camera.position.z}),this.center=e,this.updateView()}setZoom(e){const t=this.decomposeRotation(),i=this.getProjectionCenter(),n=this.getZoomUnitsByZoom(e),[s,o]=this.getContainerSize(),r=o/2*n/Math.tan(ft.degToRad(this.fov/2));this._cameraLookAt(this.camera,i,{...t,range:.1*r,height:r}),this.range=.1*r,this.updateView()}setPitch(e){const t=this.decomposeRotation(),i=this.getProjectionCenter(),n=this.camera.position.distanceTo(US.set(i[0],i[1],i[2]));this._cameraLookAt(this.camera,i,{heading:t.heading,pitch:e,range:n}),this.pitch=e,this.updateView()}setHeading(e){const t=this.decomposeRotation(),i=this.getProjectionCenter(),n=this.camera.position.distanceTo(US.set(i[0],i[1],i[2]));this._cameraLookAt(this.camera,i,{heading:e,pitch:t.pitch,range:n}),this.heading=e,this.updateView()}setRange(e){const t=this.decomposeRotation(),i=this.getProjectionCenter();this._cameraLookAt(this.camera,i,{...t,range:e}),this.range=e,this.updateView()}setMaxRange(e){this.maxRange=e}zoomIn(){const e=this.decomposeRotation(),t=this.getProjectionCenter();let i=this.camera.position.distanceTo(US.set(t[0],t[1],t[2])),n=.5*ft.clamp(i,.5,1e7);n+.2>i?(n=i-.2,i=.2):i-=n,this._cameraLookAt(this.camera,t,{...e,range:i}),this.range=i,this.updateView()}zoomOut(){const e=this.decomposeRotation(),t=this.getProjectionCenter();let i=this.camera.position.distanceTo(US.set(t[0],t[1],t[2])),n=-.5*ft.clamp(i,.5,1e7);n+.2>i?(n=i-.2,i=.2):i-=n,this._cameraLookAt(this.camera,t,{...e,range:i}),this.range=i,this.updateView()}lookAt(e,t={}){let i=[];e.isVector3?e.toArray(i):i=e;let n=this.projectArrayCoordinate(i);const{heading:s,pitch:o,range:r}=t;isNaN(s)||(this.heading=s),isNaN(o)||(this.pitch=o),isNaN(r)||(this.range=r),this._cameraLookAt(this.camera,n,t)}_cameraLookAt(e,t,i){const{heading:n=this.heading,pitch:s=this.pitch,range:o,height:r}=i,a=this._getCameraQuaternion(n,s),l=new Qt(0,0,-1);l.applyQuaternion(a),l.negate();const g=US;Array.isArray(t)?g.set(t[0],t[1],t[2]||0):t.isVector3&&g.copy(t),isNaN(o)||g.add(l.multiplyScalar(o)),e.position.copy(g),e.quaternion.copy(a),e.updateMatrix(),e.updateMatrixWorld()}offsetFromHeadingPitchRange(e=0,t=0,i=0){const n=new Ut;n.setFromAxisAngle(new Qt(0,0,1),e*Math.PI/180);const s=new Ut;s.setFromAxisAngle(new Qt(1,0,0),t*Math.PI/180);const o=new Ut;o.multiplyQuaternions(n,s);const r=new Qt(0,0,-1);r.applyQuaternion(o),r.negate();const a=new Qt;return a.copy(r).multiplyScalar(i),a}decomposeRotation(){const e=this.camera.quaternion,t=YS.clone(),i=PS.clone();return t.applyQuaternion(e),t.clampScalar(-1,1),i.applyQuaternion(e),this.decomposeRotationFromDirection(t,i)}decomposeRotationFromDirection(e,t){const i=180-ft.radToDeg(Math.acos(e.z));let n=ft.radToDeg(Math.atan2(e.y,e.x));return 0===e.x&&0===e.y&&(n=ft.radToDeg(Math.atan2(t.y,t.x))),n=(n-90)%360,{heading:n,pitch:i}}setBounds(e){this.bounds=[this.projectArrayCoordinate(e[0]).map((e=>Math.ceil(e))),this.projectArrayCoordinate(e[1]).map((e=>Math.ceil(e)))]}lockDrag(e){this.control.onMouseDragging=e?()=>!1:null}updateCamera(){const e=this.camera;e.updateMatrix(),e.updateMatrixWorld();const[t,i]=this.getContainerSize();e.aspect=t/i;const n=e.position.z;let s=this.pitch+this.fov/2,o=1e6;o=n/Math.cos(ft.degToRad(Math.min(s,89)))*1.25,e.near=Math.min(Math.max(n/1e4,.1),10),o<2e4&&(o=2e4),e.far=o,e.updateProjectionMatrix(),this._updateCameraLocation()}}class JS extends pw{constructor(e,t,i){super(e,i),__publicField(this,"near",.1),__publicField(this,"_far",4e3),__publicField(this,"fov",35),__publicField(this,"projectionName","_bmap_mercator"),__publicField(this,"handleMapUpdate",(()=>{this.onViewChanged&&this.onViewChanged()})),__publicField(this,"handleMapResize",(()=>{this.onResolutionChanged&&this.onResolutionChanged(this.getResolution())})),__publicField(this,"handleEventClick",(e=>{const t=this._engine.event,i=[e.pixel.x,e.pixel.y],n=[e.latlng.lng,e.latlng.lat],s=[e.point.lng,e.point.lat];t._handleClick({pixel:i,point:n,position:s,event:e})})),__publicField(this,"handleEventRightClick",(e=>{const t=this._engine.event,i=[e.pixel.x,e.pixel.y],n=[e.latlng.lng,e.latlng.lat],s=[e.point.lng,e.point.lat];t._handleRightClick({pixel:i,point:n,position:s,event:e})})),__publicField(this,"handleEventDblClick",(e=>{const t=this._engine.event,i=[e.pixel.x,e.pixel.y],n=[e.latlng.lng,e.latlng.lat],s=[e.point.lng,e.point.lat];t._handleDblClick({pixel:i,point:n,position:s,event:e})})),__publicField(this,"handleEventRightDblClick",(e=>{const t=this._engine.event,i=[e.pixel.x,e.pixel.y],n=[e.latlng.lng,e.latlng.lat],s=[e.point.lng,e.point.lat];t._handleRightDblClick({pixel:i,point:n,position:s,event:e})})),this._engine=e,this.map=t}getContainerSize(){const e=this.map.getSize();return[e.width,e.height]}getResolution(){const e=this.map.getSize();return new bt(e.width,e.height)}afterInit(){const e=this.map;this.canvas.style.zIndex="3",e.getContainer().appendChild(this.canvas),e.addEventListener("update",this.handleMapUpdate),e.addEventListener("resize",this.handleMapResize),e.addEventListener("click",this.handleEventClick),e.addEventListener("rightclick",this.handleEventRightClick),e.addEventListener("dblclick",this.handleEventDblClick),e.addEventListener("rightdblclick",this.handleEventRightDblClick),this.handleMapResize()}getCenter(){const e=this.map.getCenter();return[e.lng,e.lat]}getZoom(){return this.map.getZoom()}getZoomUnits(){return this.map.getZoomUnits()}getZoomByZoomUnits(e){return window.BMAPGL_84?Math.log2(this.MERCATOR_LENGTH/128/e):18-Math.log2(e)}getZoomUnitsByZoom(e){return this.map.getZoomUnits(e)}getHeading(){return this.map.getHeading()}getPitch(){return this.map.getTilt()}setCenter(e){this.map.setCenter(e)}setProjectionCenter(e){const t=this.unprojectArrayCoordinate(e);this.setCenter(t)}setZoom(e){this.map.setZoom(e)}setPitch(e){this.map.setTilt(e)}setHeading(e){this.map.setHeading(e)}setBounds(e){let t=[this.projectArrayCoordinate(e[0]),this.projectArrayCoordinate(e[1])];this.map.setBounds(new BMapGL.Point(t[0][0],t[0][1]),new BMapGL.Point(t[1][0],t[1][1]))}setMaxRange(e){console.warn("setMaxRange is only compatible with 3DMap Control,\n            please set options 'map: {is3DControl: true}' when Engine is created")}getBounds(){const e=new Qt,t=new Qt,i=this.map.getBoundsIn();return e.set(i.getMin().lng,i.getMin().lat,0),t.set(i.getMax().lng,i.getMax().lat,0),new qt(e,t)}enableControl(){this.map.enableDragging()}disableControl(){this.map.disableDragging()}zoomIn(){this.map.zoomIn()}zoomOut(){this.map.zoomOut()}updateCamera(){this.updateMatrixWorld(),this.updateProjectionMatrix()}updateMatrixWorld(){const e=this.map,t=this.camera,i=e.getCenterIn(),n=[i.lng,i.lat],s=e.getZoomUnits(),o=e.getTilt(),r=e.getHeading(),[a,l]=this.getContainerSize(),g=l/2/Math.tan(this.fov/2*Math.PI/180)*s;this.cameraDistance=g,t.position.set(0,0,0),t.quaternion.set(0,0,0,1),t.up.set(0,1,0),t.translateX(n[0]),t.translateY(n[1]),t.rotateOnAxis(new Qt(0,0,1),r*Math.PI/180),t.rotateOnAxis(new Qt(1,0,0),o*Math.PI/180),t.translateZ(g),t.updateMatrix(),t.updateMatrixWorld()}updateProjectionMatrix(){const e=this.camera,[t,i]=this.getContainerSize(),n=this.map.getZoomUnits();e.aspect=t/i,e.near=.1,e.far=this._far*n,e.far<1e3&&(e.far=1e3),e.updateProjectionMatrix()}getCameraDistance(){return this.cameraDistance}getProjectionCenter(){const e=this.map.getCenterIn();return[e.lng,e.lat]}dispose(){const e=this.map;e.getContainer().removeChild(this.canvas),e.removeEventListener("update",this.handleMapUpdate),e.removeEventListener("resize",this.handleMapResize),e.removeEventListener("click",this.handleEventClick),super.dispose()}get far(){return this._far}set far(e){}}class jS extends pw{constructor(e,t,i){super(e,i),__publicField(this,"MERCATOR_LENGTH",20037508.3427892),__publicField(this,"projectionName","_web_mercator"),__publicField(this,"origin",[0,0]),__publicField(this,"center",[0,0]),__publicField(this,"pitch",0),__publicField(this,"heading",0),__publicField(this,"near",.1),__publicField(this,"_far",8e3),__publicField(this,"fov",35),__publicField(this,"cameraDistance",1e3),__publicField(this,"handleEventClick",(e=>{const t=this._engine.event,i=[e.point.x,e.point.y],n=[e.lngLat.lng,e.lngLat.lat],s=this.projectArrayCoordinate(n);t._handleClick({pixel:i,point:n,position:s,event:e.originalEvent})})),__publicField(this,"handleEventDblClick",(e=>{const t=this._engine.event,i=[e.point.x,e.point.y],n=[e.lngLat.lng,e.lngLat.lat],s=this.projectArrayCoordinate(n);t._handleDblClick({pixel:i,point:n,position:s,event:e.originalEvent})})),__publicField(this,"handleEventRightClick",(e=>{const t=this._engine.event,i=[e.point.x,e.point.y],n=[e.lngLat.lng,e.lngLat.lat],s=this.projectArrayCoordinate(n);t._handleRightClick({pixel:i,point:n,position:s,event:e.originalEvent})})),__publicField(this,"handleMapResize",(()=>{this.onResolutionChanged&&this.onResolutionChanged(this.getResolution())})),this._engine=e,this.map=t,this.domContainer=t._container}afterInit(){this.canvas.style.pointerEvents="none",this.domContainer.appendChild(this.canvas);const e=this.map;e.on("render",(e=>{this.onViewChanged&&this.onViewChanged()})),e.on("click",this.handleEventClick),e.on("contextmenu",this.handleEventRightClick),e.on("dblclick",this.handleEventDblClick),e.on("resize",(()=>{this.handleMapResize()})),this.handleMapResize()}getContainerSize(){return[this.domContainer.clientWidth,this.domContainer.clientHeight]}getResolution(){return new bt(this.domContainer.clientWidth,this.domContainer.clientHeight)}setCenter(e){this.map.setCenter(e)}setZoom(e){this.map.setZoom(e)}setHeading(e){this.map.setBearing(e)}setPitch(e){this.map.setPitch(e)}getCenter(){const e=this.map.getCenter();return[e.lng,e.lat]}getZoom(){return this.map.getZoom()}getZoomUnitsByZoom(e){return this.MERCATOR_LENGTH/256/Math.pow(2,e)}getZoomByZoomUnits(e){return Math.log2(this.MERCATOR_LENGTH/256/e)}getZoomUnits(){return this.getZoomUnitsByZoom(this.map.getZoom())}getPitch(){return this.map.getPitch()}getHeading(){return this.map.getBearing()}enableControl(){this.map.dragPan.enable(),this.map.dragRotate.enable()}disableControl(){this.map.dragPan.disable(),this.map.dragRotate.disable()}zoomIn(){this.setZoom(this.getZoom()+1)}zoomOut(){this.setZoom(this.getZoom()-1)}flyTo(e){}updateCamera(){this.updateMatrixWorld(),this.updateProjectionMatrix()}updateMatrixWorld(){this.map;const e=this.camera,t=this.getCenter(),i=this.getZoomUnits(),n=this.getPitch(),s=this.getHeading(),[o,r]=this.getContainerSize(),a=this.projectArrayCoordinate(t),l=r/2/Math.tan(this.fov/2*Math.PI/180)*i;this.cameraDistance=l,e.position.set(0,0,0),e.quaternion.set(0,0,0,1),e.up.set(0,1,0),e.translateX(a[0]),e.translateY(a[1]),e.rotateOnAxis(new Qt(0,0,-1),s*Math.PI/180),e.rotateOnAxis(new Qt(1,0,0),n*Math.PI/180),e.translateZ(l),e.updateMatrix()}updateProjectionMatrix(){const e=this.camera,t=this.getZoomUnits(),[i,n]=this.getContainerSize();e.aspect=i/n,e.fov=this.fov,e.near=this.near*t,e.far=this._far*t,e.updateProjectionMatrix()}dispose(){this.domContainer.removeChild(this.canvas),this._engine.event,super.dispose()}getProjectionCenter(){const e=this.map.getCenter();return this.projectArrayCoordinate(e)}getCameraDistance(){return this.cameraDistance}get far(){return this._far}set far(e){}}__publicField(jS,"EARTH_RADIUS",637e4),new Qt;class qS extends Ji{constructor(e,t){super(),this._ellipsoid=e,this._engine=t}onBeforeScenePrepareRender(e,t,i,n){}get ellipsoid(){return this._ellipsoid}}const $S={LEFT_DRAG:0,RIGHT_DRAG:1,MIDDLE_DRAG:2,WHEEL:3,PINCH:4};function eG(){return!0}function tG(e,t){function i(){throw new Lm(t)}t=zm(t,"This object was destroyed, i.e., destroy() was called.");for(const n in e)"function"==typeof e[n]&&(e[n]=i);e.isDestroyed=eG}Object.freeze($S);const iG={SHIFT:0,CTRL:1,ALT:2};function nG(){this._array=[],this._hash={}}Object.freeze(iG),Object.defineProperties(nG.prototype,{length:{get:function(){return this._array.length}},values:{get:function(){return this._array}}}),nG.prototype.contains=function(e){if("string"!=typeof e&&"number"!=typeof e)throw new Lm("key is required to be a string or number.");return Hm(this._hash[e])},nG.prototype.set=function(e,t){if("string"!=typeof e&&"number"!=typeof e)throw new Lm("key is required to be a string or number.");t!==this._hash[e]&&(this.remove(e),this._hash[e]=t,this._array.push(t))},nG.prototype.get=function(e){if("string"!=typeof e&&"number"!=typeof e)throw new Lm("key is required to be a string or number.");return this._hash[e]},nG.prototype.remove=function(e){if(Hm(e)&&"string"!=typeof e&&"number"!=typeof e)throw new Lm("key is required to be a string or number.");var t=this._hash[e],i=Hm(t);if(i){var n=this._array;n.splice(n.indexOf(t),1),delete this._hash[e]}return i},nG.prototype.removeAll=function(){var e=this._array;e.length>0&&(this._hash={},e.length=0)};const sG={LEFT_DOWN:0,LEFT_UP:1,LEFT_CLICK:2,LEFT_DOUBLE_CLICK:3,RIGHT_DOWN:5,RIGHT_UP:6,RIGHT_CLICK:7,MIDDLE_DOWN:10,MIDDLE_UP:11,MIDDLE_CLICK:12,MOUSE_MOVE:15,WHEEL:16,PINCH_START:17,PINCH_END:18,PINCH_MOVE:19};function oG(e,t,i){var n=e._element;if(n===document)return i.x=t.clientX,i.y=t.clientY,i;var s=n.getBoundingClientRect();return i.x=t.clientX-s.left,i.y=t.clientY-s.top,i}function rG(e,t){var i=e;return Hm(t)&&(i+="+"+t),i}function aG(e){return e.shiftKey?iG.SHIFT:e.ctrlKey?iG.CTRL:e.altKey?iG.ALT:void 0}Object.freeze(sG);const lG={LEFT:0,MIDDLE:1,RIGHT:2};function gG(e,t,i,n){function s(t){n(e,t)}i.addEventListener(t,s,{capture:!1,passive:!1}),e._removalFunctions.push((function(){i.removeEventListener(t,s,!1)}))}var cG={position:new bt};function dG(e){e._lastSeenTouchEvent=Date.now()}function hG(e){return Date.now()-e._lastSeenTouchEvent>HG.mouseEmulationIgnoreMilliseconds}function uG(e,t,i){var n=e.x-t.x,s=e.y-t.y;return Math.sqrt(n*n+s*s)<i}function IG(e,t){if(hG(e)){var i,n=t.button;if(e._buttonDown[n]=!0,n===lG.LEFT)i=sG.LEFT_DOWN;else if(n===lG.MIDDLE)i=sG.MIDDLE_DOWN;else{if(n!==lG.RIGHT)return;i=sG.RIGHT_DOWN}var s=oG(e,t,e._primaryPosition);oA.clone(s,e._primaryStartPosition),oA.clone(s,e._primaryPreviousPosition);var o=aG(t),r=e.getInputAction(i,o);Hm(r)&&(oA.clone(s,cG.position),cG.event=t,r(cG),t.preventDefault())}}var pG={position:new bt},mG={position:new bt};function AG(e,t,i,n){var s=aG(n),o=e.getInputAction(t,s),r=e.getInputAction(i,s);if(Hm(o)||Hm(r)){var a=oG(e,n,e._primaryPosition);if(Hm(o)&&(oA.clone(a,pG.position),pG.event=n,o(pG)),Hm(r))uG(e._primaryStartPosition,a,e._clickPixelTolerance)&&(oA.clone(a,mG.position),mG.event=n,r(mG))}}function CG(e,t){if(hG(e)){var i=t.button;i!==lG.LEFT&&i!==lG.MIDDLE&&i!==lG.RIGHT||(e._buttonDown[lG.LEFT]&&(AG(e,sG.LEFT_UP,sG.LEFT_CLICK,t),e._buttonDown[lG.LEFT]=!1),e._buttonDown[lG.MIDDLE]&&(AG(e,sG.MIDDLE_UP,sG.MIDDLE_CLICK,t),e._buttonDown[lG.MIDDLE]=!1),e._buttonDown[lG.RIGHT]&&(AG(e,sG.RIGHT_UP,sG.RIGHT_CLICK,t),e._buttonDown[lG.RIGHT]=!1))}}var fG={startPosition:new bt,endPosition:new bt};function bG(e,t){if(hG(e)){var i=aG(t),n=oG(e,t,e._primaryPosition),s=e._primaryPreviousPosition,o=e.getInputAction(sG.MOUSE_MOVE,i);Hm(o)&&(oA.clone(s,fG.startPosition),oA.clone(n,fG.endPosition),fG.event=t,o(fG)),oA.clone(n,s),(e._buttonDown[lG.LEFT]||e._buttonDown[lG.MIDDLE]||e._buttonDown[lG.RIGHT])&&t.preventDefault()}}var yG={position:new bt};function _G(e,t){var i;if(t.button===lG.LEFT){i=sG.LEFT_DOUBLE_CLICK;var n=aG(t),s=e.getInputAction(i,n);Hm(s)&&(oG(e,t,yG.position),yG.event=t,s(yG))}}function vG(e,t){var i;if(Hm(t.deltaY)){var n=t.deltaMode;i=n===t.DOM_DELTA_PIXEL?-t.deltaY:n===t.DOM_DELTA_LINE?40*-t.deltaY:120*-t.deltaY}else i=t.detail>0?-120*t.detail:t.wheelDelta;if(Hm(i)){var s=aG(t),o=e.getInputAction(sG.WHEEL,s);Hm(o)&&(o(i),t.preventDefault())}}function xG(e,t){dG(e);var i,n,s,o=t.changedTouches,r=o.length,a=e._positions;for(i=0;i<r;++i)s=(n=o[i]).identifier,a.set(s,oG(e,n,new bt));TG(e,t);var l=e._previousPositions;for(i=0;i<r;++i)s=(n=o[i]).identifier,l.set(s,oA.clone(a.get(s)))}function BG(e,t){dG(e);var i,n,s=t.changedTouches,o=s.length,r=e._positions;for(i=0;i<o;++i)n=s[i].identifier,r.remove(n);TG(e,t);var a=e._previousPositions;for(i=0;i<o;++i)n=s[i].identifier,a.remove(n)}var wG={position:new bt},SG={position1:new bt,position2:new bt},GG={position:new bt},MG={position:new bt},RG={position:new bt};function TG(e,t){var i,n,s=aG(t),o=e._positions,r=o.length,a=e._isPinching;if(1!==r&&e._buttonDown[lG.LEFT]){if(e._buttonDown[lG.LEFT]=!1,Hm(e._touchHoldTimer)&&(clearTimeout(e._touchHoldTimer),e._touchHoldTimer=void 0),Hm(i=e.getInputAction(sG.LEFT_UP,s))&&(oA.clone(e._primaryPosition,GG.position),GG.event=t,i(GG)),0===r&&!e._isTouchHolding)if(Hm(n=e.getInputAction(sG.LEFT_CLICK,s)))uG(e._primaryStartPosition,e._previousPositions.values[0],e._clickPixelTolerance)&&(oA.clone(e._primaryPosition,MG.position),MG.event=t,n(MG));e._isTouchHolding=!1}if(0===r&&a&&(e._isPinching=!1,Hm(i=e.getInputAction(sG.PINCH_END,s))&&i()),1===r&&!a){var l=o.values[0];oA.clone(l,e._primaryPosition),oA.clone(l,e._primaryStartPosition),oA.clone(l,e._primaryPreviousPosition),e._buttonDown[lG.LEFT]=!0,Hm(i=e.getInputAction(sG.LEFT_DOWN,s))&&(oA.clone(l,wG.position),wG.event=t,i(wG)),e._touchHoldTimer=setTimeout((function(){e.isDestroyed()||(e._touchHoldTimer=void 0,e._isTouchHolding=!0,Hm(n=e.getInputAction(sG.RIGHT_CLICK,s))&&uG(e._primaryStartPosition,e._previousPositions.values[0],e._holdPixelTolerance)&&(oA.clone(e._primaryPosition,RG.position),RG.event=t,n(RG)))}),HG.touchHoldDelayMilliseconds),t.preventDefault()}2!==r||a||(e._isPinching=!0,Hm(i=e.getInputAction(sG.PINCH_START,s))&&(oA.clone(o.values[0],SG.position1),oA.clone(o.values[1],SG.position2),SG.event=t,i(SG),t.preventDefault()))}function ZG(e,t){dG(e);var i,n,s,o=t.changedTouches,r=o.length,a=e._positions;for(i=0;i<r;++i){s=(n=o[i]).identifier;var l=a.get(s);Hm(l)&&oG(e,n,l)}EG(e,t);var g=e._previousPositions;for(i=0;i<r;++i)s=(n=o[i]).identifier,oA.clone(a.get(s),g.get(s))}var VG={startPosition:new bt,endPosition:new bt},WG={distance:{startPosition:new bt,endPosition:new bt},angleAndHeight:{startPosition:new bt,endPosition:new bt}};function EG(e,t){var i,n=aG(t),s=e._positions,o=e._previousPositions,r=s.length;if(1===r&&e._buttonDown[lG.LEFT]){var a=s.values[0];oA.clone(a,e._primaryPosition);var l=e._primaryPreviousPosition;Hm(i=e.getInputAction(sG.MOUSE_MOVE,n))&&(oA.clone(l,VG.startPosition),oA.clone(a,VG.endPosition),VG.event=t,i(VG)),oA.clone(a,l),t.preventDefault()}else if(2===r&&e._isPinching&&Hm(i=e.getInputAction(sG.PINCH_MOVE,n))){var g=s.values[0],c=s.values[1],d=o.values[0],h=o.values[1],u=c.x-g.x,I=c.y-g.y,p=.25*Math.sqrt(u*u+I*I),m=h.x-d.x,A=h.y-d.y,C=.25*Math.sqrt(m*m+A*A),f=.125*(c.y+g.y),b=.125*(h.y+d.y),y=Math.atan2(I,u),_=Math.atan2(A,m);oA.fromElements(0,C,WG.distance.startPosition),oA.fromElements(0,p,WG.distance.endPosition),oA.fromElements(_,b,WG.angleAndHeight.startPosition),oA.fromElements(y,f,WG.angleAndHeight.endPosition),WG.event=t,i(WG)}}function NG(e,t){if(t.target.setPointerCapture(t.pointerId),"touch"===t.pointerType){var i=e._positions,n=t.pointerId;i.set(n,oG(e,t,new bt)),TG(e,t),e._previousPositions.set(n,oA.clone(i.get(n)))}else IG(e,t)}function FG(e,t){if("touch"===t.pointerType){var i=e._positions,n=t.pointerId;i.remove(n),TG(e,t),e._previousPositions.remove(n)}else CG(e,t)}function XG(e,t){if("touch"===t.pointerType){var i=e._positions,n=t.pointerId,s=i.get(n);if(!Hm(s))return;oG(e,t,s),EG(e,t);var o=e._previousPositions;oA.clone(i.get(n),o.get(n))}else bG(e,t)}function HG(e){this._inputEvents={},this._buttonDown={LEFT:!1,MIDDLE:!1,RIGHT:!1},this._isPinching=!1,this._isTouchHolding=!1,this._lastSeenTouchEvent=-HG.mouseEmulationIgnoreMilliseconds,this._primaryStartPosition=new bt,this._primaryPosition=new bt,this._primaryPreviousPosition=new bt,this._positions=new nG,this._previousPositions=new nG,this._removalFunctions=[],this._touchHoldTimer=void 0,this._clickPixelTolerance=5,this._holdPixelTolerance=25,this._element=zm(e,document),function(e){var t=e._element,i=Hm(t.disableRootEvents)?t:document;"undefined"!=typeof PointerEvent?(gG(e,"pointerdown",t,NG),gG(e,"pointerup",t,FG),gG(e,"pointermove",t,XG),gG(e,"pointercancel",t,FG)):(gG(e,"mousedown",t,IG),gG(e,"mouseup",i,CG),gG(e,"mousemove",i,bG),gG(e,"touchstart",t,xG),gG(e,"touchend",i,BG),gG(e,"touchmove",i,ZG),gG(e,"touchcancel",i,BG)),gG(e,"dblclick",t,_G),gG(e,"onwheel"in t?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll",t,vG)}(this)}function zG(e,t){let i=e;return Hm(t)&&(i+="+"+t),i}function LG(e,t,i){const n=zG($S.PINCH,t),s=e._update,o=e._isDown,r=e._eventStartPosition,a=e._pressTime,l=e._releaseTime;s[n]=!0,o[n]=!1,r[n]=new bt;let g=e._movement[n];Hm(g)||(g=e._movement[n]={}),g.distance={startPosition:new bt,endPosition:new bt},g.angleAndHeight={startPosition:new bt,endPosition:new bt},g.prevAngle=0,e._eventHandler.setInputAction((function(t){e._buttonsDown++,o[n]=!0,a[n]=new Date,oA.lerp(t.position1,t.position2,.5,r[n]),e._rendering.requestRender()}),sG.PINCH_START,t),e._eventHandler.setInputAction((function(){e._buttonsDown=Math.max(e._buttonsDown-1,0),o[n]=!1,l[n]=new Date,e._rendering.requestRender()}),sG.PINCH_END,t),e._eventHandler.setInputAction((function(t){if(o[n]){s[n]?(r=t,a=g,oA.clone(r.distance.startPosition,a.distance.startPosition),oA.clone(r.distance.endPosition,a.distance.endPosition),oA.clone(r.angleAndHeight.startPosition,a.angleAndHeight.startPosition),oA.clone(r.angleAndHeight.endPosition,a.angleAndHeight.endPosition),s[n]=!1,g.prevAngle=g.angleAndHeight.startPosition.x):(oA.clone(t.distance.endPosition,g.distance.endPosition),oA.clone(t.angleAndHeight.endPosition,g.angleAndHeight.endPosition));let o=g.angleAndHeight.endPosition.x;const l=g.prevAngle,c=2*Math.PI;for(;o>=l+Math.PI;)o-=c;for(;o<l-Math.PI;)o+=c;g.angleAndHeight.endPosition.x=-o*i.clientWidth/12,g.angleAndHeight.startPosition.x=-l*i.clientWidth/12,e._rendering.requestRender()}var r,a}),sG.PINCH_MOVE,t)}function DG(e,t){const i=zG($S.WHEEL,t),n=e._pressTime,s=e._releaseTime,o=e._update;o[i]=!0;let r=e._movement[i];Hm(r)||(r=e._movement[i]={});let a=e._lastMovement[i];Hm(a)||(a=e._lastMovement[i]={startPosition:new bt,endPosition:new bt,valid:!1}),r.startPosition=new bt,oA.clone(oA.ZERO,r.startPosition),r.endPosition=new bt,e._eventHandler.setInputAction((function(t){const l=7.5*Km.toRadians(t);n[i]=s[i]=new Date,r.endPosition.x=0,r.endPosition.y=l,oA.clone(r.endPosition,a.endPosition),a.valid=!0,o[i]=!1,e._rendering.requestRender()}),sG.WHEEL,t)}function KG(e,t,i){const n=zG(i,t),s=e._isDown,o=e._eventStartPosition,r=e._pressTime,a=e._releaseTime;s[n]=!1,o[n]=new bt;let l,g,c=e._lastMovement[n];Hm(c)||(c=e._lastMovement[n]={startPosition:new bt,endPosition:new bt,valid:!1}),i===$S.LEFT_DRAG?(l=sG.LEFT_DOWN,g=sG.LEFT_UP):i===$S.RIGHT_DRAG?(l=sG.RIGHT_DOWN,g=sG.RIGHT_UP):i===$S.MIDDLE_DRAG&&(l=sG.MIDDLE_DOWN,g=sG.MIDDLE_UP),e._eventHandler.setInputAction((function(t){e._buttonsDown++,c.valid=!1,s[n]=!0,r[n]=new Date,oA.clone(t.position,o[n]),t&&e.onEventPointerDown&&e.onEventPointerDown(t)}),l,t),e._eventHandler.setInputAction((function(t){e._buttonsDown=Math.max(e._buttonsDown-1,0),s[n]=!1,a[n]=new Date,t&&e.onEventPointerUp&&e.onEventPointerUp(t),e._rendering.requestRender()}),g,t)}function YG(e,t){oA.clone(e.startPosition,t.startPosition),oA.clone(e.endPosition,t.endPosition)}function PG(e,t){const i=e._update,n=e._movement,s=e._lastMovement,o=e._isDown;for(const r in $S)if($S.hasOwnProperty(r)){const n=$S[r];if(Hm(n)){const s=zG(n,t);i[s]=!0,Hm(e._lastMovement[s])||(e._lastMovement[s]={startPosition:new bt,endPosition:new bt,valid:!1}),Hm(e._movement[s])||(e._movement[s]={startPosition:new bt,endPosition:new bt})}}e._eventHandler.setInputAction((function(r){for(const a in $S)if($S.hasOwnProperty(a)){const l=$S[a];if(Hm(l)){const a=zG(l,t);o[a]?(i[a]?(YG(n[a],s[a]),s[a].valid=!0,YG(r,n[a]),i[a]=!1):oA.clone(r.endPosition,n[a].endPosition),e._rendering.requestRender()):e.onEventMouseMove&&e.onEventMouseMove(r)}}oA.clone(r.endPosition,e._currentMousePosition)}),sG.MOUSE_MOVE,t)}function kG(e,t){e._eventHandler.setInputAction((function(t){t&&e.onEventClick&&e.onEventClick(t),e._rendering.requestRender()}),sG.LEFT_CLICK,t),e._eventHandler.setInputAction((function(t){t&&e.onEventClick&&e.onEventClick(t),e._rendering.requestRender()}),sG.RIGHT_CLICK,t),e._eventHandler.setInputAction((function(t){t&&e.onEventDblClick&&e.onEventDblClick(t),e._rendering.requestRender()}),sG.LEFT_DOUBLE_CLICK,t)}function OG(e,t){if(!Hm(e))throw new Lm("canvas is required.");this._eventHandler=new HG(e),this._rendering=t,this._update={},this._movement={},this._lastMovement={},this._isDown={},this._eventStartPosition={},this._pressTime={},this._releaseTime={},this._buttonsDown=0,this._currentMousePosition=new bt,DG(this,void 0),LG(this,void 0,e),KG(this,void 0,$S.LEFT_DRAG),KG(this,void 0,$S.RIGHT_DRAG),KG(this,void 0,$S.MIDDLE_DRAG),PG(this,void 0),kG(this,void 0);for(const i in iG)if(iG.hasOwnProperty(i)){const t=iG[i];Hm(t)&&(DG(this,t),LG(this,t,e),KG(this,t,$S.LEFT_DRAG),KG(this,t,$S.RIGHT_DRAG),KG(this,t,$S.MIDDLE_DRAG),PG(this,t),kG(this,t))}}HG.prototype.setInputAction=function(e,t,i){if(!Hm(e))throw new Lm("action is required.");if(!Hm(t))throw new Lm("type is required.");var n=rG(t,i);this._inputEvents[n]=e},HG.prototype.getInputAction=function(e,t){if(!Hm(e))throw new Lm("type is required.");var i=rG(e,t);return this._inputEvents[i]},HG.prototype.removeInputAction=function(e,t){if(!Hm(e))throw new Lm("type is required.");var i=rG(e,t);delete this._inputEvents[i]},HG.prototype.isDestroyed=function(){return!1},HG.prototype.destroy=function(){return function(e){for(var t=e._removalFunctions,i=0;i<t.length;++i)t[i]()}(this),tG(this)},HG.mouseEmulationIgnoreMilliseconds=800,HG.touchHoldDelayMilliseconds=1500,Object.defineProperties(OG.prototype,{currentMousePosition:{get:function(){return this._currentMousePosition}},anyButtonDown:{get:function(){const e=!(this._update[zG($S.WHEEL)]&&this._update[zG($S.WHEEL,iG.SHIFT)]&&this._update[zG($S.WHEEL,iG.CTRL)]&&this._update[zG($S.WHEEL,iG.ALT)]);return this._buttonsDown>0||e}}}),OG.prototype.isMoving=function(e,t){const i=zG(e,t);return!this._update[i]},OG.prototype.getMovement=function(e,t){const i=zG(e,t);return this._movement[i]},OG.prototype.getLastMovement=function(e,t){const i=zG(e,t),n=this._lastMovement[i];if(n.valid)return n},OG.prototype.isButtonDown=function(e,t){const i=zG(e,t);return this._isDown[i]},OG.prototype.getStartMousePosition=function(e,t){if(e===$S.WHEEL)return this._currentMousePosition;const i=zG(e,t);return this._eventStartPosition[i]},OG.prototype.getButtonPressTime=function(e,t){const i=zG(e,t);return this._pressTime[i]},OG.prototype.getButtonReleaseTime=function(e,t){const i=zG(e,t);return this._releaseTime[i]},OG.prototype.reset=function(){for(const e in this._update)this._update.hasOwnProperty(e)&&(this._update[e]=!0)},OG.prototype.isDestroyed=function(){return!1},OG.prototype.destroy=function(){return this._eventHandler=this._eventHandler&&this._eventHandler.destroy(),tG(this)};var UG={};function QG(e,t,i){this.heading=zm(e,0),this.pitch=zm(t,0),this.roll=zm(i,0)}UG.getHeight=function(e,t,i){return(e-i)*t+i},QG.fromQuaternion=function(e,t){if(!Hm(e))throw new Lm("quaternion is required");Hm(t)||(t=new QG);const i=2*(e.w*e.y-e.z*e.x),n=1-2*(e.x*e.x+e.y*e.y),s=2*(e.w*e.x+e.y*e.z),o=1-2*(e.y*e.y+e.z*e.z),r=2*(e.w*e.z+e.x*e.y);return t.heading=-Math.atan2(r,o),t.roll=Math.atan2(s,n),t.pitch=-Km.asinClamped(i),t},QG.fromDegrees=function(e,t,i,n){if(!Hm(e))throw new Lm("heading is required");if(!Hm(t))throw new Lm("pitch is required");if(!Hm(i))throw new Lm("roll is required");return Hm(n)||(n=new QG),n.heading=e*Km.RADIANS_PER_DEGREE,n.pitch=t*Km.RADIANS_PER_DEGREE,n.roll=i*Km.RADIANS_PER_DEGREE,n},QG.clone=function(e,t){if(Hm(e))return Hm(t)?(t.heading=e.heading,t.pitch=e.pitch,t.roll=e.roll,t):new QG(e.heading,e.pitch,e.roll)},QG.equals=function(e,t){return e===t||Hm(e)&&Hm(t)&&e.heading===t.heading&&e.pitch===t.pitch&&e.roll===t.roll},QG.equalsEpsilon=function(e,t,i,n){return e===t||Hm(e)&&Hm(t)&&Km.equalsEpsilon(e.heading,t.heading,i,n)&&Km.equalsEpsilon(e.pitch,t.pitch,i,n)&&Km.equalsEpsilon(e.roll,t.roll,i,n)},QG.prototype.clone=function(e){return QG.clone(this,e)},QG.prototype.equals=function(e){return QG.equals(this,e)},QG.prototype.equalsEpsilon=function(e,t,i){return QG.equalsEpsilon(this,e,t,i)},QG.prototype.toString=function(){return`(${this.heading}, ${this.pitch}, ${this.roll})`};const JG={},jG=new Dt(0,0,0,1),qG={x:0,y:0,width:0,height:0};new Qt(Math.PI,Km.PI_OVER_TWO);let $G=new Dt(0,0,0,0);new Qt;const eM=new Dt(0,0,0,0),tM=new Qt;JG.computeActualEllipsoidPosition=function(e,t,i){if(e.mode===yC.SCENE3D)return jm.clone(t,i)},JG.worldToWindowCoordinates=function(e,t,i){return JG.worldWithEyeOffsetToWindowCoordinates(e,t,jm.ZERO,i)},JG.worldWithEyeOffsetToWindowCoordinates=function(e,t,i,n){if(!Hm(e))throw new Lm("scene is required.");if(!Hm(t))throw new Lm("position is required.");const s=JG.computeActualEllipsoidPosition(e,t,jG);if(!Hm(s))return;const o=e.canvas,r=qG;r.x=0,r.y=0,r.width=o.clientWidth,r.height=o.clientHeight;const a=e.camera;if(e.mode,yC.SCENE2D,e.mode!==yC.SCENE2D){if($G=function(e,t,i,n){const s=i.viewMatrix,o=aA.multiplyByVector(s,__.fromElements(e.x,e.y,e.z,1,eM),eM),r=jm.multiplyComponents(t,jm.normalize(o,tM),tM);return o.x+=t.x+r.x,o.y+=t.y+r.y,o.z+=r.z,aA.multiplyByVector(i.frustum.projectionMatrix,o,n)}(s,i,a,$G),$G.z<0)return;n=JG.clipToGLWindowCoordinates(r,$G,n)}return n.y=o.clientHeight-n.y,n};const iM=new Qt,nM=new Qt,sM=new Bi;function oM(e){if(!Hm(e))throw new Lm("scene is required.");this.enableInputs=!0,this.enableTranslate=!0,this.enableZoom=!0,this.enableRotate=!0,this.enableTilt=!0,this.enableLook=!0,this.enableFixCenter=!1,this.enableTerrainCollision=!1,this.inertiaSpin=.9,this.inertiaTranslate=.9,this.inertiaZoom=.8,this.maximumMovementRatio=.1,this.bounceAnimationTime=3,this.minimumZoomDistance=1,this.maximumZoomDistance=Number.POSITIVE_INFINITY,this.translateEventTypes=$S.LEFT_DRAG,this.zoomEventTypes=[$S.MIDDLE_DRAG,$S.WHEEL,$S.PINCH],this.rotateEventTypes=$S.LEFT_DRAG,this.tiltEventTypes=[$S.RIGHT_DRAG,$S.PINCH,{eventType:$S.LEFT_DRAG,modifier:iG.CTRL},{eventType:$S.RIGHT_DRAG,modifier:iG.CTRL}],this.lookEventTypes={eventType:$S.LEFT_DRAG,modifier:iG.SHIFT},this.minimumPickingTerrainHeight=15e4,this._minimumPickingTerrainHeight=this.minimumPickingTerrainHeight,this.minimumPickingTerrainDistanceWithInertia=4e3,this.minimumCollisionTerrainHeight=15e3,this._minimumCollisionTerrainHeight=this.minimumCollisionTerrainHeight,this.minimumTrackBallHeight=75e5,this._minimumTrackBallHeight=this.minimumTrackBallHeight,this.enableCollisionDetection=!0,this._scene=e,this._globe=void 0,this._ellipsoid=void 0,this._lastGlobeHeight=0,this._aggregator=new OG(e.canvas,e.rendering),this._lastInertiaSpinMovement=void 0,this._lastInertiaZoomMovement=void 0,this._lastInertiaTranslateMovement=void 0,this._lastInertiaTiltMovement=void 0,this._inertiaDisablers={_lastInertiaZoomMovement:["_lastInertiaSpinMovement","_lastInertiaTranslateMovement","_lastInertiaTiltMovement"],_lastInertiaTiltMovement:["_lastInertiaSpinMovement","_lastInertiaTranslateMovement"]},this._horizontalRotationAxis=void 0,this._tiltCenterMousePosition=new bt(-1,-1),this._tiltCenter=new Qt,this._translateMousePosition=new bt,this._rotateMousePosition=new bt(-1,-1),this._rotateStartPosition=new Qt,this._strafeStartPosition=new Qt,this._strafeMousePosition=new bt,this._strafeEndMousePosition=new bt,this._zoomMouseStart=new bt(-1,-1),this._zoomWorldPosition=new Qt,this._useZoomWorldPosition=!1,this._panLastMousePosition=new bt,this._panLastWorldPosition=new Qt,this._tiltCVOffMap=!1,this._looking=!1,this._rotating=!1,this._strafing=!1,this._zoomingOnVector=!1,this._zoomingUnderground=!1,this._rotatingZoom=!1,this._adjustedHeightForTerrain=!1,this._cameraUnderground=!1;const t=e.mapProjection;this._maxCoord=t.project(new Qt(Math.PI,Km.PI_OVER_TWO)),this._zoomFactor=5,this._rotateFactor=void 0,this._rotateRateRangeAdjustment=void 0,this._maximumRotateRate=1.77,this._minimumRotateRate=2e-4,this._minimumZoomRate=20,this._maximumZoomRate=5906376272e3,this._minimumUndergroundPickDistance=2e3,this._maximumUndergroundPickDistance=1e4}JG.clipToGLWindowCoordinates=function(e,t,i){return jm.divideByScalar(t,t.w,iM),aA.computeViewportTransformation(e,0,1,sM),aA.multiplyByPoint(sM,iM,nM),oA.fromCartesian3(nM,i)};const rM=.4;function aM(e,t,i,n,s,o,r){let a=o[r];Hm(a)||(a=o[r]={startPosition:new bt,endPosition:new bt,motion:new bt,inertiaEnabled:!0});const l=e.getButtonPressTime(t,i),g=e.getButtonReleaseTime(t,i),c=l&&g&&(g.getTime()-l.getTime())/1e3,d=new Date,h=g&&(d.getTime()-g.getTime())/1e3;if(l&&g&&c<rM){const r=function(e,t){if(e<0)return 0;const i=25*(1-t);return Math.exp(-i*e)}(h,n),l=e.getLastMovement(t,i);if(!Hm(l)||(u=l,oA.equalsEpsilon(u.startPosition,u.endPosition,Km.EPSILON14))||!a.inertiaEnabled)return;if(a.motion.x=.5*(l.endPosition.x-l.startPosition.x),a.motion.y=.5*(l.endPosition.y-l.startPosition.y),a.startPosition=oA.clone(l.startPosition,a.startPosition),a.endPosition=oA.multiplyByScalar(a.motion,r,a.endPosition),a.endPosition=oA.add(a.startPosition,a.endPosition,a.endPosition),isNaN(a.endPosition.x)||isNaN(a.endPosition.y)||oA.distance(a.startPosition,a.endPosition)<.5)return;if(!e.isButtonDown(t,i)){s(o,e.getStartMousePosition(t,i),a)}}var u}function lM(e,t){if(Hm(t)){let i=e[t];Hm(i)&&(i.inertiaEnabled=!0);const n=e._inertiaDisablers[t];if(Hm(n)){const t=n.length;for(let s=0;s<t;++s)i=e[n[s]],Hm(i)&&(i.inertiaEnabled=!1)}}}const gM=[];function cM(e,t,i,n,s,o){if(!Hm(i))return;const r=e._aggregator;Array.isArray(i)||(gM[0]=i,i=gM);const a=i.length;for(let l=0;l<a;++l){const a=i[l],g=Hm(a.eventType)?a.eventType:a,c=a.modifier,d=r.isMoving(g,c)&&r.getMovement(g,c),h=r.getStartMousePosition(g,c);e.enableInputs&&t&&(d?(n(e,h,d),lM(e,o)):s<1&&aM(r,g,c,s,n,e,o))}}const dM=new xi,hM=new Qt,uM=new bt,IM=new Qt,pM=new bt,mM=new Qt,AM=new Qt,CM=new Qt,fM=new Qt,bM=new Qt,yM=new Qt,_M=new Qt,vM=new Qt,xM=new Qt,BM=new Qt,wM=new Qt,SM=new Qt,GM=new Qt,MM=new Qt,RM=new Qt,TM=new Qt,ZM=new Qt,VM=new Qt,WM={orientation:new QG},EM=new Qt;function NM(e,t,i){if(!t.enableFixCenter)return;const n=e.position.length(),s=Km.asinClamped(eA.WGS84.maximumRadius/n),o=Math.cos(s)*n,r=s-e.position.clone().normalize().negate().angleTo(e.directionWC),a=Math.tan(r)*o,l=Math.cos(r)*a,g=Math.sin(r)*a,c=o/Math.cos(r)-g,d=ft.degToRad(t._scene.rendering.camera.fov)/2-Math.atan(l/c);if(d<0)return;let h=n-.85*t._minimumTrackBallHeight;if(h<0)return;const u=5e6;h=ft.clamp(h,0,u);const I=.1+.3*(1-h/u);let p=Math.max(i,.1);jm.negate(e.position,EM);const m=EM.normalize(),A=jm.dot(m,e.directionWC);let C=Km.acosClamped(A);C>.1&&(C=d-I/3),C*=p,C<0||(e.rotateAroundPoint(t._zoomWorldPosition,e.right,C),WM.orientation.pitch-=C)}async function FM(e,t,i,n,s,o){let r=1;Hm(o)&&(r=Km.clamp(Math.abs(o),.25,1));const a=i.endPosition.y-i.startPosition.y,l=a>0?e.minimumZoomDistance*r:0,g=e.maximumZoomDistance;let c=n*(s-l);c=Km.clamp(c,e._minimumZoomRate,e._maximumZoomRate);let d=a/e._scene.canvas.clientHeight;d=Math.min(d,e.maximumMovementRatio);let h=c*d;if(e.enableCollisionDetection||0===e.minimumZoomDistance||!Hm(e._globe)){if(h>0&&Math.abs(s-l)<1)return;if(h<0&&Math.abs(s-g)<1)return;s-h<l?h=s-l-1:s-h>g&&(h=s-g)}const u=e._scene,I=u.camera,p=u.mode;if(e.enableFixCenter&&I.positionWC.length()>6317e4&&a<0)return;const m=WM.orientation;m.heading=I.heading,m.pitch=I.pitch,m.roll=I.roll;const A=zm(i.inertiaEnabled,oA.equals(t,e._zoomMouseStart));let C,f=e._zoomingOnVector,b=e._rotatingZoom;if(A||(e._zoomMouseStart=oA.clone(t,e._zoomMouseStart),Hm(e._globe)&&p===bC.SCENE2D?(C=I.getPickRay(t,dM).origin,C=jm.fromElements(C.y,C.z,C.x)):Hm(e._globe)&&(C=await YM(e,t,hM)),Hm(C)?(e._useZoomWorldPosition=!0,e._zoomWorldPosition=jm.clone(C,e._zoomWorldPosition)):e._useZoomWorldPosition=!1,f=e._zoomingOnVector=!1,b=e._rotatingZoom=!1,e._zoomingUnderground=e._cameraUnderground),!e._useZoomWorldPosition)return p===bC.SCENE3D&&h<0&&NM(I,e,h),void I.zoomIn(h);let y=p===bC.COLUMBUS_VIEW;if(I.positionCartographic.z<2e6&&(b=!0),!A||b){if(p===bC.SCENE2D){const i=e._zoomWorldPosition,n=I.position;if(!jm.equals(i,n)&&I.positionCartographic.z<2*e._maxCoord.x){const s=I.position.x,o=jm.subtract(i,n,IM);jm.normalize(o,o);const r=jm.distance(i,n)*h/(.5*I.getMagnitude());I.move(o,.5*r),(I.position.x<0&&s>0||I.position.x>0&&s<0)&&(C=I.getPickRay(t,dM).origin,C=jm.fromElements(C.y,C.z,C.x),e._zoomWorldPosition=jm.clone(C,e._zoomWorldPosition))}}else if(p===bC.SCENE3D){const t=jm.normalize(I.position,bM);if(e._cameraUnderground||e._zoomingUnderground||I.positionCartographic.z<3e3&&Math.abs(jm.dot(I.direction,t))<.6)y=!0;else{const i=u.canvas,n=pM;n.x=i.clientWidth/2,n.y=i.clientHeight/2;const s=await YM(e,n,mM);if(Hm(s))if(I.positionCartographic.z<1e6){if(!(jm.dot(I.direction,t)>=-.5)){const i=_M;jm.clone(I.position,i);const n=e._zoomWorldPosition;let s=yM;if(s=jm.normalize(n,s),jm.dot(s,t)<0)return;const o=RM,r=BM;jm.clone(I.direction,r),jm.add(i,jm.multiplyByScalar(r,1e3,TM),o);const a=wM,l=SM;jm.subtract(n,i,a),jm.normalize(a,l);const g=jm.dot(t,l);if(g>=0)return void(e._zoomMouseStart.x=-1);const c=Math.acos(-g),d=jm.magnitude(i),u=jm.magnitude(n),m=d-h,A=jm.magnitude(a),C=Math.asin(Km.clamp(A/u*Math.sin(c),-1,1))-Math.asin(Km.clamp(m/u*Math.sin(c),-1,1))+c,f=vM;jm.normalize(i,f);let b=xM;b=jm.cross(l,f,b),b=jm.normalize(b,b),jm.normalize(jm.cross(f,b,TM),r),jm.multiplyByScalar(jm.normalize(o,TM),jm.magnitude(o)-h,o),jm.normalize(i,i),jm.multiplyByScalar(i,m,i);const y=GM;jm.multiplyByScalar(jm.add(jm.multiplyByScalar(f,Math.cos(C)-1,ZM),jm.multiplyByScalar(r,Math.sin(C),VM),TM),m,y),jm.add(i,y,i),jm.normalize(o,f),jm.normalize(jm.cross(f,b,TM),r);const _=MM;return jm.multiplyByScalar(jm.add(jm.multiplyByScalar(f,Math.cos(C)-1,ZM),jm.multiplyByScalar(r,Math.sin(C),VM),TM),jm.magnitude(o),_),jm.add(o,_,o),jm.clone(i,I.position),jm.normalize(jm.subtract(o,i,TM),I.direction),jm.clone(I.direction,I.direction),jm.cross(I.direction,I.up,I.right),jm.cross(I.right,I.direction,I.up),p===bC.SCENE3D&&h<0&&NM(I,e,h),void I.setView(WM)}y=!0}else{const t=jm.normalize(s,AM),i=jm.normalize(e._zoomWorldPosition,CM),n=jm.dot(i,t);if(n>0&&n<1){const e=Km.acosClamped(n),s=jm.cross(i,t,fM),o=h/(2*(Math.abs(e)>Km.toRadians(20)?.75*I.positionCartographic.z:I.positionCartographic.z-h));I.rotate(s,e*o)}}else y=!0}}e._rotatingZoom=!y}if(!A&&y||f){let i;const n=JG.worldToWindowCoordinates(u,e._zoomWorldPosition,uM);i=p!==bC.COLUMBUS_VIEW&&oA.equals(t,e._zoomMouseStart)&&Hm(n)?I.getPickRay(n,dM):I.getPickRay(t,dM);const s=i.direction;p!==bC.COLUMBUS_VIEW&&p!==bC.SCENE2D||jm.fromElements(s.y,s.z,s.x,s),I.move(s,h),e._zoomingOnVector=!0}else I.zoomIn(h);p===bC.SCENE3D&&h<0&&NM(I,e,h),e._cameraUnderground||I.setView(WM)}const XM=new xi,HM=new xi,zM=new Qt;function LM(e,t,i){const n=e._scene.camera;let s=n.getPickRay(i.startPosition,XM).origin,o=n.getPickRay(i.endPosition,HM).origin;s=jm.fromElements(s.y,s.z,s.x,s),o=jm.fromElements(o.y,o.z,o.x,o);const r=jm.subtract(s,o,zM),a=jm.magnitude(r);a>0&&(jm.normalize(r,r),n.move(r,a))}async function DM(e,t,i){Hm(i.distance)&&(i=i.distance);const n=e._scene.camera;await FM(e,t,i,e._zoomFactor,n.getMagnitude())}new bt,new bt;const KM=new xi;async function YM(e,t,i){const n=e._scene;let s=await n.rendering.picking.pickWorldPosition(t);return jm.clone(s,i),i}new Qt,new Qt;const PM=new Qt;function kM(e){const t=e._ellipsoid,i=e._scene,n=i.camera;let s=0;if(i.mode===bC.SCENE3D){const e=t.cartesianToCartographic(n.position,PM);Hm(e)&&(s=e.z)}else s=n.position.z;const o=zm(e._scene.globeHeight,0);return Math.abs(o-s)}const OM=new Qt;function UM(e,t){const i=t.origin,n=t.direction,s=kM(e),o=jm.normalize(i,OM);let r=Math.abs(jm.dot(o,n));return r=2*Math.max(r,.5),s*r}function QM(e,t,i,n){let s=jm.distance(t.origin,i);const o=kM(e);return s>Km.clamp(5*o,e._minimumUndergroundPickDistance,e._maximumUndergroundPickDistance)&&(s=Math.min(s,o/5),s=Math.max(s,100)),fC.getPoint(t,s,n)}function JM(e,t,i,n){let s;return Hm(i)?(s=jm.distance(t.origin,i),s>e._maximumUndergroundPickDistance&&(s=kM(e))):s=kM(e),fC.getPoint(t,s,n)}const jM=new bt;function qM(e,t){const i=t.endPosition,n=oA.subtract(t.endPosition,t.startPosition,jM),s=e._strafeEndMousePosition;oA.add(s,n,s),t.endPosition=s,ZR(e,t,e._strafeStartPosition),t.endPosition=i}const $M=new xi,eR=new xi,tR=new Qt,iR=new Qt,nR=new Qt,sR=new Qt,oR=new Cs(new Qt(1,0,0),0),rR=new bt,aR=new bt;async function lR(e,t,i){if(jm.equals(t,e._translateMousePosition)||(e._looking=!1),jm.equals(t,e._strafeMousePosition)||(e._strafing=!1),e._looking)return void BT(e,t,i);if(e._strafing)return void qM(e,i);const n=e._scene.camera,s=e._cameraUnderground,o=oA.clone(i.startPosition,rR),r=oA.clone(i.endPosition,aR);let a=n.getPickRay(o,$M);const l=jm.clone(jm.ZERO,sR),g=jm.UNIT_X;let c;if(n.position.z<e._minimumPickingTerrainHeight&&(c=await YM(e,o,tR),Hm(c)&&(l.x=c.x)),s||l.x>n.position.z&&Hm(c)){let n=c;return s&&(n=JM(e,a,c,tR)),oA.clone(t,e._strafeMousePosition),oA.clone(t,e._strafeEndMousePosition),jm.clone(n,e._strafeStartPosition),e._strafing=!0,void ZR(e,i,e._strafeStartPosition)}const d=G_.fromPointNormal(l,g,oR);a=n.getPickRay(o,$M);const h=YA.rayPlane(a,d,tR),u=n.getPickRay(r,eR),I=YA.rayPlane(u,d,iR);if(!Hm(h)||!Hm(I))return e._looking=!0,BT(e,t,i),void oA.clone(t,e._translateMousePosition);const p=jm.subtract(h,I,nR),m=p.x;p.x=p.y,p.y=p.z,p.z=m;const A=jm.magnitude(p);A>Km.EPSILON6&&(jm.normalize(p,p),n.move(p,A))}const gR=new bt,cR=new xi,dR=new Qt,hR=new Qt,uR=new Bi,IR=new Bi,pR=new Qt,mR=new Cs(new Qt(1,0,0),0),AR=new Qt,CR=new Qt,fR=new Bi,bR=new Ut,yR=new yt,_R=new Qt;async function vR(e,t,i){if(Hm(i.angleAndHeight)&&(i=i.angleAndHeight),oA.equals(t,e._tiltCenterMousePosition)||(e._tiltCVOffMap=!1,e._looking=!1),e._looking)return void BT(e,t,i);const n=e._scene.camera;e._tiltCVOffMap||!e.onMap()||Math.abs(n.position.z)>e._minimumPickingTerrainHeight?(e._tiltCVOffMap=!0,function(e,t,i){const n=e._scene,s=n.camera,o=n.canvas,r=gR;r.x=o.clientWidth/2,r.y=o.clientHeight/2;const a=s.getPickRay(r,cR),l=jm.UNIT_X,g=a.origin,c=a.direction;let d;const h=jm.dot(l,c);Math.abs(h)>Km.EPSILON6&&(d=-jm.dot(l,g)/h);if(!Hm(d)||d<=0)return e._looking=!0,BT(e,t,i),void oA.clone(t,e._tiltCenterMousePosition);const u=jm.multiplyByScalar(c,d,dR);jm.add(g,u,u);const I=n.mapProjection,p=I.ellipsoid;jm.fromElements(u.y,u.z,u.x,u);const m=I.unproject(u,CR);p.cartographicToCartesian(m,u);const A=bA.eastNorthUpToFixedFrame(u,p,uR),C=e._globe,f=e._ellipsoid;e._globe=void 0,e._ellipsoid=eA.UNIT_SPHERE,e._rotateFactor=1,e._rotateRateRangeAdjustment=1;const b=aA.clone(s.transform,fR);s._setTransform(A),LR(e,t,i,jm.UNIT_Z),s._setTransform(b),e._globe=C,e._ellipsoid=f;const y=f.maximumRadius;e._rotateFactor=1/y,e._rotateRateRangeAdjustment=y}(e,t,i)):await async function(e,t,i){const n=e._scene,s=n.camera,o=e._cameraUnderground,r=n.mapProjection;let a,l;const g=jm.UNIT_X;if(oA.equals(t,e._tiltCenterMousePosition))a=jm.clone(e._tiltCenter,dR);else{if(s.position.z<e._minimumPickingTerrainHeight&&(a=await YM(e,t,dR)),!Hm(a)){l=s.getPickRay(t,cR);const n=l.origin,o=l.direction;let r;const c=jm.dot(g,o);if(Math.abs(c)>Km.EPSILON6&&(r=-jm.dot(g,n)/c),!Hm(r)||r<=0)return e._looking=!0,BT(e,t,i),void oA.clone(t,e._tiltCenterMousePosition);a=jm.multiplyByScalar(o,r,dR),jm.add(n,a,a)}o&&(Hm(l)||(l=s.getPickRay(t,cR)),QM(e,l,a,a)),oA.clone(t,e._tiltCenterMousePosition),jm.clone(a,e._tiltCenter)}const c=n.canvas,d=gR;d.x=c.clientWidth/2,d.y=e._tiltCenterMousePosition.y,l=s.getPickRay(d,cR);const h=jm.clone(jm.ZERO,pR);h.x=a.x;const u=G_.fromPointNormal(h,g,mR),I=YA.rayPlane(l,u,hR),p=r.ellipsoid;jm.fromElements(a.y,a.z,a.x,a);let m=r.unproject(a,CR);p.cartographicToCartesian(m,a);const A=bA.eastNorthUpToFixedFrame(a,p,uR);let C;Hm(I)?(jm.fromElements(I.y,I.z,I.x,I),m=r.unproject(I,CR),p.cartographicToCartesian(m,I),C=bA.eastNorthUpToFixedFrame(I,p,IR)):C=A;const f=e._globe,b=e._ellipsoid;e._globe=void 0,e._ellipsoid=eA.UNIT_SPHERE,e._rotateFactor=1,e._rotateRateRangeAdjustment=1;let y=jm.UNIT_Z;const _=aA.clone(s.transform,fR);s._setTransform(A);const v=jm.cross(jm.UNIT_Z,jm.normalize(s.position,AR),AR),x=jm.dot(s.right,v);if(LR(e,t,i,y,!1,!0),s._setTransform(C),x<0){const n=i.startPosition.y-i.endPosition.y;(o&&n<0||!o&&n>0)&&(y=void 0);const r=s.constrainedAxis;s.constrainedAxis=void 0,LR(e,t,i,y,!0,!1),s.constrainedAxis=r}else LR(e,t,i,y,!0,!1);if(Hm(s.constrainedAxis)){const e=jm.cross(s.direction,s.constrainedAxis,_R);jm.equalsEpsilon(e,jm.ZERO,Km.EPSILON6)||(jm.dot(e,s.right)<0&&jm.negate(e,e),jm.cross(e,s.direction,s.up),jm.cross(s.direction,s.up,s.right),jm.normalize(s.up,s.up),jm.normalize(s.right,s.right))}s._setTransform(_),e._globe=f,e._ellipsoid=b;const B=b.maximumRadius;e._rotateFactor=1/B,e._rotateRateRangeAdjustment=B;const w=jm.clone(s.positionWC,AR);e.enableCollisionDetection&&GT(e,!0);if(!jm.equals(s.positionWC,w)){s._setTransform(C),s.worldToCameraCoordinatesPoint(w,w);const e=jm.magnitudeSquared(w);jm.magnitudeSquared(s.position)>e&&(jm.normalize(s.position,s.position),jm.multiplyByScalar(s.position,Math.sqrt(e),s.position));const t=jm.angleBetween(w,s.position),i=jm.cross(w,s.position,w);jm.normalize(i,i);const n=uA.fromAxisAngle(i,t,bR),o=rA.fromQuaternion(n,yR);rA.multiplyByVector(o,s.direction,s.direction),rA.multiplyByVector(o,s.up,s.up),jm.cross(s.direction,s.up,s.right),jm.cross(s.right,s.direction,s.up),s._setTransform(_)}}(e,t,i)}const xR=new bt,BR=new xi,wR=new Qt;async function SR(e,t,i){Hm(i.distance)&&(i=i.distance);const n=e._scene,s=n.camera,o=n.canvas,r=e._cameraUnderground;let a;r?a=t:(a=xR,a.x=o.clientWidth/2,a.y=o.clientHeight/2);const l=s.getPickRay(a,BR),g=l.origin,c=l.direction;let d,h;if(s.position.z<e._minimumPickingTerrainHeight&&(d=await YM(e,a,wR)),Hm(d)&&(h=jm.distance(g,d)),r){const t=UM(e,l);h=Hm(h)?Math.min(h,t):t}if(!Hm(h)){const e=jm.UNIT_X;h=-jm.dot(e,g)/jm.dot(e,c)}await FM(e,t,i,e._zoomFactor,h)}const GR=new xi,MR=new Cs(new Qt(1,0,0),0),RR=new Qt,TR=new Qt;function ZR(e,t,i){const n=e._scene,s=n.camera,o=s.getPickRay(t.endPosition,GR);let r=jm.clone(s.direction,TR);n.mode===bC.COLUMBUS_VIEW&&jm.fromElements(r.z,r.x,r.y,r);const a=G_.fromPointNormal(i,r,MR),l=YA.rayPlane(o,a,RR);Hm(l)&&(r=jm.subtract(i,l,r),n.mode===bC.COLUMBUS_VIEW&&jm.fromElements(r.y,r.z,r.x,r),jm.add(s.position,r,s.position))}const VR=new Qt,WR=new Qt,ER=new Qt,NR=new eA,FR=new Qt,XR=new Qt,HR=new Qt;async function zR(e,t,i){const n=e._scene.camera,s=e._cameraUnderground;let o,r,a=e._ellipsoid;if(!aA.equals(n.transform,aA.IDENTITY))return void LR(e,t,i);const l=a.geodeticSurfaceNormal(n.position,FR);if(oA.equals(t,e._rotateMousePosition)){if(e._looking)BT(e,t,i,l);else if(e._rotating)LR(e,t,i);else if(e._strafing)qM(e,i);else{if(jm.magnitude(n.position)<jm.magnitude(e._rotateStartPosition))return;o=jm.magnitude(e._rotateStartPosition),r=ER,r.x=r.y=r.z=o,a=eA.fromCartesian3(r,NR),await tT(e,t,i,a)}return}e._looking=!1,e._rotating=!1,e._strafing=!1;const g=a.cartesianToCartographic(n.positionWC,WR).z;if(Hm(e._globe)&&g<e._minimumPickingTerrainHeight){const g=await YM(e,i.startPosition,HR);if(Hm(g)){let l=!1;const c=n.getPickRay(i.startPosition,KM);if(s)l=!0,JM(e,c,g,g);else{const e=a.geodeticSurfaceNormal(g,XR);l=!!(Math.abs(jm.dot(c.direction,e))<.05)||jm.magnitude(n.position)<jm.magnitude(g)}l?(oA.clone(t,e._strafeEndMousePosition),jm.clone(g,e._strafeStartPosition),e._strafing=!0,ZR(e,i,e._strafeStartPosition)):(o=jm.magnitude(g),r=ER,r.x=r.y=r.z=o,a=eA.fromCartesian3(r,NR),await tT(e,t,i,a),jm.clone(g,e._rotateStartPosition))}else e._looking=!0,BT(e,t,i,l)}else Hm(n.pickEllipsoid(i.startPosition,e._ellipsoid,VR))?(await tT(e,t,i,e._ellipsoid),jm.clone(VR,e._rotateStartPosition)):g>e._minimumTrackBallHeight?(e._rotating=!0,LR(e,t,i)):(e._looking=!0,BT(e,t,i,l));oA.clone(t,e._rotateMousePosition)}function LR(e,t,i,n,s,o){s=zm(s,!1),o=zm(o,!1);const r=e._scene,a=r.camera,l=r.canvas,g=a.constrainedAxis;Hm(n)&&(a.constrainedAxis=n);const c=jm.magnitude(a.position);let d=e._rotateFactor*(c-e._rotateRateRangeAdjustment);d>e._maximumRotateRate&&(d=e._maximumRotateRate),d<e._minimumRotateRate&&(d=e._minimumRotateRate);let h=(i.startPosition.x-i.endPosition.x)/l.clientWidth,u=(i.startPosition.y-i.endPosition.y)/l.clientHeight;h=Math.min(h,e.maximumMovementRatio),u=Math.min(u,e.maximumMovementRatio);const I=d*h*Math.PI*2,p=d*u*Math.PI;s||a.rotateRight(I),o||a.rotateUp(p),a.constrainedAxis=g}const DR=__.clone(__.UNIT_W),KR=__.clone(__.UNIT_W),YR=new Qt,PR=new Qt,kR=new Qt,OR=new Qt,UR=new Qt,QR=new Qt,JR=new bt,jR=new bt,qR=new bt,$R=new bt,eT=new xi;async function tT(e,t,i,n){const s=e._scene,o=s.camera,r=oA.clone(i.startPosition,JR),a=oA.clone(i.endPosition,jR),l=n.cartesianToCartographic(o.positionWC,WR).z;let g,c;if(!i.inertiaEnabled&&l<e._minimumPickingTerrainHeight&&(g=jm.clone(e._panLastWorldPosition,DR),Hm(e._globe)||oA.equalsEpsilon(r,e._panLastMousePosition)||(g=await YM(e,r,DR)),!Hm(e._globe)&&Hm(g))){const t=jm.subtract(g,o.positionWC,OR),i=jm.multiplyByScalar(o.directionWC,jm.dot(o.directionWC,t),OR),n=jm.magnitude(i),l=o.frustum.getPixelDimensions(s.drawingBufferWidth,s.drawingBufferHeight,n,s.pixelRatio,$R),d=oA.subtract(a,r,qR),h=jm.multiplyByScalar(o.rightWC,d.x*l.x,OR),u=jm.normalize(o.positionWC,bM),I=o.getPickRay(a,eT).direction,p=jm.subtract(I,jm.projectVector(I,o.rightWC,UR),UR),m=jm.angleBetween(p,o.directionWC);let A=1;Hm(o.frustum.fov)&&(A=Math.max(Math.tan(m),.1));let C=Math.abs(jm.dot(o.directionWC,u));const f=-d.y*l.y*2/Math.sqrt(A)*(1-C),b=jm.multiplyByScalar(I,f,UR);C=Math.abs(jm.dot(o.upWC,u));const y=jm.multiplyByScalar(o.upWC,-d.y*(1-C)*l.y,QR);c=jm.add(g,h,KR),c=jm.add(c,b,c),c=jm.add(c,y,c),jm.clone(c,e._panLastWorldPosition),oA.clone(a,e._panLastMousePosition)}if(Hm(g)&&Hm(c)||(g=o.pickEllipsoid(r,n,DR),c=o.pickEllipsoid(a,n,KR)),g&&(g.w=1),c&&(c.w=1),!Hm(g)||!Hm(c))return e._rotating=!0,void LR(e,0,i);if(g=o.worldToCameraCoordinates(g,g),c=o.worldToCameraCoordinates(c,c),g=jm.fromCartesian4(g,YR),c=jm.fromCartesian4(c,PR),Hm(o.constrainedAxis)){const e=o.constrainedAxis,t=jm.mostOrthogonalAxis(e,kR);jm.cross(t,e,t),jm.normalize(t,t);const i=jm.cross(e,t,OR),n=jm.magnitude(g),s=jm.dot(e,g),r=Math.acos(s/n),a=jm.multiplyByScalar(e,s,UR);jm.subtract(g,a,a),jm.normalize(a,a);const l=jm.magnitude(c),d=jm.dot(e,c),h=Math.acos(d/l),u=jm.multiplyByScalar(e,d,QR);jm.subtract(c,u,u),jm.normalize(u,u);let I=Math.acos(jm.dot(a,t));jm.dot(a,i)<0&&(I=Km.TWO_PI-I);let p=Math.acos(jm.dot(u,t));jm.dot(u,i)<0&&(p=Km.TWO_PI-p);const m=I-p;let A;A=jm.equalsEpsilon(e,o.position,Km.EPSILON2)?o.right:jm.cross(e,o.position,kR);const C=jm.cross(e,A,kR),f=jm.dot(C,jm.subtract(g,e,OR)),b=jm.dot(C,jm.subtract(c,e,OR));let y;y=f>0&&b>0?h-r:f>0&&b<=0?jm.dot(o.position,e)>0?-r-h:r+h:r-h,o.rotateRight(m),o.rotateUp(y)}else{jm.normalize(g,g),jm.normalize(c,c);const e=jm.dot(g,c),t=jm.cross(g,c,kR);if(e<1&&!jm.equalsEpsilon(t,jm.ZERO,Km.EPSILON14)){const i=Math.acos(e);o.rotate(t,i)}}}const iT=new Qt,nT=new Qt;let sT=0;async function oT(e,t,i){Hm(i.distance)&&(i=i.distance);const n=i.inertiaEnabled,s=e._ellipsoid,o=e._scene,r=o.camera,a=o.canvas,l=e._cameraUnderground;let g;l?g=t:(g=xR,g.x=a.clientWidth/2,g.y=a.clientHeight/2);const c=r.getPickRay(g,BR);let d;const h=s.cartesianToCartographic(r.position,nT).z,u=Math.abs(sT)<e.minimumPickingTerrainDistanceWithInertia;let I;if((n?u:h<e._minimumPickingTerrainHeight)&&(d=await YM(e,g,wR)),Hm(d)&&(I=jm.distance(c.origin,d),sT=I),l){const t=UM(e,c);I=Hm(I)?Math.min(I,t):t}Hm(I)||(I=h);const p=jm.normalize(r.position,iT);await FM(e,t,i,e._zoomFactor,I,jm.dot(p,r.direction))}const rT=new bt,aT=new xi,lT=new Qt,gT=new Qt,cT=new Bi,dT=new Bi,hT=new Bi,uT=new Ut,IT=new yt,pT=new Qt,mT=new Qt;async function AT(e,t,i){const n=e._scene.camera;if(!aA.equals(n.transform,aA.IDENTITY))return;if(Hm(i.angleAndHeight)&&(i=i.angleAndHeight),oA.equals(t,e._tiltCenterMousePosition)||(e._tiltOnEllipsoid=!1,e._looking=!1),e._looking){const s=e._ellipsoid.geodeticSurfaceNormal(n.position,mT);return void BT(e,t,i,s)}const s=e._ellipsoid.cartesianToCartographic(n.position,pT);e._tiltOnEllipsoid||s.z>e._minimumCollisionTerrainHeight?(e._tiltOnEllipsoid=!0,function(e,t,i){const n=e._ellipsoid,s=e._scene,o=s.camera,r=.25*e.minimumZoomDistance,a=n.cartesianToCartographic(o.positionWC,CT).z;if(a-r-1<Km.EPSILON3&&i.endPosition.y-i.startPosition.y<0)return;const l=s.canvas,g=rT;g.x=l.clientWidth/2,g.y=l.clientHeight/2;const c=o.getPickRay(g,aT);let d;const h=YA.rayEllipsoid(c,n);if(Hm(h))d=fC.getPoint(c,h.start,lT);else{if(!(a>e._minimumTrackBallHeight)){e._looking=!0;const n=e._ellipsoid.geodeticSurfaceNormal(o.position,mT);return BT(e,t,i,n),void oA.clone(t,e._tiltCenterMousePosition)}{const e=YA.grazingAltitudeLocation(c,n);if(!Hm(e))return;const t=n.cartesianToCartographic(e,pT);t.z=0,d=n.cartographicToCartesian(t,lT)}}const u=bA.eastNorthUpToFixedFrame(d,n,cT),I=e._globe,p=e._ellipsoid;e._globe=void 0,e._ellipsoid=eA.UNIT_SPHERE,e._rotateFactor=1,e._rotateRateRangeAdjustment=1;const m=aA.clone(o.transform,hT);o._setTransform(u),LR(e,0,i,jm.UNIT_Z),o._setTransform(m),e._globe=I,e._ellipsoid=p;const A=p.maximumRadius;e._rotateFactor=1/A,e._rotateRateRangeAdjustment=A}(e,t,i)):await async function(e,t,i){const n=e._ellipsoid,s=e._scene,o=s.camera,r=e._cameraUnderground;let a,l,g;if(oA.equals(t,e._tiltCenterMousePosition))a=jm.clone(e._tiltCenter,lT);else{if(a=await YM(e,t,lT),!Hm(a)){if(l=o.getPickRay(t,aT),g=YA.rayEllipsoid(l,n),!Hm(g)){if(n.cartesianToCartographic(o.position,pT).z<=e._minimumTrackBallHeight){e._looking=!0;const n=e._ellipsoid.geodeticSurfaceNormal(o.position,mT);BT(e,t,i,n),oA.clone(t,e._tiltCenterMousePosition)}return}a=fC.getPoint(l,g.start,lT)}r&&(Hm(l)||(l=o.getPickRay(t,aT)),QM(e,l,a,a)),oA.clone(t,e._tiltCenterMousePosition),jm.clone(a,e._tiltCenter)}const c=s.canvas,d=rT;d.x=c.clientWidth/2,d.y=e._tiltCenterMousePosition.y,l=o.getPickRay(d,aT);const h=jm.magnitude(a),u=jm.fromElements(h,h,h,ER),I=eA.fromCartesian3(u,NR);if(g=YA.rayEllipsoid(l,I),!Hm(g))return;const p=jm.magnitude(l.origin)>h?g.start:g.stop,m=fC.getPoint(l,p,gT),A=bA.eastNorthUpToFixedFrame(a,n,cT),C=bA.eastNorthUpToFixedFrame(m,I,dT),f=e._globe,b=e._ellipsoid;e._globe=void 0,e._ellipsoid=eA.UNIT_SPHERE,e._rotateFactor=1,e._rotateRateRangeAdjustment=1;let y=jm.UNIT_Z;const _=aA.clone(o.transform,hT);o._setTransform(C);const v=jm.cross(m,o.positionWC,_R),x=jm.dot(o.rightWC,v);if(x<0){const t=i.startPosition.y-i.endPosition.y;(r&&t<0||!r&&t>0)&&(y=void 0);const n=o.constrainedAxis;o.constrainedAxis=void 0,LR(e,0,i,y,!0,!1),o.constrainedAxis=n}else LR(e,0,i,y,!0,!1);if(o._setTransform(A),LR(e,0,i,y,!1,!0),Hm(o.constrainedAxis)){const e=jm.cross(o.direction,o.constrainedAxis,_R);jm.equalsEpsilon(e,jm.ZERO,Km.EPSILON6)||(jm.dot(e,o.right)<0&&jm.negate(e,e),jm.cross(e,o.direction,o.up),jm.cross(o.direction,o.up,o.right),jm.normalize(o.up,o.up),jm.normalize(o.right,o.right))}o._setTransform(_),e._globe=f,e._ellipsoid=b;const B=b.maximumRadius;e._rotateFactor=1/B,e._rotateRateRangeAdjustment=B;const w=jm.clone(o.positionWC,_R);e.enableCollisionDetection&&GT(e,!0);if(!jm.equals(o.positionWC,w)){o._setTransform(C),o.worldToCameraCoordinatesPoint(w,w);const e=jm.magnitudeSquared(w);jm.magnitudeSquared(o.position)>e&&(jm.normalize(o.position,o.position),jm.multiplyByScalar(o.position,Math.sqrt(e),o.position));const t=jm.angleBetween(w,o.position),i=jm.cross(w,o.position,w);jm.normalize(i,i);const n=uA.fromAxisAngle(i,t,uT),s=rA.fromQuaternion(n,IT);rA.multiplyByVector(s,o.direction,o.direction),rA.multiplyByVector(s,o.up,o.up),jm.cross(o.direction,o.up,o.right),jm.cross(o.right,o.direction,o.up),o._setTransform(_)}}(e,t,i)}const CT=new Qt;const fT=new bt,bT=new bt,yT=new xi,_T=new xi,vT=new Qt,xT=new Qt;function BT(e,t,i,n){const s=e._scene.camera,o=fT;o.x=i.startPosition.x,o.y=0;const r=bT;r.x=i.endPosition.x,r.y=0;let a,l,g=s.getPickRay(o,yT),c=s.getPickRay(r,_T),d=0;a=g.direction,l=c.direction;let h=jm.dot(a,l);h<1&&(d=Math.acos(h)),d=i.startPosition.x>i.endPosition.x?-d:d;const u=e._horizontalRotationAxis;if(Hm(n)?s.look(n,-d):Hm(u)?s.look(u,-d):s.lookLeft(d),o.x=0,o.y=i.startPosition.y,r.x=0,r.y=i.endPosition.y,g=s.getPickRay(o,yT),c=s.getPickRay(r,_T),d=0,a=g.direction,l=c.direction,h=jm.dot(a,l),h<1&&(d=Math.acos(h)),d=i.startPosition.y>i.endPosition.y?-d:d,Hm(n=zm(n,u))){const e=s.direction,t=jm.negate(n,vT),i=jm.equalsEpsilon(e,n,Km.EPSILON2),o=jm.equalsEpsilon(e,t,Km.EPSILON2);if(i||o)(i&&d<0||o&&d>0)&&s.look(s.right,-d);else{h=jm.dot(e,n);let i=Km.acosClamped(h);d>0&&d>i&&(d=i-Km.EPSILON4),h=jm.dot(e,t),i=Km.acosClamped(h),d<0&&-d>i&&(d=-i+Km.EPSILON4);const o=jm.cross(n,e,xT);s.look(o,d)}}else s.lookUp(d)}const wT=new Bi,ST=new Qt;function GT(e,t){e._adjustedHeightForTerrain=!0;const i=e._scene,n=i.mode,s=i.globe;if(!Hm(s)||n===bC.SCENE2D||n===bC.MORPHING)return;const o=i.camera,r=s.ellipsoid,a=i.mapProjection;let l,g;aA.equals(o.transform,aA.IDENTITY)||(l=aA.clone(o.transform,wT),g=jm.magnitude(o.position),o._setTransform(aA.IDENTITY));const c=ST;n===bC.SCENE3D?r.cartesianToCartographic(o.position,c):a.unproject(o.position,c);let d=!1;if(c.z<e._minimumCollisionTerrainHeight){const i=zm(e._scene.globeHeight,0);if(Hm(i)){const s=i+e.minimumZoomDistance,l=i-e._lastGlobeHeight,g=l/e._lastGlobeHeight;c.z<s&&(t||Math.abs(g)<=.1)&&(c.z=s,n===bC.SCENE3D?r.cartographicToCartesian(c,o.position):a.project(c,o.position),d=!0),t||Math.abs(g)<=.1?e._lastGlobeHeight=i:e._lastGlobeHeight+=.1*l}}Hm(l)&&(o._setTransform(l),d&&(jm.normalize(o.position,o.position),jm.negate(o.position,o.direction),jm.multiplyByScalar(o.position,Math.max(g,e.minimumZoomDistance),o.position),jm.normalize(o.direction,o.direction),jm.cross(o.direction,o.up,o.right),jm.cross(o.right,o.direction,o.up)))}const MT=new Qt,RT=new Qt,TT=new Qt,ZT=new xi;function VT(e){const t=e._scene;e.enableTerrainCollision&&(t.globeHeight=function(e){const t=e._scene;if(t.mode===bC.MORPHING)return;const i=t.camera.positionCartographic;if(!Hm(i))return;let n=Number.NEGATIVE_INFINITY;if(Hm(t.globe)){const s=t.mapProjection.ellipsoid,o=jm.fromRadians(i.x,i.y,0,s,MT),r=ZT;s.geodeticSurfaceNormal(o,r.direction),s.getSurfaceNormalIntersectionWithZAxis(o,111500,r.origin);const a=7e6;r.origin.add(r.direction.clone().multiplyScalar(a)),r.direction.negate(),e._cameraUnderground;let l=t.rendering.picking.pickTerrainWorldPosition(r);if(!Hm(l)){let e=YA.rayEllipsoid(r,s);if(Hm(e)){let t=e.start>0?e.start:e.stop;l=fC.getPoint(r,t,RT)}}Hm(l)&&(n=s.cartesianToCartographic(l,TT).z)}return n>Number.NEGATIVE_INFINITY?n:void 0}(e)),t.cameraUnderground=function(e){const t=e._scene,i=t.camera,n=t.mode,s=i.positionCartographic;if(!Hm(s))return!1;if(!e.onMap()&&s.z<0)return!0;if(n===bC.SCENE2D||n===bC.MORPHING)return!1;const o=zm(t.globeHeight,0);return Hm(o)&&s.z<o}(e)}oM.prototype.onMap=function(){const e=this._scene,t=e.mode,i=e.camera;return t!==bC.COLUMBUS_VIEW||Math.abs(i.position.x)-this._maxCoord.x<0&&Math.abs(i.position.y)-this._maxCoord.y<0};const WT=new Qt,ET=new Qt;function NT(e,t){this._ellipsoid=e,this._cameraPosition=new Qt,this._cameraPositionInScaledSpace=new Qt,this._distanceToLimbInScaledSpaceSquared=0,Hm(t)&&(this.cameraPosition=t)}oM.prototype.update=function(){const e=this._scene,t=e.camera,i=e.globe,n=e.mode;VT(this),aA.equals(t.transform,aA.IDENTITY)?(this._globe=i,this._ellipsoid=Hm(this._globe)?this._globe.ellipsoid:e.mapProjection.ellipsoid):(this._globe=void 0,this._ellipsoid=eA.UNIT_SPHERE);const s=Hm(this._globe)&&Hm(this._globe.terrainExaggeration)?this._globe.terrainExaggeration:1,o=Hm(this._globe)&&Hm(this._globe.terrainExaggerationRelativeHeight)?this._globe.terrainExaggerationRelativeHeight:0;if(this._minimumCollisionTerrainHeight=UG.getHeight(this.minimumCollisionTerrainHeight,s,o),this._minimumPickingTerrainHeight=UG.getHeight(this.minimumPickingTerrainHeight,s,o),this._minimumTrackBallHeight=UG.getHeight(this.minimumTrackBallHeight,s,o),this._cameraUnderground=e.cameraUnderground&&Hm(this._globe),this._ellipsoid){const e=this._ellipsoid.maximumRadius;this._rotateFactor=1/e,this._rotateRateRangeAdjustment=e}this._adjustedHeightForTerrain=!1;const r=jm.clone(t.positionWC,WT),a=jm.clone(t.directionWC,ET);var l;if(n===bC.SCENE2D?(l=this,aA.equals(aA.IDENTITY,l._scene.camera.transform)?(cM(l,l.enableTranslate,l.translateEventTypes,LM,l.inertiaTranslate,"_lastInertiaTranslateMovement"),cM(l,l.enableZoom,l.zoomEventTypes,DM,l.inertiaZoom,"_lastInertiaZoomMovement")):cM(l,l.enableZoom,l.zoomEventTypes,DM,l.inertiaZoom,"_lastInertiaZoomMovement")):n===bC.COLUMBUS_VIEW?(this._horizontalRotationAxis=jm.UNIT_Z,function(e){const t=e._scene.camera;aA.equals(aA.IDENTITY,t.transform)?(cM(e,e.enableTilt,e.tiltEventTypes,vR,e.inertiaSpin,"_lastInertiaTiltMovement"),cM(e,e.enableTranslate,e.translateEventTypes,lR,e.inertiaTranslate,"_lastInertiaTranslateMovement"),cM(e,e.enableZoom,e.zoomEventTypes,SR,e.inertiaZoom,"_lastInertiaZoomMovement"),cM(e,e.enableLook,e.lookEventTypes,BT)):(cM(e,e.enableRotate,e.rotateEventTypes,LR,e.inertiaSpin,"_lastInertiaSpinMovement"),cM(e,e.enableZoom,e.zoomEventTypes,oT,e.inertiaZoom,"_lastInertiaZoomMovement"))}(this)):n===bC.SCENE3D&&(this._horizontalRotationAxis=void 0,function(e){cM(e,e.enableRotate,e.rotateEventTypes,zR,e.inertiaSpin,"_lastInertiaSpinMovement"),cM(e,e.enableZoom,e.zoomEventTypes,oT,e.inertiaZoom,"_lastInertiaZoomMovement"),cM(e,e.enableTilt,e.tiltEventTypes,AT,e.inertiaSpin,"_lastInertiaTiltMovement"),cM(e,e.enableLook,e.lookEventTypes,BT)}(this)),this.enableCollisionDetection&&!this._adjustedHeightForTerrain){GT(this,!jm.equals(r,t.positionWC)||!jm.equals(a,t.directionWC))}this._aggregator.reset()},oM.prototype.isDestroyed=function(){return!1},oM.prototype.destroy=function(){return this._aggregator=this._aggregator&&this._aggregator.destroy(),tG(this)},Object.defineProperties(NT.prototype,{ellipsoid:{get:function(){return this._ellipsoid}},cameraPosition:{get:function(){return this._cameraPosition},set:function(e){const t=this._ellipsoid.transformPositionToScaledSpace(e,this._cameraPositionInScaledSpace),i=jm.magnitudeSquared(t)-1;jm.clone(e,this._cameraPosition),this._cameraPositionInScaledSpace=t,this._distanceToLimbInScaledSpaceSquared=i}}});const FT=new Qt;NT.prototype.isPointVisible=function(e){return kT(this._ellipsoid.transformPositionToScaledSpace(e,FT),this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)},NT.prototype.isScaledSpacePointVisible=function(e){return kT(e,this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)};const XT=new jm;NT.prototype.isScaledSpacePointVisiblePossiblyUnderEllipsoid=function(e,t){const i=this._ellipsoid;let n,s;return Hm(t)&&t<0&&i.minimumRadius>-t?(s=XT,s.x=this._cameraPosition.x/(i.radii.x+t),s.y=this._cameraPosition.y/(i.radii.y+t),s.z=this._cameraPosition.z/(i.radii.z+t),n=s.x*s.x+s.y*s.y+s.z*s.z-1):(s=this._cameraPositionInScaledSpace,n=this._distanceToLimbInScaledSpaceSquared),kT(e,s,n)},NT.prototype.computeHorizonCullingPoint=function(e,t,i){return KT(this._ellipsoid,e,t,i)};const HT=eA.clone(eA.UNIT_SPHERE);NT.prototype.computeHorizonCullingPointPossiblyUnderEllipsoid=function(e,t,i,n){return KT(DT(this._ellipsoid,i,HT),e,t,n)},NT.prototype.computeHorizonCullingPointFromVertices=function(e,t,i,n,s){return PT(this._ellipsoid,e,t,i,n,s)},NT.prototype.computeHorizonCullingPointFromVerticesPossiblyUnderEllipsoid=function(e,t,i,n,s,o){return PT(DT(this._ellipsoid,s,HT),e,t,i,n,o)};const zT=[];NT.prototype.computeHorizonCullingPointFromRectangle=function(e,t,i){const n=IA.subsample(e,t,0,zT),s=new mi;if(s.setFromPoints(n),!(jm.magnitude(s.center)<.1*t.minimumRadius))return this.computeHorizonCullingPoint(s.center,n,i)};const LT=new Qt;function DT(e,t,i){if(Hm(t)&&t<0&&e.minimumRadius>-t){const n=jm.fromElements(e.radii.x+t,e.radii.y+t,e.radii.z+t,LT);e=eA.fromCartesian3(n,i)}return e}function KT(e,t,i,n){Hm(n)||(n=new Qt);const s=qT(e,t);let o=0;for(let r=0,a=i.length;r<a;++r){const t=QT(e,i[r],s);if(t<0)return;o=Math.max(o,t)}return JT(s,o,n)}const YT=new Qt;function PT(e,t,i,n,s,o){Hm(o)||(o=new Qt),n=zm(n,3),s=zm(s,jm.ZERO);const r=qT(e,t);let a=0;for(let l=0,g=i.length;l<g;l+=n){YT.x=i[l]+s.x,YT.y=i[l+1]+s.y,YT.z=i[l+2]+s.z;const t=QT(e,YT,r);if(t<0)return;a=Math.max(a,t)}return JT(r,a,o)}function kT(e,t,i){const n=t,s=i,o=jm.subtract(e,n,FT),r=-jm.dot(o,n);return!(s<0?r>0:r>s&&r*r/jm.magnitudeSquared(o)>s)}const OT=new Qt,UT=new Qt;function QT(e,t,i){const n=e.transformPositionToScaledSpace(t,OT);let s=jm.magnitudeSquared(n),o=Math.sqrt(s);const r=jm.divideByScalar(n,o,UT);s=Math.max(1,s),o=Math.max(1,o);const a=1/o;return 1/(jm.dot(r,i)*a-jm.magnitude(jm.cross(r,i,r))*(Math.sqrt(s-1)*a))}function JT(e,t,i){if(!(t<=0||t===1/0||isNaN(t)))return jm.multiplyByScalar(e,t,i)}const jT=new Qt;function qT(e,t){return jm.equals(t,jm.ZERO)?t:(e.transformPositionToScaledSpace(t,jT),jm.normalize(jT,jT))}new Qt;const $T=new Qt,eZ=new Qt;new Qt;const tZ=new Qt,iZ=new Qt,nZ=new Qt,sZ=new Qt,oZ=new Bi,rZ=new Qt,aZ=new Qt;class lZ extends pw{constructor(e,t,i){super(e,i),__publicField(this,"MERCATOR_LENGTH",20037508.3427892),__publicField(this,"projectionName","ecef"),__publicField(this,"near",.1),__publicField(this,"fov",35),__publicField(this,"_farScale",1.2),__publicField(this,"handleContextMenu",(e=>{e.preventDefault()})),__publicField(this,"handleEventPointerDown",(e=>{const t=this._engine.event,i=e.position.x,n=e.position.y;t._handlePointerDown({pixel:[i,n],event:e.event})})),__publicField(this,"handleEventPointerUp",(e=>{const t=this._engine.event,i=e.position.x,n=e.position.y;t._handlePointerUp({pixel:[i,n],event:e.event})})),__publicField(this,"handleEventClick",(e=>{const t=this._engine.event,i=e.position.x,n=e.position.y;2===e.event.button?t._handleRightClick({pixel:[i,n],event:e.event}):t._handleClick({pixel:[i,n],event:e.event})})),__publicField(this,"handleEventDblClick",(e=>{const t=this._engine.event,i=e.position.x,n=e.position.y;2===e.event.button?t._handleRightDblClick({pixel:[i,n],event:e.event}):t._handleDblClick({pixel:[i,n],event:e.event})})),__publicField(this,"handleEventMouseMove",(e=>{const t=this._engine.event,i=e.startPosition.x,n=e.startPosition.y;t._handleMouseMove({pixel:[i,n],event:e})})),__publicField(this,"handleViewChange",(()=>{this.onViewChanged&&this.onViewChanged()})),__publicField(this,"handleMapResize",(()=>{this.onResolutionChanged&&this.onResolutionChanged(this.getResolution())})),this._engine=e,this.domContainer=t,this._ellipsoid=eA.WGS84,this.mode=bC.SCENE3D,this.mapProjection=new tA(this._ellipsoid)}afterInit(){this.bindCanvas(),this.camera.matrixAutoUpdate=!1,this.handleMapResize(),Jw(this.domContainer,this.handleMapResize);const e=this._ellipsoidCamera=new Uf(this);e.frustum=this.camera,e.constrainedAxis=jm.UNIT_Z,this._globe=new qS(this._ellipsoid,this._engine),this._occluder=new NT(this._ellipsoid,this.camera.position),this._initControl()}bindCanvas(){this.domContainer.appendChild(this.canvas)}releaseCanvas(){this.domContainer.removeChild(this.canvas)}_initControl(){const e=this._controllerScene={camera:this._ellipsoidCamera,canvas:this.canvas,globe:this._globe,mode:this.mode,globeHeight:0,mapProjection:this.mapProjection,rendering:this._engine.rendering};this._controller=new oM(e),this.canvas.addEventListener("contextmenu",this.handleContextMenu),this._bindEvents()}_bindEvents(){this._controller._aggregator.onEventPointerDown=this.handleEventPointerDown,this._controller._aggregator.onEventPointerUp=this.handleEventPointerUp,this._controller._aggregator.onEventClick=this.handleEventClick,this._controller._aggregator.onEventDblClick=this.handleEventDblClick,this._controller._aggregator.onEventMouseMove=this.handleEventMouseMove}getContainerSize(){return[this.domContainer.clientWidth,this.domContainer.clientHeight]}getResolution(){return new bt(this.domContainer.clientWidth,this.domContainer.clientHeight)}getCenter(){let e=this.unprojectArrayCoordinate(this.getProjectionCenter());return jv(e)?e:eZ.toArray()}getProjectionCenter(){const[e,t]=this.getContainerSize(),i=new bt(e/2,t/2),n=this._ellipsoidCamera.pickEllipsoid(i);return n?[n.x,n.y,n.z]:[0,0,0]}getPitch(){return ft.radToDeg(this._ellipsoidCamera.pitch)+90}getHeading(){return 360-ft.radToDeg(this._ellipsoidCamera.heading)}getRoll(){return ft.radToDeg(this._ellipsoidCamera.roll)}getRange(){const e=this.getProjectionCenter();return this._ellipsoidCamera.position.distanceTo($T.set(e[0],e[1],e[2]))}getZoom(){return this.getZoomByZoomUnits(this.getZoomUnits())}getZoomUnits(){const[e,t]=this.getContainerSize();return this.getViewHeight()*Math.tan(ft.degToRad(this.fov/2))*2/t}getCameraDistance(){return this.getRange()}getZoomUnitsByZoom(e){return this.MERCATOR_LENGTH/128/Math.pow(2,e)}getZoomByZoomUnits(e){return Math.log2(this.MERCATOR_LENGTH/128/e)}getProjectionBounds(){const e=this.getProjectionCenter(),t=this._ellipsoidCamera.position.distanceTo($T.set(e[0],e[1],e[2])),[i,n]=this.getContainerSize(),s=i/n,o=ft.degToRad(this.getHeading()),r=ft.degToRad(Math.max(this.getPitch(),80)),a=Math.cos(r);let l=2*t*Math.tan(ft.degToRad(this.fov/2)),g=l*s;g=Math.abs(Math.cos(o))*g+Math.abs(Math.sin(o))*l,l=Math.abs(Math.cos(o))*l+Math.abs(Math.sin(o))*g,g/=a,l/=a;const c=bA.eastNorthUpToFixedFrame($T.fromArray(e)),d=oZ.extractRotation(c);rZ.setFromMatrixColumn(d,0),aZ.setFromMatrixColumn(d,1);const h=rZ.multiplyScalar(g).add(aZ.multiplyScalar(l)),u=new Qt,I=new Qt;return u.fromArray(e).sub(h),I.fromArray(e).add(h),new qt(u,I)}getBounds(){const e=this.getProjectionBounds(),t=this.unprojectArrayCoordinate([e.min.x,e.min.y,e.min.z]),i=this.unprojectArrayCoordinate([e.max.x,e.max.y,e.max.z]);return new qt(new Qt(t[0],t[1],t[2]),new Qt(i[0],i[1],i[2]))}setCenter(e){this.setProjectionCenter(e)}setProjectionCenter(e){this.setView(e,{heading:this.getHeading(),pitch:this.getPitch(),roll:this.getRoll()})}setHeading(e){const t=this.getProjectionCenter(),i=this._ellipsoidCamera.position.distanceTo($T.set(t[0],t[1],t[2]));this.unprojectArrayCoordinate(t,t),$T.fromArray(t),this.lookAt($T,{heading:e,pitch:this.getPitch(),roll:this.getRoll(),range:i})}setPitch(e){const t=this.getProjectionCenter(),i=this._ellipsoidCamera.position.distanceTo($T.set(t[0],t[1],t[2]));this.unprojectArrayCoordinate(t,t),$T.fromArray(t),this.lookAt($T,{heading:this.getHeading(),pitch:e,roll:this.getRoll(),range:i})}setZoom(e){const t=this.getProjectionCenter(),i=this._ellipsoidCamera.directionWC,n=this.getZoomUnitsByZoom(e),[s,o]=this.getContainerSize(),r=o/2*n/Math.tan(ft.degToRad(this.fov/2));$T.set(t[0],t[1],t[2]).add(i.clone().normalize().negate().multiplyScalar(.1*r)),this.unprojectArrayCoordinate($T.toArray(),t),$T.fromArray(t),this.setView($T,{heading:this.getHeading(),pitch:this.getPitch(),roll:this.getRoll()})}setRange(e){const t=this.getProjectionCenter();this.unprojectArrayCoordinate(t,t),$T.fromArray(t),this.lookAt($T,{heading:this.getHeading(),pitch:this.getPitch(),roll:this.getRoll(),range:e})}zoomIn(){const e=tZ.set(this._ellipsoidCamera.directionWC.x,this._ellipsoidCamera.directionWC.y,this._ellipsoidCamera.directionWC.z);let t=this.getRange(),i=.5*ft.clamp(t,.5,1e7);i+.2>t&&(i=t-.2);const n=this._ellipsoidCamera.positionWC;$T.set(n.x,n.y,n.z).add(e.normalize().multiplyScalar(i)),this.setView($T,{heading:this.getHeading(),pitch:this.getPitch(),roll:this.getRoll()})}zoomOut(){const e=tZ.set(this._ellipsoidCamera.directionWC.x,this._ellipsoidCamera.directionWC.y,this._ellipsoidCamera.directionWC.z);let t=this.getRange(),i=.5*ft.clamp(t,.5,1e7);i+.2>t&&(i=t-.2);const n=this._ellipsoidCamera.positionWC;$T.set(n.x,n.y,n.z).add(e.normalize().multiplyScalar(-i)),this.setView($T,{heading:this.getHeading(),pitch:this.getPitch(),roll:this.getRoll()})}updateView(){this.handleViewChange()}flyTo(e,t={}){const i=this._ellipsoidCamera;tZ.copy(i.direction),iZ.copy(i.position),nZ.copy(i.up),sZ.copy(i.right);const n=new Qt;e instanceof Array?n.set(e[0],e[1],e[2]||0):n.copy(e),n.z=n.z||0,this._ellipsoid.cartographicDegreeToCartesian(n,n),t.heading=lm(t.heading,this.getHeading()),t.pitch=lm(t.pitch,this.getPitch()),void 0!==t.heading&&(t.heading=ft.degToRad(360-t.heading)),void 0!==t.pitch&&(t.pitch=ft.degToRad(t.pitch-90)),i.lookAt(n,t);const s={destination:i.position.clone(),orientation:{heading:t.heading,pitch:t.pitch,roll:t.roll},duration:t.duration,complete:t.complete};i.position.copy(iZ),i.direction.copy(tZ),i.up.copy(nZ),i.right.copy(sZ),i.flyTo(s),this.updateView()}lookAt(e,t={}){const i=this._ellipsoidCamera,n=new Qt;e instanceof Array?n.set(e[0],e[1],e[2]||0):n.copy(e),n.z=n.z||0,this._ellipsoid.cartographicDegreeToCartesian(n,n),void 0!==t.heading&&(t.heading=ft.degToRad(360-t.heading)),t.pitch=t.pitch||.001,t.pitch=ft.degToRad(t.pitch-90),i.lookAt(n,t),this._syncFromEllipsoidCamera(),this.updateView()}setView(e,t={}){const i=this._ellipsoidCamera,n=new Qt;e instanceof Array?n.set(e[0],e[1],e[2]||100):n.copy(e),n.z=n.z||0,n.x>-180&&n.x<180&&n.y>-90&&n.y<90&&this._ellipsoid.cartographicDegreeToCartesian(n,n);const s={destination:n,orientation:t};void 0!==t.heading&&(t.heading=ft.degToRad(360-t.heading)),void 0!==t.pitch&&(t.pitch=ft.degToRad(t.pitch-90)),void 0!==t.roll&&(t.roll=ft.degToRad(t.roll)),i.setView(s),this._syncFromEllipsoidCamera(),this.updateView()}_syncFromEllipsoidCamera(){const e=this.camera,t=this._ellipsoidCamera,i=t.viewMatrix,n=t.inverseViewMatrix;e.matrixWorld.copy(n),e.matrixWorldInverse.copy(i),e.matrixWorld.decompose(e.position,e.quaternion,e.scale)}updateCamera(){this._controller.update();const e=this.camera,t=this._ellipsoidCamera,i=t.viewMatrix,n=t.inverseViewMatrix;e.matrixWorld.copy(n),e.matrixWorldInverse.copy(i),e.matrixWorld.decompose(e.position,e.quaternion,e.scale);const s=e.position.length(),o=s-this._ellipsoid._maximumRadius;let r=s;r=s<20228866?s:s*this._farScale;const[a,l]=this.getContainerSize();e.aspect=a/l,this.near=e.near=Math.min(Math.max(o/1e4,.1),50),e.near=this.near,e.far=r,e.updateProjectionMatrix()}enableControl(){this._controller.enableInputs=!0}disableControl(){this._controller.enableInputs=!1}getViewHeight(){return this._ellipsoidCamera.positionCartographic.z}getCameraLocation(e){e||(e=new Qt);const t=180*this._ellipsoidCamera.positionCartographic.x/Math.PI,i=180*this._ellipsoidCamera.positionCartographic.y/Math.PI,n=this._ellipsoidCamera.positionCartographic.z;return e.set(t,i,n),e}pickSeaLevelWorldPosition(e){return this._ellipsoidCamera.pickEllipsoid(e)}dispose(){this.releaseCanvas(),jw(this.domContainer,this.handleMapResize),this.canvas.removeEventListener("contextmenu",this.handleContextMenu)}setInputAction(e,t){this.eventHandler.setInputAction(e,t)}getInputAction(e){return this.eventHandler.getInputAction(e)}removeInputAction(e){this.eventHandler.removeInputAction(e)}get occluder(){return this._occluder}set canvas(e){this._canvas!==e&&(this._canvas=e,this._controller&&(this._controller.destroy(),this._initControl()))}get canvas(){return this._canvas}get farScale(){return this._farScale}set farScale(e){this._farScale=e}}class gZ{constructor(e){this._grid=e,this._root=null,this._tiles={},this._tilesCount=0}getTileByKey(e){if(this._tiles[e])return this._tiles[e];const[t,i,n]=e.split("-");return this._getOrCreateTile(parseInt(t,10),parseInt(i,10),parseInt(n,10))}getTile(e,t,i){const n=e+"-"+t+"-"+i;return this._tiles[n]?this._tiles[n]:this._getOrCreateTile(e,t,i)}getTileChildren(e){if(e.children)return e.children;if(e.z>=this._grid.maxLevel)return null;const t=this._grid.createTileChildren(e);return this._invokeTileCreateHook(t),e.children=t,t}_getOrCreateTile(e,t,i){return e>this._grid.maxLevel?null:this._selectOrCreateAncestralTiles(e,t,i,this.root)}isAncestralTile(e,t,i,n){const s=this._grid.getQuadTreeLevelGap(n.z,e);return t>>s===n.x&&i>>s===n.y}_selectOrCreateAncestralTiles(e,t,i,n){for(const s of n){if(s.z===e){if(s.x===t&&s.y===i)return s}else if(s.z>e)return null;if(this.isAncestralTile(e,t,i,s)){const n=this.getTileChildren(s);for(const e of n)this._tiles[e.key]=e,this._tilesCount++;return this._selectOrCreateAncestralTiles(e,t,i,n)}}return null}_invokeTileCreateHook(e){if(this.onTileCreated)for(const t of e)this.onTileCreated(t)}get root(){if(!this._root){this._root=this._grid.getRootTiles();for(const e of this._root)this._tiles[e.key]=e,this._tilesCount++;this._invokeTileCreateHook(this._root)}return this._root}}function cZ(e){this.rectangle=IA.clone(e.rectangle),this.minimumHeight=zm(e.minimumHeight,0),this.maximumHeight=zm(e.maximumHeight,0),this.southwestCornerCartesian=new Qt,this.northeastCornerCartesian=new Qt,this.westNormal=new Qt,this.southNormal=new Qt,this.eastNormal=new Qt,this.northNormal=new Qt;const t=zm(e.ellipsoid,eA.WGS84);!function(e,t,i){i.cartographicToCartesian(IA.southwest(t),e.southwestCornerCartesian),i.cartographicToCartesian(IA.northeast(t),e.northeastCornerCartesian),CZ.x=t.west,CZ.y=.5*(t.south+t.north),CZ.z=0;const n=i.cartographicToCartesian(CZ,mZ),s=jm.cross(n,jm.UNIT_Z,IZ);jm.normalize(s,e.westNormal),CZ.x=t.east;const o=i.cartographicToCartesian(CZ,AZ),r=jm.cross(jm.UNIT_Z,o,dZ);jm.normalize(r,e.eastNormal);let a=jm.subtract(n,o,dZ);0===jm.magnitude(a)&&(a=jm.clone(s,a));const l=jm.normalize(a,pZ),g=t.south;let c;if(g>0){CZ.x=.5*(t.west+t.east),CZ.y=g;const n=i.cartographicToCartesian(CZ,bZ.origin);jm.clone(l,bZ.direction);const s=G_.fromPointNormal(e.southwestCornerCartesian,e.westNormal,fZ);YA.rayPlane(bZ,s,e.southwestCornerCartesian),c=i.geodeticSurfaceNormal(n,hZ)}else c=i.geodeticSurfaceNormalCartographic(IA.southeast(t),hZ);const d=jm.cross(c,a,uZ);jm.normalize(d,e.southNormal);const h=t.north;let u;if(h<0){CZ.x=.5*(t.west+t.east),CZ.y=h;const n=i.cartographicToCartesian(CZ,bZ.origin);jm.negate(l,bZ.direction);const s=G_.fromPointNormal(e.northeastCornerCartesian,e.eastNormal,fZ);YA.rayPlane(bZ,s,e.northeastCornerCartesian),u=i.geodeticSurfaceNormal(n,hZ)}else u=i.geodeticSurfaceNormalCartographic(IA.northwest(t),hZ);const I=jm.cross(a,u,uZ);jm.normalize(I,e.northNormal)}(this,e.rectangle,t),this._orientedBoundingBox=void 0,this._boundingSphere=void 0,zm(e.computeBoundingVolumes,!0)&&this.computeBoundingVolumes(t)}Object.defineProperties(cZ.prototype,{boundingVolume:{get:function(){return this._orientedBoundingBox}},boundingSphere:{get:function(){return this._boundingSphere}}}),cZ.prototype.computeBoundingVolumes=function(e){this._orientedBoundingBox=W_.fromRectangle(this.rectangle,this.minimumHeight,this.maximumHeight,e)};const dZ=new Qt,hZ=new Qt,uZ=new Qt,IZ=new Qt,pZ=new Qt,mZ=new Qt,AZ=new Qt,CZ=new Qt,fZ=new Cs(new Qt(1,0,0),0),bZ=new xi;const yZ=new Qt,_Z=new Qt,vZ=new Qt(0,-1,0),xZ=new Qt(0,0,-1),BZ=new Qt;cZ.prototype.distanceToCamera=function(e,t,i,n){const s=function(e,t,i,n,s){const o=t,r=(s=zm(s,eA.WGS84)).cartesianToCartographic(t);let a,l,g,c=0;if(!IA.contains(e.rectangle,r)){let t=e.southwestCornerCartesian,s=e.northeastCornerCartesian,r=e.westNormal,a=e.southNormal,l=e.eastNormal,g=e.northNormal;i!==bC.SCENE3D&&(t=n.project(IA.southwest(e.rectangle),yZ),t.z=t.y,t.y=t.x,t.x=0,s=n.project(IA.northeast(e.rectangle),_Z),s.z=s.y,s.y=s.x,s.x=0,r=vZ,l=jm.UNIT_Y,a=xZ,g=jm.UNIT_Z);const d=jm.subtract(o,t,BZ),h=jm.dot(d,r),u=jm.dot(d,a),I=jm.subtract(o,s,BZ),p=jm.dot(I,l),m=jm.dot(I,g);h>0?c+=h*h:p>0&&(c+=p*p),u>0?c+=u*u:m>0&&(c+=m*m)}if(i===bC.SCENE3D?(a=r.z,l=e.minimumHeight,g=e.maximumHeight):(a=o.x,l=0,g=0),a>g){const e=a-g;c+=e*e}else if(a<l){const e=l-a;c+=e*e}return Math.sqrt(c)}(this,e,t,i,n);return s},cZ.prototype.intersectPlane=function(e){return this._orientedBoundingBox.intersectPlane(e)};class wZ{constructor(){__publicField(this,"_renderTarget",null),this._copyMesh=null}render(e,t,i,n,s){const o=this._lastOverrideMaterial,r=e.overrideMaterial;this._lastOverrideMaterial=r;let a=!this._renderTarget;o!==r&&(e.overrideMaterial=r,a=!0);const l=t.rendering.resolution,g=t.rendering.pixelRatio,c=t.rendering.features.antialias.samples;this._renderTarget&&this._renderTarget.samples!==c&&(a=!0),a&&(this._renderTarget&&this._renderTarget.dispose(),r?(this._renderTarget=new Yt(l.x*g,l.y*g,{depthBuffer:!0,stencilBuffer:!1}),this._fakeDepthTexture=new ya(new Float32Array(4),1,1,K)):this._renderTarget=new Ot(l.x*g,l.y*g,2,{depthBuffer:!0,stencilBuffer:!1}),this._renderTarget.samples=c),this._renderTarget.width===l.x*g&&this._renderTarget.height===l.y*g||this._renderTarget.setSize(l.x*g,l.y*g);const d=t.renderer,h=d.getRenderTarget(),u=d.autoClear;d.autoClear=!1,d.setRenderTarget(this._renderTarget),d.clear();const I=s.cameraOffset;e.position.set(-I.x,-I.y,-I.z),e.updateMatrix(),e.updateMatrixWorld(),d.render(e,n),e.position.set(0,0,0),e.updateMatrix(),e.updateMatrixWorld(),d.setRenderTarget(h),d.autoClear=u;const p=this.copyMesh;if(p){const e=p.material.uniforms;a&&(r?(e.tDiffuse.value=this._renderTarget.texture,e.tDepth.value=this._fakeDepthTexture):(e.tDiffuse.value=this._renderTarget.texture[0],e.tDepth.value=this._renderTarget.texture[1])),e.viewMatrix.value.copy(n.matrixWorldInverse),e.projectionMatrix.value.copy(n.projectionMatrix)}}get copyMesh(){if(!this._copyMesh){const e=new Fn;e.setAttribute("position",new Mn([-1,3,0,-1,-1,0,3,-1,0],3)),e.setAttribute("uv",new Mn([0,2,0,0,2,0],2));const t=new ls({name:"GroundSceneCopyShader",vertexShader:"\n                    varying vec2 vUv;\n                    #include <color_pars_vertex>\n                    void main() {\n                        vUv = uv;\n                        gl_Position = vec4(position, 1.0);\n                    }\n                ",fragmentShader:"\n                    #include <packing>\n                    #include <color_pars_fragment>\n                    uniform sampler2D tDiffuse;\n                    uniform sampler2D tDepth;\n                    uniform mat4 projectionMatrix;\n                    uniform float logDepthBufFC;\n                    varying vec2 vUv;\n\n                    void main() {\n                        gl_FragColor = texelFetch(tDiffuse, ivec2(gl_FragCoord.xy), 0);\n                        vec4 depthValue = texelFetch(tDepth, ivec2(gl_FragCoord.xy), 0);\n                        gl_FragDepthEXT = unpackRGBAToDepth(depthValue);\n                        // 半透明区域不写入深度，边缘由于抗锯齿会产生一些半透明区域，深度值会被写入错误值\n                        if (gl_FragColor.a < 0.99) {\n                            gl_FragDepthEXT = 1.0;\n                        }\n\n                        #include <tonemapping_fragment>\n                        #include <colorspace_fragment>\n                    }\n                ",uniforms:{tDiffuse:{value:null},tDepth:{value:null},viewMatrix:{value:new Bi},projectionMatrix:{value:new Bi}}});this._copyMesh=new ts(e,t),this._copyMesh.isFSQuad=!0,this._copyMesh.frustumCulled=!1,this._copyMesh.renderOrder=-1e6}return this._copyMesh}}class SZ{constructor(e={}){__publicField(this,"_logLoadInCurrentFrame",!1),__publicField(this,"_loadSiblings",!0)}beginFrame(){}endFrame(){this._logLoadInCurrentFrame=!1}computeTiles(e,t,i,n,s){return{selectedTiles:[],requestTilesQueue:[]}}_pushSelectedTile(e,t,i=!1){const n=t.isMeetSSE;t.isMeetSSEChanged=n!==i,t.isMeetSSE=i;t.tile._horizonFactor<.05&&(t.isMeetSSE=!1),e.push(t)}get surface(){return this._surface}}const GZ=class{constructor(){__publicField(this,"state",0)}setInFrustum(){this.state|=GZ.STATE_IN_FRUSTUM}setNotReady(){this.state|=GZ.STATE_NOT_READY}setRendered(){this.state|=GZ.STATE_RENDERED}setChildRendered(){this.state|=GZ.STATE_CHILD_RENDERED}setForceKeep(){this.state|=GZ.STATE_FORCE_KEEP}setRenderReady(){this.state|=GZ.STATE_RENDER_READY}clearInFrustum(){this.state&=~GZ.STATE_IN_FRUSTUM}clearNotReady(){this.state&=~GZ.STATE_NOT_READY}clearRendered(){this.state&=~GZ.STATE_RENDERED}clearChildRendered(){this.state&=~GZ.STATE_CHILD_RENDERED}clearForceKeep(){this.state&=~GZ.STATE_FORCE_KEEP}clearRenderReady(){this.state&=~GZ.STATE_RENDER_READY}isInFrustum(){return 0!=(this.state&GZ.STATE_IN_FRUSTUM)}isNotReady(){return 0!=(this.state&GZ.STATE_NOT_READY)}isRendered(){return 0!=(this.state&GZ.STATE_RENDERED)}isChildRendered(){return 0!=(this.state&GZ.STATE_CHILD_RENDERED)}isForceKeep(){return 0!=(this.state&GZ.STATE_FORCE_KEEP)}isRenderReady(){return 0!=(this.state&GZ.STATE_RENDER_READY)}};let MZ=GZ;function RZ(e,t){let i=!1;return e.isOrientedBoundingBox&&t.isOrientedBoundingBox?i=e.intersectsObb(t)||t.intersectsObb(e):e.isOrientedBoundingBox&&t.isBox3?i=TZ(e,t):e.isBox3&&t.isOrientedBoundingBox?i=TZ(t,e):e.isBox3&&t.isBox3&&(i=e.intersectsBox(t)),i}function TZ(e,t){const i=e.computeCorners().map((e=>({x:e.x,y:e.y,z:e.z})));for(const g of i)if(g.x>=t.min.x&&g.x<=t.max.x&&g.y>=t.min.y&&g.y<=t.max.y&&g.z>=t.min.z&&g.z<=t.max.z)return!0;const n=[new Qt(t.min.x,t.min.y,t.min.z),new Qt(t.max.x,t.min.y,t.min.z),new Qt(t.min.x,t.max.y,t.min.z),new Qt(t.max.x,t.max.y,t.min.z),new Qt(t.min.x,t.min.y,t.max.z),new Qt(t.max.x,t.min.y,t.max.z),new Qt(t.min.x,t.max.y,t.max.z),new Qt(t.max.x,t.max.y,t.max.z)];for(const g of n)if(0===e.distanceSquaredTo(g))return!0;const s=[new Qt(1,0,0),new Qt(0,1,0),new Qt(0,0,1)],o=s,r=[...s,...o];for(const g of r){const i=ZZ(e,g),n=VZ(t,g);if(l=n,(a=i).max<l.min||l.max<a.min)return!1}var a,l;return!0}function ZZ(e,t){const i=e.computeCorners();let n=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY;for(const o of i){const e=o.dot(t);n=Math.min(n,e),s=Math.max(s,e)}return{min:n,max:s}}function VZ(e,t){const i=[new Qt(e.min.x,e.min.y,e.min.z),new Qt(e.max.x,e.min.y,e.min.z),new Qt(e.min.x,e.max.y,e.min.z),new Qt(e.max.x,e.max.y,e.min.z),new Qt(e.min.x,e.min.y,e.max.z),new Qt(e.max.x,e.min.y,e.max.z),new Qt(e.min.x,e.max.y,e.max.z),new Qt(e.max.x,e.max.y,e.max.z)];let n=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY;for(const o of i){const e=o.dot(t);n=Math.min(n,e),s=Math.max(s,e)}return{min:n,max:s}}__publicField(MZ,"STATE_IN_FRUSTUM",1),__publicField(MZ,"STATE_NOT_READY",2),__publicField(MZ,"STATE_RENDERED",4),__publicField(MZ,"STATE_CHILD_RENDERED",8),__publicField(MZ,"STATE_FORCE_KEEP",16),__publicField(MZ,"STATE_RENDER_READY",32),new yg,new Cs(new Qt(0,0,1),0),new bt;const WZ=new Qt,EZ=new bt(-1,-1),NZ=new bt(1,-1);new bt(-.5,-.5),new bt(.5,-.5),new Qt;const FZ=new bt;let XZ=new Qt,HZ=new Qt,zZ=new Qt,LZ=new Qt;const DZ=new qt(new Qt(74,3,-100),new Qt(135,53,100));class KZ extends SZ{constructor(e={}){super(e),__publicField(this,"isFastTileLoaderStrategy",!0),__publicField(this,"_renderedTiles",[]),__publicField(this,"_renderedTilesMap",new Map),__publicField(this,"_viewportTilesMap",new Map),__publicField(this,"_lastViewportZLevel",0),__publicField(this,"_hysteresis",null),__publicField(this,"_showDebug",!1),__publicField(this,"_isAncestorTile",((e,t)=>{if(e.z<=t.z)return!1;return this.surface._quadtree.isAncestralTile(e.z,e.x,e.y,t)})),__publicField(this,"_preserveLastFrameChildrenTiles",((e,t)=>{const i=this._renderedTiles;let n=0;for(const s of i)if(this._isAncestorTile(s.dataTile,e)){const e=this._surfaceTileManager.getSurfaceTile(s.tile);e&&(this._pushSelectedTile(t,e,!1),n++)}return n})),__publicField(this,"_isTileRenderedInLastFrame",(e=>this._renderedTilesMap.has(e.key))),__publicField(this,"_isTileAncestorRenderedInLastFrame",(e=>{for(;e.parent;)if(e=e.parent,this._renderedTilesMap.has(e.key))return!0})),__publicField(this,"_hideChildrenTiles",((e,t,i)=>{let n,s,o=0;for(s=e.length-1;s>=0;s--)n=e[s].dataTile,this._isAncestorTile(n,i)&&(e.splice(s,1),o++);for(s=t.length-1;s>=0;s--)n=t[s],this._isAncestorTile(n,i)&&t.splice(s,1);return o})),__publicField(this,"_traverseViewportTiles",((e,t,i,n,s)=>{if(!e)return;const o=this.surface,r=o.engine,{mode:a,mapProjection:l,_ellipsoid:g}=r.map.map,c=r.map.isGlobe;for(const d of n){if(a===yC.SCENE3D&&(o.updateTileBoundingRegion(d),o._enableHorizonCulling&&o._currentOccluder&&(d._occludeePointInScaledSpace||(d._occludeePointInScaledSpace=o._computeOccludeePoint(d,o._currentOccluder)),d._occludeePointInScaledSpace&&!o._currentOccluder.isScaledSpacePointVisiblePossiblyUnderEllipsoid(d._occludeePointInScaledSpace,0))))continue;if(!o._computeTileVisibility(t,d))continue;let n=!1;if(c?d.boundingRegion&&d.boundingRegion.boundingVolume&&(n=RZ(e,d.boundingRegion.boundingVolume)):n=RZ(e,d.targetBoundingBox),n){const n=o.computeDistanceToTile(d,i,a,l,g);d._distance=n;const r=o.screenSpaceError(d)<2,c=d.z>=o._maxLevel;if(d.z>=o._minLevel&&(r||c)){s.push(d);continue}const h=o._quadtree.getTileChildren(d);h.length>0&&this._traverseViewportTiles(e,t,i,h,s)}}})),this._restrictViewportLevel=lm(e.restrictViewportLevel,!0)}beginFrame(){super.beginFrame()}initDebugMeshes(){if(!this.mesh){const e=new dl(1,32,32),t=new Cn({color:new In(16711680),transparent:!0,opacity:.9});(this.mesh=new ts(e,t)).scale.set(50,50,50);const i=new Cn({color:new In(255),transparent:!0,opacity:.9}),n=new Cn({color:new In(65280),transparent:!0,opacity:.9}),s=this.mesh1=new ts(e,i),o=this.mesh2=new ts(e,n);s.scale.set(50,50,50),o.scale.set(50,50,50)}}getViewportBounds(e){const t=[],i=e.map.getPitch();let n=this.getNdcYFactor(i);return XZ=e.rendering.picking.pickSeaLevelWorldPositionFromNdc(EZ),zZ=e.rendering.picking.pickSeaLevelWorldPositionFromNdc(NZ),FZ.set(-1,n),HZ=e.rendering.picking.pickSeaLevelWorldPositionFromNdc(FZ),FZ.set(1,n),LZ=e.rendering.picking.pickSeaLevelWorldPositionFromNdc(FZ),XZ&&zZ&&HZ&&LZ?(this._showDebug&&(this.mesh1.position.copy(HZ),this.mesh2.position.copy(LZ),this.mesh.scale.setScalar(e.map.getCameraDistance()/100),this.mesh1.scale.setScalar(e.map.getCameraDistance()/100),this.mesh2.scale.setScalar(e.map.getCameraDistance()/100)),t[0]=Math.min(XZ.x,zZ.x,HZ.x,LZ.x),t[1]=Math.min(XZ.y,zZ.y,HZ.y,LZ.y),t[2]=Math.min(XZ.z,zZ.z,HZ.z,LZ.z),t[3]=Math.max(XZ.x,zZ.x,HZ.x,LZ.x),t[4]=Math.max(XZ.y,zZ.y,HZ.y,LZ.y),t[5]=Math.max(XZ.z,zZ.z,HZ.z,LZ.z),new qt(new Qt(t[0],t[1],t[2]),new Qt(t[3],t[4],t[5]))):null}getNdcYFactor(e,t=30,i=.3){if(e<t)return 1;const n=(e-t)/(90-t),s=1-Math.tan(n*Math.PI/2)*i;return Math.max(-.2,Math.min(s,1))}computeTiles(e,t,i,n){const s=this.surface,o=[],r=[],a=[],l=[],g=this._viewportTilesMap;g.clear();const c=e.map.getProjectionCenter();WZ.set(c[0],c[1],c[2]),this._showDebug&&this.mesh.position.copy(WZ);let d=0;if(this._restrictViewportLevel){let n=this.getViewportBounds(e),o=e.map.getViewHeight()>1e6;if(!n&&o&&(n=e.map.projection.getWorldBoundingBox()),this._traverseViewportTiles(n,i,t,s._quadtree.root,l),d=this.calcViewportWeightedZLevel(l,g),o&&s.tileProvider.isBaiduProvider){let t=e.map.projection.geoBoxToProjectedBox(DZ);l.forEach((i=>{if(!i.inStrictBounds){let n=!1;e.map.isGlobe?i.boundingRegion&&i.boundingRegion.boundingVolume&&(n=RZ(t,i.boundingRegion.boundingVolume)):n=RZ(t,i.targetBoundingBox),i.inStrictBounds=n}}))}const r=.5;let a,c=lm(this._hysteresis,r);Math.abs(d-this._lastViewportZLevel)>c?this._lastViewportZLevel=d:d=this._lastViewportZLevel,d=Math.round(d);for(let e=0;e<l.length;e++)a=l[e],a.z<d&&a.inStrictBounds?a._shouldSplit=!0:a.z===d-1&&(a._shouldSplitOnce=!0)}for(const h of s._quadtree.root)this._computeIntersectTiles(i,t,h,r,o,a,d);return this._logLoadInCurrentFrame,this._renderedTiles=r,this._renderedTilesMap=new Map(r.map((e=>[e.dataTile.key,e.dataTile]))),{selectedTiles:r,requestTilesQueue:[o],placeholderTiles:a}}calcViewportWeightedZLevel(e,t){const i=this.surface,n=[];let s=0;const o=i.engine.map.isGlobe;let r;for(let l=0;l<e.length;l++){r=e[l];const s=i.projectBoundingBoxToNdc(r),a=i.reverseScreenSpaceErrorZ(r),g=s.map((([e,t])=>[Math.max(-1,Math.min(1,e)),Math.max(-1,Math.min(1,t))]));let c;if(o){const e=r.boundingRegion;if(e){const t=e.rectangle,i=Math.abs((t.east-t.west)*(Math.sin(t.north)-Math.sin(t.south))*6378137*6378137),n=this.getPolygonArea(g);c=Math.sqrt(i*n)}else c=this.getPolygonArea(g)}else c=this.getPolygonArea(g);n.push(c),t.set(r,{z:a,area:c})}const a=n.reduce(((e,t)=>e+t),0);if(a<=0)return s;for(let l=0;l<e.length;l++){r=e[l];const i=t.get(r).area/a;t.get(r).areaProportion=i,t.get(r).ratio=i*t.get(r).z}return s=e.reduce(((e,i)=>e+t.get(i).ratio),0),s}_computeIntersectTiles(e,t,i,n,s,o,r){const a=this.surface,l=a.engine,g=a._currentStatistics;g.visited+=1,this._logLoadInCurrentFrame;const c=new MZ,{mode:d,mapProjection:h,_ellipsoid:u}=l.map.map;if(d===yC.SCENE3D&&a.updateTileBoundingRegion(i),!a._computeTileVisibility(e,i))return this._logLoadInCurrentFrame,c;c.setInFrustum(),this._surfaceTileManager.markTileUsed(i),g.used++;let I=a.computeDistanceToTile(i,t,d,h,u);i._distance=I;const p=this._surfaceTileManager.isTileRenderable(i);let m=a.screenSpaceError(i)<2&&!i._shouldSplit&&!i._shouldSplitOnce,A=i.z>=a._maxLevel||i.z>=r&&r>0;if(i.z>=a._minLevel&&(A||m)){const e=this._surfaceTileManager.getSurfaceTile(i);if(p)return this._logLoadInCurrentFrame,this._pushSelectedTile(n,e,!i.overMeetSse),delete i.overMeetSse,g.rendered+=1,c.setRendered(),c.setRenderReady(),c;this._logLoadInCurrentFrame,s.push(i),o.push(i),g.request+=1,c.setNotReady();const t=this._preserveLastFrameChildrenTiles(i,n);return t>0&&(this._logLoadInCurrentFrame,g.rendered+=t,c.setForceKeep(),c.setRenderReady()),c}const C=a._quadtree.getTileChildren(i);if(i.z===a._minLevel-1&&m)for(const b of C)b.overMeetSse=!0;if(delete i._shouldSplitOnce,i._shouldSplit){delete i._shouldSplit;for(const e of C)e.z<r?e._shouldSplit=!0:delete e._shouldSplit}i.childrenInFrustum=[];let f=!0;for(const b of C){b.parent=i;let a=this._computeIntersectTiles(e,t,b,n,s,o,r);a.isInFrustum()&&(i.childrenInFrustum.push(b),a.isForceKeep()&&c.setForceKeep(),a.isRenderReady()?c.setRenderReady():f=!1,a.isRendered())}if(c.isForceKeep())return c;if(!f){let e=!1;if(this._isTileRenderedInLastFrame(i)?(e=!0,p&&(this._logLoadInCurrentFrame,this._pushSelectedTile(n,this._surfaceTileManager.getSurfaceTile(i),!1),g.rendered+=1,c.setRenderReady(),c.setRendered())):this._isTileAncestorRenderedInLastFrame(i)&&(e=!0,c.clearRenderReady()),e){const e=this._hideChildrenTiles(n,o,i);g.rendered-=e}}return c}getPolygonArea(e){let t=0;const i=e.length;for(let n=0;n<i;n++){const[s,o]=e[n],[r,a]=e[(n+1)%i];t+=s*a-r*o}return Math.abs(t)/2}set showDebug(e){if(!this.surface.engine)return;const t=this.surface.engine;this.initDebugMeshes(),e?(t.add(this.mesh1),t.add(this.mesh2),t.add(this.mesh)):(t.remove(this.mesh1),t.remove(this.mesh2),t.remove(this.mesh)),this._showDebug=e}get showDebug(){return this._showDebug}set restrictViewportLevel(e){this._restrictViewportLevel=e}get restrictViewportLevel(){return this._restrictViewportLevel}}class YZ extends SZ{constructor(){super(...arguments),__publicField(this,"isHierarchicalTileLoaderStrategy",!0),__publicField(this,"_computeHierarchicalIntersectTiles",((e,t,i,n,s,o,r,a,l)=>{const g=this.surface,c=g.engine,d=g._currentStatistics;d.visited+=1,this._logLoadInCurrentFrame;const{mode:h,mapProjection:u,_ellipsoid:I}=c.map.map;let p=g.computeDistanceToTile(i,e,h,u,I);i._distance=p,this._surfaceTileManager.isTileComputable(i);const m=this._surfaceTileManager.isTileRenderable(i),A=this._surfaceTileManager.isTileStable(i);if(!m)return this._logLoadInCurrentFrame,s.push(i),!1;d.used+=1,this._surfaceTileManager.markTileUsed(i);let C=g.screenSpaceError(i)<2;if(i.z>=g._minLevel&&(C||i.z>=g._maxLevel)){A||(s.push(i),d.request+=1,this._logLoadInCurrentFrame);const e=this._surfaceTileManager.getSurfaceTile(i,l);return n.push(e),this._logLoadInCurrentFrame,d.rendered+=1,!0}A||(this._logLoadInCurrentFrame,r.push(i));const f=g._quadtree.getTileChildren(i);if(!f||0===f.length){const e=this._surfaceTileManager.getSurfaceTile(i,l);return n.push(e),this._logLoadInCurrentFrame,d.rendered+=1,!0}let b=!0;const y=[];for(const _ of f)if(h===yC.SCENE3D&&g.updateTileBoundingRegion(_),g._computeTileVisibility(t,_))this._surfaceTileManager.isTileComputable(_)||(b=!1,this._logLoadInCurrentFrame),this._logLoadInCurrentFrame,y.push(_),this._surfaceTileManager.markTileUsed(_);else{if(this._logLoadInCurrentFrame,!this._loadSiblings)continue;this._surfaceTileManager.markTileUsed(_),d.used++,this._surfaceTileManager.isTileComputable(_)||(o.push(_),this._logLoadInCurrentFrame)}if(b){for(const i of y)this._computeHierarchicalIntersectTiles(e,t,i,n,s,o,r,a,l);this._logLoadInCurrentFrame}else{let e;this._logLoadInCurrentFrame,e=h===yC.SCENE3D?c.map.map._ellipsoidCamera.positionCartographic:c.map.unprojectArrayCoordinate(c.camera.position.toArray());let t=f;4===f.length&&(t=g._naturalOrderChildTiles(f,e)),this._logLoadInCurrentFrame,t=t.filter((e=>y.includes(e))),t.forEach((e=>{this._surfaceTileManager.isTileComputable(e)||(this._logLoadInCurrentFrame,a.push(e),d.visited+=1,d.request+=1,this._logLoadInCurrentFrame)}));const s=this._surfaceTileManager.getSurfaceTile(i,l);n.push(s),d.rendered+=1,d.unstable+=1,this._logLoadInCurrentFrame}return!0}))}computeTiles(e,t,i,n){const s=this.surface,o=[],r=[],a=[],l=[],g=[];for(const c of s._quadtree.root){this._surfaceTileManager.isTileRenderable(c)?this._computeHierarchicalIntersectTiles(t,i,c,o,a,g,l,r,n):a.push(c)}return this._logLoadInCurrentFrame,{selectedTiles:o,requestTilesQueue:[r,a,l,g],placeholderTiles:[]}}queueTileLoaded(e,t){this._surfaceTileManager.isTileNeedsLoading(e)&&t.push(e)}}const PZ=as.merge([{color:{value:[.95,.95,.95]},borderColor:{value:[.5,.5,.5]},vertexZIndex:{value:!1},isEmissive:{value:!1},depthRange:{value:new bt(0,1)},map:{value:null}}]);class kZ extends mx{constructor(e){super(),this.name="PlaceholderMaterial",this.type="PlaceholderMaterial",this.isPlaceholderMaterial=!0,this.transparent=!1,this.fragmentShader="#define GLSLIFY 1\n#include <common>\n#include <packing>\n\nvarying vec2 vUv;\nuniform vec3 color;\nuniform vec3 borderColor;\nuniform sampler2D map;\n\n#include <logdepthbuf_pars_fragment>\n#include <mvt_depth_range_pars_fragment>\n\nvoid main() {\n\n    vec4 diffuseColor = vec4(color, 1.0);\n    vec4 diffuseMap = texture2D(map, vUv);\n    if (diffuseMap.a > 0.1) {\n        diffuseMap.rgb = borderColor;\n    }\n\n    gl_FragColor.rgb = mix(diffuseColor, diffuseMap, diffuseMap.a).rgb;\n    gl_FragColor.a = 1.0;\n\n    // if (gl_FragColor.a <= 0.) {\n    //     discard;\n    // }\n\n    #include <logdepthbuf_fragment>\n    #include <tonemapping_fragment>\n    #include <colorspace_fragment>\n    \n    #include <mvt_depth_range_fragment>\n}\n\n",this.vertexShader="#define GLSLIFY 1\n#include <common>\n#include <logdepthbuf_pars_vertex>\n\nvarying vec2 vUv;\n#ifdef MVT_USE_VERTEX_ZINDEX\nattribute float layerIndex;\nvarying float vLayerIndex;\n#endif\n\nvoid main() {\n\n\tvUv = uv;\n\n    #include <begin_vertex>\n    vec4 worldPosition = modelMatrix * vec4(transformed, 1.0);\n\n    #ifdef MVT_USE_VERTEX_ZINDEX\n        vLayerIndex = layerIndex;\n    #endif\n\n    vec4 mvPosition = viewMatrix * worldPosition;\n    gl_Position = projectionMatrix * mvPosition;\n\n    #include <logdepthbuf_vertex>\n}\n\n",Object.assign(this.uniforms,as.clone(PZ)),fy(this,["isEmissive","map","depthRange"]),by(this,["color","borderColor"]),_y(this,[["vertexZIndex","MVT_USE_VERTEX_ZINDEX"],["enableDepthRange","MVT_USE_DEPTH_RANGE"]]),this.setValues(e)}}const OZ=new Qt,UZ=new Qt,QZ=new xi,JZ=new Qt,jZ=new Qt,qZ=class{constructor(e,t){this.position=e,this.position||(e=new bt),this.tangentPlane=t,this.tangentPlane||(this.tangentPlane=qZ.NORTH_POLE_TANGENT_PLANE)}getLatitude(e){e||(e=eA.WGS84),OZ.x=this.longitude,OZ.y=this.conformalLatitude,OZ.z=0;const t=this.ellipsoid.cartographicToCartesian(OZ,UZ);return e.cartesianToCartographic(t,OZ),OZ.y}static fromCartesian(e,t){const i=e.z<0?-1:1;let n=qZ.NORTH_POLE_TANGENT_PLANE,s=qZ.SOUTH_POLE;i<0&&(n=qZ.SOUTH_POLE_TANGENT_PLANE,s=qZ.NORTH_POLE);const o=QZ;o.origin=n.ellipsoid.scaleToGeocentricSurface(e,o.origin),o.direction=jm.subtract(o.origin,s,JZ),jm.normalize(o.direction,o.direction);const r=YA.rayPlane(o,n.plane,jZ),a=jm.subtract(r,s,r),l=jm.dot(n.xAxis,a),g=i*jm.dot(n.yAxis,a);return t?(t.position=new bt(l,g),t.tangentPlane=n,t):new qZ(new bt(l,g),n)}clone(e){return qZ.clone(this,e)}static clone(e,t){if(e)return t?(t.position=e.position,t.tangentPlane=e.tangentPlane,t):new qZ(e.position,e.tangentPlane)}get ellipsoid(){return this.tangentPlane.ellipsoid}get x(){return this.position.x}get y(){return this.position.y}get conformalLatitude(){const e=this.position.length(),t=2*this.ellipsoid.maximumRadius;return this.tangentPlane.plane.normal.z*(Km.PI_OVER_TWO-2*Math.atan2(e,t))}get longitude(){let e=Km.PI_OVER_TWO+Math.atan2(this.y,this.x);return e>Math.PI&&(e-=Km.TWO_PI),e}};let $Z=qZ;__publicField($Z,"HALF_UNIT_SPHERE",Object.freeze(new eA(.5,.5,.5))),__publicField($Z,"NORTH_POLE",Object.freeze(new Qt(0,0,.5))),__publicField($Z,"SOUTH_POLE",Object.freeze(new Qt(0,0,-.5))),__publicField($Z,"NORTH_POLE_TANGENT_PLANE",Object.freeze(new Z_(qZ.NORTH_POLE,qZ.HALF_UNIT_SPHERE))),__publicField($Z,"SOUTH_POLE_TANGENT_PLANE",Object.freeze(new Z_(qZ.SOUTH_POLE,qZ.HALF_UNIT_SPHERE)));const eV=new $Z,tV=new $Z,iV={northAngle:0,southAngle:0,westOverIdl:0,eastOverIdl:0},nV=new bt,sV=new bt,oV=new $Z;new bt;const rV=(e,t,i,n,s)=>{const o=e.longitude,r=o>=0?o:o+Km.TWO_PI;n.westOverIdl=Math.min(n.westOverIdl,r),n.eastOverIdl=Math.max(n.eastOverIdl,r),s.west=Math.min(s.west,o),s.east=Math.max(s.east,o);const a=e.getLatitude(i);let l=a;s.south=Math.min(s.south,a),s.north=Math.max(s.north,a);const g=oA.subtract(t.position,e.position,nV),c=oA.dot(t.position,g)/oA.dot(g,g);if(c>0&&c<1){const e=oA.add(t.position,oA.multiplyByScalar(g,-c,g),sV),n=$Z.clone(t,oV);n.position=e;const o=n.getLatitude(i);s.south=Math.min(s.south,o),s.north=Math.max(s.north,o),Math.abs(a)>Math.abs(o)&&(l=o)}const d=t.x*e.y-e.x*t.y;let h=Math.sign(d);0!==h&&(h*=oA.angleBetween(t.position,e.position)),l>=0&&(n.northAngle+=h),l<=0&&(n.southAngle+=h)},aV=(e,t,i)=>{if(i||(i=new IA),e.length<3)return i;i.west=Number.POSITIVE_INFINITY,i.east=Number.NEGATIVE_INFINITY,i.south=Number.POSITIVE_INFINITY,i.north=Number.NEGATIVE_INFINITY,iV.northAngle=0,iV.southAngle=0,iV.westOverIdl=Number.POSITIVE_INFINITY,iV.eastOverIdl=Number.NEGATIVE_INFINITY;const n=e.length;let s=$Z.fromCartesian(new Qt(...e[0]),tV);for(let o=1;o<n;o++){const n=$Z.fromCartesian(new Qt(...e[o]),eV);rV(n,s,t,iV,i),s=$Z.clone(n,s)}return rV($Z.fromCartesian(new Qt(...e[0]),eV),s,t,iV,i),i.east-i.west>iV.eastOverIdl-iV.westOverIdl&&(i.west=iV.westOverIdl,i.east=iV.eastOverIdl,i.east>Km.PI&&(i.east=i.east-Km.TWO_PI),i.west<Km.PI&&(i.west=i.west+Km.TWO_PI)),Km.equalsEpsilon(Math.abs(iV.northAngle),Km.TWO_PI,Km.EPSILON10)&&(i.north=Km.PI_OVER_TWO,i.east=Km.PI,i.west=-Km.PI),Km.equalsEpsilon(Math.abs(iV.southAngle),Km.TWO_PI,Km.EPSILON10)&&(i.south=-Km.PI_OVER_TWO,i.east=Km.PI,i.west=-Km.PI),i},lV=(e,t,i)=>{if(e.height>=Km.PI||e.width>=Km.PI)return;const n=t.map((e=>new Qt(...e))),s=((e,t)=>{let i=e[0][0],n=e[0][1],s=e[0][2],o=e[0][0],r=e[0][1],a=e[0][2];const l=e.length;for(let c=0;c<l;c++){const t=e[c],l=t[0],g=t[1],d=t[2];i=Math.min(l,i),n=Math.min(g,n),s=Math.min(d,s),o=Math.max(l,o),r=Math.max(g,r),a=Math.max(d,a)}const g=new Qt((i+o)/2,(n+r)/2,(s+a)/2);return new Z_(g,t)})(t,i);return s.projectPointsOntoPlane(n)};function gV(e){if(e.length<3)throw new Error("点的数量必须大于等于3个才能形成多边形");const t=function(e,t){t||(t=new bt);const i=e.length;let n=0,s=0;return e.forEach((e=>{n+=e.x,s+=e.y})),t.set(n/i,s/i)}(e),i=e.map(((e,i)=>({index:i,angle:Math.atan2(e.y-t.y,e.x-t.x)})));return i.sort(((e,t)=>e.angle-t.angle)),i.map((e=>e.index))}function cV(e,t,i,n,s){return e.x>=t&&e.x<=i&&e.y>=n&&e.y<=s}function dV(e,t,i){const n=[];e.forEach(((e,s)=>{if(cV(e,i[0].x,i[2].x,i[0].y,i[2].y)){const i=e.x+","+e.y+","+e.z;n[i]||(n[i]={point:e,uv:t[s]})}}));const s=Math.min(e[0].x,Math.min(e[1].x,e[2].x)),o=Math.max(e[0].x,Math.max(e[1].x,e[2].x)),r=Math.min(e[0].y,Math.min(e[1].y,e[2].y)),a=Math.max(e[0].y,Math.max(e[1].y,e[2].y)),l=Math.min(t[0].x,Math.min(t[1].x,t[2].x)),g=Math.max(t[0].x,Math.max(t[1].x,t[2].x)),c=Math.min(t[0].y,Math.min(t[1].y,t[2].y)),d=Math.max(t[0].y,Math.max(t[1].y,t[2].y)),h=o-s,u=a-r,I=g-l,p=d-c;i.forEach((t=>{const i=function(e,t,i,n){const s=i.x-t.x,o=i.y-t.y,r=n.x-t.x,a=n.y-t.y,l=e.x-t.x,g=e.y-t.y,c=s*a-o*r,d=(l*a-g*r)/c,h=(s*g-o*l)/c;return d>=0&&h>=0&&d+h<=1}(t,...e);if(i){const e=t.x+","+t.y+","+t.z;if(!n[e]){const i=l+I*(t.x-s)/h,o=c+p*(t.y-r)/u;n[e]={point:t,uv:new bt(i,o)}}}}));const m=function(e){return[[e[0],e[1]],[e[1],e[2]],[e[2],e[3]],[e[3],e[0]]]}(i);return[[0,1],[1,2],[2,0]].forEach((([i,s])=>{m.forEach((([o,r])=>{const a=function(e,t,i,n,s,o){const r=e.x,a=e.y,l=t.x,g=t.y,c=i.x,d=i.y,h=n.x,u=n.y,I=(r-l)*(d-u)-(a-g)*(c-h);if(Math.abs(I)<1e-4)return null;const p=((r-c)*(d-u)-(a-d)*(c-h))/I,m=-((r-l)*(a-d)-(a-g)*(r-c))/I;return p>=0&&p<=1&&m>=0&&m<=1?{point:e.clone().lerp(t,p),uv:s.clone().lerp(o,p)}:null}(e[i],e[s],o,r,t[i],t[s]);if(a){const{point:e}=a,t=e.x+","+e.y+","+e.z;n[t]||(n[t]=a)}}))})),Object.values(n)}const hV=new Qt,uV=new Qt,IV=new Qt;new Qt,new Qt,new Qt;const pV=new Qt,mV=new bt,AV=new bt,CV=new bt,fV=(e,t,i,n,s,o,r,a,l)=>{const g=[];for(let C=0;C<e.length;C++){const t=e[C];l[`${t.x},${t.y},${t.z}`]=i[C];cV(t,a[0],a[1],a[0],a[1])&&g.push(C)}if(3===g.length)return!1;const c=(d=a[0],h=a[1],u=a[0],I=a[1],[new bt(d,u),new bt(h,u),new bt(h,I),new bt(d,I)]);var d,h,u,I;const p=dV([e[0],e[1],e[2]],t,c),m=p.map((e=>e.point)),A=p.map((e=>e.uv));if(m.length>2){const e=gV(m),t=[];for(let i=0,r=e.length;i<r;i++){const r=e[i],a=m[r],g=A[r],c=`${a.x},${a.y},${a.z}`;am(l[c])||(s.push(a.x,a.y,a.z),n&&o.push(g.x,g.y),l[c]=s.length/3-1);const d=l[c];t.push(d)}3===m.length?r.push(t[1],t[2],t[0]):4===m.length?r.push(t[2],t[3],t[0],t[0],t[1],t[2]):5===m.length&&r.push(t[3],t[4],t[0],t[0],t[1],t[2],t[2],t[3],t[0])}return!0},bV=new Qt,yV=new Qt,_V=(e,t,i,n)=>e!==t&&e&&t?(e.unprojectCoordinate(i,yV),bV.copy(yV),t.projectCoordinate(bV,n),n):(n.copy(i),n),vV=(e,t,i,n)=>{if(n.sourceProjectionName===n.targetProjectionName)return{vertices:e,indices:t,uvs:i};return((e,t,i,n,s=0,o=[-.501,.501])=>{const r=!!i,a=Array.from(t);let l=0;const g=e.length;let c=null,d=null;if(Array.isArray(e[0])){c=[];let t=0;for(l=0;l<g;l++){const i=e[l];c[t++]=i[0],c[t++]=i[1],c[t++]=i[2]}}else c=e.slice(0);if(r)if(Array.isArray(i[0])){d=[];let e=0;for(l=0;l<i.length;l++){const t=i[l];d[e++]=t[0],d[e++]=t[1]}}else d=i.slice(0);const h=[],u={},I={},p=n*n;for(;a.length>0;){const e=a.pop(),t=a.pop(),i=a.pop(),n=hV.fromArray(c,3*i),g=uV.fromArray(c,3*t),m=IV.fromArray(c,3*e);let A,C,f;r&&(A=mV.fromArray(d,2*i),C=AV.fromArray(d,2*t),f=CV.fromArray(d,2*e));const b=jm.magnitudeSquared(jm.subtract(n,g,pV)),y=jm.magnitudeSquared(jm.subtract(g,m,pV)),_=jm.magnitudeSquared(jm.subtract(m,n,pV)),v=Math.max(b,y,_);let x,B,w;if(v>p)b===v?(x=`${Math.min(i,t)} ${Math.max(i,t)}`,l=u[x],null==l&&(B=jm.add(n,g,pV),jm.multiplyByScalar(B,.5,B),c.push(B.x,B.y,B.z),l=c.length/3-1,u[x]=l,r&&(w=oA.add(A,C,pV),oA.multiplyByScalar(w,.5,w),d.push(w.x,w.y))),a.push(i,l,e),a.push(l,t,e)):y===v?(x=`${Math.min(t,e)} ${Math.max(t,e)}`,l=u[x],l||(B=jm.add(g,m,pV),jm.multiplyByScalar(B,.5,B),c.push(B.x,B.y,B.z),l=c.length/3-1,u[x]=l,r&&(w=oA.add(C,f,pV),oA.multiplyByScalar(w,.5,w),d.push(w.x,w.y))),a.push(t,l,i),a.push(l,e,i)):_===v&&(x=`${Math.min(e,i)} ${Math.max(e,i)}`,l=u[x],l||(B=jm.add(m,n,pV),jm.multiplyByScalar(B,.5,B),c.push(B.x,B.y,B.z),l=c.length/3-1,u[x]=l,r&&(w=oA.add(f,A,pV),oA.multiplyByScalar(w,.5,w),d.push(w.x,w.y))),a.push(e,l,t),a.push(l,i,t));else{if(fV([n,g,m],[A,C,f],[i,t,e],r,c,d,a,o,I))continue;h.push(i+s),h.push(t+s),h.push(e+s)}}return{vertices:c,uvs:d,indices:h}})(e,t,i,1/Math.max(2,16-n.z))},xV=(e,t)=>{const{vertices:i,uvs:n,indices:s}=vV([-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],[0,2,1,0,3,2],[0,0,0,1,1,1,1,0],e);((e,t,i=!0,n=!0)=>{if(!t.forceProjectCoordinates&&t.targetProjectionName===t.sourceProjectionName)return;const s=t.sourceProjection,o=t.targetProjection,[r,a,l]=t.targetCenter,g=t.forceUseGeoBoundingBox||s.isGeo,c=g?t.geoBoundingBox:t.projectedBoundingBox;let d,h,u,I;if(c.isBox3){const e=c.min,t=c.max;d=e.x,h=e.y,u=t.x,I=t.y}else[d,h,,u,I]=c;const p=u-d,m=I-h;if(i)for(let A=0,C=e.length-2;A<C;A+=3){const t=e[A],i=e[A+1],c=e[A+2];bV.set(d+(t+.5)*p,h+(i+.5)*m,c),g?o.projectCoordinate(bV,yV):_V(s,o,bV,yV),e[A]=yV.x,e[A+1]=yV.y,e[A+2]=yV.z,n&&(e[A]-=r,e[A+1]-=a,e[A+2]-=l)}else for(let A=0,C=e.length;A<C;A+=1){const t=e[A],i=t[0],c=t[1],u=t[2];bV.set(d+(i+.5)*p,h+(c+.5)*m,u),g?o.projectCoordinate(bV,yV):_V(s,o,bV,yV),t[0]=yV.x,t[1]=yV.y,t[2]=yV.z,n&&(t[0]-=r,t[1]-=a,t[2]-=l)}})(i,e);const o={vertices:i,uvs:n,indices:s};if(t){const e=i.length/3;for(const i of Object.keys(t)){const n=t[i],s=Array.isArray(n),r=s?n.length:1,a=[];if(s)for(let t=0;t<e;t++)for(let e=0;e<r;e++)a.push(n[e]);else for(let t=0;t<e;t++)a.push(n);o[i]=a}}return o},BV=new Dl;let wV=null;class SV{constructor(e={}){if(__publicField(this,"_maxCacheSize",1e3),__publicField(this,"handleRemove",((e,t)=>{e.geometry.dispose()})),this._cache=new Zx({max:this._maxCacheSize,onRemove:this.handleRemove}),!wV){const t=lm(e.backgroundColor,16382457),i=lm(e.borderColor,13224393);wV=BV.load("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAUdJREFUeNrs2sENwyAQRcE4ckf0RBv04Z7ck30wFXBi/4wU5bScXhQk9hhj9B+xzu/7WjijvZ/b/Jbz/e83kE0AAkAACAABIAAEgAAQAAJAAAgAAVDYfA5ui+eY33R+BuA9PXO++QtwB0AACAABIAAEgAAQAAJAAAgAASAAqrIPED5vH8A+AO4ACAABIAAEgAAQAAJAAAgAASAABEBJ9gHC5+0D2AfAHQABIAAEgAAQAAJAAAgAASAABIAAKMk+QPi8fQD7ALgDIAAEgAAQAAJAAAgAASAABIAAEAAl2QcIn7cPYB8AdwAEgAAQAAJAAAgAASAABIAAEAACoCT7AOHz9gHsA+AOgAAQAAJAAAgAASAABIAAEAACQACUZB8gfN4+gH0A3AEQAAJAAAgAASAABIAAEAACQABUNV8D++I5nmM3nX8EGADa0U/2xPbBVwAAAABJRU5ErkJggg=="),this._material=new kZ({color:new In(t),borderColor:new In(i),map:wV,vertexZIndex:!0,enableDepthRange:!0,depthRange:new bt(1,1)})}}createMesh(e){let t=null;const i=e.grid.targetProjection;if(i.isAxisAligned)return this._geometry||(this._geometry=new xs(1,1),this._geometry.setAttribute("layerIndex",new Bn(new Float32Array([0,0,0,0]),1))),t=new ts(this._geometry,this._material),t.position.copy(e.targetCenter),e.targetBoundingBox.getSize(t.scale),t;const n={x:e.x,y:e.y,z:e.z,targetProjection:i,sourceProjection:e.grid.sourceProjection,targetProjectionName:i.name,sourceProjectionName:e.grid.sourceProjection.name,targetCenter:e.targetCenter.toArray(),geoBoundingBox:e.availableGeoBoundingBox,forceUseGeoBoundingBox:!0,forceProjectCoordinates:!0,projectedBoundingBox:e.projectedBoundingBox.isBox3?e.projectedBoundingBox:[]},s=xV(n,{layerIndices:0}),o=new Fn;return o.setIndex(s.indices),o.setAttribute("position",new Bn(new Float32Array(s.vertices),3)),o.setAttribute("layerIndex",new Bn(new Float32Array(s.layerIndices),1)),o.setAttribute("uv",new Bn(new Float32Array(s.uvs),2)),t=new ts(o,this._material),t.position.copy(e.targetCenter),t}get(e){let t=this._cache.get(e.key);return t||(t=this.createMesh(e),this._cache.set(e.key,t),t)}clear(){this._cache.clear()}get maxCacheSize(){return this._maxCacheSize}set maxCacheSize(e){this._maxCacheSize=e}get backgroundColor(){return this._material.color}set backgroundColor(e){e instanceof In?this._material.color.copy(e):this._material.color.set(e)}get borderColor(){return this._material.borderColor}set borderColor(e){e instanceof In?this._material.borderColor.copy(e):this._material.borderColor.set(e)}}const GV="fast",MV="hierarchical",RV="web_mercator",TV="bd_vector_online",ZV="bd_vector_offline",VV=Object.freeze(Object.defineProperty({__proto__:null,TILELOADER_STRATEGY_FAST:GV,TILELOADER_STRATEGY_HIERARCHICAL:MV,MAP_GRID_NAME_GEO:"geo",MAP_GRID_NAME_WEB_MERCATOR:RV,MAP_GRID_NAME_BD_VECTOR_ONLINE:TV,MAP_GRID_NAME_BD_VECTOR_OFFLINE:ZV},Symbol.toStringTag,{value:"Module"})),WV=new Cs(new Qt(1,0,0),0),EV=[new Qt,new Qt,new Qt,new Qt],NV=new Dt,FV=new Qt,XV=new Bi,HV=new Bi,zV=new Bi,LV=new Bi;let DV=0;class KV extends Ji{constructor(e={}){super(e),__publicField(this,"name","MapSurface"),__publicField(this,"_lodScaleFactor",1),__publicField(this,"_sseFactor",.8),__publicField(this,"_minLevel",0),__publicField(this,"_maxLevel",21),__publicField(this,"_surfaceTileManager",null),__publicField(this,"_showTileBoundingBox",!1),__publicField(this,"_showTileDebugLabel",!1),__publicField(this,"_debugLabelIds",{}),__publicField(this,"_placeholderMeshesLastFrame",[]),__publicField(this,"_freezeUpdate",!1),__publicField(this,"_maxRequestTilesPerFrame",20),__publicField(this,"_enableHorizonCulling",!0),__publicField(this,"_selectedTilesMapLastFrame",{}),__publicField(this,"_selectedTilesLastFrame",[]),__publicField(this,"_showGroundWireframe",!1),this._id=DV++,this._quadtree=null,this._placeholder=null,this._options=e,this.statistics={visited:0,used:0,rendered:0,request:0,unstable:0},this._currentStatistics=Object.assign({},this.statistics),this._objectGroup=new qr,this.add(this._objectGroup),this._boundingBoxGroup=new qr,this.add(this._boundingBoxGroup),this._groundObjectGroup=new ra,e.strategy===GV?this.strategy=new KZ(e):e.strategy===MV&&(this.strategy=new YZ(e))}_getCurrentGrid(){}computeDistanceToTile(e,t,i,n,s){let o;if(i===yC.SCENE3D){this.updateTileBoundingRegion(e);if(!e.boundingVolumeSourceTile&&e.z>=this._minLevel)return 9999999999;const r=e.boundingRegion,a=r.minimumHeight,l=r.maximumHeight;if(e.boundingVolumeSourceTile&&e.boundingVolumeSourceTile.tile!==e){const e=this.engine.map.map._ellipsoidCamera.positionCartographic.z;Math.abs(e-a)>Math.abs(e-l)?(r.minimumHeight=a,r.maximumHeight=a):(r.minimumHeight=l,r.maximumHeight=l)}return o=r.distanceToCamera(t,i,n,s),o}return o=e.targetBoundingBox.distanceToPoint(t),o}clearTilesInView(){this._groundObjectGroup.clear(),this._boundingBoxGroup.clear();const e=this._objectGroup;for(const t of this._selectedTilesLastFrame)e.remove(t.object),this.onSurfaceTileRemoved(t);this._selectedTilesLastFrame=[],this._selectedTilesMapLastFrame={}}updateView(e,t,i,n){if(this._freezeUpdate)return;if(!1===this.beginFrame(n))return;const s=this._getCurrentGrid();if(!s)return;this._quadtree||(this._quadtree=new gZ(s),this._quadtree.onTileCreated=this._onTileCreated);const o=this._currentOccluder=e.map._map.occluder;o&&(o.cameraPosition=t);let r=this._strategy;r._surfaceTileManager||(r._surfaceTileManager=this._surfaceTileManager);let{selectedTiles:a,requestTilesQueue:l,placeholderTiles:g}=r.computeTiles(e,t,i,n),c=[];g.length>0&&this._shouldRenderPlaceholder&&(this._placeholder||(this._placeholder=new SV(this._options),this._placeholder.engine=e),c=g.map((e=>this._placeholder.get(e))));let d=this._maxRequestTilesPerFrame;d-=Math.min(2,this._currentStatistics.unstable);const h=d;for(let f=0;f<l.length;f++){const e=l[f],t=Math.min(d,e.length);this._requestTilesInArray(e,t),d-=t}h>d&&this._quadMap._engine.requestRender();const u=this._selectedTilesLastFrame,I=this._selectedTilesMapLastFrame,p={};for(const f of a)p[f.tile.key]=f;const m=this._objectGroup;let A=this._groundObjectGroup;e.scene.overrideMaterial&&(A=m);const C=this._boundingBoxGroup;C.clear();for(const f of u)if(!p[f.tile.key]&&(m.remove(f.object),A.remove(f.groundObject),this.onSurfaceTileRemoved(f),this._showTileDebugLabel)){const t=this._getDebugLabelId(f);this._debugLabelIds[t]&&(delete this._debugLabelIds[t],e.rendering.label.removeLabel({id:t,type:"text_flat"}))}for(const f of this._placeholderMeshesLastFrame)A.remove(f);for(const f of c)A.add(f);for(const f of a)if(f){if(this._showTileBoundingBox&&C.add(f.boxHelper),this._showTileDebugLabel){const t=this._getDebugLabelId(f);if(!this._debugLabelIds[t]){this._debugLabelIds[t]=!0;const i={crs:e.map.projectionName,id:t,position:f.tile.targetCenter,text:f.tile.key,textSize:24,textFillStyle:[255,0,0,1],textStrokeStyle:[255,255,255,1],textStrokeWidth:2,type:"text_flat",rank:1e7};e.rendering.label.addLabel(i)}}I[f.tile.key]?f.isMeetSSEChanged&&this.onSurfaceTileSSEChanged(f):(f.object&&this._objectGroup.add(f.object),f.groundObject&&A.add(f.groundObject),this.onSurfaceTileAdded(f))}this._placeholderMeshesLastFrame=c,this._selectedTilesLastFrame=a,this._selectedTilesMapLastFrame=p,this.endFrame(n)}_getDebugLabelId(e){return"mapsurface-"+this._id+"-debuglabel-"+e.tile.key}_onBeforeSceneRender(e,t,i,n){0!==this._groundObjectGroup.children.length?(this._groundSceneRenderer||(this._groundSceneRenderer=new wZ),this.add(this._groundSceneRenderer.copyMesh),this._groundSceneRenderer.render(this._groundObjectGroup,e,t,i,n)):this._groundSceneRenderer&&this.remove(this._groundSceneRenderer.copyMesh)}_requestTilesInArray(e,t,i=!1){if(t<=0)return;let n=e.slice(0,t);for(const s of n)this._surfaceTileManager.requestSurfaceTile(s,i)}_selectCurrentFrameRequestTiles(e,t){return e.length<t?e:(e.sort(((e,t)=>e.z!==t.z?t.z-e.z:e._distance-t._distance)),e.slice(0,t))}beginFrame(e){this._currentStatistics.visited=0,this._currentStatistics.used=0,this._currentStatistics.rendered=0,this._currentStatistics.request=0,this._currentStatistics.unstable=0,this._strategy.beginFrame()}endFrame(e){this.statistics.visited=this._currentStatistics.visited,this.statistics.used=this._currentStatistics.used,this.statistics.rendered=this._currentStatistics.rendered,this.statistics.request=this._currentStatistics.request,this.statistics.unstable=this._currentStatistics.unstable,this._strategy.endFrame()}_computeOccludeePoint(e,t){const i=e.boundingRegion.boundingVolume.center,n=e.geoBoundingBox,s=IA.fromBox(n),o=this.engine.map.map._ellipsoid,r=EV;return jm.fromRadians(s.west,s.south,0,o,r[0]),jm.fromRadians(s.east,s.south,0,o,r[1]),jm.fromRadians(s.west,s.north,0,o,r[2]),jm.fromRadians(s.east,s.north,0,o,r[3]),t.computeHorizonCullingPointPossiblyUnderEllipsoid(i,r,0)}_computeOccludeePoint2(e,t){const i=e.boundingBox,n=e.center,s=i.min,o=i.max,r=[s,o,new Qt(s.x,s.y,o.z),new Qt(s.x,o.y,s.z)];return t.computeHorizonCullingPointPossiblyUnderEllipsoid(n,r,0)}updateTileBoundingRegion(e,t,i){const n=this.engine.map.map._ellipsoid;if(!e.boundingRegion){const t=IA.fromBox(e.geoBoundingBox,new IA,!0);e.boundingRegion=new cZ({computeBoundingVolumes:!1,rectangle:t,ellipsoid:n,minimumHeight:0,maximumHeight:0})}let s=this._surfaceTileManager.getSurfaceTile(e,i);const o=s&&s.object,r=e._heights,a=e.boundingRegion,l=a.minimumHeight,g=a.maximumHeight;let c=!1;if(o)r&&(a.minimumHeight=r[0],a.maximumHeight=r[1]),c=!0;else{a.minimumHeight=Number.NaN,a.maximumHeight=Number.NaN;let t=e.parent;for(;void 0!==t;){const e=t._heights,n=this._surfaceTileManager.getSurfaceTile(t,i);if(n){const i=n.object,s=void 0!==t._heights;if(i){s?(a.minimumHeight=e[0],a.maximumHeight=e[1]):(a.minimumHeight=0,a.maximumHeight=0);break}}t=t.parent}s=t}if(void 0!==s){const t=void 0===a._orientedBoundingBox;(a.minimumHeight!==l||a.maximumHeight!==g||t)&&a.computeBoundingVolumes(n),e.boundingVolumeSourceTile=s,e.boundingVolumeIsFromMesh=c}else{a.minimumHeight=0,a.maximumHeight=0;void 0===a._orientedBoundingBox&&a.computeBoundingVolumes(n),e.boundingVolumeSourceTile=void 0,e.boundingVolumeIsFromMesh=!1}}screenSpaceError(e){const t=this.quadMap;let i=e.z;const n=this.engine.map;let s=n.isGlobe,o=1,r=!0;if(s){r=e.targetCenter.length()>n.map._ellipsoid.minimumRadius}if(r){FV.copy(this.engine.camera.position),s?(bA.eastNorthUpToFixedFrame(e.targetCenter,null,XV),XV.invert(),FV.applyMatrix4(XV).normalize()):FV.sub(e.targetCenter).normalize(),o=Math.exp(-this._sseFactor*(1-ft.clamp(FV.z,0,1)));let t=ft.clamp(FV.z,0,1);e._distance<2e3&&(o=1,t=1),e._horizonFactor=t}const a=e.grid.getPixelSizeByLevel(i),l=e._distance;let g=a*this.engine.rendering.resolution.y/(l*t._sseDenominator)*this._lodScaleFactor*o;return g*=e.targetLODScaleRatio,g}reverseScreenSpaceErrorZ(e){const t=this.quadMap,i=this.engine.map;let n=i.isGlobe,s=1,o=!0;if(n){o=e.targetCenter.length()>i.map._ellipsoid.minimumRadius}o&&(FV.copy(this.engine.camera.position),n?(bA.eastNorthUpToFixedFrame(e.targetCenter,null,XV),XV.invert(),FV.applyMatrix4(XV).normalize()):FV.sub(e.targetCenter).normalize(),s=Math.exp(-this._sseFactor*(1-ft.clamp(FV.z,0,1))),e._distance<2e3&&(s=1));const r=e._distance,a=this.engine.rendering.resolution.y;let l=2*r*t._sseDenominator/(a*this._lodScaleFactor*s);l/=e.targetLODScaleRatio;const g=Math.log2(2*e.grid.zeroLevelPixelSize/l);return isNaN(g)?0:Math.max(g,0)}projectBoundingBoxToNdc(e){const t=this.engine.camera;zV.copy(t.matrixWorldInverse),HV.copy(t.projectionMatrix),LV.multiplyMatrices(HV,zV);let i;if(this.engine.map.isGlobe){const t=e.boundingRegion;if(!t||!t.boundingVolume)return[[0,0],[0,0],[0,0],[0,0]];const n=t.boundingVolume.computeCorners();i=[n[0],n[2],n[6],n[4]]}else{const t=e.targetBoundingBox;i=[new Qt(t.min.x,t.min.y,0),new Qt(t.min.x,t.max.y,0),new Qt(t.max.x,t.max.y,0),new Qt(t.max.x,t.min.y,0)]}return i.map((e=>(NV.set(e.x,e.y,e.z,1),NV.applyMatrix4(LV),NV.divideScalar(NV.w),[NV.x,NV.y])))}_computeTileVisibility(e,t){const{mode:i}=this.engine.map.map;if(i===yC.SCENE3D){const i=t.boundingRegion.boundingVolume;return!!(this._computeTileVisibility3D(e,i)!==V_.OUTSIDE)&&!(this._enableHorizonCulling&&this._currentOccluder&&(t._occludeePointInScaledSpace||(t._occludeePointInScaledSpace=this._computeOccludeePoint(t,this._currentOccluder)),t._occludeePointInScaledSpace&&!this._currentOccluder.isScaledSpacePointVisiblePossiblyUnderEllipsoid(t._occludeePointInScaledSpace,0)))}const n=t.targetBoundingBox;return e.intersectsBox(n)}_computeTileVisibility3D(e,t){if(!Hm(t))throw new Lm("boundingVolume is required.");const i=e.planes;let n=!1;for(let s=0,o=i.length;s<o;++s){const e=i[s],o=e.normal.clone().normalize(),r=e.constant,a=new Dt(...o.toArray(),r),l=t.intersectPlane(G_.fromCartesian4(a,WV));if(l===V_.OUTSIDE)return V_.OUTSIDE;l===V_.INTERSECTING&&(n=!0)}return n?V_.INTERSECTING:V_.INSIDE}_naturalOrderChildTiles(e,t){const i=e[0],n=e[1],s=e[2],o=e[3],r=t.x/Math.PI*180,a=t.y/Math.PI*180;return r<i.geoBoundingBox.max.x?a<i.geoBoundingBox.max.y?[i,s,n,o]:[n,i,o,s]:a<i.geoBoundingBox.max.y?[s,i,o,n]:[o,n,s,i]}_createRootTiles(){const e=this._getCurrentGrid();this._rootTiles=e.getRootTiles()}showLoadLogInOneFrame(){this._strategy._logLoadInCurrentFrame=!0}onSurfaceTileAdded(e){}onSurfaceTileRemoved(e){}onSurfaceTileSSEChanged(e){}dispose(){this._quadtree=null,this._surfaceTileManager.dispose(),this._surfaceTileManager=null}set quadMap(e){this._quadMap=e}get quadMap(){return this._quadMap}get showTileBoundingBox(){return this._showTileBoundingBox}set showTileBoundingBox(e){this._showTileBoundingBox=e,this._quadMap._engine.requestRender()}get showTileDebugLabel(){return this._showTileDebugLabel}set showTileDebugLabel(e){if(this._showTileDebugLabel=e,!1===e){const e=this._quadMap._engine.rendering.label;for(const t of Object.keys(this._debugLabelIds))e.removeLabel({id:t,type:"text_flat"});this._debugLabelIds={}}this._quadMap._engine.requestRender()}get freezeUpdate(){return this._freezeUpdate}set freezeUpdate(e){this._freezeUpdate=e}get enableHorizonCulling(){return this._enableHorizonCulling}set enableHorizonCulling(e){this._enableHorizonCulling=e}get tileManager(){return this._surfaceTileManager}get loadSiblings(){return this._strategy._loadSiblings}set loadSiblings(e){this._strategy._loadSiblings=e}get sseFactor(){return this._sseFactor}set sseFactor(e){this._sseFactor=e}get lodScaleFactor(){return this._lodScaleFactor}set lodScaleFactor(e){this._lodScaleFactor=e}get showGroundWireframe(){return this._showGroundWireframe}set showGroundWireframe(e){this._showGroundWireframe=e,e?(this._groundWireframeMaterial||(this._groundWireframeMaterial=new Cn({wireframe:!0,color:16746496})),this._groundObjectGroup.overrideMaterial=this._groundWireframeMaterial):(this._groundObjectGroup.overrideMaterial=null,this._groundWireframeMaterial&&(this._groundWireframeMaterial.dispose(),this._groundWireframeMaterial=null))}set strategy(e){this._strategy=e,this._strategy._surface=this,this._strategy._surfaceTileManager=this._surfaceTileManager}get strategy(){return this._strategy}get placeholder(){return this._placeholder||(this._placeholder=new SV(this._options),this._placeholder.engine=this._quadMap._engine),this._placeholder}}class YV{constructor(e){__publicField(this,"_surface",null),this._surface=e,this._pendingCount=0}getSurfaceTile(e){}requestSurfaceTile(e){}dispose(){console.warn("SurfaceTileManager.dispose not implemented")}get pendingCount(){return this._pendingCount}}const PV=new Qt;class kV{constructor(e,t,i,n){__publicField(this,"x"),__publicField(this,"y"),__publicField(this,"z"),__publicField(this,"compeleted",!1),__publicField(this,"siblingIndex",0),__publicField(this,"_grid"),__publicField(this,"_geoBoundingBox"),__publicField(this,"_projectedCenter"),__publicField(this,"_projectedBoundingBox"),__publicField(this,"_targetCenter"),__publicField(this,"_targetBoundingBox"),__publicField(this,"_targetLODScaleRatio"),__publicField(this,"_targetSSESize"),this._grid=e,this.z=t,this.x=i,this.y=n,this.key=t+"-"+i+"-"+n,this.state=1,this.childrenKeys=[],e.getTileLoaderConfig&&(this.loaderConfig=e.getTileLoaderConfig(this))}updateBoundingBoxZ(e,t){const i=this._projectedBoundingBox;i.min.z=e,i.max.z=t,i.getCenter(this._projectedCenter)}get boundingBox(){return console.warn("boundingBox is renamed to projectedBoundingBox"),this.projectedBoundingBox}set boundingBox(e){console.warn("boundingBox is renamed to projectedBoundingBox"),this.projectedBoundingBox=e}get projectedBoundingBox(){return this._projectedBoundingBox}set projectedBoundingBox(e){e?(this._projectedBoundingBox=e,this._projectedCenter||(this._projectedCenter=new Qt),e.getCenter(this._projectedCenter)):console.warn("Invalid bounding",e)}get geoBoundingBox(){return this._geoBoundingBox}set geoBoundingBox(e){this._geoBoundingBox=e}get reverseY(){return void 0===this._reverseY&&(this._reverseY=this._grid.getTileReverseY(this)),this._reverseY}set grid(e){this._grid=e}get grid(){return this._grid}get center(){return console.warn("center is renamed to projectedCenter"),this.projectedCenter}set center(e){console.warn("center is renamed to projectedCenter"),this.projectedCenter=e}get projectedCenter(){return this._projectedCenter}set projectedCenter(e){this._projectedCenter=e}set targetBoundingBox(e){console.warn("targetBoundingBox is readonly")}get targetBoundingBox(){return this._targetBoundingBox||(this._targetBoundingBox=new qt,this._grid._engine,this._grid.targetProjection.name!==this._grid.sourceProjection.name?this._targetBoundingBox=this._grid.targetProjection.geoBoxToProjectedBox(this.geoBoundingBox):this._targetBoundingBox.copy(this.projectedBoundingBox)),this._targetBoundingBox}get targetCenter(){return this._targetCenter||(this._targetCenter=new Qt,this._grid.targetProjection.name!==this._grid.sourceProjection.name?this.targetBoundingBox.getCenter(this._targetCenter):this._projectedBoundingBox.getCenter(this._targetCenter)),this._targetCenter}get geoIntersectionOfTargetProjection(){const e=this._grid.targetProjection.geoBoundingBox;if(!e)return V_.INSIDE;const{x:t,y:i}=this.geoBoundingBox.min,{x:n,y:s}=this.geoBoundingBox.max,{x:o,y:r}=e.min,{x:a,y:l}=e.max;return n<o||t>a||s<r||i>l?V_.OUTSIDE:t>=o&&n<=a&&i>=r&&s<=l?V_.INSIDE:V_.INTERSECT}_computeAvailableGeoBoundingBox(){const e=this._grid.targetProjection.geoBoundingBox;let{x:t,y:i,z:n}=this.geoBoundingBox.min,{x:s,y:o,z:r}=this.geoBoundingBox.max;const{x:a,y:l}=e.min,{x:g,y:c}=e.max;t<a&&(t=a),s>g&&(s=g),i<l&&(i=l),o>c&&(o=c),this._availableGeoBoundingBox=new qt(new Qt(t,i,n),new Qt(s,o,r))}get availableGeoBoundingBox(){return this.geoIntersectionOfTargetProjection===V_.OUTSIDE?null:this.geoIntersectionOfTargetProjection===V_.INTERSECT?(this._availableGeoBoundingBox||this._computeAvailableGeoBoundingBox(),this._availableGeoBoundingBox):this.geoBoundingBox}_computeTargetLODScaleRatio(){let e;if(this._grid.targetProjection.getLODSacleOfGeoBoundingBox&&(e=this._grid.targetProjection.getLODSacleOfGeoBoundingBox(this.geoBoundingBox),void 0!==e))return e;const t=this.projectedBoundingBox;let i=t.max.x-t.min.x,n=t.max.y-t.min.y;const s=this.targetBoundingBox;let o,r;s.isOrientedBoundingBox?(PV.fromArray(s.halfAxes.elements,0),o=2*PV.length(),PV.fromArray(s.halfAxes.elements,3),r=2*PV.length()):(o=s.max.x-s.min.x,r=s.max.y-s.min.y);let a=o/i,l=r/n;return e=Math.min(a,l),e}get targetLODScaleRatio(){return void 0===this._targetLODScaleRatio&&(this._grid.sourceProjection.equals(this._grid.targetProjection)?this._targetLODScaleRatio=1:this._targetLODScaleRatio=this._computeTargetLODScaleRatio()),this._targetLODScaleRatio}}class OV{constructor(e){this.maxSize=e||800,this.minSize=Math.round(.75*this.maxSize),this.unloadPercent=.05,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadPriorityCallback=null;const t=this.itemSet;this.defaultPriorityCallback=e=>t.get(e)}setMaxSize(e){this.maxSize=e,this.minSize=Math.round(.75*this.maxSize)}isFull(){return this.itemSet.size>=this.maxSize}add(e,t){const i=this.itemSet;if(i.has(e))return!1;if(this.isFull())return!1;const n=this.usedSet,s=this.itemList,o=this.callbacks;return s.push(e),n.add(e),i.set(e,Date.now()),o.set(e,t),!0}remove(e){const t=this.usedSet,i=this.itemSet,n=this.itemList,s=this.callbacks;if(i.has(e)){s.get(e)(e);const o=n.indexOf(e);return n.splice(o,1),t.delete(e),i.delete(e),s.delete(e),!0}return!1}clear(){const e=this.usedSet,t=this.itemSet,i=this.itemList,n=this.callbacks;for(let s=0;s<i.length;s++){const e=i[s];n.get(e)(e)}this.itemList=[],e.clear(),t.clear(),n.clear()}markUsed(e){const t=this.itemSet,i=this.usedSet;t.has(e)&&!i.has(e)&&(t.set(e,Date.now()),i.add(e))}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const e=this.unloadPercent,t=this.minSize,i=this.itemList,n=this.itemSet,s=this.usedSet,o=this.callbacks,r=i.length-s.size,a=i.length-t,l=this.unloadPriorityCallback||this.defaultPriorityCallback;if(a>0&&r>0){i.sort(((e,t)=>{const i=s.has(e),n=s.has(t);return i&&n?0:i||n?i?1:-1:l(t)-l(e)}));const g=Math.min(a,r),c=Math.max(t*e,g*e);let d=Math.min(c,r);d=Math.ceil(d);const h=i.splice(0,d);for(let e=0,t=h.length;e<t;e++){const t=h[e];o.get(t)(t),n.delete(t),o.delete(t)}}}scheduleUnload(e=!0){var t;this.scheduled||(this.scheduled=!0,t=()=>{this.scheduled=!1,this.unloadUnusedContent(),e&&this.markAllUnused()},Promise.resolve().then(t))}}class UV{constructor(e,t,i){__publicField(this,"_minLevel",0),__publicField(this,"_maxLevel",18),__publicField(this,"_useGeoSubdivision",!1),__publicField(this,"_projectBoxWithFourConrner",!1),__publicField(this,"_unprojectBoxWithFourConrner",!1),__publicField(this,"_shouldCheckTileBoundingRange",!1),__publicField(this,"_pixelSizes",[]),this._engine=e,this._sourceProjection=t,this._targetProjection=i}getRootTiles(){return console.warn("getRootTiles is not implemented"),[]}getRootBoundingBox(){return console.warn("getRootBoundingBox is not implemented"),null}getPixelSizeByLevel(e){return this._pixelSizes[e]}getNextLevel(e){return e+1}shouldCreateChildren(e){return!0}getNextLevelTileCount(e,t){return Math.pow(2,t-e)}getQuadTreeLevelGap(e,t){return t-e}createTileChildren(e){const t=[];e.childrenKeys=[];const i=this.getNextLevel(e.z);if(!this.shouldCreateChildren(e))return[];let n=null,s=null;if(this._useGeoSubdivision){const t=e.geoBoundingBox;n=t.min,s=t.max}else{const t=e.projectedBoundingBox;n=t.min,s=t.max}const o=this.getQuadTreeLevelGap(e.z,i),r=Math.pow(2,o),a=(s.x-n.x)/r,l=(s.y-n.y)/r;let g=e.x*r,c=e.y*r,d=null;for(let h=0;h<r;h++)for(let o=0;o<r;o++){const u=new kV(this,i,g+h,c+o);if(d=new qt(new Qt(n.x+h*a,n.y+o*l,n.z),new Qt(n.x+(h+1)*a,n.y+(o+1)*l,s.z)),this._useGeoSubdivision?(u.geoBoundingBox=d,u.projectedBoundingBox=this._sourceProjection.geoBoxToProjectedBox(d)):(u.projectedBoundingBox=d,u.geoBoundingBox=this._sourceProjection.projectedBoxToGeoBox(d)),!this._shouldCheckTileBoundingRange||this.isTileInBoundingRange(u)){if(this._targetProjection.geoBoundingBox){const e=this._targetProjection.geoBoundingBox;if(u.geoBoundingBox.max.x<e.min.x||u.geoBoundingBox.min.x>e.max.x||u.geoBoundingBox.max.y<e.min.y||u.geoBoundingBox.min.y>e.max.y)continue}u.siblingIndex=h*r+o,u.parentKey=e.key,u.parent=e,t.push(u),e.childrenKeys.push(u.key)}}return t}isTileInBoundingRange(e){const t=e.geoBoundingBox,i=t.min,n=t.max;return!(i.x>180||n.x<-180||i.y>90||n.y<-90)}getTileSizeAtLevel(e){console.warn("getTileSizeXAtLevel is not implemented")}getTileCoordX(e,t,i=!1){console.warn("getTileCoordX is not implemented")}getTileCoordY(e,t,i=!1){console.warn("getTileCoordY is not implemented")}_alignTileCoord(e){let t=Math.round(e);return Math.abs(e-t)<1e-6?t:e}computeCoverageTilesCoord(e,t=0,i=100){const n=[],s=e.grid;let o=null;if(s.useGeoSubdivision)o=this._useGeoSubdivision?e.geoBoundingBox:this._sourceProjection.geoBoxToProjectedBox(e.geoBoundingBox);else if(this._useGeoSubdivision)o=e.projectedBoundingBox;else{let t=s.targetProjection.projectedBoxToGeoBox(e.projectedBoundingBox);o=this._sourceProjection.geoBoxToProjectedBox(t)}const r=this.zeroLevelPixelSize/s.zeroLevelPixelSize;let a=Math.round(e.z+r-1);const l=Math.max(this._minLevel,t),g=Math.min(this._maxLevel,i);a<l&&(a=l),a>g&&(a=g);let c=0,d=0,h=0,u=0,I=0;for(;a>=l;){const t=this.getTileSizeAtLevel(a);if(d=this._alignTileCoord(this.getTileCoordX(o.min.x,t,!0)),h=this._alignTileCoord(this.getTileCoordY(o.min.y,t,!0)),u=this._alignTileCoord(this.getTileCoordX(o.max.x,t,!0)),I=this._alignTileCoord(this.getTileCoordY(o.max.y,t,!0)),d=Math.floor(d),h=Math.floor(h),u=Math.ceil(u),I=Math.ceil(I),c=(u-d)*(I-h),c<8)break;if(a===l)return console.warn(`tile count ${c} is too large for one mapped target tile ${e.key}`),[];a--}for(let p=d;p<u;p++)for(let e=h;e<I;e++)n.push([a,p,e]);return n}computeTileCoverageRect(e,t){if(e.z===t.z&&e.x===t.x&&e.y===t.y)return[-1,-1,-1,-1];let i=null,n=null;e.grid.useGeoSubdivision?(i=e.geoBoundingBox,n=t.geoBoundingBox):(i=e.projectedBoundingBox,n=t.projectedBoundingBox);const s=i.min,o=i.max,r=n.min,a=n.max;return[(r.x-s.x)/(o.x-s.x),(r.y-s.y)/(o.y-s.y),(a.x-s.x)/(o.x-s.x),(a.y-s.y)/(o.y-s.y)]}updateTileHeights(e,t){e._heights=t,e.z<2||(this.useGeoSubdivision?(e.geoBoundingBox.min.z=t[0],e.geoBoundingBox.max.z=t[1],e.projectedBoundingBox=this._sourceProjection.geoBoxToProjectedBox(e.geoBoundingBox)):(e.projectedBoundingBox.min.z=t[0],e.projectedBoundingBox.max.z=t[1],e.center.z=(t[0]+t[1])/2,e.geoBoundingBox=this.projectionBoxToGlobeBox(e.projectedBoundingBox,this._unprojectBoxWithFourConrner)))}getTileReverseY(e){return Math.pow(2,e.z)-e.y-1}_updateLODConfig(){const e=[];let t=this.zeroLevelPixelSize;for(let i=0;i<=this._maxLevel;i++)e.push(t),t/=2;this._pixelSizes=e}update(){this._updateLODConfig()}set engine(e){this._engine=e}get engine(){return this._engine}set maxLevel(e){this._maxLevel=e}get maxLevel(){return this._maxLevel}set minLevel(e){this._minLevel=e}get minLevel(){return this._minLevel}get useGeoSubdivision(){return this._useGeoSubdivision}get sourceProjection(){return this._sourceProjection}get targetProjection(){return this._targetProjection}get zeroLevelPixelSize(){return this._zeroLevelPixelSize||(this._zeroLevelPixelSize=156543.03392804062),this._zeroLevelPixelSize}}const QV=20037508.3427892;class JV extends UV{constructor(){super(...arguments),__publicField(this,"name",RV),__publicField(this,"_maxLevel",21),__publicField(this,"_rootBoundingBox",new qt(new Qt(-QV,-QV,-100),new Qt(QV,QV,100)))}getRootTiles(){const e=new kV(this,0,0,0);return e.projectedBoundingBox=this._rootBoundingBox,e.geoBoundingBox=new qt(new Qt(-180,-90,-100),new Qt(180,90,100)),[e]}getRootBoundingBox(){return this._rootBoundingBox}getTileSizeAtLevel(e){return QV/Math.pow(2,e-1)}getTileCoordX(e,t,i){return i&&(e<-QV?e=-QV:e>QV&&(e=QV)),(e+QV)/t}getTileCoordY(e,t,i){return this.getTileCoordX(e,t,i)}get textureMaxLevel(){return this._textureMaxLevel}set textureMaxLevel(e){this._textureMaxLevel=e}}class jV{constructor(e={}){__publicField(this,"name","TileProvider"),__publicField(this,"_sourceProjection"),__publicField(this,"_targetProjection"),__publicField(this,"_quadtree"),__publicField(this,"_cache"),__publicField(this,"_grid"),__publicField(this,"_supportedTargetProjectionNames",[]),__publicField(this,"_supportAllProjections",!1),__publicField(this,"_compatible",!1),__publicField(this,"_initState",0),__publicField(this,"_desiredUpperSampleLevel",100),__publicField(this,"_loadingUpperSampleLevel",1),__publicField(this,"_maxCacheSize",1e3),__publicField(this,"_maxLevel"),__publicField(this,"_minLevel"),__publicField(this,"_startLevel"),__publicField(this,"_shouldCheckTileAvailable",!1),__publicField(this,"ignoreLoadingState",!1),__publicField(this,"_requestingCount",0),__publicField(this,"_maxParallelRequestNum",6),__publicField(this,"enablePeriodRequestLog",!1),__publicField(this,"_periodRequestLogCount",0),__publicField(this,"_periodRequestLogStartTime",0),__publicField(this,"_canUpsample",!1),__publicField(this,"_useWebMeractorProjectionAndGrid",!1),__publicField(this,"handleRemove",((e,t)=>{this.onTileDispose(e),e.state=5,this._markTileStateListenersNeedsUpdate(e),e._stateListenerObjects=[]})),__publicField(this,"_logRequestStart",(()=>{this.enablePeriodRequestLog&&(0===this._requestingCount&&(this._periodRequestLogCount=0,this._periodRequestLogStartTime=performance.now()),this._periodRequestLogCount++)})),__publicField(this,"_logRequestEnd",(()=>{this.enablePeriodRequestLog&&0===this._requestingCount&&(performance.now(),this._periodRequestLogStartTime)})),__publicField(this,"_markTileStateListenersNeedsUpdate",(e=>{for(const t of e._stateListenerObjects)t.needsUpdate=!0})),__publicField(this,"_initOrUpdateTileStateListeners",((e,t)=>{e._stateListenerObjects||(e._stateListenerObjects=[]),e._stateListenerObjects.indexOf(t)<0&&e._stateListenerObjects.push(t)})),e.targetProjection&&(this._targetProjection=e.targetProjection),void 0!==e.minLevel&&(this._minLevel=e.minLevel),void 0!==e.maxLevel&&(this._maxLevel=e.maxLevel),void 0!==e.startLevel&&(this._startLevel=e.startLevel),this._maxCacheSize=e.maxCacheSize||800,this._needFeedback=lm(e.needFeedback,!0),this.statistics={loading:0,cached:0}}_init(){if(0===this._initState){if(void 0===this._minLevel&&(this._minLevel=this._defaultMinLevel||0),void 0===this._startLevel&&(this._startLevel=this._defaultStartLevel||0),void 0===this._maxLevel&&(this._maxLevel=this._defaultMaxLevel||1/0),this._initState=1,!(this._supportAllProjections||this._supportedTargetProjectionNames.indexOf(this._targetProjection.name)>=0))return this._compatible=!1,console.warn(`${this.name}: not supported target projection ${this._targetProjection.name}, supported target projections: ${this._supportedTargetProjectionNames.join(",")}`),this._inited=!0,void(this._initState=3);this._compatible=!0,this._cache=new OV(this._maxCacheSize),this._asyncInit?this._asyncInit().then((()=>{this._inited=!0,this._initState=2,this._useWebMeractorProjectionAndGrid?this._initWebMercatorProjectionAndGrid():this.initProjectionAndGrid(),this._grid.update(),this._quadtree=new gZ(this._grid),this._engine.requestRender()})).catch((e=>{console.error(e),this._inited=!0,this._initState=3})):(this._inited=!0,this._initState=2,this._useWebMeractorProjectionAndGrid?this._initWebMercatorProjectionAndGrid():this.initProjectionAndGrid(),this._grid.update(),this._quadtree=new gZ(this._grid))}}_initWebMercatorProjectionAndGrid(){this._sourceProjection=Tv(Tb),this._grid=new JV(this._engine,this._sourceProjection,this._targetProjection)}initProjectionAndGrid(){throw new Error(this.name+": initProjectionAndGrid should be overriden in subclass or set _useWebMeractorProjectionAndGrid to true")}_freeResources(){this._cache=null,this._grid=null,this._quadtree=null}beginFrame(e){this._usedTilesNum=0,this._usedTiles={},this._init(),this._needsClearCache&&(this.clearCache(),this._needsClearCache=!1)}endFrame(e){this._cache&&(this._cache.scheduleUnload(),this.statistics.cached=this._cache.itemList.length)}isReady(){return 2===this._initState}onTileDispose(e){console.warn("onTileDispose should be overriden in subclass")}async requestTileData(e,t){if(!(e.z<this._minLevel)&&2===this._initState){if(!e)return window.__debug&&console.warn("tile not found"),void console.warn("tile not found");if(t&&this._initOrUpdateTileStateListeners(e,t),2!==e.state)if(3!==e.state){if(e.geoIntersectionOfTargetProjection===V_.OUTSIDE)return e.state=3,void this._markTileStateListenersNeedsUpdate(e);if(e.geoIntersectionOfTargetProjection!==V_.INTERSECT){if(4===e.state)if(Date.now()-e._lastFailTime<9e5){if(e._failTimes>2)return}else e._failTimes=0;if(!(this._requestingCount>=this._maxParallelRequestNum)){this._logRequestStart(),this._requestingCount++;try{e.state=2,this.statistics.loading++,this._markTileStateListenersNeedsUpdate(e),window.__debug;const t=await this.doRequestTileData(e);e.data=t,e.state=3,this._cache.add(e,this.handleRemove)}catch(i){e.state=4,e._failTimes||(e._failTimes=0),e._failTimes++,e._lastFailTime=Date.now(),console.warn(`tile ${e.key} load error in ${this.name}`,i)}finally{this._markTileStateListenersNeedsUpdate(e),this.statistics.loading--,this._requestingCount--,this._logRequestEnd()}}}else e.state=2}else this._markTileStateListenersNeedsUpdate(e)}}getGroundTileData(e){return null}getTile(e,t,i,n,s){if(!this._compatible)return null;let o=e,r=t,a=i,l=o-this._maxLevel;if(l>0&&(o=this._maxLevel,r=t>>l,a=i>>l),this._shouldCheckTileAvailable)for(;!this.isTileAvailable(o,r,a);)if(l++,o--,r>>=1,a>>=1,o<0)return null;this._canUpsample||(t=r,i=a,e=o);const g=this._quadtree.getTile(e,t,i);return this._canUpsample&&e!==o|t!==r&&i!==a&&(g.needUpSample=!0),g?(this._initOrUpdateTileStateListeners(g,s),g):null}markTileUsed(e){this._usedTilesNum++,this._usedTiles[e.key]=!0,this._cache.markUsed(e)}_tileLevelInRange(e){return e>=this._startLevel&&e<=this._maxLevel}computeCoverageTilesCoord(e){const t=this._grid,i=e.grid,n=this._sourceProjection,s=i.targetProjection;return t.name===i.name&&n.name===s.name&&this._tileLevelInRange(e.z)?[[e.z,e.x,e.y]]:this.grid.computeCoverageTilesCoord(e,this._startLevel,this.grid.maxLevel)}clearCache(){this._cache&&this._cache.clear()}get maxCacheSize(){return this._maxCacheSize}set maxCacheSize(e){this._maxCacheSize=e}get desiredUpperSampleLevel(){return this._desiredUpperSampleLevel}set desiredUpperSampleLevel(e){this._desiredUpperSampleLevel=e}get loadingUpperSampleLevel(){return this._loadingUpperSampleLevel}set loadingUpperSampleLevel(e){this._loadingUpperSampleLevel=e}get grid(){return this._grid}get compatible(){return this._compatible}get projection(){return this._sourceProjection}get sourceProjection(){return this._sourceProjection}get targetProjection(){return this._targetProjection}set targetProjection(e){this._targetProjection=e}get initState(){return this._initState}get maxLevel(){return this._maxLevel}set maxLevel(e){this._maxLevel=e}get minLevel(){return this._minLevel}set minLevel(e){this._minLevel=e}get maxParallelRequestNum(){return this._maxParallelRequestNum}set maxParallelRequestNum(e){this._maxParallelRequestNum=e}get cacheMaxSize(){return this._cache&&this._cache.maxSize||0}set cacheMaxSize(e){this._cache&&this._cache.setMaxSize(e)}}const qV=as.merge([{opacity:{value:1},diffuseTextures:{value:null},textureTranslationAndScales:{value:null},colorAdjustments:{value:null},boundingRect:{value:new Dt}}]);class $V extends ls{constructor(e={}){super(),__publicField(this,"updateTextures",((e,t)=>{let i=[],n=[],s=[];for(const o of e){i.push(o.texture),n.push(new Dt(o.offsetX,o.offsetY,o.scaleX,o.scaleY));const e=o.colorTint;s.push(new Dt(e[0],e[1],e[2],o.opacity))}this.uniforms.boundingRect.value.fromArray(t),this.uniforms.diffuseTextures.value=i,this.uniforms.textureTranslationAndScales.value=n,this.uniforms.colorAdjustments.value=s,this.defines.NUM_TEXTURES!==e.length&&(this.defines.NUM_TEXTURES=e.length,this.needsUpdate=!0)})),__publicField(this,"forceUpdateTextureCount",(e=>{this.defines.NUM_TEXTURES=e,this.needsUpdate=!0})),this.name="RasterSurfaceMaterial",this.fragmentShader="#define GLSLIFY 1\n#include <common>\n\nvarying vec2 vUv;\n\nuniform float opacity;\n\n#include <logdepthbuf_pars_fragment>\n\n#if NUM_TEXTURES > 0\n    uniform sampler2D diffuseTextures[NUM_TEXTURES];\n    uniform vec4 textureTranslationAndScales[NUM_TEXTURES];\n    uniform vec4 colorAdjustments[NUM_TEXTURES];\n    uniform vec4 boundingRect;\n#endif\n\nvec4 sampleAndBlendColor(vec4 oldColor, sampler2D sampleTexture, vec4 translationAndScale, vec4 colorAdjustment) {\n    vec2 transformedUv = clamp(vUv, vec2(0.0), vec2(1.0));\n    transformedUv *= translationAndScale.zw;\n    transformedUv -= translationAndScale.xy;\n    if (transformedUv.x < 0.0 || transformedUv.y < 0.0 || transformedUv.x > 1.0 || transformedUv.y > 1.0) {\n        return oldColor;\n    }\n    vec4 sampleColor = texture2D(sampleTexture, transformedUv);\n    sampleColor *= colorAdjustment;\n    // sampleColor.a *= colorAdjustment.a;\n    vec3 mixColor = mix(oldColor.rgb, sampleColor.rgb, sampleColor.a);\n    return vec4(mixColor, oldColor.a + sampleColor.a);\n}\nvoid main() {\n\n    // gl_FragColor = vec4(0.5, 0.5, 0.5, 1.0);\n    // return;\n    #if NUM_TEXTURES > 0\n        if (boundingRect.x > -0.5 && (vUv.x < boundingRect.x || vUv.y < boundingRect.y || vUv.x > boundingRect.z || vUv.y > boundingRect.w)) {\n            discard;\n        }\n\n    #endif\n   \n    vec4 color = vec4(0);\n\n    #if NUM_TEXTURES > 0\n        color = sampleAndBlendColor(color, diffuseTextures[0], textureTranslationAndScales[0], colorAdjustments[0]);\n    #endif\n    #if NUM_TEXTURES > 1\n        color = sampleAndBlendColor(color, diffuseTextures[1], textureTranslationAndScales[1], colorAdjustments[1]);\n    #endif\n    #if NUM_TEXTURES > 2\n        color = sampleAndBlendColor(color, diffuseTextures[2], textureTranslationAndScales[2], colorAdjustments[2]);\n    #endif\n    #if NUM_TEXTURES > 3\n        color = sampleAndBlendColor(color, diffuseTextures[3], textureTranslationAndScales[3], colorAdjustments[3]);\n    #endif\n    #if NUM_TEXTURES > 4\n        color = sampleAndBlendColor(color, diffuseTextures[4], textureTranslationAndScales[4], colorAdjustments[4]);\n    #endif\n    #if NUM_TEXTURES > 5\n        color = sampleAndBlendColor(color, diffuseTextures[5], textureTranslationAndScales[5], colorAdjustments[5]);\n    #endif\n    #if NUM_TEXTURES > 6\n        color = sampleAndBlendColor(color, diffuseTextures[6], textureTranslationAndScales[6], colorAdjustments[6]);\n    #endif\n    #if NUM_TEXTURES > 7\n        color = sampleAndBlendColor(color, diffuseTextures[7], textureTranslationAndScales[7], colorAdjustments[7]);\n    #endif\n\n    gl_FragColor = color;\n    // gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);\n\n    #include <logdepthbuf_fragment>\n    #include <tonemapping_fragment>\n    #include <colorspace_fragment>\n    \n}\n\n",this.vertexShader="#define GLSLIFY 1\n#include <common>\nvarying vec2 vUv;\n\n#include <logdepthbuf_pars_vertex>\n\nvoid main() {\n\n    vUv = uv;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\n    #include <logdepthbuf_vertex>\n\n}\n\n",this.defines={NUM_TEXTURES:0},this.uniforms=as.clone(qV),e.textures&&this.updateTextures(e.textures,e.boundRect)}get textureCount(){return this.defines.NUM_TEXTURES}dispose(){super.dispose()}}const eW={},tW=e=>{if(!eW[e]){const t=new $V;t.name="RasterSurfaceMaterial_"+e,t.forceUpdateTextureCount(e),t.onBeforeRender=function(e,i,n,s,o,r){o.userData._boundingRect&&(t.uniforms.boundingRect.value=o.userData._boundingRect,t.uniforms.diffuseTextures.value=o.userData._diffuseTextures,t.uniforms.textureTranslationAndScales.value=o.userData._textureTranslationAndScales,t.uniforms.colorAdjustments.value=o.userData._colorAdjustments,t.uniformsNeedUpdate=!0)},eW[e]=t}return eW[e]},iW=(e,t,i)=>{let n=[],s=[],o=[];for(const r of t){n.push(r.texture),s.push(new Dt(r.offsetX,r.offsetY,r.scaleX,r.scaleY));const e=r.colorTint;o.push(new Dt(e[0],e[1],e[2],r.opacity))}e.userData._boundingRect=(new Dt).fromArray(i),e.userData._diffuseTextures=n,e.userData._textureTranslationAndScales=s,e.userData._colorAdjustments=o};class nW extends Ka{constructor(e,t=16776960){const i=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new Fn;n.setIndex(new Bn(i,1)),n.setAttribute("position",new Mn([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3)),super(n,new Wa({color:t,toneMapped:!1})),this.obb=e,this.type="OrientedBoundingBoxHelper",this.needsUpdateOBB=!0}setOBB(e,t){this.obb.center.copy(e),this.obb.halfAxes.copy(t),this.needsUpdateOBB=!0}updateMatrixWorld(e){if(this.needsUpdateOBB||e){this.needsUpdateOBB=!1;const e=this.obb.center,t=this.obb.halfAxes;this.position.copy(e);const i=new Qt,n=new Bi;for(let s=0;s<3;s++){let e=3*s;const o=new Qt(t.elements[e],t.elements[e+1],t.elements[e+2]);i.setComponent(s,o.length()),o.normalize(),e=4*s,n.elements[e]=o.x,n.elements[e+1]=o.y,n.elements[e+2]=o.z}this.scale.copy(i),this.quaternion.setFromRotationMatrix(n)}super.updateMatrixWorld(e)}dispose(){this.geometry.dispose(),this.material.dispose()}}class sW{constructor(e){this.tile=e}get boxHelper(){return this._boxHelper||(this.tile.boundingRegion?this._boxHelper=new nW(this.tile.boundingRegion._orientedBoundingBox,16711680):this.tile.targetBoundingBox?this._boxHelper=new Rg(this.tile.targetBoundingBox,16711680):console.warn("No bounding box")),this._boxHelper}}class oW extends YV{constructor(){super(...arguments),__publicField(this,"_tiles",new WeakMap)}forceUpdateTileState(e){const t=this._tiles.get(e);t&&(t.needsUpdate=!0,this._updateSurfaceTileData(t))}isTileNeedsLoading(e){if(!this._tiles.get(e))return!0}isTileComputable(e){const t=this._tiles.get(e);return!!t&&(t.needsUpdate&&this._updateSurfaceTileData(t),t.terrainTile&&3===t.terrainTile.state)}isTileRenderable(e){const t=this._tiles.get(e);return!!t&&(t.needsUpdate&&this._updateSurfaceTileData(t),0!==t.state)}isTileStable(e){const t=this._tiles.get(e);return!!t&&(t.needsUpdate&&this._updateSurfaceTileData(t),2===t.state)}markTileUsed(e){const t=this._tiles.get(e);if(!t)return null;const i=this._surface.terrainProvider,n=t.terrainTile;n&&i.markTileUsed(n);const s=t.imageryTiles,o=this._surface.imageryProviders;for(let r=0;r<s.length;++r){const e=s[r];if(!e)continue;const t=o[r];for(let i=0;i<e.length;++i){const n=e[i];n&&t.markTileUsed(n)}}}getSurfaceTile(e,t){const i=this._tiles.get(e);return i?(i.needsUpdate&&this._updateSurfaceTileData(i),0!==i.state?i:void 0):null}_updateSurfaceTileData(e){e.needsUpdate=!1;const t=e.state,i=e.terrainTile;if(3!==i.state)return e.state=0,void this._surface.quadMap._engine.requestRender();const n=e.imageryTiles,s=this._surface.imageryProviders;let o=0,r=0,a=0;const l=[],g=[];for(let h=0;h<n.length;++h){const e=n[h],t=s[h];if(t.ignoreLoadingState&&a++,!e||!t.compatible){l.push(""),o++;continue}let c=!1,d=!1;for(let n=0;n<e.length;++n){const s=e[n];if(s)if(3===s.state){t.markTileUsed(s);const e=this._getTileCoordConfig(i,s);g.push({texture:s.data,opacity:t.opacity,colorTint:t.randomColorTint?[Math.random(),Math.random(),Math.random()]:t.colorTint,...e}),l.push(s.key)}else{let e=this._getUpperSampleReadyTile(s,t);if(e){t.markTileUsed(e);const n=this._getTileCoordConfig(i,e);g.push({texture:e.data,opacity:t.opacity,colorTint:t.randomColorTint?[Math.random(),Math.random(),Math.random()]:t.colorTint,...n}),l.push(e.key),c=!0}else l.push(""),d=!0}}d?r++:c||o++}const c=l.join("|");let d=1;if(o>0&&o===s.length?(d=2,this._pendingCount--):r+a===s.length&&(d=0),2!==d&&this._surface.quadMap._engine.requestRender(),0!==d){if(0===t){const t=i.data,n=tW(g.length),s=new ts(t,n);iW(s,g,e.terrainBoundRect),s.position.copy(i.targetCenter),t._heights&&!e.tile._heights&&e.tile.grid.updateTileHeights(e.tile,t._heights),s.frustumCulled=!1,s.isTerrainTile=!0,e.object=s}else if(c!==e.loadStateKey){const t=e.object,i=tW(g.length);t.material=i,iW(t,g,e.terrainBoundRect)}e.state=d,e.loadStateKey=c}else e.state=d}_getTileCoordConfig(e,t){const i=e.grid,n=t.grid,s=i.rasterProjection,o=n.sourceProjection;if(s.name===o.name&&i.name===n.name&&e.z===t.z&&e.x===t.x&&e.y===t.y)return{offsetX:0,offsetY:0,scaleX:1,scaleY:1};let r=null,a=null;s.isGeo?(r=t.geoBoundingBox,a=e.geoBoundingBox):(r=t.targetBoundingBox,a=e.targetBoundingBox);const l=(a.max.x-a.min.x)/(r.max.x-r.min.x),g=(a.max.y-a.min.y)/(r.max.y-r.min.y);return{offsetX:(r.min.x-a.min.x)/(r.max.x-r.min.x),offsetY:(r.min.y-a.min.y)/(r.max.y-r.min.y),scaleX:l,scaleY:g}}_getUpperSampleReadyTile(e,t){let i=t.loadingUpperSampleLevel;if(0===i)return null;for(e=e.parent;i>0&&e;){if(3===e.state)return e;e=e.parent,i--}return null}_getCoverageTilesFromProvider(e,t){return t.computeCoverageTilesCoord(e)}_onlyRequestTileContents(e,t=!1){const i=e.terrainTile,n=e.imageryTiles,s=this._surface.terrainProvider,o=this._surface.imageryProviders;if(i&&s.requestTileData(i,e),!t)for(let r=0;r<n.length;++r){const t=n[r];if(!t)continue;const i=o[r];for(let n=0;n<t.length;++n){const s=t[n];s&&i.requestTileData(s,e)}}}requestSurfaceTile(e,t=!1){if(this._tiles.has(e)){const i=this._tiles.get(e);return i.needsUpdate&&this._updateSurfaceTileData(i),t?void(1!==i.state&&2!==i.state&&this._onlyRequestTileContents(i,!0)):void(2!==i.state&&this._onlyRequestTileContents(i))}const i=this._surface,n=i.terrainProvider;if(2!==n.initState)return;const s=i.imageryProviders;for(const l of s)if(2!==l.initState&&3!==l.initState)return;const o=new sW(e);o.state=0;const r=n.getTile(e.z,e.x,e.y,e,o);o.terrainBoundRect=n.grid.computeTileCoverageRect(r,e),n.requestTileData(r,o),o.terrainTile=r;const a=[];for(const l of s){if(!l.compatible){a.push(null);continue}const i=this._getCoverageTilesFromProvider(e,l),n=[];for(const s of i){const i=l.getTile(s[0],s[1],s[2],e,o);i&&(n.push(i),t||l.requestTileData(i,o))}a.push(n)}o.imageryTiles=a,t&&(o.needsUpdate=!0),this._tiles.set(e,o),this._pendingCount++}clear(){this._tiles=new WeakMap}dispose(){}}class rW extends KV{constructor(e,t,i={}){super(i),__publicField(this,"name","RasterSurface"),__publicField(this,"isMapRasterSurface",!0),this._terrainProvider=e,this._imageryProviders=t||[],this._surfaceTileManager=new oW(this),this.strategy||(this.strategy=new YZ(i))}addImageryLayer(e){this._imageryProviders.push(e)}removeImageryLayer(e){const t=this._imageryProviders.indexOf(e);t>-1&&this._imageryProviders.splice(t,1)}_getCurrentGrid(){return this._terrainProvider.grid}_updateMaxLevel(){let e=0;this._terrainProvider&&this._terrainProvider.maxLevel!==1/0&&(e=Math.max(e,this._terrainProvider.maxLevel));for(let t=0;t<this._imageryProviders.length;++t)this._imageryProviders[t].ignoreLevelLimit||this._imageryProviders[t].maxLevel!==1/0&&(e=Math.max(e,this._imageryProviders[t].maxLevel));this._maxLevel=e,this._minLevel=this._terrainProvider.minLevel}beginFrame(e){if(super.beginFrame(e),!this._terrainProvider)return!1;const t=this._quadMap._engine,i=t.map.projection;let n=null;if(this._terrainProvider&&(this._terrainProvider._engine=t,this._terrainProvider.targetProjection=i,this._terrainProvider.beginFrame(e),n=this._terrainProvider.rasterProjection,this._terrainProvider.isReady()))for(let s=0;s<this._imageryProviders.length;++s)this._imageryProviders[s]._engine=t,this._imageryProviders[s].targetProjection=n,this._imageryProviders[s].beginFrame(e);this._updateMaxLevel()}endFrame(e){this._terrainProvider&&this._terrainProvider.endFrame(e);for(let t=0;t<this._imageryProviders.length;++t)this._imageryProviders[t].endFrame(e);super.endFrame(e)}get terrainProvider(){return this._terrainProvider}set terrainProvider(e){this._terrainProvider!==e&&(this._terrainProvider&&this.clearTilesInView(),this._terrainProvider=e,this._surfaceTileManager.clear(),this._quadMap._engine.requestRender())}get imageryProviders(){return this._imageryProviders}set imageryProviders(e){this._imageryProviders=e,this._surfaceTileManager.clear(),this._quadMap._engine.requestRender()}}class aW extends YV{constructor(){super(...arguments),__publicField(this,"_tiles",new WeakMap)}isTileRenderable(e){const t=this._tiles.get(e);return!!t&&(t.needsUpdate&&this._updateSurfaceTileData(t),0!==t.state)}markTileUsed(e){const t=this._tiles.get(e);if(!t)return null;const i=this._surface.tileProvider,n=t.dataTile;n&&i.markTileUsed(n)}isTileNeedsLoading(e){return!this.isTileRenderable(e)}isTileComputable(e){const t=this._tiles.get(e);return!!t&&(t.needsUpdate&&this._updateSurfaceTileData(t),t.dataTile&&3===t.dataTile.state)}isTileStable(e){const t=this._tiles.get(e);return!!t&&(t.needsUpdate&&this._updateSurfaceTileData(t),2===t.state)}_updateSurfaceTileData(e){e.needsUpdate=!1;const t=e.dataTile,i=this._surface.quadMap._engine;if(3!==t.state)return e.state=0,void i.requestRender();e.state=2;const n=t.data;if(n&&n[0]){const t=n[0];e.object=t}if(n&&n[1]){const t=n[1];e.groundObject=t}}getSurfaceTile(e){const t=this._tiles.get(e);return t?(t.needsUpdate&&this._updateSurfaceTileData(t),0!==t.state?t:void 0):null}_onlyRequestTileContents(e){const t=e.dataTile,i=this._surface.tileProvider;t&&i.requestTileData(t,e)}requestSurfaceTile(e){if(this._tiles.has(e)){const t=this._tiles.get(e);return t.needsUpdate&&this._updateSurfaceTileData(t),void(2!==t.state&&this._onlyRequestTileContents(t))}const t=this._surface.tileProvider;if(2!==t.initState)return;const i=new sW(e);i.state=0;const n=t.getTile(e.z,e.x,e.y,null,i);t.requestTileData(n,i),i.dataTile=n,this._tiles.set(e,i)}clear(){this._tiles=new WeakMap}dispose(){}}class lW extends KV{constructor(e,t={}){super(t),__publicField(this,"name","VectorSurface"),__publicField(this,"isMapVectorSurface",!0),__publicField(this,"_useTargetProjectionBoundingBox",!0),__publicField(this,"_onTileCreated",(e=>{})),this._tileProvider=e,this._surfaceTileManager=new aW(this),this.strategy||(this.strategy=new KZ(t))}_getCurrentGrid(){return this._tileProvider.grid}beginFrame(e){if(super.beginFrame(e),!this._tileProvider)return!1;const t=this._quadMap._engine,i=t.map.projection;this._tileProvider&&(this._shouldRenderPlaceholder=this._tileProvider._shouldRenderPlaceholder,this._tileProvider._engine=t,this._tileProvider.targetProjection=i,this._tileProvider.beginFrame(e)),this._maxLevel=this._tileProvider.maxLevel,this._minLevel=this._tileProvider.minLevel}endFrame(e){super.endFrame(e)}onSurfaceTileAdded(e){this._tileProvider.onSurfaceTileAdded&&this._tileProvider.onSurfaceTileAdded(e,this.engine)}onSurfaceTileRemoved(e){this._tileProvider.onSurfaceTileRemoved&&this._tileProvider.onSurfaceTileRemoved(e,this.engine)}onSurfaceTileSSEChanged(e){this._tileProvider.onSurfaceTileSSEChanged&&this._tileProvider.onSurfaceTileSSEChanged(e,this.engine)}dispose(){super.dispose()}get tileProvider(){return this._tileProvider}set tileProvider(e){this._tileProvider!==e&&(this._tileProvider&&this.clearTilesInView(),this._tileProvider=e,this._surfaceTileManager.clear(),this._quadMap._engine.requestRender())}}class gW extends jV{async doRequestTileData(e){}onTileDispose(e){const t=e.data;t&&t.dispose()}}gW.heightmapTerrainQuality=.25,gW.getEstimatedLevelZeroGeometricErrorForAHeightmap=function(e,t,i){return 2*e.maximumRadius*Math.PI*gW.heightmapTerrainQuality/(t*i)};class cW extends UV{constructor(){super(...arguments),__publicField(this,"name","geo"),__publicField(this,"_useGeoSubdivision",!0),__publicField(this,"_minLevel",1)}getRootTiles(){const e=new kV(this,1,0,0);e.geoBoundingBox=new qt(new Qt(-180,-90,0),new Qt(0,90,0)),e.projectedBoundingBox=new qt(new Qt(-180,-90,0),new Qt(0,90,0));const t=new kV(this,1,1,0);return t.geoBoundingBox=new qt(new Qt(0,-90,0),new Qt(180,90,0)),t.projectedBoundingBox=new qt(new Qt(0,-90,0),new Qt(180,90,0)),[e,t]}getTileReverseY(e){return Math.pow(2,e.z-1)-e.y-1}getTileSizeAtLevel(e){return 360/Math.pow(2,e)}getTileCoordX(e,t){return(e+180)/t}getTileCoordY(e,t){return(e+90)/t}}new Qt,new Qt;class dW extends gW{constructor(){super(...arguments),__publicField(this,"name","PlaneTerrainTileProvider"),__publicField(this,"_supportedTargetProjectionNames",[Tb,Zb,Rb]),__publicField(this,"_levelZeroMaximumGeometricError",gW.getEstimatedLevelZeroGeometricErrorForAHeightmap(eA.WGS84,64,2))}initProjectionAndGrid(){this._targetProjection.name===Tb?(this._sourceProjection=this._targetProjection,this._grid=new JV(this._engine,this._sourceProjection,this._targetProjection)):(this._sourceProjection=Tv(Rb),this._grid=new cW(this._engine,this._sourceProjection,this._targetProjection));const e=this._targetProjection.name;let t=null;t=Tv(e===Tb?Tb:Rb),this.rasterProjection=t,this._grid.rasterProjection=t}doRequestTileData(e){const t={x:e.x,y:e.y,z:e.z,targetProjection:this._targetProjection,sourceProjection:this._sourceProjection,targetProjectionName:this._targetProjection.name,sourceProjectionName:this._sourceProjection.name,targetCenter:this._vectorToArray(e.targetCenter),geoBoundingBox:this._boxToArray(e.geoBoundingBox),forceProjectCoordinates:!0,projectedBoundingBox:e.projectedBoundingBox.isBox3?this._boxToArray(e.projectedBoundingBox):[]},i=xV(t,{normals:[0,0,1]}),n=new Fn;return n.setIndex(i.indices),n.setAttribute("position",new Mn(i.vertices,3)),n.setAttribute("normal",new Mn(i.normals,3)),n.setAttribute("uv",new Mn(i.uvs,2)),n}_vectorToArray(e){return[e.x,e.y,e.z]}_boxToArray(e){return[e.min.x,e.min.y,e.min.z,e.max.x,e.max.y,e.max.z]}}class hW extends ls{constructor(e={}){super(),this.name="ImageryReprojectMaterial",this.fragmentShader="\nuniform sampler2D map;\nuniform vec3 color;\nvarying vec2 vUv;\nvoid main() {\n    gl_FragColor = texture2D(map, vUv);\n    // gl_FragColor = vec4(color, 1.0);\n}\n",this.vertexShader="\n// attribute vec3 position;\n// attribute vec2 uv;\nvarying vec2 vUv;\nvoid main() {\n    vUv = uv;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",this.uniforms={map:{value:null},color:{value:new Qt(1,1,1)}}}dispose(){super.dispose()}}const uW=new Es(-.5,.5,.5,-.5,0,1),IW=new bt,pW=new Qt,mW=new Qt;class AW{_initResource(){this._renderTarget=new Yt(256,256),this._renderTarget.name="ImageryReprojector",this._renderTarget.texture.name="ImageryReprojector";const e=this._geometry=new xs(1,1,1,63);this._material=new hW,this._mesh=new ts(e,this._material)}reprojectImagery(e,t,i,n,s,o){this._mesh||this._initResource(),this._material.uniforms.map.value=i;const r=this._geometry.attributes.uv.array;let a=t.projectedBoundingBox.min.y,l=t.projectedBoundingBox.max.y;const g=t.geoBoundingBox.min.y,c=t.geoBoundingBox.max.y;if(s.name,o.name,s.isGeo){if(o.isGeo)throw new Error("Not implemented");{const e=1/(c-g);let i=t.targetBoundingBox.min.y,n=t.targetBoundingBox.max.y;for(let t=0;t<64;++t){let o=1-t/63,a=ft.lerp(i,n,o);pW.set(0,a,0),s.unprojectCoordinate(pW,mW);let l=(mW.y-g)*e;r[4*t+1]=l,r[4*t+3]=l}throw new Error("Need double check")}}{const e=1/(l-a);if(o.isGeo)for(let t=0;t<64;++t){let i=1-t/63,n=ft.lerp(g,c,i);pW.set(0,n,0),s.projectCoordinate(pW,mW);let o=(mW.y-a)*e;r[4*t+1]=o,r[4*t+3]=o}else for(let t=0;t<64;++t){let e=1-t/63,i=ft.lerp(a,l,e);pW.set(0,i,0),o.unprojectCoordinate(pW,mW),pW.copy(mW),s.projectCoordinate(pW,mW),r[4*t+1]=e,r[4*t+3]=e}}this._geometry.attributes.uv.needsUpdate=!0;const d=this._renderTarget;let h=e.getRenderTarget();return d.width===n.image.width&&d.height===n.image.height||d.setSize(n.image.width,n.image.height),e.setRenderTarget(d),e.clear(),e.render(this._mesh,uW),e.copyFramebufferToTexture(IW,n),e.setRenderTarget(h),d}dispose(){this._renderTarget.dispose(),this._mesh.geometry.dispose(),this._mesh.material.dispose()}}let CW;AW.DEFAULT=new AW;const fW=new Qt,bW=new Qt,yW=new Dl;class _W extends jV{constructor(e={}){super(e),__publicField(this,"name","ImageryTileProvider"),__publicField(this,"isImageryTileProvider",!0),__publicField(this,"_loadingUpperSampleLevel",100),this._opacity=e.opacity,this._colorTint=e.colorTint||[1,1,1],this._randomColorTint=e.randomColorTint||!1,void 0===this._opacity&&(this._opacity=1)}getTileURL(e,t,i,n){}shouldReproject(e,t,i){if(e.name===t.name)return!1;if(e.isGeo){if(t.isGeo)return!1;throw new Error("Not implemented")}if(t.isGeo){const t=(i.geoBoundingBox.min.y+i.geoBoundingBox.max.y)/2,n=(i.projectedBoundingBox.min.y+i.projectedBoundingBox.max.y)/2;fW.set(0,t,0),e.projectCoordinate(fW,bW);return Math.abs(bW.y-n)/i.grid.getPixelSizeByLevel(i.z)>.1}{const n=(i.projectedBoundingBox.min.y+i.projectedBoundingBox.max.y)/2;fW.set(0,n,0),e.unprojectCoordinate(fW,bW),fW.copy(bW),t.projectCoordinate(fW,bW);return Math.abs(bW.y-n)/i.grid.getPixelSizeByLevel(i.z)>.1}}doRequestTileData(e){const t=this.getTileURL(e.z,e.x,e.y,e);return e._url=t,new Promise(((i,n)=>{yW.load(t,(t=>{t.colorSpace=Ye,t.generateMipmaps=!1;let n=256,s=256;if(t.image&&(n=t.image.width,s=t.image.height),this.shouldReproject(this._sourceProjection,this._targetProjection,e)){const o=new qa(n,s);o.minFilter=W,o.magFilter=W,AW.DEFAULT.reprojectImagery(this._engine.renderer,e,t,o,this._sourceProjection,this._targetProjection),o.colorSpace=Ye,i(o),t.dispose()}else i(t)}),null,n)}))}errorFeedback(){return function(){if(!CW){const e=1,t=new Uint8Array(4*e);for(let i=0;i<t.length;++i)t[i]=0;CW=new ya(t,e,e,U),CW.needsUpdate=!0}return CW}()}onTileDispose(e){const t=e.data;t&&t.dispose()}set opacity(e){this._opacity=e}get opacity(){return this._opacity}set colorTint(e){this._colorTint=e}get colorTint(){return this._colorTint}set randomColorTint(e){this._randomColorTint!==e&&(this._randomColorTint=e,this._needsClearCache=!0)}get randomColorTint(){return this._randomColorTint}}class vW extends _W{constructor(e){super({...e,projection:Tb}),__publicField(this,"name","BingImageryTileProvider"),__publicField(this,"_supportedTargetProjectionNames",[Tb,Rb]),__publicField(this,"_defaultStartLevel",1),__publicField(this,"_defaultMaxLevel",18),__publicField(this,"_maxParallelRequestNum",24),__publicField(this,"_useWebMeractorProjectionAndGrid",!0)}getTileURL(e,t,i,n){if(0===e)return!1;const s=this.quadKey(e,t,n.reverseY);return`//ecn.t${s%4}.tiles.virtualearth.net/tiles/a${s}.jpeg?g=13651`}quadKey(e,t,i){let n="";for(let s=e;s>0;s--){const e=1<<s-1;let o=0;0!=(t&e)&&o++,0!=(i&e)&&(o+=2),n+=o}return n}}const xW=new Bi,BW=new ys,wW=new Qt,SW=new Qt;class GW extends Ji{constructor(e={}){super(),__publicField(this,"isQuadMap",!0),__publicField(this,"_freezeUpdate",!1),__publicField(this,"_lodScaleFactor",2),__publicField(this,"_cameraFarRatio",1),__publicField(this,"_camera",null),__publicField(this,"_lastUpdateTime",0),__publicField(this,"_delayUpdateTime",15),__publicField(this,"_delayUpdateTimeHandler",null),__publicField(this,"_restrictedBounds",[]),__publicField(this,"_engine"),__publicField(this,"_grid"),__publicField(this,"_options"),__publicField(this,"_surfaces",[]),__publicField(this,"_updateCameraInfo",((e,t)=>{e.rendering.resolution,t.projectionMatrix.elements;const i=t.matrixWorldInverse.elements;this._sseDenominator=2*Math.tan(.5*t.fov/180*Math.PI),wW.set(i[2],i[6],i[10]).normalize().negate(),e.map.isGlobe?SW.copy(t.position).normalize():SW.set(0,0,1),this._pitchRatio=wW.dot(SW)})),__publicField(this,"getKeyByValue",((e,t)=>{for(let i in e)if(e.hasOwnProperty(i)&&e[i].includes(t))return i===String(t)?null:i;return null})),__publicField(this,"handleTileLoaded",(e=>{const t=e.value;this._hirarchical&&t._heights&&(this._zCache[t.key]=t._heights),this.dispatchEvent(e),this._engine.requestRender()})),__publicField(this,"handleTileDispose",(e=>{this.onTileDisposed(e.value),this.dispatchEvent(e)})),__publicField(this,"addRestrictedBoundingBox",((e,t)=>{const i=this._engine.map;let n=i.projectArrayCoordinate(e),s=i.projectArrayCoordinate(t);const o=new qt;return o.min.set(n[0],n[1],n[2]||-100),o.max.set(s[0],s[1],n[2]||100),this._restrictedBounds.push(o),o})),__publicField(this,"removeRestrictedBounds",(e=>{this._restrictedBounds.includes(e)&&this._restrictedBounds.splice(e,1)})),this._options=e}addSurface(e){e.quadMap=this,e.engine=this._engine,this._surfaces.push(e),this.add(e)}addRasterSurface(e,t,i){const n=new rW(e,t,i);return this.addSurface(n),n}addVectorSurface(e,t){const i=new lW(e,t);return this.addSurface(i),i}removeSurface(e){const t=this._surfaces.indexOf(e);if(t>-1){const e=this._surfaces.splice(t,1)[0];e.clearTilesInView(),this.remove(e),e.quadMap=null}}setTerrainProvider(e){this._rasterSurface?this._rasterSurface.terrainProvider=e:console.warn("No raster surface")}setImageryProviders(e){this._rasterSurface?this._rasterSurface.imageryProviders=e:console.warn("No raster surface")}setImageryProvider(e){this.setImageryProviders([e])}setVectorProvider(e,t){if(this._vectorSurface)this._vectorSurface.tileProvider=e;else{if(!e)return;this._vectorSurface=this.addVectorSurface(e,t)}}getImageryProviders(){return this._rasterSurface?this._rasterSurface.imageryProviders:null}createTileLoader(){}createGrid(e){}afterAddToEngine(e){this._projection=e.map.projection,this._engine=e,this._initDefaultSurfaces()}_initDefaultSurfaces(){const e=this._options;if(e.rasterSurface)this._rasterSurface=e.rasterSurface,this.addSurface(e.rasterSurface);else{let t=e.terrainProvider;void 0===t&&(t=new dW({}));let i=e.imageryProviders;void 0===i&&(e.imageryProvider?i=[e.imageryProvider]:void 0===e.imageryProvider&&(i=[new vW({})])),t&&(this._rasterSurface=this.addRasterSurface(t,i))}e.vectorSurface?(this._vectorSurface=e.vectorSurface,this.addSurface(e.vectorSurface)):e.vectorProvider&&(this._vectorSurface=this.addVectorSurface(e.vectorProvider,e.vectorSurfaceOptions))}beforeRemoveFromEngine(e){this.dispose()}onBeforeScenePrepareRender(e,t,i,n){if(this._freezeUpdate||!this.visible)return clearTimeout(this._delayUpdateTimeHandler),void(this._delayUpdateTimeHandler=null);if(this._delayUpdateTimeHandler)return;const s=Date.now(),o=s-this._lastUpdateTime;if(o<this._delayUpdateTime)return void(this._delayUpdateTimeHandler=setTimeout((()=>{this._delayUpdateTimeHandler=null,e.requestRender()}),this._delayUpdateTime-o+1));let r=i;this._cameraFarRatio<1&&(this._camera||(this._camera=i.clone()),r=this._camera,r.copy(i),r.far=i.far*this._cameraFarRatio,r.updateProjectionMatrix()),this._updateCameraInfo(e,i),this._updateSurfaces(e,t,r,n),this._lastUpdateTime=s}onBeforeSceneRender(e,t,i,n){for(let s=0;s<this._surfaces.length;s++){const o=this._surfaces[s];o._onBeforeSceneRender&&o._onBeforeSceneRender(e,t,i,n)}}_updateSurfaces(e,t,i,n){xW.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),BW.setFromProjectionMatrix(xW),wW.copy(i.position);for(let s=0;s<this._surfaces.length;s++){this._surfaces[s].updateView(e,wW,BW,n)}}onTileAdded(e){}onTileRemoved(e){}onTileDisposed(e){}dispose(){}printSurfacesStatistics(){for(let e=0;e<this._surfaces.length;e++)this._surfaces[e]}_getCurrentCamera(){return this._cameraFarRatio<1&&this._camera||this._engine.camera}showCameraFrustum(){const e=this._engine;this.destroyCameraHelper();const t=this._getCurrentCamera(),i=this._lockedCamera=t.clone(),n=this._cameraHelper=new Gg(i);e.add(n)}destroyCameraHelper(){const e=this._engine;this._cameraHelper&&(e.remove(this._cameraHelper),this._cameraHelper.dispose(),this._cameraHelper=null)}get freezeUpdate(){return this._freezeUpdate}set freezeUpdate(e){this._freezeUpdate=e}get lodScaleFactor(){return this._lodScaleFactor}set lodScaleFactor(e){this._lodScaleFactor=e,this._engine.requestRender()}get cameraFarRatio(){return this._cameraFarRatio}set cameraFarRatio(e){this._cameraFarRatio=e}get rasterSurface(){return this._rasterSurface}get vectorSurface(){return this._vectorSurface}get surfaces(){return this._surfaces}}let MW;class RW extends jV{constructor(){super(...arguments),__publicField(this,"isVectorTileProvider",!0),__publicField(this,"name","VectorTileProvider")}errorFeedback(){return function(){if(!MW){MW=new qr;const e=new ts(new Fn,new Cn);MW.add(e)}return[MW,MW]}()}async doRequestTileData(e){}getGroundTileData(e){const t={x:e.x,y:e.y,z:e.z,targetProjection:e.grid.targetProjection,sourceProjection:e.grid.sourceProjection,targetProjectionName:e.grid.targetProjection.name,sourceProjectionName:e.grid.sourceProjection.name,targetCenter:e.targetCenter.toArray(),geoBoundingBox:e.availableGeoBoundingBox,forceUseGeoBoundingBox:!0,forceProjectCoordinates:!0,projectedBoundingBox:e.projectedBoundingBox.isBox3?e.projectedBoundingBox:[]},i=xV(t,{layerIndices:0}),n=new Fn;n.setIndex(i.indices),n.setAttribute("position",new Bn(new Float32Array(i.vertices),3)),n.setAttribute("layerIndex",new Bn(new Float32Array(i.layerIndices),1)),n.setAttribute("uv",new Bn(new Float32Array(i.uvs),2)),this._groundTileMaterial||(this._groundTileMaterial=new Cn({color:8947848}));const s=new ts(n,this._groundTileMaterial);return s.position.copy(e.targetCenter),[null,s]}}class TW{constructor(e,t){__publicField(this,"_size",1),__publicField(this,"_workerClass",null),__publicField(this,"_workers",[]),__publicField(this,"_currentRequestId",0),__publicField(this,"_requestMap",{}),__publicField(this,"_handleWorkerMessage",(async e=>{const t=e.data,i=this.getResponseMessageId(t,e);if(null==i)return void console.warn("no valid id in response message",e);const n=this._requestMap[i];if(!n)return void console.warn(`id ${i} not found in pending request`);if(this.onMessageReceived&&this.onMessageReceived(t,e),!this.isMessageCompleted(t,e))return;delete this._requestMap[i];const s=n[3];this._workers[s].use--;const o=await this.onMessageCompleted(t,e,n[2]);n[0](o)})),this._workerClass=e,this._size=t}getRequestMessageId(e){return this._currentRequestId++}getResponseMessageId(e,t){return e.id}_getAvailableWorker(){if(1===this._size)return this._workers[0].instance;let e=-1,t=1/0;for(let i=0;i<this._size;i++){const n=this._workers[i];n.use<t&&(e=i,t=n.use)}return[e,this._workers[e].instance]}initWorkers(){if(0===this._workers.length)for(let e=0;e<this._size;e++){const e=new this._workerClass;e.addEventListener("message",this._handleWorkerMessage),e.addEventListener("error",this.onWorkerError),this._workers.push({instance:e,use:0})}}async postMessage(e,t,i){null==i&&(i=this.getRequestMessageId(e)),this.initWorkers();const[n,s]=this._getAvailableWorker();return void 0!==e.id&&null!==e.id||(e.id=i),s.postMessage(e,t),this._workers[n].use++,new Promise(((t,s)=>{this._requestMap[i]=[t,s,e,n]}))}async onMessageCompleted(e,t){return e}isMessageCompleted(e,t){return!0}postMessageToAll(e,t){for(const i of this._workers)i.instance.postMessage(e,t)}get size(){return this._size}}class ZW{constructor(e,t,i){this.provider=e,this._workerTaskScheduler=new TW(t,i),this._workerTaskScheduler.getResponseMessageId=this.getResponseMessageId,this._workerTaskScheduler.isMessageCompleted=this.isMessageCompleted}isMessageCompleted(e,t){return"responseTile"===e.type}getResponseMessageId(e,t){return e.tileKey}_vectorToArray(e){return[e.x,e.y,e.z]}_boxToArray(e){return[e.min.x,e.min.y,e.min.z,e.max.x,e.max.y,e.max.z]}async requestTile(e){const t=this.provider;let i=t.getTileURL(e.z,e.x,e.y,e);const n={type:"requestTile",tileKey:e.key,sourceProjectionName:t.sourceProjection.name,targetProjectionName:t.targetProjection.name,projectedBoundingBox:this._boxToArray(e.projectedBoundingBox),geoBoundingBox:this._boxToArray(e.geoBoundingBox),projectedCenter:this._vectorToArray(e.projectedCenter),targetCenter:this._vectorToArray(e.targetCenter),id:e.id,x:e.x,y:e.y,z:e.z,reverseY:e.reverseY,url:i,timeStart:performance.now()};if(t.getFetchOptions){const i=t.getFetchOptions(e);n.fetchOptions=i}if(t.getWorkerOptions){const i=t.getWorkerOptions(e);n.workerOptions=i}return await this._workerTaskScheduler.postMessage(n,[],e.key)}postMessageToAll(e,t){this._workerTaskScheduler.initWorkers(),this._workerTaskScheduler.postMessageToAll(e,t)}}const VW="dmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKdmFyIF9fZGVmTm9ybWFsUHJvcCA9IChvYmosIGtleSwgdmFsdWUpID0+IGtleSBpbiBvYmogPyBfX2RlZlByb3Aob2JqLCBrZXksIHsgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSwgdmFsdWUgfSkgOiBvYmpba2V5XSA9IHZhbHVlOwp2YXIgX19wdWJsaWNGaWVsZCA9IChvYmosIGtleSwgdmFsdWUpID0+IHsKICBfX2RlZk5vcm1hbFByb3Aob2JqLCB0eXBlb2Yga2V5ICE9PSAic3ltYm9sIiA/IGtleSArICIiIDoga2V5LCB2YWx1ZSk7CiAgcmV0dXJuIHZhbHVlOwp9OwpmdW5jdGlvbiBjbGFtcCQxKHZhbHVlLCBtaW4sIG1heCkgewogIHJldHVybiBNYXRoLm1heChtaW4sIE1hdGgubWluKG1heCwgdmFsdWUpKTsKfQovKioKICogQGxpY2Vuc2UKICogQ29weXJpZ2h0IDIwMTAtMjAyMyBUaHJlZS5qcyBBdXRob3JzCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVQKICovCmNvbnN0IFJFVklTSU9OID0gIjE1OCI7CmNvbnN0IFdlYkdMQ29vcmRpbmF0ZVN5c3RlbSA9IDJlMzsKY29uc3QgV2ViR1BVQ29vcmRpbmF0ZVN5c3RlbSA9IDIwMDE7CmNvbnN0IF9sdXQgPSBbIjAwIiwgIjAxIiwgIjAyIiwgIjAzIiwgIjA0IiwgIjA1IiwgIjA2IiwgIjA3IiwgIjA4IiwgIjA5IiwgIjBhIiwgIjBiIiwgIjBjIiwgIjBkIiwgIjBlIiwgIjBmIiwgIjEwIiwgIjExIiwgIjEyIiwgIjEzIiwgIjE0IiwgIjE1IiwgIjE2IiwgIjE3IiwgIjE4IiwgIjE5IiwgIjFhIiwgIjFiIiwgIjFjIiwgIjFkIiwgIjFlIiwgIjFmIiwgIjIwIiwgIjIxIiwgIjIyIiwgIjIzIiwgIjI0IiwgIjI1IiwgIjI2IiwgIjI3IiwgIjI4IiwgIjI5IiwgIjJhIiwgIjJiIiwgIjJjIiwgIjJkIiwgIjJlIiwgIjJmIiwgIjMwIiwgIjMxIiwgIjMyIiwgIjMzIiwgIjM0IiwgIjM1IiwgIjM2IiwgIjM3IiwgIjM4IiwgIjM5IiwgIjNhIiwgIjNiIiwgIjNjIiwgIjNkIiwgIjNlIiwgIjNmIiwgIjQwIiwgIjQxIiwgIjQyIiwgIjQzIiwgIjQ0IiwgIjQ1IiwgIjQ2IiwgIjQ3IiwgIjQ4IiwgIjQ5IiwgIjRhIiwgIjRiIiwgIjRjIiwgIjRkIiwgIjRlIiwgIjRmIiwgIjUwIiwgIjUxIiwgIjUyIiwgIjUzIiwgIjU0IiwgIjU1IiwgIjU2IiwgIjU3IiwgIjU4IiwgIjU5IiwgIjVhIiwgIjViIiwgIjVjIiwgIjVkIiwgIjVlIiwgIjVmIiwgIjYwIiwgIjYxIiwgIjYyIiwgIjYzIiwgIjY0IiwgIjY1IiwgIjY2IiwgIjY3IiwgIjY4IiwgIjY5IiwgIjZhIiwgIjZiIiwgIjZjIiwgIjZkIiwgIjZlIiwgIjZmIiwgIjcwIiwgIjcxIiwgIjcyIiwgIjczIiwgIjc0IiwgIjc1IiwgIjc2IiwgIjc3IiwgIjc4IiwgIjc5IiwgIjdhIiwgIjdiIiwgIjdjIiwgIjdkIiwgIjdlIiwgIjdmIiwgIjgwIiwgIjgxIiwgIjgyIiwgIjgzIiwgIjg0IiwgIjg1IiwgIjg2IiwgIjg3IiwgIjg4IiwgIjg5IiwgIjhhIiwgIjhiIiwgIjhjIiwgIjhkIiwgIjhlIiwgIjhmIiwgIjkwIiwgIjkxIiwgIjkyIiwgIjkzIiwgIjk0IiwgIjk1IiwgIjk2IiwgIjk3IiwgIjk4IiwgIjk5IiwgIjlhIiwgIjliIiwgIjljIiwgIjlkIiwgIjllIiwgIjlmIiwgImEwIiwgImExIiwgImEyIiwgImEzIiwgImE0IiwgImE1IiwgImE2IiwgImE3IiwgImE4IiwgImE5IiwgImFhIiwgImFiIiwgImFjIiwgImFkIiwgImFlIiwgImFmIiwgImIwIiwgImIxIiwgImIyIiwgImIzIiwgImI0IiwgImI1IiwgImI2IiwgImI3IiwgImI4IiwgImI5IiwgImJhIiwgImJiIiwgImJjIiwgImJkIiwgImJlIiwgImJmIiwgImMwIiwgImMxIiwgImMyIiwgImMzIiwgImM0IiwgImM1IiwgImM2IiwgImM3IiwgImM4IiwgImM5IiwgImNhIiwgImNiIiwgImNjIiwgImNkIiwgImNlIiwgImNmIiwgImQwIiwgImQxIiwgImQyIiwgImQzIiwgImQ0IiwgImQ1IiwgImQ2IiwgImQ3IiwgImQ4IiwgImQ5IiwgImRhIiwgImRiIiwgImRjIiwgImRkIiwgImRlIiwgImRmIiwgImUwIiwgImUxIiwgImUyIiwgImUzIiwgImU0IiwgImU1IiwgImU2IiwgImU3IiwgImU4IiwgImU5IiwgImVhIiwgImViIiwgImVjIiwgImVkIiwgImVlIiwgImVmIiwgImYwIiwgImYxIiwgImYyIiwgImYzIiwgImY0IiwgImY1IiwgImY2IiwgImY3IiwgImY4IiwgImY5IiwgImZhIiwgImZiIiwgImZjIiwgImZkIiwgImZlIiwgImZmIl07CmxldCBfc2VlZCA9IDEyMzQ1Njc7CmNvbnN0IERFRzJSQUQgPSBNYXRoLlBJIC8gMTgwOwpjb25zdCBSQUQyREVHID0gMTgwIC8gTWF0aC5QSTsKZnVuY3Rpb24gZ2VuZXJhdGVVVUlEKCkgewogIGNvbnN0IGQwID0gTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTUgfCAwOwogIGNvbnN0IGQxID0gTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTUgfCAwOwogIGNvbnN0IGQyID0gTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTUgfCAwOwogIGNvbnN0IGQzID0gTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTUgfCAwOwogIGNvbnN0IHV1aWQgPSBfbHV0W2QwICYgMjU1XSArIF9sdXRbZDAgPj4gOCAmIDI1NV0gKyBfbHV0W2QwID4+IDE2ICYgMjU1XSArIF9sdXRbZDAgPj4gMjQgJiAyNTVdICsgIi0iICsgX2x1dFtkMSAmIDI1NV0gKyBfbHV0W2QxID4+IDggJiAyNTVdICsgIi0iICsgX2x1dFtkMSA+PiAxNiAmIDE1IHwgNjRdICsgX2x1dFtkMSA+PiAyNCAmIDI1NV0gKyAiLSIgKyBfbHV0W2QyICYgNjMgfCAxMjhdICsgX2x1dFtkMiA+PiA4ICYgMjU1XSArICItIiArIF9sdXRbZDIgPj4gMTYgJiAyNTVdICsgX2x1dFtkMiA+PiAyNCAmIDI1NV0gKyBfbHV0W2QzICYgMjU1XSArIF9sdXRbZDMgPj4gOCAmIDI1NV0gKyBfbHV0W2QzID4+IDE2ICYgMjU1XSArIF9sdXRbZDMgPj4gMjQgJiAyNTVdOwogIHJldHVybiB1dWlkLnRvTG93ZXJDYXNlKCk7Cn0KZnVuY3Rpb24gY2xhbXAodmFsdWUsIG1pbiwgbWF4KSB7CiAgcmV0dXJuIE1hdGgubWF4KG1pbiwgTWF0aC5taW4obWF4LCB2YWx1ZSkpOwp9CmZ1bmN0aW9uIGV1Y2xpZGVhbk1vZHVsbyhuLCBtKSB7CiAgcmV0dXJuIChuICUgbSArIG0pICUgbTsKfQpmdW5jdGlvbiBtYXBMaW5lYXIoeCwgYTEsIGEyLCBiMSwgYjIpIHsKICByZXR1cm4gYjEgKyAoeCAtIGExKSAqIChiMiAtIGIxKSAvIChhMiAtIGExKTsKfQpmdW5jdGlvbiBpbnZlcnNlTGVycCh4LCB5LCB2YWx1ZSkgewogIGlmICh4ICE9PSB5KSB7CiAgICByZXR1cm4gKHZhbHVlIC0geCkgLyAoeSAtIHgpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gMDsKICB9Cn0KZnVuY3Rpb24gbGVycCh4LCB5LCB0KSB7CiAgcmV0dXJuICgxIC0gdCkgKiB4ICsgdCAqIHk7Cn0KZnVuY3Rpb24gZGFtcCh4LCB5LCBsYW1iZGEsIGR0KSB7CiAgcmV0dXJuIGxlcnAoeCwgeSwgMSAtIE1hdGguZXhwKC1sYW1iZGEgKiBkdCkpOwp9CmZ1bmN0aW9uIHBpbmdwb25nKHgsIGxlbmd0aCA9IDEpIHsKICByZXR1cm4gbGVuZ3RoIC0gTWF0aC5hYnMoZXVjbGlkZWFuTW9kdWxvKHgsIGxlbmd0aCAqIDIpIC0gbGVuZ3RoKTsKfQpmdW5jdGlvbiBzbW9vdGhzdGVwKHgsIG1pbiwgbWF4KSB7CiAgaWYgKHggPD0gbWluKQogICAgcmV0dXJuIDA7CiAgaWYgKHggPj0gbWF4KQogICAgcmV0dXJuIDE7CiAgeCA9ICh4IC0gbWluKSAvIChtYXggLSBtaW4pOwogIHJldHVybiB4ICogeCAqICgzIC0gMiAqIHgpOwp9CmZ1bmN0aW9uIHNtb290aGVyc3RlcCh4LCBtaW4sIG1heCkgewogIGlmICh4IDw9IG1pbikKICAgIHJldHVybiAwOwogIGlmICh4ID49IG1heCkKICAgIHJldHVybiAxOwogIHggPSAoeCAtIG1pbikgLyAobWF4IC0gbWluKTsKICByZXR1cm4geCAqIHggKiB4ICogKHggKiAoeCAqIDYgLSAxNSkgKyAxMCk7Cn0KZnVuY3Rpb24gcmFuZEludChsb3csIGhpZ2gpIHsKICByZXR1cm4gbG93ICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKGhpZ2ggLSBsb3cgKyAxKSk7Cn0KZnVuY3Rpb24gcmFuZEZsb2F0KGxvdywgaGlnaCkgewogIHJldHVybiBsb3cgKyBNYXRoLnJhbmRvbSgpICogKGhpZ2ggLSBsb3cpOwp9CmZ1bmN0aW9uIHJhbmRGbG9hdFNwcmVhZChyYW5nZSkgewogIHJldHVybiByYW5nZSAqICgwLjUgLSBNYXRoLnJhbmRvbSgpKTsKfQpmdW5jdGlvbiBzZWVkZWRSYW5kb20ocykgewogIGlmIChzICE9PSB2b2lkIDApCiAgICBfc2VlZCA9IHM7CiAgbGV0IHQgPSBfc2VlZCArPSAxODMxNTY1ODEzOwogIHQgPSBNYXRoLmltdWwodCBeIHQgPj4+IDE1LCB0IHwgMSk7CiAgdCBePSB0ICsgTWF0aC5pbXVsKHQgXiB0ID4+PiA3LCB0IHwgNjEpOwogIHJldHVybiAoKHQgXiB0ID4+PiAxNCkgPj4+IDApIC8gNDI5NDk2NzI5NjsKfQpmdW5jdGlvbiBkZWdUb1JhZChkZWdyZWVzKSB7CiAgcmV0dXJuIGRlZ3JlZXMgKiBERUcyUkFEOwp9CmZ1bmN0aW9uIHJhZFRvRGVnKHJhZGlhbnMpIHsKICByZXR1cm4gcmFkaWFucyAqIFJBRDJERUc7Cn0KZnVuY3Rpb24gaXNQb3dlck9mVHdvKHZhbHVlKSB7CiAgcmV0dXJuICh2YWx1ZSAmIHZhbHVlIC0gMSkgPT09IDAgJiYgdmFsdWUgIT09IDA7Cn0KZnVuY3Rpb24gY2VpbFBvd2VyT2ZUd28odmFsdWUpIHsKICByZXR1cm4gTWF0aC5wb3coMiwgTWF0aC5jZWlsKE1hdGgubG9nKHZhbHVlKSAvIE1hdGguTE4yKSk7Cn0KZnVuY3Rpb24gZmxvb3JQb3dlck9mVHdvKHZhbHVlKSB7CiAgcmV0dXJuIE1hdGgucG93KDIsIE1hdGguZmxvb3IoTWF0aC5sb2codmFsdWUpIC8gTWF0aC5MTjIpKTsKfQpmdW5jdGlvbiBzZXRRdWF0ZXJuaW9uRnJvbVByb3BlckV1bGVyKHEsIGEsIGIsIGMsIG9yZGVyKSB7CiAgY29uc3QgY29zID0gTWF0aC5jb3M7CiAgY29uc3Qgc2luID0gTWF0aC5zaW47CiAgY29uc3QgYzIgPSBjb3MoYiAvIDIpOwogIGNvbnN0IHMyID0gc2luKGIgLyAyKTsKICBjb25zdCBjMTMgPSBjb3MoKGEgKyBjKSAvIDIpOwogIGNvbnN0IHMxMyA9IHNpbigoYSArIGMpIC8gMik7CiAgY29uc3QgYzFfMyA9IGNvcygoYSAtIGMpIC8gMik7CiAgY29uc3QgczFfMyA9IHNpbigoYSAtIGMpIC8gMik7CiAgY29uc3QgYzNfMSA9IGNvcygoYyAtIGEpIC8gMik7CiAgY29uc3QgczNfMSA9IHNpbigoYyAtIGEpIC8gMik7CiAgc3dpdGNoIChvcmRlcikgewogICAgY2FzZSAiWFlYIjoKICAgICAgcS5zZXQoYzIgKiBzMTMsIHMyICogYzFfMywgczIgKiBzMV8zLCBjMiAqIGMxMyk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiWVpZIjoKICAgICAgcS5zZXQoczIgKiBzMV8zLCBjMiAqIHMxMywgczIgKiBjMV8zLCBjMiAqIGMxMyk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiWlhaIjoKICAgICAgcS5zZXQoczIgKiBjMV8zLCBzMiAqIHMxXzMsIGMyICogczEzLCBjMiAqIGMxMyk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiWFpYIjoKICAgICAgcS5zZXQoYzIgKiBzMTMsIHMyICogczNfMSwgczIgKiBjM18xLCBjMiAqIGMxMyk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiWVhZIjoKICAgICAgcS5zZXQoczIgKiBjM18xLCBjMiAqIHMxMywgczIgKiBzM18xLCBjMiAqIGMxMyk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiWllaIjoKICAgICAgcS5zZXQoczIgKiBzM18xLCBzMiAqIGMzXzEsIGMyICogczEzLCBjMiAqIGMxMyk7CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgY29uc29sZS53YXJuKCJUSFJFRS5NYXRoVXRpbHM6IC5zZXRRdWF0ZXJuaW9uRnJvbVByb3BlckV1bGVyKCkgZW5jb3VudGVyZWQgYW4gdW5rbm93biBvcmRlcjogIiArIG9yZGVyKTsKICB9Cn0KZnVuY3Rpb24gZGVub3JtYWxpemUodmFsdWUsIGFycmF5KSB7CiAgc3dpdGNoIChhcnJheS5jb25zdHJ1Y3RvcikgewogICAgY2FzZSBGbG9hdDMyQXJyYXk6CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIGNhc2UgVWludDMyQXJyYXk6CiAgICAgIHJldHVybiB2YWx1ZSAvIDQyOTQ5NjcyOTU7CiAgICBjYXNlIFVpbnQxNkFycmF5OgogICAgICByZXR1cm4gdmFsdWUgLyA2NTUzNTsKICAgIGNhc2UgVWludDhBcnJheToKICAgICAgcmV0dXJuIHZhbHVlIC8gMjU1OwogICAgY2FzZSBJbnQzMkFycmF5OgogICAgICByZXR1cm4gTWF0aC5tYXgodmFsdWUgLyAyMTQ3NDgzNjQ3LCAtMSk7CiAgICBjYXNlIEludDE2QXJyYXk6CiAgICAgIHJldHVybiBNYXRoLm1heCh2YWx1ZSAvIDMyNzY3LCAtMSk7CiAgICBjYXNlIEludDhBcnJheToKICAgICAgcmV0dXJuIE1hdGgubWF4KHZhbHVlIC8gMTI3LCAtMSk7CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgY29tcG9uZW50IHR5cGUuIik7CiAgfQp9CmZ1bmN0aW9uIG5vcm1hbGl6ZSh2YWx1ZSwgYXJyYXkpIHsKICBzd2l0Y2ggKGFycmF5LmNvbnN0cnVjdG9yKSB7CiAgICBjYXNlIEZsb2F0MzJBcnJheToKICAgICAgcmV0dXJuIHZhbHVlOwogICAgY2FzZSBVaW50MzJBcnJheToKICAgICAgcmV0dXJuIE1hdGgucm91bmQodmFsdWUgKiA0Mjk0OTY3Mjk1KTsKICAgIGNhc2UgVWludDE2QXJyYXk6CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKHZhbHVlICogNjU1MzUpOwogICAgY2FzZSBVaW50OEFycmF5OgogICAgICByZXR1cm4gTWF0aC5yb3VuZCh2YWx1ZSAqIDI1NSk7CiAgICBjYXNlIEludDMyQXJyYXk6CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKHZhbHVlICogMjE0NzQ4MzY0Nyk7CiAgICBjYXNlIEludDE2QXJyYXk6CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKHZhbHVlICogMzI3NjcpOwogICAgY2FzZSBJbnQ4QXJyYXk6CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKHZhbHVlICogMTI3KTsKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBjb21wb25lbnQgdHlwZS4iKTsKICB9Cn0KY29uc3QgTWF0aFV0aWxzID0gewogIERFRzJSQUQsCiAgUkFEMkRFRywKICBnZW5lcmF0ZVVVSUQsCiAgY2xhbXAsCiAgZXVjbGlkZWFuTW9kdWxvLAogIG1hcExpbmVhciwKICBpbnZlcnNlTGVycCwKICBsZXJwLAogIGRhbXAsCiAgcGluZ3BvbmcsCiAgc21vb3Roc3RlcCwKICBzbW9vdGhlcnN0ZXAsCiAgcmFuZEludCwKICByYW5kRmxvYXQsCiAgcmFuZEZsb2F0U3ByZWFkLAogIHNlZWRlZFJhbmRvbSwKICBkZWdUb1JhZCwKICByYWRUb0RlZywKICBpc1Bvd2VyT2ZUd28sCiAgY2VpbFBvd2VyT2ZUd28sCiAgZmxvb3JQb3dlck9mVHdvLAogIHNldFF1YXRlcm5pb25Gcm9tUHJvcGVyRXVsZXIsCiAgbm9ybWFsaXplLAogIGRlbm9ybWFsaXplCn07CmNsYXNzIFZlY3RvcjIgewogIGNvbnN0cnVjdG9yKHggPSAwLCB5ID0gMCkgewogICAgVmVjdG9yMi5wcm90b3R5cGUuaXNWZWN0b3IyID0gdHJ1ZTsKICAgIHRoaXMueCA9IHg7CiAgICB0aGlzLnkgPSB5OwogIH0KICBnZXQgd2lkdGgoKSB7CiAgICByZXR1cm4gdGhpcy54OwogIH0KICBzZXQgd2lkdGgodmFsdWUpIHsKICAgIHRoaXMueCA9IHZhbHVlOwogIH0KICBnZXQgaGVpZ2h0KCkgewogICAgcmV0dXJuIHRoaXMueTsKICB9CiAgc2V0IGhlaWdodCh2YWx1ZSkgewogICAgdGhpcy55ID0gdmFsdWU7CiAgfQogIHNldCh4LCB5KSB7CiAgICB0aGlzLnggPSB4OwogICAgdGhpcy55ID0geTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRTY2FsYXIoc2NhbGFyKSB7CiAgICB0aGlzLnggPSBzY2FsYXI7CiAgICB0aGlzLnkgPSBzY2FsYXI7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0WCh4KSB7CiAgICB0aGlzLnggPSB4OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldFkoeSkgewogICAgdGhpcy55ID0geTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRDb21wb25lbnQoaW5kZXgsIHZhbHVlKSB7CiAgICBzd2l0Y2ggKGluZGV4KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICB0aGlzLnggPSB2YWx1ZTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMueSA9IHZhbHVlOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgb3V0IG9mIHJhbmdlOiAiICsgaW5kZXgpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIGdldENvbXBvbmVudChpbmRleCkgewogICAgc3dpdGNoIChpbmRleCkgewogICAgICBjYXNlIDA6CiAgICAgICAgcmV0dXJuIHRoaXMueDsKICAgICAgY2FzZSAxOgogICAgICAgIHJldHVybiB0aGlzLnk7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJpbmRleCBpcyBvdXQgb2YgcmFuZ2U6ICIgKyBpbmRleCk7CiAgICB9CiAgfQogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMueCwgdGhpcy55KTsKICB9CiAgY29weSh2KSB7CiAgICB0aGlzLnggPSB2Lng7CiAgICB0aGlzLnkgPSB2Lnk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgYWRkKHYpIHsKICAgIHRoaXMueCArPSB2Lng7CiAgICB0aGlzLnkgKz0gdi55OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFkZFNjYWxhcihzKSB7CiAgICB0aGlzLnggKz0gczsKICAgIHRoaXMueSArPSBzOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFkZFZlY3RvcnMoYSwgYikgewogICAgdGhpcy54ID0gYS54ICsgYi54OwogICAgdGhpcy55ID0gYS55ICsgYi55OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFkZFNjYWxlZFZlY3Rvcih2LCBzKSB7CiAgICB0aGlzLnggKz0gdi54ICogczsKICAgIHRoaXMueSArPSB2LnkgKiBzOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHN1Yih2KSB7CiAgICB0aGlzLnggLT0gdi54OwogICAgdGhpcy55IC09IHYueTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzdWJTY2FsYXIocykgewogICAgdGhpcy54IC09IHM7CiAgICB0aGlzLnkgLT0gczsKICAgIHJldHVybiB0aGlzOwogIH0KICBzdWJWZWN0b3JzKGEsIGIpIHsKICAgIHRoaXMueCA9IGEueCAtIGIueDsKICAgIHRoaXMueSA9IGEueSAtIGIueTsKICAgIHJldHVybiB0aGlzOwogIH0KICBtdWx0aXBseSh2KSB7CiAgICB0aGlzLnggKj0gdi54OwogICAgdGhpcy55ICo9IHYueTsKICAgIHJldHVybiB0aGlzOwogIH0KICBtdWx0aXBseVNjYWxhcihzY2FsYXIpIHsKICAgIHRoaXMueCAqPSBzY2FsYXI7CiAgICB0aGlzLnkgKj0gc2NhbGFyOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGRpdmlkZSh2KSB7CiAgICB0aGlzLnggLz0gdi54OwogICAgdGhpcy55IC89IHYueTsKICAgIHJldHVybiB0aGlzOwogIH0KICBkaXZpZGVTY2FsYXIoc2NhbGFyKSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseVNjYWxhcigxIC8gc2NhbGFyKTsKICB9CiAgYXBwbHlNYXRyaXgzKG0pIHsKICAgIGNvbnN0IHggPSB0aGlzLngsIHkgPSB0aGlzLnk7CiAgICBjb25zdCBlID0gbS5lbGVtZW50czsKICAgIHRoaXMueCA9IGVbMF0gKiB4ICsgZVszXSAqIHkgKyBlWzZdOwogICAgdGhpcy55ID0gZVsxXSAqIHggKyBlWzRdICogeSArIGVbN107CiAgICByZXR1cm4gdGhpczsKICB9CiAgbWluKHYpIHsKICAgIHRoaXMueCA9IE1hdGgubWluKHRoaXMueCwgdi54KTsKICAgIHRoaXMueSA9IE1hdGgubWluKHRoaXMueSwgdi55KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBtYXgodikgewogICAgdGhpcy54ID0gTWF0aC5tYXgodGhpcy54LCB2LngpOwogICAgdGhpcy55ID0gTWF0aC5tYXgodGhpcy55LCB2LnkpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGNsYW1wKG1pbiwgbWF4KSB7CiAgICB0aGlzLnggPSBNYXRoLm1heChtaW4ueCwgTWF0aC5taW4obWF4LngsIHRoaXMueCkpOwogICAgdGhpcy55ID0gTWF0aC5tYXgobWluLnksIE1hdGgubWluKG1heC55LCB0aGlzLnkpKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjbGFtcFNjYWxhcihtaW5WYWwsIG1heFZhbCkgewogICAgdGhpcy54ID0gTWF0aC5tYXgobWluVmFsLCBNYXRoLm1pbihtYXhWYWwsIHRoaXMueCkpOwogICAgdGhpcy55ID0gTWF0aC5tYXgobWluVmFsLCBNYXRoLm1pbihtYXhWYWwsIHRoaXMueSkpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGNsYW1wTGVuZ3RoKG1pbiwgbWF4KSB7CiAgICBjb25zdCBsZW5ndGggPSB0aGlzLmxlbmd0aCgpOwogICAgcmV0dXJuIHRoaXMuZGl2aWRlU2NhbGFyKGxlbmd0aCB8fCAxKS5tdWx0aXBseVNjYWxhcihNYXRoLm1heChtaW4sIE1hdGgubWluKG1heCwgbGVuZ3RoKSkpOwogIH0KICBmbG9vcigpIHsKICAgIHRoaXMueCA9IE1hdGguZmxvb3IodGhpcy54KTsKICAgIHRoaXMueSA9IE1hdGguZmxvb3IodGhpcy55KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjZWlsKCkgewogICAgdGhpcy54ID0gTWF0aC5jZWlsKHRoaXMueCk7CiAgICB0aGlzLnkgPSBNYXRoLmNlaWwodGhpcy55KTsKICAgIHJldHVybiB0aGlzOwogIH0KICByb3VuZCgpIHsKICAgIHRoaXMueCA9IE1hdGgucm91bmQodGhpcy54KTsKICAgIHRoaXMueSA9IE1hdGgucm91bmQodGhpcy55KTsKICAgIHJldHVybiB0aGlzOwogIH0KICByb3VuZFRvWmVybygpIHsKICAgIHRoaXMueCA9IE1hdGgudHJ1bmModGhpcy54KTsKICAgIHRoaXMueSA9IE1hdGgudHJ1bmModGhpcy55KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBuZWdhdGUoKSB7CiAgICB0aGlzLnggPSAtdGhpcy54OwogICAgdGhpcy55ID0gLXRoaXMueTsKICAgIHJldHVybiB0aGlzOwogIH0KICBkb3QodikgewogICAgcmV0dXJuIHRoaXMueCAqIHYueCArIHRoaXMueSAqIHYueTsKICB9CiAgY3Jvc3ModikgewogICAgcmV0dXJuIHRoaXMueCAqIHYueSAtIHRoaXMueSAqIHYueDsKICB9CiAgbGVuZ3RoU3EoKSB7CiAgICByZXR1cm4gdGhpcy54ICogdGhpcy54ICsgdGhpcy55ICogdGhpcy55OwogIH0KICBsZW5ndGgoKSB7CiAgICByZXR1cm4gTWF0aC5zcXJ0KHRoaXMueCAqIHRoaXMueCArIHRoaXMueSAqIHRoaXMueSk7CiAgfQogIG1hbmhhdHRhbkxlbmd0aCgpIHsKICAgIHJldHVybiBNYXRoLmFicyh0aGlzLngpICsgTWF0aC5hYnModGhpcy55KTsKICB9CiAgbm9ybWFsaXplKCkgewogICAgcmV0dXJuIHRoaXMuZGl2aWRlU2NhbGFyKHRoaXMubGVuZ3RoKCkgfHwgMSk7CiAgfQogIGFuZ2xlKCkgewogICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKC10aGlzLnksIC10aGlzLngpICsgTWF0aC5QSTsKICAgIHJldHVybiBhbmdsZTsKICB9CiAgYW5nbGVUbyh2KSB7CiAgICBjb25zdCBkZW5vbWluYXRvciA9IE1hdGguc3FydCh0aGlzLmxlbmd0aFNxKCkgKiB2Lmxlbmd0aFNxKCkpOwogICAgaWYgKGRlbm9taW5hdG9yID09PSAwKQogICAgICByZXR1cm4gTWF0aC5QSSAvIDI7CiAgICBjb25zdCB0aGV0YSA9IHRoaXMuZG90KHYpIC8gZGVub21pbmF0b3I7CiAgICByZXR1cm4gTWF0aC5hY29zKGNsYW1wKHRoZXRhLCAtMSwgMSkpOwogIH0KICBkaXN0YW5jZVRvKHYpIHsKICAgIHJldHVybiBNYXRoLnNxcnQodGhpcy5kaXN0YW5jZVRvU3F1YXJlZCh2KSk7CiAgfQogIGRpc3RhbmNlVG9TcXVhcmVkKHYpIHsKICAgIGNvbnN0IGR4ID0gdGhpcy54IC0gdi54LCBkeSA9IHRoaXMueSAtIHYueTsKICAgIHJldHVybiBkeCAqIGR4ICsgZHkgKiBkeTsKICB9CiAgbWFuaGF0dGFuRGlzdGFuY2VUbyh2KSB7CiAgICByZXR1cm4gTWF0aC5hYnModGhpcy54IC0gdi54KSArIE1hdGguYWJzKHRoaXMueSAtIHYueSk7CiAgfQogIHNldExlbmd0aChsZW5ndGgpIHsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKGxlbmd0aCk7CiAgfQogIGxlcnAodiwgYWxwaGEpIHsKICAgIHRoaXMueCArPSAodi54IC0gdGhpcy54KSAqIGFscGhhOwogICAgdGhpcy55ICs9ICh2LnkgLSB0aGlzLnkpICogYWxwaGE7CiAgICByZXR1cm4gdGhpczsKICB9CiAgbGVycFZlY3RvcnModjEsIHYyLCBhbHBoYSkgewogICAgdGhpcy54ID0gdjEueCArICh2Mi54IC0gdjEueCkgKiBhbHBoYTsKICAgIHRoaXMueSA9IHYxLnkgKyAodjIueSAtIHYxLnkpICogYWxwaGE7CiAgICByZXR1cm4gdGhpczsKICB9CiAgZXF1YWxzKHYpIHsKICAgIHJldHVybiB2LnggPT09IHRoaXMueCAmJiB2LnkgPT09IHRoaXMueTsKICB9CiAgZnJvbUFycmF5KGFycmF5LCBvZmZzZXQgPSAwKSB7CiAgICB0aGlzLnggPSBhcnJheVtvZmZzZXRdOwogICAgdGhpcy55ID0gYXJyYXlbb2Zmc2V0ICsgMV07CiAgICByZXR1cm4gdGhpczsKICB9CiAgdG9BcnJheShhcnJheSA9IFtdLCBvZmZzZXQgPSAwKSB7CiAgICBhcnJheVtvZmZzZXRdID0gdGhpcy54OwogICAgYXJyYXlbb2Zmc2V0ICsgMV0gPSB0aGlzLnk7CiAgICByZXR1cm4gYXJyYXk7CiAgfQogIGZyb21CdWZmZXJBdHRyaWJ1dGUoYXR0cmlidXRlLCBpbmRleCkgewogICAgdGhpcy54ID0gYXR0cmlidXRlLmdldFgoaW5kZXgpOwogICAgdGhpcy55ID0gYXR0cmlidXRlLmdldFkoaW5kZXgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJvdGF0ZUFyb3VuZChjZW50ZXIsIGFuZ2xlKSB7CiAgICBjb25zdCBjID0gTWF0aC5jb3MoYW5nbGUpLCBzID0gTWF0aC5zaW4oYW5nbGUpOwogICAgY29uc3QgeCA9IHRoaXMueCAtIGNlbnRlci54OwogICAgY29uc3QgeSA9IHRoaXMueSAtIGNlbnRlci55OwogICAgdGhpcy54ID0geCAqIGMgLSB5ICogcyArIGNlbnRlci54OwogICAgdGhpcy55ID0geCAqIHMgKyB5ICogYyArIGNlbnRlci55OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJhbmRvbSgpIHsKICAgIHRoaXMueCA9IE1hdGgucmFuZG9tKCk7CiAgICB0aGlzLnkgPSBNYXRoLnJhbmRvbSgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHlpZWxkIHRoaXMueDsKICAgIHlpZWxkIHRoaXMueTsKICB9Cn0KY2xhc3MgTWF0cml4MyB7CiAgY29uc3RydWN0b3IobjExLCBuMTIsIG4xMywgbjIxLCBuMjIsIG4yMywgbjMxLCBuMzIsIG4zMykgewogICAgTWF0cml4My5wcm90b3R5cGUuaXNNYXRyaXgzID0gdHJ1ZTsKICAgIHRoaXMuZWxlbWVudHMgPSBbCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgIF07CiAgICBpZiAobjExICE9PSB2b2lkIDApIHsKICAgICAgdGhpcy5zZXQobjExLCBuMTIsIG4xMywgbjIxLCBuMjIsIG4yMywgbjMxLCBuMzIsIG4zMyk7CiAgICB9CiAgfQogIHNldChuMTEsIG4xMiwgbjEzLCBuMjEsIG4yMiwgbjIzLCBuMzEsIG4zMiwgbjMzKSB7CiAgICBjb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CiAgICB0ZVswXSA9IG4xMTsKICAgIHRlWzFdID0gbjIxOwogICAgdGVbMl0gPSBuMzE7CiAgICB0ZVszXSA9IG4xMjsKICAgIHRlWzRdID0gbjIyOwogICAgdGVbNV0gPSBuMzI7CiAgICB0ZVs2XSA9IG4xMzsKICAgIHRlWzddID0gbjIzOwogICAgdGVbOF0gPSBuMzM7CiAgICByZXR1cm4gdGhpczsKICB9CiAgaWRlbnRpdHkoKSB7CiAgICB0aGlzLnNldCgKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjb3B5KG0pIHsKICAgIGNvbnN0IHRlID0gdGhpcy5lbGVtZW50czsKICAgIGNvbnN0IG1lID0gbS5lbGVtZW50czsKICAgIHRlWzBdID0gbWVbMF07CiAgICB0ZVsxXSA9IG1lWzFdOwogICAgdGVbMl0gPSBtZVsyXTsKICAgIHRlWzNdID0gbWVbM107CiAgICB0ZVs0XSA9IG1lWzRdOwogICAgdGVbNV0gPSBtZVs1XTsKICAgIHRlWzZdID0gbWVbNl07CiAgICB0ZVs3XSA9IG1lWzddOwogICAgdGVbOF0gPSBtZVs4XTsKICAgIHJldHVybiB0aGlzOwogIH0KICBleHRyYWN0QmFzaXMoeEF4aXMsIHlBeGlzLCB6QXhpcykgewogICAgeEF4aXMuc2V0RnJvbU1hdHJpeDNDb2x1bW4odGhpcywgMCk7CiAgICB5QXhpcy5zZXRGcm9tTWF0cml4M0NvbHVtbih0aGlzLCAxKTsKICAgIHpBeGlzLnNldEZyb21NYXRyaXgzQ29sdW1uKHRoaXMsIDIpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldEZyb21NYXRyaXg0KG0pIHsKICAgIGNvbnN0IG1lID0gbS5lbGVtZW50czsKICAgIHRoaXMuc2V0KAogICAgICBtZVswXSwKICAgICAgbWVbNF0sCiAgICAgIG1lWzhdLAogICAgICBtZVsxXSwKICAgICAgbWVbNV0sCiAgICAgIG1lWzldLAogICAgICBtZVsyXSwKICAgICAgbWVbNl0sCiAgICAgIG1lWzEwXQogICAgKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBtdWx0aXBseShtKSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseU1hdHJpY2VzKHRoaXMsIG0pOwogIH0KICBwcmVtdWx0aXBseShtKSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseU1hdHJpY2VzKG0sIHRoaXMpOwogIH0KICBtdWx0aXBseU1hdHJpY2VzKGEsIGIpIHsKICAgIGNvbnN0IGFlID0gYS5lbGVtZW50czsKICAgIGNvbnN0IGJlID0gYi5lbGVtZW50czsKICAgIGNvbnN0IHRlID0gdGhpcy5lbGVtZW50czsKICAgIGNvbnN0IGExMSA9IGFlWzBdLCBhMTIgPSBhZVszXSwgYTEzID0gYWVbNl07CiAgICBjb25zdCBhMjEgPSBhZVsxXSwgYTIyID0gYWVbNF0sIGEyMyA9IGFlWzddOwogICAgY29uc3QgYTMxID0gYWVbMl0sIGEzMiA9IGFlWzVdLCBhMzMgPSBhZVs4XTsKICAgIGNvbnN0IGIxMSA9IGJlWzBdLCBiMTIgPSBiZVszXSwgYjEzID0gYmVbNl07CiAgICBjb25zdCBiMjEgPSBiZVsxXSwgYjIyID0gYmVbNF0sIGIyMyA9IGJlWzddOwogICAgY29uc3QgYjMxID0gYmVbMl0sIGIzMiA9IGJlWzVdLCBiMzMgPSBiZVs4XTsKICAgIHRlWzBdID0gYTExICogYjExICsgYTEyICogYjIxICsgYTEzICogYjMxOwogICAgdGVbM10gPSBhMTEgKiBiMTIgKyBhMTIgKiBiMjIgKyBhMTMgKiBiMzI7CiAgICB0ZVs2XSA9IGExMSAqIGIxMyArIGExMiAqIGIyMyArIGExMyAqIGIzMzsKICAgIHRlWzFdID0gYTIxICogYjExICsgYTIyICogYjIxICsgYTIzICogYjMxOwogICAgdGVbNF0gPSBhMjEgKiBiMTIgKyBhMjIgKiBiMjIgKyBhMjMgKiBiMzI7CiAgICB0ZVs3XSA9IGEyMSAqIGIxMyArIGEyMiAqIGIyMyArIGEyMyAqIGIzMzsKICAgIHRlWzJdID0gYTMxICogYjExICsgYTMyICogYjIxICsgYTMzICogYjMxOwogICAgdGVbNV0gPSBhMzEgKiBiMTIgKyBhMzIgKiBiMjIgKyBhMzMgKiBiMzI7CiAgICB0ZVs4XSA9IGEzMSAqIGIxMyArIGEzMiAqIGIyMyArIGEzMyAqIGIzMzsKICAgIHJldHVybiB0aGlzOwogIH0KICBtdWx0aXBseVNjYWxhcihzKSB7CiAgICBjb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CiAgICB0ZVswXSAqPSBzOwogICAgdGVbM10gKj0gczsKICAgIHRlWzZdICo9IHM7CiAgICB0ZVsxXSAqPSBzOwogICAgdGVbNF0gKj0gczsKICAgIHRlWzddICo9IHM7CiAgICB0ZVsyXSAqPSBzOwogICAgdGVbNV0gKj0gczsKICAgIHRlWzhdICo9IHM7CiAgICByZXR1cm4gdGhpczsKICB9CiAgZGV0ZXJtaW5hbnQoKSB7CiAgICBjb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CiAgICBjb25zdCBhID0gdGVbMF0sIGIgPSB0ZVsxXSwgYyA9IHRlWzJdLCBkID0gdGVbM10sIGUgPSB0ZVs0XSwgZiA9IHRlWzVdLCBnID0gdGVbNl0sIGggPSB0ZVs3XSwgaSA9IHRlWzhdOwogICAgcmV0dXJuIGEgKiBlICogaSAtIGEgKiBmICogaCAtIGIgKiBkICogaSArIGIgKiBmICogZyArIGMgKiBkICogaCAtIGMgKiBlICogZzsKICB9CiAgaW52ZXJ0KCkgewogICAgY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzLCBuMTEgPSB0ZVswXSwgbjIxID0gdGVbMV0sIG4zMSA9IHRlWzJdLCBuMTIgPSB0ZVszXSwgbjIyID0gdGVbNF0sIG4zMiA9IHRlWzVdLCBuMTMgPSB0ZVs2XSwgbjIzID0gdGVbN10sIG4zMyA9IHRlWzhdLCB0MTEgPSBuMzMgKiBuMjIgLSBuMzIgKiBuMjMsIHQxMiA9IG4zMiAqIG4xMyAtIG4zMyAqIG4xMiwgdDEzID0gbjIzICogbjEyIC0gbjIyICogbjEzLCBkZXQgPSBuMTEgKiB0MTEgKyBuMjEgKiB0MTIgKyBuMzEgKiB0MTM7CiAgICBpZiAoZGV0ID09PSAwKQogICAgICByZXR1cm4gdGhpcy5zZXQoMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCk7CiAgICBjb25zdCBkZXRJbnYgPSAxIC8gZGV0OwogICAgdGVbMF0gPSB0MTEgKiBkZXRJbnY7CiAgICB0ZVsxXSA9IChuMzEgKiBuMjMgLSBuMzMgKiBuMjEpICogZGV0SW52OwogICAgdGVbMl0gPSAobjMyICogbjIxIC0gbjMxICogbjIyKSAqIGRldEludjsKICAgIHRlWzNdID0gdDEyICogZGV0SW52OwogICAgdGVbNF0gPSAobjMzICogbjExIC0gbjMxICogbjEzKSAqIGRldEludjsKICAgIHRlWzVdID0gKG4zMSAqIG4xMiAtIG4zMiAqIG4xMSkgKiBkZXRJbnY7CiAgICB0ZVs2XSA9IHQxMyAqIGRldEludjsKICAgIHRlWzddID0gKG4yMSAqIG4xMyAtIG4yMyAqIG4xMSkgKiBkZXRJbnY7CiAgICB0ZVs4XSA9IChuMjIgKiBuMTEgLSBuMjEgKiBuMTIpICogZGV0SW52OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHRyYW5zcG9zZSgpIHsKICAgIGxldCB0bXA7CiAgICBjb25zdCBtID0gdGhpcy5lbGVtZW50czsKICAgIHRtcCA9IG1bMV07CiAgICBtWzFdID0gbVszXTsKICAgIG1bM10gPSB0bXA7CiAgICB0bXAgPSBtWzJdOwogICAgbVsyXSA9IG1bNl07CiAgICBtWzZdID0gdG1wOwogICAgdG1wID0gbVs1XTsKICAgIG1bNV0gPSBtWzddOwogICAgbVs3XSA9IHRtcDsKICAgIHJldHVybiB0aGlzOwogIH0KICBnZXROb3JtYWxNYXRyaXgobWF0cml4NCkgewogICAgcmV0dXJuIHRoaXMuc2V0RnJvbU1hdHJpeDQobWF0cml4NCkuaW52ZXJ0KCkudHJhbnNwb3NlKCk7CiAgfQogIHRyYW5zcG9zZUludG9BcnJheShyKSB7CiAgICBjb25zdCBtID0gdGhpcy5lbGVtZW50czsKICAgIHJbMF0gPSBtWzBdOwogICAgclsxXSA9IG1bM107CiAgICByWzJdID0gbVs2XTsKICAgIHJbM10gPSBtWzFdOwogICAgcls0XSA9IG1bNF07CiAgICByWzVdID0gbVs3XTsKICAgIHJbNl0gPSBtWzJdOwogICAgcls3XSA9IG1bNV07CiAgICByWzhdID0gbVs4XTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRVdlRyYW5zZm9ybSh0eCwgdHksIHN4LCBzeSwgcm90YXRpb24sIGN4LCBjeSkgewogICAgY29uc3QgYyA9IE1hdGguY29zKHJvdGF0aW9uKTsKICAgIGNvbnN0IHMgPSBNYXRoLnNpbihyb3RhdGlvbik7CiAgICB0aGlzLnNldCgKICAgICAgc3ggKiBjLAogICAgICBzeCAqIHMsCiAgICAgIC1zeCAqIChjICogY3ggKyBzICogY3kpICsgY3ggKyB0eCwKICAgICAgLXN5ICogcywKICAgICAgc3kgKiBjLAogICAgICAtc3kgKiAoLXMgKiBjeCArIGMgKiBjeSkgKyBjeSArIHR5LAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNjYWxlKHN4LCBzeSkgewogICAgdGhpcy5wcmVtdWx0aXBseShfbTMubWFrZVNjYWxlKHN4LCBzeSkpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJvdGF0ZSh0aGV0YSkgewogICAgdGhpcy5wcmVtdWx0aXBseShfbTMubWFrZVJvdGF0aW9uKC10aGV0YSkpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHRyYW5zbGF0ZSh0eCwgdHkpIHsKICAgIHRoaXMucHJlbXVsdGlwbHkoX20zLm1ha2VUcmFuc2xhdGlvbih0eCwgdHkpKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBtYWtlVHJhbnNsYXRpb24oeCwgeSkgewogICAgaWYgKHguaXNWZWN0b3IyKSB7CiAgICAgIHRoaXMuc2V0KAogICAgICAgIDEsCiAgICAgICAgMCwKICAgICAgICB4LngsCiAgICAgICAgMCwKICAgICAgICAxLAogICAgICAgIHgueSwKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMQogICAgICApOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5zZXQoCiAgICAgICAgMSwKICAgICAgICAwLAogICAgICAgIHgsCiAgICAgICAgMCwKICAgICAgICAxLAogICAgICAgIHksCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDEKICAgICAgKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICBtYWtlUm90YXRpb24odGhldGEpIHsKICAgIGNvbnN0IGMgPSBNYXRoLmNvcyh0aGV0YSk7CiAgICBjb25zdCBzID0gTWF0aC5zaW4odGhldGEpOwogICAgdGhpcy5zZXQoCiAgICAgIGMsCiAgICAgIC1zLAogICAgICAwLAogICAgICBzLAogICAgICBjLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIG1ha2VTY2FsZSh4LCB5KSB7CiAgICB0aGlzLnNldCgKICAgICAgeCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgeSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBlcXVhbHMobWF0cml4KSB7CiAgICBjb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CiAgICBjb25zdCBtZSA9IG1hdHJpeC5lbGVtZW50czsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgOTsgaSsrKSB7CiAgICAgIGlmICh0ZVtpXSAhPT0gbWVbaV0pCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQogIGZyb21BcnJheShhcnJheSwgb2Zmc2V0ID0gMCkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCA5OyBpKyspIHsKICAgICAgdGhpcy5lbGVtZW50c1tpXSA9IGFycmF5W2kgKyBvZmZzZXRdOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHRvQXJyYXkoYXJyYXkgPSBbXSwgb2Zmc2V0ID0gMCkgewogICAgY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzOwogICAgYXJyYXlbb2Zmc2V0XSA9IHRlWzBdOwogICAgYXJyYXlbb2Zmc2V0ICsgMV0gPSB0ZVsxXTsKICAgIGFycmF5W29mZnNldCArIDJdID0gdGVbMl07CiAgICBhcnJheVtvZmZzZXQgKyAzXSA9IHRlWzNdOwogICAgYXJyYXlbb2Zmc2V0ICsgNF0gPSB0ZVs0XTsKICAgIGFycmF5W29mZnNldCArIDVdID0gdGVbNV07CiAgICBhcnJheVtvZmZzZXQgKyA2XSA9IHRlWzZdOwogICAgYXJyYXlbb2Zmc2V0ICsgN10gPSB0ZVs3XTsKICAgIGFycmF5W29mZnNldCArIDhdID0gdGVbOF07CiAgICByZXR1cm4gYXJyYXk7CiAgfQogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuZnJvbUFycmF5KHRoaXMuZWxlbWVudHMpOwogIH0KfQpjb25zdCBfbTMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hdHJpeDMoKTsKY2xhc3MgVmVjdG9yNCB7CiAgY29uc3RydWN0b3IoeCA9IDAsIHkgPSAwLCB6ID0gMCwgdyA9IDEpIHsKICAgIFZlY3RvcjQucHJvdG90eXBlLmlzVmVjdG9yNCA9IHRydWU7CiAgICB0aGlzLnggPSB4OwogICAgdGhpcy55ID0geTsKICAgIHRoaXMueiA9IHo7CiAgICB0aGlzLncgPSB3OwogIH0KICBnZXQgd2lkdGgoKSB7CiAgICByZXR1cm4gdGhpcy56OwogIH0KICBzZXQgd2lkdGgodmFsdWUpIHsKICAgIHRoaXMueiA9IHZhbHVlOwogIH0KICBnZXQgaGVpZ2h0KCkgewogICAgcmV0dXJuIHRoaXMudzsKICB9CiAgc2V0IGhlaWdodCh2YWx1ZSkgewogICAgdGhpcy53ID0gdmFsdWU7CiAgfQogIHNldCh4LCB5LCB6LCB3KSB7CiAgICB0aGlzLnggPSB4OwogICAgdGhpcy55ID0geTsKICAgIHRoaXMueiA9IHo7CiAgICB0aGlzLncgPSB3OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldFNjYWxhcihzY2FsYXIpIHsKICAgIHRoaXMueCA9IHNjYWxhcjsKICAgIHRoaXMueSA9IHNjYWxhcjsKICAgIHRoaXMueiA9IHNjYWxhcjsKICAgIHRoaXMudyA9IHNjYWxhcjsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRYKHgpIHsKICAgIHRoaXMueCA9IHg7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0WSh5KSB7CiAgICB0aGlzLnkgPSB5OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldFooeikgewogICAgdGhpcy56ID0gejsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRXKHcpIHsKICAgIHRoaXMudyA9IHc7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0Q29tcG9uZW50KGluZGV4LCB2YWx1ZSkgewogICAgc3dpdGNoIChpbmRleCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy54ID0gdmFsdWU7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLnkgPSB2YWx1ZTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMueiA9IHZhbHVlOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDM6CiAgICAgICAgdGhpcy53ID0gdmFsdWU7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJpbmRleCBpcyBvdXQgb2YgcmFuZ2U6ICIgKyBpbmRleCk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgZ2V0Q29tcG9uZW50KGluZGV4KSB7CiAgICBzd2l0Y2ggKGluZGV4KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICByZXR1cm4gdGhpcy54OwogICAgICBjYXNlIDE6CiAgICAgICAgcmV0dXJuIHRoaXMueTsKICAgICAgY2FzZSAyOgogICAgICAgIHJldHVybiB0aGlzLno7CiAgICAgIGNhc2UgMzoKICAgICAgICByZXR1cm4gdGhpcy53OwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgb3V0IG9mIHJhbmdlOiAiICsgaW5kZXgpOwogICAgfQogIH0KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLngsIHRoaXMueSwgdGhpcy56LCB0aGlzLncpOwogIH0KICBjb3B5KHYpIHsKICAgIHRoaXMueCA9IHYueDsKICAgIHRoaXMueSA9IHYueTsKICAgIHRoaXMueiA9IHYuejsKICAgIHRoaXMudyA9IHYudyAhPT0gdm9pZCAwID8gdi53IDogMTsKICAgIHJldHVybiB0aGlzOwogIH0KICBhZGQodikgewogICAgdGhpcy54ICs9IHYueDsKICAgIHRoaXMueSArPSB2Lnk7CiAgICB0aGlzLnogKz0gdi56OwogICAgdGhpcy53ICs9IHYudzsKICAgIHJldHVybiB0aGlzOwogIH0KICBhZGRTY2FsYXIocykgewogICAgdGhpcy54ICs9IHM7CiAgICB0aGlzLnkgKz0gczsKICAgIHRoaXMueiArPSBzOwogICAgdGhpcy53ICs9IHM7CiAgICByZXR1cm4gdGhpczsKICB9CiAgYWRkVmVjdG9ycyhhLCBiKSB7CiAgICB0aGlzLnggPSBhLnggKyBiLng7CiAgICB0aGlzLnkgPSBhLnkgKyBiLnk7CiAgICB0aGlzLnogPSBhLnogKyBiLno7CiAgICB0aGlzLncgPSBhLncgKyBiLnc7CiAgICByZXR1cm4gdGhpczsKICB9CiAgYWRkU2NhbGVkVmVjdG9yKHYsIHMpIHsKICAgIHRoaXMueCArPSB2LnggKiBzOwogICAgdGhpcy55ICs9IHYueSAqIHM7CiAgICB0aGlzLnogKz0gdi56ICogczsKICAgIHRoaXMudyArPSB2LncgKiBzOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHN1Yih2KSB7CiAgICB0aGlzLnggLT0gdi54OwogICAgdGhpcy55IC09IHYueTsKICAgIHRoaXMueiAtPSB2Lno7CiAgICB0aGlzLncgLT0gdi53OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHN1YlNjYWxhcihzKSB7CiAgICB0aGlzLnggLT0gczsKICAgIHRoaXMueSAtPSBzOwogICAgdGhpcy56IC09IHM7CiAgICB0aGlzLncgLT0gczsKICAgIHJldHVybiB0aGlzOwogIH0KICBzdWJWZWN0b3JzKGEsIGIpIHsKICAgIHRoaXMueCA9IGEueCAtIGIueDsKICAgIHRoaXMueSA9IGEueSAtIGIueTsKICAgIHRoaXMueiA9IGEueiAtIGIuejsKICAgIHRoaXMudyA9IGEudyAtIGIudzsKICAgIHJldHVybiB0aGlzOwogIH0KICBtdWx0aXBseSh2KSB7CiAgICB0aGlzLnggKj0gdi54OwogICAgdGhpcy55ICo9IHYueTsKICAgIHRoaXMueiAqPSB2Lno7CiAgICB0aGlzLncgKj0gdi53OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIG11bHRpcGx5U2NhbGFyKHNjYWxhcikgewogICAgdGhpcy54ICo9IHNjYWxhcjsKICAgIHRoaXMueSAqPSBzY2FsYXI7CiAgICB0aGlzLnogKj0gc2NhbGFyOwogICAgdGhpcy53ICo9IHNjYWxhcjsKICAgIHJldHVybiB0aGlzOwogIH0KICBhcHBseU1hdHJpeDQobSkgewogICAgY29uc3QgeCA9IHRoaXMueCwgeSA9IHRoaXMueSwgeiA9IHRoaXMueiwgdyA9IHRoaXMudzsKICAgIGNvbnN0IGUgPSBtLmVsZW1lbnRzOwogICAgdGhpcy54ID0gZVswXSAqIHggKyBlWzRdICogeSArIGVbOF0gKiB6ICsgZVsxMl0gKiB3OwogICAgdGhpcy55ID0gZVsxXSAqIHggKyBlWzVdICogeSArIGVbOV0gKiB6ICsgZVsxM10gKiB3OwogICAgdGhpcy56ID0gZVsyXSAqIHggKyBlWzZdICogeSArIGVbMTBdICogeiArIGVbMTRdICogdzsKICAgIHRoaXMudyA9IGVbM10gKiB4ICsgZVs3XSAqIHkgKyBlWzExXSAqIHogKyBlWzE1XSAqIHc7CiAgICByZXR1cm4gdGhpczsKICB9CiAgZGl2aWRlU2NhbGFyKHNjYWxhcikgewogICAgcmV0dXJuIHRoaXMubXVsdGlwbHlTY2FsYXIoMSAvIHNjYWxhcik7CiAgfQogIHNldEF4aXNBbmdsZUZyb21RdWF0ZXJuaW9uKHEpIHsKICAgIHRoaXMudyA9IDIgKiBNYXRoLmFjb3MocS53KTsKICAgIGNvbnN0IHMgPSBNYXRoLnNxcnQoMSAtIHEudyAqIHEudyk7CiAgICBpZiAocyA8IDFlLTQpIHsKICAgICAgdGhpcy54ID0gMTsKICAgICAgdGhpcy55ID0gMDsKICAgICAgdGhpcy56ID0gMDsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMueCA9IHEueCAvIHM7CiAgICAgIHRoaXMueSA9IHEueSAvIHM7CiAgICAgIHRoaXMueiA9IHEueiAvIHM7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0QXhpc0FuZ2xlRnJvbVJvdGF0aW9uTWF0cml4KG0pIHsKICAgIGxldCBhbmdsZSwgeCwgeSwgejsKICAgIGNvbnN0IGVwc2lsb24gPSAwLjAxLCBlcHNpbG9uMiA9IDAuMSwgdGUgPSBtLmVsZW1lbnRzLCBtMTEgPSB0ZVswXSwgbTEyID0gdGVbNF0sIG0xMyA9IHRlWzhdLCBtMjEgPSB0ZVsxXSwgbTIyID0gdGVbNV0sIG0yMyA9IHRlWzldLCBtMzEgPSB0ZVsyXSwgbTMyID0gdGVbNl0sIG0zMyA9IHRlWzEwXTsKICAgIGlmIChNYXRoLmFicyhtMTIgLSBtMjEpIDwgZXBzaWxvbiAmJiBNYXRoLmFicyhtMTMgLSBtMzEpIDwgZXBzaWxvbiAmJiBNYXRoLmFicyhtMjMgLSBtMzIpIDwgZXBzaWxvbikgewogICAgICBpZiAoTWF0aC5hYnMobTEyICsgbTIxKSA8IGVwc2lsb24yICYmIE1hdGguYWJzKG0xMyArIG0zMSkgPCBlcHNpbG9uMiAmJiBNYXRoLmFicyhtMjMgKyBtMzIpIDwgZXBzaWxvbjIgJiYgTWF0aC5hYnMobTExICsgbTIyICsgbTMzIC0gMykgPCBlcHNpbG9uMikgewogICAgICAgIHRoaXMuc2V0KDEsIDAsIDAsIDApOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIGFuZ2xlID0gTWF0aC5QSTsKICAgICAgY29uc3QgeHggPSAobTExICsgMSkgLyAyOwogICAgICBjb25zdCB5eSA9IChtMjIgKyAxKSAvIDI7CiAgICAgIGNvbnN0IHp6ID0gKG0zMyArIDEpIC8gMjsKICAgICAgY29uc3QgeHkgPSAobTEyICsgbTIxKSAvIDQ7CiAgICAgIGNvbnN0IHh6ID0gKG0xMyArIG0zMSkgLyA0OwogICAgICBjb25zdCB5eiA9IChtMjMgKyBtMzIpIC8gNDsKICAgICAgaWYgKHh4ID4geXkgJiYgeHggPiB6eikgewogICAgICAgIGlmICh4eCA8IGVwc2lsb24pIHsKICAgICAgICAgIHggPSAwOwogICAgICAgICAgeSA9IDAuNzA3MTA2NzgxOwogICAgICAgICAgeiA9IDAuNzA3MTA2NzgxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB4ID0gTWF0aC5zcXJ0KHh4KTsKICAgICAgICAgIHkgPSB4eSAvIHg7CiAgICAgICAgICB6ID0geHogLyB4OwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh5eSA+IHp6KSB7CiAgICAgICAgaWYgKHl5IDwgZXBzaWxvbikgewogICAgICAgICAgeCA9IDAuNzA3MTA2NzgxOwogICAgICAgICAgeSA9IDA7CiAgICAgICAgICB6ID0gMC43MDcxMDY3ODE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHkgPSBNYXRoLnNxcnQoeXkpOwogICAgICAgICAgeCA9IHh5IC8geTsKICAgICAgICAgIHogPSB5eiAvIHk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmICh6eiA8IGVwc2lsb24pIHsKICAgICAgICAgIHggPSAwLjcwNzEwNjc4MTsKICAgICAgICAgIHkgPSAwLjcwNzEwNjc4MTsKICAgICAgICAgIHogPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB6ID0gTWF0aC5zcXJ0KHp6KTsKICAgICAgICAgIHggPSB4eiAvIHo7CiAgICAgICAgICB5ID0geXogLyB6OwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLnNldCh4LCB5LCB6LCBhbmdsZSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgbGV0IHMgPSBNYXRoLnNxcnQoKG0zMiAtIG0yMykgKiAobTMyIC0gbTIzKSArIChtMTMgLSBtMzEpICogKG0xMyAtIG0zMSkgKyAobTIxIC0gbTEyKSAqIChtMjEgLSBtMTIpKTsKICAgIGlmIChNYXRoLmFicyhzKSA8IDFlLTMpCiAgICAgIHMgPSAxOwogICAgdGhpcy54ID0gKG0zMiAtIG0yMykgLyBzOwogICAgdGhpcy55ID0gKG0xMyAtIG0zMSkgLyBzOwogICAgdGhpcy56ID0gKG0yMSAtIG0xMikgLyBzOwogICAgdGhpcy53ID0gTWF0aC5hY29zKChtMTEgKyBtMjIgKyBtMzMgLSAxKSAvIDIpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIG1pbih2KSB7CiAgICB0aGlzLnggPSBNYXRoLm1pbih0aGlzLngsIHYueCk7CiAgICB0aGlzLnkgPSBNYXRoLm1pbih0aGlzLnksIHYueSk7CiAgICB0aGlzLnogPSBNYXRoLm1pbih0aGlzLnosIHYueik7CiAgICB0aGlzLncgPSBNYXRoLm1pbih0aGlzLncsIHYudyk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgbWF4KHYpIHsKICAgIHRoaXMueCA9IE1hdGgubWF4KHRoaXMueCwgdi54KTsKICAgIHRoaXMueSA9IE1hdGgubWF4KHRoaXMueSwgdi55KTsKICAgIHRoaXMueiA9IE1hdGgubWF4KHRoaXMueiwgdi56KTsKICAgIHRoaXMudyA9IE1hdGgubWF4KHRoaXMudywgdi53KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjbGFtcChtaW4sIG1heCkgewogICAgdGhpcy54ID0gTWF0aC5tYXgobWluLngsIE1hdGgubWluKG1heC54LCB0aGlzLngpKTsKICAgIHRoaXMueSA9IE1hdGgubWF4KG1pbi55LCBNYXRoLm1pbihtYXgueSwgdGhpcy55KSk7CiAgICB0aGlzLnogPSBNYXRoLm1heChtaW4ueiwgTWF0aC5taW4obWF4LnosIHRoaXMueikpOwogICAgdGhpcy53ID0gTWF0aC5tYXgobWluLncsIE1hdGgubWluKG1heC53LCB0aGlzLncpKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjbGFtcFNjYWxhcihtaW5WYWwsIG1heFZhbCkgewogICAgdGhpcy54ID0gTWF0aC5tYXgobWluVmFsLCBNYXRoLm1pbihtYXhWYWwsIHRoaXMueCkpOwogICAgdGhpcy55ID0gTWF0aC5tYXgobWluVmFsLCBNYXRoLm1pbihtYXhWYWwsIHRoaXMueSkpOwogICAgdGhpcy56ID0gTWF0aC5tYXgobWluVmFsLCBNYXRoLm1pbihtYXhWYWwsIHRoaXMueikpOwogICAgdGhpcy53ID0gTWF0aC5tYXgobWluVmFsLCBNYXRoLm1pbihtYXhWYWwsIHRoaXMudykpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGNsYW1wTGVuZ3RoKG1pbiwgbWF4KSB7CiAgICBjb25zdCBsZW5ndGggPSB0aGlzLmxlbmd0aCgpOwogICAgcmV0dXJuIHRoaXMuZGl2aWRlU2NhbGFyKGxlbmd0aCB8fCAxKS5tdWx0aXBseVNjYWxhcihNYXRoLm1heChtaW4sIE1hdGgubWluKG1heCwgbGVuZ3RoKSkpOwogIH0KICBmbG9vcigpIHsKICAgIHRoaXMueCA9IE1hdGguZmxvb3IodGhpcy54KTsKICAgIHRoaXMueSA9IE1hdGguZmxvb3IodGhpcy55KTsKICAgIHRoaXMueiA9IE1hdGguZmxvb3IodGhpcy56KTsKICAgIHRoaXMudyA9IE1hdGguZmxvb3IodGhpcy53KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjZWlsKCkgewogICAgdGhpcy54ID0gTWF0aC5jZWlsKHRoaXMueCk7CiAgICB0aGlzLnkgPSBNYXRoLmNlaWwodGhpcy55KTsKICAgIHRoaXMueiA9IE1hdGguY2VpbCh0aGlzLnopOwogICAgdGhpcy53ID0gTWF0aC5jZWlsKHRoaXMudyk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcm91bmQoKSB7CiAgICB0aGlzLnggPSBNYXRoLnJvdW5kKHRoaXMueCk7CiAgICB0aGlzLnkgPSBNYXRoLnJvdW5kKHRoaXMueSk7CiAgICB0aGlzLnogPSBNYXRoLnJvdW5kKHRoaXMueik7CiAgICB0aGlzLncgPSBNYXRoLnJvdW5kKHRoaXMudyk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcm91bmRUb1plcm8oKSB7CiAgICB0aGlzLnggPSBNYXRoLnRydW5jKHRoaXMueCk7CiAgICB0aGlzLnkgPSBNYXRoLnRydW5jKHRoaXMueSk7CiAgICB0aGlzLnogPSBNYXRoLnRydW5jKHRoaXMueik7CiAgICB0aGlzLncgPSBNYXRoLnRydW5jKHRoaXMudyk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgbmVnYXRlKCkgewogICAgdGhpcy54ID0gLXRoaXMueDsKICAgIHRoaXMueSA9IC10aGlzLnk7CiAgICB0aGlzLnogPSAtdGhpcy56OwogICAgdGhpcy53ID0gLXRoaXMudzsKICAgIHJldHVybiB0aGlzOwogIH0KICBkb3QodikgewogICAgcmV0dXJuIHRoaXMueCAqIHYueCArIHRoaXMueSAqIHYueSArIHRoaXMueiAqIHYueiArIHRoaXMudyAqIHYudzsKICB9CiAgbGVuZ3RoU3EoKSB7CiAgICByZXR1cm4gdGhpcy54ICogdGhpcy54ICsgdGhpcy55ICogdGhpcy55ICsgdGhpcy56ICogdGhpcy56ICsgdGhpcy53ICogdGhpcy53OwogIH0KICBsZW5ndGgoKSB7CiAgICByZXR1cm4gTWF0aC5zcXJ0KHRoaXMueCAqIHRoaXMueCArIHRoaXMueSAqIHRoaXMueSArIHRoaXMueiAqIHRoaXMueiArIHRoaXMudyAqIHRoaXMudyk7CiAgfQogIG1hbmhhdHRhbkxlbmd0aCgpIHsKICAgIHJldHVybiBNYXRoLmFicyh0aGlzLngpICsgTWF0aC5hYnModGhpcy55KSArIE1hdGguYWJzKHRoaXMueikgKyBNYXRoLmFicyh0aGlzLncpOwogIH0KICBub3JtYWxpemUoKSB7CiAgICByZXR1cm4gdGhpcy5kaXZpZGVTY2FsYXIodGhpcy5sZW5ndGgoKSB8fCAxKTsKICB9CiAgc2V0TGVuZ3RoKGxlbmd0aCkgewogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIobGVuZ3RoKTsKICB9CiAgbGVycCh2LCBhbHBoYSkgewogICAgdGhpcy54ICs9ICh2LnggLSB0aGlzLngpICogYWxwaGE7CiAgICB0aGlzLnkgKz0gKHYueSAtIHRoaXMueSkgKiBhbHBoYTsKICAgIHRoaXMueiArPSAodi56IC0gdGhpcy56KSAqIGFscGhhOwogICAgdGhpcy53ICs9ICh2LncgLSB0aGlzLncpICogYWxwaGE7CiAgICByZXR1cm4gdGhpczsKICB9CiAgbGVycFZlY3RvcnModjEsIHYyLCBhbHBoYSkgewogICAgdGhpcy54ID0gdjEueCArICh2Mi54IC0gdjEueCkgKiBhbHBoYTsKICAgIHRoaXMueSA9IHYxLnkgKyAodjIueSAtIHYxLnkpICogYWxwaGE7CiAgICB0aGlzLnogPSB2MS56ICsgKHYyLnogLSB2MS56KSAqIGFscGhhOwogICAgdGhpcy53ID0gdjEudyArICh2Mi53IC0gdjEudykgKiBhbHBoYTsKICAgIHJldHVybiB0aGlzOwogIH0KICBlcXVhbHModikgewogICAgcmV0dXJuIHYueCA9PT0gdGhpcy54ICYmIHYueSA9PT0gdGhpcy55ICYmIHYueiA9PT0gdGhpcy56ICYmIHYudyA9PT0gdGhpcy53OwogIH0KICBmcm9tQXJyYXkoYXJyYXksIG9mZnNldCA9IDApIHsKICAgIHRoaXMueCA9IGFycmF5W29mZnNldF07CiAgICB0aGlzLnkgPSBhcnJheVtvZmZzZXQgKyAxXTsKICAgIHRoaXMueiA9IGFycmF5W29mZnNldCArIDJdOwogICAgdGhpcy53ID0gYXJyYXlbb2Zmc2V0ICsgM107CiAgICByZXR1cm4gdGhpczsKICB9CiAgdG9BcnJheShhcnJheSA9IFtdLCBvZmZzZXQgPSAwKSB7CiAgICBhcnJheVtvZmZzZXRdID0gdGhpcy54OwogICAgYXJyYXlbb2Zmc2V0ICsgMV0gPSB0aGlzLnk7CiAgICBhcnJheVtvZmZzZXQgKyAyXSA9IHRoaXMuejsKICAgIGFycmF5W29mZnNldCArIDNdID0gdGhpcy53OwogICAgcmV0dXJuIGFycmF5OwogIH0KICBmcm9tQnVmZmVyQXR0cmlidXRlKGF0dHJpYnV0ZSwgaW5kZXgpIHsKICAgIHRoaXMueCA9IGF0dHJpYnV0ZS5nZXRYKGluZGV4KTsKICAgIHRoaXMueSA9IGF0dHJpYnV0ZS5nZXRZKGluZGV4KTsKICAgIHRoaXMueiA9IGF0dHJpYnV0ZS5nZXRaKGluZGV4KTsKICAgIHRoaXMudyA9IGF0dHJpYnV0ZS5nZXRXKGluZGV4KTsKICAgIHJldHVybiB0aGlzOwogIH0KICByYW5kb20oKSB7CiAgICB0aGlzLnggPSBNYXRoLnJhbmRvbSgpOwogICAgdGhpcy55ID0gTWF0aC5yYW5kb20oKTsKICAgIHRoaXMueiA9IE1hdGgucmFuZG9tKCk7CiAgICB0aGlzLncgPSBNYXRoLnJhbmRvbSgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHlpZWxkIHRoaXMueDsKICAgIHlpZWxkIHRoaXMueTsKICAgIHlpZWxkIHRoaXMuejsKICAgIHlpZWxkIHRoaXMudzsKICB9Cn0KY2xhc3MgUXVhdGVybmlvbiQxIHsKICBjb25zdHJ1Y3Rvcih4ID0gMCwgeSA9IDAsIHogPSAwLCB3ID0gMSkgewogICAgdGhpcy5pc1F1YXRlcm5pb24gPSB0cnVlOwogICAgdGhpcy5feCA9IHg7CiAgICB0aGlzLl95ID0geTsKICAgIHRoaXMuX3ogPSB6OwogICAgdGhpcy5fdyA9IHc7CiAgfQogIHN0YXRpYyBzbGVycEZsYXQoZHN0LCBkc3RPZmZzZXQsIHNyYzAsIHNyY09mZnNldDAsIHNyYzEsIHNyY09mZnNldDEsIHQpIHsKICAgIGxldCB4MCA9IHNyYzBbc3JjT2Zmc2V0MCArIDBdLCB5MCA9IHNyYzBbc3JjT2Zmc2V0MCArIDFdLCB6MCA9IHNyYzBbc3JjT2Zmc2V0MCArIDJdLCB3MCA9IHNyYzBbc3JjT2Zmc2V0MCArIDNdOwogICAgY29uc3QgeDEgPSBzcmMxW3NyY09mZnNldDEgKyAwXSwgeTEgPSBzcmMxW3NyY09mZnNldDEgKyAxXSwgejEgPSBzcmMxW3NyY09mZnNldDEgKyAyXSwgdzEgPSBzcmMxW3NyY09mZnNldDEgKyAzXTsKICAgIGlmICh0ID09PSAwKSB7CiAgICAgIGRzdFtkc3RPZmZzZXQgKyAwXSA9IHgwOwogICAgICBkc3RbZHN0T2Zmc2V0ICsgMV0gPSB5MDsKICAgICAgZHN0W2RzdE9mZnNldCArIDJdID0gejA7CiAgICAgIGRzdFtkc3RPZmZzZXQgKyAzXSA9IHcwOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodCA9PT0gMSkgewogICAgICBkc3RbZHN0T2Zmc2V0ICsgMF0gPSB4MTsKICAgICAgZHN0W2RzdE9mZnNldCArIDFdID0geTE7CiAgICAgIGRzdFtkc3RPZmZzZXQgKyAyXSA9IHoxOwogICAgICBkc3RbZHN0T2Zmc2V0ICsgM10gPSB3MTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHcwICE9PSB3MSB8fCB4MCAhPT0geDEgfHwgeTAgIT09IHkxIHx8IHowICE9PSB6MSkgewogICAgICBsZXQgcyA9IDEgLSB0OwogICAgICBjb25zdCBjb3MgPSB4MCAqIHgxICsgeTAgKiB5MSArIHowICogejEgKyB3MCAqIHcxLCBkaXIgPSBjb3MgPj0gMCA/IDEgOiAtMSwgc3FyU2luID0gMSAtIGNvcyAqIGNvczsKICAgICAgaWYgKHNxclNpbiA+IE51bWJlci5FUFNJTE9OKSB7CiAgICAgICAgY29uc3Qgc2luID0gTWF0aC5zcXJ0KHNxclNpbiksIGxlbiA9IE1hdGguYXRhbjIoc2luLCBjb3MgKiBkaXIpOwogICAgICAgIHMgPSBNYXRoLnNpbihzICogbGVuKSAvIHNpbjsKICAgICAgICB0ID0gTWF0aC5zaW4odCAqIGxlbikgLyBzaW47CiAgICAgIH0KICAgICAgY29uc3QgdERpciA9IHQgKiBkaXI7CiAgICAgIHgwID0geDAgKiBzICsgeDEgKiB0RGlyOwogICAgICB5MCA9IHkwICogcyArIHkxICogdERpcjsKICAgICAgejAgPSB6MCAqIHMgKyB6MSAqIHREaXI7CiAgICAgIHcwID0gdzAgKiBzICsgdzEgKiB0RGlyOwogICAgICBpZiAocyA9PT0gMSAtIHQpIHsKICAgICAgICBjb25zdCBmID0gMSAvIE1hdGguc3FydCh4MCAqIHgwICsgeTAgKiB5MCArIHowICogejAgKyB3MCAqIHcwKTsKICAgICAgICB4MCAqPSBmOwogICAgICAgIHkwICo9IGY7CiAgICAgICAgejAgKj0gZjsKICAgICAgICB3MCAqPSBmOwogICAgICB9CiAgICB9CiAgICBkc3RbZHN0T2Zmc2V0XSA9IHgwOwogICAgZHN0W2RzdE9mZnNldCArIDFdID0geTA7CiAgICBkc3RbZHN0T2Zmc2V0ICsgMl0gPSB6MDsKICAgIGRzdFtkc3RPZmZzZXQgKyAzXSA9IHcwOwogIH0KICBzdGF0aWMgbXVsdGlwbHlRdWF0ZXJuaW9uc0ZsYXQoZHN0LCBkc3RPZmZzZXQsIHNyYzAsIHNyY09mZnNldDAsIHNyYzEsIHNyY09mZnNldDEpIHsKICAgIGNvbnN0IHgwID0gc3JjMFtzcmNPZmZzZXQwXTsKICAgIGNvbnN0IHkwID0gc3JjMFtzcmNPZmZzZXQwICsgMV07CiAgICBjb25zdCB6MCA9IHNyYzBbc3JjT2Zmc2V0MCArIDJdOwogICAgY29uc3QgdzAgPSBzcmMwW3NyY09mZnNldDAgKyAzXTsKICAgIGNvbnN0IHgxID0gc3JjMVtzcmNPZmZzZXQxXTsKICAgIGNvbnN0IHkxID0gc3JjMVtzcmNPZmZzZXQxICsgMV07CiAgICBjb25zdCB6MSA9IHNyYzFbc3JjT2Zmc2V0MSArIDJdOwogICAgY29uc3QgdzEgPSBzcmMxW3NyY09mZnNldDEgKyAzXTsKICAgIGRzdFtkc3RPZmZzZXRdID0geDAgKiB3MSArIHcwICogeDEgKyB5MCAqIHoxIC0gejAgKiB5MTsKICAgIGRzdFtkc3RPZmZzZXQgKyAxXSA9IHkwICogdzEgKyB3MCAqIHkxICsgejAgKiB4MSAtIHgwICogejE7CiAgICBkc3RbZHN0T2Zmc2V0ICsgMl0gPSB6MCAqIHcxICsgdzAgKiB6MSArIHgwICogeTEgLSB5MCAqIHgxOwogICAgZHN0W2RzdE9mZnNldCArIDNdID0gdzAgKiB3MSAtIHgwICogeDEgLSB5MCAqIHkxIC0gejAgKiB6MTsKICAgIHJldHVybiBkc3Q7CiAgfQogIGdldCB4KCkgewogICAgcmV0dXJuIHRoaXMuX3g7CiAgfQogIHNldCB4KHZhbHVlKSB7CiAgICB0aGlzLl94ID0gdmFsdWU7CiAgICB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgfQogIGdldCB5KCkgewogICAgcmV0dXJuIHRoaXMuX3k7CiAgfQogIHNldCB5KHZhbHVlKSB7CiAgICB0aGlzLl95ID0gdmFsdWU7CiAgICB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgfQogIGdldCB6KCkgewogICAgcmV0dXJuIHRoaXMuX3o7CiAgfQogIHNldCB6KHZhbHVlKSB7CiAgICB0aGlzLl96ID0gdmFsdWU7CiAgICB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgfQogIGdldCB3KCkgewogICAgcmV0dXJuIHRoaXMuX3c7CiAgfQogIHNldCB3KHZhbHVlKSB7CiAgICB0aGlzLl93ID0gdmFsdWU7CiAgICB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgfQogIHNldCh4LCB5LCB6LCB3KSB7CiAgICB0aGlzLl94ID0geDsKICAgIHRoaXMuX3kgPSB5OwogICAgdGhpcy5feiA9IHo7CiAgICB0aGlzLl93ID0gdzsKICAgIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLl94LCB0aGlzLl95LCB0aGlzLl96LCB0aGlzLl93KTsKICB9CiAgY29weShxdWF0ZXJuaW9uKSB7CiAgICB0aGlzLl94ID0gcXVhdGVybmlvbi54OwogICAgdGhpcy5feSA9IHF1YXRlcm5pb24ueTsKICAgIHRoaXMuX3ogPSBxdWF0ZXJuaW9uLno7CiAgICB0aGlzLl93ID0gcXVhdGVybmlvbi53OwogICAgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldEZyb21FdWxlcihldWxlciwgdXBkYXRlKSB7CiAgICBjb25zdCB4ID0gZXVsZXIuX3gsIHkgPSBldWxlci5feSwgeiA9IGV1bGVyLl96LCBvcmRlciA9IGV1bGVyLl9vcmRlcjsKICAgIGNvbnN0IGNvcyA9IE1hdGguY29zOwogICAgY29uc3Qgc2luID0gTWF0aC5zaW47CiAgICBjb25zdCBjMSA9IGNvcyh4IC8gMik7CiAgICBjb25zdCBjMiA9IGNvcyh5IC8gMik7CiAgICBjb25zdCBjMyA9IGNvcyh6IC8gMik7CiAgICBjb25zdCBzMSA9IHNpbih4IC8gMik7CiAgICBjb25zdCBzMiA9IHNpbih5IC8gMik7CiAgICBjb25zdCBzMyA9IHNpbih6IC8gMik7CiAgICBzd2l0Y2ggKG9yZGVyKSB7CiAgICAgIGNhc2UgIlhZWiI6CiAgICAgICAgdGhpcy5feCA9IHMxICogYzIgKiBjMyArIGMxICogczIgKiBzMzsKICAgICAgICB0aGlzLl95ID0gYzEgKiBzMiAqIGMzIC0gczEgKiBjMiAqIHMzOwogICAgICAgIHRoaXMuX3ogPSBjMSAqIGMyICogczMgKyBzMSAqIHMyICogYzM7CiAgICAgICAgdGhpcy5fdyA9IGMxICogYzIgKiBjMyAtIHMxICogczIgKiBzMzsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiWVhaIjoKICAgICAgICB0aGlzLl94ID0gczEgKiBjMiAqIGMzICsgYzEgKiBzMiAqIHMzOwogICAgICAgIHRoaXMuX3kgPSBjMSAqIHMyICogYzMgLSBzMSAqIGMyICogczM7CiAgICAgICAgdGhpcy5feiA9IGMxICogYzIgKiBzMyAtIHMxICogczIgKiBjMzsKICAgICAgICB0aGlzLl93ID0gYzEgKiBjMiAqIGMzICsgczEgKiBzMiAqIHMzOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJaWFkiOgogICAgICAgIHRoaXMuX3ggPSBzMSAqIGMyICogYzMgLSBjMSAqIHMyICogczM7CiAgICAgICAgdGhpcy5feSA9IGMxICogczIgKiBjMyArIHMxICogYzIgKiBzMzsKICAgICAgICB0aGlzLl96ID0gYzEgKiBjMiAqIHMzICsgczEgKiBzMiAqIGMzOwogICAgICAgIHRoaXMuX3cgPSBjMSAqIGMyICogYzMgLSBzMSAqIHMyICogczM7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIlpZWCI6CiAgICAgICAgdGhpcy5feCA9IHMxICogYzIgKiBjMyAtIGMxICogczIgKiBzMzsKICAgICAgICB0aGlzLl95ID0gYzEgKiBzMiAqIGMzICsgczEgKiBjMiAqIHMzOwogICAgICAgIHRoaXMuX3ogPSBjMSAqIGMyICogczMgLSBzMSAqIHMyICogYzM7CiAgICAgICAgdGhpcy5fdyA9IGMxICogYzIgKiBjMyArIHMxICogczIgKiBzMzsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiWVpYIjoKICAgICAgICB0aGlzLl94ID0gczEgKiBjMiAqIGMzICsgYzEgKiBzMiAqIHMzOwogICAgICAgIHRoaXMuX3kgPSBjMSAqIHMyICogYzMgKyBzMSAqIGMyICogczM7CiAgICAgICAgdGhpcy5feiA9IGMxICogYzIgKiBzMyAtIHMxICogczIgKiBjMzsKICAgICAgICB0aGlzLl93ID0gYzEgKiBjMiAqIGMzIC0gczEgKiBzMiAqIHMzOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJYWlkiOgogICAgICAgIHRoaXMuX3ggPSBzMSAqIGMyICogYzMgLSBjMSAqIHMyICogczM7CiAgICAgICAgdGhpcy5feSA9IGMxICogczIgKiBjMyAtIHMxICogYzIgKiBzMzsKICAgICAgICB0aGlzLl96ID0gYzEgKiBjMiAqIHMzICsgczEgKiBzMiAqIGMzOwogICAgICAgIHRoaXMuX3cgPSBjMSAqIGMyICogYzMgKyBzMSAqIHMyICogczM7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgY29uc29sZS53YXJuKCJUSFJFRS5RdWF0ZXJuaW9uOiAuc2V0RnJvbUV1bGVyKCkgZW5jb3VudGVyZWQgYW4gdW5rbm93biBvcmRlcjogIiArIG9yZGVyKTsKICAgIH0KICAgIGlmICh1cGRhdGUgIT09IGZhbHNlKQogICAgICB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0RnJvbUF4aXNBbmdsZShheGlzLCBhbmdsZSkgewogICAgY29uc3QgaGFsZkFuZ2xlID0gYW5nbGUgLyAyLCBzID0gTWF0aC5zaW4oaGFsZkFuZ2xlKTsKICAgIHRoaXMuX3ggPSBheGlzLnggKiBzOwogICAgdGhpcy5feSA9IGF4aXMueSAqIHM7CiAgICB0aGlzLl96ID0gYXhpcy56ICogczsKICAgIHRoaXMuX3cgPSBNYXRoLmNvcyhoYWxmQW5nbGUpOwogICAgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldEZyb21Sb3RhdGlvbk1hdHJpeChtKSB7CiAgICBjb25zdCB0ZSA9IG0uZWxlbWVudHMsIG0xMSA9IHRlWzBdLCBtMTIgPSB0ZVs0XSwgbTEzID0gdGVbOF0sIG0yMSA9IHRlWzFdLCBtMjIgPSB0ZVs1XSwgbTIzID0gdGVbOV0sIG0zMSA9IHRlWzJdLCBtMzIgPSB0ZVs2XSwgbTMzID0gdGVbMTBdLCB0cmFjZSA9IG0xMSArIG0yMiArIG0zMzsKICAgIGlmICh0cmFjZSA+IDApIHsKICAgICAgY29uc3QgcyA9IDAuNSAvIE1hdGguc3FydCh0cmFjZSArIDEpOwogICAgICB0aGlzLl93ID0gMC4yNSAvIHM7CiAgICAgIHRoaXMuX3ggPSAobTMyIC0gbTIzKSAqIHM7CiAgICAgIHRoaXMuX3kgPSAobTEzIC0gbTMxKSAqIHM7CiAgICAgIHRoaXMuX3ogPSAobTIxIC0gbTEyKSAqIHM7CiAgICB9IGVsc2UgaWYgKG0xMSA+IG0yMiAmJiBtMTEgPiBtMzMpIHsKICAgICAgY29uc3QgcyA9IDIgKiBNYXRoLnNxcnQoMSArIG0xMSAtIG0yMiAtIG0zMyk7CiAgICAgIHRoaXMuX3cgPSAobTMyIC0gbTIzKSAvIHM7CiAgICAgIHRoaXMuX3ggPSAwLjI1ICogczsKICAgICAgdGhpcy5feSA9IChtMTIgKyBtMjEpIC8gczsKICAgICAgdGhpcy5feiA9IChtMTMgKyBtMzEpIC8gczsKICAgIH0gZWxzZSBpZiAobTIyID4gbTMzKSB7CiAgICAgIGNvbnN0IHMgPSAyICogTWF0aC5zcXJ0KDEgKyBtMjIgLSBtMTEgLSBtMzMpOwogICAgICB0aGlzLl93ID0gKG0xMyAtIG0zMSkgLyBzOwogICAgICB0aGlzLl94ID0gKG0xMiArIG0yMSkgLyBzOwogICAgICB0aGlzLl95ID0gMC4yNSAqIHM7CiAgICAgIHRoaXMuX3ogPSAobTIzICsgbTMyKSAvIHM7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBzID0gMiAqIE1hdGguc3FydCgxICsgbTMzIC0gbTExIC0gbTIyKTsKICAgICAgdGhpcy5fdyA9IChtMjEgLSBtMTIpIC8gczsKICAgICAgdGhpcy5feCA9IChtMTMgKyBtMzEpIC8gczsKICAgICAgdGhpcy5feSA9IChtMjMgKyBtMzIpIC8gczsKICAgICAgdGhpcy5feiA9IDAuMjUgKiBzOwogICAgfQogICAgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldEZyb21Vbml0VmVjdG9ycyh2RnJvbSwgdlRvKSB7CiAgICBsZXQgciA9IHZGcm9tLmRvdCh2VG8pICsgMTsKICAgIGlmIChyIDwgTnVtYmVyLkVQU0lMT04pIHsKICAgICAgciA9IDA7CiAgICAgIGlmIChNYXRoLmFicyh2RnJvbS54KSA+IE1hdGguYWJzKHZGcm9tLnopKSB7CiAgICAgICAgdGhpcy5feCA9IC12RnJvbS55OwogICAgICAgIHRoaXMuX3kgPSB2RnJvbS54OwogICAgICAgIHRoaXMuX3ogPSAwOwogICAgICAgIHRoaXMuX3cgPSByOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX3ggPSAwOwogICAgICAgIHRoaXMuX3kgPSAtdkZyb20uejsKICAgICAgICB0aGlzLl96ID0gdkZyb20ueTsKICAgICAgICB0aGlzLl93ID0gcjsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5feCA9IHZGcm9tLnkgKiB2VG8ueiAtIHZGcm9tLnogKiB2VG8ueTsKICAgICAgdGhpcy5feSA9IHZGcm9tLnogKiB2VG8ueCAtIHZGcm9tLnggKiB2VG8uejsKICAgICAgdGhpcy5feiA9IHZGcm9tLnggKiB2VG8ueSAtIHZGcm9tLnkgKiB2VG8ueDsKICAgICAgdGhpcy5fdyA9IHI7CiAgICB9CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemUoKTsKICB9CiAgYW5nbGVUbyhxKSB7CiAgICByZXR1cm4gMiAqIE1hdGguYWNvcyhNYXRoLmFicyhjbGFtcCh0aGlzLmRvdChxKSwgLTEsIDEpKSk7CiAgfQogIHJvdGF0ZVRvd2FyZHMocSwgc3RlcCkgewogICAgY29uc3QgYW5nbGUgPSB0aGlzLmFuZ2xlVG8ocSk7CiAgICBpZiAoYW5nbGUgPT09IDApCiAgICAgIHJldHVybiB0aGlzOwogICAgY29uc3QgdCA9IE1hdGgubWluKDEsIHN0ZXAgLyBhbmdsZSk7CiAgICB0aGlzLnNsZXJwKHEsIHQpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGlkZW50aXR5KCkgewogICAgcmV0dXJuIHRoaXMuc2V0KDAsIDAsIDAsIDEpOwogIH0KICBpbnZlcnQoKSB7CiAgICByZXR1cm4gdGhpcy5jb25qdWdhdGUoKTsKICB9CiAgY29uanVnYXRlKCkgewogICAgdGhpcy5feCAqPSAtMTsKICAgIHRoaXMuX3kgKj0gLTE7CiAgICB0aGlzLl96ICo9IC0xOwogICAgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGRvdCh2KSB7CiAgICByZXR1cm4gdGhpcy5feCAqIHYuX3ggKyB0aGlzLl95ICogdi5feSArIHRoaXMuX3ogKiB2Ll96ICsgdGhpcy5fdyAqIHYuX3c7CiAgfQogIGxlbmd0aFNxKCkgewogICAgcmV0dXJuIHRoaXMuX3ggKiB0aGlzLl94ICsgdGhpcy5feSAqIHRoaXMuX3kgKyB0aGlzLl96ICogdGhpcy5feiArIHRoaXMuX3cgKiB0aGlzLl93OwogIH0KICBsZW5ndGgoKSB7CiAgICByZXR1cm4gTWF0aC5zcXJ0KHRoaXMuX3ggKiB0aGlzLl94ICsgdGhpcy5feSAqIHRoaXMuX3kgKyB0aGlzLl96ICogdGhpcy5feiArIHRoaXMuX3cgKiB0aGlzLl93KTsKICB9CiAgbm9ybWFsaXplKCkgewogICAgbGV0IGwgPSB0aGlzLmxlbmd0aCgpOwogICAgaWYgKGwgPT09IDApIHsKICAgICAgdGhpcy5feCA9IDA7CiAgICAgIHRoaXMuX3kgPSAwOwogICAgICB0aGlzLl96ID0gMDsKICAgICAgdGhpcy5fdyA9IDE7CiAgICB9IGVsc2UgewogICAgICBsID0gMSAvIGw7CiAgICAgIHRoaXMuX3ggPSB0aGlzLl94ICogbDsKICAgICAgdGhpcy5feSA9IHRoaXMuX3kgKiBsOwogICAgICB0aGlzLl96ID0gdGhpcy5feiAqIGw7CiAgICAgIHRoaXMuX3cgPSB0aGlzLl93ICogbDsKICAgIH0KICAgIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBtdWx0aXBseShxKSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseVF1YXRlcm5pb25zKHRoaXMsIHEpOwogIH0KICBwcmVtdWx0aXBseShxKSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseVF1YXRlcm5pb25zKHEsIHRoaXMpOwogIH0KICBtdWx0aXBseVF1YXRlcm5pb25zKGEsIGIpIHsKICAgIGNvbnN0IHFheCA9IGEuX3gsIHFheSA9IGEuX3ksIHFheiA9IGEuX3osIHFhdyA9IGEuX3c7CiAgICBjb25zdCBxYnggPSBiLl94LCBxYnkgPSBiLl95LCBxYnogPSBiLl96LCBxYncgPSBiLl93OwogICAgdGhpcy5feCA9IHFheCAqIHFidyArIHFhdyAqIHFieCArIHFheSAqIHFieiAtIHFheiAqIHFieTsKICAgIHRoaXMuX3kgPSBxYXkgKiBxYncgKyBxYXcgKiBxYnkgKyBxYXogKiBxYnggLSBxYXggKiBxYno7CiAgICB0aGlzLl96ID0gcWF6ICogcWJ3ICsgcWF3ICogcWJ6ICsgcWF4ICogcWJ5IC0gcWF5ICogcWJ4OwogICAgdGhpcy5fdyA9IHFhdyAqIHFidyAtIHFheCAqIHFieCAtIHFheSAqIHFieSAtIHFheiAqIHFiejsKICAgIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzbGVycChxYiwgdCkgewogICAgaWYgKHQgPT09IDApCiAgICAgIHJldHVybiB0aGlzOwogICAgaWYgKHQgPT09IDEpCiAgICAgIHJldHVybiB0aGlzLmNvcHkocWIpOwogICAgY29uc3QgeCA9IHRoaXMuX3gsIHkgPSB0aGlzLl95LCB6ID0gdGhpcy5feiwgdyA9IHRoaXMuX3c7CiAgICBsZXQgY29zSGFsZlRoZXRhID0gdyAqIHFiLl93ICsgeCAqIHFiLl94ICsgeSAqIHFiLl95ICsgeiAqIHFiLl96OwogICAgaWYgKGNvc0hhbGZUaGV0YSA8IDApIHsKICAgICAgdGhpcy5fdyA9IC1xYi5fdzsKICAgICAgdGhpcy5feCA9IC1xYi5feDsKICAgICAgdGhpcy5feSA9IC1xYi5feTsKICAgICAgdGhpcy5feiA9IC1xYi5fejsKICAgICAgY29zSGFsZlRoZXRhID0gLWNvc0hhbGZUaGV0YTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuY29weShxYik7CiAgICB9CiAgICBpZiAoY29zSGFsZlRoZXRhID49IDEpIHsKICAgICAgdGhpcy5fdyA9IHc7CiAgICAgIHRoaXMuX3ggPSB4OwogICAgICB0aGlzLl95ID0geTsKICAgICAgdGhpcy5feiA9IHo7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgY29uc3Qgc3FyU2luSGFsZlRoZXRhID0gMSAtIGNvc0hhbGZUaGV0YSAqIGNvc0hhbGZUaGV0YTsKICAgIGlmIChzcXJTaW5IYWxmVGhldGEgPD0gTnVtYmVyLkVQU0lMT04pIHsKICAgICAgY29uc3QgcyA9IDEgLSB0OwogICAgICB0aGlzLl93ID0gcyAqIHcgKyB0ICogdGhpcy5fdzsKICAgICAgdGhpcy5feCA9IHMgKiB4ICsgdCAqIHRoaXMuX3g7CiAgICAgIHRoaXMuX3kgPSBzICogeSArIHQgKiB0aGlzLl95OwogICAgICB0aGlzLl96ID0gcyAqIHogKyB0ICogdGhpcy5fejsKICAgICAgdGhpcy5ub3JtYWxpemUoKTsKICAgICAgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGNvbnN0IHNpbkhhbGZUaGV0YSA9IE1hdGguc3FydChzcXJTaW5IYWxmVGhldGEpOwogICAgY29uc3QgaGFsZlRoZXRhID0gTWF0aC5hdGFuMihzaW5IYWxmVGhldGEsIGNvc0hhbGZUaGV0YSk7CiAgICBjb25zdCByYXRpb0EgPSBNYXRoLnNpbigoMSAtIHQpICogaGFsZlRoZXRhKSAvIHNpbkhhbGZUaGV0YSwgcmF0aW9CID0gTWF0aC5zaW4odCAqIGhhbGZUaGV0YSkgLyBzaW5IYWxmVGhldGE7CiAgICB0aGlzLl93ID0gdyAqIHJhdGlvQSArIHRoaXMuX3cgKiByYXRpb0I7CiAgICB0aGlzLl94ID0geCAqIHJhdGlvQSArIHRoaXMuX3ggKiByYXRpb0I7CiAgICB0aGlzLl95ID0geSAqIHJhdGlvQSArIHRoaXMuX3kgKiByYXRpb0I7CiAgICB0aGlzLl96ID0geiAqIHJhdGlvQSArIHRoaXMuX3ogKiByYXRpb0I7CiAgICB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2xlcnBRdWF0ZXJuaW9ucyhxYSwgcWIsIHQpIHsKICAgIHJldHVybiB0aGlzLmNvcHkocWEpLnNsZXJwKHFiLCB0KTsKICB9CiAgcmFuZG9tKCkgewogICAgY29uc3QgdTEgPSBNYXRoLnJhbmRvbSgpOwogICAgY29uc3Qgc3FydDF1MSA9IE1hdGguc3FydCgxIC0gdTEpOwogICAgY29uc3Qgc3FydHUxID0gTWF0aC5zcXJ0KHUxKTsKICAgIGNvbnN0IHUyID0gMiAqIE1hdGguUEkgKiBNYXRoLnJhbmRvbSgpOwogICAgY29uc3QgdTMgPSAyICogTWF0aC5QSSAqIE1hdGgucmFuZG9tKCk7CiAgICByZXR1cm4gdGhpcy5zZXQoCiAgICAgIHNxcnQxdTEgKiBNYXRoLmNvcyh1MiksCiAgICAgIHNxcnR1MSAqIE1hdGguc2luKHUzKSwKICAgICAgc3FydHUxICogTWF0aC5jb3ModTMpLAogICAgICBzcXJ0MXUxICogTWF0aC5zaW4odTIpCiAgICApOwogIH0KICBlcXVhbHMocXVhdGVybmlvbikgewogICAgcmV0dXJuIHF1YXRlcm5pb24uX3ggPT09IHRoaXMuX3ggJiYgcXVhdGVybmlvbi5feSA9PT0gdGhpcy5feSAmJiBxdWF0ZXJuaW9uLl96ID09PSB0aGlzLl96ICYmIHF1YXRlcm5pb24uX3cgPT09IHRoaXMuX3c7CiAgfQogIGZyb21BcnJheShhcnJheSwgb2Zmc2V0ID0gMCkgewogICAgdGhpcy5feCA9IGFycmF5W29mZnNldF07CiAgICB0aGlzLl95ID0gYXJyYXlbb2Zmc2V0ICsgMV07CiAgICB0aGlzLl96ID0gYXJyYXlbb2Zmc2V0ICsgMl07CiAgICB0aGlzLl93ID0gYXJyYXlbb2Zmc2V0ICsgM107CiAgICB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgdG9BcnJheShhcnJheSA9IFtdLCBvZmZzZXQgPSAwKSB7CiAgICBhcnJheVtvZmZzZXRdID0gdGhpcy5feDsKICAgIGFycmF5W29mZnNldCArIDFdID0gdGhpcy5feTsKICAgIGFycmF5W29mZnNldCArIDJdID0gdGhpcy5fejsKICAgIGFycmF5W29mZnNldCArIDNdID0gdGhpcy5fdzsKICAgIHJldHVybiBhcnJheTsKICB9CiAgZnJvbUJ1ZmZlckF0dHJpYnV0ZShhdHRyaWJ1dGUsIGluZGV4KSB7CiAgICB0aGlzLl94ID0gYXR0cmlidXRlLmdldFgoaW5kZXgpOwogICAgdGhpcy5feSA9IGF0dHJpYnV0ZS5nZXRZKGluZGV4KTsKICAgIHRoaXMuX3ogPSBhdHRyaWJ1dGUuZ2V0WihpbmRleCk7CiAgICB0aGlzLl93ID0gYXR0cmlidXRlLmdldFcoaW5kZXgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHRvSlNPTigpIHsKICAgIHJldHVybiB0aGlzLnRvQXJyYXkoKTsKICB9CiAgX29uQ2hhbmdlKGNhbGxiYWNrKSB7CiAgICB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICByZXR1cm4gdGhpczsKICB9CiAgX29uQ2hhbmdlQ2FsbGJhY2soKSB7CiAgfQogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHlpZWxkIHRoaXMuX3g7CiAgICB5aWVsZCB0aGlzLl95OwogICAgeWllbGQgdGhpcy5fejsKICAgIHlpZWxkIHRoaXMuX3c7CiAgfQp9CmNsYXNzIFZlY3RvcjMkMSB7CiAgY29uc3RydWN0b3IoeCA9IDAsIHkgPSAwLCB6ID0gMCkgewogICAgVmVjdG9yMyQxLnByb3RvdHlwZS5pc1ZlY3RvcjMgPSB0cnVlOwogICAgdGhpcy54ID0geDsKICAgIHRoaXMueSA9IHk7CiAgICB0aGlzLnogPSB6OwogIH0KICBzZXQoeCwgeSwgeikgewogICAgaWYgKHogPT09IHZvaWQgMCkKICAgICAgeiA9IHRoaXMuejsKICAgIHRoaXMueCA9IHg7CiAgICB0aGlzLnkgPSB5OwogICAgdGhpcy56ID0gejsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRTY2FsYXIoc2NhbGFyKSB7CiAgICB0aGlzLnggPSBzY2FsYXI7CiAgICB0aGlzLnkgPSBzY2FsYXI7CiAgICB0aGlzLnogPSBzY2FsYXI7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0WCh4KSB7CiAgICB0aGlzLnggPSB4OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldFkoeSkgewogICAgdGhpcy55ID0geTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRaKHopIHsKICAgIHRoaXMueiA9IHo7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0Q29tcG9uZW50KGluZGV4LCB2YWx1ZSkgewogICAgc3dpdGNoIChpbmRleCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy54ID0gdmFsdWU7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLnkgPSB2YWx1ZTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMueiA9IHZhbHVlOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgb3V0IG9mIHJhbmdlOiAiICsgaW5kZXgpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIGdldENvbXBvbmVudChpbmRleCkgewogICAgc3dpdGNoIChpbmRleCkgewogICAgICBjYXNlIDA6CiAgICAgICAgcmV0dXJuIHRoaXMueDsKICAgICAgY2FzZSAxOgogICAgICAgIHJldHVybiB0aGlzLnk7CiAgICAgIGNhc2UgMjoKICAgICAgICByZXR1cm4gdGhpcy56OwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgb3V0IG9mIHJhbmdlOiAiICsgaW5kZXgpOwogICAgfQogIH0KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLngsIHRoaXMueSwgdGhpcy56KTsKICB9CiAgY29weSh2KSB7CiAgICB0aGlzLnggPSB2Lng7CiAgICB0aGlzLnkgPSB2Lnk7CiAgICB0aGlzLnogPSB2Lno7CiAgICByZXR1cm4gdGhpczsKICB9CiAgYWRkKHYpIHsKICAgIHRoaXMueCArPSB2Lng7CiAgICB0aGlzLnkgKz0gdi55OwogICAgdGhpcy56ICs9IHYuejsKICAgIHJldHVybiB0aGlzOwogIH0KICBhZGRTY2FsYXIocykgewogICAgdGhpcy54ICs9IHM7CiAgICB0aGlzLnkgKz0gczsKICAgIHRoaXMueiArPSBzOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFkZFZlY3RvcnMoYSwgYikgewogICAgdGhpcy54ID0gYS54ICsgYi54OwogICAgdGhpcy55ID0gYS55ICsgYi55OwogICAgdGhpcy56ID0gYS56ICsgYi56OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFkZFNjYWxlZFZlY3Rvcih2LCBzKSB7CiAgICB0aGlzLnggKz0gdi54ICogczsKICAgIHRoaXMueSArPSB2LnkgKiBzOwogICAgdGhpcy56ICs9IHYueiAqIHM7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc3ViKHYpIHsKICAgIHRoaXMueCAtPSB2Lng7CiAgICB0aGlzLnkgLT0gdi55OwogICAgdGhpcy56IC09IHYuejsKICAgIHJldHVybiB0aGlzOwogIH0KICBzdWJTY2FsYXIocykgewogICAgdGhpcy54IC09IHM7CiAgICB0aGlzLnkgLT0gczsKICAgIHRoaXMueiAtPSBzOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHN1YlZlY3RvcnMoYSwgYikgewogICAgdGhpcy54ID0gYS54IC0gYi54OwogICAgdGhpcy55ID0gYS55IC0gYi55OwogICAgdGhpcy56ID0gYS56IC0gYi56OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIG11bHRpcGx5KHYpIHsKICAgIHRoaXMueCAqPSB2Lng7CiAgICB0aGlzLnkgKj0gdi55OwogICAgdGhpcy56ICo9IHYuejsKICAgIHJldHVybiB0aGlzOwogIH0KICBtdWx0aXBseVNjYWxhcihzY2FsYXIpIHsKICAgIHRoaXMueCAqPSBzY2FsYXI7CiAgICB0aGlzLnkgKj0gc2NhbGFyOwogICAgdGhpcy56ICo9IHNjYWxhcjsKICAgIHJldHVybiB0aGlzOwogIH0KICBtdWx0aXBseVZlY3RvcnMoYSwgYikgewogICAgdGhpcy54ID0gYS54ICogYi54OwogICAgdGhpcy55ID0gYS55ICogYi55OwogICAgdGhpcy56ID0gYS56ICogYi56OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFwcGx5RXVsZXIoZXVsZXIpIHsKICAgIHJldHVybiB0aGlzLmFwcGx5UXVhdGVybmlvbihfcXVhdGVybmlvbiQ0LnNldEZyb21FdWxlcihldWxlcikpOwogIH0KICBhcHBseUF4aXNBbmdsZShheGlzLCBhbmdsZSkgewogICAgcmV0dXJuIHRoaXMuYXBwbHlRdWF0ZXJuaW9uKF9xdWF0ZXJuaW9uJDQuc2V0RnJvbUF4aXNBbmdsZShheGlzLCBhbmdsZSkpOwogIH0KICBhcHBseU1hdHJpeDMobSkgewogICAgY29uc3QgeCA9IHRoaXMueCwgeSA9IHRoaXMueSwgeiA9IHRoaXMuejsKICAgIGNvbnN0IGUgPSBtLmVsZW1lbnRzOwogICAgdGhpcy54ID0gZVswXSAqIHggKyBlWzNdICogeSArIGVbNl0gKiB6OwogICAgdGhpcy55ID0gZVsxXSAqIHggKyBlWzRdICogeSArIGVbN10gKiB6OwogICAgdGhpcy56ID0gZVsyXSAqIHggKyBlWzVdICogeSArIGVbOF0gKiB6OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFwcGx5Tm9ybWFsTWF0cml4KG0pIHsKICAgIHJldHVybiB0aGlzLmFwcGx5TWF0cml4MyhtKS5ub3JtYWxpemUoKTsKICB9CiAgYXBwbHlNYXRyaXg0KG0pIHsKICAgIGNvbnN0IHggPSB0aGlzLngsIHkgPSB0aGlzLnksIHogPSB0aGlzLno7CiAgICBjb25zdCBlID0gbS5lbGVtZW50czsKICAgIGNvbnN0IHcgPSAxIC8gKGVbM10gKiB4ICsgZVs3XSAqIHkgKyBlWzExXSAqIHogKyBlWzE1XSk7CiAgICB0aGlzLnggPSAoZVswXSAqIHggKyBlWzRdICogeSArIGVbOF0gKiB6ICsgZVsxMl0pICogdzsKICAgIHRoaXMueSA9IChlWzFdICogeCArIGVbNV0gKiB5ICsgZVs5XSAqIHogKyBlWzEzXSkgKiB3OwogICAgdGhpcy56ID0gKGVbMl0gKiB4ICsgZVs2XSAqIHkgKyBlWzEwXSAqIHogKyBlWzE0XSkgKiB3OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFwcGx5UXVhdGVybmlvbihxKSB7CiAgICBjb25zdCB2eCA9IHRoaXMueCwgdnkgPSB0aGlzLnksIHZ6ID0gdGhpcy56OwogICAgY29uc3QgcXggPSBxLngsIHF5ID0gcS55LCBxeiA9IHEueiwgcXcgPSBxLnc7CiAgICBjb25zdCB0eCA9IDIgKiAocXkgKiB2eiAtIHF6ICogdnkpOwogICAgY29uc3QgdHkgPSAyICogKHF6ICogdnggLSBxeCAqIHZ6KTsKICAgIGNvbnN0IHR6ID0gMiAqIChxeCAqIHZ5IC0gcXkgKiB2eCk7CiAgICB0aGlzLnggPSB2eCArIHF3ICogdHggKyBxeSAqIHR6IC0gcXogKiB0eTsKICAgIHRoaXMueSA9IHZ5ICsgcXcgKiB0eSArIHF6ICogdHggLSBxeCAqIHR6OwogICAgdGhpcy56ID0gdnogKyBxdyAqIHR6ICsgcXggKiB0eSAtIHF5ICogdHg7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcHJvamVjdChjYW1lcmEpIHsKICAgIHJldHVybiB0aGlzLmFwcGx5TWF0cml4NChjYW1lcmEubWF0cml4V29ybGRJbnZlcnNlKS5hcHBseU1hdHJpeDQoY2FtZXJhLnByb2plY3Rpb25NYXRyaXgpOwogIH0KICB1bnByb2plY3QoY2FtZXJhKSB7CiAgICByZXR1cm4gdGhpcy5hcHBseU1hdHJpeDQoY2FtZXJhLnByb2plY3Rpb25NYXRyaXhJbnZlcnNlKS5hcHBseU1hdHJpeDQoY2FtZXJhLm1hdHJpeFdvcmxkKTsKICB9CiAgdHJhbnNmb3JtRGlyZWN0aW9uKG0pIHsKICAgIGNvbnN0IHggPSB0aGlzLngsIHkgPSB0aGlzLnksIHogPSB0aGlzLno7CiAgICBjb25zdCBlID0gbS5lbGVtZW50czsKICAgIHRoaXMueCA9IGVbMF0gKiB4ICsgZVs0XSAqIHkgKyBlWzhdICogejsKICAgIHRoaXMueSA9IGVbMV0gKiB4ICsgZVs1XSAqIHkgKyBlWzldICogejsKICAgIHRoaXMueiA9IGVbMl0gKiB4ICsgZVs2XSAqIHkgKyBlWzEwXSAqIHo7CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemUoKTsKICB9CiAgZGl2aWRlKHYpIHsKICAgIHRoaXMueCAvPSB2Lng7CiAgICB0aGlzLnkgLz0gdi55OwogICAgdGhpcy56IC89IHYuejsKICAgIHJldHVybiB0aGlzOwogIH0KICBkaXZpZGVTY2FsYXIoc2NhbGFyKSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseVNjYWxhcigxIC8gc2NhbGFyKTsKICB9CiAgbWluKHYpIHsKICAgIHRoaXMueCA9IE1hdGgubWluKHRoaXMueCwgdi54KTsKICAgIHRoaXMueSA9IE1hdGgubWluKHRoaXMueSwgdi55KTsKICAgIHRoaXMueiA9IE1hdGgubWluKHRoaXMueiwgdi56KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBtYXgodikgewogICAgdGhpcy54ID0gTWF0aC5tYXgodGhpcy54LCB2LngpOwogICAgdGhpcy55ID0gTWF0aC5tYXgodGhpcy55LCB2LnkpOwogICAgdGhpcy56ID0gTWF0aC5tYXgodGhpcy56LCB2LnopOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGNsYW1wKG1pbiwgbWF4KSB7CiAgICB0aGlzLnggPSBNYXRoLm1heChtaW4ueCwgTWF0aC5taW4obWF4LngsIHRoaXMueCkpOwogICAgdGhpcy55ID0gTWF0aC5tYXgobWluLnksIE1hdGgubWluKG1heC55LCB0aGlzLnkpKTsKICAgIHRoaXMueiA9IE1hdGgubWF4KG1pbi56LCBNYXRoLm1pbihtYXgueiwgdGhpcy56KSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgY2xhbXBTY2FsYXIobWluVmFsLCBtYXhWYWwpIHsKICAgIHRoaXMueCA9IE1hdGgubWF4KG1pblZhbCwgTWF0aC5taW4obWF4VmFsLCB0aGlzLngpKTsKICAgIHRoaXMueSA9IE1hdGgubWF4KG1pblZhbCwgTWF0aC5taW4obWF4VmFsLCB0aGlzLnkpKTsKICAgIHRoaXMueiA9IE1hdGgubWF4KG1pblZhbCwgTWF0aC5taW4obWF4VmFsLCB0aGlzLnopKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjbGFtcExlbmd0aChtaW4sIG1heCkgewogICAgY29uc3QgbGVuZ3RoID0gdGhpcy5sZW5ndGgoKTsKICAgIHJldHVybiB0aGlzLmRpdmlkZVNjYWxhcihsZW5ndGggfHwgMSkubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgobWluLCBNYXRoLm1pbihtYXgsIGxlbmd0aCkpKTsKICB9CiAgZmxvb3IoKSB7CiAgICB0aGlzLnggPSBNYXRoLmZsb29yKHRoaXMueCk7CiAgICB0aGlzLnkgPSBNYXRoLmZsb29yKHRoaXMueSk7CiAgICB0aGlzLnogPSBNYXRoLmZsb29yKHRoaXMueik7CiAgICByZXR1cm4gdGhpczsKICB9CiAgY2VpbCgpIHsKICAgIHRoaXMueCA9IE1hdGguY2VpbCh0aGlzLngpOwogICAgdGhpcy55ID0gTWF0aC5jZWlsKHRoaXMueSk7CiAgICB0aGlzLnogPSBNYXRoLmNlaWwodGhpcy56KTsKICAgIHJldHVybiB0aGlzOwogIH0KICByb3VuZCgpIHsKICAgIHRoaXMueCA9IE1hdGgucm91bmQodGhpcy54KTsKICAgIHRoaXMueSA9IE1hdGgucm91bmQodGhpcy55KTsKICAgIHRoaXMueiA9IE1hdGgucm91bmQodGhpcy56KTsKICAgIHJldHVybiB0aGlzOwogIH0KICByb3VuZFRvWmVybygpIHsKICAgIHRoaXMueCA9IE1hdGgudHJ1bmModGhpcy54KTsKICAgIHRoaXMueSA9IE1hdGgudHJ1bmModGhpcy55KTsKICAgIHRoaXMueiA9IE1hdGgudHJ1bmModGhpcy56KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBuZWdhdGUoKSB7CiAgICB0aGlzLnggPSAtdGhpcy54OwogICAgdGhpcy55ID0gLXRoaXMueTsKICAgIHRoaXMueiA9IC10aGlzLno7CiAgICByZXR1cm4gdGhpczsKICB9CiAgZG90KHYpIHsKICAgIHJldHVybiB0aGlzLnggKiB2LnggKyB0aGlzLnkgKiB2LnkgKyB0aGlzLnogKiB2Lno7CiAgfQogIGxlbmd0aFNxKCkgewogICAgcmV0dXJuIHRoaXMueCAqIHRoaXMueCArIHRoaXMueSAqIHRoaXMueSArIHRoaXMueiAqIHRoaXMuejsKICB9CiAgbGVuZ3RoKCkgewogICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLnggKiB0aGlzLnggKyB0aGlzLnkgKiB0aGlzLnkgKyB0aGlzLnogKiB0aGlzLnopOwogIH0KICBtYW5oYXR0YW5MZW5ndGgoKSB7CiAgICByZXR1cm4gTWF0aC5hYnModGhpcy54KSArIE1hdGguYWJzKHRoaXMueSkgKyBNYXRoLmFicyh0aGlzLnopOwogIH0KICBub3JtYWxpemUoKSB7CiAgICByZXR1cm4gdGhpcy5kaXZpZGVTY2FsYXIodGhpcy5sZW5ndGgoKSB8fCAxKTsKICB9CiAgc2V0TGVuZ3RoKGxlbmd0aCkgewogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIobGVuZ3RoKTsKICB9CiAgbGVycCh2LCBhbHBoYSkgewogICAgdGhpcy54ICs9ICh2LnggLSB0aGlzLngpICogYWxwaGE7CiAgICB0aGlzLnkgKz0gKHYueSAtIHRoaXMueSkgKiBhbHBoYTsKICAgIHRoaXMueiArPSAodi56IC0gdGhpcy56KSAqIGFscGhhOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGxlcnBWZWN0b3JzKHYxLCB2MiwgYWxwaGEpIHsKICAgIHRoaXMueCA9IHYxLnggKyAodjIueCAtIHYxLngpICogYWxwaGE7CiAgICB0aGlzLnkgPSB2MS55ICsgKHYyLnkgLSB2MS55KSAqIGFscGhhOwogICAgdGhpcy56ID0gdjEueiArICh2Mi56IC0gdjEueikgKiBhbHBoYTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjcm9zcyh2KSB7CiAgICByZXR1cm4gdGhpcy5jcm9zc1ZlY3RvcnModGhpcywgdik7CiAgfQogIGNyb3NzVmVjdG9ycyhhLCBiKSB7CiAgICBjb25zdCBheCA9IGEueCwgYXkgPSBhLnksIGF6ID0gYS56OwogICAgY29uc3QgYnggPSBiLngsIGJ5ID0gYi55LCBieiA9IGIuejsKICAgIHRoaXMueCA9IGF5ICogYnogLSBheiAqIGJ5OwogICAgdGhpcy55ID0gYXogKiBieCAtIGF4ICogYno7CiAgICB0aGlzLnogPSBheCAqIGJ5IC0gYXkgKiBieDsKICAgIHJldHVybiB0aGlzOwogIH0KICBwcm9qZWN0T25WZWN0b3IodikgewogICAgY29uc3QgZGVub21pbmF0b3IgPSB2Lmxlbmd0aFNxKCk7CiAgICBpZiAoZGVub21pbmF0b3IgPT09IDApCiAgICAgIHJldHVybiB0aGlzLnNldCgwLCAwLCAwKTsKICAgIGNvbnN0IHNjYWxhciA9IHYuZG90KHRoaXMpIC8gZGVub21pbmF0b3I7CiAgICByZXR1cm4gdGhpcy5jb3B5KHYpLm11bHRpcGx5U2NhbGFyKHNjYWxhcik7CiAgfQogIHByb2plY3RPblBsYW5lKHBsYW5lTm9ybWFsKSB7CiAgICBfdmVjdG9yJGIuY29weSh0aGlzKS5wcm9qZWN0T25WZWN0b3IocGxhbmVOb3JtYWwpOwogICAgcmV0dXJuIHRoaXMuc3ViKF92ZWN0b3IkYik7CiAgfQogIHJlZmxlY3Qobm9ybWFsKSB7CiAgICByZXR1cm4gdGhpcy5zdWIoX3ZlY3RvciRiLmNvcHkobm9ybWFsKS5tdWx0aXBseVNjYWxhcigyICogdGhpcy5kb3Qobm9ybWFsKSkpOwogIH0KICBhbmdsZVRvKHYpIHsKICAgIGNvbnN0IGRlbm9taW5hdG9yID0gTWF0aC5zcXJ0KHRoaXMubGVuZ3RoU3EoKSAqIHYubGVuZ3RoU3EoKSk7CiAgICBpZiAoZGVub21pbmF0b3IgPT09IDApCiAgICAgIHJldHVybiBNYXRoLlBJIC8gMjsKICAgIGNvbnN0IHRoZXRhID0gdGhpcy5kb3QodikgLyBkZW5vbWluYXRvcjsKICAgIHJldHVybiBNYXRoLmFjb3MoY2xhbXAodGhldGEsIC0xLCAxKSk7CiAgfQogIGRpc3RhbmNlVG8odikgewogICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLmRpc3RhbmNlVG9TcXVhcmVkKHYpKTsKICB9CiAgZGlzdGFuY2VUb1NxdWFyZWQodikgewogICAgY29uc3QgZHggPSB0aGlzLnggLSB2LngsIGR5ID0gdGhpcy55IC0gdi55LCBkeiA9IHRoaXMueiAtIHYuejsKICAgIHJldHVybiBkeCAqIGR4ICsgZHkgKiBkeSArIGR6ICogZHo7CiAgfQogIG1hbmhhdHRhbkRpc3RhbmNlVG8odikgewogICAgcmV0dXJuIE1hdGguYWJzKHRoaXMueCAtIHYueCkgKyBNYXRoLmFicyh0aGlzLnkgLSB2LnkpICsgTWF0aC5hYnModGhpcy56IC0gdi56KTsKICB9CiAgc2V0RnJvbVNwaGVyaWNhbChzKSB7CiAgICByZXR1cm4gdGhpcy5zZXRGcm9tU3BoZXJpY2FsQ29vcmRzKHMucmFkaXVzLCBzLnBoaSwgcy50aGV0YSk7CiAgfQogIHNldEZyb21TcGhlcmljYWxDb29yZHMocmFkaXVzLCBwaGksIHRoZXRhKSB7CiAgICBjb25zdCBzaW5QaGlSYWRpdXMgPSBNYXRoLnNpbihwaGkpICogcmFkaXVzOwogICAgdGhpcy54ID0gc2luUGhpUmFkaXVzICogTWF0aC5zaW4odGhldGEpOwogICAgdGhpcy55ID0gTWF0aC5jb3MocGhpKSAqIHJhZGl1czsKICAgIHRoaXMueiA9IHNpblBoaVJhZGl1cyAqIE1hdGguY29zKHRoZXRhKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRGcm9tQ3lsaW5kcmljYWwoYykgewogICAgcmV0dXJuIHRoaXMuc2V0RnJvbUN5bGluZHJpY2FsQ29vcmRzKGMucmFkaXVzLCBjLnRoZXRhLCBjLnkpOwogIH0KICBzZXRGcm9tQ3lsaW5kcmljYWxDb29yZHMocmFkaXVzLCB0aGV0YSwgeSkgewogICAgdGhpcy54ID0gcmFkaXVzICogTWF0aC5zaW4odGhldGEpOwogICAgdGhpcy55ID0geTsKICAgIHRoaXMueiA9IHJhZGl1cyAqIE1hdGguY29zKHRoZXRhKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRGcm9tTWF0cml4UG9zaXRpb24obSkgewogICAgY29uc3QgZSA9IG0uZWxlbWVudHM7CiAgICB0aGlzLnggPSBlWzEyXTsKICAgIHRoaXMueSA9IGVbMTNdOwogICAgdGhpcy56ID0gZVsxNF07CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0RnJvbU1hdHJpeFNjYWxlKG0pIHsKICAgIGNvbnN0IHN4ID0gdGhpcy5zZXRGcm9tTWF0cml4Q29sdW1uKG0sIDApLmxlbmd0aCgpOwogICAgY29uc3Qgc3kgPSB0aGlzLnNldEZyb21NYXRyaXhDb2x1bW4obSwgMSkubGVuZ3RoKCk7CiAgICBjb25zdCBzeiA9IHRoaXMuc2V0RnJvbU1hdHJpeENvbHVtbihtLCAyKS5sZW5ndGgoKTsKICAgIHRoaXMueCA9IHN4OwogICAgdGhpcy55ID0gc3k7CiAgICB0aGlzLnogPSBzejsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRGcm9tTWF0cml4Q29sdW1uKG0sIGluZGV4KSB7CiAgICByZXR1cm4gdGhpcy5mcm9tQXJyYXkobS5lbGVtZW50cywgaW5kZXggKiA0KTsKICB9CiAgc2V0RnJvbU1hdHJpeDNDb2x1bW4obSwgaW5kZXgpIHsKICAgIHJldHVybiB0aGlzLmZyb21BcnJheShtLmVsZW1lbnRzLCBpbmRleCAqIDMpOwogIH0KICBzZXRGcm9tRXVsZXIoZSkgewogICAgdGhpcy54ID0gZS5feDsKICAgIHRoaXMueSA9IGUuX3k7CiAgICB0aGlzLnogPSBlLl96OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldEZyb21Db2xvcihjKSB7CiAgICB0aGlzLnggPSBjLnI7CiAgICB0aGlzLnkgPSBjLmc7CiAgICB0aGlzLnogPSBjLmI7CiAgICByZXR1cm4gdGhpczsKICB9CiAgZXF1YWxzKHYpIHsKICAgIHJldHVybiB2LnggPT09IHRoaXMueCAmJiB2LnkgPT09IHRoaXMueSAmJiB2LnogPT09IHRoaXMuejsKICB9CiAgZnJvbUFycmF5KGFycmF5LCBvZmZzZXQgPSAwKSB7CiAgICB0aGlzLnggPSBhcnJheVtvZmZzZXRdOwogICAgdGhpcy55ID0gYXJyYXlbb2Zmc2V0ICsgMV07CiAgICB0aGlzLnogPSBhcnJheVtvZmZzZXQgKyAyXTsKICAgIHJldHVybiB0aGlzOwogIH0KICB0b0FycmF5KGFycmF5ID0gW10sIG9mZnNldCA9IDApIHsKICAgIGFycmF5W29mZnNldF0gPSB0aGlzLng7CiAgICBhcnJheVtvZmZzZXQgKyAxXSA9IHRoaXMueTsKICAgIGFycmF5W29mZnNldCArIDJdID0gdGhpcy56OwogICAgcmV0dXJuIGFycmF5OwogIH0KICBmcm9tQnVmZmVyQXR0cmlidXRlKGF0dHJpYnV0ZSwgaW5kZXgpIHsKICAgIHRoaXMueCA9IGF0dHJpYnV0ZS5nZXRYKGluZGV4KTsKICAgIHRoaXMueSA9IGF0dHJpYnV0ZS5nZXRZKGluZGV4KTsKICAgIHRoaXMueiA9IGF0dHJpYnV0ZS5nZXRaKGluZGV4KTsKICAgIHJldHVybiB0aGlzOwogIH0KICByYW5kb20oKSB7CiAgICB0aGlzLnggPSBNYXRoLnJhbmRvbSgpOwogICAgdGhpcy55ID0gTWF0aC5yYW5kb20oKTsKICAgIHRoaXMueiA9IE1hdGgucmFuZG9tKCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmFuZG9tRGlyZWN0aW9uKCkgewogICAgY29uc3QgdSA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDI7CiAgICBjb25zdCB0ID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgY29uc3QgZiA9IE1hdGguc3FydCgxIC0gdSAqKiAyKTsKICAgIHRoaXMueCA9IGYgKiBNYXRoLmNvcyh0KTsKICAgIHRoaXMueSA9IGYgKiBNYXRoLnNpbih0KTsKICAgIHRoaXMueiA9IHU7CiAgICByZXR1cm4gdGhpczsKICB9CiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgeWllbGQgdGhpcy54OwogICAgeWllbGQgdGhpcy55OwogICAgeWllbGQgdGhpcy56OwogIH0KfQpjb25zdCBfdmVjdG9yJGIgPSAvKiBAX19QVVJFX18gKi8gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBfcXVhdGVybmlvbiQ0ID0gLyogQF9fUFVSRV9fICovIG5ldyBRdWF0ZXJuaW9uJDEoKTsKY2xhc3MgQm94MyB7CiAgY29uc3RydWN0b3IobWluID0gbmV3IFZlY3RvcjMkMShJbmZpbml0eSwgSW5maW5pdHksIEluZmluaXR5KSwgbWF4ID0gbmV3IFZlY3RvcjMkMSgtSW5maW5pdHksIC1JbmZpbml0eSwgLUluZmluaXR5KSkgewogICAgdGhpcy5pc0JveDMgPSB0cnVlOwogICAgdGhpcy5taW4gPSBtaW47CiAgICB0aGlzLm1heCA9IG1heDsKICB9CiAgc2V0KG1pbiwgbWF4KSB7CiAgICB0aGlzLm1pbi5jb3B5KG1pbik7CiAgICB0aGlzLm1heC5jb3B5KG1heCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0RnJvbUFycmF5KGFycmF5KSB7CiAgICB0aGlzLm1ha2VFbXB0eSgpOwogICAgZm9yIChsZXQgaSA9IDAsIGlsID0gYXJyYXkubGVuZ3RoOyBpIDwgaWw7IGkgKz0gMykgewogICAgICB0aGlzLmV4cGFuZEJ5UG9pbnQoX3ZlY3RvciRhLmZyb21BcnJheShhcnJheSwgaSkpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldEZyb21CdWZmZXJBdHRyaWJ1dGUoYXR0cmlidXRlKSB7CiAgICB0aGlzLm1ha2VFbXB0eSgpOwogICAgZm9yIChsZXQgaSA9IDAsIGlsID0gYXR0cmlidXRlLmNvdW50OyBpIDwgaWw7IGkrKykgewogICAgICB0aGlzLmV4cGFuZEJ5UG9pbnQoX3ZlY3RvciRhLmZyb21CdWZmZXJBdHRyaWJ1dGUoYXR0cmlidXRlLCBpKSk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0RnJvbVBvaW50cyhwb2ludHMpIHsKICAgIHRoaXMubWFrZUVtcHR5KCk7CiAgICBmb3IgKGxldCBpID0gMCwgaWwgPSBwb2ludHMubGVuZ3RoOyBpIDwgaWw7IGkrKykgewogICAgICB0aGlzLmV4cGFuZEJ5UG9pbnQocG9pbnRzW2ldKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRGcm9tQ2VudGVyQW5kU2l6ZShjZW50ZXIsIHNpemUpIHsKICAgIGNvbnN0IGhhbGZTaXplID0gX3ZlY3RvciRhLmNvcHkoc2l6ZSkubXVsdGlwbHlTY2FsYXIoMC41KTsKICAgIHRoaXMubWluLmNvcHkoY2VudGVyKS5zdWIoaGFsZlNpemUpOwogICAgdGhpcy5tYXguY29weShjZW50ZXIpLmFkZChoYWxmU2l6ZSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0RnJvbU9iamVjdChvYmplY3QsIHByZWNpc2UgPSBmYWxzZSkgewogICAgdGhpcy5tYWtlRW1wdHkoKTsKICAgIHJldHVybiB0aGlzLmV4cGFuZEJ5T2JqZWN0KG9iamVjdCwgcHJlY2lzZSk7CiAgfQogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSh0aGlzKTsKICB9CiAgY29weShib3gpIHsKICAgIHRoaXMubWluLmNvcHkoYm94Lm1pbik7CiAgICB0aGlzLm1heC5jb3B5KGJveC5tYXgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIG1ha2VFbXB0eSgpIHsKICAgIHRoaXMubWluLnggPSB0aGlzLm1pbi55ID0gdGhpcy5taW4ueiA9IEluZmluaXR5OwogICAgdGhpcy5tYXgueCA9IHRoaXMubWF4LnkgPSB0aGlzLm1heC56ID0gLUluZmluaXR5OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGlzRW1wdHkoKSB7CiAgICByZXR1cm4gdGhpcy5tYXgueCA8IHRoaXMubWluLnggfHwgdGhpcy5tYXgueSA8IHRoaXMubWluLnkgfHwgdGhpcy5tYXgueiA8IHRoaXMubWluLno7CiAgfQogIGdldENlbnRlcih0YXJnZXQpIHsKICAgIHJldHVybiB0aGlzLmlzRW1wdHkoKSA/IHRhcmdldC5zZXQoMCwgMCwgMCkgOiB0YXJnZXQuYWRkVmVjdG9ycyh0aGlzLm1pbiwgdGhpcy5tYXgpLm11bHRpcGx5U2NhbGFyKDAuNSk7CiAgfQogIGdldFNpemUodGFyZ2V0KSB7CiAgICByZXR1cm4gdGhpcy5pc0VtcHR5KCkgPyB0YXJnZXQuc2V0KDAsIDAsIDApIDogdGFyZ2V0LnN1YlZlY3RvcnModGhpcy5tYXgsIHRoaXMubWluKTsKICB9CiAgZXhwYW5kQnlQb2ludChwb2ludCkgewogICAgdGhpcy5taW4ubWluKHBvaW50KTsKICAgIHRoaXMubWF4Lm1heChwb2ludCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgZXhwYW5kQnlWZWN0b3IodmVjdG9yKSB7CiAgICB0aGlzLm1pbi5zdWIodmVjdG9yKTsKICAgIHRoaXMubWF4LmFkZCh2ZWN0b3IpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGV4cGFuZEJ5U2NhbGFyKHNjYWxhcikgewogICAgdGhpcy5taW4uYWRkU2NhbGFyKC1zY2FsYXIpOwogICAgdGhpcy5tYXguYWRkU2NhbGFyKHNjYWxhcik7CiAgICByZXR1cm4gdGhpczsKICB9CiAgZXhwYW5kQnlPYmplY3Qob2JqZWN0LCBwcmVjaXNlID0gZmFsc2UpIHsKICAgIG9iamVjdC51cGRhdGVXb3JsZE1hdHJpeChmYWxzZSwgZmFsc2UpOwogICAgY29uc3QgZ2VvbWV0cnkgPSBvYmplY3QuZ2VvbWV0cnk7CiAgICBpZiAoZ2VvbWV0cnkgIT09IHZvaWQgMCkgewogICAgICBjb25zdCBwb3NpdGlvbkF0dHJpYnV0ZSA9IGdlb21ldHJ5LmdldEF0dHJpYnV0ZSgicG9zaXRpb24iKTsKICAgICAgaWYgKHByZWNpc2UgPT09IHRydWUgJiYgcG9zaXRpb25BdHRyaWJ1dGUgIT09IHZvaWQgMCAmJiBvYmplY3QuaXNJbnN0YW5jZWRNZXNoICE9PSB0cnVlKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBwb3NpdGlvbkF0dHJpYnV0ZS5jb3VudDsgaSA8IGw7IGkrKykgewogICAgICAgICAgaWYgKG9iamVjdC5pc01lc2ggPT09IHRydWUpIHsKICAgICAgICAgICAgb2JqZWN0LmdldFZlcnRleFBvc2l0aW9uKGksIF92ZWN0b3IkYSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBfdmVjdG9yJGEuZnJvbUJ1ZmZlckF0dHJpYnV0ZShwb3NpdGlvbkF0dHJpYnV0ZSwgaSk7CiAgICAgICAgICB9CiAgICAgICAgICBfdmVjdG9yJGEuYXBwbHlNYXRyaXg0KG9iamVjdC5tYXRyaXhXb3JsZCk7CiAgICAgICAgICB0aGlzLmV4cGFuZEJ5UG9pbnQoX3ZlY3RvciRhKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKG9iamVjdC5ib3VuZGluZ0JveCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBpZiAob2JqZWN0LmJvdW5kaW5nQm94ID09PSBudWxsKSB7CiAgICAgICAgICAgIG9iamVjdC5jb21wdXRlQm91bmRpbmdCb3goKTsKICAgICAgICAgIH0KICAgICAgICAgIF9ib3gkMy5jb3B5KG9iamVjdC5ib3VuZGluZ0JveCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChnZW9tZXRyeS5ib3VuZGluZ0JveCA9PT0gbnVsbCkgewogICAgICAgICAgICBnZW9tZXRyeS5jb21wdXRlQm91bmRpbmdCb3goKTsKICAgICAgICAgIH0KICAgICAgICAgIF9ib3gkMy5jb3B5KGdlb21ldHJ5LmJvdW5kaW5nQm94KTsKICAgICAgICB9CiAgICAgICAgX2JveCQzLmFwcGx5TWF0cml4NChvYmplY3QubWF0cml4V29ybGQpOwogICAgICAgIHRoaXMudW5pb24oX2JveCQzKTsKICAgICAgfQogICAgfQogICAgY29uc3QgY2hpbGRyZW4gPSBvYmplY3QuY2hpbGRyZW47CiAgICBmb3IgKGxldCBpID0gMCwgbCA9IGNoaWxkcmVuLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICB0aGlzLmV4cGFuZEJ5T2JqZWN0KGNoaWxkcmVuW2ldLCBwcmVjaXNlKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICBjb250YWluc1BvaW50KHBvaW50KSB7CiAgICByZXR1cm4gcG9pbnQueCA8IHRoaXMubWluLnggfHwgcG9pbnQueCA+IHRoaXMubWF4LnggfHwgcG9pbnQueSA8IHRoaXMubWluLnkgfHwgcG9pbnQueSA+IHRoaXMubWF4LnkgfHwgcG9pbnQueiA8IHRoaXMubWluLnogfHwgcG9pbnQueiA+IHRoaXMubWF4LnogPyBmYWxzZSA6IHRydWU7CiAgfQogIGNvbnRhaW5zQm94KGJveCkgewogICAgcmV0dXJuIHRoaXMubWluLnggPD0gYm94Lm1pbi54ICYmIGJveC5tYXgueCA8PSB0aGlzLm1heC54ICYmIHRoaXMubWluLnkgPD0gYm94Lm1pbi55ICYmIGJveC5tYXgueSA8PSB0aGlzLm1heC55ICYmIHRoaXMubWluLnogPD0gYm94Lm1pbi56ICYmIGJveC5tYXgueiA8PSB0aGlzLm1heC56OwogIH0KICBnZXRQYXJhbWV0ZXIocG9pbnQsIHRhcmdldCkgewogICAgcmV0dXJuIHRhcmdldC5zZXQoCiAgICAgIChwb2ludC54IC0gdGhpcy5taW4ueCkgLyAodGhpcy5tYXgueCAtIHRoaXMubWluLngpLAogICAgICAocG9pbnQueSAtIHRoaXMubWluLnkpIC8gKHRoaXMubWF4LnkgLSB0aGlzLm1pbi55KSwKICAgICAgKHBvaW50LnogLSB0aGlzLm1pbi56KSAvICh0aGlzLm1heC56IC0gdGhpcy5taW4ueikKICAgICk7CiAgfQogIGludGVyc2VjdHNCb3goYm94KSB7CiAgICByZXR1cm4gYm94Lm1heC54IDwgdGhpcy5taW4ueCB8fCBib3gubWluLnggPiB0aGlzLm1heC54IHx8IGJveC5tYXgueSA8IHRoaXMubWluLnkgfHwgYm94Lm1pbi55ID4gdGhpcy5tYXgueSB8fCBib3gubWF4LnogPCB0aGlzLm1pbi56IHx8IGJveC5taW4ueiA+IHRoaXMubWF4LnogPyBmYWxzZSA6IHRydWU7CiAgfQogIGludGVyc2VjdHNTcGhlcmUoc3BoZXJlKSB7CiAgICB0aGlzLmNsYW1wUG9pbnQoc3BoZXJlLmNlbnRlciwgX3ZlY3RvciRhKTsKICAgIHJldHVybiBfdmVjdG9yJGEuZGlzdGFuY2VUb1NxdWFyZWQoc3BoZXJlLmNlbnRlcikgPD0gc3BoZXJlLnJhZGl1cyAqIHNwaGVyZS5yYWRpdXM7CiAgfQogIGludGVyc2VjdHNQbGFuZShwbGFuZSkgewogICAgbGV0IG1pbiwgbWF4OwogICAgaWYgKHBsYW5lLm5vcm1hbC54ID4gMCkgewogICAgICBtaW4gPSBwbGFuZS5ub3JtYWwueCAqIHRoaXMubWluLng7CiAgICAgIG1heCA9IHBsYW5lLm5vcm1hbC54ICogdGhpcy5tYXgueDsKICAgIH0gZWxzZSB7CiAgICAgIG1pbiA9IHBsYW5lLm5vcm1hbC54ICogdGhpcy5tYXgueDsKICAgICAgbWF4ID0gcGxhbmUubm9ybWFsLnggKiB0aGlzLm1pbi54OwogICAgfQogICAgaWYgKHBsYW5lLm5vcm1hbC55ID4gMCkgewogICAgICBtaW4gKz0gcGxhbmUubm9ybWFsLnkgKiB0aGlzLm1pbi55OwogICAgICBtYXggKz0gcGxhbmUubm9ybWFsLnkgKiB0aGlzLm1heC55OwogICAgfSBlbHNlIHsKICAgICAgbWluICs9IHBsYW5lLm5vcm1hbC55ICogdGhpcy5tYXgueTsKICAgICAgbWF4ICs9IHBsYW5lLm5vcm1hbC55ICogdGhpcy5taW4ueTsKICAgIH0KICAgIGlmIChwbGFuZS5ub3JtYWwueiA+IDApIHsKICAgICAgbWluICs9IHBsYW5lLm5vcm1hbC56ICogdGhpcy5taW4uejsKICAgICAgbWF4ICs9IHBsYW5lLm5vcm1hbC56ICogdGhpcy5tYXguejsKICAgIH0gZWxzZSB7CiAgICAgIG1pbiArPSBwbGFuZS5ub3JtYWwueiAqIHRoaXMubWF4Lno7CiAgICAgIG1heCArPSBwbGFuZS5ub3JtYWwueiAqIHRoaXMubWluLno7CiAgICB9CiAgICByZXR1cm4gbWluIDw9IC1wbGFuZS5jb25zdGFudCAmJiBtYXggPj0gLXBsYW5lLmNvbnN0YW50OwogIH0KICBpbnRlcnNlY3RzVHJpYW5nbGUodHJpYW5nbGUpIHsKICAgIGlmICh0aGlzLmlzRW1wdHkoKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB0aGlzLmdldENlbnRlcihfY2VudGVyJDEpOwogICAgX2V4dGVudHMuc3ViVmVjdG9ycyh0aGlzLm1heCwgX2NlbnRlciQxKTsKICAgIF92MCQyLnN1YlZlY3RvcnModHJpYW5nbGUuYSwgX2NlbnRlciQxKTsKICAgIF92MSQ3LnN1YlZlY3RvcnModHJpYW5nbGUuYiwgX2NlbnRlciQxKTsKICAgIF92MiQ0LnN1YlZlY3RvcnModHJpYW5nbGUuYywgX2NlbnRlciQxKTsKICAgIF9mMC5zdWJWZWN0b3JzKF92MSQ3LCBfdjAkMik7CiAgICBfZjEuc3ViVmVjdG9ycyhfdjIkNCwgX3YxJDcpOwogICAgX2YyLnN1YlZlY3RvcnMoX3YwJDIsIF92MiQ0KTsKICAgIGxldCBheGVzID0gWwogICAgICAwLAogICAgICAtX2YwLnosCiAgICAgIF9mMC55LAogICAgICAwLAogICAgICAtX2YxLnosCiAgICAgIF9mMS55LAogICAgICAwLAogICAgICAtX2YyLnosCiAgICAgIF9mMi55LAogICAgICBfZjAueiwKICAgICAgMCwKICAgICAgLV9mMC54LAogICAgICBfZjEueiwKICAgICAgMCwKICAgICAgLV9mMS54LAogICAgICBfZjIueiwKICAgICAgMCwKICAgICAgLV9mMi54LAogICAgICAtX2YwLnksCiAgICAgIF9mMC54LAogICAgICAwLAogICAgICAtX2YxLnksCiAgICAgIF9mMS54LAogICAgICAwLAogICAgICAtX2YyLnksCiAgICAgIF9mMi54LAogICAgICAwCiAgICBdOwogICAgaWYgKCFzYXRGb3JBeGVzKGF4ZXMsIF92MCQyLCBfdjEkNywgX3YyJDQsIF9leHRlbnRzKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBheGVzID0gWzEsIDAsIDAsIDAsIDEsIDAsIDAsIDAsIDFdOwogICAgaWYgKCFzYXRGb3JBeGVzKGF4ZXMsIF92MCQyLCBfdjEkNywgX3YyJDQsIF9leHRlbnRzKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBfdHJpYW5nbGVOb3JtYWwuY3Jvc3NWZWN0b3JzKF9mMCwgX2YxKTsKICAgIGF4ZXMgPSBbX3RyaWFuZ2xlTm9ybWFsLngsIF90cmlhbmdsZU5vcm1hbC55LCBfdHJpYW5nbGVOb3JtYWwuel07CiAgICByZXR1cm4gc2F0Rm9yQXhlcyhheGVzLCBfdjAkMiwgX3YxJDcsIF92MiQ0LCBfZXh0ZW50cyk7CiAgfQogIGNsYW1wUG9pbnQocG9pbnQsIHRhcmdldCkgewogICAgcmV0dXJuIHRhcmdldC5jb3B5KHBvaW50KS5jbGFtcCh0aGlzLm1pbiwgdGhpcy5tYXgpOwogIH0KICBkaXN0YW5jZVRvUG9pbnQocG9pbnQpIHsKICAgIHJldHVybiB0aGlzLmNsYW1wUG9pbnQocG9pbnQsIF92ZWN0b3IkYSkuZGlzdGFuY2VUbyhwb2ludCk7CiAgfQogIGdldEJvdW5kaW5nU3BoZXJlKHRhcmdldCkgewogICAgaWYgKHRoaXMuaXNFbXB0eSgpKSB7CiAgICAgIHRhcmdldC5tYWtlRW1wdHkoKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuZ2V0Q2VudGVyKHRhcmdldC5jZW50ZXIpOwogICAgICB0YXJnZXQucmFkaXVzID0gdGhpcy5nZXRTaXplKF92ZWN0b3IkYSkubGVuZ3RoKCkgKiAwLjU7CiAgICB9CiAgICByZXR1cm4gdGFyZ2V0OwogIH0KICBpbnRlcnNlY3QoYm94KSB7CiAgICB0aGlzLm1pbi5tYXgoYm94Lm1pbik7CiAgICB0aGlzLm1heC5taW4oYm94Lm1heCk7CiAgICBpZiAodGhpcy5pc0VtcHR5KCkpCiAgICAgIHRoaXMubWFrZUVtcHR5KCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgdW5pb24oYm94KSB7CiAgICB0aGlzLm1pbi5taW4oYm94Lm1pbik7CiAgICB0aGlzLm1heC5tYXgoYm94Lm1heCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgYXBwbHlNYXRyaXg0KG1hdHJpeCkgewogICAgaWYgKHRoaXMuaXNFbXB0eSgpKQogICAgICByZXR1cm4gdGhpczsKICAgIF9wb2ludHNbMF0uc2V0KHRoaXMubWluLngsIHRoaXMubWluLnksIHRoaXMubWluLnopLmFwcGx5TWF0cml4NChtYXRyaXgpOwogICAgX3BvaW50c1sxXS5zZXQodGhpcy5taW4ueCwgdGhpcy5taW4ueSwgdGhpcy5tYXgueikuYXBwbHlNYXRyaXg0KG1hdHJpeCk7CiAgICBfcG9pbnRzWzJdLnNldCh0aGlzLm1pbi54LCB0aGlzLm1heC55LCB0aGlzLm1pbi56KS5hcHBseU1hdHJpeDQobWF0cml4KTsKICAgIF9wb2ludHNbM10uc2V0KHRoaXMubWluLngsIHRoaXMubWF4LnksIHRoaXMubWF4LnopLmFwcGx5TWF0cml4NChtYXRyaXgpOwogICAgX3BvaW50c1s0XS5zZXQodGhpcy5tYXgueCwgdGhpcy5taW4ueSwgdGhpcy5taW4ueikuYXBwbHlNYXRyaXg0KG1hdHJpeCk7CiAgICBfcG9pbnRzWzVdLnNldCh0aGlzLm1heC54LCB0aGlzLm1pbi55LCB0aGlzLm1heC56KS5hcHBseU1hdHJpeDQobWF0cml4KTsKICAgIF9wb2ludHNbNl0uc2V0KHRoaXMubWF4LngsIHRoaXMubWF4LnksIHRoaXMubWluLnopLmFwcGx5TWF0cml4NChtYXRyaXgpOwogICAgX3BvaW50c1s3XS5zZXQodGhpcy5tYXgueCwgdGhpcy5tYXgueSwgdGhpcy5tYXgueikuYXBwbHlNYXRyaXg0KG1hdHJpeCk7CiAgICB0aGlzLnNldEZyb21Qb2ludHMoX3BvaW50cyk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgdHJhbnNsYXRlKG9mZnNldCkgewogICAgdGhpcy5taW4uYWRkKG9mZnNldCk7CiAgICB0aGlzLm1heC5hZGQob2Zmc2V0KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBlcXVhbHMoYm94KSB7CiAgICByZXR1cm4gYm94Lm1pbi5lcXVhbHModGhpcy5taW4pICYmIGJveC5tYXguZXF1YWxzKHRoaXMubWF4KTsKICB9Cn0KY29uc3QgX3BvaW50cyA9IFsKICAvKiBAX19QVVJFX18gKi8gbmV3IFZlY3RvcjMkMSgpLAogIC8qIEBfX1BVUkVfXyAqLyBuZXcgVmVjdG9yMyQxKCksCiAgLyogQF9fUFVSRV9fICovIG5ldyBWZWN0b3IzJDEoKSwKICAvKiBAX19QVVJFX18gKi8gbmV3IFZlY3RvcjMkMSgpLAogIC8qIEBfX1BVUkVfXyAqLyBuZXcgVmVjdG9yMyQxKCksCiAgLyogQF9fUFVSRV9fICovIG5ldyBWZWN0b3IzJDEoKSwKICAvKiBAX19QVVJFX18gKi8gbmV3IFZlY3RvcjMkMSgpLAogIC8qIEBfX1BVUkVfXyAqLyBuZXcgVmVjdG9yMyQxKCkKXTsKY29uc3QgX3ZlY3RvciRhID0gLyogQF9fUFVSRV9fICovIG5ldyBWZWN0b3IzJDEoKTsKY29uc3QgX2JveCQzID0gLyogQF9fUFVSRV9fICovIG5ldyBCb3gzKCk7CmNvbnN0IF92MCQyID0gLyogQF9fUFVSRV9fICovIG5ldyBWZWN0b3IzJDEoKTsKY29uc3QgX3YxJDcgPSAvKiBAX19QVVJFX18gKi8gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBfdjIkNCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IF9mMCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IF9mMSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IF9mMiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IF9jZW50ZXIkMSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IF9leHRlbnRzID0gLyogQF9fUFVSRV9fICovIG5ldyBWZWN0b3IzJDEoKTsKY29uc3QgX3RyaWFuZ2xlTm9ybWFsID0gLyogQF9fUFVSRV9fICovIG5ldyBWZWN0b3IzJDEoKTsKY29uc3QgX3Rlc3RBeGlzID0gLyogQF9fUFVSRV9fICovIG5ldyBWZWN0b3IzJDEoKTsKZnVuY3Rpb24gc2F0Rm9yQXhlcyhheGVzLCB2MCwgdjEsIHYyLCBleHRlbnRzKSB7CiAgZm9yIChsZXQgaSA9IDAsIGogPSBheGVzLmxlbmd0aCAtIDM7IGkgPD0gajsgaSArPSAzKSB7CiAgICBfdGVzdEF4aXMuZnJvbUFycmF5KGF4ZXMsIGkpOwogICAgY29uc3QgciA9IGV4dGVudHMueCAqIE1hdGguYWJzKF90ZXN0QXhpcy54KSArIGV4dGVudHMueSAqIE1hdGguYWJzKF90ZXN0QXhpcy55KSArIGV4dGVudHMueiAqIE1hdGguYWJzKF90ZXN0QXhpcy56KTsKICAgIGNvbnN0IHAwID0gdjAuZG90KF90ZXN0QXhpcyk7CiAgICBjb25zdCBwMSA9IHYxLmRvdChfdGVzdEF4aXMpOwogICAgY29uc3QgcDIgPSB2Mi5kb3QoX3Rlc3RBeGlzKTsKICAgIGlmIChNYXRoLm1heCgtTWF0aC5tYXgocDAsIHAxLCBwMiksIE1hdGgubWluKHAwLCBwMSwgcDIpKSA+IHIpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KICByZXR1cm4gdHJ1ZTsKfQpjb25zdCBfdmVjdG9yJDkgPSAvKiBAX19QVVJFX18gKi8gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBfc2VnQ2VudGVyID0gLyogQF9fUFVSRV9fICovIG5ldyBWZWN0b3IzJDEoKTsKY29uc3QgX3NlZ0RpciA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IF9kaWZmID0gLyogQF9fUFVSRV9fICovIG5ldyBWZWN0b3IzJDEoKTsKY29uc3QgX2VkZ2UxID0gLyogQF9fUFVSRV9fICovIG5ldyBWZWN0b3IzJDEoKTsKY29uc3QgX2VkZ2UyID0gLyogQF9fUFVSRV9fICovIG5ldyBWZWN0b3IzJDEoKTsKY29uc3QgX25vcm1hbCQxID0gLyogQF9fUFVSRV9fICovIG5ldyBWZWN0b3IzJDEoKTsKY2xhc3MgUmF5IHsKICBjb25zdHJ1Y3RvcihvcmlnaW4gPSBuZXcgVmVjdG9yMyQxKCksIGRpcmVjdGlvbiA9IG5ldyBWZWN0b3IzJDEoMCwgMCwgLTEpKSB7CiAgICB0aGlzLm9yaWdpbiA9IG9yaWdpbjsKICAgIHRoaXMuZGlyZWN0aW9uID0gZGlyZWN0aW9uOwogIH0KICBzZXQob3JpZ2luLCBkaXJlY3Rpb24pIHsKICAgIHRoaXMub3JpZ2luLmNvcHkob3JpZ2luKTsKICAgIHRoaXMuZGlyZWN0aW9uLmNvcHkoZGlyZWN0aW9uKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjb3B5KHJheSkgewogICAgdGhpcy5vcmlnaW4uY29weShyYXkub3JpZ2luKTsKICAgIHRoaXMuZGlyZWN0aW9uLmNvcHkocmF5LmRpcmVjdGlvbik7CiAgICByZXR1cm4gdGhpczsKICB9CiAgYXQodCwgdGFyZ2V0KSB7CiAgICByZXR1cm4gdGFyZ2V0LmNvcHkodGhpcy5vcmlnaW4pLmFkZFNjYWxlZFZlY3Rvcih0aGlzLmRpcmVjdGlvbiwgdCk7CiAgfQogIGxvb2tBdCh2KSB7CiAgICB0aGlzLmRpcmVjdGlvbi5jb3B5KHYpLnN1Yih0aGlzLm9yaWdpbikubm9ybWFsaXplKCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVjYXN0KHQpIHsKICAgIHRoaXMub3JpZ2luLmNvcHkodGhpcy5hdCh0LCBfdmVjdG9yJDkpKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjbG9zZXN0UG9pbnRUb1BvaW50KHBvaW50LCB0YXJnZXQpIHsKICAgIHRhcmdldC5zdWJWZWN0b3JzKHBvaW50LCB0aGlzLm9yaWdpbik7CiAgICBjb25zdCBkaXJlY3Rpb25EaXN0YW5jZSA9IHRhcmdldC5kb3QodGhpcy5kaXJlY3Rpb24pOwogICAgaWYgKGRpcmVjdGlvbkRpc3RhbmNlIDwgMCkgewogICAgICByZXR1cm4gdGFyZ2V0LmNvcHkodGhpcy5vcmlnaW4pOwogICAgfQogICAgcmV0dXJuIHRhcmdldC5jb3B5KHRoaXMub3JpZ2luKS5hZGRTY2FsZWRWZWN0b3IodGhpcy5kaXJlY3Rpb24sIGRpcmVjdGlvbkRpc3RhbmNlKTsKICB9CiAgZGlzdGFuY2VUb1BvaW50KHBvaW50KSB7CiAgICByZXR1cm4gTWF0aC5zcXJ0KHRoaXMuZGlzdGFuY2VTcVRvUG9pbnQocG9pbnQpKTsKICB9CiAgZGlzdGFuY2VTcVRvUG9pbnQocG9pbnQpIHsKICAgIGNvbnN0IGRpcmVjdGlvbkRpc3RhbmNlID0gX3ZlY3RvciQ5LnN1YlZlY3RvcnMocG9pbnQsIHRoaXMub3JpZ2luKS5kb3QodGhpcy5kaXJlY3Rpb24pOwogICAgaWYgKGRpcmVjdGlvbkRpc3RhbmNlIDwgMCkgewogICAgICByZXR1cm4gdGhpcy5vcmlnaW4uZGlzdGFuY2VUb1NxdWFyZWQocG9pbnQpOwogICAgfQogICAgX3ZlY3RvciQ5LmNvcHkodGhpcy5vcmlnaW4pLmFkZFNjYWxlZFZlY3Rvcih0aGlzLmRpcmVjdGlvbiwgZGlyZWN0aW9uRGlzdGFuY2UpOwogICAgcmV0dXJuIF92ZWN0b3IkOS5kaXN0YW5jZVRvU3F1YXJlZChwb2ludCk7CiAgfQogIGRpc3RhbmNlU3FUb1NlZ21lbnQodjAsIHYxLCBvcHRpb25hbFBvaW50T25SYXksIG9wdGlvbmFsUG9pbnRPblNlZ21lbnQpIHsKICAgIF9zZWdDZW50ZXIuY29weSh2MCkuYWRkKHYxKS5tdWx0aXBseVNjYWxhcigwLjUpOwogICAgX3NlZ0Rpci5jb3B5KHYxKS5zdWIodjApLm5vcm1hbGl6ZSgpOwogICAgX2RpZmYuY29weSh0aGlzLm9yaWdpbikuc3ViKF9zZWdDZW50ZXIpOwogICAgY29uc3Qgc2VnRXh0ZW50ID0gdjAuZGlzdGFuY2VUbyh2MSkgKiAwLjU7CiAgICBjb25zdCBhMDEgPSAtdGhpcy5kaXJlY3Rpb24uZG90KF9zZWdEaXIpOwogICAgY29uc3QgYjAgPSBfZGlmZi5kb3QodGhpcy5kaXJlY3Rpb24pOwogICAgY29uc3QgYjEgPSAtX2RpZmYuZG90KF9zZWdEaXIpOwogICAgY29uc3QgYyA9IF9kaWZmLmxlbmd0aFNxKCk7CiAgICBjb25zdCBkZXQgPSBNYXRoLmFicygxIC0gYTAxICogYTAxKTsKICAgIGxldCBzMCwgczEsIHNxckRpc3QsIGV4dERldDsKICAgIGlmIChkZXQgPiAwKSB7CiAgICAgIHMwID0gYTAxICogYjEgLSBiMDsKICAgICAgczEgPSBhMDEgKiBiMCAtIGIxOwogICAgICBleHREZXQgPSBzZWdFeHRlbnQgKiBkZXQ7CiAgICAgIGlmIChzMCA+PSAwKSB7CiAgICAgICAgaWYgKHMxID49IC1leHREZXQpIHsKICAgICAgICAgIGlmIChzMSA8PSBleHREZXQpIHsKICAgICAgICAgICAgY29uc3QgaW52RGV0ID0gMSAvIGRldDsKICAgICAgICAgICAgczAgKj0gaW52RGV0OwogICAgICAgICAgICBzMSAqPSBpbnZEZXQ7CiAgICAgICAgICAgIHNxckRpc3QgPSBzMCAqIChzMCArIGEwMSAqIHMxICsgMiAqIGIwKSArIHMxICogKGEwMSAqIHMwICsgczEgKyAyICogYjEpICsgYzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHMxID0gc2VnRXh0ZW50OwogICAgICAgICAgICBzMCA9IE1hdGgubWF4KDAsIC0oYTAxICogczEgKyBiMCkpOwogICAgICAgICAgICBzcXJEaXN0ID0gLXMwICogczAgKyBzMSAqIChzMSArIDIgKiBiMSkgKyBjOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzMSA9IC1zZWdFeHRlbnQ7CiAgICAgICAgICBzMCA9IE1hdGgubWF4KDAsIC0oYTAxICogczEgKyBiMCkpOwogICAgICAgICAgc3FyRGlzdCA9IC1zMCAqIHMwICsgczEgKiAoczEgKyAyICogYjEpICsgYzsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHMxIDw9IC1leHREZXQpIHsKICAgICAgICAgIHMwID0gTWF0aC5tYXgoMCwgLSgtYTAxICogc2VnRXh0ZW50ICsgYjApKTsKICAgICAgICAgIHMxID0gczAgPiAwID8gLXNlZ0V4dGVudCA6IE1hdGgubWluKE1hdGgubWF4KC1zZWdFeHRlbnQsIC1iMSksIHNlZ0V4dGVudCk7CiAgICAgICAgICBzcXJEaXN0ID0gLXMwICogczAgKyBzMSAqIChzMSArIDIgKiBiMSkgKyBjOwogICAgICAgIH0gZWxzZSBpZiAoczEgPD0gZXh0RGV0KSB7CiAgICAgICAgICBzMCA9IDA7CiAgICAgICAgICBzMSA9IE1hdGgubWluKE1hdGgubWF4KC1zZWdFeHRlbnQsIC1iMSksIHNlZ0V4dGVudCk7CiAgICAgICAgICBzcXJEaXN0ID0gczEgKiAoczEgKyAyICogYjEpICsgYzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgczAgPSBNYXRoLm1heCgwLCAtKGEwMSAqIHNlZ0V4dGVudCArIGIwKSk7CiAgICAgICAgICBzMSA9IHMwID4gMCA/IHNlZ0V4dGVudCA6IE1hdGgubWluKE1hdGgubWF4KC1zZWdFeHRlbnQsIC1iMSksIHNlZ0V4dGVudCk7CiAgICAgICAgICBzcXJEaXN0ID0gLXMwICogczAgKyBzMSAqIChzMSArIDIgKiBiMSkgKyBjOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgczEgPSBhMDEgPiAwID8gLXNlZ0V4dGVudCA6IHNlZ0V4dGVudDsKICAgICAgczAgPSBNYXRoLm1heCgwLCAtKGEwMSAqIHMxICsgYjApKTsKICAgICAgc3FyRGlzdCA9IC1zMCAqIHMwICsgczEgKiAoczEgKyAyICogYjEpICsgYzsKICAgIH0KICAgIGlmIChvcHRpb25hbFBvaW50T25SYXkpIHsKICAgICAgb3B0aW9uYWxQb2ludE9uUmF5LmNvcHkodGhpcy5vcmlnaW4pLmFkZFNjYWxlZFZlY3Rvcih0aGlzLmRpcmVjdGlvbiwgczApOwogICAgfQogICAgaWYgKG9wdGlvbmFsUG9pbnRPblNlZ21lbnQpIHsKICAgICAgb3B0aW9uYWxQb2ludE9uU2VnbWVudC5jb3B5KF9zZWdDZW50ZXIpLmFkZFNjYWxlZFZlY3Rvcihfc2VnRGlyLCBzMSk7CiAgICB9CiAgICByZXR1cm4gc3FyRGlzdDsKICB9CiAgaW50ZXJzZWN0U3BoZXJlKHNwaGVyZSwgdGFyZ2V0KSB7CiAgICBfdmVjdG9yJDkuc3ViVmVjdG9ycyhzcGhlcmUuY2VudGVyLCB0aGlzLm9yaWdpbik7CiAgICBjb25zdCB0Y2EgPSBfdmVjdG9yJDkuZG90KHRoaXMuZGlyZWN0aW9uKTsKICAgIGNvbnN0IGQyID0gX3ZlY3RvciQ5LmRvdChfdmVjdG9yJDkpIC0gdGNhICogdGNhOwogICAgY29uc3QgcmFkaXVzMiA9IHNwaGVyZS5yYWRpdXMgKiBzcGhlcmUucmFkaXVzOwogICAgaWYgKGQyID4gcmFkaXVzMikKICAgICAgcmV0dXJuIG51bGw7CiAgICBjb25zdCB0aGMgPSBNYXRoLnNxcnQocmFkaXVzMiAtIGQyKTsKICAgIGNvbnN0IHQwID0gdGNhIC0gdGhjOwogICAgY29uc3QgdDEgPSB0Y2EgKyB0aGM7CiAgICBpZiAodDEgPCAwKQogICAgICByZXR1cm4gbnVsbDsKICAgIGlmICh0MCA8IDApCiAgICAgIHJldHVybiB0aGlzLmF0KHQxLCB0YXJnZXQpOwogICAgcmV0dXJuIHRoaXMuYXQodDAsIHRhcmdldCk7CiAgfQogIGludGVyc2VjdHNTcGhlcmUoc3BoZXJlKSB7CiAgICByZXR1cm4gdGhpcy5kaXN0YW5jZVNxVG9Qb2ludChzcGhlcmUuY2VudGVyKSA8PSBzcGhlcmUucmFkaXVzICogc3BoZXJlLnJhZGl1czsKICB9CiAgZGlzdGFuY2VUb1BsYW5lKHBsYW5lKSB7CiAgICBjb25zdCBkZW5vbWluYXRvciA9IHBsYW5lLm5vcm1hbC5kb3QodGhpcy5kaXJlY3Rpb24pOwogICAgaWYgKGRlbm9taW5hdG9yID09PSAwKSB7CiAgICAgIGlmIChwbGFuZS5kaXN0YW5jZVRvUG9pbnQodGhpcy5vcmlnaW4pID09PSAwKSB7CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCB0ID0gLSh0aGlzLm9yaWdpbi5kb3QocGxhbmUubm9ybWFsKSArIHBsYW5lLmNvbnN0YW50KSAvIGRlbm9taW5hdG9yOwogICAgcmV0dXJuIHQgPj0gMCA/IHQgOiBudWxsOwogIH0KICBpbnRlcnNlY3RQbGFuZShwbGFuZSwgdGFyZ2V0KSB7CiAgICBjb25zdCB0ID0gdGhpcy5kaXN0YW5jZVRvUGxhbmUocGxhbmUpOwogICAgaWYgKHQgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICByZXR1cm4gdGhpcy5hdCh0LCB0YXJnZXQpOwogIH0KICBpbnRlcnNlY3RzUGxhbmUocGxhbmUpIHsKICAgIGNvbnN0IGRpc3RUb1BvaW50ID0gcGxhbmUuZGlzdGFuY2VUb1BvaW50KHRoaXMub3JpZ2luKTsKICAgIGlmIChkaXN0VG9Qb2ludCA9PT0gMCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGNvbnN0IGRlbm9taW5hdG9yID0gcGxhbmUubm9ybWFsLmRvdCh0aGlzLmRpcmVjdGlvbik7CiAgICBpZiAoZGVub21pbmF0b3IgKiBkaXN0VG9Qb2ludCA8IDApIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGludGVyc2VjdEJveChib3gsIHRhcmdldCkgewogICAgbGV0IHRtaW4sIHRtYXgsIHR5bWluLCB0eW1heCwgdHptaW4sIHR6bWF4OwogICAgY29uc3QgaW52ZGlyeCA9IDEgLyB0aGlzLmRpcmVjdGlvbi54LCBpbnZkaXJ5ID0gMSAvIHRoaXMuZGlyZWN0aW9uLnksIGludmRpcnogPSAxIC8gdGhpcy5kaXJlY3Rpb24uejsKICAgIGNvbnN0IG9yaWdpbiA9IHRoaXMub3JpZ2luOwogICAgaWYgKGludmRpcnggPj0gMCkgewogICAgICB0bWluID0gKGJveC5taW4ueCAtIG9yaWdpbi54KSAqIGludmRpcng7CiAgICAgIHRtYXggPSAoYm94Lm1heC54IC0gb3JpZ2luLngpICogaW52ZGlyeDsKICAgIH0gZWxzZSB7CiAgICAgIHRtaW4gPSAoYm94Lm1heC54IC0gb3JpZ2luLngpICogaW52ZGlyeDsKICAgICAgdG1heCA9IChib3gubWluLnggLSBvcmlnaW4ueCkgKiBpbnZkaXJ4OwogICAgfQogICAgaWYgKGludmRpcnkgPj0gMCkgewogICAgICB0eW1pbiA9IChib3gubWluLnkgLSBvcmlnaW4ueSkgKiBpbnZkaXJ5OwogICAgICB0eW1heCA9IChib3gubWF4LnkgLSBvcmlnaW4ueSkgKiBpbnZkaXJ5OwogICAgfSBlbHNlIHsKICAgICAgdHltaW4gPSAoYm94Lm1heC55IC0gb3JpZ2luLnkpICogaW52ZGlyeTsKICAgICAgdHltYXggPSAoYm94Lm1pbi55IC0gb3JpZ2luLnkpICogaW52ZGlyeTsKICAgIH0KICAgIGlmICh0bWluID4gdHltYXggfHwgdHltaW4gPiB0bWF4KQogICAgICByZXR1cm4gbnVsbDsKICAgIGlmICh0eW1pbiA+IHRtaW4gfHwgaXNOYU4odG1pbikpCiAgICAgIHRtaW4gPSB0eW1pbjsKICAgIGlmICh0eW1heCA8IHRtYXggfHwgaXNOYU4odG1heCkpCiAgICAgIHRtYXggPSB0eW1heDsKICAgIGlmIChpbnZkaXJ6ID49IDApIHsKICAgICAgdHptaW4gPSAoYm94Lm1pbi56IC0gb3JpZ2luLnopICogaW52ZGlyejsKICAgICAgdHptYXggPSAoYm94Lm1heC56IC0gb3JpZ2luLnopICogaW52ZGlyejsKICAgIH0gZWxzZSB7CiAgICAgIHR6bWluID0gKGJveC5tYXgueiAtIG9yaWdpbi56KSAqIGludmRpcno7CiAgICAgIHR6bWF4ID0gKGJveC5taW4ueiAtIG9yaWdpbi56KSAqIGludmRpcno7CiAgICB9CiAgICBpZiAodG1pbiA+IHR6bWF4IHx8IHR6bWluID4gdG1heCkKICAgICAgcmV0dXJuIG51bGw7CiAgICBpZiAodHptaW4gPiB0bWluIHx8IHRtaW4gIT09IHRtaW4pCiAgICAgIHRtaW4gPSB0em1pbjsKICAgIGlmICh0em1heCA8IHRtYXggfHwgdG1heCAhPT0gdG1heCkKICAgICAgdG1heCA9IHR6bWF4OwogICAgaWYgKHRtYXggPCAwKQogICAgICByZXR1cm4gbnVsbDsKICAgIHJldHVybiB0aGlzLmF0KHRtaW4gPj0gMCA/IHRtaW4gOiB0bWF4LCB0YXJnZXQpOwogIH0KICBpbnRlcnNlY3RzQm94KGJveCkgewogICAgcmV0dXJuIHRoaXMuaW50ZXJzZWN0Qm94KGJveCwgX3ZlY3RvciQ5KSAhPT0gbnVsbDsKICB9CiAgaW50ZXJzZWN0VHJpYW5nbGUoYSwgYiwgYywgYmFja2ZhY2VDdWxsaW5nLCB0YXJnZXQpIHsKICAgIF9lZGdlMS5zdWJWZWN0b3JzKGIsIGEpOwogICAgX2VkZ2UyLnN1YlZlY3RvcnMoYywgYSk7CiAgICBfbm9ybWFsJDEuY3Jvc3NWZWN0b3JzKF9lZGdlMSwgX2VkZ2UyKTsKICAgIGxldCBEZE4gPSB0aGlzLmRpcmVjdGlvbi5kb3QoX25vcm1hbCQxKTsKICAgIGxldCBzaWduMjsKICAgIGlmIChEZE4gPiAwKSB7CiAgICAgIGlmIChiYWNrZmFjZUN1bGxpbmcpCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIHNpZ24yID0gMTsKICAgIH0gZWxzZSBpZiAoRGROIDwgMCkgewogICAgICBzaWduMiA9IC0xOwogICAgICBEZE4gPSAtRGROOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBfZGlmZi5zdWJWZWN0b3JzKHRoaXMub3JpZ2luLCBhKTsKICAgIGNvbnN0IERkUXhFMiA9IHNpZ24yICogdGhpcy5kaXJlY3Rpb24uZG90KF9lZGdlMi5jcm9zc1ZlY3RvcnMoX2RpZmYsIF9lZGdlMikpOwogICAgaWYgKERkUXhFMiA8IDApIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCBEZEUxeFEgPSBzaWduMiAqIHRoaXMuZGlyZWN0aW9uLmRvdChfZWRnZTEuY3Jvc3MoX2RpZmYpKTsKICAgIGlmIChEZEUxeFEgPCAwKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgaWYgKERkUXhFMiArIERkRTF4USA+IERkTikgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IFFkTiA9IC1zaWduMiAqIF9kaWZmLmRvdChfbm9ybWFsJDEpOwogICAgaWYgKFFkTiA8IDApIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICByZXR1cm4gdGhpcy5hdChRZE4gLyBEZE4sIHRhcmdldCk7CiAgfQogIGFwcGx5TWF0cml4NChtYXRyaXg0KSB7CiAgICB0aGlzLm9yaWdpbi5hcHBseU1hdHJpeDQobWF0cml4NCk7CiAgICB0aGlzLmRpcmVjdGlvbi50cmFuc2Zvcm1EaXJlY3Rpb24obWF0cml4NCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgZXF1YWxzKHJheSkgewogICAgcmV0dXJuIHJheS5vcmlnaW4uZXF1YWxzKHRoaXMub3JpZ2luKSAmJiByYXkuZGlyZWN0aW9uLmVxdWFscyh0aGlzLmRpcmVjdGlvbik7CiAgfQogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSh0aGlzKTsKICB9Cn0KY2xhc3MgTWF0cml4NCB7CiAgY29uc3RydWN0b3IobjExLCBuMTIsIG4xMywgbjE0LCBuMjEsIG4yMiwgbjIzLCBuMjQsIG4zMSwgbjMyLCBuMzMsIG4zNCwgbjQxLCBuNDIsIG40MywgbjQ0KSB7CiAgICBNYXRyaXg0LnByb3RvdHlwZS5pc01hdHJpeDQgPSB0cnVlOwogICAgdGhpcy5lbGVtZW50cyA9IFsKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgXTsKICAgIGlmIChuMTEgIT09IHZvaWQgMCkgewogICAgICB0aGlzLnNldChuMTEsIG4xMiwgbjEzLCBuMTQsIG4yMSwgbjIyLCBuMjMsIG4yNCwgbjMxLCBuMzIsIG4zMywgbjM0LCBuNDEsIG40MiwgbjQzLCBuNDQpOwogICAgfQogIH0KICBzZXQobjExLCBuMTIsIG4xMywgbjE0LCBuMjEsIG4yMiwgbjIzLCBuMjQsIG4zMSwgbjMyLCBuMzMsIG4zNCwgbjQxLCBuNDIsIG40MywgbjQ0KSB7CiAgICBjb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CiAgICB0ZVswXSA9IG4xMTsKICAgIHRlWzRdID0gbjEyOwogICAgdGVbOF0gPSBuMTM7CiAgICB0ZVsxMl0gPSBuMTQ7CiAgICB0ZVsxXSA9IG4yMTsKICAgIHRlWzVdID0gbjIyOwogICAgdGVbOV0gPSBuMjM7CiAgICB0ZVsxM10gPSBuMjQ7CiAgICB0ZVsyXSA9IG4zMTsKICAgIHRlWzZdID0gbjMyOwogICAgdGVbMTBdID0gbjMzOwogICAgdGVbMTRdID0gbjM0OwogICAgdGVbM10gPSBuNDE7CiAgICB0ZVs3XSA9IG40MjsKICAgIHRlWzExXSA9IG40MzsKICAgIHRlWzE1XSA9IG40NDsKICAgIHJldHVybiB0aGlzOwogIH0KICBpZGVudGl0eSgpIHsKICAgIHRoaXMuc2V0KAogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyBNYXRyaXg0KCkuZnJvbUFycmF5KHRoaXMuZWxlbWVudHMpOwogIH0KICBjb3B5KG0pIHsKICAgIGNvbnN0IHRlID0gdGhpcy5lbGVtZW50czsKICAgIGNvbnN0IG1lID0gbS5lbGVtZW50czsKICAgIHRlWzBdID0gbWVbMF07CiAgICB0ZVsxXSA9IG1lWzFdOwogICAgdGVbMl0gPSBtZVsyXTsKICAgIHRlWzNdID0gbWVbM107CiAgICB0ZVs0XSA9IG1lWzRdOwogICAgdGVbNV0gPSBtZVs1XTsKICAgIHRlWzZdID0gbWVbNl07CiAgICB0ZVs3XSA9IG1lWzddOwogICAgdGVbOF0gPSBtZVs4XTsKICAgIHRlWzldID0gbWVbOV07CiAgICB0ZVsxMF0gPSBtZVsxMF07CiAgICB0ZVsxMV0gPSBtZVsxMV07CiAgICB0ZVsxMl0gPSBtZVsxMl07CiAgICB0ZVsxM10gPSBtZVsxM107CiAgICB0ZVsxNF0gPSBtZVsxNF07CiAgICB0ZVsxNV0gPSBtZVsxNV07CiAgICByZXR1cm4gdGhpczsKICB9CiAgY29weVBvc2l0aW9uKG0pIHsKICAgIGNvbnN0IHRlID0gdGhpcy5lbGVtZW50cywgbWUgPSBtLmVsZW1lbnRzOwogICAgdGVbMTJdID0gbWVbMTJdOwogICAgdGVbMTNdID0gbWVbMTNdOwogICAgdGVbMTRdID0gbWVbMTRdOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldEZyb21NYXRyaXgzKG0pIHsKICAgIGNvbnN0IG1lID0gbS5lbGVtZW50czsKICAgIHRoaXMuc2V0KAogICAgICBtZVswXSwKICAgICAgbWVbM10sCiAgICAgIG1lWzZdLAogICAgICAwLAogICAgICBtZVsxXSwKICAgICAgbWVbNF0sCiAgICAgIG1lWzddLAogICAgICAwLAogICAgICBtZVsyXSwKICAgICAgbWVbNV0sCiAgICAgIG1lWzhdLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGV4dHJhY3RCYXNpcyh4QXhpcywgeUF4aXMsIHpBeGlzKSB7CiAgICB4QXhpcy5zZXRGcm9tTWF0cml4Q29sdW1uKHRoaXMsIDApOwogICAgeUF4aXMuc2V0RnJvbU1hdHJpeENvbHVtbih0aGlzLCAxKTsKICAgIHpBeGlzLnNldEZyb21NYXRyaXhDb2x1bW4odGhpcywgMik7CiAgICByZXR1cm4gdGhpczsKICB9CiAgbWFrZUJhc2lzKHhBeGlzLCB5QXhpcywgekF4aXMpIHsKICAgIHRoaXMuc2V0KAogICAgICB4QXhpcy54LAogICAgICB5QXhpcy54LAogICAgICB6QXhpcy54LAogICAgICAwLAogICAgICB4QXhpcy55LAogICAgICB5QXhpcy55LAogICAgICB6QXhpcy55LAogICAgICAwLAogICAgICB4QXhpcy56LAogICAgICB5QXhpcy56LAogICAgICB6QXhpcy56LAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGV4dHJhY3RSb3RhdGlvbihtKSB7CiAgICBjb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CiAgICBjb25zdCBtZSA9IG0uZWxlbWVudHM7CiAgICBjb25zdCBzY2FsZVggPSAxIC8gX3YxJDUuc2V0RnJvbU1hdHJpeENvbHVtbihtLCAwKS5sZW5ndGgoKTsKICAgIGNvbnN0IHNjYWxlWSA9IDEgLyBfdjEkNS5zZXRGcm9tTWF0cml4Q29sdW1uKG0sIDEpLmxlbmd0aCgpOwogICAgY29uc3Qgc2NhbGVaID0gMSAvIF92MSQ1LnNldEZyb21NYXRyaXhDb2x1bW4obSwgMikubGVuZ3RoKCk7CiAgICB0ZVswXSA9IG1lWzBdICogc2NhbGVYOwogICAgdGVbMV0gPSBtZVsxXSAqIHNjYWxlWDsKICAgIHRlWzJdID0gbWVbMl0gKiBzY2FsZVg7CiAgICB0ZVszXSA9IDA7CiAgICB0ZVs0XSA9IG1lWzRdICogc2NhbGVZOwogICAgdGVbNV0gPSBtZVs1XSAqIHNjYWxlWTsKICAgIHRlWzZdID0gbWVbNl0gKiBzY2FsZVk7CiAgICB0ZVs3XSA9IDA7CiAgICB0ZVs4XSA9IG1lWzhdICogc2NhbGVaOwogICAgdGVbOV0gPSBtZVs5XSAqIHNjYWxlWjsKICAgIHRlWzEwXSA9IG1lWzEwXSAqIHNjYWxlWjsKICAgIHRlWzExXSA9IDA7CiAgICB0ZVsxMl0gPSAwOwogICAgdGVbMTNdID0gMDsKICAgIHRlWzE0XSA9IDA7CiAgICB0ZVsxNV0gPSAxOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIG1ha2VSb3RhdGlvbkZyb21FdWxlcihldWxlcikgewogICAgY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzOwogICAgY29uc3QgeCA9IGV1bGVyLngsIHkgPSBldWxlci55LCB6ID0gZXVsZXIuejsKICAgIGNvbnN0IGEgPSBNYXRoLmNvcyh4KSwgYiA9IE1hdGguc2luKHgpOwogICAgY29uc3QgYyA9IE1hdGguY29zKHkpLCBkID0gTWF0aC5zaW4oeSk7CiAgICBjb25zdCBlID0gTWF0aC5jb3MoeiksIGYgPSBNYXRoLnNpbih6KTsKICAgIGlmIChldWxlci5vcmRlciA9PT0gIlhZWiIpIHsKICAgICAgY29uc3QgYWUgPSBhICogZSwgYWYgPSBhICogZiwgYmUgPSBiICogZSwgYmYgPSBiICogZjsKICAgICAgdGVbMF0gPSBjICogZTsKICAgICAgdGVbNF0gPSAtYyAqIGY7CiAgICAgIHRlWzhdID0gZDsKICAgICAgdGVbMV0gPSBhZiArIGJlICogZDsKICAgICAgdGVbNV0gPSBhZSAtIGJmICogZDsKICAgICAgdGVbOV0gPSAtYiAqIGM7CiAgICAgIHRlWzJdID0gYmYgLSBhZSAqIGQ7CiAgICAgIHRlWzZdID0gYmUgKyBhZiAqIGQ7CiAgICAgIHRlWzEwXSA9IGEgKiBjOwogICAgfSBlbHNlIGlmIChldWxlci5vcmRlciA9PT0gIllYWiIpIHsKICAgICAgY29uc3QgY2UgPSBjICogZSwgY2YgPSBjICogZiwgZGUgPSBkICogZSwgZGYgPSBkICogZjsKICAgICAgdGVbMF0gPSBjZSArIGRmICogYjsKICAgICAgdGVbNF0gPSBkZSAqIGIgLSBjZjsKICAgICAgdGVbOF0gPSBhICogZDsKICAgICAgdGVbMV0gPSBhICogZjsKICAgICAgdGVbNV0gPSBhICogZTsKICAgICAgdGVbOV0gPSAtYjsKICAgICAgdGVbMl0gPSBjZiAqIGIgLSBkZTsKICAgICAgdGVbNl0gPSBkZiArIGNlICogYjsKICAgICAgdGVbMTBdID0gYSAqIGM7CiAgICB9IGVsc2UgaWYgKGV1bGVyLm9yZGVyID09PSAiWlhZIikgewogICAgICBjb25zdCBjZSA9IGMgKiBlLCBjZiA9IGMgKiBmLCBkZSA9IGQgKiBlLCBkZiA9IGQgKiBmOwogICAgICB0ZVswXSA9IGNlIC0gZGYgKiBiOwogICAgICB0ZVs0XSA9IC1hICogZjsKICAgICAgdGVbOF0gPSBkZSArIGNmICogYjsKICAgICAgdGVbMV0gPSBjZiArIGRlICogYjsKICAgICAgdGVbNV0gPSBhICogZTsKICAgICAgdGVbOV0gPSBkZiAtIGNlICogYjsKICAgICAgdGVbMl0gPSAtYSAqIGQ7CiAgICAgIHRlWzZdID0gYjsKICAgICAgdGVbMTBdID0gYSAqIGM7CiAgICB9IGVsc2UgaWYgKGV1bGVyLm9yZGVyID09PSAiWllYIikgewogICAgICBjb25zdCBhZSA9IGEgKiBlLCBhZiA9IGEgKiBmLCBiZSA9IGIgKiBlLCBiZiA9IGIgKiBmOwogICAgICB0ZVswXSA9IGMgKiBlOwogICAgICB0ZVs0XSA9IGJlICogZCAtIGFmOwogICAgICB0ZVs4XSA9IGFlICogZCArIGJmOwogICAgICB0ZVsxXSA9IGMgKiBmOwogICAgICB0ZVs1XSA9IGJmICogZCArIGFlOwogICAgICB0ZVs5XSA9IGFmICogZCAtIGJlOwogICAgICB0ZVsyXSA9IC1kOwogICAgICB0ZVs2XSA9IGIgKiBjOwogICAgICB0ZVsxMF0gPSBhICogYzsKICAgIH0gZWxzZSBpZiAoZXVsZXIub3JkZXIgPT09ICJZWlgiKSB7CiAgICAgIGNvbnN0IGFjID0gYSAqIGMsIGFkID0gYSAqIGQsIGJjID0gYiAqIGMsIGJkID0gYiAqIGQ7CiAgICAgIHRlWzBdID0gYyAqIGU7CiAgICAgIHRlWzRdID0gYmQgLSBhYyAqIGY7CiAgICAgIHRlWzhdID0gYmMgKiBmICsgYWQ7CiAgICAgIHRlWzFdID0gZjsKICAgICAgdGVbNV0gPSBhICogZTsKICAgICAgdGVbOV0gPSAtYiAqIGU7CiAgICAgIHRlWzJdID0gLWQgKiBlOwogICAgICB0ZVs2XSA9IGFkICogZiArIGJjOwogICAgICB0ZVsxMF0gPSBhYyAtIGJkICogZjsKICAgIH0gZWxzZSBpZiAoZXVsZXIub3JkZXIgPT09ICJYWlkiKSB7CiAgICAgIGNvbnN0IGFjID0gYSAqIGMsIGFkID0gYSAqIGQsIGJjID0gYiAqIGMsIGJkID0gYiAqIGQ7CiAgICAgIHRlWzBdID0gYyAqIGU7CiAgICAgIHRlWzRdID0gLWY7CiAgICAgIHRlWzhdID0gZCAqIGU7CiAgICAgIHRlWzFdID0gYWMgKiBmICsgYmQ7CiAgICAgIHRlWzVdID0gYSAqIGU7CiAgICAgIHRlWzldID0gYWQgKiBmIC0gYmM7CiAgICAgIHRlWzJdID0gYmMgKiBmIC0gYWQ7CiAgICAgIHRlWzZdID0gYiAqIGU7CiAgICAgIHRlWzEwXSA9IGJkICogZiArIGFjOwogICAgfQogICAgdGVbM10gPSAwOwogICAgdGVbN10gPSAwOwogICAgdGVbMTFdID0gMDsKICAgIHRlWzEyXSA9IDA7CiAgICB0ZVsxM10gPSAwOwogICAgdGVbMTRdID0gMDsKICAgIHRlWzE1XSA9IDE7CiAgICByZXR1cm4gdGhpczsKICB9CiAgbWFrZVJvdGF0aW9uRnJvbVF1YXRlcm5pb24ocSkgewogICAgcmV0dXJuIHRoaXMuY29tcG9zZShfemVybywgcSwgX29uZSk7CiAgfQogIGxvb2tBdChleWUsIHRhcmdldCwgdXApIHsKICAgIGNvbnN0IHRlID0gdGhpcy5lbGVtZW50czsKICAgIF96LnN1YlZlY3RvcnMoZXllLCB0YXJnZXQpOwogICAgaWYgKF96Lmxlbmd0aFNxKCkgPT09IDApIHsKICAgICAgX3oueiA9IDE7CiAgICB9CiAgICBfei5ub3JtYWxpemUoKTsKICAgIF94LmNyb3NzVmVjdG9ycyh1cCwgX3opOwogICAgaWYgKF94Lmxlbmd0aFNxKCkgPT09IDApIHsKICAgICAgaWYgKE1hdGguYWJzKHVwLnopID09PSAxKSB7CiAgICAgICAgX3oueCArPSAxZS00OwogICAgICB9IGVsc2UgewogICAgICAgIF96LnogKz0gMWUtNDsKICAgICAgfQogICAgICBfei5ub3JtYWxpemUoKTsKICAgICAgX3guY3Jvc3NWZWN0b3JzKHVwLCBfeik7CiAgICB9CiAgICBfeC5ub3JtYWxpemUoKTsKICAgIF95LmNyb3NzVmVjdG9ycyhfeiwgX3gpOwogICAgdGVbMF0gPSBfeC54OwogICAgdGVbNF0gPSBfeS54OwogICAgdGVbOF0gPSBfei54OwogICAgdGVbMV0gPSBfeC55OwogICAgdGVbNV0gPSBfeS55OwogICAgdGVbOV0gPSBfei55OwogICAgdGVbMl0gPSBfeC56OwogICAgdGVbNl0gPSBfeS56OwogICAgdGVbMTBdID0gX3ouejsKICAgIHJldHVybiB0aGlzOwogIH0KICBtdWx0aXBseShtKSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseU1hdHJpY2VzKHRoaXMsIG0pOwogIH0KICBwcmVtdWx0aXBseShtKSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseU1hdHJpY2VzKG0sIHRoaXMpOwogIH0KICBtdWx0aXBseU1hdHJpY2VzKGEsIGIpIHsKICAgIGNvbnN0IGFlID0gYS5lbGVtZW50czsKICAgIGNvbnN0IGJlID0gYi5lbGVtZW50czsKICAgIGNvbnN0IHRlID0gdGhpcy5lbGVtZW50czsKICAgIGNvbnN0IGExMSA9IGFlWzBdLCBhMTIgPSBhZVs0XSwgYTEzID0gYWVbOF0sIGExNCA9IGFlWzEyXTsKICAgIGNvbnN0IGEyMSA9IGFlWzFdLCBhMjIgPSBhZVs1XSwgYTIzID0gYWVbOV0sIGEyNCA9IGFlWzEzXTsKICAgIGNvbnN0IGEzMSA9IGFlWzJdLCBhMzIgPSBhZVs2XSwgYTMzID0gYWVbMTBdLCBhMzQgPSBhZVsxNF07CiAgICBjb25zdCBhNDEgPSBhZVszXSwgYTQyID0gYWVbN10sIGE0MyA9IGFlWzExXSwgYTQ0ID0gYWVbMTVdOwogICAgY29uc3QgYjExID0gYmVbMF0sIGIxMiA9IGJlWzRdLCBiMTMgPSBiZVs4XSwgYjE0ID0gYmVbMTJdOwogICAgY29uc3QgYjIxID0gYmVbMV0sIGIyMiA9IGJlWzVdLCBiMjMgPSBiZVs5XSwgYjI0ID0gYmVbMTNdOwogICAgY29uc3QgYjMxID0gYmVbMl0sIGIzMiA9IGJlWzZdLCBiMzMgPSBiZVsxMF0sIGIzNCA9IGJlWzE0XTsKICAgIGNvbnN0IGI0MSA9IGJlWzNdLCBiNDIgPSBiZVs3XSwgYjQzID0gYmVbMTFdLCBiNDQgPSBiZVsxNV07CiAgICB0ZVswXSA9IGExMSAqIGIxMSArIGExMiAqIGIyMSArIGExMyAqIGIzMSArIGExNCAqIGI0MTsKICAgIHRlWzRdID0gYTExICogYjEyICsgYTEyICogYjIyICsgYTEzICogYjMyICsgYTE0ICogYjQyOwogICAgdGVbOF0gPSBhMTEgKiBiMTMgKyBhMTIgKiBiMjMgKyBhMTMgKiBiMzMgKyBhMTQgKiBiNDM7CiAgICB0ZVsxMl0gPSBhMTEgKiBiMTQgKyBhMTIgKiBiMjQgKyBhMTMgKiBiMzQgKyBhMTQgKiBiNDQ7CiAgICB0ZVsxXSA9IGEyMSAqIGIxMSArIGEyMiAqIGIyMSArIGEyMyAqIGIzMSArIGEyNCAqIGI0MTsKICAgIHRlWzVdID0gYTIxICogYjEyICsgYTIyICogYjIyICsgYTIzICogYjMyICsgYTI0ICogYjQyOwogICAgdGVbOV0gPSBhMjEgKiBiMTMgKyBhMjIgKiBiMjMgKyBhMjMgKiBiMzMgKyBhMjQgKiBiNDM7CiAgICB0ZVsxM10gPSBhMjEgKiBiMTQgKyBhMjIgKiBiMjQgKyBhMjMgKiBiMzQgKyBhMjQgKiBiNDQ7CiAgICB0ZVsyXSA9IGEzMSAqIGIxMSArIGEzMiAqIGIyMSArIGEzMyAqIGIzMSArIGEzNCAqIGI0MTsKICAgIHRlWzZdID0gYTMxICogYjEyICsgYTMyICogYjIyICsgYTMzICogYjMyICsgYTM0ICogYjQyOwogICAgdGVbMTBdID0gYTMxICogYjEzICsgYTMyICogYjIzICsgYTMzICogYjMzICsgYTM0ICogYjQzOwogICAgdGVbMTRdID0gYTMxICogYjE0ICsgYTMyICogYjI0ICsgYTMzICogYjM0ICsgYTM0ICogYjQ0OwogICAgdGVbM10gPSBhNDEgKiBiMTEgKyBhNDIgKiBiMjEgKyBhNDMgKiBiMzEgKyBhNDQgKiBiNDE7CiAgICB0ZVs3XSA9IGE0MSAqIGIxMiArIGE0MiAqIGIyMiArIGE0MyAqIGIzMiArIGE0NCAqIGI0MjsKICAgIHRlWzExXSA9IGE0MSAqIGIxMyArIGE0MiAqIGIyMyArIGE0MyAqIGIzMyArIGE0NCAqIGI0MzsKICAgIHRlWzE1XSA9IGE0MSAqIGIxNCArIGE0MiAqIGIyNCArIGE0MyAqIGIzNCArIGE0NCAqIGI0NDsKICAgIHJldHVybiB0aGlzOwogIH0KICBtdWx0aXBseVNjYWxhcihzKSB7CiAgICBjb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CiAgICB0ZVswXSAqPSBzOwogICAgdGVbNF0gKj0gczsKICAgIHRlWzhdICo9IHM7CiAgICB0ZVsxMl0gKj0gczsKICAgIHRlWzFdICo9IHM7CiAgICB0ZVs1XSAqPSBzOwogICAgdGVbOV0gKj0gczsKICAgIHRlWzEzXSAqPSBzOwogICAgdGVbMl0gKj0gczsKICAgIHRlWzZdICo9IHM7CiAgICB0ZVsxMF0gKj0gczsKICAgIHRlWzE0XSAqPSBzOwogICAgdGVbM10gKj0gczsKICAgIHRlWzddICo9IHM7CiAgICB0ZVsxMV0gKj0gczsKICAgIHRlWzE1XSAqPSBzOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGRldGVybWluYW50KCkgewogICAgY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzOwogICAgY29uc3QgbjExID0gdGVbMF0sIG4xMiA9IHRlWzRdLCBuMTMgPSB0ZVs4XSwgbjE0ID0gdGVbMTJdOwogICAgY29uc3QgbjIxID0gdGVbMV0sIG4yMiA9IHRlWzVdLCBuMjMgPSB0ZVs5XSwgbjI0ID0gdGVbMTNdOwogICAgY29uc3QgbjMxID0gdGVbMl0sIG4zMiA9IHRlWzZdLCBuMzMgPSB0ZVsxMF0sIG4zNCA9IHRlWzE0XTsKICAgIGNvbnN0IG40MSA9IHRlWzNdLCBuNDIgPSB0ZVs3XSwgbjQzID0gdGVbMTFdLCBuNDQgPSB0ZVsxNV07CiAgICByZXR1cm4gbjQxICogKCtuMTQgKiBuMjMgKiBuMzIgLSBuMTMgKiBuMjQgKiBuMzIgLSBuMTQgKiBuMjIgKiBuMzMgKyBuMTIgKiBuMjQgKiBuMzMgKyBuMTMgKiBuMjIgKiBuMzQgLSBuMTIgKiBuMjMgKiBuMzQpICsgbjQyICogKCtuMTEgKiBuMjMgKiBuMzQgLSBuMTEgKiBuMjQgKiBuMzMgKyBuMTQgKiBuMjEgKiBuMzMgLSBuMTMgKiBuMjEgKiBuMzQgKyBuMTMgKiBuMjQgKiBuMzEgLSBuMTQgKiBuMjMgKiBuMzEpICsgbjQzICogKCtuMTEgKiBuMjQgKiBuMzIgLSBuMTEgKiBuMjIgKiBuMzQgLSBuMTQgKiBuMjEgKiBuMzIgKyBuMTIgKiBuMjEgKiBuMzQgKyBuMTQgKiBuMjIgKiBuMzEgLSBuMTIgKiBuMjQgKiBuMzEpICsgbjQ0ICogKC1uMTMgKiBuMjIgKiBuMzEgLSBuMTEgKiBuMjMgKiBuMzIgKyBuMTEgKiBuMjIgKiBuMzMgKyBuMTMgKiBuMjEgKiBuMzIgLSBuMTIgKiBuMjEgKiBuMzMgKyBuMTIgKiBuMjMgKiBuMzEpOwogIH0KICB0cmFuc3Bvc2UoKSB7CiAgICBjb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CiAgICBsZXQgdG1wOwogICAgdG1wID0gdGVbMV07CiAgICB0ZVsxXSA9IHRlWzRdOwogICAgdGVbNF0gPSB0bXA7CiAgICB0bXAgPSB0ZVsyXTsKICAgIHRlWzJdID0gdGVbOF07CiAgICB0ZVs4XSA9IHRtcDsKICAgIHRtcCA9IHRlWzZdOwogICAgdGVbNl0gPSB0ZVs5XTsKICAgIHRlWzldID0gdG1wOwogICAgdG1wID0gdGVbM107CiAgICB0ZVszXSA9IHRlWzEyXTsKICAgIHRlWzEyXSA9IHRtcDsKICAgIHRtcCA9IHRlWzddOwogICAgdGVbN10gPSB0ZVsxM107CiAgICB0ZVsxM10gPSB0bXA7CiAgICB0bXAgPSB0ZVsxMV07CiAgICB0ZVsxMV0gPSB0ZVsxNF07CiAgICB0ZVsxNF0gPSB0bXA7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0UG9zaXRpb24oeCwgeSwgeikgewogICAgY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzOwogICAgaWYgKHguaXNWZWN0b3IzKSB7CiAgICAgIHRlWzEyXSA9IHgueDsKICAgICAgdGVbMTNdID0geC55OwogICAgICB0ZVsxNF0gPSB4Lno7CiAgICB9IGVsc2UgewogICAgICB0ZVsxMl0gPSB4OwogICAgICB0ZVsxM10gPSB5OwogICAgICB0ZVsxNF0gPSB6OwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIGludmVydCgpIHsKICAgIGNvbnN0IHRlID0gdGhpcy5lbGVtZW50cywgbjExID0gdGVbMF0sIG4yMSA9IHRlWzFdLCBuMzEgPSB0ZVsyXSwgbjQxID0gdGVbM10sIG4xMiA9IHRlWzRdLCBuMjIgPSB0ZVs1XSwgbjMyID0gdGVbNl0sIG40MiA9IHRlWzddLCBuMTMgPSB0ZVs4XSwgbjIzID0gdGVbOV0sIG4zMyA9IHRlWzEwXSwgbjQzID0gdGVbMTFdLCBuMTQgPSB0ZVsxMl0sIG4yNCA9IHRlWzEzXSwgbjM0ID0gdGVbMTRdLCBuNDQgPSB0ZVsxNV0sIHQxMSA9IG4yMyAqIG4zNCAqIG40MiAtIG4yNCAqIG4zMyAqIG40MiArIG4yNCAqIG4zMiAqIG40MyAtIG4yMiAqIG4zNCAqIG40MyAtIG4yMyAqIG4zMiAqIG40NCArIG4yMiAqIG4zMyAqIG40NCwgdDEyID0gbjE0ICogbjMzICogbjQyIC0gbjEzICogbjM0ICogbjQyIC0gbjE0ICogbjMyICogbjQzICsgbjEyICogbjM0ICogbjQzICsgbjEzICogbjMyICogbjQ0IC0gbjEyICogbjMzICogbjQ0LCB0MTMgPSBuMTMgKiBuMjQgKiBuNDIgLSBuMTQgKiBuMjMgKiBuNDIgKyBuMTQgKiBuMjIgKiBuNDMgLSBuMTIgKiBuMjQgKiBuNDMgLSBuMTMgKiBuMjIgKiBuNDQgKyBuMTIgKiBuMjMgKiBuNDQsIHQxNCA9IG4xNCAqIG4yMyAqIG4zMiAtIG4xMyAqIG4yNCAqIG4zMiAtIG4xNCAqIG4yMiAqIG4zMyArIG4xMiAqIG4yNCAqIG4zMyArIG4xMyAqIG4yMiAqIG4zNCAtIG4xMiAqIG4yMyAqIG4zNDsKICAgIGNvbnN0IGRldCA9IG4xMSAqIHQxMSArIG4yMSAqIHQxMiArIG4zMSAqIHQxMyArIG40MSAqIHQxNDsKICAgIGlmIChkZXQgPT09IDApCiAgICAgIHJldHVybiB0aGlzLnNldCgwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwKTsKICAgIGNvbnN0IGRldEludiA9IDEgLyBkZXQ7CiAgICB0ZVswXSA9IHQxMSAqIGRldEludjsKICAgIHRlWzFdID0gKG4yNCAqIG4zMyAqIG40MSAtIG4yMyAqIG4zNCAqIG40MSAtIG4yNCAqIG4zMSAqIG40MyArIG4yMSAqIG4zNCAqIG40MyArIG4yMyAqIG4zMSAqIG40NCAtIG4yMSAqIG4zMyAqIG40NCkgKiBkZXRJbnY7CiAgICB0ZVsyXSA9IChuMjIgKiBuMzQgKiBuNDEgLSBuMjQgKiBuMzIgKiBuNDEgKyBuMjQgKiBuMzEgKiBuNDIgLSBuMjEgKiBuMzQgKiBuNDIgLSBuMjIgKiBuMzEgKiBuNDQgKyBuMjEgKiBuMzIgKiBuNDQpICogZGV0SW52OwogICAgdGVbM10gPSAobjIzICogbjMyICogbjQxIC0gbjIyICogbjMzICogbjQxIC0gbjIzICogbjMxICogbjQyICsgbjIxICogbjMzICogbjQyICsgbjIyICogbjMxICogbjQzIC0gbjIxICogbjMyICogbjQzKSAqIGRldEludjsKICAgIHRlWzRdID0gdDEyICogZGV0SW52OwogICAgdGVbNV0gPSAobjEzICogbjM0ICogbjQxIC0gbjE0ICogbjMzICogbjQxICsgbjE0ICogbjMxICogbjQzIC0gbjExICogbjM0ICogbjQzIC0gbjEzICogbjMxICogbjQ0ICsgbjExICogbjMzICogbjQ0KSAqIGRldEludjsKICAgIHRlWzZdID0gKG4xNCAqIG4zMiAqIG40MSAtIG4xMiAqIG4zNCAqIG40MSAtIG4xNCAqIG4zMSAqIG40MiArIG4xMSAqIG4zNCAqIG40MiArIG4xMiAqIG4zMSAqIG40NCAtIG4xMSAqIG4zMiAqIG40NCkgKiBkZXRJbnY7CiAgICB0ZVs3XSA9IChuMTIgKiBuMzMgKiBuNDEgLSBuMTMgKiBuMzIgKiBuNDEgKyBuMTMgKiBuMzEgKiBuNDIgLSBuMTEgKiBuMzMgKiBuNDIgLSBuMTIgKiBuMzEgKiBuNDMgKyBuMTEgKiBuMzIgKiBuNDMpICogZGV0SW52OwogICAgdGVbOF0gPSB0MTMgKiBkZXRJbnY7CiAgICB0ZVs5XSA9IChuMTQgKiBuMjMgKiBuNDEgLSBuMTMgKiBuMjQgKiBuNDEgLSBuMTQgKiBuMjEgKiBuNDMgKyBuMTEgKiBuMjQgKiBuNDMgKyBuMTMgKiBuMjEgKiBuNDQgLSBuMTEgKiBuMjMgKiBuNDQpICogZGV0SW52OwogICAgdGVbMTBdID0gKG4xMiAqIG4yNCAqIG40MSAtIG4xNCAqIG4yMiAqIG40MSArIG4xNCAqIG4yMSAqIG40MiAtIG4xMSAqIG4yNCAqIG40MiAtIG4xMiAqIG4yMSAqIG40NCArIG4xMSAqIG4yMiAqIG40NCkgKiBkZXRJbnY7CiAgICB0ZVsxMV0gPSAobjEzICogbjIyICogbjQxIC0gbjEyICogbjIzICogbjQxIC0gbjEzICogbjIxICogbjQyICsgbjExICogbjIzICogbjQyICsgbjEyICogbjIxICogbjQzIC0gbjExICogbjIyICogbjQzKSAqIGRldEludjsKICAgIHRlWzEyXSA9IHQxNCAqIGRldEludjsKICAgIHRlWzEzXSA9IChuMTMgKiBuMjQgKiBuMzEgLSBuMTQgKiBuMjMgKiBuMzEgKyBuMTQgKiBuMjEgKiBuMzMgLSBuMTEgKiBuMjQgKiBuMzMgLSBuMTMgKiBuMjEgKiBuMzQgKyBuMTEgKiBuMjMgKiBuMzQpICogZGV0SW52OwogICAgdGVbMTRdID0gKG4xNCAqIG4yMiAqIG4zMSAtIG4xMiAqIG4yNCAqIG4zMSAtIG4xNCAqIG4yMSAqIG4zMiArIG4xMSAqIG4yNCAqIG4zMiArIG4xMiAqIG4yMSAqIG4zNCAtIG4xMSAqIG4yMiAqIG4zNCkgKiBkZXRJbnY7CiAgICB0ZVsxNV0gPSAobjEyICogbjIzICogbjMxIC0gbjEzICogbjIyICogbjMxICsgbjEzICogbjIxICogbjMyIC0gbjExICogbjIzICogbjMyIC0gbjEyICogbjIxICogbjMzICsgbjExICogbjIyICogbjMzKSAqIGRldEludjsKICAgIHJldHVybiB0aGlzOwogIH0KICBzY2FsZSh2KSB7CiAgICBjb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CiAgICBjb25zdCB4ID0gdi54LCB5ID0gdi55LCB6ID0gdi56OwogICAgdGVbMF0gKj0geDsKICAgIHRlWzRdICo9IHk7CiAgICB0ZVs4XSAqPSB6OwogICAgdGVbMV0gKj0geDsKICAgIHRlWzVdICo9IHk7CiAgICB0ZVs5XSAqPSB6OwogICAgdGVbMl0gKj0geDsKICAgIHRlWzZdICo9IHk7CiAgICB0ZVsxMF0gKj0gejsKICAgIHRlWzNdICo9IHg7CiAgICB0ZVs3XSAqPSB5OwogICAgdGVbMTFdICo9IHo7CiAgICByZXR1cm4gdGhpczsKICB9CiAgZ2V0TWF4U2NhbGVPbkF4aXMoKSB7CiAgICBjb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CiAgICBjb25zdCBzY2FsZVhTcSA9IHRlWzBdICogdGVbMF0gKyB0ZVsxXSAqIHRlWzFdICsgdGVbMl0gKiB0ZVsyXTsKICAgIGNvbnN0IHNjYWxlWVNxID0gdGVbNF0gKiB0ZVs0XSArIHRlWzVdICogdGVbNV0gKyB0ZVs2XSAqIHRlWzZdOwogICAgY29uc3Qgc2NhbGVaU3EgPSB0ZVs4XSAqIHRlWzhdICsgdGVbOV0gKiB0ZVs5XSArIHRlWzEwXSAqIHRlWzEwXTsKICAgIHJldHVybiBNYXRoLnNxcnQoTWF0aC5tYXgoc2NhbGVYU3EsIHNjYWxlWVNxLCBzY2FsZVpTcSkpOwogIH0KICBtYWtlVHJhbnNsYXRpb24oeCwgeSwgeikgewogICAgaWYgKHguaXNWZWN0b3IzKSB7CiAgICAgIHRoaXMuc2V0KAogICAgICAgIDEsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIHgueCwKICAgICAgICAwLAogICAgICAgIDEsCiAgICAgICAgMCwKICAgICAgICB4LnksCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDEsCiAgICAgICAgeC56LAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDEKICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuc2V0KAogICAgICAgIDEsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIHgsCiAgICAgICAgMCwKICAgICAgICAxLAogICAgICAgIDAsCiAgICAgICAgeSwKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgMSwKICAgICAgICB6LAogICAgICAgIDAsCiAgICAgICAgMCwKICAgICAgICAwLAogICAgICAgIDEKICAgICAgKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICBtYWtlUm90YXRpb25YKHRoZXRhKSB7CiAgICBjb25zdCBjID0gTWF0aC5jb3ModGhldGEpLCBzID0gTWF0aC5zaW4odGhldGEpOwogICAgdGhpcy5zZXQoCiAgICAgIDEsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIGMsCiAgICAgIC1zLAogICAgICAwLAogICAgICAwLAogICAgICBzLAogICAgICBjLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIG1ha2VSb3RhdGlvblkodGhldGEpIHsKICAgIGNvbnN0IGMgPSBNYXRoLmNvcyh0aGV0YSksIHMgPSBNYXRoLnNpbih0aGV0YSk7CiAgICB0aGlzLnNldCgKICAgICAgYywKICAgICAgMCwKICAgICAgcywKICAgICAgMCwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgLXMsCiAgICAgIDAsCiAgICAgIGMsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgbWFrZVJvdGF0aW9uWih0aGV0YSkgewogICAgY29uc3QgYyA9IE1hdGguY29zKHRoZXRhKSwgcyA9IE1hdGguc2luKHRoZXRhKTsKICAgIHRoaXMuc2V0KAogICAgICBjLAogICAgICAtcywKICAgICAgMCwKICAgICAgMCwKICAgICAgcywKICAgICAgYywKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBtYWtlUm90YXRpb25BeGlzKGF4aXMsIGFuZ2xlKSB7CiAgICBjb25zdCBjID0gTWF0aC5jb3MoYW5nbGUpOwogICAgY29uc3QgcyA9IE1hdGguc2luKGFuZ2xlKTsKICAgIGNvbnN0IHQgPSAxIC0gYzsKICAgIGNvbnN0IHggPSBheGlzLngsIHkgPSBheGlzLnksIHogPSBheGlzLno7CiAgICBjb25zdCB0eCA9IHQgKiB4LCB0eSA9IHQgKiB5OwogICAgdGhpcy5zZXQoCiAgICAgIHR4ICogeCArIGMsCiAgICAgIHR4ICogeSAtIHMgKiB6LAogICAgICB0eCAqIHogKyBzICogeSwKICAgICAgMCwKICAgICAgdHggKiB5ICsgcyAqIHosCiAgICAgIHR5ICogeSArIGMsCiAgICAgIHR5ICogeiAtIHMgKiB4LAogICAgICAwLAogICAgICB0eCAqIHogLSBzICogeSwKICAgICAgdHkgKiB6ICsgcyAqIHgsCiAgICAgIHQgKiB6ICogeiArIGMsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDAsCiAgICAgIDEKICAgICk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgbWFrZVNjYWxlKHgsIHksIHopIHsKICAgIHRoaXMuc2V0KAogICAgICB4LAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICB5LAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICB6LAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAwLAogICAgICAxCiAgICApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIG1ha2VTaGVhcih4eSwgeHosIHl4LCB5eiwgengsIHp5KSB7CiAgICB0aGlzLnNldCgKICAgICAgMSwKICAgICAgeXgsCiAgICAgIHp4LAogICAgICAwLAogICAgICB4eSwKICAgICAgMSwKICAgICAgenksCiAgICAgIDAsCiAgICAgIHh6LAogICAgICB5eiwKICAgICAgMSwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMCwKICAgICAgMQogICAgKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjb21wb3NlKHBvc2l0aW9uLCBxdWF0ZXJuaW9uLCBzY2FsZSkgewogICAgY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzOwogICAgY29uc3QgeCA9IHF1YXRlcm5pb24uX3gsIHkgPSBxdWF0ZXJuaW9uLl95LCB6ID0gcXVhdGVybmlvbi5feiwgdyA9IHF1YXRlcm5pb24uX3c7CiAgICBjb25zdCB4MiA9IHggKyB4LCB5MiA9IHkgKyB5LCB6MiA9IHogKyB6OwogICAgY29uc3QgeHggPSB4ICogeDIsIHh5ID0geCAqIHkyLCB4eiA9IHggKiB6MjsKICAgIGNvbnN0IHl5ID0geSAqIHkyLCB5eiA9IHkgKiB6MiwgenogPSB6ICogejI7CiAgICBjb25zdCB3eCA9IHcgKiB4Miwgd3kgPSB3ICogeTIsIHd6ID0gdyAqIHoyOwogICAgY29uc3Qgc3ggPSBzY2FsZS54LCBzeSA9IHNjYWxlLnksIHN6ID0gc2NhbGUuejsKICAgIHRlWzBdID0gKDEgLSAoeXkgKyB6eikpICogc3g7CiAgICB0ZVsxXSA9ICh4eSArIHd6KSAqIHN4OwogICAgdGVbMl0gPSAoeHogLSB3eSkgKiBzeDsKICAgIHRlWzNdID0gMDsKICAgIHRlWzRdID0gKHh5IC0gd3opICogc3k7CiAgICB0ZVs1XSA9ICgxIC0gKHh4ICsgenopKSAqIHN5OwogICAgdGVbNl0gPSAoeXogKyB3eCkgKiBzeTsKICAgIHRlWzddID0gMDsKICAgIHRlWzhdID0gKHh6ICsgd3kpICogc3o7CiAgICB0ZVs5XSA9ICh5eiAtIHd4KSAqIHN6OwogICAgdGVbMTBdID0gKDEgLSAoeHggKyB5eSkpICogc3o7CiAgICB0ZVsxMV0gPSAwOwogICAgdGVbMTJdID0gcG9zaXRpb24ueDsKICAgIHRlWzEzXSA9IHBvc2l0aW9uLnk7CiAgICB0ZVsxNF0gPSBwb3NpdGlvbi56OwogICAgdGVbMTVdID0gMTsKICAgIHJldHVybiB0aGlzOwogIH0KICBkZWNvbXBvc2UocG9zaXRpb24sIHF1YXRlcm5pb24sIHNjYWxlKSB7CiAgICBjb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CiAgICBsZXQgc3ggPSBfdjEkNS5zZXQodGVbMF0sIHRlWzFdLCB0ZVsyXSkubGVuZ3RoKCk7CiAgICBjb25zdCBzeSA9IF92MSQ1LnNldCh0ZVs0XSwgdGVbNV0sIHRlWzZdKS5sZW5ndGgoKTsKICAgIGNvbnN0IHN6ID0gX3YxJDUuc2V0KHRlWzhdLCB0ZVs5XSwgdGVbMTBdKS5sZW5ndGgoKTsKICAgIGNvbnN0IGRldCA9IHRoaXMuZGV0ZXJtaW5hbnQoKTsKICAgIGlmIChkZXQgPCAwKQogICAgICBzeCA9IC1zeDsKICAgIHBvc2l0aW9uLnggPSB0ZVsxMl07CiAgICBwb3NpdGlvbi55ID0gdGVbMTNdOwogICAgcG9zaXRpb24ueiA9IHRlWzE0XTsKICAgIF9tMSQyLmNvcHkodGhpcyk7CiAgICBjb25zdCBpbnZTWCA9IDEgLyBzeDsKICAgIGNvbnN0IGludlNZID0gMSAvIHN5OwogICAgY29uc3QgaW52U1ogPSAxIC8gc3o7CiAgICBfbTEkMi5lbGVtZW50c1swXSAqPSBpbnZTWDsKICAgIF9tMSQyLmVsZW1lbnRzWzFdICo9IGludlNYOwogICAgX20xJDIuZWxlbWVudHNbMl0gKj0gaW52U1g7CiAgICBfbTEkMi5lbGVtZW50c1s0XSAqPSBpbnZTWTsKICAgIF9tMSQyLmVsZW1lbnRzWzVdICo9IGludlNZOwogICAgX20xJDIuZWxlbWVudHNbNl0gKj0gaW52U1k7CiAgICBfbTEkMi5lbGVtZW50c1s4XSAqPSBpbnZTWjsKICAgIF9tMSQyLmVsZW1lbnRzWzldICo9IGludlNaOwogICAgX20xJDIuZWxlbWVudHNbMTBdICo9IGludlNaOwogICAgcXVhdGVybmlvbi5zZXRGcm9tUm90YXRpb25NYXRyaXgoX20xJDIpOwogICAgc2NhbGUueCA9IHN4OwogICAgc2NhbGUueSA9IHN5OwogICAgc2NhbGUueiA9IHN6OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIG1ha2VQZXJzcGVjdGl2ZShsZWZ0LCByaWdodCwgdG9wLCBib3R0b20sIG5lYXIsIGZhciwgY29vcmRpbmF0ZVN5c3RlbSA9IFdlYkdMQ29vcmRpbmF0ZVN5c3RlbSkgewogICAgY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzOwogICAgY29uc3QgeCA9IDIgKiBuZWFyIC8gKHJpZ2h0IC0gbGVmdCk7CiAgICBjb25zdCB5ID0gMiAqIG5lYXIgLyAodG9wIC0gYm90dG9tKTsKICAgIGNvbnN0IGEgPSAocmlnaHQgKyBsZWZ0KSAvIChyaWdodCAtIGxlZnQpOwogICAgY29uc3QgYiA9ICh0b3AgKyBib3R0b20pIC8gKHRvcCAtIGJvdHRvbSk7CiAgICBsZXQgYywgZDsKICAgIGlmIChjb29yZGluYXRlU3lzdGVtID09PSBXZWJHTENvb3JkaW5hdGVTeXN0ZW0pIHsKICAgICAgYyA9IC0oZmFyICsgbmVhcikgLyAoZmFyIC0gbmVhcik7CiAgICAgIGQgPSAtMiAqIGZhciAqIG5lYXIgLyAoZmFyIC0gbmVhcik7CiAgICB9IGVsc2UgaWYgKGNvb3JkaW5hdGVTeXN0ZW0gPT09IFdlYkdQVUNvb3JkaW5hdGVTeXN0ZW0pIHsKICAgICAgYyA9IC1mYXIgLyAoZmFyIC0gbmVhcik7CiAgICAgIGQgPSAtZmFyICogbmVhciAvIChmYXIgLSBuZWFyKTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVEhSRUUuTWF0cml4NC5tYWtlUGVyc3BlY3RpdmUoKTogSW52YWxpZCBjb29yZGluYXRlIHN5c3RlbTogIiArIGNvb3JkaW5hdGVTeXN0ZW0pOwogICAgfQogICAgdGVbMF0gPSB4OwogICAgdGVbNF0gPSAwOwogICAgdGVbOF0gPSBhOwogICAgdGVbMTJdID0gMDsKICAgIHRlWzFdID0gMDsKICAgIHRlWzVdID0geTsKICAgIHRlWzldID0gYjsKICAgIHRlWzEzXSA9IDA7CiAgICB0ZVsyXSA9IDA7CiAgICB0ZVs2XSA9IDA7CiAgICB0ZVsxMF0gPSBjOwogICAgdGVbMTRdID0gZDsKICAgIHRlWzNdID0gMDsKICAgIHRlWzddID0gMDsKICAgIHRlWzExXSA9IC0xOwogICAgdGVbMTVdID0gMDsKICAgIHJldHVybiB0aGlzOwogIH0KICBtYWtlT3J0aG9ncmFwaGljKGxlZnQsIHJpZ2h0LCB0b3AsIGJvdHRvbSwgbmVhciwgZmFyLCBjb29yZGluYXRlU3lzdGVtID0gV2ViR0xDb29yZGluYXRlU3lzdGVtKSB7CiAgICBjb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CiAgICBjb25zdCB3ID0gMSAvIChyaWdodCAtIGxlZnQpOwogICAgY29uc3QgaCA9IDEgLyAodG9wIC0gYm90dG9tKTsKICAgIGNvbnN0IHAgPSAxIC8gKGZhciAtIG5lYXIpOwogICAgY29uc3QgeCA9IChyaWdodCArIGxlZnQpICogdzsKICAgIGNvbnN0IHkgPSAodG9wICsgYm90dG9tKSAqIGg7CiAgICBsZXQgeiwgekludjsKICAgIGlmIChjb29yZGluYXRlU3lzdGVtID09PSBXZWJHTENvb3JkaW5hdGVTeXN0ZW0pIHsKICAgICAgeiA9IChmYXIgKyBuZWFyKSAqIHA7CiAgICAgIHpJbnYgPSAtMiAqIHA7CiAgICB9IGVsc2UgaWYgKGNvb3JkaW5hdGVTeXN0ZW0gPT09IFdlYkdQVUNvb3JkaW5hdGVTeXN0ZW0pIHsKICAgICAgeiA9IG5lYXIgKiBwOwogICAgICB6SW52ID0gLTEgKiBwOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUSFJFRS5NYXRyaXg0Lm1ha2VPcnRob2dyYXBoaWMoKTogSW52YWxpZCBjb29yZGluYXRlIHN5c3RlbTogIiArIGNvb3JkaW5hdGVTeXN0ZW0pOwogICAgfQogICAgdGVbMF0gPSAyICogdzsKICAgIHRlWzRdID0gMDsKICAgIHRlWzhdID0gMDsKICAgIHRlWzEyXSA9IC14OwogICAgdGVbMV0gPSAwOwogICAgdGVbNV0gPSAyICogaDsKICAgIHRlWzldID0gMDsKICAgIHRlWzEzXSA9IC15OwogICAgdGVbMl0gPSAwOwogICAgdGVbNl0gPSAwOwogICAgdGVbMTBdID0gekludjsKICAgIHRlWzE0XSA9IC16OwogICAgdGVbM10gPSAwOwogICAgdGVbN10gPSAwOwogICAgdGVbMTFdID0gMDsKICAgIHRlWzE1XSA9IDE7CiAgICByZXR1cm4gdGhpczsKICB9CiAgZXF1YWxzKG1hdHJpeCkgewogICAgY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzOwogICAgY29uc3QgbWUgPSBtYXRyaXguZWxlbWVudHM7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDE2OyBpKyspIHsKICAgICAgaWYgKHRlW2ldICE9PSBtZVtpXSkKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZnJvbUFycmF5KGFycmF5LCBvZmZzZXQgPSAwKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDE2OyBpKyspIHsKICAgICAgdGhpcy5lbGVtZW50c1tpXSA9IGFycmF5W2kgKyBvZmZzZXRdOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHRvQXJyYXkoYXJyYXkgPSBbXSwgb2Zmc2V0ID0gMCkgewogICAgY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzOwogICAgYXJyYXlbb2Zmc2V0XSA9IHRlWzBdOwogICAgYXJyYXlbb2Zmc2V0ICsgMV0gPSB0ZVsxXTsKICAgIGFycmF5W29mZnNldCArIDJdID0gdGVbMl07CiAgICBhcnJheVtvZmZzZXQgKyAzXSA9IHRlWzNdOwogICAgYXJyYXlbb2Zmc2V0ICsgNF0gPSB0ZVs0XTsKICAgIGFycmF5W29mZnNldCArIDVdID0gdGVbNV07CiAgICBhcnJheVtvZmZzZXQgKyA2XSA9IHRlWzZdOwogICAgYXJyYXlbb2Zmc2V0ICsgN10gPSB0ZVs3XTsKICAgIGFycmF5W29mZnNldCArIDhdID0gdGVbOF07CiAgICBhcnJheVtvZmZzZXQgKyA5XSA9IHRlWzldOwogICAgYXJyYXlbb2Zmc2V0ICsgMTBdID0gdGVbMTBdOwogICAgYXJyYXlbb2Zmc2V0ICsgMTFdID0gdGVbMTFdOwogICAgYXJyYXlbb2Zmc2V0ICsgMTJdID0gdGVbMTJdOwogICAgYXJyYXlbb2Zmc2V0ICsgMTNdID0gdGVbMTNdOwogICAgYXJyYXlbb2Zmc2V0ICsgMTRdID0gdGVbMTRdOwogICAgYXJyYXlbb2Zmc2V0ICsgMTVdID0gdGVbMTVdOwogICAgcmV0dXJuIGFycmF5OwogIH0KfQpjb25zdCBfdjEkNSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IF9tMSQyID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXRyaXg0KCk7CmNvbnN0IF96ZXJvID0gLyogQF9fUFVSRV9fICovIG5ldyBWZWN0b3IzJDEoMCwgMCwgMCk7CmNvbnN0IF9vbmUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFZlY3RvcjMkMSgxLCAxLCAxKTsKY29uc3QgX3ggPSAvKiBAX19QVVJFX18gKi8gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBfeSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IF96ID0gLyogQF9fUFVSRV9fICovIG5ldyBWZWN0b3IzJDEoKTsKY29uc3QgX3ZlY3RvcjEgPSAvKiBAX19QVVJFX18gKi8gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBfdmVjdG9yMiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IF9ub3JtYWxNYXRyaXggPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hdHJpeDMoKTsKY2xhc3MgUGxhbmUgewogIGNvbnN0cnVjdG9yKG5vcm1hbCA9IG5ldyBWZWN0b3IzJDEoMSwgMCwgMCksIGNvbnN0YW50ID0gMCkgewogICAgdGhpcy5pc1BsYW5lID0gdHJ1ZTsKICAgIHRoaXMubm9ybWFsID0gbm9ybWFsOwogICAgdGhpcy5jb25zdGFudCA9IGNvbnN0YW50OwogIH0KICBzZXQobm9ybWFsLCBjb25zdGFudCkgewogICAgdGhpcy5ub3JtYWwuY29weShub3JtYWwpOwogICAgdGhpcy5jb25zdGFudCA9IGNvbnN0YW50OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldENvbXBvbmVudHMoeCwgeSwgeiwgdykgewogICAgdGhpcy5ub3JtYWwuc2V0KHgsIHksIHopOwogICAgdGhpcy5jb25zdGFudCA9IHc7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0RnJvbU5vcm1hbEFuZENvcGxhbmFyUG9pbnQobm9ybWFsLCBwb2ludCkgewogICAgdGhpcy5ub3JtYWwuY29weShub3JtYWwpOwogICAgdGhpcy5jb25zdGFudCA9IC1wb2ludC5kb3QodGhpcy5ub3JtYWwpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldEZyb21Db3BsYW5hclBvaW50cyhhLCBiLCBjKSB7CiAgICBjb25zdCBub3JtYWwgPSBfdmVjdG9yMS5zdWJWZWN0b3JzKGMsIGIpLmNyb3NzKF92ZWN0b3IyLnN1YlZlY3RvcnMoYSwgYikpLm5vcm1hbGl6ZSgpOwogICAgdGhpcy5zZXRGcm9tTm9ybWFsQW5kQ29wbGFuYXJQb2ludChub3JtYWwsIGEpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGNvcHkocGxhbmUpIHsKICAgIHRoaXMubm9ybWFsLmNvcHkocGxhbmUubm9ybWFsKTsKICAgIHRoaXMuY29uc3RhbnQgPSBwbGFuZS5jb25zdGFudDsKICAgIHJldHVybiB0aGlzOwogIH0KICBub3JtYWxpemUoKSB7CiAgICBjb25zdCBpbnZlcnNlTm9ybWFsTGVuZ3RoID0gMSAvIHRoaXMubm9ybWFsLmxlbmd0aCgpOwogICAgdGhpcy5ub3JtYWwubXVsdGlwbHlTY2FsYXIoaW52ZXJzZU5vcm1hbExlbmd0aCk7CiAgICB0aGlzLmNvbnN0YW50ICo9IGludmVyc2VOb3JtYWxMZW5ndGg7CiAgICByZXR1cm4gdGhpczsKICB9CiAgbmVnYXRlKCkgewogICAgdGhpcy5jb25zdGFudCAqPSAtMTsKICAgIHRoaXMubm9ybWFsLm5lZ2F0ZSgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGRpc3RhbmNlVG9Qb2ludChwb2ludCkgewogICAgcmV0dXJuIHRoaXMubm9ybWFsLmRvdChwb2ludCkgKyB0aGlzLmNvbnN0YW50OwogIH0KICBkaXN0YW5jZVRvU3BoZXJlKHNwaGVyZSkgewogICAgcmV0dXJuIHRoaXMuZGlzdGFuY2VUb1BvaW50KHNwaGVyZS5jZW50ZXIpIC0gc3BoZXJlLnJhZGl1czsKICB9CiAgcHJvamVjdFBvaW50KHBvaW50LCB0YXJnZXQpIHsKICAgIHJldHVybiB0YXJnZXQuY29weShwb2ludCkuYWRkU2NhbGVkVmVjdG9yKHRoaXMubm9ybWFsLCAtdGhpcy5kaXN0YW5jZVRvUG9pbnQocG9pbnQpKTsKICB9CiAgaW50ZXJzZWN0TGluZShsaW5lLCB0YXJnZXQpIHsKICAgIGNvbnN0IGRpcmVjdGlvbiA9IGxpbmUuZGVsdGEoX3ZlY3RvcjEpOwogICAgY29uc3QgZGVub21pbmF0b3IgPSB0aGlzLm5vcm1hbC5kb3QoZGlyZWN0aW9uKTsKICAgIGlmIChkZW5vbWluYXRvciA9PT0gMCkgewogICAgICBpZiAodGhpcy5kaXN0YW5jZVRvUG9pbnQobGluZS5zdGFydCkgPT09IDApIHsKICAgICAgICByZXR1cm4gdGFyZ2V0LmNvcHkobGluZS5zdGFydCk7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCB0ID0gLShsaW5lLnN0YXJ0LmRvdCh0aGlzLm5vcm1hbCkgKyB0aGlzLmNvbnN0YW50KSAvIGRlbm9taW5hdG9yOwogICAgaWYgKHQgPCAwIHx8IHQgPiAxKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgcmV0dXJuIHRhcmdldC5jb3B5KGxpbmUuc3RhcnQpLmFkZFNjYWxlZFZlY3RvcihkaXJlY3Rpb24sIHQpOwogIH0KICBpbnRlcnNlY3RzTGluZShsaW5lKSB7CiAgICBjb25zdCBzdGFydFNpZ24gPSB0aGlzLmRpc3RhbmNlVG9Qb2ludChsaW5lLnN0YXJ0KTsKICAgIGNvbnN0IGVuZFNpZ24gPSB0aGlzLmRpc3RhbmNlVG9Qb2ludChsaW5lLmVuZCk7CiAgICByZXR1cm4gc3RhcnRTaWduIDwgMCAmJiBlbmRTaWduID4gMCB8fCBlbmRTaWduIDwgMCAmJiBzdGFydFNpZ24gPiAwOwogIH0KICBpbnRlcnNlY3RzQm94KGJveCkgewogICAgcmV0dXJuIGJveC5pbnRlcnNlY3RzUGxhbmUodGhpcyk7CiAgfQogIGludGVyc2VjdHNTcGhlcmUoc3BoZXJlKSB7CiAgICByZXR1cm4gc3BoZXJlLmludGVyc2VjdHNQbGFuZSh0aGlzKTsKICB9CiAgY29wbGFuYXJQb2ludCh0YXJnZXQpIHsKICAgIHJldHVybiB0YXJnZXQuY29weSh0aGlzLm5vcm1hbCkubXVsdGlwbHlTY2FsYXIoLXRoaXMuY29uc3RhbnQpOwogIH0KICBhcHBseU1hdHJpeDQobWF0cml4LCBvcHRpb25hbE5vcm1hbE1hdHJpeCkgewogICAgY29uc3Qgbm9ybWFsTWF0cml4ID0gb3B0aW9uYWxOb3JtYWxNYXRyaXggfHwgX25vcm1hbE1hdHJpeC5nZXROb3JtYWxNYXRyaXgobWF0cml4KTsKICAgIGNvbnN0IHJlZmVyZW5jZVBvaW50ID0gdGhpcy5jb3BsYW5hclBvaW50KF92ZWN0b3IxKS5hcHBseU1hdHJpeDQobWF0cml4KTsKICAgIGNvbnN0IG5vcm1hbCA9IHRoaXMubm9ybWFsLmFwcGx5TWF0cml4Myhub3JtYWxNYXRyaXgpLm5vcm1hbGl6ZSgpOwogICAgdGhpcy5jb25zdGFudCA9IC1yZWZlcmVuY2VQb2ludC5kb3Qobm9ybWFsKTsKICAgIHJldHVybiB0aGlzOwogIH0KICB0cmFuc2xhdGUob2Zmc2V0KSB7CiAgICB0aGlzLmNvbnN0YW50IC09IG9mZnNldC5kb3QodGhpcy5ub3JtYWwpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGVxdWFscyhwbGFuZSkgewogICAgcmV0dXJuIHBsYW5lLm5vcm1hbC5lcXVhbHModGhpcy5ub3JtYWwpICYmIHBsYW5lLmNvbnN0YW50ID09PSB0aGlzLmNvbnN0YW50OwogIH0KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkodGhpcyk7CiAgfQp9CmlmICh0eXBlb2YgX19USFJFRV9ERVZUT09MU19fICE9PSAidW5kZWZpbmVkIikgewogIF9fVEhSRUVfREVWVE9PTFNfXy5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgicmVnaXN0ZXIiLCB7IGRldGFpbDogewogICAgcmV2aXNpb246IFJFVklTSU9OCiAgfSB9KSk7Cn0KaWYgKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiKSB7CiAgaWYgKHdpbmRvdy5fX1RIUkVFX18pIHsKICAgIGNvbnNvbGUud2FybigiV0FSTklORzogTXVsdGlwbGUgaW5zdGFuY2VzIG9mIFRocmVlLmpzIGJlaW5nIGltcG9ydGVkLiIpOwogIH0gZWxzZSB7CiAgICB3aW5kb3cuX19USFJFRV9fID0gUkVWSVNJT047CiAgfQp9CmNsYXNzIFF1YXRlcm5pb24gewogIGNvbnN0cnVjdG9yKHggPSAwLCB5ID0gMCwgeiA9IDAsIHcgPSAxKSB7CiAgICB0aGlzLmlzUXVhdGVybmlvbiA9IHRydWU7CiAgICB0aGlzLl94ID0geDsKICAgIHRoaXMuX3kgPSB5OwogICAgdGhpcy5feiA9IHo7CiAgICB0aGlzLl93ID0gdzsKICB9CiAgc3RhdGljIHNsZXJwRmxhdChkc3QsIGRzdE9mZnNldCwgc3JjMCwgc3JjT2Zmc2V0MCwgc3JjMSwgc3JjT2Zmc2V0MSwgdCkgewogICAgbGV0IHgwID0gc3JjMFtzcmNPZmZzZXQwICsgMF0sIHkwID0gc3JjMFtzcmNPZmZzZXQwICsgMV0sIHowID0gc3JjMFtzcmNPZmZzZXQwICsgMl0sIHcwID0gc3JjMFtzcmNPZmZzZXQwICsgM107CiAgICBjb25zdCB4MSA9IHNyYzFbc3JjT2Zmc2V0MSArIDBdLCB5MSA9IHNyYzFbc3JjT2Zmc2V0MSArIDFdLCB6MSA9IHNyYzFbc3JjT2Zmc2V0MSArIDJdLCB3MSA9IHNyYzFbc3JjT2Zmc2V0MSArIDNdOwogICAgaWYgKHQgPT09IDApIHsKICAgICAgZHN0W2RzdE9mZnNldCArIDBdID0geDA7CiAgICAgIGRzdFtkc3RPZmZzZXQgKyAxXSA9IHkwOwogICAgICBkc3RbZHN0T2Zmc2V0ICsgMl0gPSB6MDsKICAgICAgZHN0W2RzdE9mZnNldCArIDNdID0gdzA7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0ID09PSAxKSB7CiAgICAgIGRzdFtkc3RPZmZzZXQgKyAwXSA9IHgxOwogICAgICBkc3RbZHN0T2Zmc2V0ICsgMV0gPSB5MTsKICAgICAgZHN0W2RzdE9mZnNldCArIDJdID0gejE7CiAgICAgIGRzdFtkc3RPZmZzZXQgKyAzXSA9IHcxOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodzAgIT09IHcxIHx8IHgwICE9PSB4MSB8fCB5MCAhPT0geTEgfHwgejAgIT09IHoxKSB7CiAgICAgIGxldCBzID0gMSAtIHQ7CiAgICAgIGNvbnN0IGNvcyA9IHgwICogeDEgKyB5MCAqIHkxICsgejAgKiB6MSArIHcwICogdzEsIGRpciA9IGNvcyA+PSAwID8gMSA6IC0xLCBzcXJTaW4gPSAxIC0gY29zICogY29zOwogICAgICBpZiAoc3FyU2luID4gTnVtYmVyLkVQU0lMT04pIHsKICAgICAgICBjb25zdCBzaW4gPSBNYXRoLnNxcnQoc3FyU2luKSwgbGVuID0gTWF0aC5hdGFuMihzaW4sIGNvcyAqIGRpcik7CiAgICAgICAgcyA9IE1hdGguc2luKHMgKiBsZW4pIC8gc2luOwogICAgICAgIHQgPSBNYXRoLnNpbih0ICogbGVuKSAvIHNpbjsKICAgICAgfQogICAgICBjb25zdCB0RGlyID0gdCAqIGRpcjsKICAgICAgeDAgPSB4MCAqIHMgKyB4MSAqIHREaXI7CiAgICAgIHkwID0geTAgKiBzICsgeTEgKiB0RGlyOwogICAgICB6MCA9IHowICogcyArIHoxICogdERpcjsKICAgICAgdzAgPSB3MCAqIHMgKyB3MSAqIHREaXI7CiAgICAgIGlmIChzID09PSAxIC0gdCkgewogICAgICAgIGNvbnN0IGYgPSAxIC8gTWF0aC5zcXJ0KHgwICogeDAgKyB5MCAqIHkwICsgejAgKiB6MCArIHcwICogdzApOwogICAgICAgIHgwICo9IGY7CiAgICAgICAgeTAgKj0gZjsKICAgICAgICB6MCAqPSBmOwogICAgICAgIHcwICo9IGY7CiAgICAgIH0KICAgIH0KICAgIGRzdFtkc3RPZmZzZXRdID0geDA7CiAgICBkc3RbZHN0T2Zmc2V0ICsgMV0gPSB5MDsKICAgIGRzdFtkc3RPZmZzZXQgKyAyXSA9IHowOwogICAgZHN0W2RzdE9mZnNldCArIDNdID0gdzA7CiAgfQogIHN0YXRpYyBtdWx0aXBseVF1YXRlcm5pb25zRmxhdChkc3QsIGRzdE9mZnNldCwgc3JjMCwgc3JjT2Zmc2V0MCwgc3JjMSwgc3JjT2Zmc2V0MSkgewogICAgY29uc3QgeDAgPSBzcmMwW3NyY09mZnNldDBdOwogICAgY29uc3QgeTAgPSBzcmMwW3NyY09mZnNldDAgKyAxXTsKICAgIGNvbnN0IHowID0gc3JjMFtzcmNPZmZzZXQwICsgMl07CiAgICBjb25zdCB3MCA9IHNyYzBbc3JjT2Zmc2V0MCArIDNdOwogICAgY29uc3QgeDEgPSBzcmMxW3NyY09mZnNldDFdOwogICAgY29uc3QgeTEgPSBzcmMxW3NyY09mZnNldDEgKyAxXTsKICAgIGNvbnN0IHoxID0gc3JjMVtzcmNPZmZzZXQxICsgMl07CiAgICBjb25zdCB3MSA9IHNyYzFbc3JjT2Zmc2V0MSArIDNdOwogICAgZHN0W2RzdE9mZnNldF0gPSB4MCAqIHcxICsgdzAgKiB4MSArIHkwICogejEgLSB6MCAqIHkxOwogICAgZHN0W2RzdE9mZnNldCArIDFdID0geTAgKiB3MSArIHcwICogeTEgKyB6MCAqIHgxIC0geDAgKiB6MTsKICAgIGRzdFtkc3RPZmZzZXQgKyAyXSA9IHowICogdzEgKyB3MCAqIHoxICsgeDAgKiB5MSAtIHkwICogeDE7CiAgICBkc3RbZHN0T2Zmc2V0ICsgM10gPSB3MCAqIHcxIC0geDAgKiB4MSAtIHkwICogeTEgLSB6MCAqIHoxOwogICAgcmV0dXJuIGRzdDsKICB9CiAgZ2V0IHgoKSB7CiAgICByZXR1cm4gdGhpcy5feDsKICB9CiAgc2V0IHgodmFsdWUpIHsKICAgIHRoaXMuX3ggPSB2YWx1ZTsKICAgIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICB9CiAgZ2V0IHkoKSB7CiAgICByZXR1cm4gdGhpcy5feTsKICB9CiAgc2V0IHkodmFsdWUpIHsKICAgIHRoaXMuX3kgPSB2YWx1ZTsKICAgIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICB9CiAgZ2V0IHooKSB7CiAgICByZXR1cm4gdGhpcy5fejsKICB9CiAgc2V0IHoodmFsdWUpIHsKICAgIHRoaXMuX3ogPSB2YWx1ZTsKICAgIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICB9CiAgZ2V0IHcoKSB7CiAgICByZXR1cm4gdGhpcy5fdzsKICB9CiAgc2V0IHcodmFsdWUpIHsKICAgIHRoaXMuX3cgPSB2YWx1ZTsKICAgIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICB9CiAgc2V0KHgsIHksIHosIHcpIHsKICAgIHRoaXMuX3ggPSB4OwogICAgdGhpcy5feSA9IHk7CiAgICB0aGlzLl96ID0gejsKICAgIHRoaXMuX3cgPSB3OwogICAgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMuX3gsIHRoaXMuX3ksIHRoaXMuX3osIHRoaXMuX3cpOwogIH0KICBjb3B5KHF1YXRlcm5pb24pIHsKICAgIHRoaXMuX3ggPSBxdWF0ZXJuaW9uLng7CiAgICB0aGlzLl95ID0gcXVhdGVybmlvbi55OwogICAgdGhpcy5feiA9IHF1YXRlcm5pb24uejsKICAgIHRoaXMuX3cgPSBxdWF0ZXJuaW9uLnc7CiAgICB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0RnJvbUV1bGVyKGV1bGVyLCB1cGRhdGUpIHsKICAgIGNvbnN0IHggPSBldWxlci5feCwgeSA9IGV1bGVyLl95LCB6ID0gZXVsZXIuX3osIG9yZGVyID0gZXVsZXIuX29yZGVyOwogICAgY29uc3QgY29zID0gTWF0aC5jb3M7CiAgICBjb25zdCBzaW4gPSBNYXRoLnNpbjsKICAgIGNvbnN0IGMxID0gY29zKHggLyAyKTsKICAgIGNvbnN0IGMyID0gY29zKHkgLyAyKTsKICAgIGNvbnN0IGMzID0gY29zKHogLyAyKTsKICAgIGNvbnN0IHMxID0gc2luKHggLyAyKTsKICAgIGNvbnN0IHMyID0gc2luKHkgLyAyKTsKICAgIGNvbnN0IHMzID0gc2luKHogLyAyKTsKICAgIHN3aXRjaCAob3JkZXIpIHsKICAgICAgY2FzZSAiWFlaIjoKICAgICAgICB0aGlzLl94ID0gczEgKiBjMiAqIGMzICsgYzEgKiBzMiAqIHMzOwogICAgICAgIHRoaXMuX3kgPSBjMSAqIHMyICogYzMgLSBzMSAqIGMyICogczM7CiAgICAgICAgdGhpcy5feiA9IGMxICogYzIgKiBzMyArIHMxICogczIgKiBjMzsKICAgICAgICB0aGlzLl93ID0gYzEgKiBjMiAqIGMzIC0gczEgKiBzMiAqIHMzOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJZWFoiOgogICAgICAgIHRoaXMuX3ggPSBzMSAqIGMyICogYzMgKyBjMSAqIHMyICogczM7CiAgICAgICAgdGhpcy5feSA9IGMxICogczIgKiBjMyAtIHMxICogYzIgKiBzMzsKICAgICAgICB0aGlzLl96ID0gYzEgKiBjMiAqIHMzIC0gczEgKiBzMiAqIGMzOwogICAgICAgIHRoaXMuX3cgPSBjMSAqIGMyICogYzMgKyBzMSAqIHMyICogczM7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIlpYWSI6CiAgICAgICAgdGhpcy5feCA9IHMxICogYzIgKiBjMyAtIGMxICogczIgKiBzMzsKICAgICAgICB0aGlzLl95ID0gYzEgKiBzMiAqIGMzICsgczEgKiBjMiAqIHMzOwogICAgICAgIHRoaXMuX3ogPSBjMSAqIGMyICogczMgKyBzMSAqIHMyICogYzM7CiAgICAgICAgdGhpcy5fdyA9IGMxICogYzIgKiBjMyAtIHMxICogczIgKiBzMzsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiWllYIjoKICAgICAgICB0aGlzLl94ID0gczEgKiBjMiAqIGMzIC0gYzEgKiBzMiAqIHMzOwogICAgICAgIHRoaXMuX3kgPSBjMSAqIHMyICogYzMgKyBzMSAqIGMyICogczM7CiAgICAgICAgdGhpcy5feiA9IGMxICogYzIgKiBzMyAtIHMxICogczIgKiBjMzsKICAgICAgICB0aGlzLl93ID0gYzEgKiBjMiAqIGMzICsgczEgKiBzMiAqIHMzOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJZWlgiOgogICAgICAgIHRoaXMuX3ggPSBzMSAqIGMyICogYzMgKyBjMSAqIHMyICogczM7CiAgICAgICAgdGhpcy5feSA9IGMxICogczIgKiBjMyArIHMxICogYzIgKiBzMzsKICAgICAgICB0aGlzLl96ID0gYzEgKiBjMiAqIHMzIC0gczEgKiBzMiAqIGMzOwogICAgICAgIHRoaXMuX3cgPSBjMSAqIGMyICogYzMgLSBzMSAqIHMyICogczM7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIlhaWSI6CiAgICAgICAgdGhpcy5feCA9IHMxICogYzIgKiBjMyAtIGMxICogczIgKiBzMzsKICAgICAgICB0aGlzLl95ID0gYzEgKiBzMiAqIGMzIC0gczEgKiBjMiAqIHMzOwogICAgICAgIHRoaXMuX3ogPSBjMSAqIGMyICogczMgKyBzMSAqIHMyICogYzM7CiAgICAgICAgdGhpcy5fdyA9IGMxICogYzIgKiBjMyArIHMxICogczIgKiBzMzsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICBjb25zb2xlLndhcm4oIlRIUkVFLlF1YXRlcm5pb246IC5zZXRGcm9tRXVsZXIoKSBlbmNvdW50ZXJlZCBhbiB1bmtub3duIG9yZGVyOiAiICsgb3JkZXIpOwogICAgfQogICAgaWYgKHVwZGF0ZSAhPT0gZmFsc2UpCiAgICAgIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRGcm9tQXhpc0FuZ2xlKGF4aXMsIGFuZ2xlKSB7CiAgICBjb25zdCBoYWxmQW5nbGUgPSBhbmdsZSAvIDIsIHMgPSBNYXRoLnNpbihoYWxmQW5nbGUpOwogICAgdGhpcy5feCA9IGF4aXMueCAqIHM7CiAgICB0aGlzLl95ID0gYXhpcy55ICogczsKICAgIHRoaXMuX3ogPSBheGlzLnogKiBzOwogICAgdGhpcy5fdyA9IE1hdGguY29zKGhhbGZBbmdsZSk7CiAgICB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0RnJvbVJvdGF0aW9uTWF0cml4KG0pIHsKICAgIGNvbnN0IHRlID0gbS5lbGVtZW50cywgbTExID0gdGVbMF0sIG0xMiA9IHRlWzRdLCBtMTMgPSB0ZVs4XSwgbTIxID0gdGVbMV0sIG0yMiA9IHRlWzVdLCBtMjMgPSB0ZVs5XSwgbTMxID0gdGVbMl0sIG0zMiA9IHRlWzZdLCBtMzMgPSB0ZVsxMF0sIHRyYWNlID0gbTExICsgbTIyICsgbTMzOwogICAgaWYgKHRyYWNlID4gMCkgewogICAgICBjb25zdCBzID0gMC41IC8gTWF0aC5zcXJ0KHRyYWNlICsgMSk7CiAgICAgIHRoaXMuX3cgPSAwLjI1IC8gczsKICAgICAgdGhpcy5feCA9IChtMzIgLSBtMjMpICogczsKICAgICAgdGhpcy5feSA9IChtMTMgLSBtMzEpICogczsKICAgICAgdGhpcy5feiA9IChtMjEgLSBtMTIpICogczsKICAgIH0gZWxzZSBpZiAobTExID4gbTIyICYmIG0xMSA+IG0zMykgewogICAgICBjb25zdCBzID0gMiAqIE1hdGguc3FydCgxICsgbTExIC0gbTIyIC0gbTMzKTsKICAgICAgdGhpcy5fdyA9IChtMzIgLSBtMjMpIC8gczsKICAgICAgdGhpcy5feCA9IDAuMjUgKiBzOwogICAgICB0aGlzLl95ID0gKG0xMiArIG0yMSkgLyBzOwogICAgICB0aGlzLl96ID0gKG0xMyArIG0zMSkgLyBzOwogICAgfSBlbHNlIGlmIChtMjIgPiBtMzMpIHsKICAgICAgY29uc3QgcyA9IDIgKiBNYXRoLnNxcnQoMSArIG0yMiAtIG0xMSAtIG0zMyk7CiAgICAgIHRoaXMuX3cgPSAobTEzIC0gbTMxKSAvIHM7CiAgICAgIHRoaXMuX3ggPSAobTEyICsgbTIxKSAvIHM7CiAgICAgIHRoaXMuX3kgPSAwLjI1ICogczsKICAgICAgdGhpcy5feiA9IChtMjMgKyBtMzIpIC8gczsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHMgPSAyICogTWF0aC5zcXJ0KDEgKyBtMzMgLSBtMTEgLSBtMjIpOwogICAgICB0aGlzLl93ID0gKG0yMSAtIG0xMikgLyBzOwogICAgICB0aGlzLl94ID0gKG0xMyArIG0zMSkgLyBzOwogICAgICB0aGlzLl95ID0gKG0yMyArIG0zMikgLyBzOwogICAgICB0aGlzLl96ID0gMC4yNSAqIHM7CiAgICB9CiAgICB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0RnJvbVVuaXRWZWN0b3JzKHZGcm9tLCB2VG8pIHsKICAgIGxldCByID0gdkZyb20uZG90KHZUbykgKyAxOwogICAgaWYgKHIgPCBOdW1iZXIuRVBTSUxPTikgewogICAgICByID0gMDsKICAgICAgaWYgKE1hdGguYWJzKHZGcm9tLngpID4gTWF0aC5hYnModkZyb20ueikpIHsKICAgICAgICB0aGlzLl94ID0gLXZGcm9tLnk7CiAgICAgICAgdGhpcy5feSA9IHZGcm9tLng7CiAgICAgICAgdGhpcy5feiA9IDA7CiAgICAgICAgdGhpcy5fdyA9IHI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5feCA9IDA7CiAgICAgICAgdGhpcy5feSA9IC12RnJvbS56OwogICAgICAgIHRoaXMuX3ogPSB2RnJvbS55OwogICAgICAgIHRoaXMuX3cgPSByOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0aGlzLl94ID0gdkZyb20ueSAqIHZUby56IC0gdkZyb20ueiAqIHZUby55OwogICAgICB0aGlzLl95ID0gdkZyb20ueiAqIHZUby54IC0gdkZyb20ueCAqIHZUby56OwogICAgICB0aGlzLl96ID0gdkZyb20ueCAqIHZUby55IC0gdkZyb20ueSAqIHZUby54OwogICAgICB0aGlzLl93ID0gcjsKICAgIH0KICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZSgpOwogIH0KICBhbmdsZVRvKHEpIHsKICAgIHJldHVybiAyICogTWF0aC5hY29zKE1hdGguYWJzKGNsYW1wJDEodGhpcy5kb3QocSksIC0xLCAxKSkpOwogIH0KICByb3RhdGVUb3dhcmRzKHEsIHN0ZXApIHsKICAgIGNvbnN0IGFuZ2xlID0gdGhpcy5hbmdsZVRvKHEpOwogICAgaWYgKGFuZ2xlID09PSAwKQogICAgICByZXR1cm4gdGhpczsKICAgIGNvbnN0IHQgPSBNYXRoLm1pbigxLCBzdGVwIC8gYW5nbGUpOwogICAgdGhpcy5zbGVycChxLCB0KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBpZGVudGl0eSgpIHsKICAgIHJldHVybiB0aGlzLnNldCgwLCAwLCAwLCAxKTsKICB9CiAgaW52ZXJ0KCkgewogICAgcmV0dXJuIHRoaXMuY29uanVnYXRlKCk7CiAgfQogIGNvbmp1Z2F0ZSgpIHsKICAgIHRoaXMuX3ggKj0gLTE7CiAgICB0aGlzLl95ICo9IC0xOwogICAgdGhpcy5feiAqPSAtMTsKICAgIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBkb3QodikgewogICAgcmV0dXJuIHRoaXMuX3ggKiB2Ll94ICsgdGhpcy5feSAqIHYuX3kgKyB0aGlzLl96ICogdi5feiArIHRoaXMuX3cgKiB2Ll93OwogIH0KICBsZW5ndGhTcSgpIHsKICAgIHJldHVybiB0aGlzLl94ICogdGhpcy5feCArIHRoaXMuX3kgKiB0aGlzLl95ICsgdGhpcy5feiAqIHRoaXMuX3ogKyB0aGlzLl93ICogdGhpcy5fdzsKICB9CiAgbGVuZ3RoKCkgewogICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLl94ICogdGhpcy5feCArIHRoaXMuX3kgKiB0aGlzLl95ICsgdGhpcy5feiAqIHRoaXMuX3ogKyB0aGlzLl93ICogdGhpcy5fdyk7CiAgfQogIG5vcm1hbGl6ZSgpIHsKICAgIGxldCBsID0gdGhpcy5sZW5ndGgoKTsKICAgIGlmIChsID09PSAwKSB7CiAgICAgIHRoaXMuX3ggPSAwOwogICAgICB0aGlzLl95ID0gMDsKICAgICAgdGhpcy5feiA9IDA7CiAgICAgIHRoaXMuX3cgPSAxOwogICAgfSBlbHNlIHsKICAgICAgbCA9IDEgLyBsOwogICAgICB0aGlzLl94ID0gdGhpcy5feCAqIGw7CiAgICAgIHRoaXMuX3kgPSB0aGlzLl95ICogbDsKICAgICAgdGhpcy5feiA9IHRoaXMuX3ogKiBsOwogICAgICB0aGlzLl93ID0gdGhpcy5fdyAqIGw7CiAgICB9CiAgICB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgbXVsdGlwbHkocSkgewogICAgcmV0dXJuIHRoaXMubXVsdGlwbHlRdWF0ZXJuaW9ucyh0aGlzLCBxKTsKICB9CiAgcHJlbXVsdGlwbHkocSkgewogICAgcmV0dXJuIHRoaXMubXVsdGlwbHlRdWF0ZXJuaW9ucyhxLCB0aGlzKTsKICB9CiAgbXVsdGlwbHlRdWF0ZXJuaW9ucyhhLCBiKSB7CiAgICBjb25zdCBxYXggPSBhLl94LCBxYXkgPSBhLl95LCBxYXogPSBhLl96LCBxYXcgPSBhLl93OwogICAgY29uc3QgcWJ4ID0gYi5feCwgcWJ5ID0gYi5feSwgcWJ6ID0gYi5feiwgcWJ3ID0gYi5fdzsKICAgIHRoaXMuX3ggPSBxYXggKiBxYncgKyBxYXcgKiBxYnggKyBxYXkgKiBxYnogLSBxYXogKiBxYnk7CiAgICB0aGlzLl95ID0gcWF5ICogcWJ3ICsgcWF3ICogcWJ5ICsgcWF6ICogcWJ4IC0gcWF4ICogcWJ6OwogICAgdGhpcy5feiA9IHFheiAqIHFidyArIHFhdyAqIHFieiArIHFheCAqIHFieSAtIHFheSAqIHFieDsKICAgIHRoaXMuX3cgPSBxYXcgKiBxYncgLSBxYXggKiBxYnggLSBxYXkgKiBxYnkgLSBxYXogKiBxYno7CiAgICB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2xlcnAocWIsIHQpIHsKICAgIGlmICh0ID09PSAwKQogICAgICByZXR1cm4gdGhpczsKICAgIGlmICh0ID09PSAxKQogICAgICByZXR1cm4gdGhpcy5jb3B5KHFiKTsKICAgIGNvbnN0IHggPSB0aGlzLl94LCB5ID0gdGhpcy5feSwgeiA9IHRoaXMuX3osIHcgPSB0aGlzLl93OwogICAgbGV0IGNvc0hhbGZUaGV0YSA9IHcgKiBxYi5fdyArIHggKiBxYi5feCArIHkgKiBxYi5feSArIHogKiBxYi5fejsKICAgIGlmIChjb3NIYWxmVGhldGEgPCAwKSB7CiAgICAgIHRoaXMuX3cgPSAtcWIuX3c7CiAgICAgIHRoaXMuX3ggPSAtcWIuX3g7CiAgICAgIHRoaXMuX3kgPSAtcWIuX3k7CiAgICAgIHRoaXMuX3ogPSAtcWIuX3o7CiAgICAgIGNvc0hhbGZUaGV0YSA9IC1jb3NIYWxmVGhldGE7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmNvcHkocWIpOwogICAgfQogICAgaWYgKGNvc0hhbGZUaGV0YSA+PSAxKSB7CiAgICAgIHRoaXMuX3cgPSB3OwogICAgICB0aGlzLl94ID0geDsKICAgICAgdGhpcy5feSA9IHk7CiAgICAgIHRoaXMuX3ogPSB6OwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGNvbnN0IHNxclNpbkhhbGZUaGV0YSA9IDEgLSBjb3NIYWxmVGhldGEgKiBjb3NIYWxmVGhldGE7CiAgICBpZiAoc3FyU2luSGFsZlRoZXRhIDw9IE51bWJlci5FUFNJTE9OKSB7CiAgICAgIGNvbnN0IHMgPSAxIC0gdDsKICAgICAgdGhpcy5fdyA9IHMgKiB3ICsgdCAqIHRoaXMuX3c7CiAgICAgIHRoaXMuX3ggPSBzICogeCArIHQgKiB0aGlzLl94OwogICAgICB0aGlzLl95ID0gcyAqIHkgKyB0ICogdGhpcy5feTsKICAgICAgdGhpcy5feiA9IHMgKiB6ICsgdCAqIHRoaXMuX3o7CiAgICAgIHRoaXMubm9ybWFsaXplKCk7CiAgICAgIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBjb25zdCBzaW5IYWxmVGhldGEgPSBNYXRoLnNxcnQoc3FyU2luSGFsZlRoZXRhKTsKICAgIGNvbnN0IGhhbGZUaGV0YSA9IE1hdGguYXRhbjIoc2luSGFsZlRoZXRhLCBjb3NIYWxmVGhldGEpOwogICAgY29uc3QgcmF0aW9BID0gTWF0aC5zaW4oKDEgLSB0KSAqIGhhbGZUaGV0YSkgLyBzaW5IYWxmVGhldGEsIHJhdGlvQiA9IE1hdGguc2luKHQgKiBoYWxmVGhldGEpIC8gc2luSGFsZlRoZXRhOwogICAgdGhpcy5fdyA9IHcgKiByYXRpb0EgKyB0aGlzLl93ICogcmF0aW9COwogICAgdGhpcy5feCA9IHggKiByYXRpb0EgKyB0aGlzLl94ICogcmF0aW9COwogICAgdGhpcy5feSA9IHkgKiByYXRpb0EgKyB0aGlzLl95ICogcmF0aW9COwogICAgdGhpcy5feiA9IHogKiByYXRpb0EgKyB0aGlzLl96ICogcmF0aW9COwogICAgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNsZXJwUXVhdGVybmlvbnMocWEsIHFiLCB0KSB7CiAgICByZXR1cm4gdGhpcy5jb3B5KHFhKS5zbGVycChxYiwgdCk7CiAgfQogIHJhbmRvbSgpIHsKICAgIGNvbnN0IHUxID0gTWF0aC5yYW5kb20oKTsKICAgIGNvbnN0IHNxcnQxdTEgPSBNYXRoLnNxcnQoMSAtIHUxKTsKICAgIGNvbnN0IHNxcnR1MSA9IE1hdGguc3FydCh1MSk7CiAgICBjb25zdCB1MiA9IDIgKiBNYXRoLlBJICogTWF0aC5yYW5kb20oKTsKICAgIGNvbnN0IHUzID0gMiAqIE1hdGguUEkgKiBNYXRoLnJhbmRvbSgpOwogICAgcmV0dXJuIHRoaXMuc2V0KAogICAgICBzcXJ0MXUxICogTWF0aC5jb3ModTIpLAogICAgICBzcXJ0dTEgKiBNYXRoLnNpbih1MyksCiAgICAgIHNxcnR1MSAqIE1hdGguY29zKHUzKSwKICAgICAgc3FydDF1MSAqIE1hdGguc2luKHUyKQogICAgKTsKICB9CiAgZXF1YWxzKHF1YXRlcm5pb24pIHsKICAgIHJldHVybiBxdWF0ZXJuaW9uLl94ID09PSB0aGlzLl94ICYmIHF1YXRlcm5pb24uX3kgPT09IHRoaXMuX3kgJiYgcXVhdGVybmlvbi5feiA9PT0gdGhpcy5feiAmJiBxdWF0ZXJuaW9uLl93ID09PSB0aGlzLl93OwogIH0KICBmcm9tQXJyYXkoYXJyYXksIG9mZnNldCA9IDApIHsKICAgIHRoaXMuX3ggPSBhcnJheVtvZmZzZXRdOwogICAgdGhpcy5feSA9IGFycmF5W29mZnNldCArIDFdOwogICAgdGhpcy5feiA9IGFycmF5W29mZnNldCArIDJdOwogICAgdGhpcy5fdyA9IGFycmF5W29mZnNldCArIDNdOwogICAgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHRvQXJyYXkoYXJyYXkgPSBbXSwgb2Zmc2V0ID0gMCkgewogICAgYXJyYXlbb2Zmc2V0XSA9IHRoaXMuX3g7CiAgICBhcnJheVtvZmZzZXQgKyAxXSA9IHRoaXMuX3k7CiAgICBhcnJheVtvZmZzZXQgKyAyXSA9IHRoaXMuX3o7CiAgICBhcnJheVtvZmZzZXQgKyAzXSA9IHRoaXMuX3c7CiAgICByZXR1cm4gYXJyYXk7CiAgfQogIGZyb21CdWZmZXJBdHRyaWJ1dGUoYXR0cmlidXRlLCBpbmRleCkgewogICAgdGhpcy5feCA9IGF0dHJpYnV0ZS5nZXRYKGluZGV4KTsKICAgIHRoaXMuX3kgPSBhdHRyaWJ1dGUuZ2V0WShpbmRleCk7CiAgICB0aGlzLl96ID0gYXR0cmlidXRlLmdldFooaW5kZXgpOwogICAgdGhpcy5fdyA9IGF0dHJpYnV0ZS5nZXRXKGluZGV4KTsKICAgIHJldHVybiB0aGlzOwogIH0KICB0b0pTT04oKSB7CiAgICByZXR1cm4gdGhpcy50b0FycmF5KCk7CiAgfQogIF9vbkNoYW5nZShjYWxsYmFjaykgewogICAgdGhpcy5fb25DaGFuZ2VDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIF9vbkNoYW5nZUNhbGxiYWNrKCkgewogIH0KICAqW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICB5aWVsZCB0aGlzLl94OwogICAgeWllbGQgdGhpcy5feTsKICAgIHlpZWxkIHRoaXMuX3o7CiAgICB5aWVsZCB0aGlzLl93OwogIH0KfQpjbGFzcyBWZWN0b3IzIHsKICBjb25zdHJ1Y3Rvcih4ID0gMCwgeSA9IDAsIHogPSAwKSB7CiAgICBWZWN0b3IzLnByb3RvdHlwZS5pc1ZlY3RvcjMgPSB0cnVlOwogICAgdGhpcy54ID0geDsKICAgIHRoaXMueSA9IHk7CiAgICB0aGlzLnogPSB6OwogIH0KICBzZXQoeCwgeSwgeikgewogICAgaWYgKHogPT09IHZvaWQgMCkKICAgICAgeiA9IHRoaXMuejsKICAgIHRoaXMueCA9IHg7CiAgICB0aGlzLnkgPSB5OwogICAgdGhpcy56ID0gejsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRTY2FsYXIoc2NhbGFyKSB7CiAgICB0aGlzLnggPSBzY2FsYXI7CiAgICB0aGlzLnkgPSBzY2FsYXI7CiAgICB0aGlzLnogPSBzY2FsYXI7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0WCh4KSB7CiAgICB0aGlzLnggPSB4OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldFkoeSkgewogICAgdGhpcy55ID0geTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRaKHopIHsKICAgIHRoaXMueiA9IHo7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0Q29tcG9uZW50KGluZGV4LCB2YWx1ZSkgewogICAgc3dpdGNoIChpbmRleCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy54ID0gdmFsdWU7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLnkgPSB2YWx1ZTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMueiA9IHZhbHVlOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgb3V0IG9mIHJhbmdlOiAiICsgaW5kZXgpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIGdldENvbXBvbmVudChpbmRleCkgewogICAgc3dpdGNoIChpbmRleCkgewogICAgICBjYXNlIDA6CiAgICAgICAgcmV0dXJuIHRoaXMueDsKICAgICAgY2FzZSAxOgogICAgICAgIHJldHVybiB0aGlzLnk7CiAgICAgIGNhc2UgMjoKICAgICAgICByZXR1cm4gdGhpcy56OwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgb3V0IG9mIHJhbmdlOiAiICsgaW5kZXgpOwogICAgfQogIH0KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLngsIHRoaXMueSwgdGhpcy56KTsKICB9CiAgY29weSh2KSB7CiAgICB0aGlzLnggPSB2Lng7CiAgICB0aGlzLnkgPSB2Lnk7CiAgICB0aGlzLnogPSB2Lno7CiAgICByZXR1cm4gdGhpczsKICB9CiAgYWRkKHYpIHsKICAgIHRoaXMueCArPSB2Lng7CiAgICB0aGlzLnkgKz0gdi55OwogICAgdGhpcy56ICs9IHYuejsKICAgIHJldHVybiB0aGlzOwogIH0KICBhZGRTY2FsYXIocykgewogICAgdGhpcy54ICs9IHM7CiAgICB0aGlzLnkgKz0gczsKICAgIHRoaXMueiArPSBzOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFkZFZlY3RvcnMoYSwgYikgewogICAgdGhpcy54ID0gYS54ICsgYi54OwogICAgdGhpcy55ID0gYS55ICsgYi55OwogICAgdGhpcy56ID0gYS56ICsgYi56OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFkZFNjYWxlZFZlY3Rvcih2LCBzKSB7CiAgICB0aGlzLnggKz0gdi54ICogczsKICAgIHRoaXMueSArPSB2LnkgKiBzOwogICAgdGhpcy56ICs9IHYueiAqIHM7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc3ViKHYpIHsKICAgIHRoaXMueCAtPSB2Lng7CiAgICB0aGlzLnkgLT0gdi55OwogICAgdGhpcy56IC09IHYuejsKICAgIHJldHVybiB0aGlzOwogIH0KICBzdWJTY2FsYXIocykgewogICAgdGhpcy54IC09IHM7CiAgICB0aGlzLnkgLT0gczsKICAgIHRoaXMueiAtPSBzOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHN1YlZlY3RvcnMoYSwgYikgewogICAgdGhpcy54ID0gYS54IC0gYi54OwogICAgdGhpcy55ID0gYS55IC0gYi55OwogICAgdGhpcy56ID0gYS56IC0gYi56OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIG11bHRpcGx5KHYpIHsKICAgIHRoaXMueCAqPSB2Lng7CiAgICB0aGlzLnkgKj0gdi55OwogICAgdGhpcy56ICo9IHYuejsKICAgIHJldHVybiB0aGlzOwogIH0KICBtdWx0aXBseVNjYWxhcihzY2FsYXIpIHsKICAgIHRoaXMueCAqPSBzY2FsYXI7CiAgICB0aGlzLnkgKj0gc2NhbGFyOwogICAgdGhpcy56ICo9IHNjYWxhcjsKICAgIHJldHVybiB0aGlzOwogIH0KICBtdWx0aXBseVZlY3RvcnMoYSwgYikgewogICAgdGhpcy54ID0gYS54ICogYi54OwogICAgdGhpcy55ID0gYS55ICogYi55OwogICAgdGhpcy56ID0gYS56ICogYi56OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFwcGx5RXVsZXIoZXVsZXIpIHsKICAgIHJldHVybiB0aGlzLmFwcGx5UXVhdGVybmlvbihfcXVhdGVybmlvbi5zZXRGcm9tRXVsZXIoZXVsZXIpKTsKICB9CiAgYXBwbHlBeGlzQW5nbGUoYXhpcywgYW5nbGUpIHsKICAgIHJldHVybiB0aGlzLmFwcGx5UXVhdGVybmlvbihfcXVhdGVybmlvbi5zZXRGcm9tQXhpc0FuZ2xlKGF4aXMsIGFuZ2xlKSk7CiAgfQogIGFwcGx5TWF0cml4MyhtKSB7CiAgICBjb25zdCB4ID0gdGhpcy54LCB5ID0gdGhpcy55LCB6ID0gdGhpcy56OwogICAgY29uc3QgZSA9IG0uZWxlbWVudHM7CiAgICB0aGlzLnggPSBlWzBdICogeCArIGVbM10gKiB5ICsgZVs2XSAqIHo7CiAgICB0aGlzLnkgPSBlWzFdICogeCArIGVbNF0gKiB5ICsgZVs3XSAqIHo7CiAgICB0aGlzLnogPSBlWzJdICogeCArIGVbNV0gKiB5ICsgZVs4XSAqIHo7CiAgICByZXR1cm4gdGhpczsKICB9CiAgYXBwbHlOb3JtYWxNYXRyaXgobSkgewogICAgcmV0dXJuIHRoaXMuYXBwbHlNYXRyaXgzKG0pLm5vcm1hbGl6ZSgpOwogIH0KICBhcHBseU1hdHJpeDQobSkgewogICAgY29uc3QgeCA9IHRoaXMueCwgeSA9IHRoaXMueSwgeiA9IHRoaXMuejsKICAgIGNvbnN0IGUgPSBtLmVsZW1lbnRzOwogICAgY29uc3QgdyA9IDEgLyAoZVszXSAqIHggKyBlWzddICogeSArIGVbMTFdICogeiArIGVbMTVdKTsKICAgIHRoaXMueCA9IChlWzBdICogeCArIGVbNF0gKiB5ICsgZVs4XSAqIHogKyBlWzEyXSkgKiB3OwogICAgdGhpcy55ID0gKGVbMV0gKiB4ICsgZVs1XSAqIHkgKyBlWzldICogeiArIGVbMTNdKSAqIHc7CiAgICB0aGlzLnogPSAoZVsyXSAqIHggKyBlWzZdICogeSArIGVbMTBdICogeiArIGVbMTRdKSAqIHc7CiAgICByZXR1cm4gdGhpczsKICB9CiAgYXBwbHlRdWF0ZXJuaW9uKHEpIHsKICAgIGNvbnN0IHZ4ID0gdGhpcy54LCB2eSA9IHRoaXMueSwgdnogPSB0aGlzLno7CiAgICBjb25zdCBxeCA9IHEueCwgcXkgPSBxLnksIHF6ID0gcS56LCBxdyA9IHEudzsKICAgIGNvbnN0IHR4ID0gMiAqIChxeSAqIHZ6IC0gcXogKiB2eSk7CiAgICBjb25zdCB0eSA9IDIgKiAocXogKiB2eCAtIHF4ICogdnopOwogICAgY29uc3QgdHogPSAyICogKHF4ICogdnkgLSBxeSAqIHZ4KTsKICAgIHRoaXMueCA9IHZ4ICsgcXcgKiB0eCArIHF5ICogdHogLSBxeiAqIHR5OwogICAgdGhpcy55ID0gdnkgKyBxdyAqIHR5ICsgcXogKiB0eCAtIHF4ICogdHo7CiAgICB0aGlzLnogPSB2eiArIHF3ICogdHogKyBxeCAqIHR5IC0gcXkgKiB0eDsKICAgIHJldHVybiB0aGlzOwogIH0KICBwcm9qZWN0KGNhbWVyYSkgewogICAgcmV0dXJuIHRoaXMuYXBwbHlNYXRyaXg0KGNhbWVyYS5tYXRyaXhXb3JsZEludmVyc2UpLmFwcGx5TWF0cml4NChjYW1lcmEucHJvamVjdGlvbk1hdHJpeCk7CiAgfQogIHVucHJvamVjdChjYW1lcmEpIHsKICAgIHJldHVybiB0aGlzLmFwcGx5TWF0cml4NChjYW1lcmEucHJvamVjdGlvbk1hdHJpeEludmVyc2UpLmFwcGx5TWF0cml4NChjYW1lcmEubWF0cml4V29ybGQpOwogIH0KICB0cmFuc2Zvcm1EaXJlY3Rpb24obSkgewogICAgY29uc3QgeCA9IHRoaXMueCwgeSA9IHRoaXMueSwgeiA9IHRoaXMuejsKICAgIGNvbnN0IGUgPSBtLmVsZW1lbnRzOwogICAgdGhpcy54ID0gZVswXSAqIHggKyBlWzRdICogeSArIGVbOF0gKiB6OwogICAgdGhpcy55ID0gZVsxXSAqIHggKyBlWzVdICogeSArIGVbOV0gKiB6OwogICAgdGhpcy56ID0gZVsyXSAqIHggKyBlWzZdICogeSArIGVbMTBdICogejsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZSgpOwogIH0KICBkaXZpZGUodikgewogICAgdGhpcy54IC89IHYueDsKICAgIHRoaXMueSAvPSB2Lnk7CiAgICB0aGlzLnogLz0gdi56OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGRpdmlkZVNjYWxhcihzY2FsYXIpIHsKICAgIHJldHVybiB0aGlzLm11bHRpcGx5U2NhbGFyKDEgLyBzY2FsYXIpOwogIH0KICBtaW4odikgewogICAgdGhpcy54ID0gTWF0aC5taW4odGhpcy54LCB2LngpOwogICAgdGhpcy55ID0gTWF0aC5taW4odGhpcy55LCB2LnkpOwogICAgdGhpcy56ID0gTWF0aC5taW4odGhpcy56LCB2LnopOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIG1heCh2KSB7CiAgICB0aGlzLnggPSBNYXRoLm1heCh0aGlzLngsIHYueCk7CiAgICB0aGlzLnkgPSBNYXRoLm1heCh0aGlzLnksIHYueSk7CiAgICB0aGlzLnogPSBNYXRoLm1heCh0aGlzLnosIHYueik7CiAgICByZXR1cm4gdGhpczsKICB9CiAgY2xhbXAobWluLCBtYXgpIHsKICAgIHRoaXMueCA9IE1hdGgubWF4KG1pbi54LCBNYXRoLm1pbihtYXgueCwgdGhpcy54KSk7CiAgICB0aGlzLnkgPSBNYXRoLm1heChtaW4ueSwgTWF0aC5taW4obWF4LnksIHRoaXMueSkpOwogICAgdGhpcy56ID0gTWF0aC5tYXgobWluLnosIE1hdGgubWluKG1heC56LCB0aGlzLnopKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjbGFtcFNjYWxhcihtaW5WYWwsIG1heFZhbCkgewogICAgdGhpcy54ID0gTWF0aC5tYXgobWluVmFsLCBNYXRoLm1pbihtYXhWYWwsIHRoaXMueCkpOwogICAgdGhpcy55ID0gTWF0aC5tYXgobWluVmFsLCBNYXRoLm1pbihtYXhWYWwsIHRoaXMueSkpOwogICAgdGhpcy56ID0gTWF0aC5tYXgobWluVmFsLCBNYXRoLm1pbihtYXhWYWwsIHRoaXMueikpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGNsYW1wTGVuZ3RoKG1pbiwgbWF4KSB7CiAgICBjb25zdCBsZW5ndGggPSB0aGlzLmxlbmd0aCgpOwogICAgcmV0dXJuIHRoaXMuZGl2aWRlU2NhbGFyKGxlbmd0aCB8fCAxKS5tdWx0aXBseVNjYWxhcihNYXRoLm1heChtaW4sIE1hdGgubWluKG1heCwgbGVuZ3RoKSkpOwogIH0KICBmbG9vcigpIHsKICAgIHRoaXMueCA9IE1hdGguZmxvb3IodGhpcy54KTsKICAgIHRoaXMueSA9IE1hdGguZmxvb3IodGhpcy55KTsKICAgIHRoaXMueiA9IE1hdGguZmxvb3IodGhpcy56KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjZWlsKCkgewogICAgdGhpcy54ID0gTWF0aC5jZWlsKHRoaXMueCk7CiAgICB0aGlzLnkgPSBNYXRoLmNlaWwodGhpcy55KTsKICAgIHRoaXMueiA9IE1hdGguY2VpbCh0aGlzLnopOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJvdW5kKCkgewogICAgdGhpcy54ID0gTWF0aC5yb3VuZCh0aGlzLngpOwogICAgdGhpcy55ID0gTWF0aC5yb3VuZCh0aGlzLnkpOwogICAgdGhpcy56ID0gTWF0aC5yb3VuZCh0aGlzLnopOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJvdW5kVG9aZXJvKCkgewogICAgdGhpcy54ID0gTWF0aC50cnVuYyh0aGlzLngpOwogICAgdGhpcy55ID0gTWF0aC50cnVuYyh0aGlzLnkpOwogICAgdGhpcy56ID0gTWF0aC50cnVuYyh0aGlzLnopOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIG5lZ2F0ZSgpIHsKICAgIHRoaXMueCA9IC10aGlzLng7CiAgICB0aGlzLnkgPSAtdGhpcy55OwogICAgdGhpcy56ID0gLXRoaXMuejsKICAgIHJldHVybiB0aGlzOwogIH0KICBkb3QodikgewogICAgcmV0dXJuIHRoaXMueCAqIHYueCArIHRoaXMueSAqIHYueSArIHRoaXMueiAqIHYuejsKICB9CiAgbGVuZ3RoU3EoKSB7CiAgICByZXR1cm4gdGhpcy54ICogdGhpcy54ICsgdGhpcy55ICogdGhpcy55ICsgdGhpcy56ICogdGhpcy56OwogIH0KICBsZW5ndGgoKSB7CiAgICByZXR1cm4gTWF0aC5zcXJ0KHRoaXMueCAqIHRoaXMueCArIHRoaXMueSAqIHRoaXMueSArIHRoaXMueiAqIHRoaXMueik7CiAgfQogIG1hbmhhdHRhbkxlbmd0aCgpIHsKICAgIHJldHVybiBNYXRoLmFicyh0aGlzLngpICsgTWF0aC5hYnModGhpcy55KSArIE1hdGguYWJzKHRoaXMueik7CiAgfQogIG5vcm1hbGl6ZSgpIHsKICAgIHJldHVybiB0aGlzLmRpdmlkZVNjYWxhcih0aGlzLmxlbmd0aCgpIHx8IDEpOwogIH0KICBzZXRMZW5ndGgobGVuZ3RoKSB7CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcihsZW5ndGgpOwogIH0KICBsZXJwKHYsIGFscGhhKSB7CiAgICB0aGlzLnggKz0gKHYueCAtIHRoaXMueCkgKiBhbHBoYTsKICAgIHRoaXMueSArPSAodi55IC0gdGhpcy55KSAqIGFscGhhOwogICAgdGhpcy56ICs9ICh2LnogLSB0aGlzLnopICogYWxwaGE7CiAgICByZXR1cm4gdGhpczsKICB9CiAgbGVycFZlY3RvcnModjEsIHYyLCBhbHBoYSkgewogICAgdGhpcy54ID0gdjEueCArICh2Mi54IC0gdjEueCkgKiBhbHBoYTsKICAgIHRoaXMueSA9IHYxLnkgKyAodjIueSAtIHYxLnkpICogYWxwaGE7CiAgICB0aGlzLnogPSB2MS56ICsgKHYyLnogLSB2MS56KSAqIGFscGhhOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGNyb3NzKHYpIHsKICAgIHJldHVybiB0aGlzLmNyb3NzVmVjdG9ycyh0aGlzLCB2KTsKICB9CiAgY3Jvc3NWZWN0b3JzKGEsIGIpIHsKICAgIGNvbnN0IGF4ID0gYS54LCBheSA9IGEueSwgYXogPSBhLno7CiAgICBjb25zdCBieCA9IGIueCwgYnkgPSBiLnksIGJ6ID0gYi56OwogICAgdGhpcy54ID0gYXkgKiBieiAtIGF6ICogYnk7CiAgICB0aGlzLnkgPSBheiAqIGJ4IC0gYXggKiBiejsKICAgIHRoaXMueiA9IGF4ICogYnkgLSBheSAqIGJ4OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHByb2plY3RPblZlY3Rvcih2KSB7CiAgICBjb25zdCBkZW5vbWluYXRvciA9IHYubGVuZ3RoU3EoKTsKICAgIGlmIChkZW5vbWluYXRvciA9PT0gMCkKICAgICAgcmV0dXJuIHRoaXMuc2V0KDAsIDAsIDApOwogICAgY29uc3Qgc2NhbGFyID0gdi5kb3QodGhpcykgLyBkZW5vbWluYXRvcjsKICAgIHJldHVybiB0aGlzLmNvcHkodikubXVsdGlwbHlTY2FsYXIoc2NhbGFyKTsKICB9CiAgcHJvamVjdE9uUGxhbmUocGxhbmVOb3JtYWwpIHsKICAgIF92ZWN0b3IkMS5jb3B5KHRoaXMpLnByb2plY3RPblZlY3RvcihwbGFuZU5vcm1hbCk7CiAgICByZXR1cm4gdGhpcy5zdWIoX3ZlY3RvciQxKTsKICB9CiAgcmVmbGVjdChub3JtYWwpIHsKICAgIHJldHVybiB0aGlzLnN1YihfdmVjdG9yJDEuY29weShub3JtYWwpLm11bHRpcGx5U2NhbGFyKDIgKiB0aGlzLmRvdChub3JtYWwpKSk7CiAgfQogIGFuZ2xlVG8odikgewogICAgY29uc3QgZGVub21pbmF0b3IgPSBNYXRoLnNxcnQodGhpcy5sZW5ndGhTcSgpICogdi5sZW5ndGhTcSgpKTsKICAgIGlmIChkZW5vbWluYXRvciA9PT0gMCkKICAgICAgcmV0dXJuIE1hdGguUEkgLyAyOwogICAgY29uc3QgdGhldGEgPSB0aGlzLmRvdCh2KSAvIGRlbm9taW5hdG9yOwogICAgcmV0dXJuIE1hdGguYWNvcyhjbGFtcCQxKHRoZXRhLCAtMSwgMSkpOwogIH0KICBkaXN0YW5jZVRvKHYpIHsKICAgIHJldHVybiBNYXRoLnNxcnQodGhpcy5kaXN0YW5jZVRvU3F1YXJlZCh2KSk7CiAgfQogIGRpc3RhbmNlVG9TcXVhcmVkKHYpIHsKICAgIGNvbnN0IGR4ID0gdGhpcy54IC0gdi54LCBkeSA9IHRoaXMueSAtIHYueSwgZHogPSB0aGlzLnogLSB2Lno7CiAgICByZXR1cm4gZHggKiBkeCArIGR5ICogZHkgKyBkeiAqIGR6OwogIH0KICBtYW5oYXR0YW5EaXN0YW5jZVRvKHYpIHsKICAgIHJldHVybiBNYXRoLmFicyh0aGlzLnggLSB2LngpICsgTWF0aC5hYnModGhpcy55IC0gdi55KSArIE1hdGguYWJzKHRoaXMueiAtIHYueik7CiAgfQogIHNldEZyb21TcGhlcmljYWwocykgewogICAgcmV0dXJuIHRoaXMuc2V0RnJvbVNwaGVyaWNhbENvb3JkcyhzLnJhZGl1cywgcy5waGksIHMudGhldGEpOwogIH0KICBzZXRGcm9tU3BoZXJpY2FsQ29vcmRzKHJhZGl1cywgcGhpLCB0aGV0YSkgewogICAgY29uc3Qgc2luUGhpUmFkaXVzID0gTWF0aC5zaW4ocGhpKSAqIHJhZGl1czsKICAgIHRoaXMueCA9IHNpblBoaVJhZGl1cyAqIE1hdGguc2luKHRoZXRhKTsKICAgIHRoaXMueSA9IE1hdGguY29zKHBoaSkgKiByYWRpdXM7CiAgICB0aGlzLnogPSBzaW5QaGlSYWRpdXMgKiBNYXRoLmNvcyh0aGV0YSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0RnJvbUN5bGluZHJpY2FsKGMpIHsKICAgIHJldHVybiB0aGlzLnNldEZyb21DeWxpbmRyaWNhbENvb3JkcyhjLnJhZGl1cywgYy50aGV0YSwgYy55KTsKICB9CiAgc2V0RnJvbUN5bGluZHJpY2FsQ29vcmRzKHJhZGl1cywgdGhldGEsIHkpIHsKICAgIHRoaXMueCA9IHJhZGl1cyAqIE1hdGguc2luKHRoZXRhKTsKICAgIHRoaXMueSA9IHk7CiAgICB0aGlzLnogPSByYWRpdXMgKiBNYXRoLmNvcyh0aGV0YSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0RnJvbU1hdHJpeFBvc2l0aW9uKG0pIHsKICAgIGNvbnN0IGUgPSBtLmVsZW1lbnRzOwogICAgdGhpcy54ID0gZVsxMl07CiAgICB0aGlzLnkgPSBlWzEzXTsKICAgIHRoaXMueiA9IGVbMTRdOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldEZyb21NYXRyaXhTY2FsZShtKSB7CiAgICBjb25zdCBzeCA9IHRoaXMuc2V0RnJvbU1hdHJpeENvbHVtbihtLCAwKS5sZW5ndGgoKTsKICAgIGNvbnN0IHN5ID0gdGhpcy5zZXRGcm9tTWF0cml4Q29sdW1uKG0sIDEpLmxlbmd0aCgpOwogICAgY29uc3Qgc3ogPSB0aGlzLnNldEZyb21NYXRyaXhDb2x1bW4obSwgMikubGVuZ3RoKCk7CiAgICB0aGlzLnggPSBzeDsKICAgIHRoaXMueSA9IHN5OwogICAgdGhpcy56ID0gc3o7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0RnJvbU1hdHJpeENvbHVtbihtLCBpbmRleCkgewogICAgcmV0dXJuIHRoaXMuZnJvbUFycmF5KG0uZWxlbWVudHMsIGluZGV4ICogNCk7CiAgfQogIHNldEZyb21NYXRyaXgzQ29sdW1uKG0sIGluZGV4KSB7CiAgICByZXR1cm4gdGhpcy5mcm9tQXJyYXkobS5lbGVtZW50cywgaW5kZXggKiAzKTsKICB9CiAgc2V0RnJvbUV1bGVyKGUpIHsKICAgIHRoaXMueCA9IGUuX3g7CiAgICB0aGlzLnkgPSBlLl95OwogICAgdGhpcy56ID0gZS5fejsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRGcm9tQ29sb3IoYykgewogICAgdGhpcy54ID0gYy5yOwogICAgdGhpcy55ID0gYy5nOwogICAgdGhpcy56ID0gYy5iOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGVxdWFscyh2KSB7CiAgICByZXR1cm4gdi54ID09PSB0aGlzLnggJiYgdi55ID09PSB0aGlzLnkgJiYgdi56ID09PSB0aGlzLno7CiAgfQogIGZyb21BcnJheShhcnJheSwgb2Zmc2V0ID0gMCkgewogICAgdGhpcy54ID0gYXJyYXlbb2Zmc2V0XTsKICAgIHRoaXMueSA9IGFycmF5W29mZnNldCArIDFdOwogICAgdGhpcy56ID0gYXJyYXlbb2Zmc2V0ICsgMl07CiAgICByZXR1cm4gdGhpczsKICB9CiAgdG9BcnJheShhcnJheSA9IFtdLCBvZmZzZXQgPSAwKSB7CiAgICBhcnJheVtvZmZzZXRdID0gdGhpcy54OwogICAgYXJyYXlbb2Zmc2V0ICsgMV0gPSB0aGlzLnk7CiAgICBhcnJheVtvZmZzZXQgKyAyXSA9IHRoaXMuejsKICAgIHJldHVybiBhcnJheTsKICB9CiAgZnJvbUJ1ZmZlckF0dHJpYnV0ZShhdHRyaWJ1dGUsIGluZGV4KSB7CiAgICB0aGlzLnggPSBhdHRyaWJ1dGUuZ2V0WChpbmRleCk7CiAgICB0aGlzLnkgPSBhdHRyaWJ1dGUuZ2V0WShpbmRleCk7CiAgICB0aGlzLnogPSBhdHRyaWJ1dGUuZ2V0WihpbmRleCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmFuZG9tKCkgewogICAgdGhpcy54ID0gTWF0aC5yYW5kb20oKTsKICAgIHRoaXMueSA9IE1hdGgucmFuZG9tKCk7CiAgICB0aGlzLnogPSBNYXRoLnJhbmRvbSgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJhbmRvbURpcmVjdGlvbigpIHsKICAgIGNvbnN0IHUgPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAyOwogICAgY29uc3QgdCA9IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJICogMjsKICAgIGNvbnN0IGYgPSBNYXRoLnNxcnQoMSAtIHUgKiogMik7CiAgICB0aGlzLnggPSBmICogTWF0aC5jb3ModCk7CiAgICB0aGlzLnkgPSBmICogTWF0aC5zaW4odCk7CiAgICB0aGlzLnogPSB1OwogICAgcmV0dXJuIHRoaXM7CiAgfQogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHlpZWxkIHRoaXMueDsKICAgIHlpZWxkIHRoaXMueTsKICAgIHlpZWxkIHRoaXMuejsKICB9Cn0KY29uc3QgX3ZlY3RvciQxID0gLyogQF9fUFVSRV9fICovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF9xdWF0ZXJuaW9uID0gLyogQF9fUFVSRV9fICovIG5ldyBRdWF0ZXJuaW9uKCk7CmZ1bmN0aW9uIGRlZmluZWQkMih2YWx1ZSkgewogIHJldHVybiB2YWx1ZSAhPT0gdm9pZCAwICYmIHZhbHVlICE9PSBudWxsOwp9CmZ1bmN0aW9uIGRlZmluZWQkMSh2YWx1ZSkgewogIHJldHVybiB2YWx1ZSAhPT0gdm9pZCAwICYmIHZhbHVlICE9PSBudWxsOwp9CmZ1bmN0aW9uIGRlZmF1bHRWYWx1ZShhLCBiKSB7CiAgaWYgKGEgIT09IHZvaWQgMCAmJiBhICE9PSBudWxsKSB7CiAgICByZXR1cm4gYTsKICB9CiAgcmV0dXJuIGI7Cn0KZGVmYXVsdFZhbHVlLkVNUFRZX09CSkVDVCA9IE9iamVjdC5mcmVlemUoe30pOwpmdW5jdGlvbiBEZXZlbG9wZXJFcnJvcihtZXNzYWdlKSB7CiAgdGhpcy5uYW1lID0gIkRldmVsb3BlckVycm9yIjsKICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlOwogIGxldCBzdGFjazsKICB0cnkgewogICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgfSBjYXRjaCAoZSkgewogICAgc3RhY2sgPSBlLnN0YWNrOwogIH0KICB0aGlzLnN0YWNrID0gc3RhY2s7Cn0KaWYgKGRlZmluZWQkMShPYmplY3QuY3JlYXRlKSkgewogIERldmVsb3BlckVycm9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoRXJyb3IucHJvdG90eXBlKTsKICBEZXZlbG9wZXJFcnJvci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBEZXZlbG9wZXJFcnJvcjsKfQpEZXZlbG9wZXJFcnJvci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICBsZXQgc3RyID0gdGhpcy5uYW1lICsgIjogIiArIHRoaXMubWVzc2FnZTsKICBpZiAoZGVmaW5lZCQxKHRoaXMuc3RhY2spKSB7CiAgICBzdHIgKz0gIlxuIiArIHRoaXMuc3RhY2sudG9TdHJpbmcoKTsKICB9CiAgcmV0dXJuIHN0cjsKfTsKRGV2ZWxvcGVyRXJyb3IudGhyb3dJbnN0YW50aWF0aW9uRXJyb3IgPSBmdW5jdGlvbigpIHsKICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoCiAgICAiVGhpcyBmdW5jdGlvbiBkZWZpbmVzIGFuIGludGVyZmFjZSBhbmQgc2hvdWxkIG5vdCBiZSBjYWxsZWQgZGlyZWN0bHkuIgogICk7Cn07CmNvbnN0IF9DZXNpdW1NYXRoID0gY2xhc3MgewogIHN0YXRpYyBlcXVhbHNFcHNpbG9uKGxlZnQsIHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgcmVsYXRpdmVFcHNpbG9uID0gZGVmYXVsdFZhbHVlKHJlbGF0aXZlRXBzaWxvbiwgMCk7CiAgICBhYnNvbHV0ZUVwc2lsb24gPSBkZWZhdWx0VmFsdWUoYWJzb2x1dGVFcHNpbG9uLCByZWxhdGl2ZUVwc2lsb24pOwogICAgY29uc3QgYWJzRGlmZiA9IE1hdGguYWJzKGxlZnQgLSByaWdodCk7CiAgICByZXR1cm4gYWJzRGlmZiA8PSBhYnNvbHV0ZUVwc2lsb24gfHwgYWJzRGlmZiA8PSByZWxhdGl2ZUVwc2lsb24gKiBNYXRoLm1heChNYXRoLmFicyhsZWZ0KSwgTWF0aC5hYnMocmlnaHQpKTsKICB9CiAgc3RhdGljIHRvUmFkaWFucyhkZWcpIHsKICAgIHJldHVybiBNYXRoVXRpbHMuZGVnVG9SYWQoZGVnKTsKICB9CiAgc3RhdGljIGNsYW1wKHZhbHVlLCBtaW4sIG1heCkgewogICAgcmV0dXJuIHZhbHVlIDwgbWluID8gbWluIDogdmFsdWUgPiBtYXggPyBtYXggOiB2YWx1ZTsKICB9CiAgc3RhdGljIGFjb3NDbGFtcGVkKHZhbHVlKSB7CiAgICByZXR1cm4gTWF0aC5hY29zKF9DZXNpdW1NYXRoLmNsYW1wKHZhbHVlLCAtMSwgMSkpOwogIH0KICBzdGF0aWMgYXNpbkNsYW1wZWQodmFsdWUpIHsKICAgIHJldHVybiBNYXRoLmFzaW4oX0Nlc2l1bU1hdGguY2xhbXAodmFsdWUsIC0xLCAxKSk7CiAgfQogIHN0YXRpYyBzaWduKHZhbHVlKSB7CiAgICByZXR1cm4gTWF0aC5zaWduKHZhbHVlKTsKICB9CiAgc3RhdGljIHplcm9Ub1R3b1BpKGFuZ2xlKSB7CiAgICBpZiAoYW5nbGUgPj0gMCAmJiBhbmdsZSA8PSBfQ2VzaXVtTWF0aC5UV09fUEkpIHsKICAgICAgcmV0dXJuIGFuZ2xlOwogICAgfQogICAgY29uc3QgbW9kID0gX0Nlc2l1bU1hdGgubW9kKGFuZ2xlLCBfQ2VzaXVtTWF0aC5UV09fUEkpOwogICAgaWYgKE1hdGguYWJzKG1vZCkgPCBfQ2VzaXVtTWF0aC5FUFNJTE9OMTQgJiYgTWF0aC5hYnMoYW5nbGUpID4gX0Nlc2l1bU1hdGguRVBTSUxPTjE0KSB7CiAgICAgIHJldHVybiBfQ2VzaXVtTWF0aC5UV09fUEk7CiAgICB9CiAgICByZXR1cm4gbW9kOwogIH0KICBzdGF0aWMgbW9kKG0sIG4pIHsKICAgIGlmIChfQ2VzaXVtTWF0aC5zaWduKG0pID09PSBfQ2VzaXVtTWF0aC5zaWduKG4pICYmIE1hdGguYWJzKG0pIDwgTWF0aC5hYnMobikpIHsKICAgICAgcmV0dXJuIG07CiAgICB9CiAgICByZXR1cm4gKG0gJSBuICsgbikgJSBuOwogIH0KICBzdGF0aWMgY2hvcmRMZW5ndGgoYW5nbGUsIHJhZGl1cykgewogICAgcmV0dXJuIDIgKiByYWRpdXMgKiBNYXRoLnNpbihhbmdsZSAqIDAuNSk7CiAgfQogIHN0YXRpYyBuZWdhdGl2ZVBpVG9QaShhbmdsZSkgewogICAgaWYgKCFkZWZpbmVkJDEoYW5nbGUpKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigiYW5nbGUgaXMgcmVxdWlyZWQuIik7CiAgICB9CiAgICBpZiAoYW5nbGUgPj0gLV9DZXNpdW1NYXRoLlBJICYmIGFuZ2xlIDw9IF9DZXNpdW1NYXRoLlBJKSB7CiAgICAgIHJldHVybiBhbmdsZTsKICAgIH0KICAgIHJldHVybiBfQ2VzaXVtTWF0aC56ZXJvVG9Ud29QaShhbmdsZSArIF9DZXNpdW1NYXRoLlBJKSAtIF9DZXNpdW1NYXRoLlBJOwogIH0KICBzdGF0aWMgbm9ybWFsaXplKHZhbHVlLCByYW5nZU1pbmltdW0sIHJhbmdlTWF4aW11bSkgewogICAgcmFuZ2VNYXhpbXVtID0gTWF0aC5tYXgocmFuZ2VNYXhpbXVtIC0gcmFuZ2VNaW5pbXVtLCAwKTsKICAgIHJldHVybiByYW5nZU1heGltdW0gPT09IDAgPyAwIDogX0Nlc2l1bU1hdGguY2xhbXAoKHZhbHVlIC0gcmFuZ2VNaW5pbXVtKSAvIHJhbmdlTWF4aW11bSwgMCwgMSk7CiAgfQp9OwpsZXQgQ2VzaXVtTWF0aCA9IF9DZXNpdW1NYXRoOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJFUFNJTE9OMSIsIDAuMSk7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIkVQU0lMT04yIiwgMC4wMSk7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIkVQU0lMT04zIiwgMWUtMyk7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIkVQU0lMT040IiwgMWUtNCk7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIkVQU0lMT041IiwgMWUtNSk7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIkVQU0lMT042IiwgMWUtNik7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIkVQU0lMT043IiwgMWUtNyk7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIkVQU0lMT044IiwgMWUtOCk7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIkVQU0lMT045IiwgMWUtOSk7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIkVQU0lMT04xMCIsIDFlLTEwKTsKX19wdWJsaWNGaWVsZChDZXNpdW1NYXRoLCAiRVBTSUxPTjExIiwgMWUtMTEpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJFUFNJTE9OMTIiLCAxZS0xMik7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIkVQU0lMT04xMyIsIDFlLTEzKTsKX19wdWJsaWNGaWVsZChDZXNpdW1NYXRoLCAiRVBTSUxPTjE0IiwgMWUtMTQpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJFUFNJTE9OMTUiLCAxZS0xNSk7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIkVQU0lMT04xNiIsIDFlLTE2KTsKX19wdWJsaWNGaWVsZChDZXNpdW1NYXRoLCAiRVBTSUxPTjE3IiwgMWUtMTcpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJFUFNJTE9OMTgiLCAxZS0xOCk7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIkVQU0lMT04xOSIsIDFlLTE5KTsKX19wdWJsaWNGaWVsZChDZXNpdW1NYXRoLCAiRVBTSUxPTjIwIiwgMWUtMjApOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJFUFNJTE9OMjEiLCAxZS0yMSk7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIlBJIiwgTWF0aC5QSSk7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIk9ORV9PVkVSX1BJIiwgMSAvIE1hdGguUEkpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJQSV9PVkVSX1RXTyIsIE1hdGguUEkgLyAyKTsKX19wdWJsaWNGaWVsZChDZXNpdW1NYXRoLCAiUElfT1ZFUl9USFJFRSIsIE1hdGguUEkgLyAzKTsKX19wdWJsaWNGaWVsZChDZXNpdW1NYXRoLCAiUElfT1ZFUl9GT1VSIiwgTWF0aC5QSSAvIDQpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJQSV9PVkVSX1NJWCIsIE1hdGguUEkgLyA2KTsKX19wdWJsaWNGaWVsZChDZXNpdW1NYXRoLCAiVEhSRUVfUElfT1ZFUl9UV08iLCAzICogTWF0aC5QSSAvIDIpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJUV09fUEkiLCAyICogTWF0aC5QSSk7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIk9ORV9PVkVSX1RXT19QSSIsIDEgLyAoMiAqIE1hdGguUEkpKTsKX19wdWJsaWNGaWVsZChDZXNpdW1NYXRoLCAiUkFESUFOU19QRVJfREVHUkVFIiwgTWF0aC5QSSAvIDE4MCk7CmZ1bmN0aW9uIGlzQ2xvc2VkKGxpbmVzdHJpbmcpIHsKICBjb25zdCBmaXJzdCA9IGxpbmVzdHJpbmdbMF07CiAgY29uc3QgbGFzdCA9IGxpbmVzdHJpbmdbbGluZXN0cmluZy5sZW5ndGggLSAxXTsKICByZXR1cm4gaXNQb2ludEVxdWFsKGZpcnN0LCBsYXN0KTsKfQpmdW5jdGlvbiBpc1BvaW50RXF1YWwocDEsIHAyLCB0aHJlc2hvbGQgPSAxZS02KSB7CiAgY29uc3QgZGlzdGFuY2UgPSBnZXREaXN0YW5jZShwMSwgcDIpOwogIHJldHVybiBkaXN0YW5jZSA8IHRocmVzaG9sZDsKfQpmdW5jdGlvbiBnZXREaXN0YW5jZShwMSwgcDIpIHsKICByZXR1cm4gTWF0aC5zcXJ0KAogICAgTWF0aC5wb3cocDFbMF0gLSBwMlswXSwgMikgKyBNYXRoLnBvdyhwMVsxXSAtIHAyWzFdLCAyKSArIE1hdGgucG93KChwMVsyXSB8fCAwKSAtIChwMlsyXSB8fCAwKSwgMikKICApOwp9Cm5ldyBWZWN0b3IzKCk7Cm5ldyBWZWN0b3IzKCk7Cm5ldyBWZWN0b3IzKCk7Cm5ldyBWZWN0b3IzKCk7Cm5ldyBWZWN0b3IzKCk7Cm5ldyBWZWN0b3IzKCk7Cm5ldyBWZWN0b3IzKCk7Cm5ldyBWZWN0b3IzKCk7Cm5ldyBWZWN0b3IzKCk7Cm5ldyBWZWN0b3IzKCk7CmZ1bmN0aW9uIGlzQU9Db25jYXZlQW5nbGUocDIsIHAxLCBwMykgewogIGNvbnN0IGEgPSBbcDNbMF0gLSBwMVswXSwgcDNbMV0gLSBwMVsxXV07CiAgY29uc3QgYiA9IFtwMlswXSAtIHAxWzBdLCBwMlsxXSAtIHAxWzFdXTsKICBjb25zdCBhYiA9IGFbMF0gKiBiWzBdICsgYVsxXSAqIGJbMV07CiAgY29uc3QgY29zQUIgPSBhYiAvIE1hdGguc3FydCgoYVswXSAqIGFbMF0gKyBhWzFdICogYVsxXSkgKiAoYlswXSAqIGJbMF0gKyBiWzFdICogYlsxXSkpOwogIGNvbnN0IGRvdFByb2R1Y3RXaXRoTm9ybWFsID0gLWFbMV0gKiBiWzBdICsgYVswXSAqIGJbMV07CiAgcmV0dXJuIGNvc0FCID4gLTAuODY2ICYmIGRvdFByb2R1Y3RXaXRoTm9ybWFsIDwgMDsKfQpjb25zdCBfY2VudGVySW4gPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IF9sYXN0UG9zaXRpb24gPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IF9jdXJyZW50UG9zaXRpb24gPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IF9saW5lTm9ybWFsID0gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBfb2Zmc2V0ID0gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBfc2VnbWVudExpbmVzM0QgPSAocG9zaXRpb25zLCB3aWR0aHMsIG5vcm1hbHMsIGluZGljZXMsIGxlbmd0aHMsIHV2cywgbGFzdCwgY3VyLCB3aWR0aCwgaW5kZXgsIGlzRmlyc3RQb2ludCwgZGlzdGFuY2UsIHRpbGVDb25maWcsIHNjYWxlKSA9PiB7CiAgY29uc3QgY2VudGVyID0gdGlsZUNvbmZpZy50YXJnZXRDZW50ZXI7CiAgY29uc3QgcHJvamVjdGlvbiA9IHRpbGVDb25maWcudGFyZ2V0UHJvamVjdGlvbjsKICBjb25zdCB7IHNvdXJjZVByb2plY3Rpb25OYW1lLCB0YXJnZXRQcm9qZWN0aW9uTmFtZSB9ID0gdGlsZUNvbmZpZzsKICBsZXQgY291bnQgPSAwOwogIF9jZW50ZXJJbi5mcm9tQXJyYXkoY2VudGVyKTsKICBfbGFzdFBvc2l0aW9uLmZyb21BcnJheShsYXN0KTsKICBfY3VycmVudFBvc2l0aW9uLmZyb21BcnJheShjdXIpOwogIGxldCBsZW5ndGggPSBkaXN0YW5jZS52YWx1ZTsKICBsZW5ndGhzLnB1c2gobGVuZ3RoLCBsZW5ndGgpOwogIHV2cy5wdXNoKAogICAgbGVuZ3RoLAogICAgMSwKICAgIGxlbmd0aCwKICAgIDAKICApOwogIGNvbnN0IHN1cmZhY2VOb3JtYWwgPSBwcm9qZWN0aW9uLmdldFByb2plY3RlZFN1cmZhY2VOb3JtYWwoX2xhc3RQb3NpdGlvbiwgX2xpbmVOb3JtYWwpOwogIGNvbnN0IG9mZnNldCA9IF9vZmZzZXQuY29weShfY3VycmVudFBvc2l0aW9uKS5zdWIoX2xhc3RQb3NpdGlvbik7CiAgY29uc3Qgbm9ybWFsID0gX2xpbmVOb3JtYWwuY3Jvc3NWZWN0b3JzKHN1cmZhY2VOb3JtYWwsIG9mZnNldCkubm9ybWFsaXplKCk7CiAgaWYgKHNvdXJjZVByb2plY3Rpb25OYW1lICE9PSB0YXJnZXRQcm9qZWN0aW9uTmFtZSkgewogICAgX2xhc3RQb3NpdGlvbi5zdWIoX2NlbnRlckluKTsKICAgIF9jdXJyZW50UG9zaXRpb24uc3ViKF9jZW50ZXJJbik7CiAgfQogIG5vcm1hbHMucHVzaChub3JtYWwueCwgbm9ybWFsLnksIG5vcm1hbC56LCAtbm9ybWFsLngsIC1ub3JtYWwueSwgLW5vcm1hbC56KTsKICBwb3NpdGlvbnMucHVzaCgKICAgIF9sYXN0UG9zaXRpb24ueCwKICAgIF9sYXN0UG9zaXRpb24ueSwKICAgIF9sYXN0UG9zaXRpb24ueiwKICAgIF9sYXN0UG9zaXRpb24ueCwKICAgIF9sYXN0UG9zaXRpb24ueSwKICAgIF9sYXN0UG9zaXRpb24uegogICk7CiAgd2lkdGhzLnB1c2god2lkdGgsIHdpZHRoKTsKICBjb3VudCArPSAyOwogIGlmICghaXNGaXJzdFBvaW50KSB7CiAgICBpbmRpY2VzLnB1c2goaW5kZXggKyAwIC0gMiwgaW5kZXggKyAxIC0gMiwgaW5kZXggKyAyIC0gMik7CiAgICBpbmRpY2VzLnB1c2goaW5kZXggKyAyIC0gMiwgaW5kZXggKyAxIC0gMiwgaW5kZXggKyAzIC0gMik7CiAgfQogIGluZGljZXMucHVzaChpbmRleCwgaW5kZXggKyAxLCBpbmRleCArIDIpOwogIG5vcm1hbHMucHVzaChub3JtYWwueCwgbm9ybWFsLnksIG5vcm1hbC56LCAtbm9ybWFsLngsIC1ub3JtYWwueSwgLW5vcm1hbC56KTsKICBwb3NpdGlvbnMucHVzaCgKICAgIF9jdXJyZW50UG9zaXRpb24ueCwKICAgIF9jdXJyZW50UG9zaXRpb24ueSwKICAgIF9jdXJyZW50UG9zaXRpb24ueiwKICAgIF9jdXJyZW50UG9zaXRpb24ueCwKICAgIF9jdXJyZW50UG9zaXRpb24ueSwKICAgIF9jdXJyZW50UG9zaXRpb24uegogICk7CiAgd2lkdGhzLnB1c2god2lkdGgsIHdpZHRoKTsKICBsZW5ndGggKz0gZ2V0RGlzdGFuY2UobGFzdCwgY3VyKSAvIHNjYWxlOwogIGxlbmd0aHMucHVzaChsZW5ndGgsIGxlbmd0aCk7CiAgdXZzLnB1c2goCiAgICBsZW5ndGgsCiAgICAxLAogICAgbGVuZ3RoLAogICAgMAogICk7CiAgZGlzdGFuY2UudmFsdWUgPSBsZW5ndGg7CiAgY291bnQgKz0gMjsKICBpbmRpY2VzLnB1c2goaW5kZXggKyAyLCBpbmRleCArIDEsIGluZGV4ICsgMyk7CiAgcmV0dXJuIGNvdW50Owp9OwpmdW5jdGlvbiBsaW5lVG9NZXNoKHBvaW50cywgd2lkdGgsIHRpbGVDb25maWcsIGlzU2luZ2xlLCBzY2FsZSA9IDEpIHsKICBsZXQgaW5kZXggPSAwOwogIGxldCBsYXN0ID0gbnVsbDsKICBsZXQgY3VyID0gbnVsbDsKICBsZXQgbmV4dCA9IG51bGw7CiAgbGV0IGNhY2hlTGFzdCA9IG51bGw7CiAgY29uc3QgdmVydGljZXMgPSBbXTsKICBjb25zdCBub3JtYWxzID0gW107CiAgY29uc3QgaW5kaWNlcyA9IFtdOwogIGNvbnN0IHdpZHRocyA9IFtdOwogIGNvbnN0IGxlbmd0aHMgPSBbXTsKICBjb25zdCB1dnMgPSBbXTsKICBsZXQgdG90YWxMZW5ndGhzOwogIGNvbnN0IGRpc3RhbmNlID0geyB2YWx1ZTogMCB9OwogIGxldCBpc0ZpcnN0UG9pbnQgPSB0cnVlOwogIGZvciAobGV0IGogPSAxLCBsYXN0SW5kZXggPSBwb2ludHMubGVuZ3RoIC0gMTsgaiA8PSBsYXN0SW5kZXg7IGorKykgewogICAgbGFzdCA9IGNhY2hlTGFzdCB8fCBwb2ludHNbaiAtIDFdOwogICAgY3VyID0gcG9pbnRzW2pdOwogICAgbmV4dCA9IHBvaW50c1tqICsgMV07CiAgICBpZiAobmV4dCAmJiBpc1BvaW50RXF1YWwoY3VyLCBuZXh0KSkgewogICAgICBjYWNoZUxhc3QgPSBsYXN0OwogICAgICBjb250aW51ZTsKICAgIH0KICAgIGxldCBhbW91bnQgPSAwOwogICAgYW1vdW50ID0gX3NlZ21lbnRMaW5lczNEKAogICAgICB2ZXJ0aWNlcywKICAgICAgd2lkdGhzLAogICAgICBub3JtYWxzLAogICAgICBpbmRpY2VzLAogICAgICBsZW5ndGhzLAogICAgICB1dnMsCiAgICAgIGxhc3QsCiAgICAgIGN1ciwKICAgICAgd2lkdGgsCiAgICAgIGluZGV4LAogICAgICBpc0ZpcnN0UG9pbnQsCiAgICAgIGRpc3RhbmNlLAogICAgICB0aWxlQ29uZmlnLAogICAgICBzY2FsZQogICAgKTsKICAgIGlmIChhbW91bnQgIT09IC0xKSB7CiAgICAgIGluZGV4ICs9IGFtb3VudDsKICAgICAgY2FjaGVMYXN0ID0gbnVsbDsKICAgIH0KICAgIGlzRmlyc3RQb2ludCA9IGZhbHNlOwogIH0KICBpZiAoaXNTaW5nbGUpIHsKICAgIHRvdGFsTGVuZ3RocyA9IG5ldyBBcnJheShsZW5ndGhzLmxlbmd0aCkuZmlsbChkaXN0YW5jZS52YWx1ZSk7CiAgfQogIHJldHVybiB7CiAgICB2ZXJ0aWNlcywKICAgIGluZGljZXMsCiAgICBub3JtYWxzLAogICAgd2lkdGhzLAogICAgbGVuZ3RocywKICAgIHRvdGFsTGVuZ3RocywKICAgIHV2cwogIH07Cn0KZnVuY3Rpb24gZmlsbEZsYXRBcnJheShsZW5ndGgsIHZhbHVlQXJyLCBpdGVtU2l6ZSkgewogIGlmICghaXRlbVNpemUpIHsKICAgIGl0ZW1TaXplID0gdmFsdWVBcnIubGVuZ3RoOwogIH0KICBjb25zdCBhcnJheUxlbmd0aCA9IGl0ZW1TaXplICogbGVuZ3RoOwogIGNvbnN0IGFycmF5ID0gbmV3IEFycmF5KGFycmF5TGVuZ3RoKTsKICBmb3IgKGxldCBpID0gMCwgbGFzdCA9IGFycmF5TGVuZ3RoIC0gaXRlbVNpemUgKyAxOyBpIDwgbGFzdDsgaSArPSBpdGVtU2l6ZSkgewogICAgZm9yIChsZXQgaiA9IDA7IGogPCBpdGVtU2l6ZTsgaisrKSB7CiAgICAgIGFycmF5W2kgKyBqXSA9IHZhbHVlQXJyW2pdOwogICAgfQogIH0KICByZXR1cm4gYXJyYXk7Cn0KZnVuY3Rpb24gcmVGZXRjaCh1cmwgPSAiIiwgZmV0Y2hPcHRpb25zLCB0aW1lcyA9IDMpIHsKICBmdW5jdGlvbiBhdXRvUmV0cnkodXJsMiwgZmV0Y2hPcHRpb25zMikgewogICAgdGltZXMtLTsKICAgIHJldHVybiBmZXRjaCh1cmwyLCBmZXRjaE9wdGlvbnMyKS50aGVuKCh2YWx1ZSkgPT4gewogICAgICBpZiAodmFsdWUuc3RhdHVzID09PSAyMDApIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgIH0pLmNhdGNoKChlcnIpID0+IHsKICAgICAgaWYgKHRpbWVzID4gMCkgewogICAgICAgIHJldHVybiBhdXRvUmV0cnkodXJsMiwgZmV0Y2hPcHRpb25zMik7CiAgICAgIH0KICAgIH0pOwogIH0KICByZXR1cm4gYXV0b1JldHJ5KHVybCwgZmV0Y2hPcHRpb25zKTsKfQpsZXQgUE9JX1RZUEUkMSA9IDM7CmxldCBMSU5LX1RZUEUkMSA9IDQ7CmxldCBQT0xZX1RZUEUkMSA9IDc7CmxldCBIUkVHSU9OX1RZUEUkMSA9IDg7CmxldCBHQU9RSU5HX1JPQURfVFlQRSQxID0gMTU7CmxldCBHQU9RSU5HX0xJTkVfVFlQRSQxID0gMTY7CmxldCBHQU9RSU5HX0FSUk9XX1RZUEUkMSA9IDE4OwpsZXQgVEVYVFVSRV9UWVBFJDEgPSAxOTsKbGV0IEdBT1FJTkdfR1JBRElFTlRfVFlQRSQxID0gMjA7CmxldCBQSUxMQVJfVFlQRSA9IDI0OwpsZXQgQlVJTERJTkdfTUVTSF9UWVBFID0gMjU7CmxldCBkZWNvZGVCbG9ja1VuaXQgPSBmdW5jdGlvbigpIHsKICBsZXQgdGV4dERlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoInV0Zi04Iik7CiAgbGV0IHVpbnQzMjsKICBsZXQgaW50MzI7CiAgbGV0IGRhdGFWZXJzaW9uID0gMTsKICBmdW5jdGlvbiBkZWNvZGVCbG9ja1VuaXQyKGJ1ZmZlcikgewogICAgbGV0IHJlc3VsdCA9IHt9OwogICAgdWludDMyID0gbmV3IFVpbnQzMkFycmF5KGJ1ZmZlcik7CiAgICBpbnQzMiA9IG5ldyBJbnQzMkFycmF5KGJ1ZmZlcik7CiAgICBkYXRhVmVyc2lvbiA9IHVpbnQzMlswXTsKICAgIHJlc3VsdC52ZXJzaW9uID0gdWludDMyWzBdOwogICAgbGV0IG1ldGFDb3VudCA9IHVpbnQzMlsxXTsKICAgIHJlc3VsdC5oZWlnaHQgPSB1aW50MzJbMl07CiAgICByZXN1bHQuaW5kb29yaGVpZ2h0ID0gdWludDMyWzNdOwogICAgbGV0IGRhdGEgPSBkZWNvZGVCaW5hcnlBcnJheShidWZmZXIsIG1ldGFDb3VudCArIDEgKyAxLCAwLCBidWZmZXIuYnl0ZUxlbmd0aCk7CiAgICByZXN1bHQuZ2VvbGF5ZXIgPSBkZWNvZGVHZW9MYXllcihidWZmZXIsIGRhdGFbMF0pOwogICAgcmVzdWx0LmluZG9vckJ1aWxkaW5ncyA9IGRlY29kZUluZG9vckJ1aWxkaW5nQXJyYXkoYnVmZmVyLCBkYXRhWzFdKTsKICAgIHJlc3VsdC5sYWJlbHAgPSBkZWNvZGVSb2FkVGV4dEFycmF5KGJ1ZmZlciwgZGF0YVsyXSk7CiAgICBpZiAoZGF0YVszXVsxXSkgewogICAgICByZXN1bHQucG5nID0gdGV4dERlY29kZXIuZGVjb2RlKG5ldyBVaW50OEFycmF5KGJ1ZmZlciwgZGF0YVszXVswXSwgZGF0YVszXVsxXSkpOwogICAgfQogICAgaWYgKGRhdGFbNF1bMV0pIHsKICAgICAgcmVzdWx0LmluZG9vcnBuZyA9IHRleHREZWNvZGVyLmRlY29kZShuZXcgVWludDhBcnJheShidWZmZXIsIGRhdGFbNF1bMF0sIGRhdGFbNF1bMV0pKTsKICAgIH0KICAgIHVpbnQzMiA9IG51bGw7CiAgICBpbnQzMiA9IG51bGw7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBkZWNvZGVJbmRvb3JCdWlsZGluZ0FycmF5KGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICBsZXQgYnVpbGRpbmdzID0gW107CiAgICBsZXQgYXJyID0gZGVjb2RlQmluYXJ5QXJyYXkoYnVmZmVyLCAwLCBvZmZzZXRbMF0sIG9mZnNldFswXSArIG9mZnNldFsxXSk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewogICAgICBidWlsZGluZ3NbaV0gPSBkZWNvZGVJbmRvb3JCdWlsZGluZyhidWZmZXIsIGFycltpXSk7CiAgICB9CiAgICByZXR1cm4gYnVpbGRpbmdzOwogIH0KICBmdW5jdGlvbiBkZWNvZGVJbmRvb3JCdWlsZGluZyhidWZmZXIsIG9mZnNldCkgewogICAgbGV0IGJ1aWxkaW5nID0ge307CiAgICBsZXQgYXJyID0gZGVjb2RlQmluYXJ5QXJyYXkoYnVmZmVyLCAwLCBvZmZzZXRbMF0sIG9mZnNldFswXSArIG9mZnNldFsxXSk7CiAgICBidWlsZGluZy5pbmRvb3JGbG9vcnMgPSBkZWNvZGVJbmRvb3JGbG9vckFycmF5KGJ1ZmZlciwgYXJyWzBdKTsKICAgIGJ1aWxkaW5nLmluZG9vckRlcyA9IGRlY29kZUluZG9vckZsb29yRGVzKGJ1ZmZlciwgYXJyWzFdKTsKICAgIHJldHVybiBidWlsZGluZzsKICB9CiAgZnVuY3Rpb24gZGVjb2RlSW5kb29yRmxvb3JEZXMoYnVmZmVyLCBvZmZzZXQpIHsKICAgIGxldCBvZmZzZXQzMiA9IG9mZnNldFswXSAvIDQ7CiAgICBsZXQgbWV0YUNvdW50ID0gdWludDMyW29mZnNldDMyXTsKICAgIGxldCBkZXMgPSB7CiAgICAgIGdsYXNzU3R5bGVpZDogdWludDMyW29mZnNldDMyICsgMV0sCiAgICAgIHR3aW5rbGVOb3JtOiB1aW50MzJbb2Zmc2V0MzIgKyAyXSwKICAgICAgc2VsZWN0ZWRGbG9vclN0eWxlaWQ6IHVpbnQzMltvZmZzZXQzMiArIDNdCiAgICB9OwogICAgbGV0IGFyciA9IGRlY29kZUJpbmFyeUFycmF5KGJ1ZmZlciwgbWV0YUNvdW50ICsgMSwgb2Zmc2V0WzBdLCBvZmZzZXRbMF0gKyBvZmZzZXRbMV0pOwogICAgZGVzLmluZG9vckJpZCA9IFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoU3RyaW5nLCBuZXcgVWludDhBcnJheShidWZmZXIsIGFyclswXVswXSwgYXJyWzBdWzFdKSk7CiAgICBkZXMuaW5kb29yRGVmYXVsdGZsciA9IFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoU3RyaW5nLCBuZXcgVWludDhBcnJheShidWZmZXIsIGFyclsxXVswXSwgYXJyWzFdWzFdKSk7CiAgICBsZXQgYm91bmRhcnlBcnIgPSBkZWNvZGVCaW5hcnlBcnJheShidWZmZXIsIDAsIGFyclsyXVswXSwgYXJyWzJdWzBdICsgYXJyWzJdWzFdKTsKICAgIGRlcy5pbmRvb3JCb3VuZGFyeSA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBib3VuZGFyeUFyci5sZW5ndGg7IGkrKykgewogICAgICBkZXMuaW5kb29yQm91bmRhcnlbaV0gPSBkZWNvZGVHZW9PYmplY3QoYnVmZmVyLCBib3VuZGFyeUFycltpXSwgUE9MWV9UWVBFJDEpOwogICAgfQogICAgbGV0IGZsb29yc0FyciA9IGRlY29kZUJpbmFyeUFycmF5KGJ1ZmZlciwgMCwgYXJyWzNdWzBdLCBhcnJbM11bMF0gKyBhcnJbM11bMV0pOwogICAgZGVzLmluZG9vckZsb29ycyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmbG9vcnNBcnIubGVuZ3RoOyBpKyspIHsKICAgICAgZGVzLmluZG9vckZsb29yc1tpXSA9IFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoU3RyaW5nLCBuZXcgVWludDhBcnJheShidWZmZXIsIGZsb29yc0FycltpXVswXSwgZmxvb3JzQXJyW2ldWzFdKSk7CiAgICB9CiAgICBkZXMubXBvaU5hbWUgPSB0ZXh0RGVjb2Rlci5kZWNvZGUobmV3IFVpbnQ4QXJyYXkoYnVmZmVyLCBhcnJbNF1bMF0sIGFycls0XVsxXSkpOwogICAgZGVzLm1wb2kgPSBuZXcgVWludDMyQXJyYXkoYnVmZmVyLCBhcnJbNV1bMF0sIGFycls1XVsxXSAvIDQpOwogICAgbGV0IGJvdW5kYXJ5VXBBcnIgPSBkZWNvZGVCaW5hcnlBcnJheShidWZmZXIsIDAsIGFycls2XVswXSwgYXJyWzZdWzFdKTsKICAgIGRlcy5pbmRvb3JCb3VuZGFyeVVwID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJvdW5kYXJ5VXBBcnIubGVuZ3RoOyBpKyspIHsKICAgICAgZGVzLmluZG9vckJvdW5kYXJ5VXBbaV0gPSBkZWNvZGVHZW9PYmplY3QoYnVmZmVyLCBib3VuZGFyeVVwQXJyW2ldLCBQT0xZX1RZUEUkMSk7CiAgICB9CiAgICBkZXMuaW5kb29yRWFjaGZsb29ySGVpZ2h0ID0gbmV3IEludDMyQXJyYXkoYnVmZmVyLCBhcnJbN11bMF0sIGFycls3XVsxXSAvIDQpOwogICAgcmV0dXJuIGRlczsKICB9CiAgZnVuY3Rpb24gZGVjb2RlSW5kb29yRmxvb3JBcnJheShidWZmZXIsIG9mZnNldCkgewogICAgbGV0IGZsb29ycyA9IFtdOwogICAgbGV0IGFyciA9IGRlY29kZUJpbmFyeUFycmF5KGJ1ZmZlciwgMCwgb2Zmc2V0WzBdLCBvZmZzZXRbMF0gKyBvZmZzZXRbMV0pOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgZmxvb3JzW2ldID0gZGVjb2RlSW5kb29yRmxvb3IoYnVmZmVyLCBhcnJbaV0pOwogICAgfQogICAgcmV0dXJuIGZsb29yczsKICB9CiAgZnVuY3Rpb24gZGVjb2RlSW5kb29yRmxvb3IoYnVmZmVyLCBvZmZzZXQpIHsKICAgIGxldCBvZmZzZXQzMiA9IG9mZnNldFswXSAvIDQ7CiAgICBsZXQgbWV0YUNvdW50ID0gdWludDMyW29mZnNldDMyXTsKICAgIGxldCBmbG9vciA9IHsKICAgICAgY3VycmVudEZsb29ySWR4OiBpbnQzMltvZmZzZXQzMiArIDFdCiAgICB9OwogICAgbGV0IGFyciA9IGRlY29kZUJpbmFyeUFycmF5KGJ1ZmZlciwgbWV0YUNvdW50ICsgMSwgb2Zmc2V0WzBdLCBvZmZzZXRbMF0gKyBvZmZzZXRbMV0pOwogICAgZmxvb3IuY3VycmVudEZsb29yID0gU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShTdHJpbmcsIG5ldyBVaW50OEFycmF5KGJ1ZmZlciwgYXJyWzBdWzBdLCBhcnJbMF1bMV0pKTsKICAgIGZsb29yLmdlb2xheWVyID0gZGVjb2RlR2VvTGF5ZXIoYnVmZmVyLCBhcnJbMV0pOwogICAgcmV0dXJuIGZsb29yOwogIH0KICBmdW5jdGlvbiBkZWNvZGVSb2FkVGV4dEFycmF5KGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICBsZXQgbGFiZWxwID0gW107CiAgICBsZXQgYXJyID0gZGVjb2RlQmluYXJ5QXJyYXkoYnVmZmVyLCAwLCBvZmZzZXRbMF0sIG9mZnNldFswXSArIG9mZnNldFsxXSk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewogICAgICBsYWJlbHBbaV0gPSBkZWNvZGVSb2FkVGV4dChidWZmZXIsIGFycltpXSk7CiAgICB9CiAgICByZXR1cm4gbGFiZWxwOwogIH0KICBmdW5jdGlvbiBkZWNvZGVSb2FkVGV4dChidWZmZXIsIG9mZnNldCkgewogICAgbGV0IG9mZnNldDMyID0gb2Zmc2V0WzBdIC8gNDsKICAgIGxldCBtZXRhQ291bnQgPSB1aW50MzJbb2Zmc2V0MzJdOwogICAgbGV0IHJvYWRUZXh0ID0gewogICAgICBzdHlsZUlkOiBpbnQzMltvZmZzZXQzMiArIDFdLAogICAgICByYW5rOiBpbnQzMltvZmZzZXQzMiArIDJdLAogICAgICBuYW1lTGVuOiBpbnQzMltvZmZzZXQzMiArIDNdCiAgICB9OwogICAgbGV0IGFyciA9IGRlY29kZUJpbmFyeUFycmF5KGJ1ZmZlciwgbWV0YUNvdW50ICsgMSwgb2Zmc2V0WzBdLCBvZmZzZXRbMF0gKyBvZmZzZXRbMV0pOwogICAgaWYgKGFyclswXVsxXSkgewogICAgICByb2FkVGV4dC5uYW1lID0gdGV4dERlY29kZXIuZGVjb2RlKG5ldyBVaW50OEFycmF5KGJ1ZmZlciwgYXJyWzBdWzBdLCBhcnJbMF1bMV0pKTsKICAgIH0KICAgIHJvYWRUZXh0LnggPSBuZXcgSW50MzJBcnJheShidWZmZXIsIGFyclsxXVswXSwgYXJyWzFdWzFdIC8gNCk7CiAgICByb2FkVGV4dC5hbmdsZSA9IG5ldyBVaW50MTZBcnJheShidWZmZXIsIGFyclsyXVswXSwgYXJyWzJdWzFdIC8gMik7CiAgICByb2FkVGV4dC5yZXZlcnNlID0gbmV3IFVpbnQxNkFycmF5KGJ1ZmZlciwgYXJyWzNdWzBdLCBhcnJbM11bMV0gLyAyKTsKICAgIHJvYWRUZXh0LnRyYWNlciA9IG5ldyBVaW50MTZBcnJheShidWZmZXIsIGFycls0XVswXSwgYXJyWzRdWzFdIC8gMik7CiAgICByb2FkVGV4dC56dmVjdG9yID0gbmV3IEludDE2QXJyYXkoYnVmZmVyLCBhcnJbNV1bMF0sIGFycls1XVsxXSAvIDIpOwogICAgbGV0IHBvc0FyciA9IGRlY29kZUJpbmFyeUFycmF5KGJ1ZmZlciwgMCwgYXJyWzZdWzBdLCBhcnJbNl1bMF0gKyBhcnJbNl1bMV0pOwogICAgcm9hZFRleHQucG9zID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBvc0Fyci5sZW5ndGg7IGkrKykgewogICAgICByb2FkVGV4dC5wb3NbaV0gPSBuZXcgVWludDE2QXJyYXkoYnVmZmVyLCBwb3NBcnJbaV1bMF0sIHBvc0FycltpXVsxXSAvIDIpOwogICAgfQogICAgcmV0dXJuIHJvYWRUZXh0OwogIH0KICBmdW5jdGlvbiBkZWNvZGVHZW9MYXllcihidWZmZXIsIG9mZnNldCkgewogICAgbGV0IHJlc3VsdCA9IFtdOwogICAgbGV0IGdlb2xheWVyQXJyID0gZGVjb2RlQmluYXJ5QXJyYXkoYnVmZmVyLCAwLCBvZmZzZXRbMF0sIG9mZnNldFswXSArIG9mZnNldFsxXSk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGdlb2xheWVyQXJyLmxlbmd0aDsgaSsrKSB7CiAgICAgIHJlc3VsdFtpXSA9IGRlY29kZUdlb0xheWVySXRlbShidWZmZXIsIGdlb2xheWVyQXJyW2ldKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGRlY29kZUdlb0xheWVySXRlbShidWZmZXIsIG9mZnNldCkgewogICAgbGV0IGdlb2xheWVyID0ge307CiAgICBsZXQgb2Zmc2V0MzIgPSBvZmZzZXRbMF0gLyA0OwogICAgbGV0IG1ldGFDb3VudCA9IHVpbnQzMltvZmZzZXQzMl07CiAgICBnZW9sYXllci5jYXRhbG9nVHlwZSA9IHVpbnQzMltvZmZzZXQzMiArIDFdOwogICAgZ2VvbGF5ZXIucmFuayA9IHVpbnQzMltvZmZzZXQzMiArIDJdOwogICAgbGV0IGFyciA9IGRlY29kZUJpbmFyeUFycmF5KGJ1ZmZlciwgbWV0YUNvdW50ICsgMSwgb2Zmc2V0WzBdLCBvZmZzZXRbMF0gKyBvZmZzZXRbMV0pOwogICAgaWYgKGFyci5sZW5ndGgpIHsKICAgICAgaWYgKGdlb2xheWVyLmNhdGFsb2dUeXBlID09PSBHQU9RSU5HX0FSUk9XX1RZUEUkMSkgewogICAgICAgIGdlb2xheWVyLmFycm93cCA9IHsKICAgICAgICAgIHg6IG5ldyBJbnQzMkFycmF5KGJ1ZmZlciwgYXJyWzBdWzBdLCBhcnJbMF1bMV0gLyA0KSwKICAgICAgICAgIHRyYWNlcjogbmV3IEludDMyQXJyYXkoYnVmZmVyLCBhcnJbMV1bMF0sIGFyclsxXVsxXSAvIDQpLAogICAgICAgICAgenZlY3RvcjogbmV3IEludDE2QXJyYXkoYnVmZmVyLCBhcnJbMl1bMF0sIGFyclsyXVsxXSAvIDIpCiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICBnZW9sYXllci5nZW9vYmplY3RzZXRTZXQgPSBbXTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykgewogICAgICAgICAgZ2VvbGF5ZXIuZ2Vvb2JqZWN0c2V0U2V0W2ldID0gZGVjb2RlR2VvT2JqZWN0U2V0KGJ1ZmZlciwgYXJyW2ldLCBnZW9sYXllci5jYXRhbG9nVHlwZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gZ2VvbGF5ZXI7CiAgfQogIGZ1bmN0aW9uIGRlY29kZUdlb09iamVjdFNldChidWZmZXIsIG9mZnNldCwgY2F0YWxvZykgewogICAgbGV0IGdlb09iamVjdFNldCA9IHt9OwogICAgbGV0IG9mZnNldDMyID0gb2Zmc2V0WzBdIC8gNDsKICAgIGxldCBtZXRhQ291bnQgPSB1aW50MzJbb2Zmc2V0MzJdOwogICAgZ2VvT2JqZWN0U2V0LnN0eWxlSWQgPSB1aW50MzJbb2Zmc2V0MzIgKyAxXTsKICAgIGxldCBnZW9PYmplY3RTZXRBcnIgPSBkZWNvZGVCaW5hcnlBcnJheShidWZmZXIsIG1ldGFDb3VudCArIDEsIG9mZnNldFswXSwgb2Zmc2V0WzBdICsgb2Zmc2V0WzFdKTsKICAgIGdlb09iamVjdFNldC5nZW9PYmplY3RTZXQgPSBbXTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZ2VvT2JqZWN0U2V0QXJyLmxlbmd0aDsgaSsrKSB7CiAgICAgIGdlb09iamVjdFNldC5nZW9PYmplY3RTZXRbaV0gPSBkZWNvZGVHZW9PYmplY3QoYnVmZmVyLCBnZW9PYmplY3RTZXRBcnJbaV0sIGNhdGFsb2cpOwogICAgfQogICAgcmV0dXJuIGdlb09iamVjdFNldDsKICB9CiAgZnVuY3Rpb24gZGVjb2RlR2VvT2JqZWN0KGJ1ZmZlciwgb2Zmc2V0LCBjYXRhbG9nKSB7CiAgICBsZXQgZ2VvT2JqZWN0ID0ge307CiAgICBsZXQgb2Zmc2V0MzIgPSBvZmZzZXRbMF0gLyA0OwogICAgbGV0IG1ldGFDb3VudCA9IHVpbnQzMltvZmZzZXQzMl07CiAgICBnZW9PYmplY3QudHJhY2VyID0gdWludDMyW29mZnNldDMyICsgMV07CiAgICBpZiAoY2F0YWxvZyA9PT0gUE9MWV9UWVBFJDEgfHwgY2F0YWxvZyA9PT0gR0FPUUlOR19ST0FEX1RZUEUkMSkgewogICAgICBsZXQgYXJyID0gZGVjb2RlQmluYXJ5QXJyYXkoYnVmZmVyLCBtZXRhQ291bnQgKyAxLCBvZmZzZXRbMF0sIG9mZnNldFswXSArIG9mZnNldFsxXSk7CiAgICAgIGdlb09iamVjdC5zdXJmYWNlVHlwZSA9IHVpbnQzMltvZmZzZXQzMiArIDJdOwogICAgICBnZW9PYmplY3QubWlkUG9pbnRzID0gbmV3IEludDMyQXJyYXkoYnVmZmVyLCBhcnJbMF1bMF0sIGFyclswXVsxXSAvIDQpOwogICAgICBpZiAoZGF0YVZlcnNpb24gPiAxKSB7CiAgICAgICAgZ2VvT2JqZWN0Lnp2ZWN0b3IgPSBuZXcgSW50MTZBcnJheShidWZmZXIsIGFyclsxXVswXSwgYXJyWzFdWzFdIC8gMik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZ2VvT2JqZWN0Lnp2ZWN0b3IgPSBuZXcgVWludDE2QXJyYXkoYnVmZmVyLCBhcnJbMV1bMF0sIGFyclsxXVsxXSAvIDIpOwogICAgICB9CiAgICAgIGdlb09iamVjdC5pbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KGJ1ZmZlciwgYXJyWzJdWzBdLCBhcnJbMl1bMV0gLyAyKTsKICAgICAgaWYgKGFyclszXSkgewogICAgICAgIGxldCBib3JkZXJBcnIgPSBkZWNvZGVCaW5hcnlBcnJheShidWZmZXIsIDAsIGFyclszXVswXSwgYXJyWzNdWzBdICsgYXJyWzNdWzFdKTsKICAgICAgICBpZiAoYm9yZGVyQXJyLmxlbmd0aCkgewogICAgICAgICAgZ2VvT2JqZWN0LmJvcmRlciA9IFtdOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBib3JkZXJBcnIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgZ2VvT2JqZWN0LmJvcmRlcltpXSA9IGRlY29kZUJvcmRlcihidWZmZXIsIGJvcmRlckFycltpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKGNhdGFsb2cgPT09IExJTktfVFlQRSQxIHx8IGNhdGFsb2cgPT09IEdBT1FJTkdfTElORV9UWVBFJDEgfHwgY2F0YWxvZyA9PT0gVEVYVFVSRV9UWVBFJDEpIHsKICAgICAgbGV0IGFyciA9IGRlY29kZUJpbmFyeUFycmF5KGJ1ZmZlciwgbWV0YUNvdW50ICsgMSwgb2Zmc2V0WzBdLCBvZmZzZXRbMF0gKyBvZmZzZXRbMV0pOwogICAgICBnZW9PYmplY3Qud2lkdGggPSB1aW50MzJbb2Zmc2V0MzIgKyAyXTsKICAgICAgZ2VvT2JqZWN0Lm1pZFBvaW50cyA9IG5ldyBJbnQzMkFycmF5KGJ1ZmZlciwgYXJyWzBdWzBdLCBhcnJbMF1bMV0gLyA0KTsKICAgICAgaWYgKGRhdGFWZXJzaW9uID4gMSkgewogICAgICAgIGdlb09iamVjdC56dmVjdG9yID0gbmV3IEludDE2QXJyYXkoYnVmZmVyLCBhcnJbMV1bMF0sIGFyclsxXVsxXSAvIDIpOwogICAgICB9IGVsc2UgewogICAgICAgIGdlb09iamVjdC56dmVjdG9yID0gbmV3IFVpbnQxNkFycmF5KGJ1ZmZlciwgYXJyWzFdWzBdLCBhcnJbMV1bMV0gLyAyKTsKICAgICAgfQogICAgICBnZW9PYmplY3QucGFyc2VkUG9pbnRzID0gbmV3IEludDE2QXJyYXkoYnVmZmVyLCBhcnJbMl1bMF0sIGFyclsyXVsxXSAvIDIpOwogICAgICBnZW9PYmplY3QudHVybmluZ0RpciA9IG5ldyBJbnQ4QXJyYXkoYnVmZmVyLCBhcnJbM11bMF0sIGFyclszXVsxXSk7CiAgICB9IGVsc2UgaWYgKGNhdGFsb2cgPT09IEdBT1FJTkdfR1JBRElFTlRfVFlQRSQxKSB7CiAgICAgIGxldCBhcnIgPSBkZWNvZGVCaW5hcnlBcnJheShidWZmZXIsIG1ldGFDb3VudCArIDEsIG9mZnNldFswXSwgb2Zmc2V0WzBdICsgb2Zmc2V0WzFdKTsKICAgICAgZ2VvT2JqZWN0Lm1pZFBvaW50cyA9IG5ldyBJbnQzMkFycmF5KGJ1ZmZlciwgYXJyWzBdWzBdLCBhcnJbMF1bMV0gLyA0KTsKICAgICAgZ2VvT2JqZWN0LmdyYWRpZW50UG9zID0gbmV3IEludDMyQXJyYXkoYnVmZmVyLCBhcnJbMV1bMF0sIGFyclsxXVsxXSAvIDQpOwogICAgICBnZW9PYmplY3QuZ3JhZGllbnRTdHlsZUlkID0gbmV3IFVpbnQzMkFycmF5KGJ1ZmZlciwgYXJyWzJdWzBdLCBhcnJbMl1bMV0gLyA0KTsKICAgICAgaWYgKGRhdGFWZXJzaW9uID4gMSkgewogICAgICAgIGdlb09iamVjdC56dmVjdG9yID0gbmV3IEludDE2QXJyYXkoYnVmZmVyLCBhcnJbM11bMF0sIGFyclszXVsxXSAvIDIpOwogICAgICB9IGVsc2UgewogICAgICAgIGdlb09iamVjdC56dmVjdG9yID0gbmV3IFVpbnQxNkFycmF5KGJ1ZmZlciwgYXJyWzNdWzBdLCBhcnJbM11bMV0gLyAyKTsKICAgICAgfQogICAgICBnZW9PYmplY3QuaW5kaWNlcyA9IG5ldyBVaW50MTZBcnJheShidWZmZXIsIGFycls0XVswXSwgYXJyWzRdWzFdIC8gMik7CiAgICB9IGVsc2UgaWYgKGNhdGFsb2cgPT09IEJVSUxESU5HX01FU0hfVFlQRSkgewogICAgICBsZXQgYXJyID0gZGVjb2RlQmluYXJ5QXJyYXkoYnVmZmVyLCBtZXRhQ291bnQgKyAxLCBvZmZzZXRbMF0sIG9mZnNldFswXSArIG9mZnNldFsxXSk7CiAgICAgIGdlb09iamVjdC5idWlsZGluZ0JpZCA9IFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoU3RyaW5nLCBuZXcgVWludDhBcnJheShidWZmZXIsIGFyclswXVswXSwgYXJyWzBdWzFdKSk7CiAgICAgIGdlb09iamVjdC52ZXJ0ZXggPSBuZXcgSW50MzJBcnJheShidWZmZXIsIGFyclsxXVswXSwgYXJyWzFdWzFdIC8gNCk7CiAgICAgIGdlb09iamVjdC5ub3JtYWwgPSBuZXcgSW50MzJBcnJheShidWZmZXIsIGFyclsyXVswXSwgYXJyWzJdWzFdIC8gNCk7CiAgICAgIGxldCBzdWJtZXNoZXMgPSBkZWNvZGVCaW5hcnlBcnJheShidWZmZXIsIDAsIGFyclszXVswXSwgYXJyWzNdWzBdICsgYXJyWzNdWzFdKTsKICAgICAgZ2VvT2JqZWN0LnN1Ym1lc2ggPSBbXTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdWJtZXNoZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBnZW9PYmplY3Quc3VibWVzaFtpXSA9IG5ldyBVaW50MzJBcnJheShidWZmZXIsIHN1Ym1lc2hlc1tpXVswXSwgc3VibWVzaGVzW2ldWzFdIC8gNCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoY2F0YWxvZyA9PT0gUElMTEFSX1RZUEUpIHsKICAgICAgZ2VvT2JqZWN0LnRyYWNlciA9IHVpbnQzMltvZmZzZXQzMl07CiAgICAgIGdlb09iamVjdC56ID0gdWludDMyW29mZnNldDMyICsgMV07CiAgICAgIGdlb09iamVjdC5yYWRpdXMgPSB1aW50MzJbb2Zmc2V0MzIgKyAyXTsKICAgICAgZ2VvT2JqZWN0LnggPSB1aW50MzJbb2Zmc2V0MzIgKyAzXTsKICAgICAgZ2VvT2JqZWN0LnkgPSB1aW50MzJbb2Zmc2V0MzIgKyA0XTsKICAgIH0gZWxzZSBpZiAoY2F0YWxvZyA9PT0gSFJFR0lPTl9UWVBFJDEpIHsKICAgICAgbGV0IGFyciA9IGRlY29kZUJpbmFyeUFycmF5KGJ1ZmZlciwgbWV0YUNvdW50ICsgMSwgb2Zmc2V0WzBdLCBvZmZzZXRbMF0gKyBvZmZzZXRbMV0pOwogICAgICBnZW9PYmplY3QuYWx0aXR1ZGUgPSB1aW50MzJbb2Zmc2V0MzIgKyAyXTsKICAgICAgZ2VvT2JqZWN0Lm1pZFBvaW50cyA9IG5ldyBJbnQzMkFycmF5KGJ1ZmZlciwgYXJyWzBdWzBdLCBhcnJbMF1bMV0gLyA0KTsKICAgICAgZ2VvT2JqZWN0LmluZGljZXMgPSBuZXcgVWludDE2QXJyYXkoYnVmZmVyLCBhcnJbMV1bMF0sIGFyclsxXVsxXSAvIDIpOwogICAgICBpZiAoYXJyWzJdKSB7CiAgICAgICAgbGV0IGJvcmRlckFyciA9IGRlY29kZUJpbmFyeUFycmF5KGJ1ZmZlciwgMCwgYXJyWzJdWzBdLCBhcnJbMl1bMF0gKyBhcnJbMl1bMV0pOwogICAgICAgIGlmIChib3JkZXJBcnIubGVuZ3RoKSB7CiAgICAgICAgICBnZW9PYmplY3QuYm9yZGVyID0gW107CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJvcmRlckFyci5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBnZW9PYmplY3QuYm9yZGVyW2ldID0gZGVjb2RlQm9yZGVyKGJ1ZmZlciwgYm9yZGVyQXJyW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoY2F0YWxvZyA9PT0gUE9JX1RZUEUkMSkgewogICAgICBsZXQgYXJyID0gZGVjb2RlQmluYXJ5QXJyYXkoYnVmZmVyLCBtZXRhQ291bnQgKyAxLCBvZmZzZXRbMF0sIG9mZnNldFswXSArIG9mZnNldFsxXSk7CiAgICAgIGdlb09iamVjdC5wb3N4ID0gdWludDMyW29mZnNldDMyICsgMl07CiAgICAgIGdlb09iamVjdC5wb3N5ID0gdWludDMyW29mZnNldDMyICsgM107CiAgICAgIGdlb09iamVjdC5yYW5rID0gdWludDMyW29mZnNldDMyICsgNF07CiAgICAgIGdlb09iamVjdC5kaXJlY3Rpb24gPSB1aW50MzJbb2Zmc2V0MzIgKyA1XTsKICAgICAgaWYgKGFyclswXVsxXSkgewogICAgICAgIGdlb09iamVjdC51aWQgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZywgbmV3IFVpbnQ4QXJyYXkoYnVmZmVyLCBhcnJbMF1bMF0sIGFyclswXVsxXSkpOwogICAgICB9CiAgICAgIGlmIChhcnJbMV1bMV0pIHsKICAgICAgICBnZW9PYmplY3QubmFtZSA9IHRleHREZWNvZGVyLmRlY29kZShuZXcgVWludDhBcnJheShidWZmZXIsIGFyclsxXVswXSwgYXJyWzFdWzFdKSkucmVwbGFjZSgvXFxcXC9nLCAiXFwiKTsKICAgICAgfQogICAgICBsZXQgcG9zQXJyID0gZGVjb2RlQmluYXJ5QXJyYXkoYnVmZmVyLCAwLCBhcnJbMl1bMF0sIGFyclsyXVswXSArIGFyclsyXVsxXSk7CiAgICAgIGdlb09iamVjdC5wb3MgPSBbXTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb3NBcnIubGVuZ3RoOyBpKyspIHsKICAgICAgICBnZW9PYmplY3QucG9zW2ldID0gbmV3IFVpbnQxNkFycmF5KGJ1ZmZlciwgcG9zQXJyW2ldWzBdLCBwb3NBcnJbaV1bMV0gLyAyKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGdlb09iamVjdDsKICB9CiAgZnVuY3Rpb24gZGVjb2RlQm9yZGVyKGJ1ZmZlciwgb2Zmc2V0KSB7CiAgICBsZXQgZGF0YSA9IGRlY29kZUJpbmFyeUFycmF5KGJ1ZmZlciwgMCwgb2Zmc2V0WzBdLCBvZmZzZXRbMF0gKyBvZmZzZXRbMV0pOwogICAgcmV0dXJuIHsKICAgICAgcGFyc2VkUG9pbnRzOiBuZXcgSW50MTZBcnJheShidWZmZXIsIGRhdGFbMF1bMF0sIGRhdGFbMF1bMV0gLyAyKSwKICAgICAgc3BsaXRJbmRpY2VzOiBuZXcgVWludDE2QXJyYXkoYnVmZmVyLCBkYXRhWzFdWzBdLCBkYXRhWzFdWzFdIC8gMiksCiAgICAgIHR1cm5pbmdEaXI6IG5ldyBJbnQ4QXJyYXkoYnVmZmVyLCBkYXRhWzJdWzBdLCBkYXRhWzJdWzFdIC8gMikKICAgIH07CiAgfQogIGZ1bmN0aW9uIGRlY29kZUJpbmFyeUFycmF5KGJ1ZmZlciwgc3RhcnQsIG9mZnNldCwgZW5kKSB7CiAgICBsZXQgb2Zmc2V0MzIgPSBvZmZzZXQgLyA0OwogICAgbGV0IGNvdW50ID0gdWludDMyW29mZnNldDMyICsgc3RhcnRdOwogICAgbGV0IGJ5dGVTdGFydCA9IChjb3VudCArIHN0YXJ0ICsgMSkgKiA0ICsgb2Zmc2V0OwogICAgbGV0IHJlc3VsdCA9IFtdOwogICAgaWYgKGJ5dGVTdGFydCA+IGVuZCkgewogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgIGxldCBpdGVtTGVuZ3RoID0gdWludDMyW29mZnNldDMyICsgc3RhcnQgKyAxICsgaV07CiAgICAgIGxldCBieXRlRW5kID0gYnl0ZVN0YXJ0ICsgaXRlbUxlbmd0aDsKICAgICAgcmVzdWx0W2ldID0gW2J5dGVTdGFydCwgaXRlbUxlbmd0aF07CiAgICAgIGlmIChieXRlRW5kICUgNCAhPT0gMCkgewogICAgICAgIGJ5dGVTdGFydCA9IGJ5dGVFbmQgKyA0IC0gYnl0ZUVuZCAlIDQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYnl0ZVN0YXJ0ID0gYnl0ZUVuZDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgcmV0dXJuIGRlY29kZUJsb2NrVW5pdDI7Cn0oKTsKY29uc3QgUFJPSkVDVElPTl9HRU8gPSAiRVBTRzo0MzI2IjsKY29uc3QgUFJPSkVDVElPTl9XRUJfTUVSQ0FUT1IgPSAiRVBTRzozODU3IjsKY29uc3QgUFJPSkVDVElPTl9FQ0VGID0gIkVQU0c6NDk3OCI7CmNvbnN0IFBST0pFQ1RJT05fQkRfTUVSQ0FUT1IgPSAiQkQ6TUVSQ0FUT1IiOwpjb25zdCBQUk9KRUNUSU9OX1NDUkVFTl9QSVhFTCA9ICJTQ1JFRU5fUElYRUwiOwpjb25zdCBhbmdsZUJldHdlZW5TY3JhdGNoJDEgPSBuZXcgVmVjdG9yMigpOwpjb25zdCBhbmdsZUJldHdlZW5TY3JhdGNoMiQxID0gbmV3IFZlY3RvcjIoKTsKY29uc3QgX0NhcnRlc2lhbjIgPSBjbGFzcyB7CiAgc3RhdGljIGNsb25lKHYxLCB2MikgewogICAgdjIuY29weSh2MSk7CiAgICByZXR1cm4gdjI7CiAgfQogIHN0YXRpYyBmcm9tRWxlbWVudHMoeCwgeSwgcmVzdWx0KSB7CiAgICBpZiAoIXJlc3VsdCkgewogICAgICByZXN1bHQgPSBuZXcgVmVjdG9yMigpOwogICAgfQogICAgcmVzdWx0LnNldCh4LCB5KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHN0YXRpYyBsZXJwKHN0YXJ0LCBlbmQsIHQsIHJlc3VsdCkgewogICAgaWYgKCFyZXN1bHQpIHsKICAgICAgcmVzdWx0ID0gbmV3IFZlY3RvcjIoKTsKICAgIH0KICAgIHJlc3VsdC5sZXJwVmVjdG9ycyhzdGFydCwgZW5kLCB0KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHN0YXRpYyBlcXVhbHNFcHNpbG9uKGxlZnQsIHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWQkMShsZWZ0KSAmJiBkZWZpbmVkJDEocmlnaHQpICYmIENlc2l1bU1hdGguZXF1YWxzRXBzaWxvbigKICAgICAgbGVmdC54LAogICAgICByaWdodC54LAogICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgIGFic29sdXRlRXBzaWxvbgogICAgKSAmJiBDZXNpdW1NYXRoLmVxdWFsc0Vwc2lsb24oCiAgICAgIGxlZnQueSwKICAgICAgcmlnaHQueSwKICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICk7CiAgfQogIHN0YXRpYyBlcXVhbHModjEsIHYyKSB7CiAgICByZXR1cm4gdjEuZXF1YWxzKHYyKTsKICB9CiAgc3RhdGljIGRvdCh2MSwgdjIpIHsKICAgIHJldHVybiB2MS5kb3QodjIpOwogIH0KICBzdGF0aWMgbm9ybWFsaXplKHYxLCB2MikgewogICAgaWYgKHYxID09PSB2MikgewogICAgICB2MS5ub3JtYWxpemUoKTsKICAgICAgcmV0dXJuIHYxOwogICAgfQogICAgdjIuY29weSh2MSk7CiAgICB2Mi5ub3JtYWxpemUoKTsKICAgIHJldHVybiB2MjsKICB9CiAgc3RhdGljIGFkZCh2MSwgdjIsIHJlc3VsdCkgewogICAgaWYgKCFyZXN1bHQpIHsKICAgICAgcmVzdWx0ID0gbmV3IFZlY3RvcjIoKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQuYWRkVmVjdG9ycyh2MSwgdjIpOwogIH0KICBzdGF0aWMgbXVsdGlwbHlCeVNjYWxhcih2MSwgc2NhbGFyLCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3IyKCk7CiAgICB9CiAgICByZXN1bHQuY29weSh2MSkubXVsdGlwbHlTY2FsYXIoc2NhbGFyKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHN0YXRpYyBzdWJ0cmFjdCh2MSwgdjIsIHJlc3VsdCkgewogICAgaWYgKCFyZXN1bHQpIHsKICAgICAgcmVzdWx0ID0gbmV3IFZlY3RvcjIoKTsKICAgIH0KICAgIHJlc3VsdC5zdWJWZWN0b3JzKHYxLCB2Mik7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBzdGF0aWMgZGlzdGFuY2UodjEsIHYyKSB7CiAgICByZXR1cm4gdjEuZGlzdGFuY2VUbyh2Mik7CiAgfQogIHN0YXRpYyBhbmdsZUJldHdlZW4obGVmdCwgcmlnaHQpIHsKICAgIF9DYXJ0ZXNpYW4yLm5vcm1hbGl6ZShsZWZ0LCBhbmdsZUJldHdlZW5TY3JhdGNoJDEpOwogICAgX0NhcnRlc2lhbjIubm9ybWFsaXplKHJpZ2h0LCBhbmdsZUJldHdlZW5TY3JhdGNoMiQxKTsKICAgIHJldHVybiBDZXNpdW1NYXRoLmFjb3NDbGFtcGVkKAogICAgICBfQ2FydGVzaWFuMi5kb3QoYW5nbGVCZXR3ZWVuU2NyYXRjaCQxLCBhbmdsZUJldHdlZW5TY3JhdGNoMiQxKQogICAgKTsKICB9Cn07CmxldCBDYXJ0ZXNpYW4yID0gX0NhcnRlc2lhbjI7Cl9fcHVibGljRmllbGQoQ2FydGVzaWFuMiwgIlpFUk8iLCBuZXcgVmVjdG9yMigpKTsKQ2FydGVzaWFuMi5mcm9tQ2FydGVzaWFuMyA9IENhcnRlc2lhbjIuY2xvbmU7CkNhcnRlc2lhbjIuZnJvbUNhcnRlc2lhbjQgPSBDYXJ0ZXNpYW4yLmNsb25lOwpjb25zdCBtb3N0T3J0aG9nb25hbEF4aXNTY3JhdGNoID0gbmV3IFZlY3RvcjMkMSgpOwpsZXQgc2NyYXRjaE4kMSA9IG5ldyBWZWN0b3IzJDEoKTsKbGV0IHNjcmF0Y2hLJDEgPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IHdnczg0UmFkaWlTcXVhcmVkID0gbmV3IFZlY3RvcjMkMSgKICA2Mzc4MTM3ICogNjM3ODEzNywKICA2Mzc4MTM3ICogNjM3ODEzNywKICA2MzU2NzUyMzE0MjQ1MTc5ZS05ICogNjM1Njc1MjMxNDI0NTE3OWUtOQopOwpjb25zdCBhbmdsZUJldHdlZW5TY3JhdGNoID0gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBhbmdsZUJldHdlZW5TY3JhdGNoMiA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3QgX0NhcnRlc2lhbjMgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoKSB7CiAgICBfX3B1YmxpY0ZpZWxkKHRoaXMsICJDT0xVTU4wUk9XMCIsIDApOwogICAgX19wdWJsaWNGaWVsZCh0aGlzLCAiQ09MVU1OMFJPVzEiLCAxKTsKICAgIF9fcHVibGljRmllbGQodGhpcywgIkNPTFVNTjBST1cyIiwgMik7CiAgICBfX3B1YmxpY0ZpZWxkKHRoaXMsICJDT0xVTU4xUk9XMCIsIDMpOwogICAgX19wdWJsaWNGaWVsZCh0aGlzLCAiQ09MVU1OMVJPVzEiLCA0KTsKICAgIF9fcHVibGljRmllbGQodGhpcywgIkNPTFVNTjFST1cyIiwgNSk7CiAgICBfX3B1YmxpY0ZpZWxkKHRoaXMsICJDT0xVTU4yUk9XMCIsIDYpOwogICAgX19wdWJsaWNGaWVsZCh0aGlzLCAiQ09MVU1OMlJPVzEiLCA3KTsKICAgIF9fcHVibGljRmllbGQodGhpcywgIkNPTFVNTjJST1cyIiwgOCk7CiAgfQogIHN0YXRpYyBjbG9uZSh2MSwgdjIpIHsKICAgIGlmICghdjEpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHYyLmNvcHkodjEpOwogICAgcmV0dXJuIHYyOwogIH0KICBzdGF0aWMgZXF1YWxzKHYxLCB2MikgewogICAgaWYgKGRlZmluZWQkMSh2MSkgJiYgZGVmaW5lZCQxKHYyKSkgewogICAgICByZXR1cm4gdjEuZXF1YWxzKHYyKTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgc3RhdGljIG5vcm1hbGl6ZSh2MSwgdjIpIHsKICAgIGlmICh2MSA9PT0gdjIpIHsKICAgICAgdjEubm9ybWFsaXplKCk7CiAgICAgIHJldHVybiB2MTsKICAgIH0KICAgIHYyLmNvcHkodjEpOwogICAgdjIubm9ybWFsaXplKCk7CiAgICByZXR1cm4gdjI7CiAgfQogIHN0YXRpYyBhZGQodjEsIHYyLCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3IzJDEoKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQuYWRkVmVjdG9ycyh2MSwgdjIpOwogIH0KICBzdGF0aWMgZG90KHYxLCB2MikgewogICAgcmV0dXJuIHYxLmRvdCh2Mik7CiAgfQogIHN0YXRpYyBjcm9zcyh2MSwgdjIsIHJlc3VsdCkgewogICAgaWYgKCFyZXN1bHQpIHsKICAgICAgcmVzdWx0ID0gbmV3IFZlY3RvcjMkMSgpOwogICAgfQogICAgcmVzdWx0LmNyb3NzVmVjdG9ycyh2MSwgdjIpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc3RhdGljIG1hZ25pdHVkZVNxdWFyZWQodjEpIHsKICAgIHJldHVybiB2MS5sZW5ndGhTcSgpOwogIH0KICBzdGF0aWMgbXVsdGlwbHlCeVNjYWxhcih2MSwgc2NhbGFyLCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3IzJDEoKTsKICAgIH0KICAgIHJlc3VsdC5jb3B5KHYxKS5tdWx0aXBseVNjYWxhcihzY2FsYXIpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc3RhdGljIGRpdmlkZUJ5U2NhbGFyKHYxLCBzY2FsYXIsIHJlc3VsdCkgewogICAgaWYgKCFyZXN1bHQpIHsKICAgICAgcmVzdWx0ID0gbmV3IFZlY3RvcjMkMSgpOwogICAgfQogICAgcmVzdWx0LnggPSB2MS54IC8gc2NhbGFyOwogICAgcmVzdWx0LnkgPSB2MS55IC8gc2NhbGFyOwogICAgcmVzdWx0LnogPSB2MS56IC8gc2NhbGFyOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc3RhdGljIHN1YnRyYWN0KHYxLCB2MiwgcmVzdWx0KSB7CiAgICBpZiAoIXJlc3VsdCkgewogICAgICByZXN1bHQgPSBuZXcgVmVjdG9yMyQxKCk7CiAgICB9CiAgICByZXN1bHQuc3ViVmVjdG9ycyh2MSwgdjIpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc3RhdGljIGRpc3RhbmNlKHYxLCB2MikgewogICAgcmV0dXJuIHYxLmRpc3RhbmNlVG8odjIpOwogIH0KICBzdGF0aWMgbmVnYXRlKHYxLCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3IzJDEoKTsKICAgIH0KICAgIHJlc3VsdC5jb3B5KHYxKTsKICAgIHJlc3VsdC5uZWdhdGUoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHN0YXRpYyBtdWx0aXBseUNvbXBvbmVudHModjEsIHYyLCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3IzJDEoKTsKICAgIH0KICAgIHJlc3VsdC5tdWx0aXBseVZlY3RvcnModjEsIHYyKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHN0YXRpYyBtYWduaXR1ZGUodikgewogICAgcmV0dXJuIHYubGVuZ3RoKCk7CiAgfQogIHN0YXRpYyBlcXVhbHNFcHNpbG9uKGxlZnQsIHJpZ2h0LCByZWxhdGl2ZUVwc2lsb24sIGFic29sdXRlRXBzaWxvbikgewogICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0IHx8IGRlZmluZWQkMShsZWZ0KSAmJiBkZWZpbmVkJDEocmlnaHQpICYmIENlc2l1bU1hdGguZXF1YWxzRXBzaWxvbigKICAgICAgbGVmdC54LAogICAgICByaWdodC54LAogICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgIGFic29sdXRlRXBzaWxvbgogICAgKSAmJiBDZXNpdW1NYXRoLmVxdWFsc0Vwc2lsb24oCiAgICAgIGxlZnQueSwKICAgICAgcmlnaHQueSwKICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICkgJiYgQ2VzaXVtTWF0aC5lcXVhbHNFcHNpbG9uKAogICAgICBsZWZ0LnosCiAgICAgIHJpZ2h0LnosCiAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICApOwogIH0KICBzdGF0aWMgZnJvbUNhcnRlc2lhbjQodiwgcmVzdWx0KSB7CiAgICBpZiAoIXJlc3VsdCkgewogICAgICByZXN1bHQgPSBuZXcgVmVjdG9yMyQxKCk7CiAgICB9CiAgICByZXN1bHQuc2V0KHYueCwgdi55LCB2LnopOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc3RhdGljIGZyb21FbGVtZW50cyh4LCB5LCB6LCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3IzJDEoKTsKICAgIH0KICAgIHJlc3VsdC5zZXQoeCwgeSwgeik7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBzdGF0aWMgZnJvbVJhZGlhbnMobG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0LCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlKGhlaWdodCwgMCk7CiAgICBjb25zdCByYWRpaVNxdWFyZWQgPSBkZWZpbmVkJDEoZWxsaXBzb2lkKSA/IGVsbGlwc29pZC5yYWRpaVNxdWFyZWQgOiB3Z3M4NFJhZGlpU3F1YXJlZDsKICAgIGNvbnN0IGNvc0xhdGl0dWRlID0gTWF0aC5jb3MobGF0aXR1ZGUpOwogICAgc2NyYXRjaE4kMS54ID0gY29zTGF0aXR1ZGUgKiBNYXRoLmNvcyhsb25naXR1ZGUpOwogICAgc2NyYXRjaE4kMS55ID0gY29zTGF0aXR1ZGUgKiBNYXRoLnNpbihsb25naXR1ZGUpOwogICAgc2NyYXRjaE4kMS56ID0gTWF0aC5zaW4obGF0aXR1ZGUpOwogICAgc2NyYXRjaE4kMSA9IF9DYXJ0ZXNpYW4zLm5vcm1hbGl6ZShzY3JhdGNoTiQxLCBzY3JhdGNoTiQxKTsKICAgIF9DYXJ0ZXNpYW4zLm11bHRpcGx5Q29tcG9uZW50cyhyYWRpaVNxdWFyZWQsIHNjcmF0Y2hOJDEsIHNjcmF0Y2hLJDEpOwogICAgY29uc3QgZ2FtbWEgPSBNYXRoLnNxcnQoX0NhcnRlc2lhbjMuZG90KHNjcmF0Y2hOJDEsIHNjcmF0Y2hLJDEpKTsKICAgIHNjcmF0Y2hLJDEgPSBfQ2FydGVzaWFuMy5kaXZpZGVCeVNjYWxhcihzY3JhdGNoSyQxLCBnYW1tYSwgc2NyYXRjaEskMSk7CiAgICBzY3JhdGNoTiQxID0gX0NhcnRlc2lhbjMubXVsdGlwbHlCeVNjYWxhcihzY3JhdGNoTiQxLCBoZWlnaHQsIHNjcmF0Y2hOJDEpOwogICAgaWYgKCFkZWZpbmVkJDEocmVzdWx0KSkgewogICAgICByZXN1bHQgPSBuZXcgVmVjdG9yMyQxKCk7CiAgICB9CiAgICByZXR1cm4gX0NhcnRlc2lhbjMuYWRkKHNjcmF0Y2hLJDEsIHNjcmF0Y2hOJDEsIHJlc3VsdCk7CiAgfQogIHN0YXRpYyBhbmdsZUJldHdlZW4obGVmdCwgcmlnaHQpIHsKICAgIF9DYXJ0ZXNpYW4zLm5vcm1hbGl6ZShsZWZ0LCBhbmdsZUJldHdlZW5TY3JhdGNoKTsKICAgIF9DYXJ0ZXNpYW4zLm5vcm1hbGl6ZShyaWdodCwgYW5nbGVCZXR3ZWVuU2NyYXRjaDIpOwogICAgY29uc3QgY29zaW5lID0gX0NhcnRlc2lhbjMuZG90KGFuZ2xlQmV0d2VlblNjcmF0Y2gsIGFuZ2xlQmV0d2VlblNjcmF0Y2gyKTsKICAgIGNvbnN0IHNpbmUgPSBfQ2FydGVzaWFuMy5tYWduaXR1ZGUoCiAgICAgIF9DYXJ0ZXNpYW4zLmNyb3NzKAogICAgICAgIGFuZ2xlQmV0d2VlblNjcmF0Y2gsCiAgICAgICAgYW5nbGVCZXR3ZWVuU2NyYXRjaDIsCiAgICAgICAgYW5nbGVCZXR3ZWVuU2NyYXRjaAogICAgICApCiAgICApOwogICAgcmV0dXJuIE1hdGguYXRhbjIoc2luZSwgY29zaW5lKTsKICB9CiAgc3RhdGljIGZyb21EZWdyZWVzKGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCwgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgIGxvbmdpdHVkZSA9IENlc2l1bU1hdGgudG9SYWRpYW5zKGxvbmdpdHVkZSk7CiAgICBsYXRpdHVkZSA9IENlc2l1bU1hdGgudG9SYWRpYW5zKGxhdGl0dWRlKTsKICAgIHJldHVybiBfQ2FydGVzaWFuMy5mcm9tUmFkaWFucyhsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQsIGVsbGlwc29pZCwgcmVzdWx0KTsKICB9Cn07CmxldCBDYXJ0ZXNpYW4zID0gX0NhcnRlc2lhbjM7Cl9fcHVibGljRmllbGQoQ2FydGVzaWFuMywgIlpFUk8iLCBPYmplY3QuZnJlZXplKG5ldyBWZWN0b3IzJDEoKSkpOwpfX3B1YmxpY0ZpZWxkKENhcnRlc2lhbjMsICJVTklUX1giLCBPYmplY3QuZnJlZXplKG5ldyBWZWN0b3IzJDEoMSwgMCwgMCkpKTsKX19wdWJsaWNGaWVsZChDYXJ0ZXNpYW4zLCAiVU5JVF9ZIiwgT2JqZWN0LmZyZWV6ZShuZXcgVmVjdG9yMyQxKDAsIDEsIDApKSk7Cl9fcHVibGljRmllbGQoQ2FydGVzaWFuMywgIlVOSVRfWiIsIE9iamVjdC5mcmVlemUobmV3IFZlY3RvcjMkMSgwLCAwLCAxKSkpOwpfX3B1YmxpY0ZpZWxkKENhcnRlc2lhbjMsICJhYnMiLCBmdW5jdGlvbihjYXJ0ZXNpYW4sIHJlc3VsdCkgewogIHJlc3VsdC54ID0gTWF0aC5hYnMoY2FydGVzaWFuLngpOwogIHJlc3VsdC55ID0gTWF0aC5hYnMoY2FydGVzaWFuLnkpOwogIHJlc3VsdC56ID0gTWF0aC5hYnMoY2FydGVzaWFuLnopOwogIHJldHVybiByZXN1bHQ7Cn0pOwpfX3B1YmxpY0ZpZWxkKENhcnRlc2lhbjMsICJtb3N0T3J0aG9nb25hbEF4aXMiLCBmdW5jdGlvbihjYXJ0ZXNpYW4sIHJlc3VsdCkgewogIGNvbnN0IGYgPSBfQ2FydGVzaWFuMy5ub3JtYWxpemUoY2FydGVzaWFuLCBtb3N0T3J0aG9nb25hbEF4aXNTY3JhdGNoKTsKICBfQ2FydGVzaWFuMy5hYnMoZiwgZik7CiAgaWYgKGYueCA8PSBmLnkpIHsKICAgIGlmIChmLnggPD0gZi56KSB7CiAgICAgIHJlc3VsdCA9IF9DYXJ0ZXNpYW4zLmNsb25lKF9DYXJ0ZXNpYW4zLlVOSVRfWCwgcmVzdWx0KTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdCA9IF9DYXJ0ZXNpYW4zLmNsb25lKF9DYXJ0ZXNpYW4zLlVOSVRfWiwgcmVzdWx0KTsKICAgIH0KICB9IGVsc2UgaWYgKGYueSA8PSBmLnopIHsKICAgIHJlc3VsdCA9IF9DYXJ0ZXNpYW4zLmNsb25lKF9DYXJ0ZXNpYW4zLlVOSVRfWSwgcmVzdWx0KTsKICB9IGVsc2UgewogICAgcmVzdWx0ID0gX0NhcnRlc2lhbjMuY2xvbmUoX0NhcnRlc2lhbjMuVU5JVF9aLCByZXN1bHQpOwogIH0KICByZXR1cm4gcmVzdWx0Owp9KTsKY2xhc3MgUmVjdGFuZ2xlIHsKICBjb25zdHJ1Y3Rvcih3ZXN0LCBzb3V0aCwgZWFzdCwgbm9ydGgpIHsKICAgIHRoaXMud2VzdCA9IHdlc3QgfHwgMDsKICAgIHRoaXMuc291dGggPSBzb3V0aCB8fCAwOwogICAgdGhpcy5lYXN0ID0gZWFzdCB8fCAwOwogICAgdGhpcy5ub3J0aCA9IG5vcnRoIHx8IDA7CiAgfQogIGdldCB3aWR0aCgpIHsKICAgIHJldHVybiBSZWN0YW5nbGUuY29tcHV0ZVdpZHRoKHRoaXMpOwogIH0KICBnZXQgaGVpZ2h0KCkgewogICAgcmV0dXJuIFJlY3RhbmdsZS5jb21wdXRlSGVpZ2h0KHRoaXMpOwogIH0KfQpSZWN0YW5nbGUuZnJvbURlZ3JlZXMgPSBmdW5jdGlvbih3ZXN0LCBzb3V0aCwgZWFzdCwgbm9ydGgsIHJlc3VsdCkgewogIHdlc3QgPSBNYXRoVXRpbHMuZGVnVG9SYWQoZGVmYXVsdFZhbHVlKHdlc3QsIDApKTsKICBzb3V0aCA9IE1hdGhVdGlscy5kZWdUb1JhZChkZWZhdWx0VmFsdWUoc291dGgsIDApKTsKICBlYXN0ID0gTWF0aFV0aWxzLmRlZ1RvUmFkKGRlZmF1bHRWYWx1ZShlYXN0LCAwKSk7CiAgbm9ydGggPSBNYXRoVXRpbHMuZGVnVG9SYWQoZGVmYXVsdFZhbHVlKG5vcnRoLCAwKSk7CiAgaWYgKCFkZWZpbmVkJDEocmVzdWx0KSkgewogICAgcmV0dXJuIG5ldyBSZWN0YW5nbGUod2VzdCwgc291dGgsIGVhc3QsIG5vcnRoKTsKICB9CiAgcmVzdWx0Lndlc3QgPSB3ZXN0OwogIHJlc3VsdC5zb3V0aCA9IHNvdXRoOwogIHJlc3VsdC5lYXN0ID0gZWFzdDsKICByZXN1bHQubm9ydGggPSBub3J0aDsKICByZXR1cm4gcmVzdWx0Owp9OwpSZWN0YW5nbGUuY29tcHV0ZVdpZHRoID0gZnVuY3Rpb24ocmVjdGFuZ2xlKSB7CiAgbGV0IGVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICBjb25zdCB3ZXN0ID0gcmVjdGFuZ2xlLndlc3Q7CiAgaWYgKGVhc3QgPCB3ZXN0KSB7CiAgICBlYXN0ICs9IENlc2l1bU1hdGguVFdPX1BJOwogIH0KICByZXR1cm4gZWFzdCAtIHdlc3Q7Cn07ClJlY3RhbmdsZS5jb21wdXRlSGVpZ2h0ID0gZnVuY3Rpb24ocmVjdGFuZ2xlKSB7CiAgcmV0dXJuIHJlY3RhbmdsZS5ub3J0aCAtIHJlY3RhbmdsZS5zb3V0aDsKfTsKUmVjdGFuZ2xlLmNsb25lID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICBpZiAoIWRlZmluZWQkMShyZWN0YW5nbGUpKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAoIWRlZmluZWQkMShyZXN1bHQpKSB7CiAgICByZXR1cm4gbmV3IFJlY3RhbmdsZShyZWN0YW5nbGUud2VzdCwgcmVjdGFuZ2xlLnNvdXRoLCByZWN0YW5nbGUuZWFzdCwgcmVjdGFuZ2xlLm5vcnRoKTsKICB9CiAgcmVzdWx0Lndlc3QgPSByZWN0YW5nbGUud2VzdDsKICByZXN1bHQuc291dGggPSByZWN0YW5nbGUuc291dGg7CiAgcmVzdWx0LmVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICByZXN1bHQubm9ydGggPSByZWN0YW5nbGUubm9ydGg7CiAgcmV0dXJuIHJlc3VsdDsKfTsKUmVjdGFuZ2xlLnNvdXRod2VzdCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgcmVzdWx0KSB7CiAgaWYgKCFkZWZpbmVkJDEocmVzdWx0KSkgewogICAgcmV0dXJuIG5ldyBWZWN0b3IzJDEocmVjdGFuZ2xlLndlc3QsIHJlY3RhbmdsZS5zb3V0aCk7CiAgfQogIHJlc3VsdC54ID0gcmVjdGFuZ2xlLndlc3Q7CiAgcmVzdWx0LnkgPSByZWN0YW5nbGUuc291dGg7CiAgcmVzdWx0LnogPSAwOwogIHJldHVybiByZXN1bHQ7Cn07ClJlY3RhbmdsZS5ub3J0aGVhc3QgPSBmdW5jdGlvbihyZWN0YW5nbGUsIHJlc3VsdCkgewogIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgIHJldHVybiBuZXcgVmVjdG9yMyQxKHJlY3RhbmdsZS5lYXN0LCByZWN0YW5nbGUubm9ydGgpOwogIH0KICByZXN1bHQueCA9IHJlY3RhbmdsZS5lYXN0OwogIHJlc3VsdC55ID0gcmVjdGFuZ2xlLm5vcnRoOwogIHJlc3VsdC56ID0gMDsKICByZXR1cm4gcmVzdWx0Owp9OwpSZWN0YW5nbGUuc291dGhlYXN0ID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICBpZiAoIWRlZmluZWQkMShyZXN1bHQpKSB7CiAgICByZXR1cm4gbmV3IFZlY3RvcjMkMShyZWN0YW5nbGUuZWFzdCwgcmVjdGFuZ2xlLnNvdXRoKTsKICB9CiAgcmVzdWx0LnggPSByZWN0YW5nbGUuZWFzdDsKICByZXN1bHQueSA9IHJlY3RhbmdsZS5zb3V0aDsKICByZXN1bHQueiA9IDA7CiAgcmV0dXJuIHJlc3VsdDsKfTsKUmVjdGFuZ2xlLm5vcnRod2VzdCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgcmVzdWx0KSB7CiAgaWYgKCFkZWZpbmVkJDEocmVzdWx0KSkgewogICAgcmV0dXJuIG5ldyBWZWN0b3IzJDEocmVjdGFuZ2xlLndlc3QsIHJlY3RhbmdsZS5ub3J0aCk7CiAgfQogIHJlc3VsdC54ID0gcmVjdGFuZ2xlLndlc3Q7CiAgcmVzdWx0LnkgPSByZWN0YW5nbGUubm9ydGg7CiAgcmVzdWx0LnogPSAwOwogIHJldHVybiByZXN1bHQ7Cn07ClJlY3RhbmdsZS5jZW50ZXIgPSBmdW5jdGlvbihyZWN0YW5nbGUsIHJlc3VsdCkgewogIGxldCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogIGlmIChlYXN0IDwgd2VzdCkgewogICAgZWFzdCArPSBDZXNpdW1NYXRoLlRXT19QSTsKICB9CiAgY29uc3QgbG9uZ2l0dWRlID0gQ2VzaXVtTWF0aC5uZWdhdGl2ZVBpVG9QaSgod2VzdCArIGVhc3QpICogMC41KTsKICBjb25zdCBsYXRpdHVkZSA9IChyZWN0YW5nbGUuc291dGggKyByZWN0YW5nbGUubm9ydGgpICogMC41OwogIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgIHJldHVybiBuZXcgVmVjdG9yMyQxKGxvbmdpdHVkZSwgbGF0aXR1ZGUpOwogIH0KICByZXN1bHQueCA9IGxvbmdpdHVkZTsKICByZXN1bHQueSA9IGxhdGl0dWRlOwogIHJlc3VsdC56ID0gMDsKICByZXR1cm4gcmVzdWx0Owp9OwpSZWN0YW5nbGUuY29udGFpbnMgPSBmdW5jdGlvbihyZWN0YW5nbGUsIGNhcnRvZ3JhcGhpYykgewogIGxldCBsb25naXR1ZGUgPSBjYXJ0b2dyYXBoaWMueDsKICBjb25zdCBsYXRpdHVkZSA9IGNhcnRvZ3JhcGhpYy55OwogIGNvbnN0IHdlc3QgPSByZWN0YW5nbGUud2VzdDsKICBsZXQgZWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogIGlmIChlYXN0IDwgd2VzdCkgewogICAgZWFzdCArPSBDZXNpdW1NYXRoLlRXT19QSTsKICAgIGlmIChsb25naXR1ZGUgPCAwKSB7CiAgICAgIGxvbmdpdHVkZSArPSBDZXNpdW1NYXRoLlRXT19QSTsKICAgIH0KICB9CiAgcmV0dXJuIChsb25naXR1ZGUgPiB3ZXN0IHx8IENlc2l1bU1hdGguZXF1YWxzRXBzaWxvbihsb25naXR1ZGUsIHdlc3QsIENlc2l1bU1hdGguRVBTSUxPTjE0KSkgJiYgKGxvbmdpdHVkZSA8IGVhc3QgfHwgQ2VzaXVtTWF0aC5lcXVhbHNFcHNpbG9uKGxvbmdpdHVkZSwgZWFzdCwgQ2VzaXVtTWF0aC5FUFNJTE9OMTQpKSAmJiBsYXRpdHVkZSA+PSByZWN0YW5nbGUuc291dGggJiYgbGF0aXR1ZGUgPD0gcmVjdGFuZ2xlLm5vcnRoOwp9Owpjb25zdCBtYXhQSSA9IE1hdGguUEkgKyAxZS01Owpjb25zdCBtaW5QSSA9IC1NYXRoLlBJIC0gMWUtNTsKY29uc3QgbWF4UElPdmVyVHdvID0gQ2VzaXVtTWF0aC5QSV9PVkVSX1RXTyArIDFlLTU7CmNvbnN0IG1pblBJT3ZlclR3byA9IC1DZXNpdW1NYXRoLlBJX09WRVJfVFdPIC0gMWUtNTsKUmVjdGFuZ2xlLmZyb21Cb3ggPSBmdW5jdGlvbihib3gsIHJlc3VsdCwgcmVzdHJpY3QgPSBmYWxzZSkgewogIGNvbnN0IG1pbiA9IGJveC5taW47CiAgY29uc3QgbWF4ID0gYm94Lm1heDsKICBsZXQgbWluTG9uID0gbWluLnggLyAxODAgKiBNYXRoLlBJOwogIGxldCBtaW5MYXQgPSBtaW4ueSAvIDE4MCAqIE1hdGguUEk7CiAgbGV0IG1heExvbjIgPSBtYXgueCAvIDE4MCAqIE1hdGguUEk7CiAgbGV0IG1heExhdCA9IG1heC55IC8gMTgwICogTWF0aC5QSTsKICBpZiAocmVzdHJpY3QpIHsKICAgIGlmIChtaW5Mb24gPCBtaW5QSSkgewogICAgICBtaW5Mb24gPSAtTWF0aC5QSTsKICAgIH0KICAgIGlmIChtaW5Mb24gPiBtYXhQSSkgewogICAgICBtaW5Mb24gPSBNYXRoLlBJOwogICAgfQogICAgaWYgKG1pbkxhdCA8IG1pblBJT3ZlclR3bykgewogICAgICBtaW5MYXQgPSAtQ2VzaXVtTWF0aC5QSV9PVkVSX1RXTzsKICAgIH0KICAgIGlmIChtaW5MYXQgPiBtYXhQSU92ZXJUd28pIHsKICAgICAgbWluTGF0ID0gQ2VzaXVtTWF0aC5QSV9PVkVSX1RXTzsKICAgIH0KICAgIGlmIChtYXhMb24yID4gbWF4UEkpIHsKICAgICAgbWF4TG9uMiA9IE1hdGguUEk7CiAgICB9CiAgICBpZiAobWF4TG9uMiA8IG1pblBJKSB7CiAgICAgIG1heExvbjIgPSAtTWF0aC5QSTsKICAgIH0KICAgIGlmIChtYXhMYXQgPiBtYXhQSU92ZXJUd28pIHsKICAgICAgbWF4TGF0ID0gQ2VzaXVtTWF0aC5QSV9PVkVSX1RXTzsKICAgIH0KICAgIGlmIChtYXhMYXQgPCBtaW5QSU92ZXJUd28pIHsKICAgICAgbWF4TGF0ID0gLUNlc2l1bU1hdGguUElfT1ZFUl9UV087CiAgICB9CiAgfQogIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlKG1pbkxvbiwgbWluTGF0LCBtYXhMb24yLCBtYXhMYXQpOwogIH0KICByZXN1bHQud2VzdCA9IG1pbkxvbjsKICByZXN1bHQuc291dGggPSBtaW5MYXQ7CiAgcmVzdWx0LmVhc3QgPSBtYXhMb24yOwogIHJlc3VsdC5ub3J0aCA9IG1heExhdDsKICByZXR1cm4gcmVzdWx0Owp9OwpSZWN0YW5nbGUuTUFYX1ZBTFVFID0gT2JqZWN0LmZyZWV6ZSgKICBuZXcgUmVjdGFuZ2xlKAogICAgLU1hdGguUEksCiAgICAtQ2VzaXVtTWF0aC5QSV9PVkVSX1RXTywKICAgIE1hdGguUEksCiAgICBDZXNpdW1NYXRoLlBJX09WRVJfVFdPCiAgKQopOwpjb25zdCBzY2FsZVRvR2VvZGV0aWNTdXJmYWNlSW50ZXJzZWN0aW9uID0gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBzY2FsZVRvR2VvZGV0aWNTdXJmYWNlR3JhZGllbnQgPSBuZXcgVmVjdG9yMyQxKCk7CmZ1bmN0aW9uIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2UoY2FydGVzaWFuLCBvbmVPdmVyUmFkaWksIG9uZU92ZXJSYWRpaVNxdWFyZWQsIGNlbnRlclRvbGVyYW5jZVNxdWFyZWQsIHJlc3VsdCkgewogIGNvbnN0IHBvc2l0aW9uWCA9IGNhcnRlc2lhbi54OwogIGNvbnN0IHBvc2l0aW9uWSA9IGNhcnRlc2lhbi55OwogIGNvbnN0IHBvc2l0aW9uWiA9IGNhcnRlc2lhbi56OwogIGNvbnN0IG9uZU92ZXJSYWRpaVggPSBvbmVPdmVyUmFkaWkueDsKICBjb25zdCBvbmVPdmVyUmFkaWlZID0gb25lT3ZlclJhZGlpLnk7CiAgY29uc3Qgb25lT3ZlclJhZGlpWiA9IG9uZU92ZXJSYWRpaS56OwogIGNvbnN0IHgyID0gcG9zaXRpb25YICogcG9zaXRpb25YICogb25lT3ZlclJhZGlpWCAqIG9uZU92ZXJSYWRpaVg7CiAgY29uc3QgeTIgPSBwb3NpdGlvblkgKiBwb3NpdGlvblkgKiBvbmVPdmVyUmFkaWlZICogb25lT3ZlclJhZGlpWTsKICBjb25zdCB6MiA9IHBvc2l0aW9uWiAqIHBvc2l0aW9uWiAqIG9uZU92ZXJSYWRpaVogKiBvbmVPdmVyUmFkaWlaOwogIGNvbnN0IHNxdWFyZWROb3JtID0geDIgKyB5MiArIHoyOwogIGNvbnN0IHJhdGlvID0gTWF0aC5zcXJ0KDEgLyBzcXVhcmVkTm9ybSk7CiAgY29uc3QgaW50ZXJzZWN0aW9uID0gc2NhbGVUb0dlb2RldGljU3VyZmFjZUludGVyc2VjdGlvbi5jb3B5KGNhcnRlc2lhbikubXVsdGlwbHlTY2FsYXIocmF0aW8pOwogIGlmIChzcXVhcmVkTm9ybSA8IGNlbnRlclRvbGVyYW5jZVNxdWFyZWQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3IzJDEoKTsKICAgIH0KICAgIHJldHVybiAhaXNGaW5pdGUocmF0aW8pID8gdm9pZCAwIDogcmVzdWx0LmNvcHkoaW50ZXJzZWN0aW9uKTsKICB9CiAgY29uc3Qgb25lT3ZlclJhZGlpU3F1YXJlZFggPSBvbmVPdmVyUmFkaWlTcXVhcmVkLng7CiAgY29uc3Qgb25lT3ZlclJhZGlpU3F1YXJlZFkgPSBvbmVPdmVyUmFkaWlTcXVhcmVkLnk7CiAgY29uc3Qgb25lT3ZlclJhZGlpU3F1YXJlZFogPSBvbmVPdmVyUmFkaWlTcXVhcmVkLno7CiAgY29uc3QgZ3JhZGllbnQgPSBzY2FsZVRvR2VvZGV0aWNTdXJmYWNlR3JhZGllbnQ7CiAgZ3JhZGllbnQueCA9IGludGVyc2VjdGlvbi54ICogb25lT3ZlclJhZGlpU3F1YXJlZFggKiAyOwogIGdyYWRpZW50LnkgPSBpbnRlcnNlY3Rpb24ueSAqIG9uZU92ZXJSYWRpaVNxdWFyZWRZICogMjsKICBncmFkaWVudC56ID0gaW50ZXJzZWN0aW9uLnogKiBvbmVPdmVyUmFkaWlTcXVhcmVkWiAqIDI7CiAgbGV0IGxhbWJkYSA9ICgxIC0gcmF0aW8pICogY2FydGVzaWFuLmxlbmd0aCgpIC8gKDAuNSAqIGdyYWRpZW50Lmxlbmd0aCgpKTsKICBsZXQgY29ycmVjdGlvbiA9IDA7CiAgbGV0IGZ1bmM7CiAgbGV0IGRlbm9taW5hdG9yOwogIGxldCB4TXVsdGlwbGllcjsKICBsZXQgeU11bHRpcGxpZXI7CiAgbGV0IHpNdWx0aXBsaWVyOwogIGxldCB4TXVsdGlwbGllcjI7CiAgbGV0IHlNdWx0aXBsaWVyMjsKICBsZXQgek11bHRpcGxpZXIyOwogIGxldCB4TXVsdGlwbGllcjM7CiAgbGV0IHlNdWx0aXBsaWVyMzsKICBsZXQgek11bHRpcGxpZXIzOwogIGRvIHsKICAgIGxhbWJkYSAtPSBjb3JyZWN0aW9uOwogICAgeE11bHRpcGxpZXIgPSAxIC8gKDEgKyBsYW1iZGEgKiBvbmVPdmVyUmFkaWlTcXVhcmVkWCk7CiAgICB5TXVsdGlwbGllciA9IDEgLyAoMSArIGxhbWJkYSAqIG9uZU92ZXJSYWRpaVNxdWFyZWRZKTsKICAgIHpNdWx0aXBsaWVyID0gMSAvICgxICsgbGFtYmRhICogb25lT3ZlclJhZGlpU3F1YXJlZFopOwogICAgeE11bHRpcGxpZXIyID0geE11bHRpcGxpZXIgKiB4TXVsdGlwbGllcjsKICAgIHlNdWx0aXBsaWVyMiA9IHlNdWx0aXBsaWVyICogeU11bHRpcGxpZXI7CiAgICB6TXVsdGlwbGllcjIgPSB6TXVsdGlwbGllciAqIHpNdWx0aXBsaWVyOwogICAgeE11bHRpcGxpZXIzID0geE11bHRpcGxpZXIyICogeE11bHRpcGxpZXI7CiAgICB5TXVsdGlwbGllcjMgPSB5TXVsdGlwbGllcjIgKiB5TXVsdGlwbGllcjsKICAgIHpNdWx0aXBsaWVyMyA9IHpNdWx0aXBsaWVyMiAqIHpNdWx0aXBsaWVyOwogICAgZnVuYyA9IHgyICogeE11bHRpcGxpZXIyICsgeTIgKiB5TXVsdGlwbGllcjIgKyB6MiAqIHpNdWx0aXBsaWVyMiAtIDE7CiAgICBkZW5vbWluYXRvciA9IHgyICogeE11bHRpcGxpZXIzICogb25lT3ZlclJhZGlpU3F1YXJlZFggKyB5MiAqIHlNdWx0aXBsaWVyMyAqIG9uZU92ZXJSYWRpaVNxdWFyZWRZICsgejIgKiB6TXVsdGlwbGllcjMgKiBvbmVPdmVyUmFkaWlTcXVhcmVkWjsKICAgIGxldCBkZXJpdmF0aXZlID0gLTIgKiBkZW5vbWluYXRvcjsKICAgIGNvcnJlY3Rpb24gPSBmdW5jIC8gZGVyaXZhdGl2ZTsKICB9IHdoaWxlIChNYXRoLmFicyhmdW5jKSA+IDFlLTEyKTsKICBpZiAoIXJlc3VsdCkgewogICAgcmV0dXJuIG5ldyBWZWN0b3IzJDEoCiAgICAgIHBvc2l0aW9uWCAqIHhNdWx0aXBsaWVyLAogICAgICBwb3NpdGlvblkgKiB5TXVsdGlwbGllciwKICAgICAgcG9zaXRpb25aICogek11bHRpcGxpZXIKICAgICk7CiAgfQogIHJlc3VsdC54ID0gcG9zaXRpb25YICogeE11bHRpcGxpZXI7CiAgcmVzdWx0LnkgPSBwb3NpdGlvblkgKiB5TXVsdGlwbGllcjsKICByZXN1bHQueiA9IHBvc2l0aW9uWiAqIHpNdWx0aXBsaWVyOwogIHJldHVybiByZXN1bHQ7Cn0KY29uc3QgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNOID0gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY1AgPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IGNhcnRlc2lhblRvQ2FydG9ncmFwaGljSCA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3Qgd2dzODRPbmVPdmVyUmFkaWkgPSBuZXcgVmVjdG9yMyQxKAogIDEgLyA2Mzc4MTM3LAogIDEgLyA2Mzc4MTM3LAogIDEgLyA2MzU2NzUyMzE0MjQ1MTc5ZS05Cik7CmNvbnN0IHdnczg0T25lT3ZlclJhZGlpU3F1YXJlZCA9IG5ldyBWZWN0b3IzJDEoCiAgMSAvICg2Mzc4MTM3ICogNjM3ODEzNyksCiAgMSAvICg2Mzc4MTM3ICogNjM3ODEzNyksCiAgMSAvICg2MzU2NzUyMzE0MjQ1MTc5ZS05ICogNjM1Njc1MjMxNDI0NTE3OWUtOSkKKTsKY29uc3Qgd2dzODRDZW50ZXJUb2xlcmFuY2VTcXVhcmVkID0gQ2VzaXVtTWF0aC5FUFNJTE9OMTsKY29uc3QgX0NhcnRvZ3JhcGhpYyA9IGNsYXNzIHsKICBzdGF0aWMgZnJvbVJhZGlhbnMobG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0LCByZXN1bHQpIHsKICAgIGhlaWdodCA9IGRlZmF1bHRWYWx1ZShoZWlnaHQsIDApOwogICAgaWYgKCFkZWZpbmVkJDEocmVzdWx0KSkgewogICAgICByZXR1cm4gbmV3IFZlY3RvcjMkMShsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQpOwogICAgfQogICAgcmVzdWx0LnggPSBsb25naXR1ZGU7CiAgICByZXN1bHQueSA9IGxhdGl0dWRlOwogICAgcmVzdWx0LnogPSBoZWlnaHQ7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBzdGF0aWMgZnJvbURlZ3JlZXMobG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0LCByZXN1bHQpIHsKICAgIGxvbmdpdHVkZSA9IENlc2l1bU1hdGgudG9SYWRpYW5zKGxvbmdpdHVkZSk7CiAgICBsYXRpdHVkZSA9IENlc2l1bU1hdGgudG9SYWRpYW5zKGxhdGl0dWRlKTsKICAgIHJldHVybiBfQ2FydG9ncmFwaGljLmZyb21SYWRpYW5zKGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCwgcmVzdWx0KTsKICB9CiAgc3RhdGljIGZyb21DYXJ0ZXNpYW4oY2FydGVzaWFuLCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgY29uc3Qgb25lT3ZlclJhZGlpID0gZGVmaW5lZCQxKGVsbGlwc29pZCkgPyBlbGxpcHNvaWQub25lT3ZlclJhZGlpIDogd2dzODRPbmVPdmVyUmFkaWk7CiAgICBjb25zdCBvbmVPdmVyUmFkaWlTcXVhcmVkID0gZGVmaW5lZCQxKGVsbGlwc29pZCkgPyBlbGxpcHNvaWQub25lT3ZlclJhZGlpU3F1YXJlZCA6IHdnczg0T25lT3ZlclJhZGlpU3F1YXJlZDsKICAgIGNvbnN0IGNlbnRlclRvbGVyYW5jZVNxdWFyZWQgPSBkZWZpbmVkJDEoZWxsaXBzb2lkKSA/IGVsbGlwc29pZC5fY2VudGVyVG9sZXJhbmNlU3F1YXJlZCA6IHdnczg0Q2VudGVyVG9sZXJhbmNlU3F1YXJlZDsKICAgIGNvbnN0IHAgPSBzY2FsZVRvR2VvZGV0aWNTdXJmYWNlKAogICAgICBjYXJ0ZXNpYW4sCiAgICAgIG9uZU92ZXJSYWRpaSwKICAgICAgb25lT3ZlclJhZGlpU3F1YXJlZCwKICAgICAgY2VudGVyVG9sZXJhbmNlU3F1YXJlZCwKICAgICAgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNQCiAgICApOwogICAgaWYgKCFkZWZpbmVkJDEocCkpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIGxldCBuID0gQ2FydGVzaWFuMy5tdWx0aXBseUNvbXBvbmVudHMoCiAgICAgIHAsCiAgICAgIG9uZU92ZXJSYWRpaVNxdWFyZWQsCiAgICAgIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljTgogICAgKTsKICAgIG4gPSBDYXJ0ZXNpYW4zLm5vcm1hbGl6ZShuLCBuKTsKICAgIGNvbnN0IGggPSBDYXJ0ZXNpYW4zLnN1YnRyYWN0KGNhcnRlc2lhbiwgcCwgY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNIKTsKICAgIGNvbnN0IGxvbmdpdHVkZSA9IE1hdGguYXRhbjIobi55LCBuLngpOwogICAgY29uc3QgbGF0aXR1ZGUgPSBNYXRoLmFzaW4obi56KTsKICAgIGNvbnN0IGhlaWdodCA9IENlc2l1bU1hdGguc2lnbihDYXJ0ZXNpYW4zLmRvdChoLCBjYXJ0ZXNpYW4pKSAqIENhcnRlc2lhbjMubWFnbml0dWRlKGgpOwogICAgaWYgKCFkZWZpbmVkJDEocmVzdWx0KSkgewogICAgICByZXR1cm4gbmV3IFZlY3RvcjMkMShsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQpOwogICAgfQogICAgcmVzdWx0LnggPSBsb25naXR1ZGU7CiAgICByZXN1bHQueSA9IGxhdGl0dWRlOwogICAgcmVzdWx0LnogPSBoZWlnaHQ7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBzdGF0aWMgdG9DYXJ0ZXNpYW4oY2FydG9ncmFwaGljLCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgcmV0dXJuIENhcnRlc2lhbjMuZnJvbVJhZGlhbnMoCiAgICAgIGNhcnRvZ3JhcGhpYy54LAogICAgICBjYXJ0b2dyYXBoaWMueSwKICAgICAgY2FydG9ncmFwaGljLnosCiAgICAgIGVsbGlwc29pZCwKICAgICAgcmVzdWx0CiAgICApOwogIH0KICBzdGF0aWMgY2xvbmUoY2FydG9ncmFwaGljLCByZXN1bHQpIHsKICAgIGlmICghZGVmaW5lZCQxKGNhcnRvZ3JhcGhpYykpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgICAgcmV0dXJuIG5ldyBWZWN0b3IzJDEoCiAgICAgICAgY2FydG9ncmFwaGljLngsCiAgICAgICAgY2FydG9ncmFwaGljLnksCiAgICAgICAgY2FydG9ncmFwaGljLnoKICAgICAgKTsKICAgIH0KICAgIHJlc3VsdC54ID0gY2FydG9ncmFwaGljLng7CiAgICByZXN1bHQueSA9IGNhcnRvZ3JhcGhpYy55OwogICAgcmVzdWx0LnogPSBjYXJ0b2dyYXBoaWMuejsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHN0YXRpYyBlcXVhbHMobGVmdCwgcmlnaHQpIHsKICAgIHJldHVybiBsZWZ0ID09PSByaWdodCB8fCBkZWZpbmVkJDEobGVmdCkgJiYgZGVmaW5lZCQxKHJpZ2h0KSAmJiBsZWZ0LnggPT09IHJpZ2h0LnggJiYgbGVmdC55ID09PSByaWdodC55ICYmIGxlZnQueiA9PT0gcmlnaHQuejsKICB9CiAgc3RhdGljIGVxdWFsc0Vwc2lsb24obGVmdCwgcmlnaHQsIGVwc2lsb24pIHsKICAgIGVwc2lsb24gPSBkZWZhdWx0VmFsdWUoZXBzaWxvbiwgMCk7CiAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZCQxKGxlZnQpICYmIGRlZmluZWQkMShyaWdodCkgJiYgQ2VzaXVtTWF0aC5lcXVhbHNFcHNpbG9uKGxlZnQueCwgcmlnaHQueCwgZXBzaWxvbikgJiYgQ2VzaXVtTWF0aC5lcXVhbHNFcHNpbG9uKGxlZnQueSwgcmlnaHQueSwgZXBzaWxvbikgJiYgQ2VzaXVtTWF0aC5lcXVhbHNFcHNpbG9uKGxlZnQueiwgcmlnaHQueiwgZXBzaWxvbik7CiAgfQp9OwpsZXQgQ2FydG9ncmFwaGljID0gX0NhcnRvZ3JhcGhpYzsKX19wdWJsaWNGaWVsZChDYXJ0b2dyYXBoaWMsICJmcm9tUmFkaWFucyIsIGZ1bmN0aW9uKGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCwgcmVzdWx0KSB7CiAgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlKGhlaWdodCwgMCk7CiAgaWYgKCFkZWZpbmVkJDEocmVzdWx0KSkgewogICAgcmV0dXJuIG5ldyBWZWN0b3IzJDEobG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0KTsKICB9CiAgcmVzdWx0LnggPSBsb25naXR1ZGU7CiAgcmVzdWx0LnkgPSBsYXRpdHVkZTsKICByZXN1bHQueiA9IGhlaWdodDsKICByZXR1cm4gcmVzdWx0Owp9KTsKX19wdWJsaWNGaWVsZChDYXJ0b2dyYXBoaWMsICJmcm9tRGVncmVlcyIsIGZ1bmN0aW9uKGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCwgcmVzdWx0KSB7CiAgbG9uZ2l0dWRlID0gQ2VzaXVtTWF0aC50b1JhZGlhbnMobG9uZ2l0dWRlKTsKICBsYXRpdHVkZSA9IENlc2l1bU1hdGgudG9SYWRpYW5zKGxhdGl0dWRlKTsKICByZXR1cm4gX0NhcnRvZ3JhcGhpYy5mcm9tUmFkaWFucyhsb25naXR1ZGUsIGxhdGl0dWRlLCBoZWlnaHQsIHJlc3VsdCk7Cn0pOwpfX3B1YmxpY0ZpZWxkKENhcnRvZ3JhcGhpYywgIlpFUk8iLCBPYmplY3QuZnJlZXplKG5ldyBWZWN0b3IzJDEoMCwgMCwgMCkpKTsKY29uc3QgX2lucHV0VmVjdG9yMyA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3QgX291dHB1dFZlY3RvcjMgPSBuZXcgVmVjdG9yMyQxKCk7CmNsYXNzIEVsbGlwc29pZCB7CiAgY29uc3RydWN0b3IoeCwgeSwgeikgewogICAgdGhpcy5fcmFkaWkgPSBuZXcgVmVjdG9yMyQxKHgsIHksIHopOwogICAgdGhpcy5fcmFkaWlTcXVhcmVkID0gbmV3IFZlY3RvcjMkMSh4ICogeCwgeSAqIHksIHogKiB6KTsKICAgIHRoaXMuX3JhZGlpVG9UaGVGb3VydGggPSBuZXcgVmVjdG9yMyQxKAogICAgICB4ICogeCAqIHggKiB4LAogICAgICB5ICogeSAqIHkgKiB5LAogICAgICB6ICogeiAqIHogKiB6CiAgICApOwogICAgdGhpcy5fb25lT3ZlclJhZGlpID0gbmV3IFZlY3RvcjMkMSgKICAgICAgeCA9PT0gMCA/IDAgOiAxIC8geCwKICAgICAgeSA9PT0gMCA/IDAgOiAxIC8geSwKICAgICAgeiA9PT0gMCA/IDAgOiAxIC8gegogICAgKTsKICAgIHRoaXMuX29uZU92ZXJSYWRpaVNxdWFyZWQgPSBuZXcgVmVjdG9yMyQxKAogICAgICB4ID09PSAwID8gMCA6IDEgLyAoeCAqIHgpLAogICAgICB5ID09PSAwID8gMCA6IDEgLyAoeSAqIHkpLAogICAgICB6ID09PSAwID8gMCA6IDEgLyAoeiAqIHopCiAgICApOwogICAgdGhpcy5fbWluaW11bVJhZGl1cyA9IE1hdGgubWluKHgsIHksIHopOwogICAgdGhpcy5fbWF4aW11bVJhZGl1cyA9IE1hdGgubWF4KHgsIHksIHopOwogICAgdGhpcy5fY2VudGVyVG9sZXJhbmNlU3F1YXJlZCA9IDAuMTsKICAgIGlmICh0aGlzLl9yYWRpaVNxdWFyZWQueiAhPT0gMCkgewogICAgICB0aGlzLl9zcXVhcmVkWE92ZXJTcXVhcmVkWiA9IHRoaXMuX3JhZGlpU3F1YXJlZC54IC8gdGhpcy5fcmFkaWlTcXVhcmVkLno7CiAgICB9CiAgfQogIHN0YXRpYyBmcm9tQ2FydGVzaWFuMyh2ZWN0b3IpIHsKICAgIHJldHVybiBuZXcgRWxsaXBzb2lkKHZlY3Rvci54LCB2ZWN0b3IueSwgdmVjdG9yLnopOwogIH0KICBnZW9kZXRpY1N1cmZhY2VOb3JtYWxDYXJ0b2dyYXBoaWMoY2FydG9ncmFwaGljLCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3IzJDEoKTsKICAgIH0KICAgIGNvbnN0IGxvbmdpdHVkZSA9IGNhcnRvZ3JhcGhpYy54OwogICAgY29uc3QgbGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWMueTsKICAgIGNvbnN0IGNvc0xhdGl0dWRlID0gTWF0aC5jb3MobGF0aXR1ZGUpOwogICAgY29uc3QgeCA9IGNvc0xhdGl0dWRlICogTWF0aC5jb3MobG9uZ2l0dWRlKTsKICAgIGNvbnN0IHkgPSBjb3NMYXRpdHVkZSAqIE1hdGguc2luKGxvbmdpdHVkZSk7CiAgICBjb25zdCB6ID0gTWF0aC5zaW4obGF0aXR1ZGUpOwogICAgcmVzdWx0LnNldCh4LCB5LCB6KTsKICAgIHJlc3VsdC5ub3JtYWxpemUoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGNhcnRvZ3JhcGhpY0RlZ3JlZVRvQ2FydGVzaWFuKGNhcnRvZ3JhcGhpY0RlZ3JlZSwgcmVzdWx0KSB7CiAgICBfaW5wdXRWZWN0b3IzLnNldCgKICAgICAgTWF0aFV0aWxzLmRlZ1RvUmFkKGNhcnRvZ3JhcGhpY0RlZ3JlZS54KSwKICAgICAgTWF0aFV0aWxzLmRlZ1RvUmFkKGNhcnRvZ3JhcGhpY0RlZ3JlZS55KSwKICAgICAgY2FydG9ncmFwaGljRGVncmVlLnoKICAgICk7CiAgICByZXR1cm4gdGhpcy5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihfaW5wdXRWZWN0b3IzLCByZXN1bHQpOwogIH0KICBjYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihjYXJ0b2dyYXBoaWMsIGspIHsKICAgIGNvbnN0IG5vcm1hbCA9IHRoaXMuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsQ2FydG9ncmFwaGljKGNhcnRvZ3JhcGhpYyk7CiAgICBpZiAoIWspIHsKICAgICAgayA9IG5ldyBWZWN0b3IzJDEoKTsKICAgIH0KICAgIGsubXVsdGlwbHlWZWN0b3JzKHRoaXMuX3JhZGlpU3F1YXJlZCwgbm9ybWFsKTsKICAgIGNvbnN0IGdhbW1hID0gTWF0aC5zcXJ0KG5vcm1hbC5jbG9uZSgpLmRvdChrKSk7CiAgICBrLmRpdmlkZVNjYWxhcihnYW1tYSk7CiAgICBub3JtYWwubXVsdGlwbHlTY2FsYXIoY2FydG9ncmFwaGljLnopOwogICAgay5hZGQobm9ybWFsKTsKICAgIHJldHVybiBrOwogIH0KICBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY0RlZ3JlZShjYXJ0ZXNpYW4sIHJlc3VsdCkgewogICAgY29uc3QgdGVtcFJlc3VsdCA9IHRoaXMuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoY2FydGVzaWFuLCByZXN1bHQpOwogICAgaWYgKCF0ZW1wUmVzdWx0KSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICByZXN1bHQgPSB0ZW1wUmVzdWx0OwogICAgcmVzdWx0LnggPSBNYXRoVXRpbHMucmFkVG9EZWcocmVzdWx0LngpOwogICAgcmVzdWx0LnkgPSBNYXRoVXRpbHMucmFkVG9EZWcocmVzdWx0LnkpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc2NhbGVUb0dlb2RldGljU3VyZmFjZShjYXJ0ZXNpYW4sIHJlc3VsdCkgewogICAgcmV0dXJuIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2UoCiAgICAgIGNhcnRlc2lhbiwKICAgICAgdGhpcy5fb25lT3ZlclJhZGlpLAogICAgICB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkLAogICAgICB0aGlzLl9jZW50ZXJUb2xlcmFuY2VTcXVhcmVkLAogICAgICByZXN1bHQKICAgICk7CiAgfQogIHNjYWxlVG9HZW9jZW50cmljU3VyZmFjZShjYXJ0ZXNpYW4sIHJlc3VsdCkgewogICAgaWYgKCFyZXN1bHQpIHsKICAgICAgcmVzdWx0ID0gbmV3IFZlY3RvcjMkMSgpOwogICAgfQogICAgY29uc3QgcG9zaXRpb25YID0gY2FydGVzaWFuLng7CiAgICBjb25zdCBwb3NpdGlvblkgPSBjYXJ0ZXNpYW4ueTsKICAgIGNvbnN0IHBvc2l0aW9uWiA9IGNhcnRlc2lhbi56OwogICAgY29uc3Qgb25lT3ZlclJhZGlpU3F1YXJlZCA9IHRoaXMuX29uZU92ZXJSYWRpaVNxdWFyZWQ7CiAgICBjb25zdCBiZXRhID0gMSAvIE1hdGguc3FydCgKICAgICAgcG9zaXRpb25YICogcG9zaXRpb25YICogb25lT3ZlclJhZGlpU3F1YXJlZC54ICsgcG9zaXRpb25ZICogcG9zaXRpb25ZICogb25lT3ZlclJhZGlpU3F1YXJlZC55ICsgcG9zaXRpb25aICogcG9zaXRpb25aICogb25lT3ZlclJhZGlpU3F1YXJlZC56CiAgICApOwogICAgcmV0dXJuIHJlc3VsdC5jb3B5KGNhcnRlc2lhbikubXVsdGlwbHlTY2FsYXIoYmV0YSk7CiAgfQogIGNhcnRlc2lhblRvQ2FydG9ncmFwaGljKGNhcnRlc2lhbiwgcmVzdWx0KSB7CiAgICBjb25zdCBwID0gdGhpcy5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKAogICAgICBjYXJ0ZXNpYW4sCiAgICAgIF9vdXRwdXRWZWN0b3IzCiAgICApOwogICAgaWYgKCFwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBjb25zdCBuID0gdGhpcy5nZW9kZXRpY1N1cmZhY2VOb3JtYWwocCk7CiAgICBjb25zdCBoID0gY2FydGVzaWFuLmNsb25lKCk7CiAgICBoLnN1YihwKTsKICAgIGNvbnN0IGxvbmdpdHVkZSA9IE1hdGguYXRhbjIobi55LCBuLngpOwogICAgY29uc3QgbGF0aXR1ZGUgPSBNYXRoLmFzaW4obi56KTsKICAgIGNvbnN0IGhlaWdodCA9IE1hdGguc2lnbihoLmRvdChjYXJ0ZXNpYW4pKSAqIGgubGVuZ3RoKCk7CiAgICBpZiAoIXJlc3VsdCkgewogICAgICByZXN1bHQgPSBuZXcgVmVjdG9yMyQxKCk7CiAgICB9CiAgICByZXN1bHQuc2V0KGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBnZW9kZXRpY1N1cmZhY2VOb3JtYWwoY2FydGVzaWFuLCByZXN1bHQpIHsKICAgIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgICAgcmVzdWx0ID0gbmV3IFZlY3RvcjMkMSgpOwogICAgfQogICAgcmVzdWx0Lm11bHRpcGx5VmVjdG9ycyhjYXJ0ZXNpYW4sIHRoaXMuX29uZU92ZXJSYWRpaVNxdWFyZWQpOwogICAgcmVzdWx0Lm5vcm1hbGl6ZSgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZ2V0U3VyZmFjZU5vcm1hbEludGVyc2VjdGlvbldpdGhaQXhpcyhwb3NpdGlvbiwgYnVmZmVyLCByZXN1bHQpIHsKICAgIGJ1ZmZlciA9IGRlZmF1bHRWYWx1ZShidWZmZXIsIDApOwogICAgY29uc3Qgc3F1YXJlZFhPdmVyU3F1YXJlZFogPSB0aGlzLl9zcXVhcmVkWE92ZXJTcXVhcmVkWjsKICAgIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgICAgcmVzdWx0ID0gbmV3IFZlY3RvcjMkMSgpOwogICAgfQogICAgcmVzdWx0LnggPSAwOwogICAgcmVzdWx0LnkgPSAwOwogICAgcmVzdWx0LnogPSBwb3NpdGlvbi56ICogKDEgLSBzcXVhcmVkWE92ZXJTcXVhcmVkWik7CiAgICBpZiAoTWF0aC5hYnMocmVzdWx0LnopID49IHRoaXMuX3JhZGlpLnogLSBidWZmZXIpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHRyYW5zZm9ybVBvc2l0aW9uVG9TY2FsZWRTcGFjZShwb3NpdGlvbiwgcmVzdWx0KSB7CiAgICByZXR1cm4gQ2FydGVzaWFuMy5tdWx0aXBseUNvbXBvbmVudHMocG9zaXRpb24sIHRoaXMuX29uZU92ZXJSYWRpaSwgcmVzdWx0KTsKICB9CiAgc3RhdGljIGNsb25lKGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgICBpZiAoIWVsbGlwc29pZCkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgY29uc3QgcmFkaWkgPSBlbGxpcHNvaWQuX3JhZGlpOwogICAgaWYgKCFyZXN1bHQpIHsKICAgICAgcmV0dXJuIG5ldyBFbGxpcHNvaWQocmFkaWkueCwgcmFkaWkueSwgcmFkaWkueik7CiAgICB9CiAgICBDYXJ0ZXNpYW4zLmNsb25lKHJhZGlpLCByZXN1bHQuX3JhZGlpKTsKICAgIENhcnRlc2lhbjMuY2xvbmUoZWxsaXBzb2lkLl9yYWRpaVNxdWFyZWQsIHJlc3VsdC5fcmFkaWlTcXVhcmVkKTsKICAgIENhcnRlc2lhbjMuY2xvbmUoZWxsaXBzb2lkLl9yYWRpaVRvVGhlRm91cnRoLCByZXN1bHQuX3JhZGlpVG9UaGVGb3VydGgpOwogICAgQ2FydGVzaWFuMy5jbG9uZShlbGxpcHNvaWQuX29uZU92ZXJSYWRpaSwgcmVzdWx0Ll9vbmVPdmVyUmFkaWkpOwogICAgQ2FydGVzaWFuMy5jbG9uZShlbGxpcHNvaWQuX29uZU92ZXJSYWRpaVNxdWFyZWQsIHJlc3VsdC5fb25lT3ZlclJhZGlpU3F1YXJlZCk7CiAgICByZXN1bHQuX21pbmltdW1SYWRpdXMgPSBlbGxpcHNvaWQuX21pbmltdW1SYWRpdXM7CiAgICByZXN1bHQuX21heGltdW1SYWRpdXMgPSBlbGxpcHNvaWQuX21heGltdW1SYWRpdXM7CiAgICByZXN1bHQuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQgPSBlbGxpcHNvaWQuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQ7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBnZXQgcmFkaWkoKSB7CiAgICByZXR1cm4gdGhpcy5fcmFkaWk7CiAgfQogIGdldCByYWRpaVNxdWFyZWQoKSB7CiAgICByZXR1cm4gdGhpcy5fcmFkaWlTcXVhcmVkOwogIH0KICBnZXQgcmFkaWlUb1RoZUZvdXJ0aCgpIHsKICAgIHJldHVybiB0aGlzLnJhZGlpVG9UaGVGb3VydGg7CiAgfQogIGdldCBvbmVPdmVyUmFkaWkoKSB7CiAgICByZXR1cm4gdGhpcy5fb25lT3ZlclJhZGlpOwogIH0KICBnZXQgb25lT3ZlclJhZGlpU3F1YXJlZCgpIHsKICAgIHJldHVybiB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkOwogIH0KICBnZXQgbWF4aW11bVJhZGl1cygpIHsKICAgIHJldHVybiB0aGlzLl9tYXhpbXVtUmFkaXVzOwogIH0KICBnZXQgbWluaW11bVJhZGl1cygpIHsKICAgIHJldHVybiB0aGlzLl9taW5pbXVtUmFkaXVzOwogIH0KfQpFbGxpcHNvaWQuV0dTODQgPSBPYmplY3QuZnJlZXplKAogIG5ldyBFbGxpcHNvaWQoNjM3ODEzNywgNjM3ODEzNywgNjM1Njc1MjMxNDI0NTE3OWUtOSkKKTsKbGV0IHNjcmF0Y2hIUFJRdWF0ZXJuaW9uJDEgPSBuZXcgUXVhdGVybmlvbiQxKCk7CmxldCBzY3JhdGNoSGVhZGluZ1F1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbiQxKCk7CmxldCBzY3JhdGNoUGl0Y2hRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb24kMSgpOwpsZXQgc2NyYXRjaFJvbGxRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb24kMSgpOwpsZXQgZnJvbUF4aXNBbmdsZVNjcmF0Y2ggPSBuZXcgVmVjdG9yMyQxKCk7CmNsYXNzIFN0YXRpY1F1YXRlcm5pb24gewogIHN0YXRpYyBmcm9tQXhpc0FuZ2xlKGF4aXMsIGFuZ2xlLCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBRdWF0ZXJuaW9uJDEoKTsKICAgIH0KICAgIGZyb21BeGlzQW5nbGVTY3JhdGNoLmNvcHkoYXhpcyk7CiAgICBmcm9tQXhpc0FuZ2xlU2NyYXRjaC5ub3JtYWxpemUoKTsKICAgIHJlc3VsdC5zZXRGcm9tQXhpc0FuZ2xlKGZyb21BeGlzQW5nbGVTY3JhdGNoLCBhbmdsZSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBzdGF0aWMgbXVsdGlwbHkocTEsIHEyLCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBRdWF0ZXJuaW9uJDEoKTsKICAgIH0KICAgIHJlc3VsdC5tdWx0aXBseVF1YXRlcm5pb25zKHExLCBxMik7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBzdGF0aWMgZnJvbUhlYWRpbmdQaXRjaFJvbGwoaGVhZGluZ1BpdGNoUm9sbCwgcmVzdWx0KSB7CiAgICBzY3JhdGNoUm9sbFF1YXRlcm5pb24gPSBTdGF0aWNRdWF0ZXJuaW9uLmZyb21BeGlzQW5nbGUoCiAgICAgIENhcnRlc2lhbjMuVU5JVF9YLAogICAgICBoZWFkaW5nUGl0Y2hSb2xsLnJvbGwsCiAgICAgIHNjcmF0Y2hIUFJRdWF0ZXJuaW9uJDEKICAgICk7CiAgICBzY3JhdGNoUGl0Y2hRdWF0ZXJuaW9uID0gU3RhdGljUXVhdGVybmlvbi5mcm9tQXhpc0FuZ2xlKAogICAgICBDYXJ0ZXNpYW4zLlVOSVRfWSwKICAgICAgLWhlYWRpbmdQaXRjaFJvbGwucGl0Y2gsCiAgICAgIHJlc3VsdAogICAgKTsKICAgIHJlc3VsdCA9IFN0YXRpY1F1YXRlcm5pb24ubXVsdGlwbHkoCiAgICAgIHNjcmF0Y2hQaXRjaFF1YXRlcm5pb24sCiAgICAgIHNjcmF0Y2hSb2xsUXVhdGVybmlvbiwKICAgICAgc2NyYXRjaFBpdGNoUXVhdGVybmlvbgogICAgKTsKICAgIHNjcmF0Y2hIZWFkaW5nUXVhdGVybmlvbiA9IFN0YXRpY1F1YXRlcm5pb24uZnJvbUF4aXNBbmdsZSgKICAgICAgQ2FydGVzaWFuMy5VTklUX1osCiAgICAgIC1oZWFkaW5nUGl0Y2hSb2xsLmhlYWRpbmcsCiAgICAgIHNjcmF0Y2hIUFJRdWF0ZXJuaW9uJDEKICAgICk7CiAgICByZXR1cm4gU3RhdGljUXVhdGVybmlvbi5tdWx0aXBseShzY3JhdGNoSGVhZGluZ1F1YXRlcm5pb24sIHJlc3VsdCwgcmVzdWx0KTsKICB9Cn0KY2xhc3MgU3RhdGljTWF0cml4NCB7CiAgc3RhdGljIGNsb25lKG0xLCBtMikgewogICAgbTIuY29weShtMSk7CiAgICByZXR1cm4gbTI7CiAgfQogIHN0YXRpYyBpbnZlcnNlVHJhbnNmb3JtYXRpb24obTEsIG0yKSB7CiAgICBtMi5jb3B5KG0xKS5pbnZlcnQoKTsKICAgIHJldHVybiBtMjsKICB9CiAgc3RhdGljIG11bHRpcGx5QnlQb2ludChtLCB2LCByZXN1bHQpIHsKICAgIGNvbnN0IG1hdHJpeCA9IG0uZWxlbWVudHM7CiAgICBjb25zdCB2WCA9IHYueDsKICAgIGNvbnN0IHZZID0gdi55OwogICAgY29uc3QgdlogPSB2Lno7CiAgICBjb25zdCB4ID0gbWF0cml4WzBdICogdlggKyBtYXRyaXhbNF0gKiB2WSArIG1hdHJpeFs4XSAqIHZaICsgbWF0cml4WzEyXTsKICAgIGNvbnN0IHkgPSBtYXRyaXhbMV0gKiB2WCArIG1hdHJpeFs1XSAqIHZZICsgbWF0cml4WzldICogdlogKyBtYXRyaXhbMTNdOwogICAgY29uc3QgeiA9IG1hdHJpeFsyXSAqIHZYICsgbWF0cml4WzZdICogdlkgKyBtYXRyaXhbMTBdICogdlogKyBtYXRyaXhbMTRdOwogICAgcmVzdWx0LnggPSB4OwogICAgcmVzdWx0LnkgPSB5OwogICAgcmVzdWx0LnogPSB6OwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc3RhdGljIG11bHRpcGx5QnlQb2ludEFzVmVjdG9yKG0sIHYsIHJlc3VsdCkgewogICAgY29uc3QgbWF0cml4ID0gbS5lbGVtZW50czsKICAgIGNvbnN0IHZYID0gdi54OwogICAgY29uc3QgdlkgPSB2Lnk7CiAgICBjb25zdCB2WiA9IHYuejsKICAgIGNvbnN0IHggPSBtYXRyaXhbMF0gKiB2WCArIG1hdHJpeFs0XSAqIHZZICsgbWF0cml4WzhdICogdlo7CiAgICBjb25zdCB5ID0gbWF0cml4WzFdICogdlggKyBtYXRyaXhbNV0gKiB2WSArIG1hdHJpeFs5XSAqIHZaOwogICAgY29uc3QgeiA9IG1hdHJpeFsyXSAqIHZYICsgbWF0cml4WzZdICogdlkgKyBtYXRyaXhbMTBdICogdlo7CiAgICByZXN1bHQueCA9IHg7CiAgICByZXN1bHQueSA9IHk7CiAgICByZXN1bHQueiA9IHo7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBzdGF0aWMgY29tcHV0ZVZpZXdwb3J0VHJhbnNmb3JtYXRpb24odmlld3BvcnQsIG5lYXJEZXB0aFJhbmdlLCBmYXJEZXB0aFJhbmdlLCByZXN1bHQpIHsKICAgIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgICAgcmVzdWx0ID0gbmV3IE1hdHJpeDQoKTsKICAgIH0KICAgIHZpZXdwb3J0ID0gZGVmYXVsdFZhbHVlKHZpZXdwb3J0LCBkZWZhdWx0VmFsdWUuRU1QVFlfT0JKRUNUKTsKICAgIGNvbnN0IHggPSBkZWZhdWx0VmFsdWUodmlld3BvcnQueCwgMCk7CiAgICBjb25zdCB5ID0gZGVmYXVsdFZhbHVlKHZpZXdwb3J0LnksIDApOwogICAgY29uc3Qgd2lkdGggPSBkZWZhdWx0VmFsdWUodmlld3BvcnQud2lkdGgsIDApOwogICAgY29uc3QgaGVpZ2h0ID0gZGVmYXVsdFZhbHVlKHZpZXdwb3J0LmhlaWdodCwgMCk7CiAgICBuZWFyRGVwdGhSYW5nZSA9IGRlZmF1bHRWYWx1ZShuZWFyRGVwdGhSYW5nZSwgMCk7CiAgICBmYXJEZXB0aFJhbmdlID0gZGVmYXVsdFZhbHVlKGZhckRlcHRoUmFuZ2UsIDEpOwogICAgY29uc3QgaGFsZldpZHRoID0gd2lkdGggKiAwLjU7CiAgICBjb25zdCBoYWxmSGVpZ2h0ID0gaGVpZ2h0ICogMC41OwogICAgY29uc3QgaGFsZkRlcHRoID0gKGZhckRlcHRoUmFuZ2UgLSBuZWFyRGVwdGhSYW5nZSkgKiAwLjU7CiAgICBjb25zdCBjb2x1bW4wUm93MCA9IGhhbGZXaWR0aDsKICAgIGNvbnN0IGNvbHVtbjFSb3cxID0gaGFsZkhlaWdodDsKICAgIGNvbnN0IGNvbHVtbjJSb3cyID0gaGFsZkRlcHRoOwogICAgY29uc3QgY29sdW1uM1JvdzAgPSB4ICsgaGFsZldpZHRoOwogICAgY29uc3QgY29sdW1uM1JvdzEgPSB5ICsgaGFsZkhlaWdodDsKICAgIGNvbnN0IGNvbHVtbjNSb3cyID0gbmVhckRlcHRoUmFuZ2UgKyBoYWxmRGVwdGg7CiAgICBjb25zdCBjb2x1bW4zUm93MyA9IDE7CiAgICBjb25zdCBlbGVtZW50cyA9IHJlc3VsdC5lbGVtZW50czsKICAgIGVsZW1lbnRzWzBdID0gY29sdW1uMFJvdzA7CiAgICBlbGVtZW50c1sxXSA9IDA7CiAgICBlbGVtZW50c1syXSA9IDA7CiAgICBlbGVtZW50c1szXSA9IDA7CiAgICBlbGVtZW50c1s0XSA9IDA7CiAgICBlbGVtZW50c1s1XSA9IGNvbHVtbjFSb3cxOwogICAgZWxlbWVudHNbNl0gPSAwOwogICAgZWxlbWVudHNbN10gPSAwOwogICAgZWxlbWVudHNbOF0gPSAwOwogICAgZWxlbWVudHNbOV0gPSAwOwogICAgZWxlbWVudHNbMTBdID0gY29sdW1uMlJvdzI7CiAgICBlbGVtZW50c1sxMV0gPSAwOwogICAgZWxlbWVudHNbMTJdID0gY29sdW1uM1JvdzA7CiAgICBlbGVtZW50c1sxM10gPSBjb2x1bW4zUm93MTsKICAgIGVsZW1lbnRzWzE0XSA9IGNvbHVtbjNSb3cyOwogICAgZWxlbWVudHNbMTVdID0gY29sdW1uM1JvdzM7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBzdGF0aWMgZXF1YWxzKGEsIGIpIHsKICAgIHJldHVybiBhLmVxdWFscyhiKTsKICB9CiAgc3RhdGljIG11bHRpcGx5QnlWZWN0b3IobWF0cml4LCB2LCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3I0KCk7CiAgICB9CiAgICByZXN1bHQuY29weSh2KTsKICAgIHJlc3VsdC5hcHBseU1hdHJpeDQobWF0cml4KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHN0YXRpYyBnZXRDb2x1bW4obWF0cml4LCBpbmRleCwgcmVzdWx0KSB7CiAgICBjb25zdCBlbGVtZW50cyA9IG1hdHJpeC5lbGVtZW50czsKICAgIGNvbnN0IHN0YXJ0SW5kZXggPSBpbmRleCAqIDQ7CiAgICBjb25zdCB4ID0gZWxlbWVudHNbc3RhcnRJbmRleF07CiAgICBjb25zdCB5ID0gZWxlbWVudHNbc3RhcnRJbmRleCArIDFdOwogICAgY29uc3QgeiA9IGVsZW1lbnRzW3N0YXJ0SW5kZXggKyAyXTsKICAgIGNvbnN0IHcgPSBlbGVtZW50c1tzdGFydEluZGV4ICsgM107CiAgICByZXN1bHQueCA9IHg7CiAgICByZXN1bHQueSA9IHk7CiAgICByZXN1bHQueiA9IHo7CiAgICByZXN1bHQudyA9IHc7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBzdGF0aWMgZnJvbVRyYW5zbGF0aW9uUXVhdGVybmlvblJvdGF0aW9uU2NhbGUodHJhbnNsYXRpb24sIHJvdGF0aW9uLCBzY2FsZSwgcmVzdWx0KSB7CiAgICBpZiAoIXJlc3VsdCkgewogICAgICByZXN1bHQgPSBuZXcgTWF0cml4NCgpOwogICAgfQogICAgY29uc3Qgc2NhbGVYID0gc2NhbGUueDsKICAgIGNvbnN0IHNjYWxlWSA9IHNjYWxlLnk7CiAgICBjb25zdCBzY2FsZVogPSBzY2FsZS56OwogICAgY29uc3QgeDIgPSByb3RhdGlvbi54ICogcm90YXRpb24ueDsKICAgIGNvbnN0IHh5ID0gcm90YXRpb24ueCAqIHJvdGF0aW9uLnk7CiAgICBjb25zdCB4eiA9IHJvdGF0aW9uLnggKiByb3RhdGlvbi56OwogICAgY29uc3QgeHcgPSByb3RhdGlvbi54ICogcm90YXRpb24udzsKICAgIGNvbnN0IHkyID0gcm90YXRpb24ueSAqIHJvdGF0aW9uLnk7CiAgICBjb25zdCB5eiA9IHJvdGF0aW9uLnkgKiByb3RhdGlvbi56OwogICAgY29uc3QgeXcgPSByb3RhdGlvbi55ICogcm90YXRpb24udzsKICAgIGNvbnN0IHoyID0gcm90YXRpb24ueiAqIHJvdGF0aW9uLno7CiAgICBjb25zdCB6dyA9IHJvdGF0aW9uLnogKiByb3RhdGlvbi53OwogICAgY29uc3QgdzIgPSByb3RhdGlvbi53ICogcm90YXRpb24udzsKICAgIGNvbnN0IG0wMCA9IHgyIC0geTIgLSB6MiArIHcyOwogICAgY29uc3QgbTAxID0gMiAqICh4eSAtIHp3KTsKICAgIGNvbnN0IG0wMiA9IDIgKiAoeHogKyB5dyk7CiAgICBjb25zdCBtMTAgPSAyICogKHh5ICsgencpOwogICAgY29uc3QgbTExID0gLXgyICsgeTIgLSB6MiArIHcyOwogICAgY29uc3QgbTEyID0gMiAqICh5eiAtIHh3KTsKICAgIGNvbnN0IG0yMCA9IDIgKiAoeHogLSB5dyk7CiAgICBjb25zdCBtMjEgPSAyICogKHl6ICsgeHcpOwogICAgY29uc3QgbTIyID0gLXgyIC0geTIgKyB6MiArIHcyOwogICAgY29uc3QgZWxlbWVudHMgPSByZXN1bHQuZWxlbWVudHM7CiAgICBlbGVtZW50c1swXSA9IG0wMCAqIHNjYWxlWDsKICAgIGVsZW1lbnRzWzFdID0gbTEwICogc2NhbGVYOwogICAgZWxlbWVudHNbMl0gPSBtMjAgKiBzY2FsZVg7CiAgICBlbGVtZW50c1szXSA9IDA7CiAgICBlbGVtZW50c1s0XSA9IG0wMSAqIHNjYWxlWTsKICAgIGVsZW1lbnRzWzVdID0gbTExICogc2NhbGVZOwogICAgZWxlbWVudHNbNl0gPSBtMjEgKiBzY2FsZVk7CiAgICBlbGVtZW50c1s3XSA9IDA7CiAgICBlbGVtZW50c1s4XSA9IG0wMiAqIHNjYWxlWjsKICAgIGVsZW1lbnRzWzldID0gbTEyICogc2NhbGVaOwogICAgZWxlbWVudHNbMTBdID0gbTIyICogc2NhbGVaOwogICAgZWxlbWVudHNbMTFdID0gMDsKICAgIGVsZW1lbnRzWzEyXSA9IHRyYW5zbGF0aW9uLng7CiAgICBlbGVtZW50c1sxM10gPSB0cmFuc2xhdGlvbi55OwogICAgZWxlbWVudHNbMTRdID0gdHJhbnNsYXRpb24uejsKICAgIGVsZW1lbnRzWzE1XSA9IDE7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KfQpfX3B1YmxpY0ZpZWxkKFN0YXRpY01hdHJpeDQsICJJREVOVElUWSIsIE9iamVjdC5mcmVlemUobmV3IE1hdHJpeDQoKSkpOwpTdGF0aWNNYXRyaXg0LlpFUk8gPSBPYmplY3QuZnJlZXplKAogIG5ldyBNYXRyaXg0KAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMAogICkKKTsKY29uc3QgVHJhbnNmb3JtcyA9IHt9Owpjb25zdCBzY3JhdGNoSFBSUXVhdGVybmlvbiA9IG5ldyBRdWF0ZXJuaW9uJDEoKTsKY29uc3Qgc2NyYXRjaFNjYWxlJDEgPSBuZXcgVmVjdG9yMyQxKDEsIDEsIDEpOwpjb25zdCBzY3JhdGNoSFBSTWF0cml4NCA9IG5ldyBNYXRyaXg0KCk7CmNvbnN0IHZlY3RvclByb2R1Y3RMb2NhbEZyYW1lID0gewogIHVwOiB7CiAgICBzb3V0aDogImVhc3QiLAogICAgbm9ydGg6ICJ3ZXN0IiwKICAgIHdlc3Q6ICJzb3V0aCIsCiAgICBlYXN0OiAibm9ydGgiCiAgfSwKICBkb3duOiB7CiAgICBzb3V0aDogIndlc3QiLAogICAgbm9ydGg6ICJlYXN0IiwKICAgIHdlc3Q6ICJub3J0aCIsCiAgICBlYXN0OiAic291dGgiCiAgfSwKICBzb3V0aDogewogICAgdXA6ICJ3ZXN0IiwKICAgIGRvd246ICJlYXN0IiwKICAgIHdlc3Q6ICJkb3duIiwKICAgIGVhc3Q6ICJ1cCIKICB9LAogIG5vcnRoOiB7CiAgICB1cDogImVhc3QiLAogICAgZG93bjogIndlc3QiLAogICAgd2VzdDogInVwIiwKICAgIGVhc3Q6ICJkb3duIgogIH0sCiAgd2VzdDogewogICAgdXA6ICJub3J0aCIsCiAgICBkb3duOiAic291dGgiLAogICAgbm9ydGg6ICJkb3duIiwKICAgIHNvdXRoOiAidXAiCiAgfSwKICBlYXN0OiB7CiAgICB1cDogInNvdXRoIiwKICAgIGRvd246ICJub3J0aCIsCiAgICBub3J0aDogInVwIiwKICAgIHNvdXRoOiAiZG93biIKICB9Cn07CmxldCBkZWdlbmVyYXRlUG9zaXRpb25Mb2NhbEZyYW1lID0gewogIG5vcnRoOiBbLTEsIDAsIDBdLAogIGVhc3Q6IFswLCAxLCAwXSwKICB1cDogWzAsIDAsIDFdLAogIHNvdXRoOiBbMSwgMCwgMF0sCiAgd2VzdDogWzAsIC0xLCAwXSwKICBkb3duOiBbMCwgMCwgLTFdCn07CmxldCBsb2NhbEZyYW1lVG9GaXhlZEZyYW1lQ2FjaGUgPSB7fTsKbGV0IHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4gPSB7CiAgZWFzdDogbmV3IFZlY3RvcjMkMSgpLAogIG5vcnRoOiBuZXcgVmVjdG9yMyQxKCksCiAgdXA6IG5ldyBWZWN0b3IzJDEoKSwKICB3ZXN0OiBuZXcgVmVjdG9yMyQxKCksCiAgc291dGg6IG5ldyBWZWN0b3IzJDEoKSwKICBkb3duOiBuZXcgVmVjdG9yMyQxKCkKfTsKbGV0IHNjcmF0Y2hGaXJzdENhcnRlc2lhbiA9IG5ldyBWZWN0b3IzJDEoKTsKbGV0IHNjcmF0Y2hTZWNvbmRDYXJ0ZXNpYW4gPSBuZXcgVmVjdG9yMyQxKCk7CmxldCBzY3JhdGNoVGhpcmRDYXJ0ZXNpYW4gPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IGRlZmluZWQgPSAodmFsdWUpID0+IHsKICByZXR1cm4gdmFsdWUgIT09IHZvaWQgMDsKfTsKY29uc3QgemVyb1ZlY3RvcjMgPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IG1hdGhTaWduID0gKHZhbHVlKSA9PiB7CiAgdmFsdWUgPSArdmFsdWU7CiAgaWYgKHZhbHVlID09PSAwKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIHJldHVybiB2YWx1ZSA+IDAgPyAxIDogLTE7Cn07CmNvbnN0IHNjcmF0Y2hOID0gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBzY3JhdGNoSyA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3QgcmFkaWFuVG9FY2VmID0gZnVuY3Rpb24obG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0ID0gMCwgcmVzdWx0KSB7CiAgY29uc3QgcmFkaWlTcXVhcmVkID0gbmV3IFZlY3RvcjMkMSgKICAgIDYzNzgxMzcgKiA2Mzc4MTM3LAogICAgNjM3ODEzNyAqIDYzNzgxMzcsCiAgICA2MzU2NzUyMzE0MjQ1MTc5ZS05ICogNjM1Njc1MjMxNDI0NTE3OWUtOQogICk7CiAgY29uc3QgY29zTGF0aXR1ZGUgPSBNYXRoLmNvcyhsYXRpdHVkZSk7CiAgc2NyYXRjaE4ueCA9IGNvc0xhdGl0dWRlICogTWF0aC5jb3MobG9uZ2l0dWRlKTsKICBzY3JhdGNoTi55ID0gY29zTGF0aXR1ZGUgKiBNYXRoLnNpbihsb25naXR1ZGUpOwogIHNjcmF0Y2hOLnogPSBNYXRoLnNpbihsYXRpdHVkZSk7CiAgc2NyYXRjaE4ubm9ybWFsaXplKCk7CiAgc2NyYXRjaEsubXVsdGlwbHlWZWN0b3JzKHJhZGlpU3F1YXJlZCwgc2NyYXRjaE4pOwogIGNvbnN0IGdhbW1hID0gTWF0aC5zcXJ0KHNjcmF0Y2hOLmRvdChzY3JhdGNoSykpOwogIHNjcmF0Y2hLLmRpdmlkZVNjYWxhcihnYW1tYSk7CiAgc2NyYXRjaE4ubXVsdGlwbHlTY2FsYXIoaGVpZ2h0KTsKICBpZiAoIWRlZmluZWQocmVzdWx0KSkgewogICAgcmVzdWx0ID0gbmV3IFZlY3RvcjMkMSgpOwogIH0KICByZXR1cm4gcmVzdWx0LmFkZFZlY3RvcnMoc2NyYXRjaEssIHNjcmF0Y2hOKTsKfTsKY29uc3QgbG5nbGF0VG9FY2VmID0gKGxuZywgbGF0LCBoZWlnaHQgPSAwLCByZXN1bHQpID0+IHsKICByZXR1cm4gcmFkaWFuVG9FY2VmKGxuZyAqIE1hdGguUEkgLyAxODAsIGxhdCAqIE1hdGguUEkgLyAxODAsIGhlaWdodCwgcmVzdWx0KTsKfTsKVHJhbnNmb3Jtcy5sbmdsYXRUb0VjZWYgPSBsbmdsYXRUb0VjZWY7ClRyYW5zZm9ybXMucmFkaWFuVG9FY2VmID0gcmFkaWFuVG9FY2VmOwpUcmFuc2Zvcm1zLmxvY2FsRnJhbWVUb0ZpeGVkRnJhbWVHZW5lcmF0b3IgPSBmdW5jdGlvbihmaXJzdEF4aXMsIHNlY29uZEF4aXMpIHsKICBpZiAoIXZlY3RvclByb2R1Y3RMb2NhbEZyYW1lLmhhc093blByb3BlcnR5KGZpcnN0QXhpcykgfHwgIXZlY3RvclByb2R1Y3RMb2NhbEZyYW1lW2ZpcnN0QXhpc10uaGFzT3duUHJvcGVydHkoc2Vjb25kQXhpcykpIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgImZpcnN0QXhpcyBhbmQgc2Vjb25kQXhpcyBtdXN0IGJlIGVhc3QsIG5vcnRoLCB1cCwgd2VzdCwgc291dGggb3IgZG93bi4iCiAgICApOwogIH0KICBsZXQgdGhpcmRBeGlzID0gdmVjdG9yUHJvZHVjdExvY2FsRnJhbWVbZmlyc3RBeGlzXVtzZWNvbmRBeGlzXTsKICBsZXQgcmVzdWx0YXQ7CiAgbGV0IGhhc2hBeGlzID0gZmlyc3RBeGlzICsgc2Vjb25kQXhpczsKICBpZiAoZGVmaW5lZChsb2NhbEZyYW1lVG9GaXhlZEZyYW1lQ2FjaGVbaGFzaEF4aXNdKSkgewogICAgcmVzdWx0YXQgPSBsb2NhbEZyYW1lVG9GaXhlZEZyYW1lQ2FjaGVbaGFzaEF4aXNdOwogIH0gZWxzZSB7CiAgICByZXN1bHRhdCA9IGZ1bmN0aW9uKG9yaWdpbiwgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgICAgaWYgKCFkZWZpbmVkKG9yaWdpbikpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIm9yaWdpbiBpcyByZXF1aXJlZC4iKTsKICAgICAgfQogICAgICBpZiAoIWRlZmluZWQocmVzdWx0KSkgewogICAgICAgIHJlc3VsdCA9IG5ldyBNYXRyaXg0KCk7CiAgICAgIH0KICAgICAgaWYgKG9yaWdpbi5lcXVhbHMoemVyb1ZlY3RvcjMpKSB7CiAgICAgICAgc2NyYXRjaEZpcnN0Q2FydGVzaWFuLmZyb21BcnJheShkZWdlbmVyYXRlUG9zaXRpb25Mb2NhbEZyYW1lW2ZpcnN0QXhpc10pOwogICAgICAgIHNjcmF0Y2hTZWNvbmRDYXJ0ZXNpYW4uZnJvbUFycmF5KGRlZ2VuZXJhdGVQb3NpdGlvbkxvY2FsRnJhbWVbc2Vjb25kQXhpc10pOwogICAgICAgIHNjcmF0Y2hUaGlyZENhcnRlc2lhbi5mcm9tQXJyYXkoZGVnZW5lcmF0ZVBvc2l0aW9uTG9jYWxGcmFtZVt0aGlyZEF4aXNdKTsKICAgICAgfSBlbHNlIGlmIChNYXRoLmFicyhvcmlnaW4ueCkgPCAxZS0xNCAmJiBNYXRoLmFicyhvcmlnaW4ueSkgPCAxZS0xNCkgewogICAgICAgIGxldCBzaWduMiA9IG1hdGhTaWduKG9yaWdpbi56KTsKICAgICAgICBzY3JhdGNoRmlyc3RDYXJ0ZXNpYW4uZnJvbUFycmF5KGRlZ2VuZXJhdGVQb3NpdGlvbkxvY2FsRnJhbWVbZmlyc3RBeGlzXSk7CiAgICAgICAgaWYgKGZpcnN0QXhpcyAhPT0gImVhc3QiICYmIGZpcnN0QXhpcyAhPT0gIndlc3QiKSB7CiAgICAgICAgICBzY3JhdGNoRmlyc3RDYXJ0ZXNpYW4ubXVsdGlwbHlTY2FsYXIoc2lnbjIpOwogICAgICAgIH0KICAgICAgICBzY3JhdGNoU2Vjb25kQ2FydGVzaWFuLmZyb21BcnJheShkZWdlbmVyYXRlUG9zaXRpb25Mb2NhbEZyYW1lW3NlY29uZEF4aXNdKTsKICAgICAgICBpZiAoc2Vjb25kQXhpcyAhPT0gImVhc3QiICYmIHNlY29uZEF4aXMgIT09ICJ3ZXN0IikgewogICAgICAgICAgc2NyYXRjaFNlY29uZENhcnRlc2lhbi5tdWx0aXBseVNjYWxhcihzaWduMik7CiAgICAgICAgfQogICAgICAgIHNjcmF0Y2hUaGlyZENhcnRlc2lhbi5mcm9tQXJyYXkoZGVnZW5lcmF0ZVBvc2l0aW9uTG9jYWxGcmFtZVt0aGlyZEF4aXNdKTsKICAgICAgICBpZiAodGhpcmRBeGlzICE9PSAiZWFzdCIgJiYgdGhpcmRBeGlzICE9PSAid2VzdCIpIHsKICAgICAgICAgIHNjcmF0Y2hUaGlyZENhcnRlc2lhbi5tdWx0aXBseVNjYWxhcihzaWduMik7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGVsbGlwc29pZCA9IGVsbGlwc29pZCB8fCBFbGxpcHNvaWQuV0dTODQ7CiAgICAgICAgZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChvcmlnaW4sIHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4udXApOwogICAgICAgIGxldCB1cCA9IHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4udXA7CiAgICAgICAgbGV0IGVhc3QgPSBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLmVhc3Q7CiAgICAgICAgZWFzdC54ID0gLW9yaWdpbi55OwogICAgICAgIGVhc3QueSA9IG9yaWdpbi54OwogICAgICAgIGVhc3QueiA9IDA7CiAgICAgICAgc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi5lYXN0LmNvcHkoZWFzdCkubm9ybWFsaXplKCk7CiAgICAgICAgc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi5ub3J0aC5jcm9zc1ZlY3RvcnModXAsIGVhc3QpOwogICAgICAgIHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4uZG93bi5jb3B5KHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW4udXApLm11bHRpcGx5U2NhbGFyKC0xKTsKICAgICAgICBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLndlc3QuY29weShzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLmVhc3QpLm11bHRpcGx5U2NhbGFyKC0xKTsKICAgICAgICBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuLnNvdXRoLmNvcHkoc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbi5ub3J0aCkubXVsdGlwbHlTY2FsYXIoLTEpOwogICAgICAgIHNjcmF0Y2hGaXJzdENhcnRlc2lhbiA9IHNjcmF0Y2hDYWxjdWxhdGVDYXJ0ZXNpYW5bZmlyc3RBeGlzXTsKICAgICAgICBzY3JhdGNoU2Vjb25kQ2FydGVzaWFuID0gc2NyYXRjaENhbGN1bGF0ZUNhcnRlc2lhbltzZWNvbmRBeGlzXTsKICAgICAgICBzY3JhdGNoVGhpcmRDYXJ0ZXNpYW4gPSBzY3JhdGNoQ2FsY3VsYXRlQ2FydGVzaWFuW3RoaXJkQXhpc107CiAgICAgIH0KICAgICAgY29uc3QgZWxlbWVudHMgPSByZXN1bHQuZWxlbWVudHM7CiAgICAgIGVsZW1lbnRzWzBdID0gc2NyYXRjaEZpcnN0Q2FydGVzaWFuLng7CiAgICAgIGVsZW1lbnRzWzFdID0gc2NyYXRjaEZpcnN0Q2FydGVzaWFuLnk7CiAgICAgIGVsZW1lbnRzWzJdID0gc2NyYXRjaEZpcnN0Q2FydGVzaWFuLno7CiAgICAgIGVsZW1lbnRzWzNdID0gMDsKICAgICAgZWxlbWVudHNbNF0gPSBzY3JhdGNoU2Vjb25kQ2FydGVzaWFuLng7CiAgICAgIGVsZW1lbnRzWzVdID0gc2NyYXRjaFNlY29uZENhcnRlc2lhbi55OwogICAgICBlbGVtZW50c1s2XSA9IHNjcmF0Y2hTZWNvbmRDYXJ0ZXNpYW4uejsKICAgICAgZWxlbWVudHNbN10gPSAwOwogICAgICBlbGVtZW50c1s4XSA9IHNjcmF0Y2hUaGlyZENhcnRlc2lhbi54OwogICAgICBlbGVtZW50c1s5XSA9IHNjcmF0Y2hUaGlyZENhcnRlc2lhbi55OwogICAgICBlbGVtZW50c1sxMF0gPSBzY3JhdGNoVGhpcmRDYXJ0ZXNpYW4uejsKICAgICAgZWxlbWVudHNbMTFdID0gMDsKICAgICAgZWxlbWVudHNbMTJdID0gb3JpZ2luLng7CiAgICAgIGVsZW1lbnRzWzEzXSA9IG9yaWdpbi55OwogICAgICBlbGVtZW50c1sxNF0gPSBvcmlnaW4uejsKICAgICAgZWxlbWVudHNbMTVdID0gMTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgICBsb2NhbEZyYW1lVG9GaXhlZEZyYW1lQ2FjaGVbaGFzaEF4aXNdID0gcmVzdWx0YXQ7CiAgfQogIHJldHVybiByZXN1bHRhdDsKfTsKVHJhbnNmb3Jtcy5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZSA9IFRyYW5zZm9ybXMubG9jYWxGcmFtZVRvRml4ZWRGcmFtZUdlbmVyYXRvcigKICAiZWFzdCIsCiAgIm5vcnRoIgopOwpUcmFuc2Zvcm1zLmhlYWRpbmdQaXRjaFJvbGxUb0ZpeGVkRnJhbWUgPSBmdW5jdGlvbihvcmlnaW4sIGhlYWRpbmdQaXRjaFJvbGwsIGVsbGlwc29pZCwgZml4ZWRGcmFtZVRyYW5zZm9ybSwgcmVzdWx0KSB7CiAgZml4ZWRGcmFtZVRyYW5zZm9ybSA9IGZpeGVkRnJhbWVUcmFuc2Zvcm0gfHwgVHJhbnNmb3Jtcy5lYXN0Tm9ydGhVcFRvRml4ZWRGcmFtZTsKICBjb25zdCBocHJRdWF0ZXJuaW9uID0gU3RhdGljUXVhdGVybmlvbi5mcm9tSGVhZGluZ1BpdGNoUm9sbCgKICAgIGhlYWRpbmdQaXRjaFJvbGwsCiAgICBzY3JhdGNoSFBSUXVhdGVybmlvbgogICk7CiAgY29uc3QgaHByTWF0cml4ID0gU3RhdGljTWF0cml4NC5mcm9tVHJhbnNsYXRpb25RdWF0ZXJuaW9uUm90YXRpb25TY2FsZSgKICAgIENhcnRlc2lhbjMuWkVSTywKICAgIGhwclF1YXRlcm5pb24sCiAgICBzY3JhdGNoU2NhbGUkMSwKICAgIHNjcmF0Y2hIUFJNYXRyaXg0CiAgKTsKICByZXN1bHQgPSBmaXhlZEZyYW1lVHJhbnNmb3JtKG9yaWdpbiwgZWxsaXBzb2lkLCByZXN1bHQpOwogIHJldHVybiByZXN1bHQubXVsdGlwbHkoaHByTWF0cml4KTsKfTsKVHJhbnNmb3Jtcy5ub3J0aEVhc3REb3duVG9GaXhlZEZyYW1lID0gVHJhbnNmb3Jtcy5sb2NhbEZyYW1lVG9GaXhlZEZyYW1lR2VuZXJhdG9yKAogICJub3J0aCIsCiAgImVhc3QiCik7ClRyYW5zZm9ybXMubm9ydGhVcEVhc3RUb0ZpeGVkRnJhbWUgPSBUcmFuc2Zvcm1zLmxvY2FsRnJhbWVUb0ZpeGVkRnJhbWVHZW5lcmF0b3IoCiAgIm5vcnRoIiwKICAidXAiCik7ClRyYW5zZm9ybXMubm9ydGhXZXN0VXBUb0ZpeGVkRnJhbWUgPSBUcmFuc2Zvcm1zLmxvY2FsRnJhbWVUb0ZpeGVkRnJhbWVHZW5lcmF0b3IoCiAgIm5vcnRoIiwKICAid2VzdCIKKTsKZnVuY3Rpb24gSW50ZXJ2YWwoc3RhcnQsIHN0b3ApIHsKICB0aGlzLnN0YXJ0ID0gZGVmYXVsdFZhbHVlKHN0YXJ0LCAwKTsKICB0aGlzLnN0b3AgPSBkZWZhdWx0VmFsdWUoc3RvcCwgMCk7Cn0KY2xhc3MgU3RhdGljTWF0cml4MyB7CiAgc3RhdGljIGZyb21RdWF0ZXJuaW9uKHF1YXRlcm5pb24sIHJlc3VsdCkgewogICAgY29uc3QgeDIgPSBxdWF0ZXJuaW9uLnggKiBxdWF0ZXJuaW9uLng7CiAgICBjb25zdCB4eSA9IHF1YXRlcm5pb24ueCAqIHF1YXRlcm5pb24ueTsKICAgIGNvbnN0IHh6ID0gcXVhdGVybmlvbi54ICogcXVhdGVybmlvbi56OwogICAgY29uc3QgeHcgPSBxdWF0ZXJuaW9uLnggKiBxdWF0ZXJuaW9uLnc7CiAgICBjb25zdCB5MiA9IHF1YXRlcm5pb24ueSAqIHF1YXRlcm5pb24ueTsKICAgIGNvbnN0IHl6ID0gcXVhdGVybmlvbi55ICogcXVhdGVybmlvbi56OwogICAgY29uc3QgeXcgPSBxdWF0ZXJuaW9uLnkgKiBxdWF0ZXJuaW9uLnc7CiAgICBjb25zdCB6MiA9IHF1YXRlcm5pb24ueiAqIHF1YXRlcm5pb24uejsKICAgIGNvbnN0IHp3ID0gcXVhdGVybmlvbi56ICogcXVhdGVybmlvbi53OwogICAgY29uc3QgdzIgPSBxdWF0ZXJuaW9uLncgKiBxdWF0ZXJuaW9uLnc7CiAgICBjb25zdCBtMDAgPSB4MiAtIHkyIC0gejIgKyB3MjsKICAgIGNvbnN0IG0wMSA9IDIgKiAoeHkgLSB6dyk7CiAgICBjb25zdCBtMDIgPSAyICogKHh6ICsgeXcpOwogICAgY29uc3QgbTEwID0gMiAqICh4eSArIHp3KTsKICAgIGNvbnN0IG0xMSA9IC14MiArIHkyIC0gejIgKyB3MjsKICAgIGNvbnN0IG0xMiA9IDIgKiAoeXogLSB4dyk7CiAgICBjb25zdCBtMjAgPSAyICogKHh6IC0geXcpOwogICAgY29uc3QgbTIxID0gMiAqICh5eiArIHh3KTsKICAgIGNvbnN0IG0yMiA9IC14MiAtIHkyICsgejIgKyB3MjsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBNYXRyaXgzKCk7CiAgICB9CiAgICByZXN1bHQuc2V0KG0wMCwgbTAxLCBtMDIsIG0xMCwgbTExLCBtMTIsIG0yMCwgbTIxLCBtMjIpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc3RhdGljIGdldENvbHVtbihtYXRyaXgsIGluZGV4LCByZXN1bHQpIHsKICAgIGNvbnN0IGVsZW1lbnRzID0gbWF0cml4LmVsZW1lbnRzOwogICAgY29uc3Qgc3RhcnRJbmRleCA9IGluZGV4ICogMzsKICAgIGNvbnN0IHggPSBlbGVtZW50c1tzdGFydEluZGV4XTsKICAgIGNvbnN0IHkgPSBlbGVtZW50c1tzdGFydEluZGV4ICsgMV07CiAgICBjb25zdCB6ID0gZWxlbWVudHNbc3RhcnRJbmRleCArIDJdOwogICAgcmVzdWx0LnggPSB4OwogICAgcmVzdWx0LnkgPSB5OwogICAgcmVzdWx0LnogPSB6OwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc3RhdGljIG11bHRpcGx5QnlWZWN0b3IobWF0cml4LCB2LCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3IzJDEoKTsKICAgIH0KICAgIHJlc3VsdC5jb3B5KHYpOwogICAgcmVzdWx0LmFwcGx5TWF0cml4MyhtYXRyaXgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc3RhdGljIG11bHRpcGx5QnlTY2FsZShtYXRyaXgsIHNjYWxlLCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBNYXRyaXgzKCk7CiAgICB9CiAgICBjb25zdCBlbGVtZW50cyA9IHJlc3VsdC5lbGVtZW50czsKICAgIGNvbnN0IG1hdHJpeEVsZW1lbnRzID0gbWF0cml4LmVsZW1lbnRzOwogICAgZWxlbWVudHNbMF0gPSBtYXRyaXhFbGVtZW50c1swXSAqIHNjYWxlLng7CiAgICBlbGVtZW50c1sxXSA9IG1hdHJpeEVsZW1lbnRzWzFdICogc2NhbGUueDsKICAgIGVsZW1lbnRzWzJdID0gbWF0cml4RWxlbWVudHNbMl0gKiBzY2FsZS54OwogICAgZWxlbWVudHNbM10gPSBtYXRyaXhFbGVtZW50c1szXSAqIHNjYWxlLnk7CiAgICBlbGVtZW50c1s0XSA9IG1hdHJpeEVsZW1lbnRzWzRdICogc2NhbGUueTsKICAgIGVsZW1lbnRzWzVdID0gbWF0cml4RWxlbWVudHNbNV0gKiBzY2FsZS55OwogICAgZWxlbWVudHNbNl0gPSBtYXRyaXhFbGVtZW50c1s2XSAqIHNjYWxlLno7CiAgICBlbGVtZW50c1s3XSA9IG1hdHJpeEVsZW1lbnRzWzddICogc2NhbGUuejsKICAgIGVsZW1lbnRzWzhdID0gbWF0cml4RWxlbWVudHNbOF0gKiBzY2FsZS56OwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc3RhdGljIHRyYW5zcG9zZShtLCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBNYXRyaXgzKCk7CiAgICB9CiAgICByZXN1bHQuY29weShtKS50cmFuc3Bvc2UoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHN0YXRpYyBmcm9tU2NhbGUoc2NhbGUsIHJlc3VsdCkgewogICAgaWYgKCFyZXN1bHQpIHsKICAgICAgcmVzdWx0ID0gbmV3IE1hdHJpeDMoKTsKICAgIH0KICAgIGNvbnN0IGVsZW1lbnRzID0gcmVzdWx0LmVsZW1lbnRzOwogICAgZWxlbWVudHNbMF0gPSBzY2FsZS54OwogICAgZWxlbWVudHNbMV0gPSAwOwogICAgZWxlbWVudHNbMl0gPSAwOwogICAgZWxlbWVudHNbM10gPSAwOwogICAgZWxlbWVudHNbNF0gPSBzY2FsZS55OwogICAgZWxlbWVudHNbNV0gPSAwOwogICAgZWxlbWVudHNbNl0gPSAwOwogICAgZWxlbWVudHNbN10gPSAwOwogICAgZWxlbWVudHNbOF0gPSBzY2FsZS56OwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc3RhdGljIG11bHRpcGx5KGEsIGIsIHJlc3VsdCkgewogICAgaWYgKCFyZXN1bHQpIHsKICAgICAgcmVzdWx0ID0gbmV3IE1hdHJpeDMoKTsKICAgIH0KICAgIGNvbnN0IGFlID0gYS5lbGVtZW50czsKICAgIGNvbnN0IGJlID0gYi5lbGVtZW50czsKICAgIGNvbnN0IHRlID0gcmVzdWx0LmVsZW1lbnRzOwogICAgY29uc3QgYTExID0gYWVbMF07CiAgICBjb25zdCBhMTIgPSBhZVszXTsKICAgIGNvbnN0IGExMyA9IGFlWzZdOwogICAgY29uc3QgYTIxID0gYWVbMV07CiAgICBjb25zdCBhMjIgPSBhZVs0XTsKICAgIGNvbnN0IGEyMyA9IGFlWzddOwogICAgY29uc3QgYTMxID0gYWVbMl07CiAgICBjb25zdCBhMzIgPSBhZVs1XTsKICAgIGNvbnN0IGEzMyA9IGFlWzhdOwogICAgY29uc3QgYjExID0gYmVbMF07CiAgICBjb25zdCBiMTIgPSBiZVszXTsKICAgIGNvbnN0IGIxMyA9IGJlWzZdOwogICAgY29uc3QgYjIxID0gYmVbMV07CiAgICBjb25zdCBiMjIgPSBiZVs0XTsKICAgIGNvbnN0IGIyMyA9IGJlWzddOwogICAgY29uc3QgYjMxID0gYmVbMl07CiAgICBjb25zdCBiMzIgPSBiZVs1XTsKICAgIGNvbnN0IGIzMyA9IGJlWzhdOwogICAgdGVbMF0gPSBhMTEgKiBiMTEgKyBhMTIgKiBiMjEgKyBhMTMgKiBiMzE7CiAgICB0ZVszXSA9IGExMSAqIGIxMiArIGExMiAqIGIyMiArIGExMyAqIGIzMjsKICAgIHRlWzZdID0gYTExICogYjEzICsgYTEyICogYjIzICsgYTEzICogYjMzOwogICAgdGVbMV0gPSBhMjEgKiBiMTEgKyBhMjIgKiBiMjEgKyBhMjMgKiBiMzE7CiAgICB0ZVs0XSA9IGEyMSAqIGIxMiArIGEyMiAqIGIyMiArIGEyMyAqIGIzMjsKICAgIHRlWzddID0gYTIxICogYjEzICsgYTIyICogYjIzICsgYTIzICogYjMzOwogICAgdGVbMl0gPSBhMzEgKiBiMTEgKyBhMzIgKiBiMjEgKyBhMzMgKiBiMzE7CiAgICB0ZVs1XSA9IGEzMSAqIGIxMiArIGEzMiAqIGIyMiArIGEzMyAqIGIzMjsKICAgIHRlWzhdID0gYTMxICogYjEzICsgYTMyICogYjIzICsgYTMzICogYjMzOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc3RhdGljIGNsb25lKG1hdHJpeCwgcmVzdWx0KSB7CiAgICBpZiAoIWRlZmluZWQkMShtYXRyaXgpKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBpZiAoIWRlZmluZWQkMShyZXN1bHQpKSB7CiAgICAgIHJldHVybiBuZXcgTWF0cml4MygKICAgICAgICBtYXRyaXhbMF0sCiAgICAgICAgbWF0cml4WzNdLAogICAgICAgIG1hdHJpeFs2XSwKICAgICAgICBtYXRyaXhbMV0sCiAgICAgICAgbWF0cml4WzRdLAogICAgICAgIG1hdHJpeFs3XSwKICAgICAgICBtYXRyaXhbMl0sCiAgICAgICAgbWF0cml4WzVdLAogICAgICAgIG1hdHJpeFs4XQogICAgICApOwogICAgfQogICAgcmVzdWx0LmNsb25lKG1hdHJpeCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBzdGF0aWMgc2V0Q29sdW1uKG1hdHJpeCwgaW5kZXgsIGNhcnRlc2lhbiwgcmVzdWx0KSB7CiAgICByZXN1bHQgPSBTdGF0aWNNYXRyaXgzLmNsb25lKG1hdHJpeCwgcmVzdWx0KTsKICAgIGNvbnN0IGVsZW1lbnRzID0gcmVzdWx0LmVsZW1lbnRzOwogICAgY29uc3Qgc3RhcnRJbmRleCA9IGluZGV4ICogMzsKICAgIGVsZW1lbnRzW3N0YXJ0SW5kZXhdID0gY2FydGVzaWFuLng7CiAgICBlbGVtZW50c1tzdGFydEluZGV4ICsgMV0gPSBjYXJ0ZXNpYW4ueTsKICAgIGVsZW1lbnRzW3N0YXJ0SW5kZXggKyAyXSA9IGNhcnRlc2lhbi56OwogICAgcmV0dXJuIHJlc3VsdDsKICB9Cn0KU3RhdGljTWF0cml4My5aRVJPID0gTWF0cml4My5aRVJPID0gT2JqZWN0LmZyZWV6ZSgKICBuZXcgTWF0cml4MygwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwKQopOwpTdGF0aWNNYXRyaXgzLkNPTFVNTjBST1cwID0gMDsKU3RhdGljTWF0cml4My5DT0xVTU4wUk9XMSA9IDE7ClN0YXRpY01hdHJpeDMuQ09MVU1OMFJPVzIgPSAyOwpTdGF0aWNNYXRyaXgzLkNPTFVNTjFST1cwID0gMzsKU3RhdGljTWF0cml4My5DT0xVTU4xUk9XMSA9IDQ7ClN0YXRpY01hdHJpeDMuQ09MVU1OMVJPVzIgPSA1OwpTdGF0aWNNYXRyaXgzLkNPTFVNTjJST1cwID0gNjsKU3RhdGljTWF0cml4My5DT0xVTU4yUk9XMSA9IDc7ClN0YXRpY01hdHJpeDMuQ09MVU1OMlJPVzIgPSA4Owp2YXIgUXVhZHJhdGljUmVhbFBvbHlub21pYWwgPSB7fTsKUXVhZHJhdGljUmVhbFBvbHlub21pYWwuY29tcHV0ZURpc2NyaW1pbmFudCA9IGZ1bmN0aW9uKGEsIGIsIGMpIHsKICBpZiAodHlwZW9mIGEgIT09ICJudW1iZXIiKSB7CiAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoImEgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgfQogIGlmICh0eXBlb2YgYiAhPT0gIm51bWJlciIpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigiYiBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICB9CiAgaWYgKHR5cGVvZiBjICE9PSAibnVtYmVyIikgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJjIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogIH0KICB2YXIgZGlzY3JpbWluYW50ID0gYiAqIGIgLSA0ICogYSAqIGM7CiAgcmV0dXJuIGRpc2NyaW1pbmFudDsKfTsKZnVuY3Rpb24gYWRkV2l0aENhbmNlbGxhdGlvbkNoZWNrJDEobGVmdCwgcmlnaHQsIHRvbGVyYW5jZSkgewogIHZhciBkaWZmZXJlbmNlID0gbGVmdCArIHJpZ2h0OwogIGlmIChDZXNpdW1NYXRoLnNpZ24obGVmdCkgIT09IENlc2l1bU1hdGguc2lnbihyaWdodCkgJiYgTWF0aC5hYnMoZGlmZmVyZW5jZSAvIE1hdGgubWF4KE1hdGguYWJzKGxlZnQpLCBNYXRoLmFicyhyaWdodCkpKSA8IHRvbGVyYW5jZSkgewogICAgcmV0dXJuIDA7CiAgfQogIHJldHVybiBkaWZmZXJlbmNlOwp9ClF1YWRyYXRpY1JlYWxQb2x5bm9taWFsLmNvbXB1dGVSZWFsUm9vdHMgPSBmdW5jdGlvbihhLCBiLCBjKSB7CiAgaWYgKHR5cGVvZiBhICE9PSAibnVtYmVyIikgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJhIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogIH0KICBpZiAodHlwZW9mIGIgIT09ICJudW1iZXIiKSB7CiAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoImIgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgfQogIGlmICh0eXBlb2YgYyAhPT0gIm51bWJlciIpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigiYyBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICB9CiAgdmFyIHJhdGlvOwogIGlmIChhID09PSAwKSB7CiAgICBpZiAoYiA9PT0gMCkgewogICAgICByZXR1cm4gW107CiAgICB9CiAgICByZXR1cm4gWy1jIC8gYl07CiAgfSBlbHNlIGlmIChiID09PSAwKSB7CiAgICBpZiAoYyA9PT0gMCkgewogICAgICByZXR1cm4gWzAsIDBdOwogICAgfQogICAgdmFyIGNNYWduaXR1ZGUgPSBNYXRoLmFicyhjKTsKICAgIHZhciBhTWFnbml0dWRlID0gTWF0aC5hYnMoYSk7CiAgICBpZiAoY01hZ25pdHVkZSA8IGFNYWduaXR1ZGUgJiYgY01hZ25pdHVkZSAvIGFNYWduaXR1ZGUgPCBDZXNpdW1NYXRoLkVQU0lMT04xNCkgewogICAgICByZXR1cm4gWzAsIDBdOwogICAgfSBlbHNlIGlmIChjTWFnbml0dWRlID4gYU1hZ25pdHVkZSAmJiBhTWFnbml0dWRlIC8gY01hZ25pdHVkZSA8IENlc2l1bU1hdGguRVBTSUxPTjE0KSB7CiAgICAgIHJldHVybiBbXTsKICAgIH0KICAgIHJhdGlvID0gLWMgLyBhOwogICAgaWYgKHJhdGlvIDwgMCkgewogICAgICByZXR1cm4gW107CiAgICB9CiAgICB2YXIgcm9vdCA9IE1hdGguc3FydChyYXRpbyk7CiAgICByZXR1cm4gWy1yb290LCByb290XTsKICB9IGVsc2UgaWYgKGMgPT09IDApIHsKICAgIHJhdGlvID0gLWIgLyBhOwogICAgaWYgKHJhdGlvIDwgMCkgewogICAgICByZXR1cm4gW3JhdGlvLCAwXTsKICAgIH0KICAgIHJldHVybiBbMCwgcmF0aW9dOwogIH0KICB2YXIgYjIgPSBiICogYjsKICB2YXIgZm91cl9hYyA9IDQgKiBhICogYzsKICB2YXIgcmFkaWNhbmQgPSBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2skMShiMiwgLWZvdXJfYWMsIENlc2l1bU1hdGguRVBTSUxPTjE0KTsKICBpZiAocmFkaWNhbmQgPCAwKSB7CiAgICByZXR1cm4gW107CiAgfQogIHZhciBxID0gLTAuNSAqIGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjayQxKAogICAgYiwKICAgIENlc2l1bU1hdGguc2lnbihiKSAqIE1hdGguc3FydChyYWRpY2FuZCksCiAgICBDZXNpdW1NYXRoLkVQU0lMT04xNAogICk7CiAgaWYgKGIgPiAwKSB7CiAgICByZXR1cm4gW3EgLyBhLCBjIC8gcV07CiAgfQogIHJldHVybiBbYyAvIHEsIHEgLyBhXTsKfTsKdmFyIEN1YmljUmVhbFBvbHlub21pYWwgPSB7fTsKQ3ViaWNSZWFsUG9seW5vbWlhbC5jb21wdXRlRGlzY3JpbWluYW50ID0gZnVuY3Rpb24oYSwgYiwgYywgZCkgewogIGlmICh0eXBlb2YgYSAhPT0gIm51bWJlciIpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigiYSBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICB9CiAgaWYgKHR5cGVvZiBiICE9PSAibnVtYmVyIikgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJiIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogIH0KICBpZiAodHlwZW9mIGMgIT09ICJudW1iZXIiKSB7CiAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoImMgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgfQogIGlmICh0eXBlb2YgZCAhPT0gIm51bWJlciIpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigiZCBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICB9CiAgdmFyIGEyID0gYSAqIGE7CiAgdmFyIGIyID0gYiAqIGI7CiAgdmFyIGMyID0gYyAqIGM7CiAgdmFyIGQyID0gZCAqIGQ7CiAgdmFyIGRpc2NyaW1pbmFudCA9IDE4ICogYSAqIGIgKiBjICogZCArIGIyICogYzIgLSAyNyAqIGEyICogZDIgLSA0ICogKGEgKiBjMiAqIGMgKyBiMiAqIGIgKiBkKTsKICByZXR1cm4gZGlzY3JpbWluYW50Owp9OwpmdW5jdGlvbiBjb21wdXRlUmVhbFJvb3RzKGEsIGIsIGMsIGQpIHsKICB2YXIgQTIgPSBhOwogIHZhciBCID0gYiAvIDM7CiAgdmFyIEMgPSBjIC8gMzsKICB2YXIgRCA9IGQ7CiAgdmFyIEFDID0gQTIgKiBDOwogIHZhciBCRCA9IEIgKiBEOwogIHZhciBCMiA9IEIgKiBCOwogIHZhciBDMiA9IEMgKiBDOwogIHZhciBkZWx0YTEgPSBBMiAqIEMgLSBCMjsKICB2YXIgZGVsdGEyID0gQTIgKiBEIC0gQiAqIEM7CiAgdmFyIGRlbHRhMyA9IEIgKiBEIC0gQzI7CiAgdmFyIGRpc2NyaW1pbmFudCA9IDQgKiBkZWx0YTEgKiBkZWx0YTMgLSBkZWx0YTIgKiBkZWx0YTI7CiAgdmFyIHRlbXA7CiAgdmFyIHRlbXAxOwogIGlmIChkaXNjcmltaW5hbnQgPCAwKSB7CiAgICB2YXIgQUJhcjsKICAgIHZhciBDQmFyOwogICAgdmFyIERCYXI7CiAgICBpZiAoQjIgKiBCRCA+PSBBQyAqIEMyKSB7CiAgICAgIEFCYXIgPSBBMjsKICAgICAgQ0JhciA9IGRlbHRhMTsKICAgICAgREJhciA9IC0yICogQiAqIGRlbHRhMSArIEEyICogZGVsdGEyOwogICAgfSBlbHNlIHsKICAgICAgQUJhciA9IEQ7CiAgICAgIENCYXIgPSBkZWx0YTM7CiAgICAgIERCYXIgPSAtRCAqIGRlbHRhMiArIDIgKiBDICogZGVsdGEzOwogICAgfQogICAgdmFyIHMgPSBEQmFyIDwgMCA/IC0xIDogMTsKICAgIHZhciB0ZW1wMCA9IC1zICogTWF0aC5hYnMoQUJhcikgKiBNYXRoLnNxcnQoLWRpc2NyaW1pbmFudCk7CiAgICB0ZW1wMSA9IC1EQmFyICsgdGVtcDA7CiAgICB2YXIgeCA9IHRlbXAxIC8gMjsKICAgIHZhciBwID0geCA8IDAgPyAtTWF0aC5wb3coLXgsIDEgLyAzKSA6IE1hdGgucG93KHgsIDEgLyAzKTsKICAgIHZhciBxID0gdGVtcDEgPT09IHRlbXAwID8gLXAgOiAtQ0JhciAvIHA7CiAgICB0ZW1wID0gQ0JhciA8PSAwID8gcCArIHEgOiAtREJhciAvIChwICogcCArIHEgKiBxICsgQ0Jhcik7CiAgICBpZiAoQjIgKiBCRCA+PSBBQyAqIEMyKSB7CiAgICAgIHJldHVybiBbKHRlbXAgLSBCKSAvIEEyXTsKICAgIH0KICAgIHJldHVybiBbLUQgLyAodGVtcCArIEMpXTsKICB9CiAgdmFyIENCYXJBID0gZGVsdGExOwogIHZhciBEQmFyQSA9IC0yICogQiAqIGRlbHRhMSArIEEyICogZGVsdGEyOwogIHZhciBDQmFyRCA9IGRlbHRhMzsKICB2YXIgREJhckQgPSAtRCAqIGRlbHRhMiArIDIgKiBDICogZGVsdGEzOwogIHZhciBzcXVhcmVSb290T2ZEaXNjcmltaW5hbnQgPSBNYXRoLnNxcnQoZGlzY3JpbWluYW50KTsKICB2YXIgaGFsZlNxdWFyZVJvb3RPZjMgPSBNYXRoLnNxcnQoMykgLyAyOwogIHZhciB0aGV0YSA9IE1hdGguYWJzKE1hdGguYXRhbjIoQTIgKiBzcXVhcmVSb290T2ZEaXNjcmltaW5hbnQsIC1EQmFyQSkgLyAzKTsKICB0ZW1wID0gMiAqIE1hdGguc3FydCgtQ0JhckEpOwogIHZhciBjb3NpbmUgPSBNYXRoLmNvcyh0aGV0YSk7CiAgdGVtcDEgPSB0ZW1wICogY29zaW5lOwogIHZhciB0ZW1wMyA9IHRlbXAgKiAoLWNvc2luZSAvIDIgLSBoYWxmU3F1YXJlUm9vdE9mMyAqIE1hdGguc2luKHRoZXRhKSk7CiAgdmFyIG51bWVyYXRvckxhcmdlID0gdGVtcDEgKyB0ZW1wMyA+IDIgKiBCID8gdGVtcDEgLSBCIDogdGVtcDMgLSBCOwogIHZhciBkZW5vbWluYXRvckxhcmdlID0gQTI7CiAgdmFyIHJvb3QxID0gbnVtZXJhdG9yTGFyZ2UgLyBkZW5vbWluYXRvckxhcmdlOwogIHRoZXRhID0gTWF0aC5hYnMoTWF0aC5hdGFuMihEICogc3F1YXJlUm9vdE9mRGlzY3JpbWluYW50LCAtREJhckQpIC8gMyk7CiAgdGVtcCA9IDIgKiBNYXRoLnNxcnQoLUNCYXJEKTsKICBjb3NpbmUgPSBNYXRoLmNvcyh0aGV0YSk7CiAgdGVtcDEgPSB0ZW1wICogY29zaW5lOwogIHRlbXAzID0gdGVtcCAqICgtY29zaW5lIC8gMiAtIGhhbGZTcXVhcmVSb290T2YzICogTWF0aC5zaW4odGhldGEpKTsKICB2YXIgbnVtZXJhdG9yU21hbGwgPSAtRDsKICB2YXIgZGVub21pbmF0b3JTbWFsbCA9IHRlbXAxICsgdGVtcDMgPCAyICogQyA/IHRlbXAxICsgQyA6IHRlbXAzICsgQzsKICB2YXIgcm9vdDMgPSBudW1lcmF0b3JTbWFsbCAvIGRlbm9taW5hdG9yU21hbGw7CiAgdmFyIEUgPSBkZW5vbWluYXRvckxhcmdlICogZGVub21pbmF0b3JTbWFsbDsKICB2YXIgRiA9IC1udW1lcmF0b3JMYXJnZSAqIGRlbm9taW5hdG9yU21hbGwgLSBkZW5vbWluYXRvckxhcmdlICogbnVtZXJhdG9yU21hbGw7CiAgdmFyIEcgPSBudW1lcmF0b3JMYXJnZSAqIG51bWVyYXRvclNtYWxsOwogIHZhciByb290MiA9IChDICogRiAtIEIgKiBHKSAvICgtQiAqIEYgKyBDICogRSk7CiAgaWYgKHJvb3QxIDw9IHJvb3QyKSB7CiAgICBpZiAocm9vdDEgPD0gcm9vdDMpIHsKICAgICAgaWYgKHJvb3QyIDw9IHJvb3QzKSB7CiAgICAgICAgcmV0dXJuIFtyb290MSwgcm9vdDIsIHJvb3QzXTsKICAgICAgfQogICAgICByZXR1cm4gW3Jvb3QxLCByb290Mywgcm9vdDJdOwogICAgfQogICAgcmV0dXJuIFtyb290Mywgcm9vdDEsIHJvb3QyXTsKICB9CiAgaWYgKHJvb3QxIDw9IHJvb3QzKSB7CiAgICByZXR1cm4gW3Jvb3QyLCByb290MSwgcm9vdDNdOwogIH0KICBpZiAocm9vdDIgPD0gcm9vdDMpIHsKICAgIHJldHVybiBbcm9vdDIsIHJvb3QzLCByb290MV07CiAgfQogIHJldHVybiBbcm9vdDMsIHJvb3QyLCByb290MV07Cn0KQ3ViaWNSZWFsUG9seW5vbWlhbC5jb21wdXRlUmVhbFJvb3RzID0gZnVuY3Rpb24oYSwgYiwgYywgZCkgewogIGlmICh0eXBlb2YgYSAhPT0gIm51bWJlciIpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigiYSBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICB9CiAgaWYgKHR5cGVvZiBiICE9PSAibnVtYmVyIikgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJiIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogIH0KICBpZiAodHlwZW9mIGMgIT09ICJudW1iZXIiKSB7CiAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoImMgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgfQogIGlmICh0eXBlb2YgZCAhPT0gIm51bWJlciIpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigiZCBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICB9CiAgdmFyIHJvb3RzOwogIHZhciByYXRpbzsKICBpZiAoYSA9PT0gMCkgewogICAgcmV0dXJuIFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsLmNvbXB1dGVSZWFsUm9vdHMoYiwgYywgZCk7CiAgfSBlbHNlIGlmIChiID09PSAwKSB7CiAgICBpZiAoYyA9PT0gMCkgewogICAgICBpZiAoZCA9PT0gMCkgewogICAgICAgIHJldHVybiBbMCwgMCwgMF07CiAgICAgIH0KICAgICAgcmF0aW8gPSAtZCAvIGE7CiAgICAgIHZhciByb290ID0gcmF0aW8gPCAwID8gLU1hdGgucG93KC1yYXRpbywgMSAvIDMpIDogTWF0aC5wb3cocmF0aW8sIDEgLyAzKTsKICAgICAgcmV0dXJuIFtyb290LCByb290LCByb290XTsKICAgIH0gZWxzZSBpZiAoZCA9PT0gMCkgewogICAgICByb290cyA9IFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsLmNvbXB1dGVSZWFsUm9vdHMoYSwgMCwgYyk7CiAgICAgIGlmIChyb290cy5MZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gWzBdOwogICAgICB9CiAgICAgIHJldHVybiBbcm9vdHNbMF0sIDAsIHJvb3RzWzFdXTsKICAgIH0KICAgIHJldHVybiBjb21wdXRlUmVhbFJvb3RzKGEsIDAsIGMsIGQpOwogIH0gZWxzZSBpZiAoYyA9PT0gMCkgewogICAgaWYgKGQgPT09IDApIHsKICAgICAgcmF0aW8gPSAtYiAvIGE7CiAgICAgIGlmIChyYXRpbyA8IDApIHsKICAgICAgICByZXR1cm4gW3JhdGlvLCAwLCAwXTsKICAgICAgfQogICAgICByZXR1cm4gWzAsIDAsIHJhdGlvXTsKICAgIH0KICAgIHJldHVybiBjb21wdXRlUmVhbFJvb3RzKGEsIGIsIDAsIGQpOwogIH0gZWxzZSBpZiAoZCA9PT0gMCkgewogICAgcm9vdHMgPSBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbC5jb21wdXRlUmVhbFJvb3RzKGEsIGIsIGMpOwogICAgaWYgKHJvb3RzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gWzBdOwogICAgfSBlbHNlIGlmIChyb290c1sxXSA8PSAwKSB7CiAgICAgIHJldHVybiBbcm9vdHNbMF0sIHJvb3RzWzFdLCAwXTsKICAgIH0gZWxzZSBpZiAocm9vdHNbMF0gPj0gMCkgewogICAgICByZXR1cm4gWzAsIHJvb3RzWzBdLCByb290c1sxXV07CiAgICB9CiAgICByZXR1cm4gW3Jvb3RzWzBdLCAwLCByb290c1sxXV07CiAgfQogIHJldHVybiBjb21wdXRlUmVhbFJvb3RzKGEsIGIsIGMsIGQpOwp9Owp2YXIgUXVhcnRpY1JlYWxQb2x5bm9taWFsID0ge307ClF1YXJ0aWNSZWFsUG9seW5vbWlhbC5jb21wdXRlRGlzY3JpbWluYW50ID0gZnVuY3Rpb24oYSwgYiwgYywgZCwgZSkgewogIGlmICh0eXBlb2YgYSAhPT0gIm51bWJlciIpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigiYSBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICB9CiAgaWYgKHR5cGVvZiBiICE9PSAibnVtYmVyIikgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJiIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogIH0KICBpZiAodHlwZW9mIGMgIT09ICJudW1iZXIiKSB7CiAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoImMgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgfQogIGlmICh0eXBlb2YgZCAhPT0gIm51bWJlciIpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigiZCBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICB9CiAgaWYgKHR5cGVvZiBlICE9PSAibnVtYmVyIikgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJlIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogIH0KICB2YXIgYTIgPSBhICogYTsKICB2YXIgYTMgPSBhMiAqIGE7CiAgdmFyIGIyID0gYiAqIGI7CiAgdmFyIGIzID0gYjIgKiBiOwogIHZhciBjMiA9IGMgKiBjOwogIHZhciBjMyA9IGMyICogYzsKICB2YXIgZDIgPSBkICogZDsKICB2YXIgZDMgPSBkMiAqIGQ7CiAgdmFyIGUyID0gZSAqIGU7CiAgdmFyIGUzID0gZTIgKiBlOwogIHZhciBkaXNjcmltaW5hbnQgPSBiMiAqIGMyICogZDIgLSA0ICogYjMgKiBkMyAtIDQgKiBhICogYzMgKiBkMiArIDE4ICogYSAqIGIgKiBjICogZDMgLSAyNyAqIGEyICogZDIgKiBkMiArIDI1NiAqIGEzICogZTMgKyBlICogKDE4ICogYjMgKiBjICogZCAtIDQgKiBiMiAqIGMzICsgMTYgKiBhICogYzIgKiBjMiAtIDgwICogYSAqIGIgKiBjMiAqIGQgLSA2ICogYSAqIGIyICogZDIgKyAxNDQgKiBhMiAqIGMgKiBkMikgKyBlMiAqICgxNDQgKiBhICogYjIgKiBjIC0gMjcgKiBiMiAqIGIyIC0gMTI4ICogYTIgKiBjMiAtIDE5MiAqIGEyICogYiAqIGQpOwogIHJldHVybiBkaXNjcmltaW5hbnQ7Cn07CmZ1bmN0aW9uIG9yaWdpbmFsKGEzLCBhMiwgYTEsIGEwKSB7CiAgdmFyIGEzU3F1YXJlZCA9IGEzICogYTM7CiAgdmFyIHAgPSBhMiAtIDMgKiBhM1NxdWFyZWQgLyA4OwogIHZhciBxID0gYTEgLSBhMiAqIGEzIC8gMiArIGEzU3F1YXJlZCAqIGEzIC8gODsKICB2YXIgciA9IGEwIC0gYTEgKiBhMyAvIDQgKyBhMiAqIGEzU3F1YXJlZCAvIDE2IC0gMyAqIGEzU3F1YXJlZCAqIGEzU3F1YXJlZCAvIDI1NjsKICB2YXIgY3ViaWNSb290cyA9IEN1YmljUmVhbFBvbHlub21pYWwuY29tcHV0ZVJlYWxSb290cygKICAgIDEsCiAgICAyICogcCwKICAgIHAgKiBwIC0gNCAqIHIsCiAgICAtcSAqIHEKICApOwogIGlmIChjdWJpY1Jvb3RzLmxlbmd0aCA+IDApIHsKICAgIHZhciB0ZW1wID0gLWEzIC8gNDsKICAgIHZhciBoU3F1YXJlZCA9IGN1YmljUm9vdHNbY3ViaWNSb290cy5sZW5ndGggLSAxXTsKICAgIGlmIChNYXRoLmFicyhoU3F1YXJlZCkgPCBDZXNpdW1NYXRoLkVQU0lMT04xNCkgewogICAgICB2YXIgcm9vdHMgPSBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbC5jb21wdXRlUmVhbFJvb3RzKDEsIHAsIHIpOwogICAgICBpZiAocm9vdHMubGVuZ3RoID09PSAyKSB7CiAgICAgICAgdmFyIHJvb3QwID0gcm9vdHNbMF07CiAgICAgICAgdmFyIHJvb3QxID0gcm9vdHNbMV07CiAgICAgICAgdmFyIHk7CiAgICAgICAgaWYgKHJvb3QwID49IDAgJiYgcm9vdDEgPj0gMCkgewogICAgICAgICAgdmFyIHkwID0gTWF0aC5zcXJ0KHJvb3QwKTsKICAgICAgICAgIHZhciB5MSA9IE1hdGguc3FydChyb290MSk7CiAgICAgICAgICByZXR1cm4gW3RlbXAgLSB5MSwgdGVtcCAtIHkwLCB0ZW1wICsgeTAsIHRlbXAgKyB5MV07CiAgICAgICAgfSBlbHNlIGlmIChyb290MCA+PSAwICYmIHJvb3QxIDwgMCkgewogICAgICAgICAgeSA9IE1hdGguc3FydChyb290MCk7CiAgICAgICAgICByZXR1cm4gW3RlbXAgLSB5LCB0ZW1wICsgeV07CiAgICAgICAgfSBlbHNlIGlmIChyb290MCA8IDAgJiYgcm9vdDEgPj0gMCkgewogICAgICAgICAgeSA9IE1hdGguc3FydChyb290MSk7CiAgICAgICAgICByZXR1cm4gW3RlbXAgLSB5LCB0ZW1wICsgeV07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBbXTsKICAgIH0gZWxzZSBpZiAoaFNxdWFyZWQgPiAwKSB7CiAgICAgIHZhciBoID0gTWF0aC5zcXJ0KGhTcXVhcmVkKTsKICAgICAgdmFyIG0gPSAocCArIGhTcXVhcmVkIC0gcSAvIGgpIC8gMjsKICAgICAgdmFyIG4gPSAocCArIGhTcXVhcmVkICsgcSAvIGgpIC8gMjsKICAgICAgdmFyIHJvb3RzMSA9IFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsLmNvbXB1dGVSZWFsUm9vdHMoMSwgaCwgbSk7CiAgICAgIHZhciByb290czIgPSBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbC5jb21wdXRlUmVhbFJvb3RzKDEsIC1oLCBuKTsKICAgICAgaWYgKHJvb3RzMS5sZW5ndGggIT09IDApIHsKICAgICAgICByb290czFbMF0gKz0gdGVtcDsKICAgICAgICByb290czFbMV0gKz0gdGVtcDsKICAgICAgICBpZiAocm9vdHMyLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgcm9vdHMyWzBdICs9IHRlbXA7CiAgICAgICAgICByb290czJbMV0gKz0gdGVtcDsKICAgICAgICAgIGlmIChyb290czFbMV0gPD0gcm9vdHMyWzBdKSB7CiAgICAgICAgICAgIHJldHVybiBbcm9vdHMxWzBdLCByb290czFbMV0sIHJvb3RzMlswXSwgcm9vdHMyWzFdXTsKICAgICAgICAgIH0gZWxzZSBpZiAocm9vdHMyWzFdIDw9IHJvb3RzMVswXSkgewogICAgICAgICAgICByZXR1cm4gW3Jvb3RzMlswXSwgcm9vdHMyWzFdLCByb290czFbMF0sIHJvb3RzMVsxXV07CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3RzMVswXSA+PSByb290czJbMF0gJiYgcm9vdHMxWzFdIDw9IHJvb3RzMlsxXSkgewogICAgICAgICAgICByZXR1cm4gW3Jvb3RzMlswXSwgcm9vdHMxWzBdLCByb290czFbMV0sIHJvb3RzMlsxXV07CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3RzMlswXSA+PSByb290czFbMF0gJiYgcm9vdHMyWzFdIDw9IHJvb3RzMVsxXSkgewogICAgICAgICAgICByZXR1cm4gW3Jvb3RzMVswXSwgcm9vdHMyWzBdLCByb290czJbMV0sIHJvb3RzMVsxXV07CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3RzMVswXSA+IHJvb3RzMlswXSAmJiByb290czFbMF0gPCByb290czJbMV0pIHsKICAgICAgICAgICAgcmV0dXJuIFtyb290czJbMF0sIHJvb3RzMVswXSwgcm9vdHMyWzFdLCByb290czFbMV1dOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFtyb290czFbMF0sIHJvb3RzMlswXSwgcm9vdHMxWzFdLCByb290czJbMV1dOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcm9vdHMxOwogICAgICB9CiAgICAgIGlmIChyb290czIubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgcm9vdHMyWzBdICs9IHRlbXA7CiAgICAgICAgcm9vdHMyWzFdICs9IHRlbXA7CiAgICAgICAgcmV0dXJuIHJvb3RzMjsKICAgICAgfQogICAgICByZXR1cm4gW107CiAgICB9CiAgfQogIHJldHVybiBbXTsKfQpmdW5jdGlvbiBuZXVtYXJrKGEzLCBhMiwgYTEsIGEwKSB7CiAgdmFyIGExU3F1YXJlZCA9IGExICogYTE7CiAgdmFyIGEyU3F1YXJlZCA9IGEyICogYTI7CiAgdmFyIGEzU3F1YXJlZCA9IGEzICogYTM7CiAgdmFyIHAgPSAtMiAqIGEyOwogIHZhciBxID0gYTEgKiBhMyArIGEyU3F1YXJlZCAtIDQgKiBhMDsKICB2YXIgciA9IGEzU3F1YXJlZCAqIGEwIC0gYTEgKiBhMiAqIGEzICsgYTFTcXVhcmVkOwogIHZhciBjdWJpY1Jvb3RzID0gQ3ViaWNSZWFsUG9seW5vbWlhbC5jb21wdXRlUmVhbFJvb3RzKDEsIHAsIHEsIHIpOwogIGlmIChjdWJpY1Jvb3RzLmxlbmd0aCA+IDApIHsKICAgIHZhciB5ID0gY3ViaWNSb290c1swXTsKICAgIHZhciB0ZW1wID0gYTIgLSB5OwogICAgdmFyIHRlbXBTcXVhcmVkID0gdGVtcCAqIHRlbXA7CiAgICB2YXIgZzEgPSBhMyAvIDI7CiAgICB2YXIgaDEgPSB0ZW1wIC8gMjsKICAgIHZhciBtID0gdGVtcFNxdWFyZWQgLSA0ICogYTA7CiAgICB2YXIgbUVycm9yID0gdGVtcFNxdWFyZWQgKyA0ICogTWF0aC5hYnMoYTApOwogICAgdmFyIG4gPSBhM1NxdWFyZWQgLSA0ICogeTsKICAgIHZhciBuRXJyb3IgPSBhM1NxdWFyZWQgKyA0ICogTWF0aC5hYnMoeSk7CiAgICB2YXIgZzI7CiAgICB2YXIgaDI7CiAgICBpZiAoeSA8IDAgfHwgbSAqIG5FcnJvciA8IG4gKiBtRXJyb3IpIHsKICAgICAgdmFyIHNxdWFyZVJvb3RPZk4gPSBNYXRoLnNxcnQobik7CiAgICAgIGcyID0gc3F1YXJlUm9vdE9mTiAvIDI7CiAgICAgIGgyID0gc3F1YXJlUm9vdE9mTiA9PT0gMCA/IDAgOiAoYTMgKiBoMSAtIGExKSAvIHNxdWFyZVJvb3RPZk47CiAgICB9IGVsc2UgewogICAgICB2YXIgc3F1YXJlUm9vdE9mTSA9IE1hdGguc3FydChtKTsKICAgICAgZzIgPSBzcXVhcmVSb290T2ZNID09PSAwID8gMCA6IChhMyAqIGgxIC0gYTEpIC8gc3F1YXJlUm9vdE9mTTsKICAgICAgaDIgPSBzcXVhcmVSb290T2ZNIC8gMjsKICAgIH0KICAgIHZhciBHOwogICAgdmFyIGc7CiAgICBpZiAoZzEgPT09IDAgJiYgZzIgPT09IDApIHsKICAgICAgRyA9IDA7CiAgICAgIGcgPSAwOwogICAgfSBlbHNlIGlmIChDZXNpdW1NYXRoLnNpZ24oZzEpID09PSBDZXNpdW1NYXRoLnNpZ24oZzIpKSB7CiAgICAgIEcgPSBnMSArIGcyOwogICAgICBnID0geSAvIEc7CiAgICB9IGVsc2UgewogICAgICBnID0gZzEgLSBnMjsKICAgICAgRyA9IHkgLyBnOwogICAgfQogICAgdmFyIEg7CiAgICB2YXIgaDsKICAgIGlmIChoMSA9PT0gMCAmJiBoMiA9PT0gMCkgewogICAgICBIID0gMDsKICAgICAgaCA9IDA7CiAgICB9IGVsc2UgaWYgKENlc2l1bU1hdGguc2lnbihoMSkgPT09IENlc2l1bU1hdGguc2lnbihoMikpIHsKICAgICAgSCA9IGgxICsgaDI7CiAgICAgIGggPSBhMCAvIEg7CiAgICB9IGVsc2UgewogICAgICBoID0gaDEgLSBoMjsKICAgICAgSCA9IGEwIC8gaDsKICAgIH0KICAgIHZhciByb290czEgPSBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbC5jb21wdXRlUmVhbFJvb3RzKDEsIEcsIEgpOwogICAgdmFyIHJvb3RzMiA9IFF1YWRyYXRpY1JlYWxQb2x5bm9taWFsLmNvbXB1dGVSZWFsUm9vdHMoMSwgZywgaCk7CiAgICBpZiAocm9vdHMxLmxlbmd0aCAhPT0gMCkgewogICAgICBpZiAocm9vdHMyLmxlbmd0aCAhPT0gMCkgewogICAgICAgIGlmIChyb290czFbMV0gPD0gcm9vdHMyWzBdKSB7CiAgICAgICAgICByZXR1cm4gW3Jvb3RzMVswXSwgcm9vdHMxWzFdLCByb290czJbMF0sIHJvb3RzMlsxXV07CiAgICAgICAgfSBlbHNlIGlmIChyb290czJbMV0gPD0gcm9vdHMxWzBdKSB7CiAgICAgICAgICByZXR1cm4gW3Jvb3RzMlswXSwgcm9vdHMyWzFdLCByb290czFbMF0sIHJvb3RzMVsxXV07CiAgICAgICAgfSBlbHNlIGlmIChyb290czFbMF0gPj0gcm9vdHMyWzBdICYmIHJvb3RzMVsxXSA8PSByb290czJbMV0pIHsKICAgICAgICAgIHJldHVybiBbcm9vdHMyWzBdLCByb290czFbMF0sIHJvb3RzMVsxXSwgcm9vdHMyWzFdXTsKICAgICAgICB9IGVsc2UgaWYgKHJvb3RzMlswXSA+PSByb290czFbMF0gJiYgcm9vdHMyWzFdIDw9IHJvb3RzMVsxXSkgewogICAgICAgICAgcmV0dXJuIFtyb290czFbMF0sIHJvb3RzMlswXSwgcm9vdHMyWzFdLCByb290czFbMV1dOwogICAgICAgIH0gZWxzZSBpZiAocm9vdHMxWzBdID4gcm9vdHMyWzBdICYmIHJvb3RzMVswXSA8IHJvb3RzMlsxXSkgewogICAgICAgICAgcmV0dXJuIFtyb290czJbMF0sIHJvb3RzMVswXSwgcm9vdHMyWzFdLCByb290czFbMV1dOwogICAgICAgIH0KICAgICAgICByZXR1cm4gW3Jvb3RzMVswXSwgcm9vdHMyWzBdLCByb290czFbMV0sIHJvb3RzMlsxXV07CiAgICAgIH0KICAgICAgcmV0dXJuIHJvb3RzMTsKICAgIH0KICAgIGlmIChyb290czIubGVuZ3RoICE9PSAwKSB7CiAgICAgIHJldHVybiByb290czI7CiAgICB9CiAgfQogIHJldHVybiBbXTsKfQpRdWFydGljUmVhbFBvbHlub21pYWwuY29tcHV0ZVJlYWxSb290cyA9IGZ1bmN0aW9uKGEsIGIsIGMsIGQsIGUpIHsKICBpZiAodHlwZW9mIGEgIT09ICJudW1iZXIiKSB7CiAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoImEgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgfQogIGlmICh0eXBlb2YgYiAhPT0gIm51bWJlciIpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigiYiBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICB9CiAgaWYgKHR5cGVvZiBjICE9PSAibnVtYmVyIikgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJjIGlzIGEgcmVxdWlyZWQgbnVtYmVyLiIpOwogIH0KICBpZiAodHlwZW9mIGQgIT09ICJudW1iZXIiKSB7CiAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoImQgaXMgYSByZXF1aXJlZCBudW1iZXIuIik7CiAgfQogIGlmICh0eXBlb2YgZSAhPT0gIm51bWJlciIpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigiZSBpcyBhIHJlcXVpcmVkIG51bWJlci4iKTsKICB9CiAgaWYgKE1hdGguYWJzKGEpIDwgQ2VzaXVtTWF0aC5FUFNJTE9OMTUpIHsKICAgIHJldHVybiBDdWJpY1JlYWxQb2x5bm9taWFsLmNvbXB1dGVSZWFsUm9vdHMoYiwgYywgZCwgZSk7CiAgfQogIHZhciBhMyA9IGIgLyBhOwogIHZhciBhMiA9IGMgLyBhOwogIHZhciBhMSA9IGQgLyBhOwogIHZhciBhMCA9IGUgLyBhOwogIHZhciBrID0gYTMgPCAwID8gMSA6IDA7CiAgayArPSBhMiA8IDAgPyBrICsgMSA6IGs7CiAgayArPSBhMSA8IDAgPyBrICsgMSA6IGs7CiAgayArPSBhMCA8IDAgPyBrICsgMSA6IGs7CiAgc3dpdGNoIChrKSB7CiAgICBjYXNlIDA6CiAgICAgIHJldHVybiBvcmlnaW5hbChhMywgYTIsIGExLCBhMCk7CiAgICBjYXNlIDE6CiAgICAgIHJldHVybiBuZXVtYXJrKGEzLCBhMiwgYTEsIGEwKTsKICAgIGNhc2UgMjoKICAgICAgcmV0dXJuIG5ldW1hcmsoYTMsIGEyLCBhMSwgYTApOwogICAgY2FzZSAzOgogICAgICByZXR1cm4gb3JpZ2luYWwoYTMsIGEyLCBhMSwgYTApOwogICAgY2FzZSA0OgogICAgICByZXR1cm4gb3JpZ2luYWwoYTMsIGEyLCBhMSwgYTApOwogICAgY2FzZSA1OgogICAgICByZXR1cm4gbmV1bWFyayhhMywgYTIsIGExLCBhMCk7CiAgICBjYXNlIDY6CiAgICAgIHJldHVybiBvcmlnaW5hbChhMywgYTIsIGExLCBhMCk7CiAgICBjYXNlIDc6CiAgICAgIHJldHVybiBvcmlnaW5hbChhMywgYTIsIGExLCBhMCk7CiAgICBjYXNlIDg6CiAgICAgIHJldHVybiBuZXVtYXJrKGEzLCBhMiwgYTEsIGEwKTsKICAgIGNhc2UgOToKICAgICAgcmV0dXJuIG9yaWdpbmFsKGEzLCBhMiwgYTEsIGEwKTsKICAgIGNhc2UgMTA6CiAgICAgIHJldHVybiBvcmlnaW5hbChhMywgYTIsIGExLCBhMCk7CiAgICBjYXNlIDExOgogICAgICByZXR1cm4gbmV1bWFyayhhMywgYTIsIGExLCBhMCk7CiAgICBjYXNlIDEyOgogICAgICByZXR1cm4gb3JpZ2luYWwoYTMsIGEyLCBhMSwgYTApOwogICAgY2FzZSAxMzoKICAgICAgcmV0dXJuIG9yaWdpbmFsKGEzLCBhMiwgYTEsIGEwKTsKICAgIGNhc2UgMTQ6CiAgICAgIHJldHVybiBvcmlnaW5hbChhMywgYTIsIGExLCBhMCk7CiAgICBjYXNlIDE1OgogICAgICByZXR1cm4gb3JpZ2luYWwoYTMsIGEyLCBhMSwgYTApOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIHZvaWQgMDsKICB9Cn07CnZhciBJbnRlcnNlY3Rpb25UZXN0cyA9IHt9OwpJbnRlcnNlY3Rpb25UZXN0cy5yYXlQbGFuZSA9IGZ1bmN0aW9uKHJheSwgcGxhbmUsIHJlc3VsdCkgewogIGlmICghZGVmaW5lZCQxKHJheSkpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigicmF5IGlzIHJlcXVpcmVkLiIpOwogIH0KICBpZiAoIWRlZmluZWQkMShwbGFuZSkpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigicGxhbmUgaXMgcmVxdWlyZWQuIik7CiAgfQogIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgIHJlc3VsdCA9IG5ldyBWZWN0b3IzJDEoKTsKICB9CiAgdmFyIG9yaWdpbiA9IHJheS5vcmlnaW47CiAgdmFyIGRpcmVjdGlvbiA9IHJheS5kaXJlY3Rpb247CiAgdmFyIG5vcm1hbCA9IHBsYW5lLm5vcm1hbDsKICB2YXIgZGVub21pbmF0b3IgPSBDYXJ0ZXNpYW4zLmRvdChub3JtYWwsIGRpcmVjdGlvbik7CiAgaWYgKE1hdGguYWJzKGRlbm9taW5hdG9yKSA8IENlc2l1bU1hdGguRVBTSUxPTjE1KSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgdCA9ICgtcGxhbmUuY29uc3RhbnQgLSBDYXJ0ZXNpYW4zLmRvdChub3JtYWwsIG9yaWdpbikpIC8gZGVub21pbmF0b3I7CiAgaWYgKHQgPCAwKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXN1bHQgPSBDYXJ0ZXNpYW4zLm11bHRpcGx5QnlTY2FsYXIoZGlyZWN0aW9uLCB0LCByZXN1bHQpOwogIHJldHVybiBDYXJ0ZXNpYW4zLmFkZChvcmlnaW4sIHJlc3VsdCwgcmVzdWx0KTsKfTsKdmFyIHNjcmF0Y2hFZGdlMCA9IG5ldyBWZWN0b3IzJDEoKTsKdmFyIHNjcmF0Y2hFZGdlMSA9IG5ldyBWZWN0b3IzJDEoKTsKdmFyIHNjcmF0Y2hQVmVjID0gbmV3IFZlY3RvcjMkMSgpOwp2YXIgc2NyYXRjaFRWZWMgPSBuZXcgVmVjdG9yMyQxKCk7CnZhciBzY3JhdGNoUVZlYyA9IG5ldyBWZWN0b3IzJDEoKTsKSW50ZXJzZWN0aW9uVGVzdHMucmF5VHJpYW5nbGVQYXJhbWV0cmljID0gZnVuY3Rpb24ocmF5LCBwMCwgcDEsIHAyLCBjdWxsQmFja0ZhY2VzKSB7CiAgaWYgKCFkZWZpbmVkJDEocmF5KSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJyYXkgaXMgcmVxdWlyZWQuIik7CiAgfQogIGlmICghZGVmaW5lZCQxKHAwKSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJwMCBpcyByZXF1aXJlZC4iKTsKICB9CiAgaWYgKCFkZWZpbmVkJDEocDEpKSB7CiAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoInAxIGlzIHJlcXVpcmVkLiIpOwogIH0KICBpZiAoIWRlZmluZWQkMShwMikpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigicDIgaXMgcmVxdWlyZWQuIik7CiAgfQogIGN1bGxCYWNrRmFjZXMgPSBkZWZhdWx0VmFsdWUoY3VsbEJhY2tGYWNlcywgZmFsc2UpOwogIHZhciBvcmlnaW4gPSByYXkub3JpZ2luOwogIHZhciBkaXJlY3Rpb24gPSByYXkuZGlyZWN0aW9uOwogIHZhciBlZGdlMCA9IENhcnRlc2lhbjMuc3VidHJhY3QocDEsIHAwLCBzY3JhdGNoRWRnZTApOwogIHZhciBlZGdlMSA9IENhcnRlc2lhbjMuc3VidHJhY3QocDIsIHAwLCBzY3JhdGNoRWRnZTEpOwogIHZhciBwID0gQ2FydGVzaWFuMy5jcm9zcyhkaXJlY3Rpb24sIGVkZ2UxLCBzY3JhdGNoUFZlYyk7CiAgdmFyIGRldCA9IENhcnRlc2lhbjMuZG90KGVkZ2UwLCBwKTsKICB2YXIgdHZlYzsKICB2YXIgcTsKICB2YXIgdTsKICB2YXIgdjsKICB2YXIgdDsKICBpZiAoY3VsbEJhY2tGYWNlcykgewogICAgaWYgKGRldCA8IENlc2l1bU1hdGguRVBTSUxPTjYpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHR2ZWMgPSBDYXJ0ZXNpYW4zLnN1YnRyYWN0KG9yaWdpbiwgcDAsIHNjcmF0Y2hUVmVjKTsKICAgIHUgPSBDYXJ0ZXNpYW4zLmRvdCh0dmVjLCBwKTsKICAgIGlmICh1IDwgMCB8fCB1ID4gZGV0KSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBxID0gQ2FydGVzaWFuMy5jcm9zcyh0dmVjLCBlZGdlMCwgc2NyYXRjaFFWZWMpOwogICAgdiA9IENhcnRlc2lhbjMuZG90KGRpcmVjdGlvbiwgcSk7CiAgICBpZiAodiA8IDAgfHwgdSArIHYgPiBkZXQpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHQgPSBDYXJ0ZXNpYW4zLmRvdChlZGdlMSwgcSkgLyBkZXQ7CiAgfSBlbHNlIHsKICAgIGlmIChNYXRoLmFicyhkZXQpIDwgQ2VzaXVtTWF0aC5FUFNJTE9ONikgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgdmFyIGludkRldCA9IDEgLyBkZXQ7CiAgICB0dmVjID0gQ2FydGVzaWFuMy5zdWJ0cmFjdChvcmlnaW4sIHAwLCBzY3JhdGNoVFZlYyk7CiAgICB1ID0gQ2FydGVzaWFuMy5kb3QodHZlYywgcCkgKiBpbnZEZXQ7CiAgICBpZiAodSA8IDAgfHwgdSA+IDEpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHEgPSBDYXJ0ZXNpYW4zLmNyb3NzKHR2ZWMsIGVkZ2UwLCBzY3JhdGNoUVZlYyk7CiAgICB2ID0gQ2FydGVzaWFuMy5kb3QoZGlyZWN0aW9uLCBxKSAqIGludkRldDsKICAgIGlmICh2IDwgMCB8fCB1ICsgdiA+IDEpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHQgPSBDYXJ0ZXNpYW4zLmRvdChlZGdlMSwgcSkgKiBpbnZEZXQ7CiAgfQogIHJldHVybiB0Owp9OwpJbnRlcnNlY3Rpb25UZXN0cy5yYXlUcmlhbmdsZSA9IGZ1bmN0aW9uKHJheSwgcDAsIHAxLCBwMiwgY3VsbEJhY2tGYWNlcywgcmVzdWx0KSB7CiAgdmFyIHQgPSBJbnRlcnNlY3Rpb25UZXN0cy5yYXlUcmlhbmdsZVBhcmFtZXRyaWMoCiAgICByYXksCiAgICBwMCwKICAgIHAxLAogICAgcDIsCiAgICBjdWxsQmFja0ZhY2VzCiAgKTsKICBpZiAoIWRlZmluZWQkMSh0KSB8fCB0IDwgMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKCFkZWZpbmVkJDEocmVzdWx0KSkgewogICAgcmVzdWx0ID0gbmV3IFZlY3RvcjMkMSgpOwogIH0KICBDYXJ0ZXNpYW4zLm11bHRpcGx5QnlTY2FsYXIocmF5LmRpcmVjdGlvbiwgdCwgcmVzdWx0KTsKICByZXR1cm4gQ2FydGVzaWFuMy5hZGQocmF5Lm9yaWdpbiwgcmVzdWx0LCByZXN1bHQpOwp9Owp2YXIgc2NyYXRjaExpbmVTZWdtZW50VHJpYW5nbGVSYXkgPSBuZXcgUmF5KCk7CkludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50VHJpYW5nbGUgPSBmdW5jdGlvbih2MCwgdjEsIHAwLCBwMSwgcDIsIGN1bGxCYWNrRmFjZXMsIHJlc3VsdCkgewogIGlmICghZGVmaW5lZCQxKHYwKSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJ2MCBpcyByZXF1aXJlZC4iKTsKICB9CiAgaWYgKCFkZWZpbmVkJDEodjEpKSB7CiAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoInYxIGlzIHJlcXVpcmVkLiIpOwogIH0KICBpZiAoIWRlZmluZWQkMShwMCkpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigicDAgaXMgcmVxdWlyZWQuIik7CiAgfQogIGlmICghZGVmaW5lZCQxKHAxKSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJwMSBpcyByZXF1aXJlZC4iKTsKICB9CiAgaWYgKCFkZWZpbmVkJDEocDIpKSB7CiAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoInAyIGlzIHJlcXVpcmVkLiIpOwogIH0KICB2YXIgcmF5ID0gc2NyYXRjaExpbmVTZWdtZW50VHJpYW5nbGVSYXk7CiAgQ2FydGVzaWFuMy5jbG9uZSh2MCwgcmF5Lm9yaWdpbik7CiAgQ2FydGVzaWFuMy5zdWJ0cmFjdCh2MSwgdjAsIHJheS5kaXJlY3Rpb24pOwogIENhcnRlc2lhbjMubm9ybWFsaXplKHJheS5kaXJlY3Rpb24sIHJheS5kaXJlY3Rpb24pOwogIHZhciB0ID0gSW50ZXJzZWN0aW9uVGVzdHMucmF5VHJpYW5nbGVQYXJhbWV0cmljKAogICAgcmF5LAogICAgcDAsCiAgICBwMSwKICAgIHAyLAogICAgY3VsbEJhY2tGYWNlcwogICk7CiAgaWYgKCFkZWZpbmVkJDEodCkgfHwgdCA8IDAgfHwgdCA+IENhcnRlc2lhbjMuZGlzdGFuY2UodjAsIHYxKSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKCFkZWZpbmVkJDEocmVzdWx0KSkgewogICAgcmVzdWx0ID0gbmV3IFZlY3RvcjMkMSgpOwogIH0KICBDYXJ0ZXNpYW4zLm11bHRpcGx5QnlTY2FsYXIocmF5LmRpcmVjdGlvbiwgdCwgcmVzdWx0KTsKICByZXR1cm4gQ2FydGVzaWFuMy5hZGQocmF5Lm9yaWdpbiwgcmVzdWx0LCByZXN1bHQpOwp9OwpmdW5jdGlvbiBzb2x2ZVF1YWRyYXRpYyhhLCBiLCBjLCByZXN1bHQpIHsKICB2YXIgZGV0ID0gYiAqIGIgLSA0ICogYSAqIGM7CiAgaWYgKGRldCA8IDApIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfSBlbHNlIGlmIChkZXQgPiAwKSB7CiAgICB2YXIgZGVub20gPSAxIC8gKDIgKiBhKTsKICAgIHZhciBkaXNjID0gTWF0aC5zcXJ0KGRldCk7CiAgICB2YXIgcm9vdDAgPSAoLWIgKyBkaXNjKSAqIGRlbm9tOwogICAgdmFyIHJvb3QxID0gKC1iIC0gZGlzYykgKiBkZW5vbTsKICAgIGlmIChyb290MCA8IHJvb3QxKSB7CiAgICAgIHJlc3VsdC5yb290MCA9IHJvb3QwOwogICAgICByZXN1bHQucm9vdDEgPSByb290MTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdC5yb290MCA9IHJvb3QxOwogICAgICByZXN1bHQucm9vdDEgPSByb290MDsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHZhciByb290ID0gLWIgLyAoMiAqIGEpOwogIGlmIChyb290ID09PSAwKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXN1bHQucm9vdDAgPSByZXN1bHQucm9vdDEgPSByb290OwogIHJldHVybiByZXN1bHQ7Cn0KdmFyIHJheVNwaGVyZVJvb3RzID0gewogIHJvb3QwOiAwLAogIHJvb3QxOiAwCn07CmZ1bmN0aW9uIHJheVNwaGVyZShyYXksIHNwaGVyZSwgcmVzdWx0KSB7CiAgaWYgKCFkZWZpbmVkJDEocmVzdWx0KSkgewogICAgcmVzdWx0ID0gbmV3IEludGVydmFsKCk7CiAgfQogIHZhciBvcmlnaW4gPSByYXkub3JpZ2luOwogIHZhciBkaXJlY3Rpb24gPSByYXkuZGlyZWN0aW9uOwogIHZhciBjZW50ZXIgPSBzcGhlcmUuY2VudGVyOwogIHZhciByYWRpdXNTcXVhcmVkID0gc3BoZXJlLnJhZGl1cyAqIHNwaGVyZS5yYWRpdXM7CiAgdmFyIGRpZmYgPSBDYXJ0ZXNpYW4zLnN1YnRyYWN0KG9yaWdpbiwgY2VudGVyLCBzY3JhdGNoUFZlYyk7CiAgdmFyIGEgPSBDYXJ0ZXNpYW4zLmRvdChkaXJlY3Rpb24sIGRpcmVjdGlvbik7CiAgdmFyIGIgPSAyICogQ2FydGVzaWFuMy5kb3QoZGlyZWN0aW9uLCBkaWZmKTsKICB2YXIgYyA9IENhcnRlc2lhbjMubWFnbml0dWRlU3F1YXJlZChkaWZmKSAtIHJhZGl1c1NxdWFyZWQ7CiAgdmFyIHJvb3RzID0gc29sdmVRdWFkcmF0aWMoYSwgYiwgYywgcmF5U3BoZXJlUm9vdHMpOwogIGlmICghZGVmaW5lZCQxKHJvb3RzKSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmVzdWx0LnN0YXJ0ID0gcm9vdHMucm9vdDA7CiAgcmVzdWx0LnN0b3AgPSByb290cy5yb290MTsKICByZXR1cm4gcmVzdWx0Owp9CkludGVyc2VjdGlvblRlc3RzLnJheVNwaGVyZSA9IGZ1bmN0aW9uKHJheSwgc3BoZXJlLCByZXN1bHQpIHsKICBpZiAoIWRlZmluZWQkMShyYXkpKSB7CiAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoInJheSBpcyByZXF1aXJlZC4iKTsKICB9CiAgaWYgKCFkZWZpbmVkJDEoc3BoZXJlKSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJzcGhlcmUgaXMgcmVxdWlyZWQuIik7CiAgfQogIHJlc3VsdCA9IHJheVNwaGVyZShyYXksIHNwaGVyZSwgcmVzdWx0KTsKICBpZiAoIWRlZmluZWQkMShyZXN1bHQpIHx8IHJlc3VsdC5zdG9wIDwgMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmVzdWx0LnN0YXJ0ID0gTWF0aC5tYXgocmVzdWx0LnN0YXJ0LCAwKTsKICByZXR1cm4gcmVzdWx0Owp9Owp2YXIgc2NyYXRjaExpbmVTZWdtZW50UmF5ID0gbmV3IFJheSgpOwpJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFNwaGVyZSA9IGZ1bmN0aW9uKHAwLCBwMSwgc3BoZXJlLCByZXN1bHQpIHsKICBpZiAoIWRlZmluZWQkMShwMCkpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigicDAgaXMgcmVxdWlyZWQuIik7CiAgfQogIGlmICghZGVmaW5lZCQxKHAxKSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJwMSBpcyByZXF1aXJlZC4iKTsKICB9CiAgaWYgKCFkZWZpbmVkJDEoc3BoZXJlKSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJzcGhlcmUgaXMgcmVxdWlyZWQuIik7CiAgfQogIHZhciByYXkgPSBzY3JhdGNoTGluZVNlZ21lbnRSYXk7CiAgQ2FydGVzaWFuMy5jbG9uZShwMCwgcmF5Lm9yaWdpbik7CiAgdmFyIGRpcmVjdGlvbiA9IENhcnRlc2lhbjMuc3VidHJhY3QocDEsIHAwLCByYXkuZGlyZWN0aW9uKTsKICB2YXIgbWF4VCA9IENhcnRlc2lhbjMubWFnbml0dWRlKGRpcmVjdGlvbik7CiAgQ2FydGVzaWFuMy5ub3JtYWxpemUoZGlyZWN0aW9uLCBkaXJlY3Rpb24pOwogIHJlc3VsdCA9IHJheVNwaGVyZShyYXksIHNwaGVyZSwgcmVzdWx0KTsKICBpZiAoIWRlZmluZWQkMShyZXN1bHQpIHx8IHJlc3VsdC5zdG9wIDwgMCB8fCByZXN1bHQuc3RhcnQgPiBtYXhUKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXN1bHQuc3RhcnQgPSBNYXRoLm1heChyZXN1bHQuc3RhcnQsIDApOwogIHJlc3VsdC5zdG9wID0gTWF0aC5taW4ocmVzdWx0LnN0b3AsIG1heFQpOwogIHJldHVybiByZXN1bHQ7Cn07CnZhciBzY3JhdGNoUSA9IG5ldyBWZWN0b3IzJDEoKTsKdmFyIHNjcmF0Y2hXID0gbmV3IFZlY3RvcjMkMSgpOwpJbnRlcnNlY3Rpb25UZXN0cy5yYXlFbGxpcHNvaWQgPSBmdW5jdGlvbihyYXksIGVsbGlwc29pZCkgewogIGlmICghZGVmaW5lZCQxKHJheSkpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigicmF5IGlzIHJlcXVpcmVkLiIpOwogIH0KICBpZiAoIWRlZmluZWQkMShlbGxpcHNvaWQpKSB7CiAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoImVsbGlwc29pZCBpcyByZXF1aXJlZC4iKTsKICB9CiAgdmFyIGludmVyc2VSYWRpaSA9IGVsbGlwc29pZC5vbmVPdmVyUmFkaWk7CiAgdmFyIHEgPSBDYXJ0ZXNpYW4zLm11bHRpcGx5Q29tcG9uZW50cyhpbnZlcnNlUmFkaWksIHJheS5vcmlnaW4sIHNjcmF0Y2hRKTsKICB2YXIgdyA9IENhcnRlc2lhbjMubXVsdGlwbHlDb21wb25lbnRzKGludmVyc2VSYWRpaSwgcmF5LmRpcmVjdGlvbiwgc2NyYXRjaFcpOwogIHZhciBxMiA9IENhcnRlc2lhbjMubWFnbml0dWRlU3F1YXJlZChxKTsKICB2YXIgcXcgPSBDYXJ0ZXNpYW4zLmRvdChxLCB3KTsKICB2YXIgZGlmZmVyZW5jZSwgdzIsIHByb2R1Y3QsIGRpc2NyaW1pbmFudCwgdGVtcDsKICBpZiAocTIgPiAxKSB7CiAgICBpZiAocXcgPj0gMCkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgdmFyIHF3MiA9IHF3ICogcXc7CiAgICBkaWZmZXJlbmNlID0gcTIgLSAxOwogICAgdzIgPSBDYXJ0ZXNpYW4zLm1hZ25pdHVkZVNxdWFyZWQodyk7CiAgICBwcm9kdWN0ID0gdzIgKiBkaWZmZXJlbmNlOwogICAgaWYgKHF3MiA8IHByb2R1Y3QpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0gZWxzZSBpZiAocXcyID4gcHJvZHVjdCkgewogICAgICBkaXNjcmltaW5hbnQgPSBxdyAqIHF3IC0gcHJvZHVjdDsKICAgICAgdGVtcCA9IC1xdyArIE1hdGguc3FydChkaXNjcmltaW5hbnQpOwogICAgICB2YXIgcm9vdDAgPSB0ZW1wIC8gdzI7CiAgICAgIHZhciByb290MSA9IGRpZmZlcmVuY2UgLyB0ZW1wOwogICAgICBpZiAocm9vdDAgPCByb290MSkgewogICAgICAgIHJldHVybiBuZXcgSW50ZXJ2YWwocm9vdDAsIHJvb3QxKTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHN0YXJ0OiByb290MSwKICAgICAgICBzdG9wOiByb290MAogICAgICB9OwogICAgfQogICAgdmFyIHJvb3QgPSBNYXRoLnNxcnQoZGlmZmVyZW5jZSAvIHcyKTsKICAgIHJldHVybiBuZXcgSW50ZXJ2YWwocm9vdCwgcm9vdCk7CiAgfSBlbHNlIGlmIChxMiA8IDEpIHsKICAgIGRpZmZlcmVuY2UgPSBxMiAtIDE7CiAgICB3MiA9IENhcnRlc2lhbjMubWFnbml0dWRlU3F1YXJlZCh3KTsKICAgIHByb2R1Y3QgPSB3MiAqIGRpZmZlcmVuY2U7CiAgICBkaXNjcmltaW5hbnQgPSBxdyAqIHF3IC0gcHJvZHVjdDsKICAgIHRlbXAgPSAtcXcgKyBNYXRoLnNxcnQoZGlzY3JpbWluYW50KTsKICAgIHJldHVybiBuZXcgSW50ZXJ2YWwoMCwgdGVtcCAvIHcyKTsKICB9CiAgaWYgKHF3IDwgMCkgewogICAgdzIgPSBDYXJ0ZXNpYW4zLm1hZ25pdHVkZVNxdWFyZWQodyk7CiAgICByZXR1cm4gbmV3IEludGVydmFsKDAsIC1xdyAvIHcyKTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKZnVuY3Rpb24gYWRkV2l0aENhbmNlbGxhdGlvbkNoZWNrKGxlZnQsIHJpZ2h0LCB0b2xlcmFuY2UpIHsKICB2YXIgZGlmZmVyZW5jZSA9IGxlZnQgKyByaWdodDsKICBpZiAoQ2VzaXVtTWF0aC5zaWduKGxlZnQpICE9PSBDZXNpdW1NYXRoLnNpZ24ocmlnaHQpICYmIE1hdGguYWJzKGRpZmZlcmVuY2UgLyBNYXRoLm1heChNYXRoLmFicyhsZWZ0KSwgTWF0aC5hYnMocmlnaHQpKSkgPCB0b2xlcmFuY2UpIHsKICAgIHJldHVybiAwOwogIH0KICByZXR1cm4gZGlmZmVyZW5jZTsKfQpmdW5jdGlvbiBxdWFkcmF0aWNWZWN0b3JFeHByZXNzaW9uKEEyLCBiLCBjLCB4LCB3KSB7CiAgdmFyIHhTcXVhcmVkID0geCAqIHg7CiAgdmFyIHdTcXVhcmVkID0gdyAqIHc7CiAgdmFyIGwyID0gKEEyW1N0YXRpY01hdHJpeDMuQ09MVU1OMVJPVzFdIC0gQTJbU3RhdGljTWF0cml4My5DT0xVTU4yUk9XMl0pICogd1NxdWFyZWQ7CiAgdmFyIGwxID0gdyAqICh4ICogYWRkV2l0aENhbmNlbGxhdGlvbkNoZWNrKAogICAgQTJbU3RhdGljTWF0cml4My5DT0xVTU4xUk9XMF0sCiAgICBBMltTdGF0aWNNYXRyaXgzLkNPTFVNTjBST1cxXSwKICAgIENlc2l1bU1hdGguRVBTSUxPTjE1CiAgKSArIGIueSk7CiAgdmFyIGwwID0gQTJbU3RhdGljTWF0cml4My5DT0xVTU4wUk9XMF0gKiB4U3F1YXJlZCArIEEyW1N0YXRpY01hdHJpeDMuQ09MVU1OMlJPVzJdICogd1NxdWFyZWQgKyB4ICogYi54ICsgYzsKICB2YXIgcjEgPSB3U3F1YXJlZCAqIGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjaygKICAgIEEyW1N0YXRpY01hdHJpeDMuQ09MVU1OMlJPVzFdLAogICAgQTJbU3RhdGljTWF0cml4My5DT0xVTU4xUk9XMl0sCiAgICBDZXNpdW1NYXRoLkVQU0lMT04xNQogICk7CiAgdmFyIHIwID0gdyAqICh4ICogYWRkV2l0aENhbmNlbGxhdGlvbkNoZWNrKEEyW1N0YXRpY01hdHJpeDMuQ09MVU1OMlJPVzBdLCBBMltTdGF0aWNNYXRyaXgzLkNPTFVNTjBST1cyXSkgKyBiLnopOwogIHZhciBjb3NpbmVzOwogIHZhciBzb2x1dGlvbnMgPSBbXTsKICBpZiAocjAgPT09IDAgJiYgcjEgPT09IDApIHsKICAgIGNvc2luZXMgPSBRdWFkcmF0aWNSZWFsUG9seW5vbWlhbC5jb21wdXRlUmVhbFJvb3RzKGwyLCBsMSwgbDApOwogICAgaWYgKGNvc2luZXMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBzb2x1dGlvbnM7CiAgICB9CiAgICB2YXIgY29zaW5lMCA9IGNvc2luZXNbMF07CiAgICB2YXIgc2luZTAgPSBNYXRoLnNxcnQoTWF0aC5tYXgoMSAtIGNvc2luZTAgKiBjb3NpbmUwLCAwKSk7CiAgICBzb2x1dGlvbnMucHVzaChuZXcgVmVjdG9yMyQxKHgsIHcgKiBjb3NpbmUwLCB3ICogLXNpbmUwKSk7CiAgICBzb2x1dGlvbnMucHVzaChuZXcgVmVjdG9yMyQxKHgsIHcgKiBjb3NpbmUwLCB3ICogc2luZTApKTsKICAgIGlmIChjb3NpbmVzLmxlbmd0aCA9PT0gMikgewogICAgICB2YXIgY29zaW5lMSA9IGNvc2luZXNbMV07CiAgICAgIHZhciBzaW5lMSA9IE1hdGguc3FydChNYXRoLm1heCgxIC0gY29zaW5lMSAqIGNvc2luZTEsIDApKTsKICAgICAgc29sdXRpb25zLnB1c2gobmV3IFZlY3RvcjMkMSh4LCB3ICogY29zaW5lMSwgdyAqIC1zaW5lMSkpOwogICAgICBzb2x1dGlvbnMucHVzaChuZXcgVmVjdG9yMyQxKHgsIHcgKiBjb3NpbmUxLCB3ICogc2luZTEpKTsKICAgIH0KICAgIHJldHVybiBzb2x1dGlvbnM7CiAgfQogIHZhciByMFNxdWFyZWQgPSByMCAqIHIwOwogIHZhciByMVNxdWFyZWQgPSByMSAqIHIxOwogIHZhciBsMlNxdWFyZWQgPSBsMiAqIGwyOwogIHZhciByMHIxID0gcjAgKiByMTsKICB2YXIgYzQgPSBsMlNxdWFyZWQgKyByMVNxdWFyZWQ7CiAgdmFyIGMzID0gMiAqIChsMSAqIGwyICsgcjByMSk7CiAgdmFyIGMyID0gMiAqIGwwICogbDIgKyBsMSAqIGwxIC0gcjFTcXVhcmVkICsgcjBTcXVhcmVkOwogIHZhciBjMSA9IDIgKiAobDAgKiBsMSAtIHIwcjEpOwogIHZhciBjMCA9IGwwICogbDAgLSByMFNxdWFyZWQ7CiAgaWYgKGM0ID09PSAwICYmIGMzID09PSAwICYmIGMyID09PSAwICYmIGMxID09PSAwKSB7CiAgICByZXR1cm4gc29sdXRpb25zOwogIH0KICBjb3NpbmVzID0gUXVhcnRpY1JlYWxQb2x5bm9taWFsLmNvbXB1dGVSZWFsUm9vdHMoYzQsIGMzLCBjMiwgYzEsIGMwKTsKICB2YXIgbGVuZ3RoID0gY29zaW5lcy5sZW5ndGg7CiAgaWYgKGxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHNvbHV0aW9uczsKICB9CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgdmFyIGNvc2luZSA9IGNvc2luZXNbaV07CiAgICB2YXIgY29zaW5lU3F1YXJlZCA9IGNvc2luZSAqIGNvc2luZTsKICAgIHZhciBzaW5lU3F1YXJlZCA9IE1hdGgubWF4KDEgLSBjb3NpbmVTcXVhcmVkLCAwKTsKICAgIHZhciBzaW5lID0gTWF0aC5zcXJ0KHNpbmVTcXVhcmVkKTsKICAgIHZhciBsZWZ0OwogICAgaWYgKENlc2l1bU1hdGguc2lnbihsMikgPT09IENlc2l1bU1hdGguc2lnbihsMCkpIHsKICAgICAgbGVmdCA9IGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjaygKICAgICAgICBsMiAqIGNvc2luZVNxdWFyZWQgKyBsMCwKICAgICAgICBsMSAqIGNvc2luZSwKICAgICAgICBDZXNpdW1NYXRoLkVQU0lMT04xMgogICAgICApOwogICAgfSBlbHNlIGlmIChDZXNpdW1NYXRoLnNpZ24obDApID09PSBDZXNpdW1NYXRoLnNpZ24obDEgKiBjb3NpbmUpKSB7CiAgICAgIGxlZnQgPSBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2soCiAgICAgICAgbDIgKiBjb3NpbmVTcXVhcmVkLAogICAgICAgIGwxICogY29zaW5lICsgbDAsCiAgICAgICAgQ2VzaXVtTWF0aC5FUFNJTE9OMTIKICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIGxlZnQgPSBhZGRXaXRoQ2FuY2VsbGF0aW9uQ2hlY2soCiAgICAgICAgbDIgKiBjb3NpbmVTcXVhcmVkICsgbDEgKiBjb3NpbmUsCiAgICAgICAgbDAsCiAgICAgICAgQ2VzaXVtTWF0aC5FUFNJTE9OMTIKICAgICAgKTsKICAgIH0KICAgIHZhciByaWdodCA9IGFkZFdpdGhDYW5jZWxsYXRpb25DaGVjayhyMSAqIGNvc2luZSwgcjAsIENlc2l1bU1hdGguRVBTSUxPTjE1KTsKICAgIHZhciBwcm9kdWN0ID0gbGVmdCAqIHJpZ2h0OwogICAgaWYgKHByb2R1Y3QgPCAwKSB7CiAgICAgIHNvbHV0aW9ucy5wdXNoKG5ldyBWZWN0b3IzJDEoeCwgdyAqIGNvc2luZSwgdyAqIHNpbmUpKTsKICAgIH0gZWxzZSBpZiAocHJvZHVjdCA+IDApIHsKICAgICAgc29sdXRpb25zLnB1c2gobmV3IFZlY3RvcjMkMSh4LCB3ICogY29zaW5lLCB3ICogLXNpbmUpKTsKICAgIH0gZWxzZSBpZiAoc2luZSAhPT0gMCkgewogICAgICBzb2x1dGlvbnMucHVzaChuZXcgVmVjdG9yMyQxKHgsIHcgKiBjb3NpbmUsIHcgKiAtc2luZSkpOwogICAgICBzb2x1dGlvbnMucHVzaChuZXcgVmVjdG9yMyQxKHgsIHcgKiBjb3NpbmUsIHcgKiBzaW5lKSk7CiAgICAgICsraTsKICAgIH0gZWxzZSB7CiAgICAgIHNvbHV0aW9ucy5wdXNoKG5ldyBWZWN0b3IzJDEoeCwgdyAqIGNvc2luZSwgdyAqIHNpbmUpKTsKICAgIH0KICB9CiAgcmV0dXJuIHNvbHV0aW9uczsKfQp2YXIgZmlyc3RBeGlzU2NyYXRjaCA9IG5ldyBWZWN0b3IzJDEoKTsKdmFyIHNlY29uZEF4aXNTY3JhdGNoID0gbmV3IFZlY3RvcjMkMSgpOwp2YXIgdGhpcmRBeGlzU2NyYXRjaCA9IG5ldyBWZWN0b3IzJDEoKTsKdmFyIHJlZmVyZW5jZVNjcmF0Y2ggPSBuZXcgVmVjdG9yMyQxKCk7CnZhciBiQ2FydCA9IG5ldyBWZWN0b3IzJDEoKTsKdmFyIGJTY3JhdGNoID0gbmV3IE1hdHJpeDMoKTsKdmFyIGJ0U2NyYXRjaCA9IG5ldyBNYXRyaXgzKCk7CnZhciBkaVNjcmF0Y2ggPSBuZXcgTWF0cml4MygpOwp2YXIgZFNjcmF0Y2ggPSBuZXcgTWF0cml4MygpOwp2YXIgY1NjcmF0Y2ggPSBuZXcgTWF0cml4MygpOwp2YXIgdGVtcE1hdHJpeCA9IG5ldyBNYXRyaXgzKCk7CnZhciBhU2NyYXRjaCA9IG5ldyBNYXRyaXgzKCk7CnZhciBzU2NyYXRjaCA9IG5ldyBWZWN0b3IzJDEoKTsKdmFyIGNsb3Nlc3RTY3JhdGNoID0gbmV3IFZlY3RvcjMkMSgpOwp2YXIgc3VyZlBvaW50U2NyYXRjaCA9IG5ldyBWZWN0b3IzJDEoKTsKSW50ZXJzZWN0aW9uVGVzdHMuZ3JhemluZ0FsdGl0dWRlTG9jYXRpb24gPSBmdW5jdGlvbihyYXksIGVsbGlwc29pZCkgewogIGlmICghZGVmaW5lZCQxKHJheSkpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigicmF5IGlzIHJlcXVpcmVkLiIpOwogIH0KICBpZiAoIWRlZmluZWQkMShlbGxpcHNvaWQpKSB7CiAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoImVsbGlwc29pZCBpcyByZXF1aXJlZC4iKTsKICB9CiAgdmFyIHBvc2l0aW9uID0gcmF5Lm9yaWdpbjsKICB2YXIgZGlyZWN0aW9uID0gcmF5LmRpcmVjdGlvbjsKICBpZiAoIUNhcnRlc2lhbjMuZXF1YWxzKHBvc2l0aW9uLCBDYXJ0ZXNpYW4zLlpFUk8pKSB7CiAgICB2YXIgbm9ybWFsID0gZWxsaXBzb2lkLmdlb2RldGljU3VyZmFjZU5vcm1hbChwb3NpdGlvbiwgZmlyc3RBeGlzU2NyYXRjaCk7CiAgICBpZiAoQ2FydGVzaWFuMy5kb3QoZGlyZWN0aW9uLCBub3JtYWwpID49IDApIHsKICAgICAgcmV0dXJuIHBvc2l0aW9uOwogICAgfQogIH0KICB2YXIgaW50ZXJzZWN0cyA9IGRlZmluZWQkMSh0aGlzLnJheUVsbGlwc29pZChyYXksIGVsbGlwc29pZCkpOwogIHZhciBmID0gZWxsaXBzb2lkLnRyYW5zZm9ybVBvc2l0aW9uVG9TY2FsZWRTcGFjZShkaXJlY3Rpb24sIGZpcnN0QXhpc1NjcmF0Y2gpOwogIHZhciBmaXJzdEF4aXMgPSBDYXJ0ZXNpYW4zLm5vcm1hbGl6ZShmLCBmKTsKICB2YXIgcmVmZXJlbmNlID0gQ2FydGVzaWFuMy5tb3N0T3J0aG9nb25hbEF4aXMoZiwgcmVmZXJlbmNlU2NyYXRjaCk7CiAgdmFyIHNlY29uZEF4aXMgPSBDYXJ0ZXNpYW4zLm5vcm1hbGl6ZSgKICAgIENhcnRlc2lhbjMuY3Jvc3MocmVmZXJlbmNlLCBmaXJzdEF4aXMsIHNlY29uZEF4aXNTY3JhdGNoKSwKICAgIHNlY29uZEF4aXNTY3JhdGNoCiAgKTsKICB2YXIgdGhpcmRBeGlzID0gQ2FydGVzaWFuMy5ub3JtYWxpemUoCiAgICBDYXJ0ZXNpYW4zLmNyb3NzKGZpcnN0QXhpcywgc2Vjb25kQXhpcywgdGhpcmRBeGlzU2NyYXRjaCksCiAgICB0aGlyZEF4aXNTY3JhdGNoCiAgKTsKICB2YXIgQiA9IGJTY3JhdGNoOwogIEJbMF0gPSBmaXJzdEF4aXMueDsKICBCWzFdID0gZmlyc3RBeGlzLnk7CiAgQlsyXSA9IGZpcnN0QXhpcy56OwogIEJbM10gPSBzZWNvbmRBeGlzLng7CiAgQls0XSA9IHNlY29uZEF4aXMueTsKICBCWzVdID0gc2Vjb25kQXhpcy56OwogIEJbNl0gPSB0aGlyZEF4aXMueDsKICBCWzddID0gdGhpcmRBeGlzLnk7CiAgQls4XSA9IHRoaXJkQXhpcy56OwogIHZhciBCX1QgPSBTdGF0aWNNYXRyaXgzLnRyYW5zcG9zZShCLCBidFNjcmF0Y2gpOwogIHZhciBEX0kgPSBTdGF0aWNNYXRyaXgzLmZyb21TY2FsZShlbGxpcHNvaWQucmFkaWksIGRpU2NyYXRjaCk7CiAgdmFyIEQgPSBTdGF0aWNNYXRyaXgzLmZyb21TY2FsZShlbGxpcHNvaWQub25lT3ZlclJhZGlpLCBkU2NyYXRjaCk7CiAgdmFyIEMgPSBjU2NyYXRjaDsKICBDWzBdID0gMDsKICBDWzFdID0gLWRpcmVjdGlvbi56OwogIENbMl0gPSBkaXJlY3Rpb24ueTsKICBDWzNdID0gZGlyZWN0aW9uLno7CiAgQ1s0XSA9IDA7CiAgQ1s1XSA9IC1kaXJlY3Rpb24ueDsKICBDWzZdID0gLWRpcmVjdGlvbi55OwogIENbN10gPSBkaXJlY3Rpb24ueDsKICBDWzhdID0gMDsKICB2YXIgdGVtcCA9IFN0YXRpY01hdHJpeDMubXVsdGlwbHkoCiAgICBTdGF0aWNNYXRyaXgzLm11bHRpcGx5KEJfVCwgRCwgdGVtcE1hdHJpeCksCiAgICBDLAogICAgdGVtcE1hdHJpeAogICk7CiAgdmFyIEEyID0gU3RhdGljTWF0cml4My5tdWx0aXBseShTdGF0aWNNYXRyaXgzLm11bHRpcGx5KHRlbXAsIERfSSwgYVNjcmF0Y2gpLCBCLCBhU2NyYXRjaCk7CiAgdmFyIGIgPSBTdGF0aWNNYXRyaXgzLm11bHRpcGx5QnlWZWN0b3IodGVtcCwgcG9zaXRpb24sIGJDYXJ0KTsKICB2YXIgc29sdXRpb25zID0gcXVhZHJhdGljVmVjdG9yRXhwcmVzc2lvbigKICAgIEEyLAogICAgQ2FydGVzaWFuMy5uZWdhdGUoYiwgZmlyc3RBeGlzU2NyYXRjaCksCiAgICAwLAogICAgMCwKICAgIDEKICApOwogIHZhciBzOwogIHZhciBhbHRpdHVkZTsKICB2YXIgbGVuZ3RoID0gc29sdXRpb25zLmxlbmd0aDsKICBpZiAobGVuZ3RoID4gMCkgewogICAgdmFyIGNsb3Nlc3QgPSBDYXJ0ZXNpYW4zLmNsb25lKENhcnRlc2lhbjMuWkVSTywgY2xvc2VzdFNjcmF0Y2gpOwogICAgdmFyIG1heGltdW1WYWx1ZSA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgcyA9IFN0YXRpY01hdHJpeDMubXVsdGlwbHlCeVZlY3RvcigKICAgICAgICBEX0ksCiAgICAgICAgU3RhdGljTWF0cml4My5tdWx0aXBseUJ5VmVjdG9yKEIsIHNvbHV0aW9uc1tpXSwgc1NjcmF0Y2gpLAogICAgICAgIHNTY3JhdGNoCiAgICAgICk7CiAgICAgIHZhciB2ID0gQ2FydGVzaWFuMy5ub3JtYWxpemUoCiAgICAgICAgQ2FydGVzaWFuMy5zdWJ0cmFjdChzLCBwb3NpdGlvbiwgcmVmZXJlbmNlU2NyYXRjaCksCiAgICAgICAgcmVmZXJlbmNlU2NyYXRjaAogICAgICApOwogICAgICB2YXIgZG90UHJvZHVjdCA9IENhcnRlc2lhbjMuZG90KHYsIGRpcmVjdGlvbik7CiAgICAgIGlmIChkb3RQcm9kdWN0ID4gbWF4aW11bVZhbHVlKSB7CiAgICAgICAgbWF4aW11bVZhbHVlID0gZG90UHJvZHVjdDsKICAgICAgICBjbG9zZXN0ID0gQ2FydGVzaWFuMy5jbG9uZShzLCBjbG9zZXN0KTsKICAgICAgfQogICAgfQogICAgdmFyIHN1cmZhY2VQb2ludCA9IGVsbGlwc29pZC5jYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYygKICAgICAgY2xvc2VzdCwKICAgICAgc3VyZlBvaW50U2NyYXRjaAogICAgKTsKICAgIG1heGltdW1WYWx1ZSA9IENlc2l1bU1hdGguY2xhbXAobWF4aW11bVZhbHVlLCAwLCAxKTsKICAgIGFsdGl0dWRlID0gQ2FydGVzaWFuMy5tYWduaXR1ZGUoCiAgICAgIENhcnRlc2lhbjMuc3VidHJhY3QoY2xvc2VzdCwgcG9zaXRpb24sIHJlZmVyZW5jZVNjcmF0Y2gpCiAgICApICogTWF0aC5zcXJ0KDEgLSBtYXhpbXVtVmFsdWUgKiBtYXhpbXVtVmFsdWUpOwogICAgYWx0aXR1ZGUgPSBpbnRlcnNlY3RzID8gLWFsdGl0dWRlIDogYWx0aXR1ZGU7CiAgICBzdXJmYWNlUG9pbnQueiA9IGFsdGl0dWRlOwogICAgcmV0dXJuIGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbihzdXJmYWNlUG9pbnQsIG5ldyBWZWN0b3IzJDEoKSk7CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CnZhciBsaW5lU2VnbWVudFBsYW5lRGlmZmVyZW5jZSA9IG5ldyBWZWN0b3IzJDEoKTsKSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZSA9IGZ1bmN0aW9uKGVuZFBvaW50MCwgZW5kUG9pbnQxLCBwbGFuZSwgcmVzdWx0KSB7CiAgaWYgKCFkZWZpbmVkJDEoZW5kUG9pbnQwKSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJlbmRQb2ludDAgaXMgcmVxdWlyZWQuIik7CiAgfQogIGlmICghZGVmaW5lZCQxKGVuZFBvaW50MSkpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigiZW5kUG9pbnQxIGlzIHJlcXVpcmVkLiIpOwogIH0KICBpZiAoIWRlZmluZWQkMShwbGFuZSkpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigicGxhbmUgaXMgcmVxdWlyZWQuIik7CiAgfQogIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgIHJlc3VsdCA9IG5ldyBWZWN0b3IzJDEoKTsKICB9CiAgdmFyIGRpZmZlcmVuY2UgPSBDYXJ0ZXNpYW4zLnN1YnRyYWN0KAogICAgZW5kUG9pbnQxLAogICAgZW5kUG9pbnQwLAogICAgbGluZVNlZ21lbnRQbGFuZURpZmZlcmVuY2UKICApOwogIHZhciBub3JtYWwgPSBwbGFuZS5ub3JtYWw7CiAgdmFyIG5Eb3REaWZmID0gQ2FydGVzaWFuMy5kb3Qobm9ybWFsLCBkaWZmZXJlbmNlKTsKICBpZiAoTWF0aC5hYnMobkRvdERpZmYpIDwgQ2VzaXVtTWF0aC5FUFNJTE9ONikgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIG5Eb3RQMCA9IENhcnRlc2lhbjMuZG90KG5vcm1hbCwgZW5kUG9pbnQwKTsKICB2YXIgdCA9IC0ocGxhbmUuY29uc3RhbnQgKyBuRG90UDApIC8gbkRvdERpZmY7CiAgaWYgKHQgPCAwIHx8IHQgPiAxKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBDYXJ0ZXNpYW4zLm11bHRpcGx5QnlTY2FsYXIoZGlmZmVyZW5jZSwgdCwgcmVzdWx0KTsKICBDYXJ0ZXNpYW4zLmFkZChlbmRQb2ludDAsIHJlc3VsdCwgcmVzdWx0KTsKICByZXR1cm4gcmVzdWx0Owp9OwpJbnRlcnNlY3Rpb25UZXN0cy50cmlhbmdsZVBsYW5lSW50ZXJzZWN0aW9uID0gZnVuY3Rpb24ocDAsIHAxLCBwMiwgcGxhbmUpIHsKICBpZiAoIWRlZmluZWQkMShwMCkgfHwgIWRlZmluZWQkMShwMSkgfHwgIWRlZmluZWQkMShwMikgfHwgIWRlZmluZWQkMShwbGFuZSkpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigicDAsIHAxLCBwMiwgYW5kIHBsYW5lIGFyZSByZXF1aXJlZC4iKTsKICB9CiAgdmFyIHBsYW5lTm9ybWFsID0gcGxhbmUubm9ybWFsOwogIHZhciBwbGFuZUQgPSBwbGFuZS5jb25zdGFudDsKICB2YXIgcDBCZWhpbmQgPSBDYXJ0ZXNpYW4zLmRvdChwbGFuZU5vcm1hbCwgcDApICsgcGxhbmVEIDwgMDsKICB2YXIgcDFCZWhpbmQgPSBDYXJ0ZXNpYW4zLmRvdChwbGFuZU5vcm1hbCwgcDEpICsgcGxhbmVEIDwgMDsKICB2YXIgcDJCZWhpbmQgPSBDYXJ0ZXNpYW4zLmRvdChwbGFuZU5vcm1hbCwgcDIpICsgcGxhbmVEIDwgMDsKICB2YXIgbnVtQmVoaW5kID0gMDsKICBudW1CZWhpbmQgKz0gcDBCZWhpbmQgPyAxIDogMDsKICBudW1CZWhpbmQgKz0gcDFCZWhpbmQgPyAxIDogMDsKICBudW1CZWhpbmQgKz0gcDJCZWhpbmQgPyAxIDogMDsKICB2YXIgdTEsIHUyOwogIGlmIChudW1CZWhpbmQgPT09IDEgfHwgbnVtQmVoaW5kID09PSAyKSB7CiAgICB1MSA9IG5ldyBWZWN0b3IzJDEoKTsKICAgIHUyID0gbmV3IFZlY3RvcjMkMSgpOwogIH0KICBpZiAobnVtQmVoaW5kID09PSAxKSB7CiAgICBpZiAocDBCZWhpbmQpIHsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZShwMCwgcDEsIHBsYW5lLCB1MSk7CiAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDAsIHAyLCBwbGFuZSwgdTIpOwogICAgICByZXR1cm4gewogICAgICAgIHBvc2l0aW9uczogW3AwLCBwMSwgcDIsIHUxLCB1Ml0sCiAgICAgICAgaW5kaWNlczogWwogICAgICAgICAgMCwKICAgICAgICAgIDMsCiAgICAgICAgICA0LAogICAgICAgICAgMSwKICAgICAgICAgIDIsCiAgICAgICAgICA0LAogICAgICAgICAgMSwKICAgICAgICAgIDQsCiAgICAgICAgICAzCiAgICAgICAgXQogICAgICB9OwogICAgfSBlbHNlIGlmIChwMUJlaGluZCkgewogICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAxLCBwMiwgcGxhbmUsIHUxKTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZShwMSwgcDAsIHBsYW5lLCB1Mik7CiAgICAgIHJldHVybiB7CiAgICAgICAgcG9zaXRpb25zOiBbcDAsIHAxLCBwMiwgdTEsIHUyXSwKICAgICAgICBpbmRpY2VzOiBbCiAgICAgICAgICAxLAogICAgICAgICAgMywKICAgICAgICAgIDQsCiAgICAgICAgICAyLAogICAgICAgICAgMCwKICAgICAgICAgIDQsCiAgICAgICAgICAyLAogICAgICAgICAgNCwKICAgICAgICAgIDMKICAgICAgICBdCiAgICAgIH07CiAgICB9IGVsc2UgaWYgKHAyQmVoaW5kKSB7CiAgICAgIEludGVyc2VjdGlvblRlc3RzLmxpbmVTZWdtZW50UGxhbmUocDIsIHAwLCBwbGFuZSwgdTEpOwogICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAyLCBwMSwgcGxhbmUsIHUyKTsKICAgICAgcmV0dXJuIHsKICAgICAgICBwb3NpdGlvbnM6IFtwMCwgcDEsIHAyLCB1MSwgdTJdLAogICAgICAgIGluZGljZXM6IFsKICAgICAgICAgIDIsCiAgICAgICAgICAzLAogICAgICAgICAgNCwKICAgICAgICAgIDAsCiAgICAgICAgICAxLAogICAgICAgICAgNCwKICAgICAgICAgIDAsCiAgICAgICAgICA0LAogICAgICAgICAgMwogICAgICAgIF0KICAgICAgfTsKICAgIH0KICB9IGVsc2UgaWYgKG51bUJlaGluZCA9PT0gMikgewogICAgaWYgKCFwMEJlaGluZCkgewogICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAxLCBwMCwgcGxhbmUsIHUxKTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZShwMiwgcDAsIHBsYW5lLCB1Mik7CiAgICAgIHJldHVybiB7CiAgICAgICAgcG9zaXRpb25zOiBbcDAsIHAxLCBwMiwgdTEsIHUyXSwKICAgICAgICBpbmRpY2VzOiBbCiAgICAgICAgICAxLAogICAgICAgICAgMiwKICAgICAgICAgIDQsCiAgICAgICAgICAxLAogICAgICAgICAgNCwKICAgICAgICAgIDMsCiAgICAgICAgICAwLAogICAgICAgICAgMywKICAgICAgICAgIDQKICAgICAgICBdCiAgICAgIH07CiAgICB9IGVsc2UgaWYgKCFwMUJlaGluZCkgewogICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAyLCBwMSwgcGxhbmUsIHUxKTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZShwMCwgcDEsIHBsYW5lLCB1Mik7CiAgICAgIHJldHVybiB7CiAgICAgICAgcG9zaXRpb25zOiBbcDAsIHAxLCBwMiwgdTEsIHUyXSwKICAgICAgICBpbmRpY2VzOiBbCiAgICAgICAgICAyLAogICAgICAgICAgMCwKICAgICAgICAgIDQsCiAgICAgICAgICAyLAogICAgICAgICAgNCwKICAgICAgICAgIDMsCiAgICAgICAgICAxLAogICAgICAgICAgMywKICAgICAgICAgIDQKICAgICAgICBdCiAgICAgIH07CiAgICB9IGVsc2UgaWYgKCFwMkJlaGluZCkgewogICAgICBJbnRlcnNlY3Rpb25UZXN0cy5saW5lU2VnbWVudFBsYW5lKHAwLCBwMiwgcGxhbmUsIHUxKTsKICAgICAgSW50ZXJzZWN0aW9uVGVzdHMubGluZVNlZ21lbnRQbGFuZShwMSwgcDIsIHBsYW5lLCB1Mik7CiAgICAgIHJldHVybiB7CiAgICAgICAgcG9zaXRpb25zOiBbcDAsIHAxLCBwMiwgdTEsIHUyXSwKICAgICAgICBpbmRpY2VzOiBbCiAgICAgICAgICAwLAogICAgICAgICAgMSwKICAgICAgICAgIDQsCiAgICAgICAgICAwLAogICAgICAgICAgNCwKICAgICAgICAgIDMsCiAgICAgICAgICAyLAogICAgICAgICAgMywKICAgICAgICAgIDQKICAgICAgICBdCiAgICAgIH07CiAgICB9CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CmNsYXNzIENhcnRlc2lhbjQgewogIHN0YXRpYyBjbG9uZSh2MSwgdjIpIHsKICAgIGlmICghdjIpIHsKICAgICAgdjIgPSBuZXcgVmVjdG9yNCgpOwogICAgfQogICAgdjIuY29weSh2MSk7CiAgICByZXR1cm4gdjI7CiAgfQogIHN0YXRpYyBmcm9tRWxlbWVudHMoeCwgeSwgeiwgdywgcmVzdWx0KSB7CiAgICBpZiAoIXJlc3VsdCkgewogICAgICByZXN1bHQgPSBuZXcgVmVjdG9yNCgpOwogICAgfQogICAgcmVzdWx0LnNldCh4LCB5LCB6LCB3KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHN0YXRpYyBsZXJwKHN0YXJ0LCBlbmQsIHQsIHJlc3VsdCkgewogICAgaWYgKCFyZXN1bHQpIHsKICAgICAgcmVzdWx0ID0gbmV3IFZlY3RvcjQoKTsKICAgIH0KICAgIHJlc3VsdC5sZXJwVmVjdG9ycyhzdGFydCwgZW5kLCB0KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHN0YXRpYyBlcXVhbHModjEsIHYyKSB7CiAgICByZXR1cm4gdjEuZXF1YWxzKHYyKTsKICB9CiAgc3RhdGljIG5vcm1hbGl6ZSh2MSwgdjIpIHsKICAgIGlmICh2MSA9PT0gdjIpIHsKICAgICAgdjEubm9ybWFsaXplKCk7CiAgICAgIHJldHVybiB2MTsKICAgIH0KICAgIHYyLmNvcHkodjEpOwogICAgdjIubm9ybWFsaXplKCk7CiAgICByZXR1cm4gdjI7CiAgfQogIHN0YXRpYyBhZGQodjEsIHYyLCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3I0KCk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0LmFkZFZlY3RvcnModjEsIHYyKTsKICB9CiAgc3RhdGljIG11bHRpcGx5QnlTY2FsYXIodjEsIHNjYWxhciwgcmVzdWx0KSB7CiAgICBpZiAoIXJlc3VsdCkgewogICAgICByZXN1bHQgPSBuZXcgVmVjdG9yNCgpOwogICAgfQogICAgcmVzdWx0LmNvcHkodjEpLm11bHRpcGx5U2NhbGFyKHNjYWxhcik7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBzdGF0aWMgc3VidHJhY3QodjEsIHYyLCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3I0KCk7CiAgICB9CiAgICByZXN1bHQuc3ViVmVjdG9ycyh2MSwgdjIpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc3RhdGljIGRpc3RhbmNlKHYxLCB2MikgewogICAgcmV0dXJuIHYxLmRpc3RhbmNlVG8odjIpOwogIH0KfQpfX3B1YmxpY0ZpZWxkKENhcnRlc2lhbjQsICJaRVJPIiwgbmV3IFZlY3RvcjQoMCwgMCwgMCwgMCkpOwpfX3B1YmxpY0ZpZWxkKENhcnRlc2lhbjQsICJVTklUX1ciLCBPYmplY3QuZnJlZXplKG5ldyBWZWN0b3I0KDAsIDAsIDAsIDEpKSk7CmNvbnN0IHNjcmF0Y2hOb3JtYWwgPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IHNjcmF0Y2hDYXJ0ZXNpYW4kMSA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3Qgc2NyYXRjaEludmVyc2VUcmFuc3Bvc2UgPSBuZXcgTWF0cml4NCgpOwpjb25zdCBzY3JhdGNoUGxhbmVDYXJ0ZXNpYW40ID0gbmV3IFZlY3RvcjQoMCwgMCwgMCwgMCk7CmNvbnN0IHNjcmF0Y2hUcmFuc2Zvcm1Ob3JtYWwgPSBuZXcgVmVjdG9yMyQxKCk7CmNsYXNzIFN0YXRpY1BsYW5lIHsKICBzdGF0aWMgZnJvbVBvaW50Tm9ybWFsKHBvaW50LCBub3JtYWwsIHJlc3VsdCkgewogICAgaWYgKCFyZXN1bHQpIHsKICAgICAgcmVzdWx0ID0gbmV3IFBsYW5lKCk7CiAgICB9CiAgICByZXN1bHQuc2V0RnJvbU5vcm1hbEFuZENvcGxhbmFyUG9pbnQobm9ybWFsLCBwb2ludCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBzdGF0aWMgZnJvbUNhcnRlc2lhbjQoY29lZmZpY2llbnRzLCByZXN1bHQpIHsKICAgIGNvbnN0IG5vcm1hbCA9IENhcnRlc2lhbjMuZnJvbUNhcnRlc2lhbjQoY29lZmZpY2llbnRzLCBzY3JhdGNoTm9ybWFsKTsKICAgIGNvbnN0IGRpc3RhbmNlID0gY29lZmZpY2llbnRzLnc7CiAgICBpZiAoIUNlc2l1bU1hdGguZXF1YWxzRXBzaWxvbigKICAgICAgQ2FydGVzaWFuMy5tYWduaXR1ZGUobm9ybWFsKSwKICAgICAgMSwKICAgICAgQ2VzaXVtTWF0aC5FUFNJTE9ONgogICAgKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIm5vcm1hbCBtdXN0IGJlIG5vcm1hbGl6ZWQuIik7CiAgICB9CiAgICBpZiAoIWRlZmluZWQkMShyZXN1bHQpKSB7CiAgICAgIHJldHVybiBuZXcgU3RhdGljUGxhbmUobm9ybWFsLCBkaXN0YW5jZSk7CiAgICB9CiAgICBDYXJ0ZXNpYW4zLmNsb25lKG5vcm1hbCwgcmVzdWx0Lm5vcm1hbCk7CiAgICByZXN1bHQuY29uc3RhbnQgPSBkaXN0YW5jZTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHN0YXRpYyBnZXRQb2ludERpc3RhbmNlKHBsYW5lLCBwb2ludCkgewogICAgcmV0dXJuIENhcnRlc2lhbjMuZG90KHBsYW5lLm5vcm1hbCwgcG9pbnQpICsgcGxhbmUuY29uc3RhbnQ7CiAgfQogIHN0YXRpYyBwcm9qZWN0UG9pbnRPbnRvUGxhbmUocGxhbmUsIHBvaW50LCByZXN1bHQpIHsKICAgIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgICAgcmVzdWx0ID0gbmV3IFZlY3RvcjMkMSgpOwogICAgfQogICAgY29uc3QgcG9pbnREaXN0YW5jZSA9IFN0YXRpY1BsYW5lLmdldFBvaW50RGlzdGFuY2UocGxhbmUsIHBvaW50KTsKICAgIGNvbnN0IHNjYWxlZE5vcm1hbCA9IENhcnRlc2lhbjMubXVsdGlwbHlCeVNjYWxhcigKICAgICAgcGxhbmUubm9ybWFsLAogICAgICBwb2ludERpc3RhbmNlLAogICAgICBzY3JhdGNoQ2FydGVzaWFuJDEKICAgICk7CiAgICByZXR1cm4gQ2FydGVzaWFuMy5zdWJ0cmFjdChwb2ludCwgc2NhbGVkTm9ybWFsLCByZXN1bHQpOwogIH0KICBzdGF0aWMgdHJhbnNmb3JtKHBsYW5lLCB0cmFuc2Zvcm0sIHJlc3VsdCkgewogICAgY29uc3Qgbm9ybWFsID0gcGxhbmUubm9ybWFsOwogICAgY29uc3QgZGlzdGFuY2UgPSBwbGFuZS5jb25zdGFudDsKICAgIGNvbnN0IGludmVyc2VUcmFuc3Bvc2UgPSBNYXRyaXg0LmludmVyc2VUcmFuc3Bvc2UoCiAgICAgIHRyYW5zZm9ybSwKICAgICAgc2NyYXRjaEludmVyc2VUcmFuc3Bvc2UKICAgICk7CiAgICBsZXQgcGxhbmVBc0NhcnRlc2lhbjQgPSBDYXJ0ZXNpYW40LmZyb21FbGVtZW50cygKICAgICAgbm9ybWFsLngsCiAgICAgIG5vcm1hbC55LAogICAgICBub3JtYWwueiwKICAgICAgZGlzdGFuY2UsCiAgICAgIHNjcmF0Y2hQbGFuZUNhcnRlc2lhbjQKICAgICk7CiAgICBwbGFuZUFzQ2FydGVzaWFuNCA9IE1hdHJpeDQubXVsdGlwbHlCeVZlY3RvcigKICAgICAgaW52ZXJzZVRyYW5zcG9zZSwKICAgICAgcGxhbmVBc0NhcnRlc2lhbjQsCiAgICAgIHBsYW5lQXNDYXJ0ZXNpYW40CiAgICApOwogICAgY29uc3QgdHJhbnNmb3JtZWROb3JtYWwgPSBDYXJ0ZXNpYW4zLmZyb21DYXJ0ZXNpYW40KAogICAgICBwbGFuZUFzQ2FydGVzaWFuNCwKICAgICAgc2NyYXRjaFRyYW5zZm9ybU5vcm1hbAogICAgKTsKICAgIHBsYW5lQXNDYXJ0ZXNpYW40ID0gQ2FydGVzaWFuNC5kaXZpZGVCeVNjYWxhcigKICAgICAgcGxhbmVBc0NhcnRlc2lhbjQsCiAgICAgIENhcnRlc2lhbjMubWFnbml0dWRlKHRyYW5zZm9ybWVkTm9ybWFsKSwKICAgICAgcGxhbmVBc0NhcnRlc2lhbjQKICAgICk7CiAgICByZXR1cm4gUGxhbmUuZnJvbUNhcnRlc2lhbjQocGxhbmVBc0NhcnRlc2lhbjQsIHJlc3VsdCk7CiAgfQogIHN0YXRpYyBjbG9uZShwbGFuZSwgcmVzdWx0KSB7CiAgICBpZiAoIWRlZmluZWQkMShyZXN1bHQpKSB7CiAgICAgIHJldHVybiBuZXcgU3RhdGljUGxhbmUocGxhbmUubm9ybWFsLCBwbGFuZS5jb25zdGFudCk7CiAgICB9CiAgICBDYXJ0ZXNpYW4zLmNsb25lKHBsYW5lLm5vcm1hbCwgcmVzdWx0Lm5vcm1hbCk7CiAgICByZXN1bHQuY29uc3RhbnQgPSBwbGFuZS5jb25zdGFudDsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHN0YXRpYyBlcXVhbHMobGVmdCwgcmlnaHQpIHsKICAgIHJldHVybiBsZWZ0LmNvbnN0YW50ID09PSByaWdodC5jb25zdGFudCAmJiBDYXJ0ZXNpYW4zLmVxdWFscyhsZWZ0Lm5vcm1hbCwgcmlnaHQubm9ybWFsKTsKICB9Cn0KUGxhbmUuT1JJR0lOX1hZX1BMQU5FID0gT2JqZWN0LmZyZWV6ZShuZXcgU3RhdGljUGxhbmUoQ2FydGVzaWFuMy5VTklUX1osIDApKTsKUGxhbmUuT1JJR0lOX1laX1BMQU5FID0gT2JqZWN0LmZyZWV6ZShuZXcgU3RhdGljUGxhbmUoQ2FydGVzaWFuMy5VTklUX1gsIDApKTsKUGxhbmUuT1JJR0lOX1pYX1BMQU5FID0gT2JqZWN0LmZyZWV6ZShuZXcgU3RhdGljUGxhbmUoQ2FydGVzaWFuMy5VTklUX1ksIDApKTsKY29uc3Qgc2NyYXRjaENhcnQ0ID0gbmV3IFZlY3RvcjQoMCwgMCwgMCwgMCk7CmNvbnN0IHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVSYXkkMSA9IG5ldyBSYXkoKTsKY29uc3Qgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZUNhcnRlc2lhbjMkMSA9IG5ldyBWZWN0b3IzJDEoKTsKY2xhc3MgRWxsaXBzb2lkVGFuZ2VudFBsYW5lIHsKICBjb25zdHJ1Y3RvcihvcmlnaW4sIGVsbGlwc29pZCkgewogICAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlKGVsbGlwc29pZCwgRWxsaXBzb2lkLldHUzg0KTsKICAgIG9yaWdpbiA9IGVsbGlwc29pZC5zY2FsZVRvR2VvZGV0aWNTdXJmYWNlKG9yaWdpbik7CiAgICBpZiAoIWRlZmluZWQkMShvcmlnaW4pKSB7CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigKICAgICAgICAib3JpZ2luIG11c3Qgbm90IGJlIGF0IHRoZSBjZW50ZXIgb2YgdGhlIGVsbGlwc29pZC4iCiAgICAgICk7CiAgICB9CiAgICBjb25zdCBlYXN0Tm9ydGhVcCA9IFRyYW5zZm9ybXMuZWFzdE5vcnRoVXBUb0ZpeGVkRnJhbWUob3JpZ2luLCBlbGxpcHNvaWQpOwogICAgdGhpcy5fZWxsaXBzb2lkID0gZWxsaXBzb2lkOwogICAgdGhpcy5fb3JpZ2luID0gb3JpZ2luOwogICAgdGhpcy5feEF4aXMgPSBDYXJ0ZXNpYW4zLmZyb21DYXJ0ZXNpYW40KAogICAgICBTdGF0aWNNYXRyaXg0LmdldENvbHVtbihlYXN0Tm9ydGhVcCwgMCwgc2NyYXRjaENhcnQ0KQogICAgKTsKICAgIHRoaXMuX3lBeGlzID0gQ2FydGVzaWFuMy5mcm9tQ2FydGVzaWFuNCgKICAgICAgU3RhdGljTWF0cml4NC5nZXRDb2x1bW4oZWFzdE5vcnRoVXAsIDEsIHNjcmF0Y2hDYXJ0NCkKICAgICk7CiAgICBjb25zdCBub3JtYWwgPSBDYXJ0ZXNpYW4zLmZyb21DYXJ0ZXNpYW40KAogICAgICBTdGF0aWNNYXRyaXg0LmdldENvbHVtbihlYXN0Tm9ydGhVcCwgMiwgc2NyYXRjaENhcnQ0KQogICAgKTsKICAgIHRoaXMuX3BsYW5lID0gU3RhdGljUGxhbmUuZnJvbVBvaW50Tm9ybWFsKG9yaWdpbiwgbm9ybWFsKTsKICB9CiAgc3RhdGljIGZyb21Qb2ludHMocG9zaXRpb25zLCBlbGxpcHNvaWQpIHsKICAgIGxldCBtaW5pbXVtWCA9IHBvc2l0aW9uc1swXS54OwogICAgbGV0IG1pbmltdW1ZID0gcG9zaXRpb25zWzBdLnk7CiAgICBsZXQgbWluaW11bVogPSBwb3NpdGlvbnNbMF0uejsKICAgIGxldCBtYXhpbXVtWCA9IHBvc2l0aW9uc1swXS54OwogICAgbGV0IG1heGltdW1ZID0gcG9zaXRpb25zWzBdLnk7CiAgICBsZXQgbWF4aW11bVogPSBwb3NpdGlvbnNbMF0uejsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHAgPSBwb3NpdGlvbnNbaV07CiAgICAgIGNvbnN0IHggPSBwLng7CiAgICAgIGNvbnN0IHkgPSBwLnk7CiAgICAgIGNvbnN0IHogPSBwLno7CiAgICAgIG1pbmltdW1YID0gTWF0aC5taW4oeCwgbWluaW11bVgpOwogICAgICBtYXhpbXVtWCA9IE1hdGgubWF4KHgsIG1heGltdW1YKTsKICAgICAgbWluaW11bVkgPSBNYXRoLm1pbih5LCBtaW5pbXVtWSk7CiAgICAgIG1heGltdW1ZID0gTWF0aC5tYXgoeSwgbWF4aW11bVkpOwogICAgICBtaW5pbXVtWiA9IE1hdGgubWluKHosIG1pbmltdW1aKTsKICAgICAgbWF4aW11bVogPSBNYXRoLm1heCh6LCBtYXhpbXVtWik7CiAgICB9CiAgICBjb25zdCBtaW4gPSBuZXcgVmVjdG9yMyQxKG1pbmltdW1YLCBtaW5pbXVtWSwgbWluaW11bVopOwogICAgY29uc3QgbWF4ID0gbmV3IFZlY3RvcjMkMShtYXhpbXVtWCwgbWF4aW11bVksIG1heGltdW1aKTsKICAgIGNvbnN0IGF4aXNBbGlnaEJveCA9IG5ldyBCb3gzKG1pbiwgbWF4KTsKICAgIGxldCBjZW50ZXIgPSBuZXcgVmVjdG9yMyQxKCk7CiAgICBjZW50ZXIgPSBheGlzQWxpZ2hCb3guZ2V0Q2VudGVyKGNlbnRlcik7CiAgICByZXR1cm4gbmV3IEVsbGlwc29pZFRhbmdlbnRQbGFuZShjZW50ZXIsIGVsbGlwc29pZCk7CiAgfQogIHByb2plY3RQb2ludFRvTmVhcmVzdE9uUGxhbmUoY2FydGVzaWFuLCByZXN1bHQpIHsKICAgIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgICAgcmVzdWx0ID0gbmV3IENhcnRlc2lhbjIoKTsKICAgIH0KICAgIGNvbnN0IHJheSA9IHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVSYXkkMTsKICAgIHJheS5vcmlnaW4gPSBjYXJ0ZXNpYW47CiAgICBDYXJ0ZXNpYW4zLmNsb25lKHRoaXMuX3BsYW5lLm5vcm1hbCwgcmF5LmRpcmVjdGlvbik7CiAgICBsZXQgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0cy5yYXlQbGFuZSgKICAgICAgcmF5LAogICAgICB0aGlzLl9wbGFuZSwKICAgICAgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZUNhcnRlc2lhbjMkMQogICAgKTsKICAgIGlmICghZGVmaW5lZCQxKGludGVyc2VjdGlvblBvaW50KSkgewogICAgICBDYXJ0ZXNpYW4zLm5lZ2F0ZShyYXkuZGlyZWN0aW9uLCByYXkuZGlyZWN0aW9uKTsKICAgICAgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0cy5yYXlQbGFuZSgKICAgICAgICByYXksCiAgICAgICAgdGhpcy5fcGxhbmUsCiAgICAgICAgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZUNhcnRlc2lhbjMkMQogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWQkMShpbnRlcnNlY3Rpb25Qb2ludCkpIHsKICAgICAgY29uc3QgdiA9IENhcnRlc2lhbjMuc3VidHJhY3QoCiAgICAgICAgaW50ZXJzZWN0aW9uUG9pbnQsCiAgICAgICAgdGhpcy5fb3JpZ2luLAogICAgICAgIGludGVyc2VjdGlvblBvaW50CiAgICAgICk7CiAgICAgIGNvbnN0IHggPSBDYXJ0ZXNpYW4zLmRvdCh0aGlzLl94QXhpcywgdik7CiAgICAgIGNvbnN0IHkgPSBDYXJ0ZXNpYW4zLmRvdCh0aGlzLl95QXhpcywgdik7CiAgICAgIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgICAgICByZXR1cm4gbmV3IFZlY3RvcjIoeCwgeSk7CiAgICAgIH0KICAgICAgcmVzdWx0LnggPSB4OwogICAgICByZXN1bHQueSA9IHk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBwcm9qZWN0UG9pbnRzT250b1BsYW5lKGNhcnRlc2lhbnMsIHJlc3VsdCkgewogICAgaWYgKCFkZWZpbmVkJDEocmVzdWx0KSkgewogICAgICByZXN1bHQgPSBbXTsKICAgIH0KICAgIGxldCBjb3VudCA9IDA7CiAgICBjb25zdCBsZW5ndGggPSBjYXJ0ZXNpYW5zLmxlbmd0aDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcCA9IHRoaXMucHJvamVjdFBvaW50T250b1BsYW5lKGNhcnRlc2lhbnNbaV0sIHJlc3VsdFtjb3VudF0pOwogICAgICBpZiAocCkgewogICAgICAgIHJlc3VsdFtjb3VudF0gPSBwOwogICAgICAgIGNvdW50Kys7CiAgICAgIH0KICAgIH0KICAgIHJlc3VsdC5sZW5ndGggPSBjb3VudDsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHByb2plY3RQb2ludE9udG9QbGFuZShjYXJ0ZXNpYW4sIHJlc3VsdCkgewogICAgY29uc3QgcmF5ID0gc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZVJheSQxOwogICAgcmF5Lm9yaWdpbiA9IGNhcnRlc2lhbjsKICAgIENhcnRlc2lhbjMubm9ybWFsaXplKGNhcnRlc2lhbiwgcmF5LmRpcmVjdGlvbik7CiAgICBsZXQgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0cy5yYXlQbGFuZSgKICAgICAgcmF5LAogICAgICB0aGlzLl9wbGFuZSwKICAgICAgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZUNhcnRlc2lhbjMkMQogICAgKTsKICAgIGlmICghZGVmaW5lZCQxKGludGVyc2VjdGlvblBvaW50KSkgewogICAgICBDYXJ0ZXNpYW4zLm5lZ2F0ZShyYXkuZGlyZWN0aW9uLCByYXkuZGlyZWN0aW9uKTsKICAgICAgaW50ZXJzZWN0aW9uUG9pbnQgPSBJbnRlcnNlY3Rpb25UZXN0cy5yYXlQbGFuZSgKICAgICAgICByYXksCiAgICAgICAgdGhpcy5fcGxhbmUsCiAgICAgICAgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZUNhcnRlc2lhbjMkMQogICAgICApOwogICAgfQogICAgaWYgKGRlZmluZWQkMShpbnRlcnNlY3Rpb25Qb2ludCkpIHsKICAgICAgY29uc3QgdiA9IENhcnRlc2lhbjMuc3VidHJhY3QoCiAgICAgICAgaW50ZXJzZWN0aW9uUG9pbnQsCiAgICAgICAgdGhpcy5fb3JpZ2luLAogICAgICAgIGludGVyc2VjdGlvblBvaW50CiAgICAgICk7CiAgICAgIGNvbnN0IHggPSBDYXJ0ZXNpYW4zLmRvdCh0aGlzLl94QXhpcywgdik7CiAgICAgIGNvbnN0IHkgPSBDYXJ0ZXNpYW4zLmRvdCh0aGlzLl95QXhpcywgdik7CiAgICAgIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgICAgICByZXR1cm4gbmV3IFZlY3RvcjIoeCwgeSk7CiAgICAgIH0KICAgICAgcmVzdWx0LnggPSB4OwogICAgICByZXN1bHQueSA9IHk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgfQogIGdldCBlbGxpcHNvaWQoKSB7CiAgICByZXR1cm4gdGhpcy5fZWxsaXBzb2lkOwogIH0KICBnZXQgb3JpZ2luKCkgewogICAgcmV0dXJuIHRoaXMuX29yaWdpbjsKICB9CiAgZ2V0IHBsYW5lKCkgewogICAgcmV0dXJuIHRoaXMuX3BsYW5lOwogIH0KICBnZXQgeEF4aXMoKSB7CiAgICByZXR1cm4gdGhpcy5feEF4aXM7CiAgfQogIGdldCB5QXhpcygpIHsKICAgIHJldHVybiB0aGlzLl95QXhpczsKICB9CiAgZ2V0IHpBeGlzKCkgewogICAgcmV0dXJuIHRoaXMuX3BsYW5lLm5vcm1hbDsKICB9Cn0KY29uc3Qgc2NyYXRjaENhcnRvZ3JhcGhpYyA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3Qgc2NyYXRjaENhcnRlc2lhbiA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3Qgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZVJheSA9IG5ldyBSYXkoKTsKY29uc3Qgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZVJheURpcmVjdGlvbiA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3Qgc2NyYXRjaFByb2plY3RQb2ludE9udG9QbGFuZUNhcnRlc2lhbjMgPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IF9TdGVyZW9ncmFwaGljID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHBvc2l0aW9uLCB0YW5nZW50UGxhbmUpIHsKICAgIHRoaXMucG9zaXRpb24gPSBwb3NpdGlvbjsKICAgIGlmICghdGhpcy5wb3NpdGlvbikgewogICAgICBwb3NpdGlvbiA9IG5ldyBWZWN0b3IyKCk7CiAgICB9CiAgICB0aGlzLnRhbmdlbnRQbGFuZSA9IHRhbmdlbnRQbGFuZTsKICAgIGlmICghdGhpcy50YW5nZW50UGxhbmUpIHsKICAgICAgdGhpcy50YW5nZW50UGxhbmUgPSBfU3RlcmVvZ3JhcGhpYy5OT1JUSF9QT0xFX1RBTkdFTlRfUExBTkU7CiAgICB9CiAgfQogIGdldExhdGl0dWRlKGVsbGlwc29pZCkgewogICAgaWYgKCFlbGxpcHNvaWQpIHsKICAgICAgZWxsaXBzb2lkID0gRWxsaXBzb2lkLldHUzg0OwogICAgfQogICAgc2NyYXRjaENhcnRvZ3JhcGhpYy54ID0gdGhpcy5sb25naXR1ZGU7CiAgICBzY3JhdGNoQ2FydG9ncmFwaGljLnkgPSB0aGlzLmNvbmZvcm1hbExhdGl0dWRlOwogICAgc2NyYXRjaENhcnRvZ3JhcGhpYy56ID0gMDsKICAgIGNvbnN0IGNhcnRlc2lhbiA9IHRoaXMuZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICBzY3JhdGNoQ2FydG9ncmFwaGljLAogICAgICBzY3JhdGNoQ2FydGVzaWFuCiAgICApOwogICAgZWxsaXBzb2lkLmNhcnRlc2lhblRvQ2FydG9ncmFwaGljKGNhcnRlc2lhbiwgc2NyYXRjaENhcnRvZ3JhcGhpYyk7CiAgICByZXR1cm4gc2NyYXRjaENhcnRvZ3JhcGhpYy55OwogIH0KICBzdGF0aWMgZnJvbUNhcnRlc2lhbihjYXJ0ZXNpYW4sIHJlc3VsdCkgewogICAgY29uc3Qgc2lnbjIgPSBjYXJ0ZXNpYW4ueiA8IDAgPyAtMSA6IDE7CiAgICBsZXQgdGFuZ2VudFBsYW5lID0gX1N0ZXJlb2dyYXBoaWMuTk9SVEhfUE9MRV9UQU5HRU5UX1BMQU5FOwogICAgbGV0IG9yaWdpbiA9IF9TdGVyZW9ncmFwaGljLlNPVVRIX1BPTEU7CiAgICBpZiAoc2lnbjIgPCAwKSB7CiAgICAgIHRhbmdlbnRQbGFuZSA9IF9TdGVyZW9ncmFwaGljLlNPVVRIX1BPTEVfVEFOR0VOVF9QTEFORTsKICAgICAgb3JpZ2luID0gX1N0ZXJlb2dyYXBoaWMuTk9SVEhfUE9MRTsKICAgIH0KICAgIGNvbnN0IHJheSA9IHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVSYXk7CiAgICByYXkub3JpZ2luID0gdGFuZ2VudFBsYW5lLmVsbGlwc29pZC5zY2FsZVRvR2VvY2VudHJpY1N1cmZhY2UoCiAgICAgIGNhcnRlc2lhbiwKICAgICAgcmF5Lm9yaWdpbgogICAgKTsKICAgIHJheS5kaXJlY3Rpb24gPSBDYXJ0ZXNpYW4zLnN1YnRyYWN0KAogICAgICByYXkub3JpZ2luLAogICAgICBvcmlnaW4sCiAgICAgIHNjcmF0Y2hQcm9qZWN0UG9pbnRPbnRvUGxhbmVSYXlEaXJlY3Rpb24KICAgICk7CiAgICBDYXJ0ZXNpYW4zLm5vcm1hbGl6ZShyYXkuZGlyZWN0aW9uLCByYXkuZGlyZWN0aW9uKTsKICAgIGNvbnN0IGludGVyc2VjdGlvblBvaW50ID0gSW50ZXJzZWN0aW9uVGVzdHMucmF5UGxhbmUoCiAgICAgIHJheSwKICAgICAgdGFuZ2VudFBsYW5lLnBsYW5lLAogICAgICBzY3JhdGNoUHJvamVjdFBvaW50T250b1BsYW5lQ2FydGVzaWFuMwogICAgKTsKICAgIGNvbnN0IHYgPSBDYXJ0ZXNpYW4zLnN1YnRyYWN0KGludGVyc2VjdGlvblBvaW50LCBvcmlnaW4sIGludGVyc2VjdGlvblBvaW50KTsKICAgIGNvbnN0IHggPSBDYXJ0ZXNpYW4zLmRvdCh0YW5nZW50UGxhbmUueEF4aXMsIHYpOwogICAgY29uc3QgeSA9IHNpZ24yICogQ2FydGVzaWFuMy5kb3QodGFuZ2VudFBsYW5lLnlBeGlzLCB2KTsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJldHVybiBuZXcgX1N0ZXJlb2dyYXBoaWMobmV3IFZlY3RvcjIoeCwgeSksIHRhbmdlbnRQbGFuZSk7CiAgICB9CiAgICByZXN1bHQucG9zaXRpb24gPSBuZXcgVmVjdG9yMih4LCB5KTsKICAgIHJlc3VsdC50YW5nZW50UGxhbmUgPSB0YW5nZW50UGxhbmU7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBjbG9uZShyZXN1bHQpIHsKICAgIHJldHVybiBfU3RlcmVvZ3JhcGhpYy5jbG9uZSh0aGlzLCByZXN1bHQpOwogIH0KICBzdGF0aWMgY2xvbmUoc3RlcmVvZ3JhcGhpYywgcmVzdWx0KSB7CiAgICBpZiAoIXN0ZXJlb2dyYXBoaWMpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJldHVybiBuZXcgX1N0ZXJlb2dyYXBoaWMoCiAgICAgICAgc3RlcmVvZ3JhcGhpYy5wb3NpdGlvbiwKICAgICAgICBzdGVyZW9ncmFwaGljLnRhbmdlbnRQbGFuZQogICAgICApOwogICAgfQogICAgcmVzdWx0LnBvc2l0aW9uID0gc3RlcmVvZ3JhcGhpYy5wb3NpdGlvbjsKICAgIHJlc3VsdC50YW5nZW50UGxhbmUgPSBzdGVyZW9ncmFwaGljLnRhbmdlbnRQbGFuZTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGdldCBlbGxpcHNvaWQoKSB7CiAgICByZXR1cm4gdGhpcy50YW5nZW50UGxhbmUuZWxsaXBzb2lkOwogIH0KICBnZXQgeCgpIHsKICAgIHJldHVybiB0aGlzLnBvc2l0aW9uLng7CiAgfQogIGdldCB5KCkgewogICAgcmV0dXJuIHRoaXMucG9zaXRpb24ueTsKICB9CiAgZ2V0IGNvbmZvcm1hbExhdGl0dWRlKCkgewogICAgY29uc3QgciA9IHRoaXMucG9zaXRpb24ubGVuZ3RoKCk7CiAgICBjb25zdCBkID0gMiAqIHRoaXMuZWxsaXBzb2lkLm1heGltdW1SYWRpdXM7CiAgICBjb25zdCBzaWduMiA9IHRoaXMudGFuZ2VudFBsYW5lLnBsYW5lLm5vcm1hbC56OwogICAgcmV0dXJuIHNpZ24yICogKENlc2l1bU1hdGguUElfT1ZFUl9UV08gLSAyICogTWF0aC5hdGFuMihyLCBkKSk7CiAgfQogIGdldCBsb25naXR1ZGUoKSB7CiAgICBsZXQgbG9uZ2l0dWRlID0gQ2VzaXVtTWF0aC5QSV9PVkVSX1RXTyArIE1hdGguYXRhbjIodGhpcy55LCB0aGlzLngpOwogICAgaWYgKGxvbmdpdHVkZSA+IE1hdGguUEkpIHsKICAgICAgbG9uZ2l0dWRlIC09IENlc2l1bU1hdGguVFdPX1BJOwogICAgfQogICAgcmV0dXJuIGxvbmdpdHVkZTsKICB9Cn07CmxldCBTdGVyZW9ncmFwaGljID0gX1N0ZXJlb2dyYXBoaWM7Cl9fcHVibGljRmllbGQoU3RlcmVvZ3JhcGhpYywgIkhBTEZfVU5JVF9TUEhFUkUiLCBPYmplY3QuZnJlZXplKG5ldyBFbGxpcHNvaWQoMC41LCAwLjUsIDAuNSkpKTsKX19wdWJsaWNGaWVsZChTdGVyZW9ncmFwaGljLCAiTk9SVEhfUE9MRSIsIE9iamVjdC5mcmVlemUobmV3IFZlY3RvcjMkMSgwLCAwLCAwLjUpKSk7Cl9fcHVibGljRmllbGQoU3RlcmVvZ3JhcGhpYywgIlNPVVRIX1BPTEUiLCBPYmplY3QuZnJlZXplKG5ldyBWZWN0b3IzJDEoMCwgMCwgLTAuNSkpKTsKX19wdWJsaWNGaWVsZChTdGVyZW9ncmFwaGljLCAiTk9SVEhfUE9MRV9UQU5HRU5UX1BMQU5FIiwgT2JqZWN0LmZyZWV6ZShuZXcgRWxsaXBzb2lkVGFuZ2VudFBsYW5lKF9TdGVyZW9ncmFwaGljLk5PUlRIX1BPTEUsIF9TdGVyZW9ncmFwaGljLkhBTEZfVU5JVF9TUEhFUkUpKSk7Cl9fcHVibGljRmllbGQoU3RlcmVvZ3JhcGhpYywgIlNPVVRIX1BPTEVfVEFOR0VOVF9QTEFORSIsIE9iamVjdC5mcmVlemUobmV3IEVsbGlwc29pZFRhbmdlbnRQbGFuZShfU3RlcmVvZ3JhcGhpYy5TT1VUSF9QT0xFLCBfU3RlcmVvZ3JhcGhpYy5IQUxGX1VOSVRfU1BIRVJFKSkpOwpuZXcgU3RlcmVvZ3JhcGhpYygpOwpuZXcgU3RlcmVvZ3JhcGhpYygpOwpuZXcgVmVjdG9yMigpOwpuZXcgVmVjdG9yMigpOwpuZXcgU3RlcmVvZ3JhcGhpYygpOwpuZXcgVmVjdG9yMigpOwpmdW5jdGlvbiBzb3J0UG9seWdvblBvaW50cyhwb2ludHMpIHsKICBpZiAocG9pbnRzLmxlbmd0aCA8IDMpIHsKICAgIHRocm93IG5ldyBFcnJvcigiXHU3MEI5XHU3Njg0XHU2NTcwXHU5MUNGXHU1RkM1XHU5ODdCXHU1OTI3XHU0RThFXHU3QjQ5XHU0RThFM1x1NEUyQVx1NjI0RFx1ODBGRFx1NUY2Mlx1NjIxMFx1NTkxQVx1OEZCOVx1NUY2MiIpOwogIH0KICBjb25zdCBjZW50cm9pZCA9IGNhbGN1bGF0ZUNlbnRyb2lkKHBvaW50cyk7CiAgY29uc3QgaW5kZXhlZFBvaW50cyA9IHBvaW50cy5tYXAoKHBvaW50LCBpbmRleCkgPT4gewogICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKHBvaW50LnkgLSBjZW50cm9pZC55LCBwb2ludC54IC0gY2VudHJvaWQueCk7CiAgICByZXR1cm4geyBpbmRleCwgYW5nbGUgfTsKICB9KTsKICBpbmRleGVkUG9pbnRzLnNvcnQoKGEsIGIpID0+IGEuYW5nbGUgLSBiLmFuZ2xlKTsKICByZXR1cm4gaW5kZXhlZFBvaW50cy5tYXAoKGl0ZW0pID0+IGl0ZW0uaW5kZXgpOwp9CmZ1bmN0aW9uIGNhbGN1bGF0ZUNlbnRyb2lkKHBvaW50cywgb3V0cHV0KSB7CiAgaWYgKCFvdXRwdXQpIHsKICAgIG91dHB1dCA9IG5ldyBWZWN0b3IyKCk7CiAgfQogIGNvbnN0IG4gPSBwb2ludHMubGVuZ3RoOwogIGxldCBzdW1YID0gMDsKICBsZXQgc3VtWSA9IDA7CiAgcG9pbnRzLmZvckVhY2goKHBvaW50KSA9PiB7CiAgICBzdW1YICs9IHBvaW50Lng7CiAgICBzdW1ZICs9IHBvaW50Lnk7CiAgfSk7CiAgcmV0dXJuIG91dHB1dC5zZXQoc3VtWCAvIG4sIHN1bVkgLyBuKTsKfQpmdW5jdGlvbiBnZXRMaW5lSW50ZXJzZWN0aW9uKHN0YXJ0MSwgZW5kMSwgc3RhcnQyLCBlbmQyLCB1dlN0YXJ0MSwgdXZFbmQxKSB7CiAgY29uc3QgeDEgPSBzdGFydDEueDsKICBjb25zdCB5MSA9IHN0YXJ0MS55OwogIGNvbnN0IHgyID0gZW5kMS54OwogIGNvbnN0IHkyID0gZW5kMS55OwogIGNvbnN0IHgzID0gc3RhcnQyLng7CiAgY29uc3QgeTMgPSBzdGFydDIueTsKICBjb25zdCB4NCA9IGVuZDIueDsKICBjb25zdCB5NCA9IGVuZDIueTsKICBjb25zdCBkZW5vbWluYXRvciA9ICh4MSAtIHgyKSAqICh5MyAtIHk0KSAtICh5MSAtIHkyKSAqICh4MyAtIHg0KTsKICBpZiAoTWF0aC5hYnMoZGVub21pbmF0b3IpIDwgMWUtNCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGNvbnN0IHQgPSAoKHgxIC0geDMpICogKHkzIC0geTQpIC0gKHkxIC0geTMpICogKHgzIC0geDQpKSAvIGRlbm9taW5hdG9yOwogIGNvbnN0IHUgPSAtKCh4MSAtIHgyKSAqICh5MSAtIHkzKSAtICh5MSAtIHkyKSAqICh4MSAtIHgzKSkgLyBkZW5vbWluYXRvcjsKICBpZiAodCA+PSAwICYmIHQgPD0gMSAmJiB1ID49IDAgJiYgdSA8PSAxKSB7CiAgICByZXR1cm4gewogICAgICBwb2ludDogc3RhcnQxLmNsb25lKCkubGVycChlbmQxLCB0KSwKICAgICAgdXY6IHV2U3RhcnQxLmNsb25lKCkubGVycCh1dkVuZDEsIHQpCiAgICB9OwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBpc1BvaW50SW5UcmlhbmdsZShwb2ludCwgcDEsIHAyLCBwMykgewogIGNvbnN0IGVkZ2UxID0gcDIueCAtIHAxLng7CiAgY29uc3QgZWRnZTIgPSBwMi55IC0gcDEueTsKICBjb25zdCBlZGdlMyA9IHAzLnggLSBwMS54OwogIGNvbnN0IGVkZ2U0ID0gcDMueSAtIHAxLnk7CiAgY29uc3QgcG9pbnQxID0gcG9pbnQueCAtIHAxLng7CiAgY29uc3QgcG9pbnQyID0gcG9pbnQueSAtIHAxLnk7CiAgY29uc3QgZCA9IGVkZ2UxICogZWRnZTQgLSBlZGdlMiAqIGVkZ2UzOwogIGNvbnN0IHMgPSAocG9pbnQxICogZWRnZTQgLSBwb2ludDIgKiBlZGdlMykgLyBkOwogIGNvbnN0IHQgPSAoZWRnZTEgKiBwb2ludDIgLSBlZGdlMiAqIHBvaW50MSkgLyBkOwogIHJldHVybiBzID49IDAgJiYgdCA+PSAwICYmIHMgKyB0IDw9IDE7Cn0KZnVuY3Rpb24gaXNQb2ludEluUmVjdGFuZ2xlKHBvaW50LCB4bWluLCB4bWF4LCB5bWluLCB5bWF4KSB7CiAgcmV0dXJuIHBvaW50LnggPj0geG1pbiAmJiBwb2ludC54IDw9IHhtYXggJiYgcG9pbnQueSA+PSB5bWluICYmIHBvaW50LnkgPD0geW1heDsKfQpmdW5jdGlvbiBnZXRSZWN0YW5nbGVQb2ludHMoeG1pbiwgeG1heCwgeW1pbiwgeW1heCkgewogIHJldHVybiBbCiAgICBuZXcgVmVjdG9yMih4bWluLCB5bWluKSwKICAgIG5ldyBWZWN0b3IyKHhtYXgsIHltaW4pLAogICAgbmV3IFZlY3RvcjIoeG1heCwgeW1heCksCiAgICBuZXcgVmVjdG9yMih4bWluLCB5bWF4KQogIF07Cn0KZnVuY3Rpb24gZ2V0UmVjdGFuZ2xlRWRnZXMocmVjdGFuZ2xlUG9pbnRzKSB7CiAgcmV0dXJuIFsKICAgIFtyZWN0YW5nbGVQb2ludHNbMF0sIHJlY3RhbmdsZVBvaW50c1sxXV0sCiAgICBbcmVjdGFuZ2xlUG9pbnRzWzFdLCByZWN0YW5nbGVQb2ludHNbMl1dLAogICAgW3JlY3RhbmdsZVBvaW50c1syXSwgcmVjdGFuZ2xlUG9pbnRzWzNdXSwKICAgIFtyZWN0YW5nbGVQb2ludHNbM10sIHJlY3RhbmdsZVBvaW50c1swXV0KICBdOwp9CmZ1bmN0aW9uIGNhbGN1bGF0ZUludGVyc2VjdGlvbih0cmlhbmdsZVBvaW50cywgdHJpYW5nbGVVdnMsIHJlY3RhbmdsZVBvaW50cykgewogIGNvbnN0IGludGVyc2VjdGlvbnMgPSBbXTsKICB0cmlhbmdsZVBvaW50cy5mb3JFYWNoKChwb2ludCwgaSkgPT4gewogICAgY29uc3QgaXNJbnNpZGVSZWN0YW5nbGUgPSBpc1BvaW50SW5SZWN0YW5nbGUoCiAgICAgIHBvaW50LAogICAgICByZWN0YW5nbGVQb2ludHNbMF0ueCwKICAgICAgcmVjdGFuZ2xlUG9pbnRzWzJdLngsCiAgICAgIHJlY3RhbmdsZVBvaW50c1swXS55LAogICAgICByZWN0YW5nbGVQb2ludHNbMl0ueQogICAgKTsKICAgIGlmIChpc0luc2lkZVJlY3RhbmdsZSkgewogICAgICBjb25zdCBrZXkgPSBwb2ludC54ICsgIiwiICsgcG9pbnQueSArICIsIiArIHBvaW50Lno7CiAgICAgIGlmICghaW50ZXJzZWN0aW9uc1trZXldKSB7CiAgICAgICAgaW50ZXJzZWN0aW9uc1trZXldID0gewogICAgICAgICAgcG9pbnQsCiAgICAgICAgICB1djogdHJpYW5nbGVVdnNbaV0KICAgICAgICB9OwogICAgICB9CiAgICB9CiAgfSk7CiAgY29uc3QgbWluWCA9IE1hdGgubWluKHRyaWFuZ2xlUG9pbnRzWzBdLngsIE1hdGgubWluKHRyaWFuZ2xlUG9pbnRzWzFdLngsIHRyaWFuZ2xlUG9pbnRzWzJdLngpKTsKICBjb25zdCBtYXhYID0gTWF0aC5tYXgodHJpYW5nbGVQb2ludHNbMF0ueCwgTWF0aC5tYXgodHJpYW5nbGVQb2ludHNbMV0ueCwgdHJpYW5nbGVQb2ludHNbMl0ueCkpOwogIGNvbnN0IG1pblkgPSBNYXRoLm1pbih0cmlhbmdsZVBvaW50c1swXS55LCBNYXRoLm1pbih0cmlhbmdsZVBvaW50c1sxXS55LCB0cmlhbmdsZVBvaW50c1syXS55KSk7CiAgY29uc3QgbWF4WSA9IE1hdGgubWF4KHRyaWFuZ2xlUG9pbnRzWzBdLnksIE1hdGgubWF4KHRyaWFuZ2xlUG9pbnRzWzFdLnksIHRyaWFuZ2xlUG9pbnRzWzJdLnkpKTsKICBjb25zdCBtaW5VID0gTWF0aC5taW4odHJpYW5nbGVVdnNbMF0ueCwgTWF0aC5taW4odHJpYW5nbGVVdnNbMV0ueCwgdHJpYW5nbGVVdnNbMl0ueCkpOwogIGNvbnN0IG1heFUgPSBNYXRoLm1heCh0cmlhbmdsZVV2c1swXS54LCBNYXRoLm1heCh0cmlhbmdsZVV2c1sxXS54LCB0cmlhbmdsZVV2c1syXS54KSk7CiAgY29uc3QgbWluViA9IE1hdGgubWluKHRyaWFuZ2xlVXZzWzBdLnksIE1hdGgubWluKHRyaWFuZ2xlVXZzWzFdLnksIHRyaWFuZ2xlVXZzWzJdLnkpKTsKICBjb25zdCBtYXhWID0gTWF0aC5tYXgodHJpYW5nbGVVdnNbMF0ueSwgTWF0aC5tYXgodHJpYW5nbGVVdnNbMV0ueSwgdHJpYW5nbGVVdnNbMl0ueSkpOwogIGNvbnN0IHhEaWZmID0gbWF4WCAtIG1pblg7CiAgY29uc3QgeURpZmYgPSBtYXhZIC0gbWluWTsKICBjb25zdCB1RGlmZiA9IG1heFUgLSBtaW5VOwogIGNvbnN0IHZEaWZmID0gbWF4ViAtIG1pblY7CiAgcmVjdGFuZ2xlUG9pbnRzLmZvckVhY2goKHBvaW50KSA9PiB7CiAgICBjb25zdCBpc0luc2lkZVRyaWFuZ2xlID0gaXNQb2ludEluVHJpYW5nbGUocG9pbnQsIC4uLnRyaWFuZ2xlUG9pbnRzKTsKICAgIGlmIChpc0luc2lkZVRyaWFuZ2xlKSB7CiAgICAgIGNvbnN0IGtleSA9IHBvaW50LnggKyAiLCIgKyBwb2ludC55ICsgIiwiICsgcG9pbnQuejsKICAgICAgaWYgKCFpbnRlcnNlY3Rpb25zW2tleV0pIHsKICAgICAgICBjb25zdCB1ID0gbWluVSArIHVEaWZmICogKHBvaW50LnggLSBtaW5YKSAvIHhEaWZmOwogICAgICAgIGNvbnN0IHYgPSBtaW5WICsgdkRpZmYgKiAocG9pbnQueSAtIG1pblkpIC8geURpZmY7CiAgICAgICAgaW50ZXJzZWN0aW9uc1trZXldID0gewogICAgICAgICAgcG9pbnQsCiAgICAgICAgICB1djogbmV3IFZlY3RvcjIodSwgdikKICAgICAgICB9OwogICAgICB9CiAgICB9CiAgfSk7CiAgY29uc3QgdHJpYW5nbGVFZGdlcyA9IFsKICAgIFswLCAxXSwKICAgIFsxLCAyXSwKICAgIFsyLCAwXQogIF07CiAgY29uc3QgcmVjdGFuZ2xlRWRnZXMgPSBnZXRSZWN0YW5nbGVFZGdlcyhyZWN0YW5nbGVQb2ludHMpOwogIHRyaWFuZ2xlRWRnZXMuZm9yRWFjaCgoW3RTdGFydEluZGV4LCB0RW5kSW5kZXhdKSA9PiB7CiAgICByZWN0YW5nbGVFZGdlcy5mb3JFYWNoKChbclN0YXJ0LCByRW5kXSkgPT4gewogICAgICBjb25zdCB0U3RhcnQgPSB0cmlhbmdsZVBvaW50c1t0U3RhcnRJbmRleF07CiAgICAgIGNvbnN0IHRFbmQgPSB0cmlhbmdsZVBvaW50c1t0RW5kSW5kZXhdOwogICAgICBjb25zdCB0U3RhcnRVdiA9IHRyaWFuZ2xlVXZzW3RTdGFydEluZGV4XTsKICAgICAgY29uc3QgdEVuZFV2ID0gdHJpYW5nbGVVdnNbdEVuZEluZGV4XTsKICAgICAgY29uc3QgaW50ZXJzZWN0aW9uID0gZ2V0TGluZUludGVyc2VjdGlvbih0U3RhcnQsIHRFbmQsIHJTdGFydCwgckVuZCwgdFN0YXJ0VXYsIHRFbmRVdik7CiAgICAgIGlmIChpbnRlcnNlY3Rpb24pIHsKICAgICAgICBjb25zdCB7IHBvaW50IH0gPSBpbnRlcnNlY3Rpb247CiAgICAgICAgY29uc3Qga2V5ID0gcG9pbnQueCArICIsIiArIHBvaW50LnkgKyAiLCIgKyBwb2ludC56OwogICAgICAgIGlmICghaW50ZXJzZWN0aW9uc1trZXldKSB7CiAgICAgICAgICBpbnRlcnNlY3Rpb25zW2tleV0gPSBpbnRlcnNlY3Rpb247CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9KTsKICByZXR1cm4gT2JqZWN0LnZhbHVlcyhpbnRlcnNlY3Rpb25zKTsKfQpjb25zdCBzdWJkaXZpc2lvblYwU2NyYXRjaCA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3Qgc3ViZGl2aXNpb25WMVNjcmF0Y2ggPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IHN1YmRpdmlzaW9uVjJTY3JhdGNoID0gbmV3IFZlY3RvcjMkMSgpOwpuZXcgVmVjdG9yMyQxKCk7Cm5ldyBWZWN0b3IzJDEoKTsKbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBzdWJkaXZpc2lvbk1pZFNjcmF0Y2ggPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IHN1YmRpdmlzaW9uVDBTY3JhdGNoID0gbmV3IFZlY3RvcjIoKTsKY29uc3Qgc3ViZGl2aXNpb25UMVNjcmF0Y2ggPSBuZXcgVmVjdG9yMigpOwpjb25zdCBzdWJkaXZpc2lvblQyU2NyYXRjaCA9IG5ldyBWZWN0b3IyKCk7CmNvbnN0IHN1YmRpdmlkZVdpdGhSYW5nZSA9ICh2ZXJ0aWNlcywgdXZzLCBpbmRpY2VzLCBoYXNUZXhDb29yZHMsIHN1YmRpdmlkZWRQb3NpdGlvbnMsIHN1YmRpdmlkZWRUZXhjb29yZHMsIHRyaWFuZ2xlcywgcmFuZ2UsIHBvaW50cykgPT4gewogIGNvbnN0IGluc2lkZUluZGljZXMgPSBbXTsKICBmb3IgKGxldCBpID0gMDsgaSA8IHZlcnRpY2VzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBwb3NpdGlvbiA9IHZlcnRpY2VzW2ldOwogICAgbGV0IHBvaW50ID0gYCR7cG9zaXRpb24ueH0sJHtwb3NpdGlvbi55fSwke3Bvc2l0aW9uLnp9YDsKICAgIHBvaW50c1twb2ludF0gPSBpbmRpY2VzW2ldOwogICAgY29uc3QgaXNJbnNpZGUgPSBpc1BvaW50SW5SZWN0YW5nbGUocG9zaXRpb24sIHJhbmdlWzBdLCByYW5nZVsxXSwgcmFuZ2VbMF0sIHJhbmdlWzFdKTsKICAgIGlmIChpc0luc2lkZSkgewogICAgICBpbnNpZGVJbmRpY2VzLnB1c2goaSk7CiAgICB9CiAgfQogIGNvbnN0IG51bUluc2lkZSA9IGluc2lkZUluZGljZXMubGVuZ3RoOwogIGlmIChudW1JbnNpZGUgPT09IDMpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgY29uc3QgcmVjdGFuZ2xlID0gZ2V0UmVjdGFuZ2xlUG9pbnRzKHJhbmdlWzBdLCByYW5nZVsxXSwgcmFuZ2VbMF0sIHJhbmdlWzFdKTsKICBjb25zdCB0cmlhbmdsZSA9IFt2ZXJ0aWNlc1swXSwgdmVydGljZXNbMV0sIHZlcnRpY2VzWzJdXTsKICBjb25zdCBpbnRlcnNlY3Rpb25zID0gY2FsY3VsYXRlSW50ZXJzZWN0aW9uKHRyaWFuZ2xlLCB1dnMsIHJlY3RhbmdsZSk7CiAgY29uc3QgaW50ZXJzZWN0aW9uUG9pbnRzID0gaW50ZXJzZWN0aW9ucy5tYXAoKGl0ZW0pID0+IGl0ZW0ucG9pbnQpOwogIGNvbnN0IGludGVyc2VjdGlvblV2cyA9IGludGVyc2VjdGlvbnMubWFwKChpdGVtKSA9PiBpdGVtLnV2KTsKICBjb25zdCBsZW5ndGggPSBpbnRlcnNlY3Rpb25Qb2ludHMubGVuZ3RoOwogIGlmIChsZW5ndGggPiAyKSB7CiAgICBjb25zdCBzb3J0ZWRJbmRpY2VzID0gc29ydFBvbHlnb25Qb2ludHMoaW50ZXJzZWN0aW9uUG9pbnRzKTsKICAgIGNvbnN0IHRyaWFuZ2xlSW5kaWNlcyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDAsIGwgPSBzb3J0ZWRJbmRpY2VzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBjb25zdCBpbmRleCA9IHNvcnRlZEluZGljZXNbaV07CiAgICAgIGNvbnN0IHBvaW50ID0gaW50ZXJzZWN0aW9uUG9pbnRzW2luZGV4XTsKICAgICAgY29uc3QgdXYgPSBpbnRlcnNlY3Rpb25VdnNbaW5kZXhdOwogICAgICBjb25zdCBrZXkgPSBgJHtwb2ludC54fSwke3BvaW50Lnl9LCR7cG9pbnQuen1gOwogICAgICBpZiAoIWRlZmluZWQkMihwb2ludHNba2V5XSkpIHsKICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLnB1c2gocG9pbnQueCwgcG9pbnQueSwgcG9pbnQueik7CiAgICAgICAgaGFzVGV4Q29vcmRzICYmIHN1YmRpdmlkZWRUZXhjb29yZHMucHVzaCh1di54LCB1di55KTsKICAgICAgICBwb2ludHNba2V5XSA9IHN1YmRpdmlkZWRQb3NpdGlvbnMubGVuZ3RoIC8gMyAtIDE7CiAgICAgIH0KICAgICAgY29uc3QgdHJpYW5nbGVJbmRleCA9IHBvaW50c1trZXldOwogICAgICB0cmlhbmdsZUluZGljZXMucHVzaCh0cmlhbmdsZUluZGV4KTsKICAgIH0KICAgIGlmIChpbnRlcnNlY3Rpb25Qb2ludHMubGVuZ3RoID09PSAzKSB7CiAgICAgIHRyaWFuZ2xlcy5wdXNoKAogICAgICAgIHRyaWFuZ2xlSW5kaWNlc1sxXSwKICAgICAgICB0cmlhbmdsZUluZGljZXNbMl0sCiAgICAgICAgdHJpYW5nbGVJbmRpY2VzWzBdCiAgICAgICk7CiAgICB9IGVsc2UgaWYgKGludGVyc2VjdGlvblBvaW50cy5sZW5ndGggPT09IDQpIHsKICAgICAgdHJpYW5nbGVzLnB1c2goCiAgICAgICAgdHJpYW5nbGVJbmRpY2VzWzJdLAogICAgICAgIHRyaWFuZ2xlSW5kaWNlc1szXSwKICAgICAgICB0cmlhbmdsZUluZGljZXNbMF0sCiAgICAgICAgdHJpYW5nbGVJbmRpY2VzWzBdLAogICAgICAgIHRyaWFuZ2xlSW5kaWNlc1sxXSwKICAgICAgICB0cmlhbmdsZUluZGljZXNbMl0KICAgICAgKTsKICAgIH0gZWxzZSBpZiAoaW50ZXJzZWN0aW9uUG9pbnRzLmxlbmd0aCA9PT0gNSkgewogICAgICB0cmlhbmdsZXMucHVzaCgKICAgICAgICB0cmlhbmdsZUluZGljZXNbM10sCiAgICAgICAgdHJpYW5nbGVJbmRpY2VzWzRdLAogICAgICAgIHRyaWFuZ2xlSW5kaWNlc1swXSwKICAgICAgICB0cmlhbmdsZUluZGljZXNbMF0sCiAgICAgICAgdHJpYW5nbGVJbmRpY2VzWzFdLAogICAgICAgIHRyaWFuZ2xlSW5kaWNlc1syXSwKICAgICAgICB0cmlhbmdsZUluZGljZXNbMl0sCiAgICAgICAgdHJpYW5nbGVJbmRpY2VzWzNdLAogICAgICAgIHRyaWFuZ2xlSW5kaWNlc1swXQogICAgICApOwogICAgfQogIH0KICByZXR1cm4gdHJ1ZTsKfTsKY29uc3Qgc3ViZGl2aWRlTWVzaCA9ICh2ZXJ0aWNlcywgaW5kaWNlcywgdGV4Y29vcmRzLCBtaW5EaXN0YW5jZSwgaW5kZXhPZmZzZXQgPSAwLCByYW5nZSA9IFstMC41MDEsIDAuNTAxXSkgPT4gewogIGNvbnN0IGhhc1RleENvb3JkcyA9ICEhdGV4Y29vcmRzOwogIGNvbnN0IHRyaWFuZ2xlcyA9IEFycmF5LmZyb20oaW5kaWNlcyk7CiAgbGV0IGkgPSAwOwogIGNvbnN0IGxlbmd0aCA9IHZlcnRpY2VzLmxlbmd0aDsKICBsZXQgc3ViZGl2aWRlZFBvc2l0aW9ucyA9IG51bGw7CiAgbGV0IHN1YmRpdmlkZWRUZXhjb29yZHMgPSBudWxsOwogIGNvbnN0IGlzUG9zaXRpb24yREFycmF5ID0gQXJyYXkuaXNBcnJheSh2ZXJ0aWNlc1swXSk7CiAgaWYgKGlzUG9zaXRpb24yREFycmF5KSB7CiAgICBzdWJkaXZpZGVkUG9zaXRpb25zID0gW107CiAgICBsZXQgcSA9IDA7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgaXRlbSA9IHZlcnRpY2VzW2ldOwogICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW3ErK10gPSBpdGVtWzBdOwogICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW3ErK10gPSBpdGVtWzFdOwogICAgICBzdWJkaXZpZGVkUG9zaXRpb25zW3ErK10gPSBpdGVtWzJdOwogICAgfQogIH0gZWxzZSB7CiAgICBzdWJkaXZpZGVkUG9zaXRpb25zID0gdmVydGljZXMuc2xpY2UoMCk7CiAgfQogIGlmIChoYXNUZXhDb29yZHMpIHsKICAgIGNvbnN0IGlzVGV4Y29vcmQyREFycmF5ID0gQXJyYXkuaXNBcnJheSh0ZXhjb29yZHNbMF0pOwogICAgaWYgKGlzVGV4Y29vcmQyREFycmF5KSB7CiAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMgPSBbXTsKICAgICAgbGV0IHEgPSAwOwogICAgICBmb3IgKGkgPSAwOyBpIDwgdGV4Y29vcmRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgaXRlbSA9IHRleGNvb3Jkc1tpXTsKICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzW3ErK10gPSBpdGVtWzBdOwogICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHNbcSsrXSA9IGl0ZW1bMV07CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMgPSB0ZXhjb29yZHMuc2xpY2UoMCk7CiAgICB9CiAgfQogIGNvbnN0IHN1YmRpdmlkZWRJbmRpY2VzID0gW107CiAgY29uc3QgZWRnZXMgPSB7fTsKICBjb25zdCBwb2ludHMgPSB7fTsKICBjb25zdCBtaW5EaXN0YW5jZVNxcmQgPSBtaW5EaXN0YW5jZSAqIG1pbkRpc3RhbmNlOwogIHdoaWxlICh0cmlhbmdsZXMubGVuZ3RoID4gMCkgewogICAgY29uc3QgaTIgPSB0cmlhbmdsZXMucG9wKCk7CiAgICBjb25zdCBpMSA9IHRyaWFuZ2xlcy5wb3AoKTsKICAgIGNvbnN0IGkwID0gdHJpYW5nbGVzLnBvcCgpOwogICAgY29uc3QgdjAgPSBzdWJkaXZpc2lvblYwU2NyYXRjaC5mcm9tQXJyYXkoc3ViZGl2aWRlZFBvc2l0aW9ucywgaTAgKiAzKTsKICAgIGNvbnN0IHYxID0gc3ViZGl2aXNpb25WMVNjcmF0Y2guZnJvbUFycmF5KHN1YmRpdmlkZWRQb3NpdGlvbnMsIGkxICogMyk7CiAgICBjb25zdCB2MiA9IHN1YmRpdmlzaW9uVjJTY3JhdGNoLmZyb21BcnJheShzdWJkaXZpZGVkUG9zaXRpb25zLCBpMiAqIDMpOwogICAgbGV0IHQwOwogICAgbGV0IHQxOwogICAgbGV0IHQyOwogICAgaWYgKGhhc1RleENvb3JkcykgewogICAgICB0MCA9IHN1YmRpdmlzaW9uVDBTY3JhdGNoLmZyb21BcnJheShzdWJkaXZpZGVkVGV4Y29vcmRzLCBpMCAqIDIpOwogICAgICB0MSA9IHN1YmRpdmlzaW9uVDFTY3JhdGNoLmZyb21BcnJheShzdWJkaXZpZGVkVGV4Y29vcmRzLCBpMSAqIDIpOwogICAgICB0MiA9IHN1YmRpdmlzaW9uVDJTY3JhdGNoLmZyb21BcnJheShzdWJkaXZpZGVkVGV4Y29vcmRzLCBpMiAqIDIpOwogICAgfQogICAgY29uc3QgZzAgPSBDYXJ0ZXNpYW4zLm1hZ25pdHVkZVNxdWFyZWQoQ2FydGVzaWFuMy5zdWJ0cmFjdCh2MCwgdjEsIHN1YmRpdmlzaW9uTWlkU2NyYXRjaCkpOwogICAgY29uc3QgZzEgPSBDYXJ0ZXNpYW4zLm1hZ25pdHVkZVNxdWFyZWQoQ2FydGVzaWFuMy5zdWJ0cmFjdCh2MSwgdjIsIHN1YmRpdmlzaW9uTWlkU2NyYXRjaCkpOwogICAgY29uc3QgZzIgPSBDYXJ0ZXNpYW4zLm1hZ25pdHVkZVNxdWFyZWQoQ2FydGVzaWFuMy5zdWJ0cmFjdCh2MiwgdjAsIHN1YmRpdmlzaW9uTWlkU2NyYXRjaCkpOwogICAgY29uc3QgbWF4ID0gTWF0aC5tYXgoZzAsIGcxLCBnMik7CiAgICBsZXQgZWRnZTsKICAgIGxldCBtaWQ7CiAgICBsZXQgbWlkVGV4Y29vcmQ7CiAgICBpZiAobWF4ID4gbWluRGlzdGFuY2VTcXJkKSB7CiAgICAgIGlmIChnMCA9PT0gbWF4KSB7CiAgICAgICAgZWRnZSA9IGAke01hdGgubWluKGkwLCBpMSl9ICR7TWF0aC5tYXgoaTAsIGkxKX1gOwogICAgICAgIGkgPSBlZGdlc1tlZGdlXTsKICAgICAgICBpZiAoaSA9PT0gbnVsbCB8fCBpID09PSB2b2lkIDApIHsKICAgICAgICAgIG1pZCA9IENhcnRlc2lhbjMuYWRkKHYwLCB2MSwgc3ViZGl2aXNpb25NaWRTY3JhdGNoKTsKICAgICAgICAgIENhcnRlc2lhbjMubXVsdGlwbHlCeVNjYWxhcihtaWQsIDAuNSwgbWlkKTsKICAgICAgICAgIHN1YmRpdmlkZWRQb3NpdGlvbnMucHVzaChtaWQueCwgbWlkLnksIG1pZC56KTsKICAgICAgICAgIGkgPSBzdWJkaXZpZGVkUG9zaXRpb25zLmxlbmd0aCAvIDMgLSAxOwogICAgICAgICAgZWRnZXNbZWRnZV0gPSBpOwogICAgICAgICAgaWYgKGhhc1RleENvb3JkcykgewogICAgICAgICAgICBtaWRUZXhjb29yZCA9IENhcnRlc2lhbjIuYWRkKHQwLCB0MSwgc3ViZGl2aXNpb25NaWRTY3JhdGNoKTsKICAgICAgICAgICAgQ2FydGVzaWFuMi5tdWx0aXBseUJ5U2NhbGFyKG1pZFRleGNvb3JkLCAwLjUsIG1pZFRleGNvb3JkKTsKICAgICAgICAgICAgc3ViZGl2aWRlZFRleGNvb3Jkcy5wdXNoKG1pZFRleGNvb3JkLngsIG1pZFRleGNvb3JkLnkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0cmlhbmdsZXMucHVzaChpMCwgaSwgaTIpOwogICAgICAgIHRyaWFuZ2xlcy5wdXNoKGksIGkxLCBpMik7CiAgICAgIH0gZWxzZSBpZiAoZzEgPT09IG1heCkgewogICAgICAgIGVkZ2UgPSBgJHtNYXRoLm1pbihpMSwgaTIpfSAke01hdGgubWF4KGkxLCBpMil9YDsKICAgICAgICBpID0gZWRnZXNbZWRnZV07CiAgICAgICAgaWYgKCFpKSB7CiAgICAgICAgICBtaWQgPSBDYXJ0ZXNpYW4zLmFkZCh2MSwgdjIsIHN1YmRpdmlzaW9uTWlkU2NyYXRjaCk7CiAgICAgICAgICBDYXJ0ZXNpYW4zLm11bHRpcGx5QnlTY2FsYXIobWlkLCAwLjUsIG1pZCk7CiAgICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLnB1c2gobWlkLngsIG1pZC55LCBtaWQueik7CiAgICAgICAgICBpID0gc3ViZGl2aWRlZFBvc2l0aW9ucy5sZW5ndGggLyAzIC0gMTsKICAgICAgICAgIGVkZ2VzW2VkZ2VdID0gaTsKICAgICAgICAgIGlmIChoYXNUZXhDb29yZHMpIHsKICAgICAgICAgICAgbWlkVGV4Y29vcmQgPSBDYXJ0ZXNpYW4yLmFkZCh0MSwgdDIsIHN1YmRpdmlzaW9uTWlkU2NyYXRjaCk7CiAgICAgICAgICAgIENhcnRlc2lhbjIubXVsdGlwbHlCeVNjYWxhcihtaWRUZXhjb29yZCwgMC41LCBtaWRUZXhjb29yZCk7CiAgICAgICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMucHVzaChtaWRUZXhjb29yZC54LCBtaWRUZXhjb29yZC55KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdHJpYW5nbGVzLnB1c2goaTEsIGksIGkwKTsKICAgICAgICB0cmlhbmdsZXMucHVzaChpLCBpMiwgaTApOwogICAgICB9IGVsc2UgaWYgKGcyID09PSBtYXgpIHsKICAgICAgICBlZGdlID0gYCR7TWF0aC5taW4oaTIsIGkwKX0gJHtNYXRoLm1heChpMiwgaTApfWA7CiAgICAgICAgaSA9IGVkZ2VzW2VkZ2VdOwogICAgICAgIGlmICghaSkgewogICAgICAgICAgbWlkID0gQ2FydGVzaWFuMy5hZGQodjIsIHYwLCBzdWJkaXZpc2lvbk1pZFNjcmF0Y2gpOwogICAgICAgICAgQ2FydGVzaWFuMy5tdWx0aXBseUJ5U2NhbGFyKG1pZCwgMC41LCBtaWQpOwogICAgICAgICAgc3ViZGl2aWRlZFBvc2l0aW9ucy5wdXNoKG1pZC54LCBtaWQueSwgbWlkLnopOwogICAgICAgICAgaSA9IHN1YmRpdmlkZWRQb3NpdGlvbnMubGVuZ3RoIC8gMyAtIDE7CiAgICAgICAgICBlZGdlc1tlZGdlXSA9IGk7CiAgICAgICAgICBpZiAoaGFzVGV4Q29vcmRzKSB7CiAgICAgICAgICAgIG1pZFRleGNvb3JkID0gQ2FydGVzaWFuMi5hZGQodDIsIHQwLCBzdWJkaXZpc2lvbk1pZFNjcmF0Y2gpOwogICAgICAgICAgICBDYXJ0ZXNpYW4yLm11bHRpcGx5QnlTY2FsYXIobWlkVGV4Y29vcmQsIDAuNSwgbWlkVGV4Y29vcmQpOwogICAgICAgICAgICBzdWJkaXZpZGVkVGV4Y29vcmRzLnB1c2gobWlkVGV4Y29vcmQueCwgbWlkVGV4Y29vcmQueSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRyaWFuZ2xlcy5wdXNoKGkyLCBpLCBpMSk7CiAgICAgICAgdHJpYW5nbGVzLnB1c2goaSwgaTAsIGkxKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29uc3QgdHJpYW5nbGVQb3NpdGlvbnMgPSBbdjAsIHYxLCB2Ml07CiAgICAgIGNvbnN0IHRyaWFuZ2xlVXZzID0gW3QwLCB0MSwgdDJdOwogICAgICBjb25zdCBpbmRpY2VzMiA9IFtpMCwgaTEsIGkyXTsKICAgICAgY29uc3Qgc3ViZGl2ZWREYXRhID0gc3ViZGl2aWRlV2l0aFJhbmdlKAogICAgICAgIHRyaWFuZ2xlUG9zaXRpb25zLAogICAgICAgIHRyaWFuZ2xlVXZzLAogICAgICAgIGluZGljZXMyLAogICAgICAgIGhhc1RleENvb3JkcywKICAgICAgICBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgICAgIHN1YmRpdmlkZWRUZXhjb29yZHMsCiAgICAgICAgdHJpYW5nbGVzLAogICAgICAgIHJhbmdlLAogICAgICAgIHBvaW50cwogICAgICApOwogICAgICBpZiAoc3ViZGl2ZWREYXRhKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgc3ViZGl2aWRlZEluZGljZXMucHVzaChpMCArIGluZGV4T2Zmc2V0KTsKICAgICAgc3ViZGl2aWRlZEluZGljZXMucHVzaChpMSArIGluZGV4T2Zmc2V0KTsKICAgICAgc3ViZGl2aWRlZEluZGljZXMucHVzaChpMiArIGluZGV4T2Zmc2V0KTsKICAgIH0KICB9CiAgcmV0dXJuIHsKICAgIHZlcnRpY2VzOiBzdWJkaXZpZGVkUG9zaXRpb25zLAogICAgdXZzOiBzdWJkaXZpZGVkVGV4Y29vcmRzLAogICAgaW5kaWNlczogc3ViZGl2aWRlZEluZGljZXMKICB9Owp9Owpjb25zdCBfcG9pbnRJbiQxID0gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBfcG9pbnRPdXQkMSA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3QgcmVwcm9qZWN0Q29vcmRpbmF0ZSA9IChzb3VyY2VQcm9qZWN0aW9uLCB0YXJnZXRQcm9qZWN0aW9uLCBpbnB1dCwgb3V0cHV0KSA9PiB7CiAgaWYgKHNvdXJjZVByb2plY3Rpb24gPT09IHRhcmdldFByb2plY3Rpb24gfHwgIXNvdXJjZVByb2plY3Rpb24gfHwgIXRhcmdldFByb2plY3Rpb24pIHsKICAgIG91dHB1dC5jb3B5KGlucHV0KTsKICAgIHJldHVybiBvdXRwdXQ7CiAgfQogIHNvdXJjZVByb2plY3Rpb24udW5wcm9qZWN0Q29vcmRpbmF0ZShpbnB1dCwgX3BvaW50T3V0JDEpOwogIF9wb2ludEluJDEuY29weShfcG9pbnRPdXQkMSk7CiAgdGFyZ2V0UHJvamVjdGlvbi5wcm9qZWN0Q29vcmRpbmF0ZShfcG9pbnRJbiQxLCBvdXRwdXQpOwogIHJldHVybiBvdXRwdXQ7Cn07CmNvbnN0IHByb2plY3RWZXJ0aWNlcyA9ICh2ZXJ0aWNlcywgdGlsZUNvbmZpZywgaXNNZXJnZSA9IHRydWUsIGlzU3ViQ2VudGVyID0gdHJ1ZSkgPT4gewogIGlmICghdGlsZUNvbmZpZy5mb3JjZVByb2plY3RDb29yZGluYXRlcyAmJiB0aWxlQ29uZmlnLnRhcmdldFByb2plY3Rpb25OYW1lID09PSB0aWxlQ29uZmlnLnNvdXJjZVByb2plY3Rpb25OYW1lKSB7CiAgICByZXR1cm47CiAgfQogIGNvbnN0IHNvdXJjZVByb2plY3Rpb24gPSB0aWxlQ29uZmlnLnNvdXJjZVByb2plY3Rpb247CiAgY29uc3QgdGFyZ2V0UHJvamVjdGlvbiA9IHRpbGVDb25maWcudGFyZ2V0UHJvamVjdGlvbjsKICBjb25zdCBbY2VudGVyWCwgY2VudGVyWSwgY2VudGVyWl0gPSB0aWxlQ29uZmlnLnRhcmdldENlbnRlcjsKICBjb25zdCB1c2VHZW9Cb3VuZGluZ0JveCA9IHRpbGVDb25maWcuZm9yY2VVc2VHZW9Cb3VuZGluZ0JveCB8fCBzb3VyY2VQcm9qZWN0aW9uLmlzR2VvOwogIGNvbnN0IGJvdW5kaW5nQm94ID0gdXNlR2VvQm91bmRpbmdCb3ggPyB0aWxlQ29uZmlnLmdlb0JvdW5kaW5nQm94IDogdGlsZUNvbmZpZy5wcm9qZWN0ZWRCb3VuZGluZ0JveDsKICBsZXQgd2VzdDsKICBsZXQgc291dGg7CiAgbGV0IGVhc3Q7CiAgbGV0IG5vcnRoOwogIGlmIChib3VuZGluZ0JveC5pc0JveDMpIHsKICAgIGNvbnN0IG1pbiA9IGJvdW5kaW5nQm94Lm1pbjsKICAgIGNvbnN0IG1heCA9IGJvdW5kaW5nQm94Lm1heDsKICAgIHdlc3QgPSBtaW4ueDsKICAgIHNvdXRoID0gbWluLnk7CiAgICBlYXN0ID0gbWF4Lng7CiAgICBub3J0aCA9IG1heC55OwogIH0gZWxzZSB7CiAgICBbd2VzdCwgc291dGgsICwgZWFzdCwgbm9ydGhdID0gYm91bmRpbmdCb3g7CiAgfQogIGNvbnN0IGxvbmd0aXR1ZGVSYW5nZSA9IGVhc3QgLSB3ZXN0OwogIGNvbnN0IGxhdGl0dWRlUmFuZ2UgPSBub3J0aCAtIHNvdXRoOwogIGlmIChpc01lcmdlKSB7CiAgICBmb3IgKGxldCBpID0gMCwgbGFzdCA9IHZlcnRpY2VzLmxlbmd0aCAtIDI7IGkgPCBsYXN0OyBpICs9IDMpIHsKICAgICAgY29uc3QgeCA9IHZlcnRpY2VzW2ldOwogICAgICBjb25zdCB5ID0gdmVydGljZXNbaSArIDFdOwogICAgICBjb25zdCB6ID0gdmVydGljZXNbaSArIDJdOwogICAgICBfcG9pbnRJbiQxLnNldCh3ZXN0ICsgKHggKyAwLjUpICogbG9uZ3RpdHVkZVJhbmdlLCBzb3V0aCArICh5ICsgMC41KSAqIGxhdGl0dWRlUmFuZ2UsIHopOwogICAgICBpZiAodXNlR2VvQm91bmRpbmdCb3gpIHsKICAgICAgICB0YXJnZXRQcm9qZWN0aW9uLnByb2plY3RDb29yZGluYXRlKF9wb2ludEluJDEsIF9wb2ludE91dCQxKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXByb2plY3RDb29yZGluYXRlKHNvdXJjZVByb2plY3Rpb24sIHRhcmdldFByb2plY3Rpb24sIF9wb2ludEluJDEsIF9wb2ludE91dCQxKTsKICAgICAgfQogICAgICB2ZXJ0aWNlc1tpXSA9IF9wb2ludE91dCQxLng7CiAgICAgIHZlcnRpY2VzW2kgKyAxXSA9IF9wb2ludE91dCQxLnk7CiAgICAgIHZlcnRpY2VzW2kgKyAyXSA9IF9wb2ludE91dCQxLno7CiAgICAgIGlmIChpc1N1YkNlbnRlcikgewogICAgICAgIHZlcnRpY2VzW2ldIC09IGNlbnRlclg7CiAgICAgICAgdmVydGljZXNbaSArIDFdIC09IGNlbnRlclk7CiAgICAgICAgdmVydGljZXNbaSArIDJdIC09IGNlbnRlclo7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgZm9yIChsZXQgaSA9IDAsIGxhc3QgPSB2ZXJ0aWNlcy5sZW5ndGg7IGkgPCBsYXN0OyBpICs9IDEpIHsKICAgICAgY29uc3QgdmVydGV4ID0gdmVydGljZXNbaV07CiAgICAgIGNvbnN0IHggPSB2ZXJ0ZXhbMF07CiAgICAgIGNvbnN0IHkgPSB2ZXJ0ZXhbMV07CiAgICAgIGNvbnN0IHogPSB2ZXJ0ZXhbMl07CiAgICAgIF9wb2ludEluJDEuc2V0KHdlc3QgKyAoeCArIDAuNSkgKiBsb25ndGl0dWRlUmFuZ2UsIHNvdXRoICsgKHkgKyAwLjUpICogbGF0aXR1ZGVSYW5nZSwgeik7CiAgICAgIGlmICh1c2VHZW9Cb3VuZGluZ0JveCkgewogICAgICAgIHRhcmdldFByb2plY3Rpb24ucHJvamVjdENvb3JkaW5hdGUoX3BvaW50SW4kMSwgX3BvaW50T3V0JDEpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlcHJvamVjdENvb3JkaW5hdGUoc291cmNlUHJvamVjdGlvbiwgdGFyZ2V0UHJvamVjdGlvbiwgX3BvaW50SW4kMSwgX3BvaW50T3V0JDEpOwogICAgICB9CiAgICAgIHZlcnRleFswXSA9IF9wb2ludE91dCQxLng7CiAgICAgIHZlcnRleFsxXSA9IF9wb2ludE91dCQxLnk7CiAgICAgIHZlcnRleFsyXSA9IF9wb2ludE91dCQxLno7CiAgICAgIGlmIChpc1N1YkNlbnRlcikgewogICAgICAgIHZlcnRleFswXSAtPSBjZW50ZXJYOwogICAgICAgIHZlcnRleFsxXSAtPSBjZW50ZXJZOwogICAgICAgIHZlcnRleFsyXSAtPSBjZW50ZXJaOwogICAgICB9CiAgICB9CiAgfQp9Owpjb25zdCBzdWJkaXZpZGVWZXJ0aWNlcyA9ICh2ZXJ0aWNlcywgaW5kaWNlcywgdXZzLCB0aWxlQ29uZmlnKSA9PiB7CiAgaWYgKHRpbGVDb25maWcuc291cmNlUHJvamVjdGlvbk5hbWUgPT09IHRpbGVDb25maWcudGFyZ2V0UHJvamVjdGlvbk5hbWUpIHsKICAgIHJldHVybiB7CiAgICAgIHZlcnRpY2VzLAogICAgICBpbmRpY2VzLAogICAgICB1dnMKICAgIH07CiAgfQogIGNvbnN0IHNlZ21lbnQgPSBNYXRoLm1heCgyLCAxNiAtIHRpbGVDb25maWcueik7CiAgbGV0IG1pbkRpc3RhbmNlID0gMSAvIHNlZ21lbnQ7CiAgcmV0dXJuIHN1YmRpdmlkZU1lc2godmVydGljZXMsIGluZGljZXMsIHV2cywgbWluRGlzdGFuY2UpOwp9OwpuZXcgVmVjdG9yMyQxKCk7CmNsYXNzIFByb2plY3Rpb24gewogIGNvbnN0cnVjdG9yKCkgewogICAgX19wdWJsaWNGaWVsZCh0aGlzLCAiaXNQcm9qZWN0aW9uIiwgdHJ1ZSk7CiAgICBfX3B1YmxpY0ZpZWxkKHRoaXMsICJpc0dlbyIsIGZhbHNlKTsKICAgIF9fcHVibGljRmllbGQodGhpcywgImlzQXhpc0FsaWduZWQiLCBmYWxzZSk7CiAgfQogIHByb2plY3RDb29yZGluYXRlKGlucHV0LCBvdXRwdXQpIHsKICAgIHRocm93IG5ldyBFcnJvcigicHJvamVjdENvb3JkaW5hdGUoKSBtdXN0IGJlIGltcGxlbWVudGVkIGluIGRlcml2ZWQgY2xhc3NlcyIpOwogIH0KICB1bnByb2plY3RDb29yZGluYXRlKGlucHV0LCBvdXRwdXQpIHsKICAgIHRocm93IG5ldyBFcnJvcigidW5wcm9qZWN0Q29vcmRpbmF0ZSgpIG11c3QgYmUgaW1wbGVtZW50ZWQgaW4gZGVyaXZlZCBjbGFzc2VzIik7CiAgfQogIGdlb0JveFRvUHJvamVjdGVkQm94KGdlb0JveCwgcHJvamVjdGVkQm94KSB7CiAgICBpZiAoIXByb2plY3RlZEJveCkgewogICAgICBwcm9qZWN0ZWRCb3ggPSBuZXcgQm94MygpOwogICAgfQogICAgY29uc3QgbWluID0gdGhpcy5wcm9qZWN0Q29vcmRpbmF0ZShnZW9Cb3gubWluKTsKICAgIGNvbnN0IG1heCA9IHRoaXMucHJvamVjdENvb3JkaW5hdGUoZ2VvQm94Lm1heCk7CiAgICBwcm9qZWN0ZWRCb3gubWluLmNvcHkobWluKTsKICAgIHByb2plY3RlZEJveC5tYXguY29weShtYXgpOwogICAgcmV0dXJuIHByb2plY3RlZEJveDsKICB9CiAgZ2V0R2VvZGV0aWNTdXJmYWNlTm9ybWFsKGlucHV0LCBvdXRwdXQpIHsKICAgIGlmICghb3V0cHV0KSB7CiAgICAgIG91dHB1dCA9IG5ldyBWZWN0b3IzJDEoKTsKICAgIH0KICAgIG91dHB1dC5zZXQoMCwgMCwgMSk7CiAgICByZXR1cm4gb3V0cHV0OwogIH0KICBnZXRQcm9qZWN0ZWRTdXJmYWNlTm9ybWFsKGlucHV0LCBvdXRwdXQpIHsKICAgIGlmICghb3V0cHV0KSB7CiAgICAgIG91dHB1dCA9IG5ldyBWZWN0b3IzJDEoKTsKICAgIH0KICAgIG91dHB1dC5zZXQoMCwgMCwgMSk7CiAgICByZXR1cm4gb3V0cHV0OwogIH0KICBwcm9qZWN0ZWRCb3hUb0dlb0JveChwcm9qZWN0ZWRCb3gsIGdlb0JveCkgewogICAgaWYgKCFnZW9Cb3gpIHsKICAgICAgZ2VvQm94ID0gbmV3IEJveDMoKTsKICAgIH0KICAgIGNvbnN0IG1pbiA9IHRoaXMudW5wcm9qZWN0Q29vcmRpbmF0ZShwcm9qZWN0ZWRCb3gubWluKTsKICAgIGNvbnN0IG1heCA9IHRoaXMudW5wcm9qZWN0Q29vcmRpbmF0ZShwcm9qZWN0ZWRCb3gubWF4KTsKICAgIGdlb0JveC5taW4uY29weShtaW4pOwogICAgZ2VvQm94Lm1heC5jb3B5KG1heCk7CiAgICByZXR1cm4gZ2VvQm94OwogIH0KICBlcXVhbHMocHJvamVjdGlvbikgewogICAgaWYgKCFwcm9qZWN0aW9uKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0aGlzLm5hbWUgPT09IHByb2plY3Rpb24ubmFtZTsKICB9CiAgZ2V0V29ybGRCb3VuZGluZ0JveCgpIHsKICAgIGNvbnN0IGdlb0JvdW5kaW5nQm94ID0gbmV3IEJveDMobmV3IFZlY3RvcjMkMSgtMTgwLCAtOTAsIC0xMDApLCBuZXcgVmVjdG9yMyQxKDE4MCwgOTAsIDEwMCkpOwogICAgcmV0dXJuIHRoaXMuZ2VvQm94VG9Qcm9qZWN0ZWRCb3goZ2VvQm91bmRpbmdCb3gpOwogIH0KICBsb2NhbEZyYW1lVG9GaXhlZEZyYW1lKG9yaWdpbiwgZml4ZWRGcmFtZSkgewogICAgaWYgKCFmaXhlZEZyYW1lKSB7CiAgICAgIGZpeGVkRnJhbWUgPSBuZXcgTWF0cml4NCgpOwogICAgfQogICAgZml4ZWRGcmFtZS5pZGVudGl0eSgpOwogICAgZml4ZWRGcmFtZS5zZXRQb3NpdGlvbihvcmlnaW4pOwogICAgcmV0dXJuIGZpeGVkRnJhbWU7CiAgfQp9CmNvbnN0IGV4dGVuZFVucHJvamVjdENvb3JkaW5hdGUgPSAoaW5wdXRWYWx1ZSwgb2xkVmFsdWUsIG1heEdsb2JlVmFsdWUsIG1heFByb2plY3RlZFZhbHVlKSA9PiB7CiAgaWYgKE1hdGguYWJzKGlucHV0VmFsdWUpIDwgbWF4UHJvamVjdGVkVmFsdWUpIHsKICAgIHJldHVybiBvbGRWYWx1ZTsKICB9CiAgY29uc3Qgc2lnbjIgPSBpbnB1dFZhbHVlID4gMCA/IDEgOiAtMTsKICBjb25zdCBkaWZmID0gTWF0aC5hYnMoaW5wdXRWYWx1ZSkgLSBtYXhQcm9qZWN0ZWRWYWx1ZTsKICBjb25zdCByYXRpbyA9IGRpZmYgLyBtYXhQcm9qZWN0ZWRWYWx1ZTsKICByZXR1cm4gc2lnbjIgKiAobWF4R2xvYmVWYWx1ZSAqICgxICsgcmF0aW8pKTsKfTsKY29uc3QgZXh0ZW5kUHJvamVjdENvb3JkaW5hdGUgPSAoaW5wdXRWYWx1ZSwgb2xkVmFsdWUsIG1heEdsb2JlVmFsdWUsIG1heFByb2plY3RlZFZhbHVlKSA9PiB7CiAgaWYgKE1hdGguYWJzKGlucHV0VmFsdWUpIDwgbWF4R2xvYmVWYWx1ZSkgewogICAgcmV0dXJuIG9sZFZhbHVlOwogIH0KICBjb25zdCBzaWduMiA9IGlucHV0VmFsdWUgPiAwID8gMSA6IC0xOwogIGNvbnN0IGRpZmYgPSBNYXRoLmFicyhpbnB1dFZhbHVlKSAtIG1heEdsb2JlVmFsdWU7CiAgY29uc3QgcmF0aW8gPSBkaWZmIC8gbWF4R2xvYmVWYWx1ZTsKICByZXR1cm4gc2lnbjIgKiAobWF4UHJvamVjdGVkVmFsdWUgKiAoMSArIHJhdGlvKSk7Cn07CmNvbnN0IEQyUiA9IE1hdGguUEkgLyAxODA7CmNvbnN0IEEgPSA2Mzc4MTM3Owpjb25zdCBNQVhFWFRFTlQgPSAyMDAzNzUwODsKY29uc3QgUjJEID0gMTgwIC8gTWF0aC5QSTsKY29uc3QgTUFYTE9OID0gODUuMDUxMTI4Nzc5ODsKZnVuY3Rpb24gdG9NZXJjYXRvcihsb25MYXQsIHJlc3VsdCA9IG51bGwsIGV4dGVuZDIgPSBmYWxzZSkgewogIHZhciBhZGp1c3RlZCA9IE1hdGguYWJzKGxvbkxhdFswXSkgPD0gMTgwID8gbG9uTGF0WzBdIDogbG9uTGF0WzBdIC0gc2lnbihsb25MYXRbMF0pICogMzYwOwogIGNvbnN0IHh5ID0gcmVzdWx0IHx8IFswLCAwXTsKICB4eVswXSA9IEEgKiBhZGp1c3RlZCAqIEQyUjsKICB4eVsxXSA9IEEgKiBNYXRoLmxvZyhNYXRoLnRhbihNYXRoLlBJICogMC4yNSArIDAuNSAqIGxvbkxhdFsxXSAqIEQyUikpOwogIGlmIChleHRlbmQyKSB7CiAgICB4eVswXSA9IGV4dGVuZFByb2plY3RDb29yZGluYXRlKGxvbkxhdFswXSwgeHlbMF0sIDE4MCwgTUFYRVhURU5UKTsKICAgIHh5WzFdID0gZXh0ZW5kUHJvamVjdENvb3JkaW5hdGUobG9uTGF0WzFdLCB4eVsxXSwgTUFYTE9OLCBNQVhFWFRFTlQpOwogIH0gZWxzZSB7CiAgICBpZiAoeHlbMF0gPiBNQVhFWFRFTlQpCiAgICAgIHh5WzBdID0gTUFYRVhURU5UOwogICAgaWYgKHh5WzBdIDwgLU1BWEVYVEVOVCkKICAgICAgeHlbMF0gPSAtTUFYRVhURU5UOwogICAgaWYgKHh5WzFdID4gTUFYRVhURU5UKQogICAgICB4eVsxXSA9IE1BWEVYVEVOVDsKICAgIGlmICh4eVsxXSA8IC1NQVhFWFRFTlQpCiAgICAgIHh5WzFdID0gLU1BWEVYVEVOVDsKICB9CiAgcmV0dXJuIHh5Owp9CmZ1bmN0aW9uIHRvV2dzODQoeHksIHJlc3VsdCwgZXh0ZW5kMiA9IGZhbHNlKSB7CiAgY29uc3QgbG5nbGF0ID0gcmVzdWx0IHx8IFswLCAwXTsKICBsbmdsYXRbMF0gPSB4eVswXSAqIFIyRCAvIEE7CiAgbG5nbGF0WzFdID0gKE1hdGguUEkgKiAwLjUgLSAyICogTWF0aC5hdGFuKE1hdGguZXhwKC14eVsxXSAvIEEpKSkgKiBSMkQ7CiAgaWYgKGV4dGVuZDIpIHsKICAgIGxuZ2xhdFswXSA9IGV4dGVuZFVucHJvamVjdENvb3JkaW5hdGUoeHlbMF0sIGxuZ2xhdFswXSwgMTgwLCBNQVhFWFRFTlQpOwogICAgbG5nbGF0WzFdID0gZXh0ZW5kVW5wcm9qZWN0Q29vcmRpbmF0ZSh4eVsxXSwgbG5nbGF0WzFdLCBNQVhMT04sIE1BWEVYVEVOVCk7CiAgfQogIHJldHVybiBsbmdsYXQ7Cn0KZnVuY3Rpb24gc2lnbih4KSB7CiAgcmV0dXJuIHggPCAwID8gLTEgOiB4ID4gMCA/IDEgOiAwOwp9CmNvbnN0IF90ZW1wQ29vcmRpbmF0ZSA9IFswLCAwXTsKY2xhc3MgV2ViTWVyY2F0b3JQcm9qZWN0aW9uIGV4dGVuZHMgUHJvamVjdGlvbiB7CiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlciguLi5hcmd1bWVudHMpOwogICAgX19wdWJsaWNGaWVsZCh0aGlzLCAibmFtZSIsIFBST0pFQ1RJT05fV0VCX01FUkNBVE9SKTsKICAgIF9fcHVibGljRmllbGQodGhpcywgImlzQXhpc0FsaWduZWQiLCB0cnVlKTsKICB9CiAgcHJvamVjdENvb3JkaW5hdGUoaW5wdXQsIG91dHB1dCkgewogICAgY29uc3QgcmV0ID0gdG9NZXJjYXRvcihbaW5wdXQueCwgaW5wdXQueV0sIF90ZW1wQ29vcmRpbmF0ZSwgdHJ1ZSk7CiAgICBpZiAoIW91dHB1dCkgewogICAgICBvdXRwdXQgPSBuZXcgVmVjdG9yMyQxKCk7CiAgICB9CiAgICBvdXRwdXQueCA9IHJldFswXTsKICAgIG91dHB1dC55ID0gcmV0WzFdOwogICAgb3V0cHV0LnogPSBpbnB1dC56OwogICAgcmV0dXJuIG91dHB1dDsKICB9CiAgdW5wcm9qZWN0Q29vcmRpbmF0ZShpbnB1dCwgb3V0cHV0KSB7CiAgICBjb25zdCByZXQgPSB0b1dnczg0KFtpbnB1dC54LCBpbnB1dC55XSwgX3RlbXBDb29yZGluYXRlLCB0cnVlKTsKICAgIGlmICghb3V0cHV0KSB7CiAgICAgIG91dHB1dCA9IG5ldyBWZWN0b3IzJDEoKTsKICAgIH0KICAgIG91dHB1dC54ID0gcmV0WzBdOwogICAgb3V0cHV0LnkgPSByZXRbMV07CiAgICBvdXRwdXQueiA9IGlucHV0Lno7CiAgICByZXR1cm4gb3V0cHV0OwogIH0KfQpjb25zdCBJbnRlcnNlY3QgPSB7CiAgT1VUU0lERTogLTEsCiAgSU5URVJTRUNUSU5HOiAwLAogIElOU0lERTogMQp9Owp2YXIgSW50ZXJzZWN0JDEgPSBPYmplY3QuZnJlZXplKEludGVyc2VjdCk7CmNsYXNzIE9yaWVudGVkQm91bmRpbmdCb3ggewogIGNvbnN0cnVjdG9yKGNlbnRlciwgaGFsZkF4ZXMpIHsKICAgIHRoaXMuaXNPcmllbnRlZEJvdW5kaW5nQm94ID0gdHJ1ZTsKICAgIHRoaXMuY2VudGVyID0gQ2FydGVzaWFuMy5jbG9uZShkZWZhdWx0VmFsdWUoY2VudGVyLCBDYXJ0ZXNpYW4zLlpFUk8pLCBuZXcgVmVjdG9yMyQxKCkpOwogICAgdGhpcy5oYWxmQXhlcyA9IFN0YXRpY01hdHJpeDMuY2xvbmUoZGVmYXVsdFZhbHVlKGhhbGZBeGVzLCBTdGF0aWNNYXRyaXgzLlpFUk8pKTsKICB9CiAgaW50ZXJzZWN0UGxhbmUocGxhbmUpIHsKICAgIHJldHVybiBPcmllbnRlZEJvdW5kaW5nQm94LmludGVyc2VjdFBsYW5lKHRoaXMsIHBsYW5lKTsKICB9CiAgZGlzdGFuY2VTcXVhcmVkVG8oY2FydGVzaWFuKSB7CiAgICByZXR1cm4gT3JpZW50ZWRCb3VuZGluZ0JveC5kaXN0YW5jZVNxdWFyZWRUbyh0aGlzLCBjYXJ0ZXNpYW4pOwogIH0KICBjb21wdXRlQ29ybmVycyhyZXN1bHQpIHsKICAgIHJldHVybiBPcmllbnRlZEJvdW5kaW5nQm94LmNvbXB1dGVDb3JuZXJzKHRoaXMsIHJlc3VsdCk7CiAgfQogIGdldENlbnRlcihyZXN1bHQpIHsKICAgIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgICAgcmV0dXJuIHRoaXMuY2VudGVyLmNsb25lKCk7CiAgICB9CiAgICByZXN1bHQuY29weSh0aGlzLmNlbnRlcik7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBpbnRlcnNlY3RzT2JiKG90aGVyT2JiKSB7CiAgICBjb25zdCBjZW50ZXJBID0gdGhpcy5jZW50ZXI7CiAgICBjb25zdCBjZW50ZXJCID0gb3RoZXJPYmIuY2VudGVyOwogICAgY29uc3QgaGFsZkF4ZXNBID0gdGhpcy5oYWxmQXhlczsKICAgIGNvbnN0IGhhbGZBeGVzQiA9IG90aGVyT2JiLmhhbGZBeGVzOwogICAgY29uc3QgdCA9IG5ldyBWZWN0b3IzJDEoKS5zdWJWZWN0b3JzKGNlbnRlckIsIGNlbnRlckEpOwogICAgY29uc3QgYXhpc0ExID0gbmV3IFZlY3RvcjMkMShoYWxmQXhlc0EuZWxlbWVudHNbMF0sIGhhbGZBeGVzQS5lbGVtZW50c1sxXSwgaGFsZkF4ZXNBLmVsZW1lbnRzWzJdKTsKICAgIGNvbnN0IGF4aXNBMiA9IG5ldyBWZWN0b3IzJDEoaGFsZkF4ZXNBLmVsZW1lbnRzWzNdLCBoYWxmQXhlc0EuZWxlbWVudHNbNF0sIGhhbGZBeGVzQS5lbGVtZW50c1s1XSk7CiAgICBjb25zdCBheGlzQTMgPSBuZXcgVmVjdG9yMyQxKGhhbGZBeGVzQS5lbGVtZW50c1s2XSwgaGFsZkF4ZXNBLmVsZW1lbnRzWzddLCBoYWxmQXhlc0EuZWxlbWVudHNbOF0pOwogICAgY29uc3QgYXhpc0IxID0gbmV3IFZlY3RvcjMkMShoYWxmQXhlc0IuZWxlbWVudHNbMF0sIGhhbGZBeGVzQi5lbGVtZW50c1sxXSwgaGFsZkF4ZXNCLmVsZW1lbnRzWzJdKTsKICAgIGNvbnN0IGF4aXNCMiA9IG5ldyBWZWN0b3IzJDEoaGFsZkF4ZXNCLmVsZW1lbnRzWzNdLCBoYWxmQXhlc0IuZWxlbWVudHNbNF0sIGhhbGZBeGVzQi5lbGVtZW50c1s1XSk7CiAgICBjb25zdCBheGlzQjMgPSBuZXcgVmVjdG9yMyQxKGhhbGZBeGVzQi5lbGVtZW50c1s2XSwgaGFsZkF4ZXNCLmVsZW1lbnRzWzddLCBoYWxmQXhlc0IuZWxlbWVudHNbOF0pOwogICAgY29uc3QgaGFsZkExID0gYXhpc0ExLmxlbmd0aCgpOwogICAgY29uc3QgaGFsZkEyID0gYXhpc0EyLmxlbmd0aCgpOwogICAgY29uc3QgaGFsZkEzID0gYXhpc0EzLmxlbmd0aCgpOwogICAgYXhpc0ExLm5vcm1hbGl6ZSgpOwogICAgYXhpc0EyLm5vcm1hbGl6ZSgpOwogICAgYXhpc0EzLm5vcm1hbGl6ZSgpOwogICAgY29uc3QgaGFsZkIxID0gYXhpc0IxLmxlbmd0aCgpOwogICAgY29uc3QgaGFsZkIyID0gYXhpc0IyLmxlbmd0aCgpOwogICAgY29uc3QgaGFsZkIzID0gYXhpc0IzLmxlbmd0aCgpOwogICAgYXhpc0IxLm5vcm1hbGl6ZSgpOwogICAgYXhpc0IyLm5vcm1hbGl6ZSgpOwogICAgYXhpc0IzLm5vcm1hbGl6ZSgpOwogICAgbGV0IHIxOwogICAgbGV0IHIyOwogICAgbGV0IHI7CiAgICByMSA9IGhhbGZBMTsKICAgIHIyID0gaGFsZkIxICogTWF0aC5hYnMoYXhpc0ExLmRvdChheGlzQjEpKSArIGhhbGZCMiAqIE1hdGguYWJzKGF4aXNBMS5kb3QoYXhpc0IyKSkgKyBoYWxmQjMgKiBNYXRoLmFicyhheGlzQTEuZG90KGF4aXNCMykpOwogICAgciA9IE1hdGguYWJzKHQuZG90KGF4aXNBMSkpOwogICAgaWYgKHIgPiByMSArIHIyKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHIxID0gaGFsZkEyOwogICAgcjIgPSBoYWxmQjEgKiBNYXRoLmFicyhheGlzQTIuZG90KGF4aXNCMSkpICsgaGFsZkIyICogTWF0aC5hYnMoYXhpc0EyLmRvdChheGlzQjIpKSArIGhhbGZCMyAqIE1hdGguYWJzKGF4aXNBMi5kb3QoYXhpc0IzKSk7CiAgICByID0gTWF0aC5hYnModC5kb3QoYXhpc0EyKSk7CiAgICBpZiAociA+IHIxICsgcjIpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcjEgPSBoYWxmQTM7CiAgICByMiA9IGhhbGZCMSAqIE1hdGguYWJzKGF4aXNBMy5kb3QoYXhpc0IxKSkgKyBoYWxmQjIgKiBNYXRoLmFicyhheGlzQTMuZG90KGF4aXNCMikpICsgaGFsZkIzICogTWF0aC5hYnMoYXhpc0EzLmRvdChheGlzQjMpKTsKICAgIHIgPSBNYXRoLmFicyh0LmRvdChheGlzQTMpKTsKICAgIGlmIChyID4gcjEgKyByMikgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByMSA9IGhhbGZBMSAqIE1hdGguYWJzKGF4aXNCMS5kb3QoYXhpc0ExKSkgKyBoYWxmQTIgKiBNYXRoLmFicyhheGlzQjEuZG90KGF4aXNBMikpICsgaGFsZkEzICogTWF0aC5hYnMoYXhpc0IxLmRvdChheGlzQTMpKTsKICAgIHIyID0gaGFsZkIxOwogICAgciA9IE1hdGguYWJzKHQuZG90KGF4aXNCMSkpOwogICAgaWYgKHIgPiByMSArIHIyKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHIxID0gaGFsZkExICogTWF0aC5hYnMoYXhpc0IyLmRvdChheGlzQTEpKSArIGhhbGZBMiAqIE1hdGguYWJzKGF4aXNCMi5kb3QoYXhpc0EyKSkgKyBoYWxmQTMgKiBNYXRoLmFicyhheGlzQjIuZG90KGF4aXNBMykpOwogICAgcjIgPSBoYWxmQjI7CiAgICByID0gTWF0aC5hYnModC5kb3QoYXhpc0IyKSk7CiAgICBpZiAociA+IHIxICsgcjIpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcjEgPSBoYWxmQTEgKiBNYXRoLmFicyhheGlzQjMuZG90KGF4aXNBMSkpICsgaGFsZkEyICogTWF0aC5hYnMoYXhpc0IzLmRvdChheGlzQTIpKSArIGhhbGZBMyAqIE1hdGguYWJzKGF4aXNCMy5kb3QoYXhpc0EzKSk7CiAgICByMiA9IGhhbGZCMzsKICAgIHIgPSBNYXRoLmFicyh0LmRvdChheGlzQjMpKTsKICAgIGlmIChyID4gcjEgKyByMikgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9Cn0KY29uc3Qgc2NyYXRjaE9mZnNldCA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3Qgc2NyYXRjaFNjYWxlID0gbmV3IFZlY3RvcjMkMSgpOwpmdW5jdGlvbiBmcm9tUGxhbmVFeHRlbnRzKHBsYW5lT3JpZ2luLCBwbGFuZVhBeGlzLCBwbGFuZVlBeGlzLCBwbGFuZVpBeGlzLCBtaW5pbXVtWCwgbWF4aW11bVgsIG1pbmltdW1ZLCBtYXhpbXVtWSwgbWluaW11bVosIG1heGltdW1aLCByZXN1bHQpIHsKICBpZiAoIWRlZmluZWQkMShtaW5pbXVtWCkgfHwgIWRlZmluZWQkMShtYXhpbXVtWCkgfHwgIWRlZmluZWQkMShtaW5pbXVtWSkgfHwgIWRlZmluZWQkMShtYXhpbXVtWSkgfHwgIWRlZmluZWQkMShtaW5pbXVtWikgfHwgIWRlZmluZWQkMShtYXhpbXVtWikpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigKICAgICAgImFsbCBleHRlbnRzIChtaW5pbXVtL21heGltdW0gWC9ZL1opIGFyZSByZXF1aXJlZC4iCiAgICApOwogIH0KICBpZiAoIWRlZmluZWQkMShyZXN1bHQpKSB7CiAgICByZXN1bHQgPSBuZXcgT3JpZW50ZWRCb3VuZGluZ0JveCgpOwogIH0KICBjb25zdCBoYWxmQXhlcyA9IHJlc3VsdC5oYWxmQXhlczsKICBTdGF0aWNNYXRyaXgzLnNldENvbHVtbihoYWxmQXhlcywgMCwgcGxhbmVYQXhpcywgaGFsZkF4ZXMpOwogIFN0YXRpY01hdHJpeDMuc2V0Q29sdW1uKGhhbGZBeGVzLCAxLCBwbGFuZVlBeGlzLCBoYWxmQXhlcyk7CiAgU3RhdGljTWF0cml4My5zZXRDb2x1bW4oaGFsZkF4ZXMsIDIsIHBsYW5lWkF4aXMsIGhhbGZBeGVzKTsKICBsZXQgY2VudGVyT2Zmc2V0ID0gc2NyYXRjaE9mZnNldDsKICBjZW50ZXJPZmZzZXQueCA9IChtaW5pbXVtWCArIG1heGltdW1YKSAvIDI7CiAgY2VudGVyT2Zmc2V0LnkgPSAobWluaW11bVkgKyBtYXhpbXVtWSkgLyAyOwogIGNlbnRlck9mZnNldC56ID0gKG1pbmltdW1aICsgbWF4aW11bVopIC8gMjsKICBjb25zdCBzY2FsZSA9IHNjcmF0Y2hTY2FsZTsKICBzY2FsZS54ID0gKG1heGltdW1YIC0gbWluaW11bVgpIC8gMjsKICBzY2FsZS55ID0gKG1heGltdW1ZIC0gbWluaW11bVkpIC8gMjsKICBzY2FsZS56ID0gKG1heGltdW1aIC0gbWluaW11bVopIC8gMjsKICBjb25zdCBjZW50ZXIgPSByZXN1bHQuY2VudGVyOwogIGNlbnRlck9mZnNldCA9IFN0YXRpY01hdHJpeDMubXVsdGlwbHlCeVZlY3RvcihoYWxmQXhlcywgY2VudGVyT2Zmc2V0LCBjZW50ZXJPZmZzZXQpOwogIENhcnRlc2lhbjMuYWRkKHBsYW5lT3JpZ2luLCBjZW50ZXJPZmZzZXQsIGNlbnRlcik7CiAgU3RhdGljTWF0cml4My5tdWx0aXBseUJ5U2NhbGUoaGFsZkF4ZXMsIHNjYWxlLCBoYWxmQXhlcyk7CiAgcmV0dXJuIHJlc3VsdDsKfQpjb25zdCBzY3JhdGNoUmVjdGFuZ2xlQ2VudGVyQ2FydG9ncmFwaGljID0gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBzY3JhdGNoUmVjdGFuZ2xlQ2VudGVyID0gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljTkMgPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOVyA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3Qgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY0NXID0gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljU1cgPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTQyA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3Qgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhbk5DID0gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuTlcgPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5DVyA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3Qgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhblNXID0gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuU0MgPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWROQyA9IG5ldyBWZWN0b3IyKCk7CmNvbnN0IHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWROVyA9IG5ldyBWZWN0b3IyKCk7CmNvbnN0IHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWRDVyA9IG5ldyBWZWN0b3IyKCk7CmNvbnN0IHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWRTVyA9IG5ldyBWZWN0b3IyKCk7CmNvbnN0IHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWRTQyA9IG5ldyBWZWN0b3IyKCk7CmNvbnN0IHNjcmF0Y2hQbGFuZU9yaWdpbiA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3Qgc2NyYXRjaFBsYW5lTm9ybWFsID0gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBzY3JhdGNoUGxhbmVYQXhpcyA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3Qgc2NyYXRjaEhvcml6b25DYXJ0ZXNpYW4gPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IHNjcmF0Y2hIb3Jpem9uUHJvamVjdGVkID0gbmV3IFZlY3RvcjIoKTsKY29uc3Qgc2NyYXRjaE1heFkgPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IHNjcmF0Y2hNaW5ZID0gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBzY3JhdGNoWiA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3Qgc2NyYXRjaFBsYW5lID0gbmV3IFBsYW5lKG5ldyBWZWN0b3IzJDEoMSwgMCwgMCksIDApOwpPcmllbnRlZEJvdW5kaW5nQm94LmZyb21SZWN0YW5nbGUgPSBmdW5jdGlvbihyZWN0YW5nbGUsIG1pbmltdW1IZWlnaHQsIG1heGltdW1IZWlnaHQsIGVsbGlwc29pZCwgcmVzdWx0KSB7CiAgaWYgKCFkZWZpbmVkJDEocmVjdGFuZ2xlKSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJyZWN0YW5nbGUgaXMgcmVxdWlyZWQiKTsKICB9CiAgaWYgKHJlY3RhbmdsZS53aWR0aCA8IDAgfHwgcmVjdGFuZ2xlLndpZHRoID4gQ2VzaXVtTWF0aC5UV09fUEkpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigiUmVjdGFuZ2xlIHdpZHRoIG11c3QgYmUgYmV0d2VlbiAwIGFuZCAyICogcGkiKTsKICB9CiAgaWYgKHJlY3RhbmdsZS5oZWlnaHQgPCAwIHx8IHJlY3RhbmdsZS5oZWlnaHQgPiBDZXNpdW1NYXRoLlBJKSB7CiAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoIlJlY3RhbmdsZSBoZWlnaHQgbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIHBpIik7CiAgfQogIGlmIChkZWZpbmVkJDEoZWxsaXBzb2lkKSAmJiAhQ2VzaXVtTWF0aC5lcXVhbHNFcHNpbG9uKAogICAgZWxsaXBzb2lkLnJhZGlpLngsCiAgICBlbGxpcHNvaWQucmFkaWkueSwKICAgIENlc2l1bU1hdGguRVBTSUxPTjE1CiAgKSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKAogICAgICAiRWxsaXBzb2lkIG11c3QgYmUgYW4gZWxsaXBzb2lkIG9mIHJldm9sdXRpb24gKHJhZGlpLnggPT0gcmFkaWkueSkiCiAgICApOwogIH0KICBtaW5pbXVtSGVpZ2h0ID0gZGVmYXVsdFZhbHVlKG1pbmltdW1IZWlnaHQsIDApOwogIG1heGltdW1IZWlnaHQgPSBkZWZhdWx0VmFsdWUobWF4aW11bUhlaWdodCwgMCk7CiAgZWxsaXBzb2lkID0gZGVmYXVsdFZhbHVlKGVsbGlwc29pZCwgRWxsaXBzb2lkLldHUzg0KTsKICBsZXQgbWluWDsKICBsZXQgbWF4WDsKICBsZXQgbWluWTsKICBsZXQgbWF4WTsKICBsZXQgbWluWjsKICBsZXQgbWF4WjsKICBsZXQgcGxhbmU7CiAgaWYgKHJlY3RhbmdsZS53aWR0aCA8PSBDZXNpdW1NYXRoLlBJKSB7CiAgICBjb25zdCB0YW5nZW50UG9pbnRDYXJ0b2dyYXBoaWMgPSBSZWN0YW5nbGUuY2VudGVyKAogICAgICByZWN0YW5nbGUsCiAgICAgIHNjcmF0Y2hSZWN0YW5nbGVDZW50ZXJDYXJ0b2dyYXBoaWMKICAgICk7CiAgICBjb25zdCB0YW5nZW50UG9pbnQgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgIHRhbmdlbnRQb2ludENhcnRvZ3JhcGhpYywKICAgICAgc2NyYXRjaFJlY3RhbmdsZUNlbnRlcgogICAgKTsKICAgIGNvbnN0IHRhbmdlbnRQbGFuZSA9IG5ldyBFbGxpcHNvaWRUYW5nZW50UGxhbmUodGFuZ2VudFBvaW50LCBlbGxpcHNvaWQpOwogICAgcGxhbmUgPSB0YW5nZW50UGxhbmUucGxhbmU7CiAgICBjb25zdCBsb25DZW50ZXIgPSB0YW5nZW50UG9pbnRDYXJ0b2dyYXBoaWMueDsKICAgIGNvbnN0IGxhdENlbnRlciA9IHJlY3RhbmdsZS5zb3V0aCA8IDAgJiYgcmVjdGFuZ2xlLm5vcnRoID4gMCA/IDAgOiB0YW5nZW50UG9pbnRDYXJ0b2dyYXBoaWMueTsKICAgIGNvbnN0IHBlcmltZXRlckNhcnRvZ3JhcGhpY05DID0gQ2FydG9ncmFwaGljLmZyb21SYWRpYW5zKAogICAgICBsb25DZW50ZXIsCiAgICAgIHJlY3RhbmdsZS5ub3J0aCwKICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY05DCiAgICApOwogICAgY29uc3QgcGVyaW1ldGVyQ2FydG9ncmFwaGljTlcgPSBDYXJ0b2dyYXBoaWMuZnJvbVJhZGlhbnMoCiAgICAgIHJlY3RhbmdsZS53ZXN0LAogICAgICByZWN0YW5nbGUubm9ydGgsCiAgICAgIG1heGltdW1IZWlnaHQsCiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOVwogICAgKTsKICAgIGNvbnN0IHBlcmltZXRlckNhcnRvZ3JhcGhpY0NXID0gQ2FydG9ncmFwaGljLmZyb21SYWRpYW5zKAogICAgICByZWN0YW5nbGUud2VzdCwKICAgICAgbGF0Q2VudGVyLAogICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljQ1cKICAgICk7CiAgICBjb25zdCBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTVyA9IENhcnRvZ3JhcGhpYy5mcm9tUmFkaWFucygKICAgICAgcmVjdGFuZ2xlLndlc3QsCiAgICAgIHJlY3RhbmdsZS5zb3V0aCwKICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRvZ3JhcGhpY1NXCiAgICApOwogICAgY29uc3QgcGVyaW1ldGVyQ2FydG9ncmFwaGljU0MgPSBDYXJ0b2dyYXBoaWMuZnJvbVJhZGlhbnMoCiAgICAgIGxvbkNlbnRlciwKICAgICAgcmVjdGFuZ2xlLnNvdXRoLAogICAgICBtYXhpbXVtSGVpZ2h0LAogICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydG9ncmFwaGljU0MKICAgICk7CiAgICBjb25zdCBwZXJpbWV0ZXJDYXJ0ZXNpYW5OQyA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgcGVyaW1ldGVyQ2FydG9ncmFwaGljTkMsCiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5OQwogICAgKTsKICAgIGxldCBwZXJpbWV0ZXJDYXJ0ZXNpYW5OVyA9IGVsbGlwc29pZC5jYXJ0b2dyYXBoaWNUb0NhcnRlc2lhbigKICAgICAgcGVyaW1ldGVyQ2FydG9ncmFwaGljTlcsCiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJDYXJ0ZXNpYW5OVwogICAgKTsKICAgIGNvbnN0IHBlcmltZXRlckNhcnRlc2lhbkNXID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNDVywKICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhbkNXCiAgICApOwogICAgbGV0IHBlcmltZXRlckNhcnRlc2lhblNXID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTVywKICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhblNXCiAgICApOwogICAgY29uc3QgcGVyaW1ldGVyQ2FydGVzaWFuU0MgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgIHBlcmltZXRlckNhcnRvZ3JhcGhpY1NDLAogICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuU0MKICAgICk7CiAgICBjb25zdCBwZXJpbWV0ZXJQcm9qZWN0ZWROQyA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRUb05lYXJlc3RPblBsYW5lKAogICAgICBwZXJpbWV0ZXJDYXJ0ZXNpYW5OQywKICAgICAgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZE5DCiAgICApOwogICAgY29uc3QgcGVyaW1ldGVyUHJvamVjdGVkTlcgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50VG9OZWFyZXN0T25QbGFuZSgKICAgICAgcGVyaW1ldGVyQ2FydGVzaWFuTlcsCiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWROVwogICAgKTsKICAgIGNvbnN0IHBlcmltZXRlclByb2plY3RlZENXID0gdGFuZ2VudFBsYW5lLnByb2plY3RQb2ludFRvTmVhcmVzdE9uUGxhbmUoCiAgICAgIHBlcmltZXRlckNhcnRlc2lhbkNXLAogICAgICBzY3JhdGNoUGVyaW1ldGVyUHJvamVjdGVkQ1cKICAgICk7CiAgICBjb25zdCBwZXJpbWV0ZXJQcm9qZWN0ZWRTVyA9IHRhbmdlbnRQbGFuZS5wcm9qZWN0UG9pbnRUb05lYXJlc3RPblBsYW5lKAogICAgICBwZXJpbWV0ZXJDYXJ0ZXNpYW5TVywKICAgICAgc2NyYXRjaFBlcmltZXRlclByb2plY3RlZFNXCiAgICApOwogICAgY29uc3QgcGVyaW1ldGVyUHJvamVjdGVkU0MgPSB0YW5nZW50UGxhbmUucHJvamVjdFBvaW50VG9OZWFyZXN0T25QbGFuZSgKICAgICAgcGVyaW1ldGVyQ2FydGVzaWFuU0MsCiAgICAgIHNjcmF0Y2hQZXJpbWV0ZXJQcm9qZWN0ZWRTQwogICAgKTsKICAgIG1pblggPSBNYXRoLm1pbigKICAgICAgcGVyaW1ldGVyUHJvamVjdGVkTlcueCwKICAgICAgcGVyaW1ldGVyUHJvamVjdGVkQ1cueCwKICAgICAgcGVyaW1ldGVyUHJvamVjdGVkU1cueAogICAgKTsKICAgIG1heFggPSAtbWluWDsKICAgIG1heFkgPSBNYXRoLm1heChwZXJpbWV0ZXJQcm9qZWN0ZWROVy55LCBwZXJpbWV0ZXJQcm9qZWN0ZWROQy55KTsKICAgIG1pblkgPSBNYXRoLm1pbihwZXJpbWV0ZXJQcm9qZWN0ZWRTVy55LCBwZXJpbWV0ZXJQcm9qZWN0ZWRTQy55KTsKICAgIHBlcmltZXRlckNhcnRvZ3JhcGhpY05XLnogPSBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNTVy56ID0gbWluaW11bUhlaWdodDsKICAgIHBlcmltZXRlckNhcnRlc2lhbk5XID0gZWxsaXBzb2lkLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKAogICAgICBwZXJpbWV0ZXJDYXJ0b2dyYXBoaWNOVywKICAgICAgc2NyYXRjaFBlcmltZXRlckNhcnRlc2lhbk5XCiAgICApOwogICAgcGVyaW1ldGVyQ2FydGVzaWFuU1cgPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgIHBlcmltZXRlckNhcnRvZ3JhcGhpY1NXLAogICAgICBzY3JhdGNoUGVyaW1ldGVyQ2FydGVzaWFuU1cKICAgICk7CiAgICBtaW5aID0gTWF0aC5taW4oCiAgICAgIFN0YXRpY1BsYW5lLmdldFBvaW50RGlzdGFuY2UocGxhbmUsIHBlcmltZXRlckNhcnRlc2lhbk5XKSwKICAgICAgU3RhdGljUGxhbmUuZ2V0UG9pbnREaXN0YW5jZShwbGFuZSwgcGVyaW1ldGVyQ2FydGVzaWFuU1cpCiAgICApOwogICAgbWF4WiA9IG1heGltdW1IZWlnaHQ7CiAgICByZXR1cm4gZnJvbVBsYW5lRXh0ZW50cygKICAgICAgdGFuZ2VudFBsYW5lLm9yaWdpbiwKICAgICAgdGFuZ2VudFBsYW5lLnhBeGlzLAogICAgICB0YW5nZW50UGxhbmUueUF4aXMsCiAgICAgIHRhbmdlbnRQbGFuZS56QXhpcywKICAgICAgbWluWCwKICAgICAgbWF4WCwKICAgICAgbWluWSwKICAgICAgbWF4WSwKICAgICAgbWluWiwKICAgICAgbWF4WiwKICAgICAgcmVzdWx0CiAgICApOwogIH0KICBjb25zdCBmdWxseUFib3ZlRXF1YXRvciA9IHJlY3RhbmdsZS5zb3V0aCA+IDA7CiAgY29uc3QgZnVsbHlCZWxvd0VxdWF0b3IgPSByZWN0YW5nbGUubm9ydGggPCAwOwogIGNvbnN0IGxhdGl0dWRlTmVhcmVzdFRvRXF1YXRvciA9IGZ1bGx5QWJvdmVFcXVhdG9yID8gcmVjdGFuZ2xlLnNvdXRoIDogZnVsbHlCZWxvd0VxdWF0b3IgPyByZWN0YW5nbGUubm9ydGggOiAwOwogIGNvbnN0IGNlbnRlckxvbmdpdHVkZSA9IFJlY3RhbmdsZS5jZW50ZXIoCiAgICByZWN0YW5nbGUsCiAgICBzY3JhdGNoUmVjdGFuZ2xlQ2VudGVyQ2FydG9ncmFwaGljCiAgKS54OwogIGNvbnN0IHBsYW5lT3JpZ2luID0gQ2FydGVzaWFuMy5mcm9tUmFkaWFucygKICAgIGNlbnRlckxvbmdpdHVkZSwKICAgIGxhdGl0dWRlTmVhcmVzdFRvRXF1YXRvciwKICAgIG1heGltdW1IZWlnaHQsCiAgICBlbGxpcHNvaWQsCiAgICBzY3JhdGNoUGxhbmVPcmlnaW4KICApOwogIHBsYW5lT3JpZ2luLnogPSAwOwogIGNvbnN0IGlzUG9sZSA9IE1hdGguYWJzKHBsYW5lT3JpZ2luLngpIDwgQ2VzaXVtTWF0aC5FUFNJTE9OMTAgJiYgTWF0aC5hYnMocGxhbmVPcmlnaW4ueSkgPCBDZXNpdW1NYXRoLkVQU0lMT04xMDsKICBjb25zdCBwbGFuZU5vcm1hbCA9ICFpc1BvbGUgPyBDYXJ0ZXNpYW4zLm5vcm1hbGl6ZShwbGFuZU9yaWdpbiwgc2NyYXRjaFBsYW5lTm9ybWFsKSA6IENhcnRlc2lhbjMuVU5JVF9YOwogIGNvbnN0IHBsYW5lWUF4aXMgPSBDYXJ0ZXNpYW4zLlVOSVRfWjsKICBjb25zdCBwbGFuZVhBeGlzID0gQ2FydGVzaWFuMy5jcm9zcygKICAgIHBsYW5lTm9ybWFsLAogICAgcGxhbmVZQXhpcywKICAgIHNjcmF0Y2hQbGFuZVhBeGlzCiAgKTsKICBwbGFuZSA9IFN0YXRpY1BsYW5lLmZyb21Qb2ludE5vcm1hbChwbGFuZU9yaWdpbiwgcGxhbmVOb3JtYWwsIHNjcmF0Y2hQbGFuZSk7CiAgY29uc3QgaG9yaXpvbkNhcnRlc2lhbiA9IENhcnRlc2lhbjMuZnJvbVJhZGlhbnMoCiAgICBjZW50ZXJMb25naXR1ZGUgKyBDZXNpdW1NYXRoLlBJX09WRVJfVFdPLAogICAgbGF0aXR1ZGVOZWFyZXN0VG9FcXVhdG9yLAogICAgbWF4aW11bUhlaWdodCwKICAgIGVsbGlwc29pZCwKICAgIHNjcmF0Y2hIb3Jpem9uQ2FydGVzaWFuCiAgKTsKICBtYXhYID0gQ2FydGVzaWFuMy5kb3QoCiAgICBTdGF0aWNQbGFuZS5wcm9qZWN0UG9pbnRPbnRvUGxhbmUoCiAgICAgIHBsYW5lLAogICAgICBob3Jpem9uQ2FydGVzaWFuLAogICAgICBzY3JhdGNoSG9yaXpvblByb2plY3RlZAogICAgKSwKICAgIHBsYW5lWEF4aXMKICApOwogIG1pblggPSAtbWF4WDsKICBtYXhZID0gQ2FydGVzaWFuMy5mcm9tUmFkaWFucygKICAgIDAsCiAgICByZWN0YW5nbGUubm9ydGgsCiAgICBmdWxseUJlbG93RXF1YXRvciA/IG1pbmltdW1IZWlnaHQgOiBtYXhpbXVtSGVpZ2h0LAogICAgZWxsaXBzb2lkLAogICAgc2NyYXRjaE1heFkKICApLno7CiAgbWluWSA9IENhcnRlc2lhbjMuZnJvbVJhZGlhbnMoCiAgICAwLAogICAgcmVjdGFuZ2xlLnNvdXRoLAogICAgZnVsbHlBYm92ZUVxdWF0b3IgPyBtaW5pbXVtSGVpZ2h0IDogbWF4aW11bUhlaWdodCwKICAgIGVsbGlwc29pZCwKICAgIHNjcmF0Y2hNaW5ZCiAgKS56OwogIGNvbnN0IGZhclogPSBDYXJ0ZXNpYW4zLmZyb21SYWRpYW5zKAogICAgcmVjdGFuZ2xlLmVhc3QsCiAgICBsYXRpdHVkZU5lYXJlc3RUb0VxdWF0b3IsCiAgICBtYXhpbXVtSGVpZ2h0LAogICAgZWxsaXBzb2lkLAogICAgc2NyYXRjaFoKICApOwogIG1pblogPSBTdGF0aWNQbGFuZS5nZXRQb2ludERpc3RhbmNlKHBsYW5lLCBmYXJaKTsKICBtYXhaID0gMDsKICByZXR1cm4gZnJvbVBsYW5lRXh0ZW50cygKICAgIHBsYW5lT3JpZ2luLAogICAgcGxhbmVYQXhpcywKICAgIHBsYW5lWUF4aXMsCiAgICBwbGFuZU5vcm1hbCwKICAgIG1pblgsCiAgICBtYXhYLAogICAgbWluWSwKICAgIG1heFksCiAgICBtaW5aLAogICAgbWF4WiwKICAgIHJlc3VsdAogICk7Cn07CmNvbnN0IHNjcmF0Y2hDYXJ0ZXNpYW5VID0gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBzY3JhdGNoQ2FydGVzaWFuViA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3Qgc2NyYXRjaENhcnRlc2lhblcgPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IHNjcmF0Y2hWYWxpZEF4aXMyID0gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBzY3JhdGNoVmFsaWRBeGlzMyA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3Qgc2NyYXRjaFBQcmltZSA9IG5ldyBWZWN0b3IzJDEoKTsKT3JpZW50ZWRCb3VuZGluZ0JveC5kaXN0YW5jZVNxdWFyZWRUbyA9IGZ1bmN0aW9uKGJveCwgY2FydGVzaWFuKSB7CiAgaWYgKCFkZWZpbmVkJDEoYm94KSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJib3ggaXMgcmVxdWlyZWQuIik7CiAgfQogIGlmICghZGVmaW5lZCQxKGNhcnRlc2lhbikpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigiY2FydGVzaWFuIGlzIHJlcXVpcmVkLiIpOwogIH0KICBjb25zdCBvZmZzZXQgPSBDYXJ0ZXNpYW4zLnN1YnRyYWN0KGNhcnRlc2lhbiwgYm94LmNlbnRlciwgc2NyYXRjaE9mZnNldCk7CiAgY29uc3QgaGFsZkF4ZXMgPSBib3guaGFsZkF4ZXM7CiAgbGV0IHUgPSBTdGF0aWNNYXRyaXgzLmdldENvbHVtbihoYWxmQXhlcywgMCwgc2NyYXRjaENhcnRlc2lhblUpOwogIGxldCB2ID0gU3RhdGljTWF0cml4My5nZXRDb2x1bW4oaGFsZkF4ZXMsIDEsIHNjcmF0Y2hDYXJ0ZXNpYW5WKTsKICBsZXQgdyA9IFN0YXRpY01hdHJpeDMuZ2V0Q29sdW1uKGhhbGZBeGVzLCAyLCBzY3JhdGNoQ2FydGVzaWFuVyk7CiAgY29uc3QgdUhhbGYgPSBDYXJ0ZXNpYW4zLm1hZ25pdHVkZSh1KTsKICBjb25zdCB2SGFsZiA9IENhcnRlc2lhbjMubWFnbml0dWRlKHYpOwogIGNvbnN0IHdIYWxmID0gQ2FydGVzaWFuMy5tYWduaXR1ZGUodyk7CiAgbGV0IHVWYWxpZCA9IHRydWU7CiAgbGV0IHZWYWxpZCA9IHRydWU7CiAgbGV0IHdWYWxpZCA9IHRydWU7CiAgaWYgKHVIYWxmID4gMCkgewogICAgQ2FydGVzaWFuMy5kaXZpZGVCeVNjYWxhcih1LCB1SGFsZiwgdSk7CiAgfSBlbHNlIHsKICAgIHVWYWxpZCA9IGZhbHNlOwogIH0KICBpZiAodkhhbGYgPiAwKSB7CiAgICBDYXJ0ZXNpYW4zLmRpdmlkZUJ5U2NhbGFyKHYsIHZIYWxmLCB2KTsKICB9IGVsc2UgewogICAgdlZhbGlkID0gZmFsc2U7CiAgfQogIGlmICh3SGFsZiA+IDApIHsKICAgIENhcnRlc2lhbjMuZGl2aWRlQnlTY2FsYXIodywgd0hhbGYsIHcpOwogIH0gZWxzZSB7CiAgICB3VmFsaWQgPSBmYWxzZTsKICB9CiAgY29uc3QgbnVtYmVyT2ZEZWdlbmVyYXRlQXhlcyA9ICF1VmFsaWQgKyAhdlZhbGlkICsgIXdWYWxpZDsKICBsZXQgdmFsaWRBeGlzMTsKICBsZXQgdmFsaWRBeGlzMjsKICBsZXQgdmFsaWRBeGlzMzsKICBpZiAobnVtYmVyT2ZEZWdlbmVyYXRlQXhlcyA9PT0gMSkgewogICAgbGV0IGRlZ2VuZXJhdGVBeGlzID0gdTsKICAgIHZhbGlkQXhpczEgPSB2OwogICAgdmFsaWRBeGlzMiA9IHc7CiAgICBpZiAoIXZWYWxpZCkgewogICAgICBkZWdlbmVyYXRlQXhpcyA9IHY7CiAgICAgIHZhbGlkQXhpczEgPSB1OwogICAgfSBlbHNlIGlmICghd1ZhbGlkKSB7CiAgICAgIGRlZ2VuZXJhdGVBeGlzID0gdzsKICAgICAgdmFsaWRBeGlzMiA9IHU7CiAgICB9CiAgICB2YWxpZEF4aXMzID0gQ2FydGVzaWFuMy5jcm9zcyh2YWxpZEF4aXMxLCB2YWxpZEF4aXMyLCBzY3JhdGNoVmFsaWRBeGlzMyk7CiAgICBpZiAoZGVnZW5lcmF0ZUF4aXMgPT09IHUpIHsKICAgICAgdSA9IHZhbGlkQXhpczM7CiAgICB9IGVsc2UgaWYgKGRlZ2VuZXJhdGVBeGlzID09PSB2KSB7CiAgICAgIHYgPSB2YWxpZEF4aXMzOwogICAgfSBlbHNlIGlmIChkZWdlbmVyYXRlQXhpcyA9PT0gdykgewogICAgICB3ID0gdmFsaWRBeGlzMzsKICAgIH0KICB9IGVsc2UgaWYgKG51bWJlck9mRGVnZW5lcmF0ZUF4ZXMgPT09IDIpIHsKICAgIHZhbGlkQXhpczEgPSB1OwogICAgaWYgKHZWYWxpZCkgewogICAgICB2YWxpZEF4aXMxID0gdjsKICAgIH0gZWxzZSBpZiAod1ZhbGlkKSB7CiAgICAgIHZhbGlkQXhpczEgPSB3OwogICAgfQogICAgbGV0IGNyb3NzVmVjdG9yID0gQ2FydGVzaWFuMy5VTklUX1k7CiAgICBpZiAoQ2FydGVzaWFuMy5lcXVhbHNFcHNpbG9uKGNyb3NzVmVjdG9yLCB2YWxpZEF4aXMxLCBDZXNpdW1NYXRoLkVQU0lMT04zKSkgewogICAgICBjcm9zc1ZlY3RvciA9IENhcnRlc2lhbjMuVU5JVF9YOwogICAgfQogICAgdmFsaWRBeGlzMiA9IENhcnRlc2lhbjMuY3Jvc3ModmFsaWRBeGlzMSwgY3Jvc3NWZWN0b3IsIHNjcmF0Y2hWYWxpZEF4aXMyKTsKICAgIENhcnRlc2lhbjMubm9ybWFsaXplKHZhbGlkQXhpczIsIHZhbGlkQXhpczIpOwogICAgdmFsaWRBeGlzMyA9IENhcnRlc2lhbjMuY3Jvc3ModmFsaWRBeGlzMSwgdmFsaWRBeGlzMiwgc2NyYXRjaFZhbGlkQXhpczMpOwogICAgQ2FydGVzaWFuMy5ub3JtYWxpemUodmFsaWRBeGlzMywgdmFsaWRBeGlzMyk7CiAgICBpZiAodmFsaWRBeGlzMSA9PT0gdSkgewogICAgICB2ID0gdmFsaWRBeGlzMjsKICAgICAgdyA9IHZhbGlkQXhpczM7CiAgICB9IGVsc2UgaWYgKHZhbGlkQXhpczEgPT09IHYpIHsKICAgICAgdyA9IHZhbGlkQXhpczI7CiAgICAgIHUgPSB2YWxpZEF4aXMzOwogICAgfSBlbHNlIGlmICh2YWxpZEF4aXMxID09PSB3KSB7CiAgICAgIHUgPSB2YWxpZEF4aXMyOwogICAgICB2ID0gdmFsaWRBeGlzMzsKICAgIH0KICB9IGVsc2UgaWYgKG51bWJlck9mRGVnZW5lcmF0ZUF4ZXMgPT09IDMpIHsKICAgIHUgPSBDYXJ0ZXNpYW4zLlVOSVRfWDsKICAgIHYgPSBDYXJ0ZXNpYW4zLlVOSVRfWTsKICAgIHcgPSBDYXJ0ZXNpYW4zLlVOSVRfWjsKICB9CiAgY29uc3QgcFByaW1lID0gc2NyYXRjaFBQcmltZTsKICBwUHJpbWUueCA9IENhcnRlc2lhbjMuZG90KG9mZnNldCwgdSk7CiAgcFByaW1lLnkgPSBDYXJ0ZXNpYW4zLmRvdChvZmZzZXQsIHYpOwogIHBQcmltZS56ID0gQ2FydGVzaWFuMy5kb3Qob2Zmc2V0LCB3KTsKICBsZXQgZGlzdGFuY2VTcXVhcmVkID0gMDsKICBsZXQgZDsKICBpZiAocFByaW1lLnggPCAtdUhhbGYpIHsKICAgIGQgPSBwUHJpbWUueCArIHVIYWxmOwogICAgZGlzdGFuY2VTcXVhcmVkICs9IGQgKiBkOwogIH0gZWxzZSBpZiAocFByaW1lLnggPiB1SGFsZikgewogICAgZCA9IHBQcmltZS54IC0gdUhhbGY7CiAgICBkaXN0YW5jZVNxdWFyZWQgKz0gZCAqIGQ7CiAgfQogIGlmIChwUHJpbWUueSA8IC12SGFsZikgewogICAgZCA9IHBQcmltZS55ICsgdkhhbGY7CiAgICBkaXN0YW5jZVNxdWFyZWQgKz0gZCAqIGQ7CiAgfSBlbHNlIGlmIChwUHJpbWUueSA+IHZIYWxmKSB7CiAgICBkID0gcFByaW1lLnkgLSB2SGFsZjsKICAgIGRpc3RhbmNlU3F1YXJlZCArPSBkICogZDsKICB9CiAgaWYgKHBQcmltZS56IDwgLXdIYWxmKSB7CiAgICBkID0gcFByaW1lLnogKyB3SGFsZjsKICAgIGRpc3RhbmNlU3F1YXJlZCArPSBkICogZDsKICB9IGVsc2UgaWYgKHBQcmltZS56ID4gd0hhbGYpIHsKICAgIGQgPSBwUHJpbWUueiAtIHdIYWxmOwogICAgZGlzdGFuY2VTcXVhcmVkICs9IGQgKiBkOwogIH0KICByZXR1cm4gZGlzdGFuY2VTcXVhcmVkOwp9OwpPcmllbnRlZEJvdW5kaW5nQm94LmludGVyc2VjdFBsYW5lID0gZnVuY3Rpb24oYm94LCBwbGFuZSkgewogIGlmICghZGVmaW5lZCQxKGJveCkpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigiYm94IGlzIHJlcXVpcmVkLiIpOwogIH0KICBpZiAoIWRlZmluZWQkMShwbGFuZSkpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigicGxhbmUgaXMgcmVxdWlyZWQuIik7CiAgfQogIGNvbnN0IGNlbnRlciA9IGJveC5jZW50ZXI7CiAgY29uc3Qgbm9ybWFsID0gcGxhbmUubm9ybWFsOwogIGNvbnN0IGhhbGZBeGVzID0gYm94LmhhbGZBeGVzOwogIGNvbnN0IG5vcm1hbFggPSBub3JtYWwueDsKICBjb25zdCBub3JtYWxZID0gbm9ybWFsLnk7CiAgY29uc3Qgbm9ybWFsWiA9IG5vcm1hbC56OwogIGNvbnN0IGVsZW1lbnRzID0gaGFsZkF4ZXMuZWxlbWVudHM7CiAgY29uc3QgcmFkRWZmZWN0aXZlID0gTWF0aC5hYnMoCiAgICBub3JtYWxYICogZWxlbWVudHNbU3RhdGljTWF0cml4My5DT0xVTU4wUk9XMF0gKyBub3JtYWxZICogZWxlbWVudHNbU3RhdGljTWF0cml4My5DT0xVTU4wUk9XMV0gKyBub3JtYWxaICogZWxlbWVudHNbU3RhdGljTWF0cml4My5DT0xVTU4wUk9XMl0KICApICsgTWF0aC5hYnMoCiAgICBub3JtYWxYICogZWxlbWVudHNbU3RhdGljTWF0cml4My5DT0xVTU4xUk9XMF0gKyBub3JtYWxZICogZWxlbWVudHNbU3RhdGljTWF0cml4My5DT0xVTU4xUk9XMV0gKyBub3JtYWxaICogZWxlbWVudHNbU3RhdGljTWF0cml4My5DT0xVTU4xUk9XMl0KICApICsgTWF0aC5hYnMoCiAgICBub3JtYWxYICogZWxlbWVudHNbU3RhdGljTWF0cml4My5DT0xVTU4yUk9XMF0gKyBub3JtYWxZICogZWxlbWVudHNbU3RhdGljTWF0cml4My5DT0xVTU4yUk9XMV0gKyBub3JtYWxaICogZWxlbWVudHNbU3RhdGljTWF0cml4My5DT0xVTU4yUk9XMl0KICApOwogIGNvbnN0IGRpc3RhbmNlVG9QbGFuZSA9IENhcnRlc2lhbjMuZG90KG5vcm1hbC5jbG9uZSgpLCBjZW50ZXIpICsgcGxhbmUuY29uc3RhbnQ7CiAgaWYgKGRpc3RhbmNlVG9QbGFuZSA8PSAtcmFkRWZmZWN0aXZlKSB7CiAgICByZXR1cm4gSW50ZXJzZWN0JDEuT1VUU0lERTsKICB9IGVsc2UgaWYgKGRpc3RhbmNlVG9QbGFuZSA+PSByYWRFZmZlY3RpdmUpIHsKICAgIHJldHVybiBJbnRlcnNlY3QkMS5JTlNJREU7CiAgfQogIHJldHVybiBJbnRlcnNlY3QkMS5JTlRFUlNFQ1RJTkc7Cn07CmNvbnN0IHNjcmF0Y2hYQXhpcyA9IG5ldyBWZWN0b3IzJDEoKTsKY29uc3Qgc2NyYXRjaFlBeGlzID0gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBzY3JhdGNoWkF4aXMgPSBuZXcgVmVjdG9yMyQxKCk7Ck9yaWVudGVkQm91bmRpbmdCb3guY29tcHV0ZUNvcm5lcnMgPSBmdW5jdGlvbihib3gsIHJlc3VsdCkgewogIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgIHJlc3VsdCA9IFsKICAgICAgbmV3IFZlY3RvcjMkMSgpLAogICAgICBuZXcgVmVjdG9yMyQxKCksCiAgICAgIG5ldyBWZWN0b3IzJDEoKSwKICAgICAgbmV3IFZlY3RvcjMkMSgpLAogICAgICBuZXcgVmVjdG9yMyQxKCksCiAgICAgIG5ldyBWZWN0b3IzJDEoKSwKICAgICAgbmV3IFZlY3RvcjMkMSgpLAogICAgICBuZXcgVmVjdG9yMyQxKCkKICAgIF07CiAgfQogIGNvbnN0IGNlbnRlciA9IGJveC5jZW50ZXI7CiAgY29uc3QgaGFsZkF4ZXMgPSBib3guaGFsZkF4ZXM7CiAgY29uc3QgeEF4aXMgPSBTdGF0aWNNYXRyaXgzLmdldENvbHVtbihoYWxmQXhlcywgMCwgc2NyYXRjaFhBeGlzKTsKICBjb25zdCB5QXhpcyA9IFN0YXRpY01hdHJpeDMuZ2V0Q29sdW1uKGhhbGZBeGVzLCAxLCBzY3JhdGNoWUF4aXMpOwogIGNvbnN0IHpBeGlzID0gU3RhdGljTWF0cml4My5nZXRDb2x1bW4oaGFsZkF4ZXMsIDIsIHNjcmF0Y2haQXhpcyk7CiAgQ2FydGVzaWFuMy5jbG9uZShjZW50ZXIsIHJlc3VsdFswXSk7CiAgQ2FydGVzaWFuMy5zdWJ0cmFjdChyZXN1bHRbMF0sIHhBeGlzLCByZXN1bHRbMF0pOwogIENhcnRlc2lhbjMuc3VidHJhY3QocmVzdWx0WzBdLCB5QXhpcywgcmVzdWx0WzBdKTsKICBDYXJ0ZXNpYW4zLnN1YnRyYWN0KHJlc3VsdFswXSwgekF4aXMsIHJlc3VsdFswXSk7CiAgQ2FydGVzaWFuMy5jbG9uZShjZW50ZXIsIHJlc3VsdFsxXSk7CiAgQ2FydGVzaWFuMy5zdWJ0cmFjdChyZXN1bHRbMV0sIHhBeGlzLCByZXN1bHRbMV0pOwogIENhcnRlc2lhbjMuc3VidHJhY3QocmVzdWx0WzFdLCB5QXhpcywgcmVzdWx0WzFdKTsKICBDYXJ0ZXNpYW4zLmFkZChyZXN1bHRbMV0sIHpBeGlzLCByZXN1bHRbMV0pOwogIENhcnRlc2lhbjMuY2xvbmUoY2VudGVyLCByZXN1bHRbMl0pOwogIENhcnRlc2lhbjMuc3VidHJhY3QocmVzdWx0WzJdLCB4QXhpcywgcmVzdWx0WzJdKTsKICBDYXJ0ZXNpYW4zLmFkZChyZXN1bHRbMl0sIHlBeGlzLCByZXN1bHRbMl0pOwogIENhcnRlc2lhbjMuc3VidHJhY3QocmVzdWx0WzJdLCB6QXhpcywgcmVzdWx0WzJdKTsKICBDYXJ0ZXNpYW4zLmNsb25lKGNlbnRlciwgcmVzdWx0WzNdKTsKICBDYXJ0ZXNpYW4zLnN1YnRyYWN0KHJlc3VsdFszXSwgeEF4aXMsIHJlc3VsdFszXSk7CiAgQ2FydGVzaWFuMy5hZGQocmVzdWx0WzNdLCB5QXhpcywgcmVzdWx0WzNdKTsKICBDYXJ0ZXNpYW4zLmFkZChyZXN1bHRbM10sIHpBeGlzLCByZXN1bHRbM10pOwogIENhcnRlc2lhbjMuY2xvbmUoY2VudGVyLCByZXN1bHRbNF0pOwogIENhcnRlc2lhbjMuYWRkKHJlc3VsdFs0XSwgeEF4aXMsIHJlc3VsdFs0XSk7CiAgQ2FydGVzaWFuMy5zdWJ0cmFjdChyZXN1bHRbNF0sIHlBeGlzLCByZXN1bHRbNF0pOwogIENhcnRlc2lhbjMuc3VidHJhY3QocmVzdWx0WzRdLCB6QXhpcywgcmVzdWx0WzRdKTsKICBDYXJ0ZXNpYW4zLmNsb25lKGNlbnRlciwgcmVzdWx0WzVdKTsKICBDYXJ0ZXNpYW4zLmFkZChyZXN1bHRbNV0sIHhBeGlzLCByZXN1bHRbNV0pOwogIENhcnRlc2lhbjMuc3VidHJhY3QocmVzdWx0WzVdLCB5QXhpcywgcmVzdWx0WzVdKTsKICBDYXJ0ZXNpYW4zLmFkZChyZXN1bHRbNV0sIHpBeGlzLCByZXN1bHRbNV0pOwogIENhcnRlc2lhbjMuY2xvbmUoY2VudGVyLCByZXN1bHRbNl0pOwogIENhcnRlc2lhbjMuYWRkKHJlc3VsdFs2XSwgeEF4aXMsIHJlc3VsdFs2XSk7CiAgQ2FydGVzaWFuMy5hZGQocmVzdWx0WzZdLCB5QXhpcywgcmVzdWx0WzZdKTsKICBDYXJ0ZXNpYW4zLnN1YnRyYWN0KHJlc3VsdFs2XSwgekF4aXMsIHJlc3VsdFs2XSk7CiAgQ2FydGVzaWFuMy5jbG9uZShjZW50ZXIsIHJlc3VsdFs3XSk7CiAgQ2FydGVzaWFuMy5hZGQocmVzdWx0WzddLCB4QXhpcywgcmVzdWx0WzddKTsKICBDYXJ0ZXNpYW4zLmFkZChyZXN1bHRbN10sIHlBeGlzLCByZXN1bHRbN10pOwogIENhcnRlc2lhbjMuYWRkKHJlc3VsdFs3XSwgekF4aXMsIHJlc3VsdFs3XSk7CiAgcmV0dXJuIHJlc3VsdDsKfTsKT3JpZW50ZWRCb3VuZGluZ0JveC5mcm9tR2VvQm91bmRpbmdCb3ggPSBmdW5jdGlvbihnZW9Cb3VuZGluZ0JveCwgcmVzdWx0KSB7CiAgaWYgKCFkZWZpbmVkJDEoZ2VvQm91bmRpbmdCb3gpKSB7CiAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoImdlb0JvdW5kaW5nQm94IGlzIHJlcXVpcmVkLiIpOwogIH0KICBjb25zdCBtaW4gPSBnZW9Cb3VuZGluZ0JveC5taW47CiAgY29uc3QgbWF4ID0gZ2VvQm91bmRpbmdCb3gubWF4OwogIGNvbnN0IHJlY3RhbmdsZSA9IFJlY3RhbmdsZS5mcm9tQm94KGdlb0JvdW5kaW5nQm94LCBudWxsLCB0cnVlKTsKICByZXR1cm4gT3JpZW50ZWRCb3VuZGluZ0JveC5mcm9tUmVjdGFuZ2xlKAogICAgcmVjdGFuZ2xlLAogICAgbWluLnosCiAgICBtYXgueiwKICAgIG51bGwsCiAgICByZXN1bHQKICApOwp9OwpjbGFzcyBFQ0VGUHJvamVjdGlvbiBleHRlbmRzIFByb2plY3Rpb24gewogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgIF9fcHVibGljRmllbGQodGhpcywgIm5hbWUiLCBQUk9KRUNUSU9OX0VDRUYpOwogIH0KICBwcm9qZWN0Q29vcmRpbmF0ZShpbnB1dCwgb3V0cHV0KSB7CiAgICByZXR1cm4gRWxsaXBzb2lkLldHUzg0LmNhcnRvZ3JhcGhpY0RlZ3JlZVRvQ2FydGVzaWFuKGlucHV0LCBvdXRwdXQpOwogIH0KICB1bnByb2plY3RDb29yZGluYXRlKGlucHV0LCBvdXRwdXQpIHsKICAgIHJldHVybiBFbGxpcHNvaWQuV0dTODQuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWNEZWdyZWUoaW5wdXQsIG91dHB1dCk7CiAgfQogIGdldEdlb2RldGljU3VyZmFjZU5vcm1hbChpbnB1dCwgb3V0cHV0KSB7CiAgICBpZiAoIW91dHB1dCkgewogICAgICBvdXRwdXQgPSBuZXcgVmVjdG9yMyQxKCk7CiAgICB9CiAgICBjb25zdCBub3JtYWwgPSBFbGxpcHNvaWQuV0dTODQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsQ2FydG9ncmFwaGljKGlucHV0LCBvdXRwdXQpOwogICAgcmV0dXJuIG5vcm1hbDsKICB9CiAgZ2V0UHJvamVjdGVkU3VyZmFjZU5vcm1hbChpbnB1dCwgb3V0cHV0KSB7CiAgICBpZiAoIW91dHB1dCkgewogICAgICBvdXRwdXQgPSBuZXcgVmVjdG9yMyQxKCk7CiAgICB9CiAgICBjb25zdCBub3JtYWwgPSBFbGxpcHNvaWQuV0dTODQuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKGlucHV0LCBvdXRwdXQpOwogICAgcmV0dXJuIG5vcm1hbDsKICB9CiAgZ2VvQm94VG9Qcm9qZWN0ZWRCb3goZ2VvQm94LCBwcm9qZWN0ZWRCb3gpIHsKICAgIGlmICghcHJvamVjdGVkQm94KSB7CiAgICAgIHByb2plY3RlZEJveCA9IG5ldyBPcmllbnRlZEJvdW5kaW5nQm94KCk7CiAgICB9CiAgICBwcm9qZWN0ZWRCb3ggPSBPcmllbnRlZEJvdW5kaW5nQm94LmZyb21HZW9Cb3VuZGluZ0JveChnZW9Cb3gsIHByb2plY3RlZEJveCk7CiAgICByZXR1cm4gcHJvamVjdGVkQm94OwogIH0KICBnZXRMT0RTYWNsZU9mR2VvQm91bmRpbmdCb3goZ2VvQm91bmRpbmdCb3gpIHsKICAgIGlmIChnZW9Cb3VuZGluZ0JveC5taW4ueSA+IDg1IHx8IGdlb0JvdW5kaW5nQm94Lm1heC55IDwgLTg1KSB7CiAgICAgIHJldHVybiAwOwogICAgfQogICAgY29uc3QgbGF0ID0gKGdlb0JvdW5kaW5nQm94Lm1pbi55ICsgZ2VvQm91bmRpbmdCb3gubWF4LnkpIC8gMjsKICAgIHJldHVybiBNYXRoLmNvcyhNYXRoVXRpbHMuZGVnVG9SYWQobGF0KSk7CiAgfQogIGxvY2FsRnJhbWVUb0ZpeGVkRnJhbWUob3JpZ2luLCBmaXhlZEZyYW1lKSB7CiAgICBpZiAoIWZpeGVkRnJhbWUpIHsKICAgICAgZml4ZWRGcmFtZSA9IG5ldyBNYXRyaXg0KCk7CiAgICB9CiAgICBUcmFuc2Zvcm1zLmVhc3ROb3J0aFVwVG9GaXhlZEZyYW1lKG9yaWdpbiwgbnVsbCwgZml4ZWRGcmFtZSk7CiAgICByZXR1cm4gZml4ZWRGcmFtZTsKICB9Cn0KZnVuY3Rpb24gTWVyY2F0b3JQcm9qZWN0aW9uKCkgewp9CmZ1bmN0aW9uIGV4dGVuZChvYmosIG9wdGlvbnMpIHsKICBmb3IgKGxldCBrZXkgaW4gb3B0aW9ucykgewogICAgb2JqW2tleV0gPSBvcHRpb25zW2tleV07CiAgfQp9CmZ1bmN0aW9uIFBvaW50KGxuZywgbGF0KSB7CiAgdGhpcy5sbmcgPSBsbmc7CiAgdGhpcy5sYXQgPSBsYXQ7Cn0KZXh0ZW5kKFBvaW50LnByb3RvdHlwZSwgewogIGVxdWFsczogZnVuY3Rpb24ob3RoZXIpIHsKICAgIHJldHVybiB0aGlzLmxhdCA9PT0gb3RoZXIubGF0ICYmIHRoaXMubG5nID09PSBvdGhlci5sbmc7CiAgfSwKICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbmV3IFBvaW50KHRoaXMubGF0LCB0aGlzLmxuZyk7CiAgfSwKICBnZXRMbmdTcGFuOiBmdW5jdGlvbihsbmcpIHsKICAgIGxldCB0aGlzTG5nID0gdGhpcy5sbmc7CiAgICBsZXQgc3BhbiA9IE1hdGguYWJzKGxuZyAtIHRoaXNMbmcpOwogICAgaWYgKHNwYW4gPiAxODApIHsKICAgICAgc3BhbiA9IDM2MCAtIHNwYW47CiAgICB9CiAgICByZXR1cm4gc3BhbjsKICB9LAogIHN1YjogZnVuY3Rpb24obGF0TG5nKSB7CiAgICByZXR1cm4gbmV3IFBvaW50KHRoaXMubGF0IC0gbGF0TG5nLmxhdCwgdGhpcy5sbmcgLSBsYXRMbmcubG5nKTsKICB9LAogIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiAiUG9pbnQiOwogIH0KfSk7CmZ1bmN0aW9uIFBpeGVsKHgsIHkpIHsKICB0aGlzLnggPSB4OwogIHRoaXMueSA9IHk7Cn0KZXh0ZW5kKE1lcmNhdG9yUHJvamVjdGlvbiwgewogIEVBUlRIUkFESVVTOiA2MzcwOTk2ODFlLTIsCiAgTUNCQU5EOiBbMTI4OTA1OTQ4NmUtMiwgODM2MjM3Nzg3ZS0yLCA1NTkxMDIxLCAzNDgxOTg5ODNlLTIsIDE2NzgwNDMxMmUtMiwgMF0sCiAgTExCQU5EOiBbNzUsIDYwLCA0NSwgMzAsIDE1LCAwXSwKICBNQzJMTDogWwogICAgWzE0MTA1MjYxNzIxMTYyNTVlLTIzLCA4OTgzMDU1MDk2NDg4NzJlLTIwLCAtMS45OTM5ODMzODE2MzMxLCAyMDAuOTgyNDM4MzEwNjc5NiwgLTE4Ny4yNDAzNzAzODE1NTQ3LCA5MS42MDg3NTE2NjY5ODQzLCAtMjMuMzg3NjU2NDk2MDMzMzksIDIuNTcxMjEzMTcyOTYxOTgsIC0wLjAzODAxMDAzMzA4NjUzLCAxNzMzNzk4MTJlLTFdLAogICAgWy03NDM1ODU2Mzg5NTY1NTM3ZS0yNCwgODk4MzA1NTA5NzcyNjIzOWUtMjEsIC0wLjc4NjI1MjAxODg2Mjg5LCA5Ni4zMjY4NzU5OTc1OTg0NiwgLTEuODUyMDQ3NTc1Mjk4MjYsIC01OS4zNjkzNTkwNTQ4NTg3NywgNDcuNDAwMzM1NDkyOTY3MzcsIC0xNi41MDc0MTkzMTA2Mzg4NywgMi4yODc4NjY3NDY5OTM3NSwgMTAyNjAxNDQ4NmUtMl0sCiAgICBbLTMwMzA4ODM0NjA4OTg4MjZlLTIzLCA4OTgzMDU1MDk5ODM1NzhlLTIwLCAwLjMwMDcxMzE2Mjg3NjE2LCA1OS43NDI5MzYxODQ0MjI3NywgNy4zNTc5ODQwNzQ4NzEsIC0yNS4zODM3MTAwMjY2NDc0NSwgMTMuNDUzODA1MjExMTA5MDgsIC0zLjI5ODgzNzY3MjM1NTg0LCAwLjMyNzEwOTA1MzYzNDc1LCA2ODU2ODE3MzdlLTJdLAogICAgWy0xOTgxOTgxMzA0OTMwNTUyZS0yMywgODk4MzA1NTA5OTc3OTUzNWUtMjEsIDAuMDMyNzgxODI4NTI1OTEsIDQwLjMxNjc4NTI3NzA1NzQ0LCAwLjY1NjU5Mjk4Njc3Mjc3LCAtNC40NDI1NTUzNDQ3NzQ5MiwgMC44NTM0MTkxMTgwNTI2MywgMC4xMjkyMzM0Nzk5ODIwNCwgLTAuMDQ2MjU3MzYwMDc1NjEsIDQ0ODI3NzcwNmUtMl0sCiAgICBbMzA5MTkxMzcxMDY4NDM3ZS0yMywgODk4MzA1NTA5NjgxMjE1NWUtMjEsIDY5OTU3MjQwNjJlLTE0LCAyMy4xMDkzNDMwNDE0NDkwMSwgLTIzNjYzNDkwNTExZS0xNCwgLTAuNjMyMTgxNzgxMDI0MiwgLTAuMDA2NjM0OTQ0NjcyNzMsIDAuMDM0MzAwODIzOTc5NTMsIC0wLjAwNDY2MDQzODc2MzMyLCAyNTU1MTY0NGUtMV0sCiAgICBbMjg5MDg3MTE0NDc3Njg3OGUtMjQsIDg5ODMwNTUwOTU4MDU0MDdlLTIxLCAtMzA2ODI5OGUtMTQsIDcuNDcxMzcwMjU0NjgwMzIsIC0zNTM5Mzc5OTRlLTE0LCAtMC4wMjE0NTE0NDg2MTAzNywgLTEyMzQ0MjY1OTZlLTE0LCAxMDMyMjk1Mjc3M2UtMTQsIC0zMjM4OTAzNjRlLTE0LCA4MjYwODguNV0KICBdLAogIExMMk1DOiBbCiAgICBbLTAuMDAxNTcwMjEwMjQ0NCwgMTExMzIwLjcwMjA2MTY5MzksIDE3MDQ0ODA1MjQ1MzUyMDMsIC0xMDMzODk4NzM3NjA0MjM0MCwgMjYxMTI2Njc4NTY2MDM4ODAsIC0zNTE0OTY2OTE3NjY1MzcwMCwgMjY1OTU3MDA3MTg0MDM5MjAsIC0xMDcyNTAxMjQ1NDE4ODI0MCwgMTgwMDgxOTkxMjk1MDQ3NCwgODIuNV0sCiAgICBbODI3NzgyNDUxNjE3MjUyNmUtMTksIDExMTMyMC43MDIwNDYzNTc4LCA2NDc3OTU1NzQ2NjcxNjA3ZS03LCAtNDA4MjAwMzE3MzY0MTMxNmUtNiwgMTA3NzQ5MDU2NjM1MTE0MmUtNSwgLTE1MTcxODc1NTMxNTE1NTllLTUsIDEyMDUzMDY1MzM4NjIxNjdlLTUsIC01MTI0OTM5NjYzNTc3NDcyZS02LCA5MTMzMTE5MzU5NTEyMDMyZS03LCA2Ny41XSwKICAgIFswLjAwMzM3Mzk4NzY2NzY1LCAxMTEzMjAuNzAyMDIwMjE2MiwgNDQ4MTM1MTA0NTg5MDM2NWUtOSwgLTIzMzkzNzUxMTk5MzE2NjJlLTgsIDc5NjgyMjE1NDcxODY0NTVlLTgsIC0xMTU5NjQ5OTMyNzk3MjUzZS03LCA5NzIzNjcxMTE1NjAyMTQ1ZS04LCAtNDM2NjE5NDYzMzc1MjgyMWUtOCwgODQ3NzIzMDUwMTEzNTIzNGUtOSwgNTIuNV0sCiAgICBbMC4wMDIyMDYzNjQ5NjIwOCwgMTExMzIwLjcwMjAyMDkxMjgsIDUxNzUxLjg2MTEyODQxMTMxLCAzNzk2ODM3NzQ5NDcwMjQ1ZS05LCA5OTIwMTMuNzM5Nzc5MTAxMywgLTEyMjE5NTIyMTcxMTI4N2UtOCwgMTM0MDY1MjY5NzAwOTA3NWUtOSwgLTYyMDk0My42OTkwOTg0MzEyLCAxNDQ0MTYuOTI5MzgwNjI0MSwgMzcuNV0sCiAgICBbLTM0NDE5NjM1MDQzNjgzOTJlLTE5LCAxMTEzMjAuNzAyMDU3Njg1NiwgMjc4LjIzNTM5ODA3NzI3NTIsIDI0ODU3NTg2OTAwMzUzOTRlLTksIDYwNzAuNzUwOTYzMjQzMzc4LCA1NDgyMS4xODM0NTM1MjExOCwgOTU0MC42MDY2MzMzMDQyMzYsIC0yNzEwLjU1MzI2NzQ2NjQ1LCAxNDA1LjQ4Mzg0NDEyMTcyNiwgMjIuNV0sCiAgICBbLTMyMTgxMzU4Nzg2MTMxMzJlLTE5LCAxMTEzMjAuNzAyMDcwMTYxNSwgMC4wMDM2OTM4MzQzMTI4OSwgODIzNzI1LjY0MDI3OTU3MTgsIDAuNDYxMDQ5ODY5MDkwOTMsIDIzNTEuMzQzMTQxMzMxMjkyLCAxLjU4MDYwNzg0Mjk4MTk5LCA4Ljc3NzM4NTg5MDc4Mjg0LCAwLjM3MjM4ODg0MjUyNDI0LCA3LjQ1XQogIF0sCiAgZ2V0RGlzdGFuY2VCeU1DOiBmdW5jdGlvbihwb2ludDEsIHBvaW50MikgewogICAgaWYgKCFwb2ludDEgfHwgIXBvaW50MikgewogICAgICByZXR1cm4gMDsKICAgIH0KICAgIGxldCB4MTsKICAgIGxldCB5MTsKICAgIGxldCB4MjsKICAgIGxldCB5MjsKICAgIHBvaW50MSA9IHRoaXMuY29udmVydE1DMkxMKHBvaW50MSk7CiAgICBpZiAoIXBvaW50MSkgewogICAgICByZXR1cm4gMDsKICAgIH0KICAgIHgxID0gdGhpcy50b1JhZGlhbnMocG9pbnQxLmxuZyk7CiAgICB5MSA9IHRoaXMudG9SYWRpYW5zKHBvaW50MS5sYXQpOwogICAgcG9pbnQyID0gdGhpcy5jb252ZXJ0TUMyTEwocG9pbnQyKTsKICAgIGlmICghcG9pbnQyKSB7CiAgICAgIHJldHVybiAwOwogICAgfQogICAgeDIgPSB0aGlzLnRvUmFkaWFucyhwb2ludDIubG5nKTsKICAgIHkyID0gdGhpcy50b1JhZGlhbnMocG9pbnQyLmxhdCk7CiAgICByZXR1cm4gdGhpcy5nZXREaXN0YW5jZSh4MSwgeDIsIHkxLCB5Mik7CiAgfSwKICBnZXREaXN0YW5jZUJ5TEw6IGZ1bmN0aW9uKHBvaW50MSwgcG9pbnQyKSB7CiAgICBpZiAoIXBvaW50MSB8fCAhcG9pbnQyKSB7CiAgICAgIHJldHVybiAwOwogICAgfQogICAgcG9pbnQxLmxuZyA9IHRoaXMuZ2V0TG9vcChwb2ludDEubG5nLCAtMTgwLCAxODApOwogICAgcG9pbnQxLmxhdCA9IHRoaXMuZ2V0UmFuZ2UocG9pbnQxLmxhdCwgLTc0LCA3NCk7CiAgICBwb2ludDIubG5nID0gdGhpcy5nZXRMb29wKHBvaW50Mi5sbmcsIC0xODAsIDE4MCk7CiAgICBwb2ludDIubGF0ID0gdGhpcy5nZXRSYW5nZShwb2ludDIubGF0LCAtNzQsIDc0KTsKICAgIGxldCB4MTsKICAgIGxldCB4MjsKICAgIGxldCB5MTsKICAgIGxldCB5MjsKICAgIHgxID0gdGhpcy50b1JhZGlhbnMocG9pbnQxLmxuZyk7CiAgICB5MSA9IHRoaXMudG9SYWRpYW5zKHBvaW50MS5sYXQpOwogICAgeDIgPSB0aGlzLnRvUmFkaWFucyhwb2ludDIubG5nKTsKICAgIHkyID0gdGhpcy50b1JhZGlhbnMocG9pbnQyLmxhdCk7CiAgICByZXR1cm4gdGhpcy5nZXREaXN0YW5jZSh4MSwgeDIsIHkxLCB5Mik7CiAgfSwKICBjb252ZXJ0TUMyTEw6IGZ1bmN0aW9uKHBvaW50KSB7CiAgICBpZiAocG9pbnQgPT09IG51bGwgfHwgcG9pbnQgPT09IHZvaWQgMCkgewogICAgICByZXR1cm4gbmV3IFBvaW50KDAsIDApOwogICAgfQogICAgaWYgKHBvaW50LmxuZyA8IDE4MCAmJiBwb2ludC5sbmcgPiAtMTgwICYmIHBvaW50LmxhdCA8IDkwICYmIHBvaW50LmxhdCA+IC05MCkgewogICAgICByZXR1cm4gcG9pbnQ7CiAgICB9CiAgICBsZXQgdGVtcDsKICAgIGxldCBmYWN0b3I7CiAgICB0ZW1wID0gbmV3IFBvaW50KE1hdGguYWJzKHBvaW50LmxuZyksIE1hdGguYWJzKHBvaW50LmxhdCkpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLk1DQkFORC5sZW5ndGg7IGkrKykgewogICAgICBpZiAodGVtcC5sYXQgPj0gdGhpcy5NQ0JBTkRbaV0pIHsKICAgICAgICBmYWN0b3IgPSB0aGlzLk1DMkxMW2ldOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBsZXQgbG5nbGF0ID0gdGhpcy5jb252ZXJ0b3IocG9pbnQsIGZhY3Rvcik7CiAgICB2YXIgcG9pbnQgPSBuZXcgUG9pbnQobG5nbGF0LmxuZy50b0ZpeGVkKDYpLCBsbmdsYXQubGF0LnRvRml4ZWQoNikpOwogICAgcmV0dXJuIHBvaW50OwogIH0sCiAgY29udmVydExMMk1DOiBmdW5jdGlvbihwb2ludCkgewogICAgaWYgKHBvaW50ID09PSBudWxsIHx8IHBvaW50ID09PSB2b2lkIDApIHsKICAgICAgcmV0dXJuIG5ldyBQb2ludCgwLCAwKTsKICAgIH0KICAgIGlmIChwb2ludC5sbmcgPiAxODAgfHwgcG9pbnQubG5nIDwgLTE4MCB8fCBwb2ludC5sYXQgPiA5MCB8fCBwb2ludC5sYXQgPCAtOTApIHsKICAgICAgcmV0dXJuIHBvaW50OwogICAgfQogICAgbGV0IHRlbXA7CiAgICBsZXQgZmFjdG9yOwogICAgcG9pbnQubG5nID0gdGhpcy5nZXRMb29wKHBvaW50LmxuZywgLTE4MCwgMTgwKTsKICAgIHBvaW50LmxhdCA9IHRoaXMuZ2V0UmFuZ2UocG9pbnQubGF0LCAtNzQsIDc0KTsKICAgIHRlbXAgPSBuZXcgUG9pbnQocG9pbnQubG5nLCBwb2ludC5sYXQpOwogICAgaWYgKHdpbmRvdy5CTUFQR0xfODQpIHsKICAgICAgdmFyIG1lcmNhdG9yID0ge307CiAgICAgIHZhciBlYXJ0aFJhZCA9IDYzNzgxMzc7CiAgICAgIG1lcmNhdG9yLmxuZyA9IHRlbXAubG5nICogTWF0aC5QSSAvIDE4MCAqIGVhcnRoUmFkOwogICAgICB2YXIgYSA9IHRlbXAubGF0ICogTWF0aC5QSSAvIDE4MDsKICAgICAgbWVyY2F0b3IubGF0ID0gZWFydGhSYWQgLyAyICogTWF0aC5sb2coKDEgKyBNYXRoLnNpbihhKSkgLyAoMSAtIE1hdGguc2luKGEpKSk7CiAgICAgIHZhciByZXN1bHQgPSBuZXcgUG9pbnQoTnVtYmVyKG1lcmNhdG9yLmxuZyksIE51bWJlcihtZXJjYXRvci5sYXQpKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5MTEJBTkQubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHRlbXAubGF0ID49IHRoaXMuTExCQU5EW2ldKSB7CiAgICAgICAgZmFjdG9yID0gdGhpcy5MTDJNQ1tpXTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgaWYgKCFmYWN0b3IpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLkxMQkFORC5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICh0ZW1wLmxhdCA8PSAtdGhpcy5MTEJBTkRbaV0pIHsKICAgICAgICAgIGZhY3RvciA9IHRoaXMuTEwyTUNbaV07CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGxldCBtYyA9IHRoaXMuY29udmVydG9yKHBvaW50LCBmYWN0b3IpOwogICAgdmFyIHBvaW50ID0gbmV3IFBvaW50KE51bWJlcihtYy5sbmcpLCBOdW1iZXIobWMubGF0KSk7CiAgICByZXR1cm4gcG9pbnQ7CiAgfSwKICBjb252ZXJ0b3I6IGZ1bmN0aW9uKGZyb21Qb2ludCwgZmFjdG9yKSB7CiAgICBpZiAoIWZyb21Qb2ludCB8fCAhZmFjdG9yKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGxldCB4ID0gZmFjdG9yWzBdICsgZmFjdG9yWzFdICogTWF0aC5hYnMoZnJvbVBvaW50LmxuZyk7CiAgICBsZXQgdGVtcCA9IE1hdGguYWJzKGZyb21Qb2ludC5sYXQpIC8gZmFjdG9yWzldOwogICAgbGV0IHkgPSBmYWN0b3JbMl0gKyBmYWN0b3JbM10gKiB0ZW1wICsgZmFjdG9yWzRdICogdGVtcCAqIHRlbXAgKyBmYWN0b3JbNV0gKiB0ZW1wICogdGVtcCAqIHRlbXAgKyBmYWN0b3JbNl0gKiB0ZW1wICogdGVtcCAqIHRlbXAgKiB0ZW1wICsgZmFjdG9yWzddICogdGVtcCAqIHRlbXAgKiB0ZW1wICogdGVtcCAqIHRlbXAgKyBmYWN0b3JbOF0gKiB0ZW1wICogdGVtcCAqIHRlbXAgKiB0ZW1wICogdGVtcCAqIHRlbXA7CiAgICB4ICo9IGZyb21Qb2ludC5sbmcgPCAwID8gLTEgOiAxOwogICAgeSAqPSBmcm9tUG9pbnQubGF0IDwgMCA/IC0xIDogMTsKICAgIHJldHVybiBuZXcgUG9pbnQoeCwgeSk7CiAgfSwKICBnZXREaXN0YW5jZTogZnVuY3Rpb24oeDEsIHgyLCB5MSwgeTIpIHsKICAgIHJldHVybiB0aGlzLkVBUlRIUkFESVVTICogTWF0aC5hY29zKE1hdGguc2luKHkxKSAqIE1hdGguc2luKHkyKSArIE1hdGguY29zKHkxKSAqIE1hdGguY29zKHkyKSAqIE1hdGguY29zKHgyIC0geDEpKTsKICB9LAogIHRvUmFkaWFuczogZnVuY3Rpb24oYW5nZGVnKSB7CiAgICByZXR1cm4gTWF0aC5QSSAqIGFuZ2RlZyAvIDE4MDsKICB9LAogIHRvRGVncmVlczogZnVuY3Rpb24oYW5ncmFkKSB7CiAgICByZXR1cm4gMTgwICogYW5ncmFkIC8gTWF0aC5QSTsKICB9LAogIGdldFJhbmdlOiBmdW5jdGlvbih2LCBhLCBiKSB7CiAgICBpZiAoYSAhPSBudWxsKSB7CiAgICAgIHYgPSBNYXRoLm1heCh2LCBhKTsKICAgIH0KICAgIGlmIChiICE9IG51bGwpIHsKICAgICAgdiA9IE1hdGgubWluKHYsIGIpOwogICAgfQogICAgcmV0dXJuIHY7CiAgfSwKICBnZXRMb29wOiBmdW5jdGlvbih2LCBhLCBiKSB7CiAgICB3aGlsZSAodiA+IGIpIHsKICAgICAgdiAtPSBiIC0gYTsKICAgIH0KICAgIHdoaWxlICh2IDwgYSkgewogICAgICB2ICs9IGIgLSBhOwogICAgfQogICAgcmV0dXJuIHY7CiAgfQp9KTsKZXh0ZW5kKE1lcmNhdG9yUHJvamVjdGlvbi5wcm90b3R5cGUsIHsKICBsbmdMYXRUb01lcmNhdG9yOiBmdW5jdGlvbihwb2ludCkgewogICAgcmV0dXJuIE1lcmNhdG9yUHJvamVjdGlvbi5jb252ZXJ0TEwyTUMocG9pbnQpOwogIH0sCiAgbG5nTGF0VG9Qb2ludDogZnVuY3Rpb24ocG9pbnQpIHsKICAgIGxldCBtZXJjYXRvciA9IE1lcmNhdG9yUHJvamVjdGlvbi5jb252ZXJ0TEwyTUMocG9pbnQpOwogICAgcmV0dXJuIG5ldyBQaXhlbChtZXJjYXRvci5sbmcsIG1lcmNhdG9yLmxhdCk7CiAgfSwKICBtZXJjYXRvclRvTG5nTGF0OiBmdW5jdGlvbihwb2ludCkgewogICAgcmV0dXJuIE1lcmNhdG9yUHJvamVjdGlvbi5jb252ZXJ0TUMyTEwocG9pbnQpOwogIH0sCiAgcG9pbnRUb0xuZ0xhdDogZnVuY3Rpb24ocG9pbnQpIHsKICAgIGxldCBtZXJjYXRvciA9IG5ldyBQb2ludChwb2ludC54LCBwb2ludC55KTsKICAgIHJldHVybiBNZXJjYXRvclByb2plY3Rpb24uY29udmVydE1DMkxMKG1lcmNhdG9yKTsKICB9LAogIHBvaW50VG9QaXhlbDogZnVuY3Rpb24ocG9pbnQsIHpvb20sIG1hcENlbnRlciwgbWFwU2l6ZSwgY3VyQ2l0eSkgewogICAgaWYgKCFwb2ludCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBwb2ludCA9IHRoaXMubG5nTGF0VG9NZXJjYXRvcihwb2ludCwgY3VyQ2l0eSk7CiAgICBsZXQgem9vbVVuaXRzID0gdGhpcy5nZXRab29tVW5pdHMoem9vbSk7CiAgICBsZXQgeCA9IE1hdGgucm91bmQoKHBvaW50LmxuZyAtIG1hcENlbnRlci5sbmcpIC8gem9vbVVuaXRzICsgbWFwU2l6ZS53aWR0aCAvIDIpOwogICAgbGV0IHkgPSBNYXRoLnJvdW5kKChtYXBDZW50ZXIubGF0IC0gcG9pbnQubGF0KSAvIHpvb21Vbml0cyArIG1hcFNpemUuaGVpZ2h0IC8gMik7CiAgICByZXR1cm4gbmV3IFBpeGVsKHgsIHkpOwogIH0sCiAgcGl4ZWxUb1BvaW50OiBmdW5jdGlvbihwaXhlbCwgem9vbSwgbWFwQ2VudGVyLCBtYXBTaXplLCBjdXJDaXR5KSB7CiAgICBpZiAoIXBpeGVsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGxldCB6b29tVW5pdHMgPSB0aGlzLmdldFpvb21Vbml0cyh6b29tKTsKICAgIGxldCBsbmcgPSBtYXBDZW50ZXIubG5nICsgem9vbVVuaXRzICogKHBpeGVsLnggLSBtYXBTaXplLndpZHRoIC8gMik7CiAgICBsZXQgbGF0ID0gbWFwQ2VudGVyLmxhdCAtIHpvb21Vbml0cyAqIChwaXhlbC55IC0gbWFwU2l6ZS5oZWlnaHQgLyAyKTsKICAgIGxldCBwb2ludCA9IG5ldyBQb2ludChsbmcsIGxhdCk7CiAgICByZXR1cm4gdGhpcy5tZXJjYXRvclRvTG5nTGF0KHBvaW50LCBjdXJDaXR5KTsKICB9LAogIGdldFpvb21Vbml0czogZnVuY3Rpb24oem9vbSkgewogICAgcmV0dXJuIE1hdGgucG93KDIsIDE4IC0gem9vbSk7CiAgfQp9KTsKY29uc3QgaGFsZkVhcnRoU2l6ZSA9IDIwMDM3NzI0MTZlLTI7CmNvbnN0IG1heExvbiA9IDg1LjA1MTEyODc3OTgwNjU5OwpjbGFzcyBCYWlkdU1lcmNhdG9yUHJvamVjdGlvbiBleHRlbmRzIFByb2plY3Rpb24gewogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgIF9fcHVibGljRmllbGQodGhpcywgIm5hbWUiLCBQUk9KRUNUSU9OX0JEX01FUkNBVE9SKTsKICAgIF9fcHVibGljRmllbGQodGhpcywgImlzQXhpc0FsaWduZWQiLCB0cnVlKTsKICAgIF9fcHVibGljRmllbGQodGhpcywgInVucHJvamVjdENvb3JkaW5hdGUiLCAoaW5wdXQsIG91dHB1dCkgPT4gewogICAgICBpZiAoIW91dHB1dCkgewogICAgICAgIG91dHB1dCA9IG5ldyBWZWN0b3IzJDEoKTsKICAgICAgfQogICAgICBjb25zdCByZXN1bHQgPSBNZXJjYXRvclByb2plY3Rpb24uY29udmVydE1DMkxMKHsgbG5nOiBpbnB1dC54LCBsYXQ6IGlucHV0LnkgfSk7CiAgICAgIG91dHB1dC5zZXQoTnVtYmVyKHJlc3VsdC5sbmcpLCBOdW1iZXIocmVzdWx0LmxhdCksIGlucHV0LnopOwogICAgICBvdXRwdXQueCA9IGV4dGVuZFVucHJvamVjdENvb3JkaW5hdGUoaW5wdXQueCwgb3V0cHV0LngsIDE4MCwgaGFsZkVhcnRoU2l6ZSk7CiAgICAgIG91dHB1dC55ID0gZXh0ZW5kVW5wcm9qZWN0Q29vcmRpbmF0ZShpbnB1dC55LCBvdXRwdXQueSwgbWF4TG9uLCBoYWxmRWFydGhTaXplKTsKICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH0pOwogIH0KICBwcm9qZWN0Q29vcmRpbmF0ZShpbnB1dCwgb3V0cHV0KSB7CiAgICBpZiAoIW91dHB1dCkgewogICAgICBvdXRwdXQgPSBuZXcgVmVjdG9yMyQxKCk7CiAgICB9CiAgICBjb25zdCByZXN1bHQgPSBNZXJjYXRvclByb2plY3Rpb24uY29udmVydExMMk1DKHsgbG5nOiBpbnB1dC54LCBsYXQ6IGlucHV0LnkgfSk7CiAgICBvdXRwdXQuc2V0KE51bWJlcihyZXN1bHQubG5nKSwgTnVtYmVyKHJlc3VsdC5sYXQpLCBpbnB1dC56KTsKICAgIG91dHB1dC54ID0gZXh0ZW5kUHJvamVjdENvb3JkaW5hdGUoaW5wdXQueCwgb3V0cHV0LngsIDE4MCwgaGFsZkVhcnRoU2l6ZSk7CiAgICBvdXRwdXQueSA9IGV4dGVuZFByb2plY3RDb29yZGluYXRlKGlucHV0LnksIG91dHB1dC55LCBtYXhMb24sIGhhbGZFYXJ0aFNpemUpOwogICAgcmV0dXJuIG91dHB1dDsKICB9Cn0KY29uc3Qgc2NhbGVGYWN0b3IgPSA2Mzc4MTM3ICogTWF0aC5QSSAvIDE4MDsKY2xhc3MgR2VvUHJvamVjdGlvbiBleHRlbmRzIFByb2plY3Rpb24gewogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgIF9fcHVibGljRmllbGQodGhpcywgIm5hbWUiLCBQUk9KRUNUSU9OX0dFTyk7CiAgICBfX3B1YmxpY0ZpZWxkKHRoaXMsICJpc0dlbyIsIHRydWUpOwogICAgX19wdWJsaWNGaWVsZCh0aGlzLCAiaXNBeGlzQWxpZ25lZCIsIHRydWUpOwogIH0KICBwcm9qZWN0Q29vcmRpbmF0ZShpbnB1dCwgb3V0cHV0KSB7CiAgICBpZiAoIW91dHB1dCkgewogICAgICBvdXRwdXQgPSBuZXcgVmVjdG9yMyQxKCk7CiAgICB9CiAgICBvdXRwdXQueCA9IGlucHV0LnggKiBzY2FsZUZhY3RvcjsKICAgIG91dHB1dC55ID0gaW5wdXQueSAqIHNjYWxlRmFjdG9yOwogICAgb3V0cHV0LnogPSBpbnB1dC56OwogICAgcmV0dXJuIG91dHB1dDsKICB9CiAgdW5wcm9qZWN0Q29vcmRpbmF0ZShpbnB1dCwgb3V0cHV0KSB7CiAgICBpZiAoIW91dHB1dCkgewogICAgICBvdXRwdXQgPSBuZXcgVmVjdG9yMyQxKCk7CiAgICB9CiAgICBvdXRwdXQueCA9IGlucHV0LnggLyBzY2FsZUZhY3RvcjsKICAgIG91dHB1dC55ID0gaW5wdXQueSAvIHNjYWxlRmFjdG9yOwogICAgb3V0cHV0LnogPSBpbnB1dC56OwogICAgcmV0dXJuIG91dHB1dDsKICB9Cn0KY2xhc3MgU2NyZWVuUGl4ZWxQcm9qZWN0aW9uIGV4dGVuZHMgUHJvamVjdGlvbiB7CiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlciguLi5hcmd1bWVudHMpOwogICAgX19wdWJsaWNGaWVsZCh0aGlzLCAibmFtZSIsIFBST0pFQ1RJT05fU0NSRUVOX1BJWEVMKTsKICAgIF9fcHVibGljRmllbGQodGhpcywgImlzQXhpc0FsaWduZWQiLCB0cnVlKTsKICB9CiAgcHJvamVjdENvb3JkaW5hdGUoaW5wdXQsIG91dHB1dCkgewogICAgaWYgKCFvdXRwdXQpIHsKICAgICAgb3V0cHV0ID0gbmV3IFZlY3RvcjMkMSgpOwogICAgfQogICAgb3V0cHV0LnggPSBpbnB1dC54OwogICAgb3V0cHV0LnkgPSAtaW5wdXQueTsKICAgIG91dHB1dC56ID0gaW5wdXQuejsKICAgIHJldHVybiBvdXRwdXQ7CiAgfQogIHVucHJvamVjdENvb3JkaW5hdGUoaW5wdXQsIG91dHB1dCkgewogICAgaWYgKCFvdXRwdXQpIHsKICAgICAgb3V0cHV0ID0gbmV3IFZlY3RvcjMkMSgpOwogICAgfQogICAgb3V0cHV0LnggPSBpbnB1dC54OwogICAgb3V0cHV0LnkgPSAtaW5wdXQueTsKICAgIG91dHB1dC56ID0gaW5wdXQuejsKICAgIHJldHVybiBvdXRwdXQ7CiAgfQp9CmNvbnN0IF9jYWNoZSA9IHt9Owpjb25zdCBub3JtYWxpemVQcm9qZWN0aW9uTmFtZSA9IChuYW1lKSA9PiB7CiAgbmFtZSA9IG5hbWUudG9VcHBlckNhc2UoKS50cmltKCk7CiAgaWYgKG5hbWUgPT09ICJFUFNHOjkwMDkxMyIpIHsKICAgIHJldHVybiBQUk9KRUNUSU9OX1dFQl9NRVJDQVRPUjsKICB9IGVsc2UgaWYgKG5hbWUgPT09ICJHTE9CRSIgfHwgbmFtZSA9PT0gIkVDRUYiKSB7CiAgICByZXR1cm4gUFJPSkVDVElPTl9FQ0VGOwogIH0KICByZXR1cm4gbmFtZTsKfTsKY29uc3QgZ2V0UHJvamVjdGlvbiA9IChuYW1lKSA9PiB7CiAgbmFtZSA9IG5vcm1hbGl6ZVByb2plY3Rpb25OYW1lKG5hbWUpOwogIGlmICghX2NhY2hlW25hbWVdKSB7CiAgICBzd2l0Y2ggKG5hbWUpIHsKICAgICAgY2FzZSBQUk9KRUNUSU9OX1dFQl9NRVJDQVRPUjoKICAgICAgICBfY2FjaGVbbmFtZV0gPSBuZXcgV2ViTWVyY2F0b3JQcm9qZWN0aW9uKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgUFJPSkVDVElPTl9FQ0VGOgogICAgICAgIF9jYWNoZVtuYW1lXSA9IG5ldyBFQ0VGUHJvamVjdGlvbigpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIFBST0pFQ1RJT05fQkRfTUVSQ0FUT1I6CiAgICAgICAgX2NhY2hlW25hbWVdID0gbmV3IEJhaWR1TWVyY2F0b3JQcm9qZWN0aW9uKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgUFJPSkVDVElPTl9HRU86CiAgICAgICAgX2NhY2hlW25hbWVdID0gbmV3IEdlb1Byb2plY3Rpb24oKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBQUk9KRUNUSU9OX1NDUkVFTl9QSVhFTDoKICAgICAgICBfY2FjaGVbbmFtZV0gPSBuZXcgU2NyZWVuUGl4ZWxQcm9qZWN0aW9uKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbnN1cHBvcnRlZCBwcm9qZWN0aW9uOiAke25hbWV9YCk7CiAgICB9CiAgfQogIHJldHVybiBfY2FjaGVbbmFtZV07Cn07CmNvbnN0IGNyZWF0ZUdyb3VuZFRpbGVNZXNoID0gKHRpbGVDb25maWcsIHJlcGVhdGVkRGF0YSkgPT4gewogIGNvbnN0IHZlcnRpY2VzID0gWwogICAgLTAuNSwKICAgIC0wLjUsCiAgICAwLAogICAgLTAuNSwKICAgIDAuNSwKICAgIDAsCiAgICAwLjUsCiAgICAwLjUsCiAgICAwLAogICAgMC41LAogICAgLTAuNSwKICAgIDAKICBdOwogIGNvbnN0IHV2cyA9IFsKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDEsCiAgICAxLAogICAgMSwKICAgIDEsCiAgICAwCiAgXTsKICBjb25zdCBpbmRpY2VzID0gWzAsIDIsIDEsIDAsIDMsIDJdOwogIGNvbnN0IHsKICAgIHZlcnRpY2VzOiB2ZXJ0aWNlc1N1YmRpdmlkZWQsCiAgICB1dnM6IHV2c1N1YmRpdmlkZWQsCiAgICBpbmRpY2VzOiBpbmRpY2VzU3ViZGl2aWRlZAogIH0gPSBzdWJkaXZpZGVWZXJ0aWNlcyh2ZXJ0aWNlcywgaW5kaWNlcywgdXZzLCB0aWxlQ29uZmlnKTsKICBwcm9qZWN0VmVydGljZXModmVydGljZXNTdWJkaXZpZGVkLCB0aWxlQ29uZmlnKTsKICBjb25zdCByZXN1bHQgPSB7CiAgICB2ZXJ0aWNlczogdmVydGljZXNTdWJkaXZpZGVkLAogICAgdXZzOiB1dnNTdWJkaXZpZGVkLAogICAgaW5kaWNlczogaW5kaWNlc1N1YmRpdmlkZWQKICB9OwogIGlmIChyZXBlYXRlZERhdGEpIHsKICAgIGNvbnN0IHNpemUgPSB2ZXJ0aWNlc1N1YmRpdmlkZWQubGVuZ3RoIC8gMzsKICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKHJlcGVhdGVkRGF0YSkpIHsKICAgICAgY29uc3QgY3VycmVudFZhbHVlID0gcmVwZWF0ZWREYXRhW2tleV07CiAgICAgIGNvbnN0IGlzQXJyYXkgPSBBcnJheS5pc0FycmF5KGN1cnJlbnRWYWx1ZSk7CiAgICAgIGNvbnN0IHN0cmlkZSA9IGlzQXJyYXkgPyBjdXJyZW50VmFsdWUubGVuZ3RoIDogMTsKICAgICAgY29uc3QgbmV3UHJvcGVydHkgPSBbXTsKICAgICAgaWYgKGlzQXJyYXkpIHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNpemU7IGkrKykgewogICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBzdHJpZGU7IGorKykgewogICAgICAgICAgICBuZXdQcm9wZXJ0eS5wdXNoKGN1cnJlbnRWYWx1ZVtqXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7CiAgICAgICAgICBuZXdQcm9wZXJ0eS5wdXNoKGN1cnJlbnRWYWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJlc3VsdFtrZXldID0gbmV3UHJvcGVydHk7CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn07CmNvbnN0IF9wb2ludEluID0gbmV3IFZlY3RvcjMkMSgpOwpjb25zdCBfcG9pbnRPdXQgPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IF92ZWN0b3IgPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IF9ub3JtYWwgPSBuZXcgVmVjdG9yMyQxKCk7CmNvbnN0IF9wcm9qZWN0ZWRTdGFydCA9IFswLCAwLCAwXTsKY29uc3QgX3Byb2plY3RlZEVuZCA9IFswLCAwLCAwXTsKY29uc3QgX2NlbnRlciA9IFswLCAwLCAwXTsKZnVuY3Rpb24gc1JHQlRvTGluZWFyKGMpIHsKICByZXR1cm4gYyA8IDAuMDQwNDUgPyBjICogMC4wNzczOTkzODA4IDogTWF0aC5wb3coYyAqIDAuOTQ3ODY3Mjk4NiArIDAuMDUyMTMyNzAxNCwgMi40KTsKfQpmdW5jdGlvbiBnZXRDb2xvckFycihjb2xvclZhbHVlKSB7CiAgcmV0dXJuIFsKICAgIHNSR0JUb0xpbmVhcigoY29sb3JWYWx1ZSAmIDI1NSkgLyAyNTUpLAogICAgc1JHQlRvTGluZWFyKChjb2xvclZhbHVlID4+IDggJiAyNTUpIC8gMjU1KSwKICAgIHNSR0JUb0xpbmVhcigoY29sb3JWYWx1ZSA+PiAxNiAmIDI1NSkgLyAyNTUpLAogICAgKGNvbG9yVmFsdWUgPj4gMjQgJiAyNTUpIC8gMjU1CiAgXTsKfQpmdW5jdGlvbiBnZXRDb2xvclJnYmEoY29sb3JWYWx1ZSkgewogIHJldHVybiBbCiAgICBzUkdCVG9MaW5lYXIoKGNvbG9yVmFsdWUgJiAyNTUpIC8gMjU1KSAqIDI1NSwKICAgIHNSR0JUb0xpbmVhcigoY29sb3JWYWx1ZSA+PiA4ICYgMjU1KSAvIDI1NSkgKiAyNTUsCiAgICBzUkdCVG9MaW5lYXIoKGNvbG9yVmFsdWUgPj4gMTYgJiAyNTUpIC8gMjU1KSAqIDI1NSwKICAgIChjb2xvclZhbHVlID4+IDI0ICYgMjU1KSAvIDI1NQogIF07Cn0KbGV0IEFUVEFDSF9TQ0FMRSA9IDEuNjc0NTgxMDYxOTc0OTU3Owpjb25zdCBNRVJDQVRPUl9MRU5HVEggPSAyMDAzNzUwODM0Mjc4OTJlLTc7CmNvbnN0IFBPSV9UWVBFID0gMzsKY29uc3QgTElOS19UWVBFID0gNDsKY29uc3QgUE9MWV9UWVBFID0gNzsKY29uc3QgSFJFR0lPTl9UWVBFID0gODsKY29uc3QgR0FPUUlOR19ST0FEX1RZUEUgPSAxNTsKY29uc3QgR0FPUUlOR19MSU5FX1RZUEUgPSAxNjsKY29uc3QgR0FPUUlOR19BUlJPV19UWVBFID0gMTg7CmNvbnN0IFRFWFRVUkVfVFlQRSA9IDE5Owpjb25zdCBHQU9RSU5HX0dSQURJRU5UX1RZUEUgPSAyMDsKY29uc3QgUE9JTlRfU1RZTEUgPSAwOwpjb25zdCBQT0lOVF9URVhUX1NUWUxFID0gMTsKY29uc3QgTElORV9TVFlMRSA9IDM7CmNvbnN0IFBPTFlHT05fU1RZTEUgPSA0Owpjb25zdCBQT0xZR09OM0RfU1RZTEUgPSA1OwpsZXQgUE9JX0lDT05fRElSX0NFTlRFUiA9IDQ7CmNvbnN0IExBTkRfT0ZGU0VUWiA9IC0xZS0zOwpjb25zdCBMQVlFUl9JTkRFWF9ERUxUQSA9IDFlLTQ7CmNvbnN0IERFTFRBID0gMWUtNTsKY29uc3QgRUFSVEhfTUVSQ0FUT1JfTEVOR1RIID0gTUVSQ0FUT1JfTEVOR1RIICogMjsKY29uc3Qgd2ViTWVyY2F0b3JUaWxlU2l6ZU1hcCA9IHt9OwpsZXQgY3VycmVudFRpbGVTaXplID0gRUFSVEhfTUVSQ0FUT1JfTEVOR1RIOwpmb3IgKGxldCBpID0gMDsgaSA8PSAyMTsgaSsrKSB7CiAgd2ViTWVyY2F0b3JUaWxlU2l6ZU1hcFtpXSA9IGN1cnJlbnRUaWxlU2l6ZTsKICBjdXJyZW50VGlsZVNpemUgLz0gMjsKfQpjb25zdCBiZE1lcmNhdG9yVGlsZVNpemVNYXAgPSB7CiAgMzogODM4ODYwOCwKICA1OiA0MTk0MzA0LAogIDc6IDEwNDg1NzYsCiAgOTogMjYyMTQ0LAogIDEwOiA2NTUzNiwKICAxMjogMzI3NjgsCiAgMTU6IDQwOTYsCiAgMTc6IDIwNDgsCiAgMTk6IDUxMgp9Owpjb25zdCBiZFRpbGVNYXhWYWx1ZSA9IHsKICAzOiAyNTYsCiAgNTogNTEyLAogIDc6IDUxMiwKICA5OiA1MTIsCiAgMTA6IDI1NiwKICAxMjogNTEyLAogIDE1OiA1MTIsCiAgMTc6IDEwMjQsCiAgMTk6IDEwMjQKfTsKY29uc3QgYmluYXJ5Q2FjaGUgPSB7CiAgMDogIjAwMDAwMDAwIiwKICAxNjogIjAwMDEwMDAwIiwKICAzMjogIjAwMTAwMDAwIiwKICA0ODogIjAwMTEwMDAwIiwKICA2NDogIjAxMDAwMDAwIiwKICA5NjogIjAxMTAwMDAwIgp9OwpmdW5jdGlvbiBpc1Zpc2libGUodHJhY2VyLCBjb25maWcpIHsKICBsZXQgYmluYXJ5OwogIGlmICghYmluYXJ5Q2FjaGVbdHJhY2VyXSkgewogICAgYmluYXJ5ID0gdHJhY2VyLnRvU3RyaW5nKDIpOwogICAgaWYgKGJpbmFyeS5sZW5ndGggPCA4KSB7CiAgICAgIGJpbmFyeSA9IG5ldyBBcnJheSg4IC0gYmluYXJ5Lmxlbmd0aCArIDEpLmpvaW4oIjAiKSArIGJpbmFyeTsKICAgIH0KICAgIGJpbmFyeUNhY2hlW3RyYWNlcl0gPSBiaW5hcnk7CiAgfQogIGJpbmFyeSA9IGJpbmFyeUNhY2hlW3RyYWNlcl07CiAgY29uc3Qgc3RhcnQgPSBjb25maWcuZmV0Y2hPcHRpb25zLnN0YXJ0WjsKICBsZXQgem9vbSA9IGNvbmZpZy56OwogIGxldCBtYXhab29tID0gMjA7CiAgaWYgKHpvb20gPiBtYXhab29tKSB7CiAgICB6b29tID0gbWF4Wm9vbTsKICB9CiAgcmV0dXJuIGJpbmFyeVt6b29tIC0gc3RhcnRdID09PSAiMSI7Cn0Kc2VsZi5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgKG1lc3NhZ2UpID0+IHsKICBjb25zdCBtZXNzYWdlRGF0YSA9IG1lc3NhZ2UuZGF0YTsKICBjb25zdCB7CiAgICB0aWxlS2V5LAogICAgdHlwZQogIH0gPSBtZXNzYWdlRGF0YTsKICBpZiAodHlwZSA9PT0gInJlcXVlc3RUaWxlIikgewogICAgc2VsZi5oYW5kbGVSZXF1ZXN0VGlsZShtZXNzYWdlRGF0YSk7CiAgfSBlbHNlIGlmICh0eXBlID09PSAiY2hhbmdlU3R5bGUiKSB7CiAgICBzZWxmLmhhbmRsZUNoYW5nZVN0eWxlKG1lc3NhZ2VEYXRhKTsKICB9IGVsc2UgaWYgKHR5cGUgPT09ICJjaGFuZ2VJY29uU2V0SW5mbyIpIHsKICAgIHNlbGYuaGFuZGxlQ2hhbmdlSWNvblNldEluZm8obWVzc2FnZURhdGEpOwogIH0gZWxzZSB7CiAgICBjb25zb2xlLmxvZyhtZXNzYWdlRGF0YSk7CiAgfQp9KTsKc2VsZi5oYW5kbGVSZXF1ZXN0VGlsZSA9IGFzeW5jIChjb25maWcpID0+IHsKICBjb25zdCB7CiAgICB0aWxlS2V5LAogICAgZmV0Y2hPcHRpb25zID0ge30sCiAgICB3b3JrZXJPcHRpb25zLAogICAgdXJsLAogICAgeiwKICAgIHNvdXJjZVByb2plY3Rpb25OYW1lLAogICAgdGFyZ2V0UHJvamVjdGlvbk5hbWUKICB9ID0gY29uZmlnOwogIGNvbmZpZy5zb3VyY2VQcm9qZWN0aW9uID0gZ2V0UHJvamVjdGlvbihzb3VyY2VQcm9qZWN0aW9uTmFtZSk7CiAgY29uZmlnLnRhcmdldFByb2plY3Rpb24gPSBnZXRQcm9qZWN0aW9uKHRhcmdldFByb2plY3Rpb25OYW1lKTsKICBjb25zdCBpc05vcm1hbGl6ZWQgPSB0YXJnZXRQcm9qZWN0aW9uTmFtZSA9PT0gUFJPSkVDVElPTl9XRUJfTUVSQ0FUT1IgJiYgc291cmNlUHJvamVjdGlvbk5hbWUgPT09IFBST0pFQ1RJT05fV0VCX01FUkNBVE9SOwogIGNvbmZpZy5pc05vcm1hbGl6ZWQgPSBpc05vcm1hbGl6ZWQ7CiAgbGV0IG1lcmdlZFJlc3VsdCA9IG51bGw7CiAgbGV0IG1heExheWVySW5kZXggPSAwOwogIGlmICh3b3JrZXJPcHRpb25zKSB7CiAgICBzZWxmLmRpc3BsYXlPcHRpb25zID0gd29ya2VyT3B0aW9ucy5kaXNwbGF5T3B0aW9uczsKICAgIHNlbGYuekluZGV4ID0gd29ya2VyT3B0aW9ucy5oZWlnaHQ7CiAgICBpZiAod29ya2VyT3B0aW9ucy5pc0F0dGFjaCkgewogICAgICBzZWxmLmlzQXR0YWNoID0gISF3b3JrZXJPcHRpb25zLmlzQXR0YWNoOwogICAgICBBVFRBQ0hfU0NBTEUgPSAxOwogICAgfQogIH0KICB0cnkgewogICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgcmVGZXRjaCh1cmwsIHsKICAgICAgcmVzcG9uc2VUeXBlOiAiYXJyYXlidWZmZXIiLAogICAgICAuLi5mZXRjaE9wdGlvbnMKICAgIH0pLnRoZW4oKHJlc3BvbnNlMikgPT4gcmVzcG9uc2UyLmFycmF5QnVmZmVyKCkpOwogICAgY29uc3QgZGF0YSA9IGRlY29kZUJsb2NrVW5pdChyZXNwb25zZSk7CiAgICBjb25zdCByZXN1bHQgPSB7CiAgICAgIGFycm93czogW10sCiAgICAgIHBvbHlnb25zOiBbXSwKICAgICAgcG9seWdvbk9wYWNpdHlzOiBbXSwKICAgICAgbGluZXM6IFtdLAogICAgICBwb2x5Z29uM2RzOiBbXSwKICAgICAgYnVpbGRpbmczZHM6IFtdLAogICAgICBwb2lzOiBbXSwKICAgICAgYmdzOiBbXQogICAgfTsKICAgIGxldCB0aWxlU2l6ZSA9IDYxMS40OTYyMjYyODE0MDg3ICogMTAwOwogICAgbWF4TGF5ZXJJbmRleCA9IHBhcnNlR2VvTGF5ZXJzKGRhdGEsIHJlc3VsdCwgY29uZmlnKTsKICAgIG1lcmdlZFJlc3VsdCA9IG1lcmdlUHJpbWl0aXZlcyhyZXN1bHQpOwogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICBjb25zb2xlLndhcm4oZXJyb3IpOwogICAgbWVyZ2VkUmVzdWx0ID0ge307CiAgfQogIGxldCB0cmFuc2ZlcmFibGVEYXRhID0gW107CiAgaWYgKG1lcmdlZFJlc3VsdC5wb2x5Z29uKSB7CiAgICB0cmFuc2ZlcmFibGVEYXRhLnB1c2gobWVyZ2VkUmVzdWx0LnBvbHlnb24uYXR0cmlidXRlcy5idWZmZXIsIG1lcmdlZFJlc3VsdC5wb2x5Z29uLmluZGljZXMuYnVmZmVyKTsKICB9CiAgaWYgKG1lcmdlZFJlc3VsdC5saW5lKSB7CiAgICB0cmFuc2ZlcmFibGVEYXRhLnB1c2gobWVyZ2VkUmVzdWx0LmxpbmUuYXR0cmlidXRlcy5idWZmZXIsIG1lcmdlZFJlc3VsdC5saW5lLmluZGljZXMuYnVmZmVyKTsKICB9CiAgaWYgKG1lcmdlZFJlc3VsdC5wb2x5Z29uM2QpIHsKICAgIHRyYW5zZmVyYWJsZURhdGEucHVzaChtZXJnZWRSZXN1bHQucG9seWdvbjNkLmF0dHJpYnV0ZXMuYnVmZmVyLCBtZXJnZWRSZXN1bHQucG9seWdvbjNkLmluZGljZXMuYnVmZmVyKTsKICB9CiAgaWYgKG1lcmdlZFJlc3VsdC5idWlsZGluZzNkKSB7CiAgICB0cmFuc2ZlcmFibGVEYXRhLnB1c2gobWVyZ2VkUmVzdWx0LmJ1aWxkaW5nM2QuYXR0cmlidXRlcy5idWZmZXIsIG1lcmdlZFJlc3VsdC5idWlsZGluZzNkLmluZGljZXMuYnVmZmVyKTsKICB9CiAgaWYgKG1lcmdlZFJlc3VsdC5hcnJvdykgewogICAgdHJhbnNmZXJhYmxlRGF0YS5wdXNoKG1lcmdlZFJlc3VsdC5hcnJvdy5hdHRyaWJ1dGVzLmJ1ZmZlciwgbWVyZ2VkUmVzdWx0LmFycm93LmluZGljZXMuYnVmZmVyKTsKICB9CiAgaWYgKG1lcmdlZFJlc3VsdC5kYXNoTGluZSkgewogICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKG1lcmdlZFJlc3VsdC5kYXNoTGluZSk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgbGluZSA9IG1lcmdlZFJlc3VsdC5kYXNoTGluZVtrZXlzW2ldXTsKICAgICAgdHJhbnNmZXJhYmxlRGF0YS5wdXNoKGxpbmUuYXR0cmlidXRlcy5idWZmZXIsIGxpbmUuaW5kaWNlcy5idWZmZXIpOwogICAgfQogIH0KICBpZiAobWVyZ2VkUmVzdWx0LnRleHR1cmVMaW5lKSB7CiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMobWVyZ2VkUmVzdWx0LnRleHR1cmVMaW5lKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBsaW5lID0gbWVyZ2VkUmVzdWx0LnRleHR1cmVMaW5lW2tleXNbaV1dOwogICAgICB0cmFuc2ZlcmFibGVEYXRhLnB1c2gobGluZS5hdHRyaWJ1dGVzLmJ1ZmZlciwgbGluZS5pbmRpY2VzLmJ1ZmZlcik7CiAgICB9CiAgfQogIGlmIChtZXJnZWRSZXN1bHQuZ2FvcWluZ0xpbmUpIHsKICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhtZXJnZWRSZXN1bHQuZ2FvcWluZ0xpbmUpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGxpbmUgPSBtZXJnZWRSZXN1bHQuZ2FvcWluZ0xpbmVba2V5c1tpXV07CiAgICAgIHRyYW5zZmVyYWJsZURhdGEucHVzaChsaW5lLmF0dHJpYnV0ZXMuYnVmZmVyLCBsaW5lLmluZGljZXMuYnVmZmVyKTsKICAgIH0KICB9CiAgbWVyZ2VkUmVzdWx0Lm1heExheWVySW5kZXggPSBtYXhMYXllckluZGV4OwogIHNlbGYucG9zdE1lc3NhZ2UoewogICAgdHlwZTogInJlc3BvbnNlVGlsZSIsCiAgICB0aWxlS2V5LAogICAgY29udGVudDogbWVyZ2VkUmVzdWx0LAogICAgaXNOb3JtYWxpemVkCiAgfSwgdHJhbnNmZXJhYmxlRGF0YSk7Cn07CmZ1bmN0aW9uIGdldFRpbGVNYXhWYWx1ZUJ5Wih6LCBjb25maWcpIHsKICBsZXQgdGlsZVNpemUgPSAxOwogIGlmIChjb25maWcuc291cmNlUHJvamVjdGlvbk5hbWUgPT09IFBST0pFQ1RJT05fQkRfTUVSQ0FUT1IpIHsKICAgIHRpbGVTaXplID0gYmRUaWxlTWF4VmFsdWVbY29uZmlnLmZldGNoT3B0aW9ucy5iYXNlWl0gKiAxMDA7CiAgfSBlbHNlIHsKICAgIHRpbGVTaXplID0gMTAyNCAqIDEwMDsKICAgIGlmIChzZWxmLmlzQXR0YWNoKSB7CiAgICAgIHRpbGVTaXplID0gNjExLjQ5NjIyNjI4MTQwODcgKiAxMDA7CiAgICB9CiAgfQogIHJldHVybiB0aWxlU2l6ZTsKfQpmdW5jdGlvbiBnZXRUaWxlU2l6ZUJ5Wih6LCBjb25maWcpIHsKICBjb25zdCBiYXNlWiA9IGNvbmZpZy5mZXRjaE9wdGlvbnMuYmFzZVo7CiAgaWYgKGNvbmZpZy5zb3VyY2VQcm9qZWN0aW9uTmFtZSA9PT0gUFJPSkVDVElPTl9CRF9NRVJDQVRPUikgewogICAgcmV0dXJuIGJkTWVyY2F0b3JUaWxlU2l6ZU1hcFtiYXNlWl07CiAgfQogIHJldHVybiB3ZWJNZXJjYXRvclRpbGVTaXplTWFwW2Jhc2VaXTsKfQpmdW5jdGlvbiBub3JtYWxpemVWZXJ0ZXgodmVydGV4LCB0aWxlU2l6ZSwgZ2FwTWluLCBnYXBNYXgsIGkgPSAwLCBvdXRwdXQpIHsKICBpZiAoIW91dHB1dCkgewogICAgb3V0cHV0ID0gdmVydGV4OwogIH0KICBvdXRwdXRbaV0gPSB2ZXJ0ZXhbaV0gLyAodGlsZVNpemUgLyAxMDApIC0gMC41OwogIG91dHB1dFtpICsgMV0gPSB2ZXJ0ZXhbaSArIDFdIC8gKHRpbGVTaXplIC8gMTAwKSAtIDAuNTsKICBvdXRwdXRbaSArIDJdID0gdmVydGV4W2kgKyAyXTsKICBpZiAoc2VsZi5pc0F0dGFjaCkgewogICAgaWYgKG91dHB1dFtpXSA8IGdhcE1pbikgewogICAgICBvdXRwdXRbaV0gPSAtMC41OwogICAgfQogICAgaWYgKG91dHB1dFtpXSA+IGdhcE1heCkgewogICAgICBvdXRwdXRbaV0gPSAwLjU7CiAgICB9CiAgICBpZiAob3V0cHV0W2kgKyAxXSA8IGdhcE1pbikgewogICAgICBvdXRwdXRbaSArIDFdID0gLTAuNTsKICAgIH0KICAgIGlmIChvdXRwdXRbaSArIDFdID4gZ2FwTWF4KSB7CiAgICAgIG91dHB1dFtpICsgMV0gPSAwLjU7CiAgICB9CiAgfQogIHJldHVybiBvdXRwdXQ7Cn0KZnVuY3Rpb24gbWVyZ2VQcmltaXRpdmVzKHJlc3VsdCkgewogIGNvbnN0IG1lcmdlZFJlc3VsdCA9IHt9OwogIGlmIChyZXN1bHQucG9seWdvbnMgJiYgcmVzdWx0LnBvbHlnb25zLmxlbmd0aCA+IDApIHsKICAgIG1lcmdlZFJlc3VsdC5wb2x5Z29uID0gbWVyZ2VQb2x5Z29ucyhyZXN1bHQucG9seWdvbnMpOwogIH0KICBpZiAocmVzdWx0LnBvbHlnb25PcGFjaXR5cyAmJiByZXN1bHQucG9seWdvbk9wYWNpdHlzLmxlbmd0aCA+IDApIHsKICAgIG1lcmdlZFJlc3VsdC5wb2x5Z29uT3BhY2l0eSA9IG1lcmdlUG9seWdvbnMocmVzdWx0LnBvbHlnb25PcGFjaXR5cywgeyBpc0NvbG9yNDogdHJ1ZSB9KTsKICB9CiAgaWYgKHJlc3VsdC5iZ3MgJiYgcmVzdWx0LmJncy5sZW5ndGggPiAwKSB7CiAgICBtZXJnZWRSZXN1bHQuYmcgPSBtZXJnZVBvbHlnb25zKHJlc3VsdC5iZ3MpOwogIH0KICBpZiAocmVzdWx0LmxpbmVzICYmIHJlc3VsdC5saW5lcy5sZW5ndGggPiAwKSB7CiAgICBsZXQgZGFzaExpbmUgPSB7fTsKICAgIGxldCB0ZXh0dXJlTGluZSA9IHt9OwogICAgbGV0IGdhb3FpbmdMaW5lID0ge307CiAgICBsZXQgc29pbGRMaW5lID0gW107CiAgICBsZXQgaGFzRGFzaExpbmUgPSBmYWxzZTsKICAgIGxldCBoYXNUZXh0dXJlTGluZSA9IGZhbHNlOwogICAgbGV0IGhhc0dhb1FpbmdMaW5lID0gZmFsc2U7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdC5saW5lcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBsaW5lID0gcmVzdWx0LmxpbmVzW2ldOwogICAgICBjb25zdCBmaWxsVGV4dHVyZVN0eWxlID0gbGluZS5maWxsVGV4dHVyZVN0eWxlOwogICAgICBpZiAoZmlsbFRleHR1cmVTdHlsZSkgewogICAgICAgIGNvbnN0IGZpbGxUZXh0dXJlID0gZmlsbFRleHR1cmVTdHlsZS5maWxsVGV4dHVyZTsKICAgICAgICBjb25zdCBpc1NpbmdsZSA9IGZpbGxUZXh0dXJlU3R5bGUuaXNTaW5nbGU7CiAgICAgICAgY29uc3QgaXNHYW9RaW5nID0gbGluZS5pc0dhb1Fpbmc7CiAgICAgICAgaWYgKGlzR2FvUWluZykgewogICAgICAgICAgaGFzR2FvUWluZ0xpbmUgPSB0cnVlOwogICAgICAgICAgaWYgKCFnYW9xaW5nTGluZVtmaWxsVGV4dHVyZV0pIHsKICAgICAgICAgICAgZ2FvcWluZ0xpbmVbZmlsbFRleHR1cmVdID0gW107CiAgICAgICAgICB9CiAgICAgICAgICBnYW9xaW5nTGluZVtmaWxsVGV4dHVyZV0ucHVzaChsaW5lKTsKICAgICAgICB9IGVsc2UgaWYgKGlzU2luZ2xlKSB7CiAgICAgICAgICBoYXNUZXh0dXJlTGluZSA9IHRydWU7CiAgICAgICAgICBpZiAoIXRleHR1cmVMaW5lW2ZpbGxUZXh0dXJlXSkgewogICAgICAgICAgICB0ZXh0dXJlTGluZVtmaWxsVGV4dHVyZV0gPSBbXTsKICAgICAgICAgIH0KICAgICAgICAgIHRleHR1cmVMaW5lW2ZpbGxUZXh0dXJlXS5wdXNoKGxpbmUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBoYXNEYXNoTGluZSA9IHRydWU7CiAgICAgICAgICBpZiAoIWRhc2hMaW5lW2ZpbGxUZXh0dXJlXSkgewogICAgICAgICAgICBkYXNoTGluZVtmaWxsVGV4dHVyZV0gPSBbXTsKICAgICAgICAgIH0KICAgICAgICAgIGRhc2hMaW5lW2ZpbGxUZXh0dXJlXS5wdXNoKGxpbmUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzb2lsZExpbmUucHVzaChsaW5lKTsKICAgICAgfQogICAgfQogICAgbWVyZ2VkUmVzdWx0LmxpbmUgPSBtZXJnZVBvbHlnb25zKHNvaWxkTGluZSwgeyBpc0xpbmU6IHRydWUsIGlzQ29sb3I0OiB0cnVlIH0pOwogICAgaGFzRGFzaExpbmUgJiYgKG1lcmdlZFJlc3VsdC5kYXNoTGluZSA9IHt9KTsKICAgIGZvciAobGV0IGtleSBpbiBkYXNoTGluZSkgewogICAgICBpZiAoZGFzaExpbmUuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgIG1lcmdlZFJlc3VsdC5kYXNoTGluZVtrZXldID0gbWVyZ2VQb2x5Z29ucyhkYXNoTGluZVtrZXldLCB7CiAgICAgICAgICBpc0xpbmU6IHRydWUsCiAgICAgICAgICBpc0NvbG9yNDogdHJ1ZSwKICAgICAgICAgIGlzRGFzaExpbmU6IHRydWUKICAgICAgICB9KTsKICAgICAgfQogICAgfQogICAgaGFzVGV4dHVyZUxpbmUgJiYgKG1lcmdlZFJlc3VsdC50ZXh0dXJlTGluZSA9IHt9KTsKICAgIGZvciAobGV0IGtleSBpbiB0ZXh0dXJlTGluZSkgewogICAgICBpZiAodGV4dHVyZUxpbmUuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgIG1lcmdlZFJlc3VsdC50ZXh0dXJlTGluZVtrZXldID0gbWVyZ2VQb2x5Z29ucyh0ZXh0dXJlTGluZVtrZXldLCB7CiAgICAgICAgICBpc0xpbmU6IHRydWUsCiAgICAgICAgICBpc0NvbG9yNDogdHJ1ZSwKICAgICAgICAgIGlzRGFzaExpbmU6IHRydWUsCiAgICAgICAgICBpc1RleHR1cmVMaW5lOiB0cnVlCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIGhhc0dhb1FpbmdMaW5lICYmIChtZXJnZWRSZXN1bHQuZ2FvcWluZ0xpbmUgPSB7fSk7CiAgICBmb3IgKGxldCBrZXkgaW4gZ2FvcWluZ0xpbmUpIHsKICAgICAgaWYgKGdhb3FpbmdMaW5lLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICBtZXJnZWRSZXN1bHQuZ2FvcWluZ0xpbmVba2V5XSA9IG1lcmdlUG9seWdvbnMoZ2FvcWluZ0xpbmVba2V5XSwgewogICAgICAgICAgaXNMaW5lOiB0cnVlLAogICAgICAgICAgaXNDb2xvcjQ6IHRydWUsCiAgICAgICAgICBpc0Rhc2hMaW5lOiB0cnVlCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9CiAgaWYgKHJlc3VsdC5wb2x5Z29uM2RzICYmIHJlc3VsdC5wb2x5Z29uM2RzLmxlbmd0aCA+IDApIHsKICAgIG1lcmdlZFJlc3VsdC5wb2x5Z29uM2QgPSBtZXJnZVBvbHlnb25zKHJlc3VsdC5wb2x5Z29uM2RzKTsKICB9CiAgaWYgKHJlc3VsdC5idWlsZGluZzNkcyAmJiByZXN1bHQuYnVpbGRpbmczZHMubGVuZ3RoID4gMCkgewogICAgbWVyZ2VkUmVzdWx0LmJ1aWxkaW5nM2QgPSBtZXJnZVBvbHlnb25zKHJlc3VsdC5idWlsZGluZzNkcywgeyBpc0J1aWxkaW5nOiB0cnVlIH0pOwogIH0KICBpZiAocmVzdWx0LmFycm93cyAmJiByZXN1bHQuYXJyb3dzLmxlbmd0aCA+IDApIHsKICAgIG1lcmdlZFJlc3VsdC5hcnJvdyA9IG1lcmdlUG9seWdvbnMocmVzdWx0LmFycm93cywgeyBpc0Fycm93OiB0cnVlIH0pOwogIH0KICBpZiAocmVzdWx0LnBvaXMgJiYgcmVzdWx0LnBvaXMubGVuZ3RoID4gMCkgewogICAgbWVyZ2VkUmVzdWx0LnBvaSA9IHJlc3VsdC5wb2lzOwogIH0KICByZXR1cm4gbWVyZ2VkUmVzdWx0Owp9CmZ1bmN0aW9uIG1lcmdlUG9seWdvbnMocHJpbWl0aXZlcywgb3B0aW9ucyA9IHt9KSB7CiAgcHJpbWl0aXZlcy5zb3J0KChhLCBiKSA9PiBhLnJhbmsgLSBiLnJhbmspOwogIGNvbnN0IGF0dHJpYnV0ZXMgPSBbXTsKICBjb25zdCBpbmRpY2VzID0gW107CiAgbGV0IHByaW1pdGl2ZSA9IG51bGw7CiAgbGV0IGN1cnJlbnRWZXJ0aWNlcyA9IG51bGw7CiAgbGV0IGN1cnJlbnROb3JtYWxzID0gbnVsbDsKICBsZXQgY3VycmVudEZsYXROb3JtYWxzID0gbnVsbDsKICBsZXQgY3VycmVudFV2cyA9IG51bGw7CiAgbGV0IGN1cnJlbnREaWZmcyA9IG51bGw7CiAgbGV0IGN1cnJlbnRJbmRpY2VzID0gbnVsbDsKICBsZXQgY3VycmVudENvbG9ycyA9IG51bGw7CiAgbGV0IGN1cnJlbnRMYXllckluZGV4ID0gbnVsbDsKICBsZXQgY3VycmVudFdpZHRocyA9IG51bGw7CiAgbGV0IGN1cnJlbnRIZWlnaHRBbmRDb25jYXZlcyA9IG51bGw7CiAgbGV0IGN1cnJlbnRUb3RhbExlbmd0aHMgPSBudWxsOwogIGxldCB0ZW1wSW5kZXggPSAwOwogIGxldCBpbmRleFN0YXJ0ID0gMDsKICBmb3IgKGxldCBpID0gMDsgaSA8IHByaW1pdGl2ZXMubGVuZ3RoOyBpKyspIHsKICAgIHByaW1pdGl2ZSA9IHByaW1pdGl2ZXNbaV07CiAgICBjdXJyZW50VmVydGljZXMgPSBwcmltaXRpdmUudmVydGljZXM7CiAgICBjdXJyZW50Tm9ybWFscyA9IHByaW1pdGl2ZS5ub3JtYWxzOwogICAgY3VycmVudEZsYXROb3JtYWxzID0gcHJpbWl0aXZlLmZsYXROb3JtYWxzOwogICAgY3VycmVudFV2cyA9IHByaW1pdGl2ZS51dnM7CiAgICBjdXJyZW50RGlmZnMgPSBwcmltaXRpdmUuZGlmZnM7CiAgICBjdXJyZW50SW5kaWNlcyA9IHByaW1pdGl2ZS5pbmRpY2VzOwogICAgY3VycmVudENvbG9ycyA9IHByaW1pdGl2ZS5jb2xvcnM7CiAgICBjdXJyZW50TGF5ZXJJbmRleCA9IHByaW1pdGl2ZS5sYXllckluZGljZXM7CiAgICBjdXJyZW50V2lkdGhzID0gcHJpbWl0aXZlLndpZHRoczsKICAgIGN1cnJlbnRUb3RhbExlbmd0aHMgPSBwcmltaXRpdmUudG90YWxMZW5ndGhzOwogICAgY3VycmVudEhlaWdodEFuZENvbmNhdmVzID0gcHJpbWl0aXZlLmhlaWdodEFuZENvbmNhdmVzOwogICAgaWYgKCFjdXJyZW50SW5kaWNlcyB8fCAhY3VycmVudEluZGljZXMubGVuZ3RoKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQogICAgZm9yIChsZXQgaiA9IDAsIGxhc3QgPSBjdXJyZW50VmVydGljZXMubGVuZ3RoIC0gMjsgaiA8IGxhc3Q7IGogKz0gMykgewogICAgICBhdHRyaWJ1dGVzLnB1c2goY3VycmVudFZlcnRpY2VzW2pdLCBjdXJyZW50VmVydGljZXNbaiArIDFdLCBjdXJyZW50VmVydGljZXNbaiArIDJdKTsKICAgICAgaWYgKG9wdGlvbnMuaXNBcnJvdykgewogICAgICAgIHRlbXBJbmRleCA9IGogLyAzICogMjsKICAgICAgICBhdHRyaWJ1dGVzLnB1c2goY3VycmVudEZsYXROb3JtYWxzW2pdLCBjdXJyZW50RmxhdE5vcm1hbHNbaiArIDFdLCBjdXJyZW50RmxhdE5vcm1hbHNbaiArIDJdKTsKICAgICAgICBhdHRyaWJ1dGVzLnB1c2goY3VycmVudFV2c1t0ZW1wSW5kZXhdLCBjdXJyZW50VXZzW3RlbXBJbmRleCArIDFdKTsKICAgICAgICBhdHRyaWJ1dGVzLnB1c2goY3VycmVudERpZmZzW2pdLCBjdXJyZW50RGlmZnNbaiArIDFdLCBjdXJyZW50RGlmZnNbaiArIDJdKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBhdHRyaWJ1dGVzLnB1c2goY3VycmVudE5vcm1hbHNbal0sIGN1cnJlbnROb3JtYWxzW2ogKyAxXSwgY3VycmVudE5vcm1hbHNbaiArIDJdKTsKICAgICAgICBpZiAob3B0aW9ucy5pc0NvbG9yNCkgewogICAgICAgICAgdGVtcEluZGV4ID0gaiAvIDMgKiA0OwogICAgICAgICAgYXR0cmlidXRlcy5wdXNoKAogICAgICAgICAgICBjdXJyZW50Q29sb3JzW3RlbXBJbmRleF0sCiAgICAgICAgICAgIGN1cnJlbnRDb2xvcnNbdGVtcEluZGV4ICsgMV0sCiAgICAgICAgICAgIGN1cnJlbnRDb2xvcnNbdGVtcEluZGV4ICsgMl0sCiAgICAgICAgICAgIGN1cnJlbnRDb2xvcnNbdGVtcEluZGV4ICsgM10KICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGF0dHJpYnV0ZXMucHVzaChjdXJyZW50Q29sb3JzW2pdLCBjdXJyZW50Q29sb3JzW2ogKyAxXSwgY3VycmVudENvbG9yc1tqICsgMl0pOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAob3B0aW9ucy5pc0J1aWxkaW5nKSB7CiAgICAgICAgdGVtcEluZGV4ID0gaiAvIDMgKiAyOwogICAgICAgIGF0dHJpYnV0ZXMucHVzaChjdXJyZW50SGVpZ2h0QW5kQ29uY2F2ZXNbdGVtcEluZGV4XSwgY3VycmVudEhlaWdodEFuZENvbmNhdmVzW3RlbXBJbmRleCArIDFdKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBhdHRyaWJ1dGVzLnB1c2goY3VycmVudExheWVySW5kZXhbaiAvIDNdKTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy5pc0xpbmUpIHsKICAgICAgICB0ZW1wSW5kZXggPSBqIC8gMyAqIDI7CiAgICAgICAgYXR0cmlidXRlcy5wdXNoKGN1cnJlbnRXaWR0aHNbaiAvIDNdKTsKICAgICAgICBpZiAob3B0aW9ucy5pc0Rhc2hMaW5lKSB7CiAgICAgICAgICBhdHRyaWJ1dGVzLnB1c2goY3VycmVudFV2c1t0ZW1wSW5kZXhdLCBjdXJyZW50VXZzW3RlbXBJbmRleCArIDFdKTsKICAgICAgICB9CiAgICAgICAgaWYgKG9wdGlvbnMuaXNUZXh0dXJlTGluZSkgewogICAgICAgICAgYXR0cmlidXRlcy5wdXNoKGN1cnJlbnRUb3RhbExlbmd0aHNbaiAvIDNdKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZvciAobGV0IGogPSAwLCBsYXN0ID0gY3VycmVudEluZGljZXMubGVuZ3RoOyBqIDwgbGFzdDsgaisrKSB7CiAgICAgIGluZGljZXMucHVzaChjdXJyZW50SW5kaWNlc1tqXSArIGluZGV4U3RhcnQpOwogICAgfQogICAgaW5kZXhTdGFydCArPSBjdXJyZW50VmVydGljZXMubGVuZ3RoIC8gMzsKICB9CiAgcmV0dXJuIHsKICAgIGF0dHJpYnV0ZXM6IG5ldyBGbG9hdDMyQXJyYXkoYXR0cmlidXRlcyksCiAgICBpbmRpY2VzOiBuZXcgVWludDMyQXJyYXkoaW5kaWNlcykKICB9Owp9CmxldCBsYXllckluZGV4ID0gMDsKZnVuY3Rpb24gcGFyc2VHZW9MYXllcnMoZGF0YSwgcmVzdWx0LCBjb25maWcpIHsKICBjb25zdCBkaXNwbGF5T3B0aW9ucyA9IHNlbGYuZGlzcGxheU9wdGlvbnM7CiAgY29uc3QgaGlkZUJhc2UgPSBkaXNwbGF5T3B0aW9ucyAmJiBkaXNwbGF5T3B0aW9ucy5iYXNlID09PSBmYWxzZTsKICBjb25zdCBoaWRlTGluayA9IGRpc3BsYXlPcHRpb25zICYmIGRpc3BsYXlPcHRpb25zLmxpbmsgPT09IGZhbHNlOwogIGNvbnN0IGhpZGVCdWlsZGluZyA9IGRpc3BsYXlPcHRpb25zICYmIGRpc3BsYXlPcHRpb25zLmJ1aWxkaW5nID09PSBmYWxzZTsKICBjb25zdCBoaWRlUG9pID0gZGlzcGxheU9wdGlvbnMgJiYgZGlzcGxheU9wdGlvbnMucG9pID09PSBmYWxzZTsKICBjb25zdCBpc0ZsYXQgPSBkaXNwbGF5T3B0aW9ucyAmJiBkaXNwbGF5T3B0aW9ucy5mbGF0ID09PSB0cnVlOwogIGNvbnN0IGdlb0xheWVycyA9IGRhdGEuZ2VvbGF5ZXI7CiAgY29uc3QgcG9seWdvbnMgPSByZXN1bHQucG9seWdvbnM7CiAgY29uc3QgcG9seWdvbk9wYWNpdHlzID0gcmVzdWx0LnBvbHlnb25PcGFjaXR5czsKICBjb25zdCBwb2x5Z29uM2RzID0gcmVzdWx0LnBvbHlnb24zZHM7CiAgY29uc3QgbGluZXMgPSByZXN1bHQubGluZXM7CiAgY29uc3QgYnVpbGRpbmczZHMgPSByZXN1bHQuYnVpbGRpbmczZHM7CiAgY29uc3QgcG9pcyA9IHJlc3VsdC5wb2lzOwogIGNvbnN0IGFycm93cyA9IHJlc3VsdC5hcnJvd3M7CiAgY29uc3QgdXNlWm9vbSA9IE1hdGguZmxvb3IoY29uZmlnLnVzZVpvb20pIHx8IGNvbmZpZy56OwogIGxldCByYW5rID0gMDsKICBsZXQgY2F0YWxvZ1R5cGUgPSAwOwogIGxldCBwb2x5Z29uID0gbnVsbDsKICBsZXQgcG9seWdvbjNkID0gbnVsbDsKICBsZXQgbGluZSA9IG51bGw7CiAgbGV0IGJ1aWxkaW5nM2QgPSBudWxsOwogIGxldCBwb2kgPSBudWxsOwogIGxheWVySW5kZXggPSBMQVlFUl9JTkRFWF9ERUxUQSAqIDIwOwogIGNvbnN0IGJnU3R5bGUgPSBjb25maWcueiA8IDkgPyBnZXRTdHlsZUNvbmZpZyhjYXRhbG9nVHlwZSwgMTUyMiwgdXNlWm9vbSwgUE9MWUdPTl9TVFlMRSwgY29uZmlnKSA6IGdldFN0eWxlQ29uZmlnKGNhdGFsb2dUeXBlLCA3MiwgdXNlWm9vbSwgUE9MWUdPTl9TVFlMRSwgY29uZmlnKTsKICBpZiAoIWhpZGVCYXNlICYmIGJnU3R5bGUpIHsKICAgIHBvbHlnb25zLnB1c2goY3JlYXRlQmdQb2x5Z29uKGJnU3R5bGUsIGNvbmZpZykpOwogIH0KICBsYXllckluZGV4ICs9IExBWUVSX0lOREVYX0RFTFRBICogMTsKICBmb3IgKGNvbnN0IGdlb0xheWVyIG9mIGdlb0xheWVycykgewogICAgY2F0YWxvZ1R5cGUgPSBnZW9MYXllci5jYXRhbG9nVHlwZTsKICAgIHJhbmsgPSBnZW9MYXllci5yYW5rOwogICAgY29uc3QgYXJyb3dwID0gZ2VvTGF5ZXIuYXJyb3dwOwogICAgaWYgKGNhdGFsb2dUeXBlID09PSBHQU9RSU5HX0FSUk9XX1RZUEUgJiYgYXJyb3dwKSB7CiAgICAgIGNvbnN0IGFycm93ID0gY3JlYXRlQXJyb3coZ2VvTGF5ZXIsIHVzZVpvb20sIGNvbmZpZyk7CiAgICAgIGlmIChhcnJvdykgewogICAgICAgIGFycm93LnJhbmsgPSByYW5rOwogICAgICAgIGFycm93cy5wdXNoKGFycm93KTsKICAgICAgICBsYXllckluZGV4ICs9IExBWUVSX0lOREVYX0RFTFRBOwogICAgICB9CiAgICAgIGNvbnRpbnVlOwogICAgfQogICAgY29uc3QgZ2VvT2JqZWN0U2V0cyA9IGdlb0xheWVyLmdlb29iamVjdHNldFNldDsKICAgIGlmICghQXJyYXkuaXNBcnJheShnZW9PYmplY3RTZXRzKSkgewogICAgICBjb250aW51ZTsKICAgIH0KICAgIGxldCBkZWxheU9iamVjdHMgPSBbXTsKICAgIGZvciAoY29uc3QgZ2VvT2JqZWN0U2V0IG9mIGdlb09iamVjdFNldHMpIHsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGdlb09iamVjdFNldC5nZW9PYmplY3RTZXQpKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKGdlb09iamVjdFNldC5zdHlsZUlkID09PSAxNTIyICYmIGNvbmZpZy56IDwgOSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGxldCBzdHlsZUNvbmZpZyA9IG51bGw7CiAgICAgIGlmICghaGlkZUJhc2UgJiYgKGNhdGFsb2dUeXBlID09PSBQT0xZX1RZUEUgfHwgY2F0YWxvZ1R5cGUgPT09IEdBT1FJTkdfUk9BRF9UWVBFKSkgewogICAgICAgIHN0eWxlQ29uZmlnID0gZ2V0U3R5bGVDb25maWcoY2F0YWxvZ1R5cGUsIGdlb09iamVjdFNldC5zdHlsZUlkLCB1c2Vab29tLCBQT0xZR09OX1NUWUxFLCBjb25maWcpOwogICAgICB9IGVsc2UgaWYgKCFoaWRlTGluayAmJiBjYXRhbG9nVHlwZSA9PT0gR0FPUUlOR19HUkFESUVOVF9UWVBFKSB7CiAgICAgICAgY29uc3Qgb2JqZWN0U2V0ID0gZ2VvT2JqZWN0U2V0Lmdlb09iamVjdFNldDsKICAgICAgICBjb25zdCBncmFkaWVudFJvYWRPYmplY3QgPSBvYmplY3RTZXQgJiYgb2JqZWN0U2V0WzBdOwogICAgICAgIGNvbnN0IGdyYWRpZW50U3R5bGVJZCA9IGdyYWRpZW50Um9hZE9iamVjdC5ncmFkaWVudFN0eWxlSWQ7CiAgICAgICAgY29uc3Qgc3RhcnRQdFN0eWxlID0gZ2V0U3R5bGVDb25maWcoCiAgICAgICAgICBjYXRhbG9nVHlwZSwKICAgICAgICAgIGdyYWRpZW50U3R5bGVJZFswXSwKICAgICAgICAgIHVzZVpvb20sCiAgICAgICAgICBQT0xZR09OX1NUWUxFLAogICAgICAgICAgY29uZmlnCiAgICAgICAgKTsKICAgICAgICBjb25zdCBlbmRQdFN0eWxlID0gZ2V0U3R5bGVDb25maWcoY2F0YWxvZ1R5cGUsIGdyYWRpZW50U3R5bGVJZFsxXSwgdXNlWm9vbSwgUE9MWUdPTl9TVFlMRSwgY29uZmlnKTsKICAgICAgICBpZiAoc3RhcnRQdFN0eWxlICYmIGVuZFB0U3R5bGUpIHsKICAgICAgICAgIHN0eWxlQ29uZmlnID0gewogICAgICAgICAgICBzdGFydFB0U3R5bGUsCiAgICAgICAgICAgIGVuZFB0U3R5bGUKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKCFoaWRlTGluayAmJiBjYXRhbG9nVHlwZSA9PT0gVEVYVFVSRV9UWVBFKSB7CiAgICAgICAgc3R5bGVDb25maWcgPSBnZXRTdHlsZUNvbmZpZyhjYXRhbG9nVHlwZSwgZ2VvT2JqZWN0U2V0LnN0eWxlSWQsIHVzZVpvb20sIExJTkVfU1RZTEUsIGNvbmZpZyk7CiAgICAgIH0gZWxzZSBpZiAoIWhpZGVMaW5rICYmIGNhdGFsb2dUeXBlID09PSBMSU5LX1RZUEUpIHsKICAgICAgICBzdHlsZUNvbmZpZyA9IGdldFN0eWxlQ29uZmlnKGNhdGFsb2dUeXBlLCBnZW9PYmplY3RTZXQuc3R5bGVJZCwgdXNlWm9vbSwgTElORV9TVFlMRSwgY29uZmlnKTsKICAgICAgfSBlbHNlIGlmIChjYXRhbG9nVHlwZSA9PT0gR0FPUUlOR19MSU5FX1RZUEUpIHsKICAgICAgICBzdHlsZUNvbmZpZyA9IGdldFN0eWxlQ29uZmlnKGNhdGFsb2dUeXBlLCBnZW9PYmplY3RTZXQuc3R5bGVJZCwgdXNlWm9vbSwgTElORV9TVFlMRSwgY29uZmlnKTsKICAgICAgfSBlbHNlIGlmICghaGlkZUJ1aWxkaW5nICYmIGNhdGFsb2dUeXBlID09PSBIUkVHSU9OX1RZUEUpIHsKICAgICAgICBzdHlsZUNvbmZpZyA9IGdldFN0eWxlQ29uZmlnKGNhdGFsb2dUeXBlLCBnZW9PYmplY3RTZXQuc3R5bGVJZCwgdXNlWm9vbSwgUE9MWUdPTjNEX1NUWUxFLCBjb25maWcpOwogICAgICB9IGVsc2UgaWYgKCFoaWRlUG9pICYmIGNhdGFsb2dUeXBlID09PSBQT0lfVFlQRSkgewogICAgICAgIGNvbnN0IHN0eWxlUHQgPSBnZXRTdHlsZUNvbmZpZyhjYXRhbG9nVHlwZSwgZ2VvT2JqZWN0U2V0LnN0eWxlSWQsIHVzZVpvb20sIFBPSU5UX1NUWUxFLCBjb25maWcpOwogICAgICAgIGNvbnN0IHN0eWxlVGV4dCA9IGdldFN0eWxlQ29uZmlnKAogICAgICAgICAgY2F0YWxvZ1R5cGUsCiAgICAgICAgICBnZW9PYmplY3RTZXQuc3R5bGVJZCwKICAgICAgICAgIHVzZVpvb20sCiAgICAgICAgICBQT0lOVF9URVhUX1NUWUxFLAogICAgICAgICAgY29uZmlnCiAgICAgICAgKTsKICAgICAgICBpZiAoISgoIXN0eWxlVGV4dCB8fCBzdHlsZVRleHQubGVuZ3RoID09PSAwKSAmJiAoIXN0eWxlUHQgfHwgc3R5bGVQdC5sZW5ndGggPiAwKSkpIHsKICAgICAgICAgIHN0eWxlQ29uZmlnID0gewogICAgICAgICAgICBzdHlsZVB0LAogICAgICAgICAgICBzdHlsZVRleHQKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICghc3R5bGVDb25maWcpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBmb3IgKGNvbnN0IGdlb09iamVjdCBvZiBnZW9PYmplY3RTZXQuZ2VvT2JqZWN0U2V0KSB7CiAgICAgICAgaWYgKGNhdGFsb2dUeXBlICE9PSBQT0lfVFlQRSAmJiAhKGdlb09iamVjdC5taWRQb2ludHMgJiYgZ2VvT2JqZWN0Lm1pZFBvaW50cy5sZW5ndGggJiYgZ2VvT2JqZWN0Lm1pZFBvaW50cy5sZW5ndGggPCA4ZTMpKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKCFpc1Zpc2libGUoZ2VvT2JqZWN0LnRyYWNlciwgY29uZmlnKSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGlmICghaGlkZUJhc2UgJiYgY2F0YWxvZ1R5cGUgPT09IFBPTFlfVFlQRSkgewogICAgICAgICAgY29uc3QgaXNUcmFuc3BhcmVudCA9IHN0eWxlQ29uZmlnLmNvbG9yWzNdIDwgMTsKICAgICAgICAgIHBvbHlnb24gPSBjcmVhdGVQb2x5Z29uKGdlb09iamVjdCwgc3R5bGVDb25maWcuY29sb3IsIHsKICAgICAgICAgICAgaXNUcmFuc3BhcmVudAogICAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICAgIGlmIChwb2x5Z29uKSB7CiAgICAgICAgICAgIHBvbHlnb24ucmFuayA9IHJhbms7CiAgICAgICAgICAgIGlmIChpc1RyYW5zcGFyZW50KSB7CiAgICAgICAgICAgICAgcG9seWdvbk9wYWNpdHlzLnB1c2gocG9seWdvbik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcG9seWdvbnMucHVzaChwb2x5Z29uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYXllckluZGV4ICs9IExBWUVSX0lOREVYX0RFTFRBOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoY2F0YWxvZ1R5cGUgPT09IFRFWFRVUkVfVFlQRSkgewogICAgICAgICAgbGluZSA9IGNyZWF0ZUxpbmUoZ2VvT2JqZWN0LCBzdHlsZUNvbmZpZy5maWxsQ29sb3IsIHN0eWxlQ29uZmlnLmZpbGxXaWR0aCwgewogICAgICAgICAgICBmaWxsVGV4dHVyZTogc3R5bGVDb25maWcuZmlsbFRleHR1cmUsCiAgICAgICAgICAgIGlzU2luZ2xlOiB0cnVlCiAgICAgICAgICB9LCBjb25maWcpOwogICAgICAgICAgaWYgKGxpbmUpIHsKICAgICAgICAgICAgbGluZS5yYW5rID0gcmFuazsKICAgICAgICAgICAgbGluZXMucHVzaChsaW5lKTsKICAgICAgICAgICAgbGF5ZXJJbmRleCArPSBMQVlFUl9JTkRFWF9ERUxUQTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCFoaWRlTGluayAmJiBjYXRhbG9nVHlwZSA9PT0gTElOS19UWVBFKSB7CiAgICAgICAgICBpZiAoc3R5bGVDb25maWcuaGF2ZUJvcmRlckxpbmUgJiYgc3R5bGVDb25maWcuYm9yZGVyQ29sb3JbM10gPiAwICYmICFzdHlsZUNvbmZpZy5maWxsVGV4dHVyZSkgewogICAgICAgICAgICBsaW5lID0gY3JlYXRlTGluZSgKICAgICAgICAgICAgICBnZW9PYmplY3QsCiAgICAgICAgICAgICAgc3R5bGVDb25maWcuYm9yZGVyQ29sb3IsCiAgICAgICAgICAgICAgc3R5bGVDb25maWcuYm9yZGVyV2lkdGggLyAyLAogICAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgICBjb25maWcKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKGxpbmUpIHsKICAgICAgICAgICAgICBsaW5lLnJhbmsgPSByYW5rOwogICAgICAgICAgICAgIGxpbmVzLnB1c2gobGluZSk7CiAgICAgICAgICAgICAgbGF5ZXJJbmRleCArPSBMQVlFUl9JTkRFWF9ERUxUQTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbGluZSA9IGNyZWF0ZUxpbmUoZ2VvT2JqZWN0LCBzdHlsZUNvbmZpZy5maWxsQ29sb3IsIHN0eWxlQ29uZmlnLmZpbGxXaWR0aCAvIDIsIHsKICAgICAgICAgICAgZmlsbFRleHR1cmU6IHN0eWxlQ29uZmlnLmZpbGxUZXh0dXJlCiAgICAgICAgICB9LCBjb25maWcpOwogICAgICAgICAgaWYgKGxpbmUpIHsKICAgICAgICAgICAgbGluZS5yYW5rID0gcmFuazsKICAgICAgICAgICAgbGluZXMucHVzaChsaW5lKTsKICAgICAgICAgICAgbGF5ZXJJbmRleCArPSBMQVlFUl9JTkRFWF9ERUxUQTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCFoaWRlQmFzZSAmJiBjYXRhbG9nVHlwZSA9PT0gR0FPUUlOR19ST0FEX1RZUEUpIHsKICAgICAgICAgIGlmIChnZW9PYmplY3QuYm9yZGVyICYmIGdlb09iamVjdC5ib3JkZXIubGVuZ3RoID4gMCkgewogICAgICAgICAgICBkZWxheU9iamVjdHMucHVzaCh7CiAgICAgICAgICAgICAgZ2VvT2JqZWN0LAogICAgICAgICAgICAgIHN0eWxlQ29uZmlnCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIHBvbHlnb24zZCA9IGNyZWF0ZVBvbHlnb24oZ2VvT2JqZWN0LCBzdHlsZUNvbmZpZy5jb2xvciwgewogICAgICAgICAgICBpc0dhb1Fpbmc6ICFpc0ZsYXQKICAgICAgICAgIH0sIGNvbmZpZyk7CiAgICAgICAgICBpZiAocG9seWdvbjNkKSB7CiAgICAgICAgICAgIHBvbHlnb24zZC5yYW5rID0gcmFuazsKICAgICAgICAgICAgcG9seWdvbjNkcy5wdXNoKHBvbHlnb24zZCk7CiAgICAgICAgICAgIGxheWVySW5kZXggKz0gTEFZRVJfSU5ERVhfREVMVEE7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChjYXRhbG9nVHlwZSA9PT0gR0FPUUlOR19MSU5FX1RZUEUpIHsKICAgICAgICAgIGxpbmUgPSBjcmVhdGVMaW5lKGdlb09iamVjdCwgc3R5bGVDb25maWcuZmlsbENvbG9yLCBzdHlsZUNvbmZpZy5maWxsV2lkdGggLyA4LCB7CiAgICAgICAgICAgIGlzR2FvUWluZzogIWlzRmxhdCwKICAgICAgICAgICAgZmlsbFRleHR1cmU6IHN0eWxlQ29uZmlnLmZpbGxUZXh0dXJlLAogICAgICAgICAgICBzY2FsZTogMS41CiAgICAgICAgICB9LCBjb25maWcpOwogICAgICAgICAgaWYgKGxpbmUpIHsKICAgICAgICAgICAgbGluZS5pc0dhb1FpbmcgPSAhaXNGbGF0OwogICAgICAgICAgICBsaW5lLnJhbmsgPSByYW5rOwogICAgICAgICAgICBsaW5lcy5wdXNoKGxpbmUpOwogICAgICAgICAgICBsYXllckluZGV4ICs9IExBWUVSX0lOREVYX0RFTFRBOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoIWhpZGVCdWlsZGluZyAmJiBjYXRhbG9nVHlwZSA9PT0gSFJFR0lPTl9UWVBFKSB7CiAgICAgICAgICBidWlsZGluZzNkID0gY3JlYXRlQnVpbGRpbmczZChnZW9PYmplY3QsIHN0eWxlQ29uZmlnLmZpbGxUb3AsIHN0eWxlQ29uZmlnLmZpbGxTaWRlLCBjb25maWcpOwogICAgICAgICAgaWYgKGJ1aWxkaW5nM2QpIHsKICAgICAgICAgICAgYnVpbGRpbmczZC5yYW5rID0gcmFuazsKICAgICAgICAgICAgYnVpbGRpbmczZHMucHVzaChidWlsZGluZzNkKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCFoaWRlTGluayAmJiBjYXRhbG9nVHlwZSA9PT0gR0FPUUlOR19HUkFESUVOVF9UWVBFKSB7CiAgICAgICAgICBwb2x5Z29uID0gY3JlYXRlR3JhZGllbnRQb2x5Z29uKAogICAgICAgICAgICBnZW9PYmplY3QsCiAgICAgICAgICAgIHN0eWxlQ29uZmlnLnN0YXJ0UHRTdHlsZSwKICAgICAgICAgICAgc3R5bGVDb25maWcuZW5kUHRTdHlsZSwKICAgICAgICAgICAgY29uZmlnCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHBvbHlnb24pIHsKICAgICAgICAgICAgcG9seWdvbi5yYW5rID0gcmFuazsKICAgICAgICAgICAgcG9seWdvbnMucHVzaChwb2x5Z29uKTsKICAgICAgICAgICAgbGF5ZXJJbmRleCArPSBMQVlFUl9JTkRFWF9ERUxUQTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCFoaWRlUG9pICYmIGNhdGFsb2dUeXBlID09PSBQT0lfVFlQRSkgewogICAgICAgICAgaWYgKCFnZW9PYmplY3QubmFtZSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIHBvaSA9IGNyZWF0ZVBPSShnZW9PYmplY3QsIGdlb09iamVjdFNldC5zdHlsZUlkLCBjb25maWcsIHN0eWxlQ29uZmlnKTsKICAgICAgICAgIGlmIChwb2kpIHsKICAgICAgICAgICAgcG9pcy5wdXNoKHBvaSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRlbGF5T2JqZWN0cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCB7IGdlb09iamVjdCwgc3R5bGVDb25maWcgfSA9IGRlbGF5T2JqZWN0c1tpXTsKICAgICAgZm9yIChsZXQgaTIgPSAwLCBsID0gZ2VvT2JqZWN0LmJvcmRlci5sZW5ndGg7IGkyIDwgbDsgaTIrKykgewogICAgICAgIGNvbnN0IGJvcmRlciA9IGdlb09iamVjdC5ib3JkZXJbaTJdOwogICAgICAgIGJvcmRlci5taWRQb2ludHMgPSBnZW9PYmplY3QubWlkUG9pbnRzOwogICAgICAgIGJvcmRlci56dmVjdG9yID0gZ2VvT2JqZWN0Lnp2ZWN0b3I7CiAgICAgICAgY29uc3QgbGluZTIgPSBjcmVhdGVMaW5lKGJvcmRlciwgc3R5bGVDb25maWcuYm9yZGVyUmdiYSwgc3R5bGVDb25maWcuYm9yZGVyV2lkdGggLyAyLCB7CiAgICAgICAgICBpc0dhb1Fpbmc6ICFpc0ZsYXQKICAgICAgICB9LCBjb25maWcpOwogICAgICAgIGlmIChsaW5lMikgewogICAgICAgICAgbGluZTIucmFuayA9IHJhbms7CiAgICAgICAgICBsaW5lcy5wdXNoKGxpbmUyKTsKICAgICAgICAgIGxheWVySW5kZXggKz0gTEFZRVJfSU5ERVhfREVMVEE7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBsZXQgZGVsYXlQb2x5Z29ucyA9IFtdOwogICAgbGV0IG9yaWdpblBvbHlnb25zID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRlbGF5T2JqZWN0cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCB7IGdlb09iamVjdCwgc3R5bGVDb25maWcgfSA9IGRlbGF5T2JqZWN0c1tpXTsKICAgICAgcG9seWdvbjNkID0gY3JlYXRlUG9seWdvbihnZW9PYmplY3QsIHN0eWxlQ29uZmlnLmNvbG9yLCB7CiAgICAgICAgaXNHYW9RaW5nOiAhaXNGbGF0LAogICAgICAgIGJvcmRlclJnYmE6IHN0eWxlQ29uZmlnLmJvcmRlclJnYmEsCiAgICAgICAgaXNEZWxheTogdHJ1ZQogICAgICB9LCBjb25maWcpOwogICAgICBpZiAocG9seWdvbjNkICYmIHBvbHlnb24zZC5kZWxheU9iamVjdCkgewogICAgICAgIGNvbnN0IGRlbGF5UG9seWdvbiA9IHBvbHlnb24zZC5kZWxheU9iamVjdDsKICAgICAgICBjb25zdCBvcmlnaW5Qb2x5Z29uID0gcG9seWdvbjNkLm9iamVjdDsKICAgICAgICBkZWxheVBvbHlnb25zLnB1c2goZGVsYXlQb2x5Z29uKTsKICAgICAgICBvcmlnaW5Qb2x5Z29ucy5wdXNoKG9yaWdpblBvbHlnb24pOwogICAgICB9IGVsc2UgaWYgKHBvbHlnb24zZCkgewogICAgICAgIHBvbHlnb24zZC5yYW5rID0gcmFuazsKICAgICAgICBwb2x5Z29uM2RzLnB1c2gocG9seWdvbjNkKTsKICAgICAgICBsYXllckluZGV4ICs9IExBWUVSX0lOREVYX0RFTFRBOwogICAgICB9CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRlbGF5UG9seWdvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcG9seWdvbjIgPSBkZWxheVBvbHlnb25zW2ldOwogICAgICBjb25zdCBsYXllckluZGljZXMgPSBwb2x5Z29uMi5sYXllckluZGljZXM7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbGF5ZXJJbmRpY2VzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgbGF5ZXJJbmRpY2VzW2pdID0gbGF5ZXJJbmRleDsKICAgICAgfQogICAgICBwb2x5Z29uMi5yYW5rID0gcmFuazsKICAgICAgcG9seWdvbjNkcy5wdXNoKHBvbHlnb24yKTsKICAgICAgbGF5ZXJJbmRleCArPSBMQVlFUl9JTkRFWF9ERUxUQTsKICAgIH0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3JpZ2luUG9seWdvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcG9seWdvbjIgPSBvcmlnaW5Qb2x5Z29uc1tpXTsKICAgICAgY29uc3QgbGF5ZXJJbmRpY2VzID0gcG9seWdvbjIubGF5ZXJJbmRpY2VzOwogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGxheWVySW5kaWNlcy5sZW5ndGg7IGorKykgewogICAgICAgIGxheWVySW5kaWNlc1tqXSA9IGxheWVySW5kZXg7CiAgICAgIH0KICAgICAgcG9seWdvbjIucmFuayA9IHJhbms7CiAgICAgIHBvbHlnb24zZHMucHVzaChwb2x5Z29uMik7CiAgICAgIGxheWVySW5kZXggKz0gTEFZRVJfSU5ERVhfREVMVEE7CiAgICB9CiAgfQogIGlmIChkYXRhLmxhYmVscCkgewogICAgbGV0IGxhYmVscCA9IGRhdGEubGFiZWxwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsYWJlbHAubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgbGFiZWwgPSBsYWJlbHBbaV07CiAgICAgIGxldCBzdHlsZUNvbmZpZyA9IG51bGw7CiAgICAgIGlmICghaGlkZVBvaSkgewogICAgICAgIHN0eWxlQ29uZmlnID0gZ2V0U3R5bGVDb25maWcoUE9JX1RZUEUsIGxhYmVsLnN0eWxlSWQsIHVzZVpvb20sIFBPSU5UX1RFWFRfU1RZTEUsIGNvbmZpZyk7CiAgICAgIH0KICAgICAgaWYgKCFzdHlsZUNvbmZpZykgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNyZWF0ZUxhYmVsUG9pKHBvaXMsIGxhYmVsLCB1c2Vab29tLCBjb25maWcsIHN0eWxlQ29uZmlnKTsKICAgIH0KICB9CiAgcmV0dXJuIGxheWVySW5kZXg7Cn0KZnVuY3Rpb24gY3JlYXRlQXJyb3coZ2VvTGF5ZXIsIHVzZVpvb20sIGNvbmZpZykgewogIGNvbnN0IGFycm93cCA9IGdlb0xheWVyLmFycm93cDsKICBjb25zdCBwb2ludHMgPSBwYXJzZUZlYXR1cmUoYXJyb3dwLngpOwogIGNvbnN0IHByb2plY3Rpb24gPSBjb25maWcudGFyZ2V0UHJvamVjdGlvbjsKICBjb25zdCBbY2VudGVyWCwgY2VudGVyWSwgY2VudGVyWl0gPSBjb25maWcudGFyZ2V0Q2VudGVyOwogIGNvbnN0IHRyYWNlcnMgPSBhcnJvd3AudHJhY2VyOwogIGNvbnN0IHp2ZWN0b3IgPSBhcnJvd3AuenZlY3RvcjsKICBjb25zdCBnYXAgPSAxIC8gMjU2OwogIGNvbnN0IGdhcE1pbiA9IC0wLjUgKyBnYXA7CiAgY29uc3QgZ2FwTWF4ID0gMC41IC0gZ2FwOwogIGxldCB0aWxlU2l6ZSA9IGdldFRpbGVNYXhWYWx1ZUJ5Wihjb25maWcueiwgY29uZmlnKTsKICBjb25zdCB2ZXJ0aWNlcyA9IFtdOwogIGNvbnN0IGluZGljZXMgPSBbXTsKICBjb25zdCBkaWZmcyA9IFtdOwogIGNvbnN0IHV2cyA9IFtdOwogIGNvbnN0IGZsYXROb3JtYWxzID0gW107CiAgY29uc3QgbGF5ZXJJbmRpY2VzID0gW107CiAgY29uc3QgaW5zdGFuY2VSb3RhdGlvbk1hdHJpY2VzID0gW107CiAgY29uc3QgYWx0aXR1ZGVzID0gcGFyc2VGZWF0dXJlKHp2ZWN0b3IsIDEpOwogIGxldCB6dmVjdG9yQXJyYXkgPSBbXTsKICBpZiAoYWx0aXR1ZGVzLmxlbmd0aCA9PT0gMSAmJiBhbHRpdHVkZXNbMF0pIHsKICAgIHp2ZWN0b3JBcnJheSA9IG5ldyBBcnJheShwb2ludHMubGVuZ3RoKTsKICAgIHp2ZWN0b3JBcnJheS5maWxsKGFsdGl0dWRlc1swXSk7CiAgfSBlbHNlIHsKICAgIHp2ZWN0b3JBcnJheSA9IGFsdGl0dWRlczsKICB9CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb2ludHMubGVuZ3RoOyBpKyspIHsKICAgIHBvaW50c1tpXVsyXSA9IHp2ZWN0b3JBcnJheVtpXSAvIEFUVEFDSF9TQ0FMRTsKICB9CiAgZm9yIChsZXQgbSA9IDAsIGwgPSB0cmFjZXJzLmxlbmd0aDsgbSA8IGw7IG0rKykgewogICAgbGV0IHRyYWNlciA9IHRyYWNlcnNbbV07CiAgICBpZiAoIWlzVmlzaWJsZSh0cmFjZXIsIGNvbmZpZykpIHsKICAgICAgY29udGludWU7CiAgICB9CiAgICBjb25zdCBzdGFydCA9IHBvaW50c1ttICogMl07CiAgICBjb25zdCBlbmQgPSBwb2ludHNbbSAqIDIgKyAxXTsKICAgIF9jZW50ZXJbMF0gPSAoc3RhcnRbMF0gKyBlbmRbMF0pIC8gMjsKICAgIF9jZW50ZXJbMV0gPSAoc3RhcnRbMV0gKyBlbmRbMV0pIC8gMjsKICAgIF9jZW50ZXJbMl0gPSAoc3RhcnRbMl0gKyBlbmRbMl0pIC8gMjsKICAgIGNvbnN0IHhEaWZmID0gX2NlbnRlclswXSAtIHN0YXJ0WzBdOwogICAgY29uc3QgeURpZmYgPSBfY2VudGVyWzFdIC0gc3RhcnRbMV07CiAgICBfdmVjdG9yLnNldCh4RGlmZiwgeURpZmYsIDApOwogICAgX25vcm1hbC5zZXQoLXlEaWZmLCB4RGlmZiwgMCk7CiAgICBjb25zdCBhcnJJbmRleCA9IGxheWVySW5kaWNlcy5sZW5ndGg7CiAgICBpZiAoIWNvbmZpZy5pc05vcm1hbGl6ZWQpIHsKICAgICAgY29uc3QgbGVuZ3RoID0gTWF0aC5oeXBvdCh4RGlmZiwgeURpZmYpOwogICAgICBfcHJvamVjdGVkU3RhcnRbMF0gPSBzdGFydFswXTsKICAgICAgX3Byb2plY3RlZFN0YXJ0WzFdID0gc3RhcnRbMV07CiAgICAgIF9wcm9qZWN0ZWRTdGFydFsyXSA9IHN0YXJ0WzJdOwogICAgICBfcHJvamVjdGVkRW5kWzBdID0gZW5kWzBdOwogICAgICBfcHJvamVjdGVkRW5kWzFdID0gZW5kWzFdOwogICAgICBfcHJvamVjdGVkRW5kWzJdID0gZW5kWzJdOwogICAgICBub3JtYWxpemVWZXJ0ZXgoX3Byb2plY3RlZFN0YXJ0LCB0aWxlU2l6ZSwgZ2FwTWluLCBnYXBNYXgpOwogICAgICBwcm9qZWN0VmVydGljZXMoX3Byb2plY3RlZFN0YXJ0LCBjb25maWcsIHRydWUsIGZhbHNlKTsKICAgICAgbm9ybWFsaXplVmVydGV4KF9wcm9qZWN0ZWRFbmQsIHRpbGVTaXplLCBnYXBNaW4sIGdhcE1heCk7CiAgICAgIHByb2plY3RWZXJ0aWNlcyhfcHJvamVjdGVkRW5kLCBjb25maWcsIHRydWUsIGZhbHNlKTsKICAgICAgX2NlbnRlclswXSA9IChfcHJvamVjdGVkRW5kWzBdICsgX3Byb2plY3RlZFN0YXJ0WzBdKSAvIDIgLSBjZW50ZXJYOwogICAgICBfY2VudGVyWzFdID0gKF9wcm9qZWN0ZWRFbmRbMV0gKyBfcHJvamVjdGVkU3RhcnRbMV0pIC8gMiAtIGNlbnRlclk7CiAgICAgIF9jZW50ZXJbMl0gPSAoX3Byb2plY3RlZEVuZFsyXSArIF9wcm9qZWN0ZWRTdGFydFsyXSkgLyAyIC0gY2VudGVyWjsKICAgICAgcHJvamVjdGlvbi5nZXRQcm9qZWN0ZWRTdXJmYWNlTm9ybWFsKF92ZWN0b3IuZnJvbUFycmF5KF9wcm9qZWN0ZWRTdGFydCksIF9ub3JtYWwpOwogICAgICBfdmVjdG9yLnNldCgKICAgICAgICBfcHJvamVjdGVkRW5kWzBdIC0gX3Byb2plY3RlZFN0YXJ0WzBdLAogICAgICAgIF9wcm9qZWN0ZWRFbmRbMV0gLSBfcHJvamVjdGVkU3RhcnRbMV0sCiAgICAgICAgX3Byb2plY3RlZEVuZFsyXSAtIF9wcm9qZWN0ZWRTdGFydFsyXQogICAgICApLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKGxlbmd0aCk7CiAgICAgIF9ub3JtYWwuY3Jvc3NWZWN0b3JzKF9ub3JtYWwsIF92ZWN0b3IpLm5vcm1hbGl6ZSgpOwogICAgfQogICAgdmVydGljZXNbdmVydGljZXMubGVuZ3RoXSA9IF9jZW50ZXJbMF07CiAgICB2ZXJ0aWNlc1t2ZXJ0aWNlcy5sZW5ndGhdID0gX2NlbnRlclsxXTsKICAgIHZlcnRpY2VzW3ZlcnRpY2VzLmxlbmd0aF0gPSBfY2VudGVyWzJdOwogICAgZGlmZnNbZGlmZnMubGVuZ3RoXSA9IC1fdmVjdG9yLng7CiAgICBkaWZmc1tkaWZmcy5sZW5ndGhdID0gLV92ZWN0b3IueTsKICAgIGRpZmZzW2RpZmZzLmxlbmd0aF0gPSAtX3ZlY3Rvci56OwogICAgZmxhdE5vcm1hbHNbZmxhdE5vcm1hbHMubGVuZ3RoXSA9IF9ub3JtYWwueDsKICAgIGZsYXROb3JtYWxzW2ZsYXROb3JtYWxzLmxlbmd0aF0gPSBfbm9ybWFsLnk7CiAgICBmbGF0Tm9ybWFsc1tmbGF0Tm9ybWFscy5sZW5ndGhdID0gX25vcm1hbC56OwogICAgdXZzW3V2cy5sZW5ndGhdID0gMC4xMjU7CiAgICB1dnNbdXZzLmxlbmd0aF0gPSAwLjMxMjU7CiAgICBsYXllckluZGljZXNbbGF5ZXJJbmRpY2VzLmxlbmd0aF0gPSBsYXllckluZGV4OwogICAgdmVydGljZXNbdmVydGljZXMubGVuZ3RoXSA9IF9jZW50ZXJbMF07CiAgICB2ZXJ0aWNlc1t2ZXJ0aWNlcy5sZW5ndGhdID0gX2NlbnRlclsxXTsKICAgIHZlcnRpY2VzW3ZlcnRpY2VzLmxlbmd0aF0gPSBfY2VudGVyWzJdOwogICAgZGlmZnNbZGlmZnMubGVuZ3RoXSA9IC1fdmVjdG9yLng7CiAgICBkaWZmc1tkaWZmcy5sZW5ndGhdID0gLV92ZWN0b3IueTsKICAgIGRpZmZzW2RpZmZzLmxlbmd0aF0gPSAtX3ZlY3Rvci56OwogICAgZmxhdE5vcm1hbHNbZmxhdE5vcm1hbHMubGVuZ3RoXSA9IC1fbm9ybWFsLng7CiAgICBmbGF0Tm9ybWFsc1tmbGF0Tm9ybWFscy5sZW5ndGhdID0gLV9ub3JtYWwueTsKICAgIGZsYXROb3JtYWxzW2ZsYXROb3JtYWxzLmxlbmd0aF0gPSAtX25vcm1hbC56OwogICAgdXZzW3V2cy5sZW5ndGhdID0gMC4xMjU7CiAgICB1dnNbdXZzLmxlbmd0aF0gPSAwLjY4NzU7CiAgICBsYXllckluZGljZXNbbGF5ZXJJbmRpY2VzLmxlbmd0aF0gPSBsYXllckluZGV4OwogICAgdmVydGljZXNbdmVydGljZXMubGVuZ3RoXSA9IF9jZW50ZXJbMF07CiAgICB2ZXJ0aWNlc1t2ZXJ0aWNlcy5sZW5ndGhdID0gX2NlbnRlclsxXTsKICAgIHZlcnRpY2VzW3ZlcnRpY2VzLmxlbmd0aF0gPSBfY2VudGVyWzJdOwogICAgZGlmZnNbZGlmZnMubGVuZ3RoXSA9IF92ZWN0b3IueDsKICAgIGRpZmZzW2RpZmZzLmxlbmd0aF0gPSBfdmVjdG9yLnk7CiAgICBkaWZmc1tkaWZmcy5sZW5ndGhdID0gX3ZlY3Rvci56OwogICAgZmxhdE5vcm1hbHNbZmxhdE5vcm1hbHMubGVuZ3RoXSA9IF9ub3JtYWwueDsKICAgIGZsYXROb3JtYWxzW2ZsYXROb3JtYWxzLmxlbmd0aF0gPSBfbm9ybWFsLnk7CiAgICBmbGF0Tm9ybWFsc1tmbGF0Tm9ybWFscy5sZW5ndGhdID0gX25vcm1hbC56OwogICAgdXZzW3V2cy5sZW5ndGhdID0gMTsKICAgIHV2c1t1dnMubGVuZ3RoXSA9IDAuMzEyNTsKICAgIGxheWVySW5kaWNlc1tsYXllckluZGljZXMubGVuZ3RoXSA9IGxheWVySW5kZXg7CiAgICB2ZXJ0aWNlc1t2ZXJ0aWNlcy5sZW5ndGhdID0gX2NlbnRlclswXTsKICAgIHZlcnRpY2VzW3ZlcnRpY2VzLmxlbmd0aF0gPSBfY2VudGVyWzFdOwogICAgdmVydGljZXNbdmVydGljZXMubGVuZ3RoXSA9IF9jZW50ZXJbMl07CiAgICBkaWZmc1tkaWZmcy5sZW5ndGhdID0gX3ZlY3Rvci54OwogICAgZGlmZnNbZGlmZnMubGVuZ3RoXSA9IF92ZWN0b3IueTsKICAgIGRpZmZzW2RpZmZzLmxlbmd0aF0gPSBfdmVjdG9yLno7CiAgICBmbGF0Tm9ybWFsc1tmbGF0Tm9ybWFscy5sZW5ndGhdID0gLV9ub3JtYWwueDsKICAgIGZsYXROb3JtYWxzW2ZsYXROb3JtYWxzLmxlbmd0aF0gPSAtX25vcm1hbC55OwogICAgZmxhdE5vcm1hbHNbZmxhdE5vcm1hbHMubGVuZ3RoXSA9IC1fbm9ybWFsLno7CiAgICB1dnNbdXZzLmxlbmd0aF0gPSAxOwogICAgdXZzW3V2cy5sZW5ndGhdID0gMC42ODc1OwogICAgbGF5ZXJJbmRpY2VzW2xheWVySW5kaWNlcy5sZW5ndGhdID0gbGF5ZXJJbmRleDsKICAgIGluZGljZXNbaW5kaWNlcy5sZW5ndGhdID0gYXJySW5kZXg7CiAgICBpbmRpY2VzW2luZGljZXMubGVuZ3RoXSA9IGFyckluZGV4ICsgMTsKICAgIGluZGljZXNbaW5kaWNlcy5sZW5ndGhdID0gYXJySW5kZXggKyAyOwogICAgaW5kaWNlc1tpbmRpY2VzLmxlbmd0aF0gPSBhcnJJbmRleCArIDI7CiAgICBpbmRpY2VzW2luZGljZXMubGVuZ3RoXSA9IGFyckluZGV4ICsgMTsKICAgIGluZGljZXNbaW5kaWNlcy5sZW5ndGhdID0gYXJySW5kZXggKyAzOwogIH0KICByZXR1cm4gewogICAgdmVydGljZXMsCiAgICBpbmRpY2VzLAogICAgZmxhdE5vcm1hbHMsCiAgICBpbnN0YW5jZVJvdGF0aW9uTWF0cmljZXMsCiAgICBkaWZmcywKICAgIHV2cywKICAgIGxheWVySW5kaWNlcwogIH07Cn0KZnVuY3Rpb24gY3JlYXRlTGluZShnZW9PYmplY3QsIGNvbG9yLCB3aWR0aCwgb3B0aW9ucyA9IHt9LCBjb25maWcpIHsKICBjb25zdCBtaWRQb2ludHMgPSBnZW9PYmplY3QubWlkUG9pbnRzOwogIGNvbnN0IHp2ZWN0b3IgPSBnZW9PYmplY3QuenZlY3RvcjsKICBjb25zdCBpc0dhb1FpbmcgPSBvcHRpb25zLmlzR2FvUWluZyB8fCBmYWxzZTsKICBjb25zdCBpbmRleE9mZnNldCA9IG9wdGlvbnMuaW5kZXhPZmZzZXQgfHwgMDsKICBjb25zdCBmaWxsVGV4dHVyZSA9IG9wdGlvbnMuZmlsbFRleHR1cmU7CiAgY29uc3QgaXNTaW5nbGUgPSBvcHRpb25zLmlzU2luZ2xlOwogIGxldCBzY2FsZSA9IG9wdGlvbnMuc2NhbGUgfHwgMTsKICBpZiAoIW1pZFBvaW50cykgewogICAgcmV0dXJuOwogIH0KICBjb25zdCBwb2ludHMgPSBwYXJzZU1pZFBvaW50cyhtaWRQb2ludHMsIExBTkRfT0ZGU0VUWiwgY29uZmlnKTsKICBsZXQgenZlY3RvckFycmF5ID0gbnVsbDsKICBpZiAoaXNHYW9RaW5nKSB7CiAgICBpZiAoenZlY3Rvci5sZW5ndGggPT09IDEgJiYgenZlY3RvclswXSkgewogICAgICB6dmVjdG9yQXJyYXkgPSBuZXcgQXJyYXkobWlkUG9pbnRzLmxlbmd0aCA+PiAxKTsKICAgICAgenZlY3RvckFycmF5LmZpbGwoenZlY3RvclswXSk7CiAgICB9IGVsc2UgaWYgKHp2ZWN0b3IubGVuZ3RoID4gMSkgewogICAgICB6dmVjdG9yQXJyYXkgPSBbXTsKICAgICAgZm9yIChsZXQgayA9IGluZGV4T2Zmc2V0OyBrIDwgenZlY3Rvci5sZW5ndGg7IGsrKykgewogICAgICAgIHp2ZWN0b3JBcnJheVtrXSA9IHp2ZWN0b3Jba10gfHwgMTsKICAgICAgfQogICAgfQogIH0KICBsZXQgZmlsbFRleHR1cmVJbmZvOwogIGlmIChmaWxsVGV4dHVyZSAmJiBzY2FsZSA+IDEpIHsKICAgIGZpbGxUZXh0dXJlSW5mbyA9IGdldEljb25JbmZvKGZpbGxUZXh0dXJlKTsKICAgIHNjYWxlID0gTWF0aC5tYXgoZmlsbFRleHR1cmVJbmZvWzFdIC8gNywgMSk7CiAgfQogIGxldCBvZmZzZXRaID0gMDsKICBpZiAoL2d1b2ppZXRpYW5xaWFvamlldGkvLnRlc3QoZmlsbFRleHR1cmUpKSB7CiAgICBvZmZzZXRaID0gMC4wNDsKICB9CiAgaWYgKC93ZWlkaW5nZ3VvamllX2d1b25laS8udGVzdChmaWxsVGV4dHVyZSkpIHsKICAgIHdpZHRoICo9IDEuMTsKICB9CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBwb2ludHMubGVuZ3RoOyBpKyspIHsKICAgIGlmICh6dmVjdG9yQXJyYXkgJiYgenZlY3RvckFycmF5W2ldKSB7CiAgICAgIHBvaW50c1tpXVsyXSArPSBvZmZzZXRaICsgenZlY3RvckFycmF5W2ldIC8gMTAwIC8gQVRUQUNIX1NDQUxFOwogICAgfQogIH0KICBwcm9qZWN0VmVydGljZXMocG9pbnRzLCBjb25maWcsIGZhbHNlLCBmYWxzZSk7CiAgY29uc3QgbGluZU1lc2ggPSBsaW5lVG9NZXNoKHBvaW50cywgd2lkdGgsIGNvbmZpZywgaXNTaW5nbGUsIHNjYWxlKTsKICBsaW5lTWVzaC5jb2xvcnMgPSBmaWxsRmxhdEFycmF5KGxpbmVNZXNoLnZlcnRpY2VzLmxlbmd0aCAvIDMsIFtjb2xvclswXSwgY29sb3JbMV0sIGNvbG9yWzJdLCBjb2xvclszXSB8fCAxXSk7CiAgbGluZU1lc2gubGF5ZXJJbmRpY2VzID0gZmlsbEZsYXRBcnJheShsaW5lTWVzaC52ZXJ0aWNlcy5sZW5ndGggLyAzLCBbbGF5ZXJJbmRleF0pOwogIGlmIChmaWxsVGV4dHVyZSkgewogICAgbGluZU1lc2guZmlsbFRleHR1cmVTdHlsZSA9IHsKICAgICAgZmlsbFRleHR1cmUsCiAgICAgIHRleHR1cmVJbmZvOiBmaWxsVGV4dHVyZUluZm8sCiAgICAgIGlzU2luZ2xlOiBpc1NpbmdsZSA/IDEgOiAwCiAgICB9OwogIH0KICByZXR1cm4gbGluZU1lc2g7Cn0KZnVuY3Rpb24gdGlsZU5vcm1hbGl6ZWRQb3NpdGlvblRvTWV0ZXIoaW5wdXQsIHRpbGVDb25maWcsIG91dHB1dCkgewogIGNvbnN0IFt3ZXN0TWV0ZXIsIHNvdXRoTWV0ZXIsIG1pbkhNZXRlciwgZWFzdE1ldGVyLCBub3J0aE1ldGVyLCBtYXhITWV0ZXJdID0gdGlsZUNvbmZpZy5wcm9qZWN0ZWRCb3VuZGluZ0JveDsKICBjb25zdCBsb25ndGl0dWRlUmFuZ2VNZXRlciA9IGVhc3RNZXRlciAtIHdlc3RNZXRlcjsKICBjb25zdCBsYXRpdHVkZVJhbmdlTWV0ZXIgPSBub3J0aE1ldGVyIC0gc291dGhNZXRlcjsKICBvdXRwdXQueCA9IHdlc3RNZXRlciArIChpbnB1dC54ICsgMC41KSAqIGxvbmd0aXR1ZGVSYW5nZU1ldGVyOwogIG91dHB1dC55ID0gc291dGhNZXRlciArIChpbnB1dC55ICsgMC41KSAqIGxhdGl0dWRlUmFuZ2VNZXRlcjsKICBvdXRwdXQueiA9IGlucHV0LnogfHwgMDsKICByZXR1cm4gb3V0cHV0Owp9CmZ1bmN0aW9uIGNyZWF0ZUJnUG9seWdvbihzdHlsZSwgY29uZmlnKSB7CiAgY29uc3QgY29sb3IgPSBzdHlsZS5jb2xvcjsKICBjb25zdCByZXN1bHQgPSBjcmVhdGVHcm91bmRUaWxlTWVzaChjb25maWcsIHsKICAgIGNvbG9yczogW2NvbG9yWzBdLCBjb2xvclsxXSwgY29sb3JbMl1dLAogICAgbGF5ZXJJbmRpY2VzOiBbMF0sCiAgICBub3JtYWxzOiBbMCwgMCwgMV0KICB9KTsKICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIGdldFN1YkRpdmlzaW9uTWF4TGVuZ3RoKGNvbmZpZykgewogIGlmIChjb25maWcudGFyZ2V0UHJvamVjdGlvbk5hbWUgPT09IGNvbmZpZy5zb3VyY2VQcm9qZWN0aW9uTmFtZSkgewogICAgcmV0dXJuIDA7CiAgfSBlbHNlIGlmIChjb25maWcudGFyZ2V0UHJvamVjdGlvbk5hbWUgPT09IFBST0pFQ1RJT05fRUNFRikgewogICAgcmV0dXJuIDAuMDU7CiAgfQogIGNvbnN0IHNlZ21lbnQgPSBNYXRoLm1heCgyLCAxNiAtIGNvbmZpZy56KTsKICByZXR1cm4gMSAvIHNlZ21lbnQ7Cn0KZnVuY3Rpb24gY3JlYXRlUG9seWdvbihnZW9PYmplY3QsIGNvbG9yQXJyLCBvcHRpb25zID0ge30sIGNvbmZpZykgewogIGNvbnN0IG1pZFBvaW50cyA9IGdlb09iamVjdC5taWRQb2ludHM7CiAgbGV0IGdlb0luZGljZXMgPSBnZW9PYmplY3QuaW5kaWNlczsKICBjb25zdCB6dmVjdG9yID0gZ2VvT2JqZWN0Lnp2ZWN0b3I7CiAgY29uc3QgaXNHYW9RaW5nID0gb3B0aW9ucy5pc0dhb1FpbmcgfHwgZmFsc2U7CiAgY29uc3QgaXNEZWxheSA9IG9wdGlvbnMuaXNEZWxheSB8fCBmYWxzZTsKICBjb25zdCBpc1RyYW5zcGFyZW50ID0gb3B0aW9ucy5pc1RyYW5zcGFyZW50IHx8IGZhbHNlOwogIGlmICghZ2VvSW5kaWNlcyB8fCAhbWlkUG9pbnRzKSB7CiAgICByZXR1cm47CiAgfQogIGNvbnN0IHZlcnRpY2VzID0gW107CiAgY29uc3QgaW5kaWNlcyA9IFtdOwogIGNvbnN0IG5vcm1hbHMgPSBbXTsKICBjb25zdCBjb2xvcnMgPSBbXTsKICBjb25zdCBsYXllckluZGljZXMgPSBbXTsKICBsZXQgZXh0cnVkZVZlcnRpY2VzID0gW107CiAgbGV0IGV4dHJ1ZGVJbmRpY2VzID0gW107CiAgbGV0IGV4dHJ1ZGVOb3JtYWxzID0gW107CiAgbGV0IGV4dHJ1ZGVDb2xvcnMgPSBbXTsKICBsZXQgZXh0cnVkZUxheWVySW5kaWNlcyA9IFtdOwogIGNvbnN0IGluZGljZXNPZmZzZXRTdGFydCA9IHZlcnRpY2VzLmxlbmd0aCAvIDM7CiAgbGV0IHBvaW50cyA9IHBhcnNlTWlkUG9pbnRzKG1pZFBvaW50cywgTEFORF9PRkZTRVRaICogMTAwLCBjb25maWcpOwogIGxldCBoYXNadmVjdG9yQXJyYXkgPSBmYWxzZTsKICBsZXQgaGFzTmVnYXRpdmVadmVjdG9yID0gZmFsc2U7CiAgaWYgKGlzR2FvUWluZykgewogICAgbGF5ZXJJbmRleCArPSBMQVlFUl9JTkRFWF9ERUxUQSAqIDE7CiAgICBpZiAoenZlY3Rvci5sZW5ndGggPT09IDEgJiYgenZlY3RvclswXSkgewogICAgICBoYXNadmVjdG9yQXJyYXkgPSB0cnVlOwogICAgICBpZiAoenZlY3RvclswXSA8IDApIHsKICAgICAgICBoYXNOZWdhdGl2ZVp2ZWN0b3IgPSB0cnVlOwogICAgICB9CiAgICAgIGZvciAobGV0IGkgPSAwLCBsYXN0ID0gcG9pbnRzLmxlbmd0aDsgaSA8IGxhc3Q7IGkgKz0gMSkgewogICAgICAgIHBvaW50c1tpXVsyXSA9IHp2ZWN0b3JbMF07CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoenZlY3Rvci5sZW5ndGggPiAxKSB7CiAgICAgIGhhc1p2ZWN0b3JBcnJheSA9IHRydWU7CiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgenZlY3Rvci5sZW5ndGg7IGsrKykgewogICAgICAgIGlmICh6dmVjdG9yW2tdIDwgMCkgewogICAgICAgICAgaGFzTmVnYXRpdmVadmVjdG9yID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcG9pbnRzW2tdWzJdID0gTWF0aC5tYXgoenZlY3RvcltrXSwgMCk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgY29uc3Qgc3ViZGl2aXNpb25NYXhMZW5ndGggPSBnZXRTdWJEaXZpc2lvbk1heExlbmd0aChjb25maWcpOwogICAgaWYgKHN1YmRpdmlzaW9uTWF4TGVuZ3RoID4gMCkgewogICAgICBjb25zdCBzdWJkaXZpc2lvblJlc3VsdCA9IHN1YmRpdmlkZU1lc2gocG9pbnRzLCBnZW9JbmRpY2VzLCBudWxsLCBzdWJkaXZpc2lvbk1heExlbmd0aCk7CiAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IHN1YmRpdmlzaW9uUmVzdWx0LnZlcnRpY2VzOwogICAgICBwb2ludHMgPSBbXTsKICAgICAgZm9yIChsZXQgaSA9IDAsIGxhc3QgPSBwb3NpdGlvbnMubGVuZ3RoIC0gMjsgaSA8IGxhc3Q7IGkgKz0gMykgewogICAgICAgIHBvaW50cy5wdXNoKFtwb3NpdGlvbnNbaV0sIHBvc2l0aW9uc1tpICsgMV0sIHBvc2l0aW9uc1tpICsgMl1dKTsKICAgICAgfQogICAgICBnZW9JbmRpY2VzID0gc3ViZGl2aXNpb25SZXN1bHQuaW5kaWNlczsKICAgIH0KICB9CiAgbGV0IHBvaW50ID0gbnVsbDsKICBmb3IgKGxldCBpID0gMCwgbGFzdCA9IHBvaW50cy5sZW5ndGg7IGkgPCBsYXN0OyBpICs9IDEpIHsKICAgIHBvaW50ID0gcG9pbnRzW2ldOwogICAgdmVydGljZXMucHVzaChwb2ludFswXSwgcG9pbnRbMV0sIHBvaW50WzJdKTsKICAgIG5vcm1hbHMucHVzaCgwLCAwLCAxKTsKICAgIGlmIChpc1RyYW5zcGFyZW50KSB7CiAgICAgIGNvbG9ycy5wdXNoKGNvbG9yQXJyWzBdLCBjb2xvckFyclsxXSwgY29sb3JBcnJbMl0sIGNvbG9yQXJyWzNdIHx8IDEpOwogICAgfSBlbHNlIHsKICAgICAgY29sb3JzLnB1c2goY29sb3JBcnJbMF0sIGNvbG9yQXJyWzFdLCBjb2xvckFyclsyXSk7CiAgICB9CiAgICBsYXllckluZGljZXMucHVzaChsYXllckluZGV4KTsKICB9CiAgZm9yIChsZXQgaSA9IDAsIGxlbmd0aCA9IGdlb0luZGljZXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgIGluZGljZXMucHVzaChpbmRpY2VzT2Zmc2V0U3RhcnQgKyBnZW9JbmRpY2VzW2ldKTsKICB9CiAgaWYgKCFpc0RlbGF5KSB7CiAgICBleHRydWRlVmVydGljZXMgPSB2ZXJ0aWNlczsKICAgIGV4dHJ1ZGVJbmRpY2VzID0gaW5kaWNlczsKICAgIGV4dHJ1ZGVDb2xvcnMgPSBjb2xvcnM7CiAgICBleHRydWRlTm9ybWFscyA9IG5vcm1hbHM7CiAgICBleHRydWRlTGF5ZXJJbmRpY2VzID0gbGF5ZXJJbmRpY2VzOwogIH0KICBsZXQgaGFzRXh0cnVkZSA9IGhhc1p2ZWN0b3JBcnJheSAmJiAhaGFzTmVnYXRpdmVadmVjdG9yOwogIGlmIChoYXNadmVjdG9yQXJyYXkgJiYgIWhhc05lZ2F0aXZlWnZlY3RvcikgewogICAgY29uc3QgYm9yZGVyUmdiYSA9IG9wdGlvbnMuYm9yZGVyUmdiYSB8fCBjb2xvckFycjsKICAgIGxldCBpdGVtSW5kZXggPSBpc0RlbGF5ID8gMCA6IHZlcnRpY2VzLmxlbmd0aCAvIDM7CiAgICBmb3IgKGxldCBpID0gMCwgbGFzdCA9IHBvaW50cy5sZW5ndGg7IGkgPCBsYXN0OyBpICs9IDEpIHsKICAgICAgcG9pbnQgPSBwb2ludHNbaV07CiAgICAgIGxldCBpdGVtQWx0aXR1ZGUgPSBwb2ludFsyXTsKICAgICAgbGV0IGJvdHRvbUFsdGl0dWRlID0gaXRlbUFsdGl0dWRlIC0gMjgwOwogICAgICBpZiAoYm90dG9tQWx0aXR1ZGUgPCAwKSB7CiAgICAgICAgYm90dG9tQWx0aXR1ZGUgPSAwOwogICAgICB9CiAgICAgIGV4dHJ1ZGVWZXJ0aWNlcy5wdXNoKAogICAgICAgIHBvaW50WzBdLAogICAgICAgIHBvaW50WzFdLAogICAgICAgIGl0ZW1BbHRpdHVkZSwKICAgICAgICBwb2ludFswXSwKICAgICAgICBwb2ludFsxXSwKICAgICAgICBib3R0b21BbHRpdHVkZQogICAgICApOwogICAgICBleHRydWRlQ29sb3JzLnB1c2goCiAgICAgICAgYm9yZGVyUmdiYVswXSwKICAgICAgICBib3JkZXJSZ2JhWzFdLAogICAgICAgIGJvcmRlclJnYmFbMl0sCiAgICAgICAgYm9yZGVyUmdiYVswXSwKICAgICAgICBib3JkZXJSZ2JhWzFdLAogICAgICAgIGJvcmRlclJnYmFbMl0KICAgICAgKTsKICAgICAgZXh0cnVkZUxheWVySW5kaWNlcy5wdXNoKGxheWVySW5kZXgsIGxheWVySW5kZXgpOwogICAgICBsZXQgbmV4dEluZGV4ID0gaSA9PT0gbGFzdCAtIDEgPyAwIDogaSArIDE7CiAgICAgIGxldCBjdXJyZW50WCA9IHBvaW50WzBdOwogICAgICBsZXQgY3VycmVudFkgPSBwb2ludFsxXTsKICAgICAgbGV0IG5leHRYID0gcG9pbnRzW25leHRJbmRleF1bMF07CiAgICAgIGxldCBuZXh0WSA9IHBvaW50c1tuZXh0SW5kZXhdWzFdOwogICAgICBsZXQgdmVjdG9yMCA9IFsKICAgICAgICAwLAogICAgICAgIDAsCiAgICAgICAgYm90dG9tQWx0aXR1ZGUgLSBpdGVtQWx0aXR1ZGUKICAgICAgXTsKICAgICAgbGV0IHZlY3RvcjEgPSBbCiAgICAgICAgbmV4dFggLSBjdXJyZW50WCwKICAgICAgICBuZXh0WSAtIGN1cnJlbnRZLAogICAgICAgIDAKICAgICAgXTsKICAgICAgbGV0IG5vcm1hbCA9IGNyb3NzVmVjdG9yczModmVjdG9yMCwgdmVjdG9yMSk7CiAgICAgIGlmICghbm9ybWFsWzBdICYmICFub3JtYWxbMV0gJiYgIW5vcm1hbFsyXSkgewogICAgICAgIG5vcm1hbCA9IFtub3JtYWxzW25vcm1hbHMubGVuZ3RoIC0gM10sIG5vcm1hbHNbbm9ybWFscy5sZW5ndGggLSAyXSwgbm9ybWFsc1tub3JtYWxzLmxlbmd0aCAtIDFdXTsKICAgICAgfQogICAgICBleHRydWRlTm9ybWFscy5wdXNoKAogICAgICAgIG5vcm1hbFswXSwKICAgICAgICBub3JtYWxbMV0sCiAgICAgICAgbm9ybWFsWzJdLAogICAgICAgIG5vcm1hbFswXSwKICAgICAgICBub3JtYWxbMV0sCiAgICAgICAgbm9ybWFsWzJdCiAgICAgICk7CiAgICAgIGxldCBpc0JvcmRlciA9IGZhbHNlOwogICAgICBpZiAoY3VycmVudFggPT09IG5leHRYKSB7CiAgICAgICAgaWYgKE1hdGguYWJzKGN1cnJlbnRYICsgMC41KSA8IERFTFRBIHx8IE1hdGguYWJzKGN1cnJlbnRYIC0gMC41KSA8IERFTFRBKSB7CiAgICAgICAgICBpc0JvcmRlciA9IHRydWU7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGN1cnJlbnRZID09PSBuZXh0WSkgewogICAgICAgIGlmIChNYXRoLmFicyhjdXJyZW50WSArIDAuNSkgPCBERUxUQSB8fCBNYXRoLmFicyhjdXJyZW50WSAtIDAuNSkgPCBERUxUQSkgewogICAgICAgICAgaXNCb3JkZXIgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIWlzQm9yZGVyKSB7CiAgICAgICAgaWYgKGkgPT09IGxhc3QgLSAxKSB7CiAgICAgICAgICBleHRydWRlSW5kaWNlcy5wdXNoKAogICAgICAgICAgICBpdGVtSW5kZXggKyBpICogMiwKICAgICAgICAgICAgaXRlbUluZGV4ICsgaSAqIDIgKyAxLAogICAgICAgICAgICBpdGVtSW5kZXgsCiAgICAgICAgICAgIGl0ZW1JbmRleCwKICAgICAgICAgICAgaXRlbUluZGV4ICsgaSAqIDIgKyAxLAogICAgICAgICAgICBpdGVtSW5kZXggKyAxCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBleHRydWRlSW5kaWNlcy5wdXNoKAogICAgICAgICAgICBpdGVtSW5kZXggKyBpICogMiwKICAgICAgICAgICAgaXRlbUluZGV4ICsgaSAqIDIgKyAxLAogICAgICAgICAgICBpdGVtSW5kZXggKyBpICogMiArIDIsCiAgICAgICAgICAgIGl0ZW1JbmRleCArIGkgKiAyICsgMiwKICAgICAgICAgICAgaXRlbUluZGV4ICsgaSAqIDIgKyAxLAogICAgICAgICAgICBpdGVtSW5kZXggKyBpICogMiArIDMKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIGZvciAobGV0IGkgPSAwOyBpIDwgdmVydGljZXMubGVuZ3RoOyBpICs9IDMpIHsKICAgIHZlcnRpY2VzW2kgKyAyXSA9IHZlcnRpY2VzW2kgKyAyXSAvIDEwMCAvIEFUVEFDSF9TQ0FMRTsKICB9CiAgcHJvamVjdFZlcnRpY2VzKHZlcnRpY2VzLCBjb25maWcpOwogIGlmIChpc0RlbGF5ICYmIGhhc0V4dHJ1ZGUpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZXh0cnVkZVZlcnRpY2VzLmxlbmd0aDsgaSArPSAzKSB7CiAgICAgIGV4dHJ1ZGVWZXJ0aWNlc1tpICsgMl0gPSBleHRydWRlVmVydGljZXNbaSArIDJdIC8gMTAwIC8gQVRUQUNIX1NDQUxFOwogICAgfQogICAgcHJvamVjdFZlcnRpY2VzKGV4dHJ1ZGVWZXJ0aWNlcywgY29uZmlnKTsKICAgIGNvbnN0IGRlbGF5T2JqZWN0ID0gewogICAgICB2ZXJ0aWNlczogZXh0cnVkZVZlcnRpY2VzLAogICAgICBpbmRpY2VzOiBleHRydWRlSW5kaWNlcywKICAgICAgbm9ybWFsczogZXh0cnVkZU5vcm1hbHMsCiAgICAgIGNvbG9yczogZXh0cnVkZUNvbG9ycywKICAgICAgbGF5ZXJJbmRpY2VzOiBleHRydWRlTGF5ZXJJbmRpY2VzCiAgICB9OwogICAgY29uc3Qgb2JqZWN0ID0gewogICAgICB2ZXJ0aWNlcywKICAgICAgaW5kaWNlcywKICAgICAgbm9ybWFscywKICAgICAgY29sb3JzLAogICAgICBsYXllckluZGljZXMKICAgIH07CiAgICByZXR1cm4gewogICAgICBkZWxheU9iamVjdCwKICAgICAgb2JqZWN0CiAgICB9OwogIH0KICByZXR1cm4gewogICAgdmVydGljZXMsCiAgICBpbmRpY2VzLAogICAgbm9ybWFscywKICAgIGNvbG9ycywKICAgIGxheWVySW5kaWNlcwogIH07Cn0KZnVuY3Rpb24gY3JlYXRlR3JhZGllbnRQb2x5Z29uKGdlb09iamVjdCwgc3RhcnRTdHlsZSwgZW5kU3R5bGUsIGNvbmZpZykgewogIGNvbnN0IG1pZFBvaW50cyA9IGdlb09iamVjdC5taWRQb2ludHM7CiAgbGV0IGdlb0luZGljZXMgPSBnZW9PYmplY3QuaW5kaWNlczsKICBjb25zdCB6dmVjdG9yID0gZ2VvT2JqZWN0Lnp2ZWN0b3I7CiAgY29uc3QgZ3JhZGllbnRQb3MgPSBnZW9PYmplY3QuZ3JhZGllbnRQb3M7CiAgaWYgKCFnZW9JbmRpY2VzIHx8ICFtaWRQb2ludHMpIHsKICAgIHJldHVybjsKICB9CiAgbGV0IGFsdGl0dWRlQXJyYXk7CiAgaWYgKHp2ZWN0b3IubGVuZ3RoID09PSAxICYmIHp2ZWN0b3JbMF0pIHsKICAgIGFsdGl0dWRlQXJyYXkgPSBuZXcgQXJyYXkobWlkUG9pbnRzLmxlbmd0aCAvIDIpOwogICAgYWx0aXR1ZGVBcnJheS5maWxsKHp2ZWN0b3JbMF0pOwogIH0gZWxzZSBpZiAoenZlY3Rvci5sZW5ndGggPiAxKSB7CiAgICBhbHRpdHVkZUFycmF5ID0gW107CiAgICBmb3IgKGxldCBrID0gMDsgayA8IHp2ZWN0b3IubGVuZ3RoOyBrKyspIHsKICAgICAgYWx0aXR1ZGVBcnJheVtrXSA9IHp2ZWN0b3Jba10gfHwgMTsKICAgIH0KICB9CiAgY29uc3QgdmVydGljZXMgPSBbXTsKICBjb25zdCBpbmRpY2VzID0gW107CiAgY29uc3Qgbm9ybWFscyA9IFtdOwogIGNvbnN0IGNvbG9ycyA9IFtdOwogIGNvbnN0IGxheWVySW5kaWNlcyA9IFtdOwogIGNvbnN0IGluZGljZXNPZmZzZXRTdGFydCA9IHZlcnRpY2VzLmxlbmd0aCAvIDM7CiAgbGV0IHBvaW50cyA9IHBhcnNlRmVhdHVyZShtaWRQb2ludHMpOwogIGNvbnN0IGdhcCA9IDEgLyAyNTY7CiAgY29uc3QgZ2FwTWluID0gLTAuNSArIGdhcDsKICBjb25zdCBnYXBNYXggPSAwLjUgLSBnYXA7CiAgbGV0IHRpbGVTaXplID0gZ2V0VGlsZU1heFZhbHVlQnlaKGNvbmZpZy56LCBjb25maWcpOwogIGNvbnN0IHN0YXJ0UHQgPSBbZ3JhZGllbnRQb3NbMF0gLyAxMDAsIGdyYWRpZW50UG9zWzFdIC8gMTAwXTsKICBjb25zdCBlbmRQdCA9IFtncmFkaWVudFBvc1syXSAvIDEwMCwgZ3JhZGllbnRQb3NbM10gLyAxMDBdOwogIGNvbnN0IHN0YXJ0Q29sb3IgPSBzdGFydFN0eWxlLmNvbG9yOwogIGNvbnN0IGVuZENvbG9yID0gZW5kU3R5bGUuY29sb3I7CiAgY29uc3QgdmVjR3JhZGllbnQgPSBbZW5kUHRbMF0gLSBzdGFydFB0WzBdLCBlbmRQdFsxXSAtIHN0YXJ0UHRbMV1dOwogIGNvbnN0IGRpc3RhbmNlID0gTWF0aC5zcXJ0KE1hdGgucG93KHZlY0dyYWRpZW50WzBdLCAyKSArIE1hdGgucG93KHZlY0dyYWRpZW50WzFdLCAyKSk7CiAgZm9yIChsZXQgaSA9IDAsIGwgPSBwb2ludHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBjb25zdCBlYWNoVmVydGV4ID0gcG9pbnRzW2ldOwogICAgbGV0IHg7CiAgICBsZXQgeTsKICAgIGlmICh2ZWNHcmFkaWVudFswXSA9PT0gMCkgewogICAgICB4ID0gc3RhcnRQdDsKICAgICAgeSA9IGVhY2hWZXJ0ZXhbMV07CiAgICB9IGVsc2UgewogICAgICBjb25zdCBrayA9IC0oKHN0YXJ0UHRbMF0gLSBlYWNoVmVydGV4WzBdKSAqIHZlY0dyYWRpZW50WzBdICsgKHN0YXJ0UHRbMV0gLSBlYWNoVmVydGV4WzFdKSAqIHZlY0dyYWRpZW50WzFdKSAvICh2ZWNHcmFkaWVudFswXSAqIHZlY0dyYWRpZW50WzBdICsgdmVjR3JhZGllbnRbMV0gKiB2ZWNHcmFkaWVudFsxXSk7CiAgICAgIHggPSBrayAqIHZlY0dyYWRpZW50WzBdICsgc3RhcnRQdFswXTsKICAgICAgeSA9IGtrICogdmVjR3JhZGllbnRbMV0gKyBzdGFydFB0WzFdOwogICAgfQogICAgY29uc3QgY3VyRGlzdGFuY2UgPSBNYXRoLnNxcnQoTWF0aC5wb3coeCAtIGVuZFB0WzBdLCAyKSArIE1hdGgucG93KHkgLSBlbmRQdFsxXSwgMikpOwogICAgbGV0IHBlcmNlbnRhZ2UgPSBjdXJEaXN0YW5jZSAvIGRpc3RhbmNlOwogICAgaWYgKHN0YXJ0UHRbMF0gPCBlbmRQdFswXSAmJiB4IDwgc3RhcnRQdFswXSB8fCBzdGFydFB0WzBdID4gZW5kUHRbMF0gJiYgeCA+IHN0YXJ0UHRbMF0pIHsKICAgICAgcGVyY2VudGFnZSA9IDE7CiAgICB9IGVsc2UgaWYgKHN0YXJ0UHRbMF0gPCBlbmRQdFswXSAmJiB4ID4gZW5kUHRbMF0gfHwgc3RhcnRQdFswXSA+IGVuZFB0WzBdICYmIHggPCBlbmRQdFswXSkgewogICAgICBwZXJjZW50YWdlID0gMDsKICAgIH0KICAgIGNvbnN0IGN1ckNvbG9yUiA9IHBlcmNlbnRhZ2UgKiBzdGFydENvbG9yWzBdICsgKDEgLSBwZXJjZW50YWdlKSAqIGVuZENvbG9yWzBdOwogICAgY29uc3QgY3VyQ29sb3JHID0gcGVyY2VudGFnZSAqIHN0YXJ0Q29sb3JbMV0gKyAoMSAtIHBlcmNlbnRhZ2UpICogZW5kQ29sb3JbMV07CiAgICBjb25zdCBjdXJDb2xvckIgPSBwZXJjZW50YWdlICogc3RhcnRDb2xvclsyXSArICgxIC0gcGVyY2VudGFnZSkgKiBlbmRDb2xvclsyXTsKICAgIG5vcm1hbGl6ZVZlcnRleChlYWNoVmVydGV4LCB0aWxlU2l6ZSwgZ2FwTWluLCBnYXBNYXgpOwogICAgY29uc3QgaXRlbUFsdGl0dWRlID0gYWx0aXR1ZGVBcnJheSA/IGFsdGl0dWRlQXJyYXlbaV0gLyAxMDAgLyBBVFRBQ0hfU0NBTEUgOiBMQU5EX09GRlNFVFo7CiAgICB2ZXJ0aWNlcy5wdXNoKGVhY2hWZXJ0ZXhbMF0sIGVhY2hWZXJ0ZXhbMV0sIGl0ZW1BbHRpdHVkZSk7CiAgICBjb2xvcnMucHVzaChjdXJDb2xvclIsIGN1ckNvbG9yRywgY3VyQ29sb3JCKTsKICAgIG5vcm1hbHMucHVzaCgwLCAwLCAxKTsKICAgIGxheWVySW5kaWNlcy5wdXNoKGxheWVySW5kZXgpOwogIH0KICBmb3IgKGxldCBpID0gMCwgbGVuZ3RoID0gZ2VvSW5kaWNlcy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgaW5kaWNlcy5wdXNoKGluZGljZXNPZmZzZXRTdGFydCArIGdlb0luZGljZXNbaV0pOwogIH0KICBwcm9qZWN0VmVydGljZXModmVydGljZXMsIGNvbmZpZyk7CiAgcmV0dXJuIHsKICAgIHZlcnRpY2VzLAogICAgaW5kaWNlcywKICAgIG5vcm1hbHMsCiAgICBjb2xvcnMsCiAgICBsYXllckluZGljZXMKICB9Owp9CmZ1bmN0aW9uIGVuY29kZUNvbmNhdmUoaXNHcm91bmQsIGlzQ29uY2F2ZSwgaXNTdGFydCkgewogIGxldCBlbmNvZGVkID0gMDsKICBpc0dyb3VuZCAmJiAoZW5jb2RlZCB8PSAxKTsKICBpc0NvbmNhdmUgJiYgKGVuY29kZWQgfD0gMik7CiAgaXNTdGFydCAmJiAoZW5jb2RlZCB8PSA0KTsKICByZXR1cm4gZW5jb2RlZDsKfQpmdW5jdGlvbiBjcmVhdGVCdWlsZGluZzNkKGdlb09iamVjdCwgdG9wQ29sb3IsIGJvZHlDb2xvciwgY29uZmlnKSB7CiAgY29uc3QgbWlkUG9pbnRzID0gZ2VvT2JqZWN0Lm1pZFBvaW50czsKICBjb25zdCBnZW9JbmRpY2VzID0gZ2VvT2JqZWN0LmluZGljZXM7CiAgY29uc3QgYWx0aXR1ZGUgPSBnZW9PYmplY3QuYWx0aXR1ZGUgLyBBVFRBQ0hfU0NBTEU7CiAgaWYgKCFnZW9JbmRpY2VzIHx8ICFtaWRQb2ludHMpIHsKICAgIHJldHVybjsKICB9CiAgY29uc3QgdmVydGljZXMgPSBbXTsKICBjb25zdCBpbmRpY2VzID0gW107CiAgY29uc3Qgbm9ybWFscyA9IFtdOwogIGNvbnN0IGNvbG9ycyA9IFtdOwogIGNvbnN0IGhlaWdodEFuZENvbmNhdmVzID0gW107CiAgY29uc3QgcG9pbnRzID0gcGFyc2VNaWRQb2ludHMobWlkUG9pbnRzLCBhbHRpdHVkZSArIExBTkRfT0ZGU0VUWiwgY29uZmlnKTsKICBsZXQgcG9pbnQgPSBudWxsOwogIGZvciAobGV0IGkgPSAwLCBsYXN0ID0gcG9pbnRzLmxlbmd0aDsgaSA8IGxhc3Q7IGkgKz0gMSkgewogICAgcG9pbnQgPSBwb2ludHNbaV07CiAgICB2ZXJ0aWNlcy5wdXNoKHBvaW50WzBdLCBwb2ludFsxXSwgcG9pbnRbMl0pOwogICAgbm9ybWFscy5wdXNoKDAsIDAsIDEpOwogICAgY29sb3JzLnB1c2godG9wQ29sb3JbMF0sIHRvcENvbG9yWzFdLCB0b3BDb2xvclsyXSk7CiAgICBoZWlnaHRBbmRDb25jYXZlcy5wdXNoKHBvaW50WzJdLCBlbmNvZGVDb25jYXZlKGZhbHNlLCBmYWxzZSwgZmFsc2UpKTsKICB9CiAgZm9yIChsZXQgaSA9IDAsIGxlbmd0aDIgPSBnZW9JbmRpY2VzLmxlbmd0aDsgaSA8IGxlbmd0aDI7IGkrKykgewogICAgaW5kaWNlcy5wdXNoKGdlb0luZGljZXNbaV0pOwogIH0KICBjb25zdCBpbmRpY2VzT2Zmc2V0U3RhcnQgPSB2ZXJ0aWNlcy5sZW5ndGggLyAzOwogIGNvbnN0IGlzQ2xvc2VkUG9pbnRzID0gaXNDbG9zZWQocG9pbnRzKTsKICBjb25zdCBsZW5ndGggPSBpc0Nsb3NlZFBvaW50cyA/IHBvaW50cy5sZW5ndGggLSAxIDogcG9pbnRzLmxlbmd0aDsKICBmb3IgKGxldCBpID0gMCwgbGFzdCA9IGxlbmd0aDsgaSA8IGxhc3Q7IGkgKz0gMSkgewogICAgbGV0IHBvaW50MCA9IFtwb2ludHNbaV1bMF0sIHBvaW50c1tpXVsxXSwgTEFORF9PRkZTRVRaXTsKICAgIGxldCBwb2ludDEgPSBbcG9pbnRzW2ldWzBdLCBwb2ludHNbaV1bMV0sIHBvaW50c1tpXVsyXV07CiAgICBsZXQgbmV4dEluZGV4ID0gaSArIDE7CiAgICBpZiAoaSA9PT0gbGFzdCAtIDEpIHsKICAgICAgbmV4dEluZGV4ID0gMDsKICAgIH0KICAgIGxldCBuZXh0MCA9IFtwb2ludHNbbmV4dEluZGV4XVswXSwgcG9pbnRzW25leHRJbmRleF1bMV0sIExBTkRfT0ZGU0VUWl07CiAgICBsZXQgbmV4dDEgPSBbcG9pbnRzW25leHRJbmRleF1bMF0sIHBvaW50c1tuZXh0SW5kZXhdWzFdLCBwb2ludHNbbmV4dEluZGV4XVsyXV07CiAgICBsZXQgcHJldkluZGV4ID0gaSA9PT0gMCA/IGxhc3QgLSAxIDogaSAtIDE7CiAgICBsZXQgcHJldjAgPSBbcG9pbnRzW3ByZXZJbmRleF1bMF0sIHBvaW50c1twcmV2SW5kZXhdWzFdLCBMQU5EX09GRlNFVFpdOwogICAgbGV0IHZlY3RvcjAgPSBbCiAgICAgIG5leHQwWzBdIC0gcG9pbnQwWzBdLAogICAgICBuZXh0MFsxXSAtIHBvaW50MFsxXSwKICAgICAgbmV4dDBbMl0gLSBwb2ludDBbMl0KICAgIF07CiAgICBsZXQgdmVjdG9yMSA9IFsKICAgICAgcG9pbnQxWzBdIC0gcG9pbnQwWzBdLAogICAgICBwb2ludDFbMV0gLSBwb2ludDBbMV0sCiAgICAgIHBvaW50MVsyXSAtIHBvaW50MFsyXQogICAgXTsKICAgIGxldCBub3JtYWwgPSBjcm9zc1ZlY3RvcnMzKHZlY3RvcjAsIHZlY3RvcjEpOwogICAgdmVydGljZXMucHVzaCgKICAgICAgcG9pbnQwWzBdLAogICAgICBwb2ludDBbMV0sCiAgICAgIHBvaW50MFsyXSwKICAgICAgcG9pbnQxWzBdLAogICAgICBwb2ludDFbMV0sCiAgICAgIHBvaW50MVsyXSwKICAgICAgbmV4dDBbMF0sCiAgICAgIG5leHQwWzFdLAogICAgICBuZXh0MFsyXSwKICAgICAgbmV4dDFbMF0sCiAgICAgIG5leHQxWzFdLAogICAgICBuZXh0MVsyXQogICAgKTsKICAgIG5vcm1hbHMucHVzaCgKICAgICAgbm9ybWFsWzBdLAogICAgICBub3JtYWxbMV0sCiAgICAgIG5vcm1hbFsyXSwKICAgICAgbm9ybWFsWzBdLAogICAgICBub3JtYWxbMV0sCiAgICAgIG5vcm1hbFsyXSwKICAgICAgbm9ybWFsWzBdLAogICAgICBub3JtYWxbMV0sCiAgICAgIG5vcm1hbFsyXSwKICAgICAgbm9ybWFsWzBdLAogICAgICBub3JtYWxbMV0sCiAgICAgIG5vcm1hbFsyXQogICAgKTsKICAgIGNvbG9ycy5wdXNoKAogICAgICBib2R5Q29sb3JbMF0sCiAgICAgIGJvZHlDb2xvclsxXSwKICAgICAgYm9keUNvbG9yWzJdLAogICAgICBib2R5Q29sb3JbMF0sCiAgICAgIGJvZHlDb2xvclsxXSwKICAgICAgYm9keUNvbG9yWzJdLAogICAgICBib2R5Q29sb3JbMF0sCiAgICAgIGJvZHlDb2xvclsxXSwKICAgICAgYm9keUNvbG9yWzJdLAogICAgICBib2R5Q29sb3JbMF0sCiAgICAgIGJvZHlDb2xvclsxXSwKICAgICAgYm9keUNvbG9yWzJdCiAgICApOwogICAgbGV0IGlzQ29uY2F2ZSA9IGlzQU9Db25jYXZlQW5nbGUocHJldjAsIHBvaW50MCwgbmV4dDApOwogICAgaWYgKGkgPT09IDApIHsKICAgICAgaGVpZ2h0QW5kQ29uY2F2ZXMucHVzaCgKICAgICAgICAwLAogICAgICAgIGVuY29kZUNvbmNhdmUodHJ1ZSwgaXNDb25jYXZlLCBmYWxzZSksCiAgICAgICAgcG9pbnQxWzJdLAogICAgICAgIGVuY29kZUNvbmNhdmUoZmFsc2UsIGlzQ29uY2F2ZSwgZmFsc2UpCiAgICAgICk7CiAgICB9IGVsc2UgewogICAgICBoZWlnaHRBbmRDb25jYXZlcy5wdXNoKAogICAgICAgIDAsCiAgICAgICAgZW5jb2RlQ29uY2F2ZSh0cnVlLCBpc0NvbmNhdmUsIHRydWUpLAogICAgICAgIHBvaW50MVsyXSwKICAgICAgICBlbmNvZGVDb25jYXZlKGZhbHNlLCBpc0NvbmNhdmUsIHRydWUpLAogICAgICAgIDAsCiAgICAgICAgZW5jb2RlQ29uY2F2ZSh0cnVlLCBpc0NvbmNhdmUsIGZhbHNlKSwKICAgICAgICBwb2ludDFbMl0sCiAgICAgICAgZW5jb2RlQ29uY2F2ZShmYWxzZSwgaXNDb25jYXZlLCBmYWxzZSkKICAgICAgKTsKICAgIH0KICAgIGlmIChpID09PSBsYXN0IC0gMSkgewogICAgICBpc0NvbmNhdmUgPSBpc0FPQ29uY2F2ZUFuZ2xlKHBvaW50MCwgbmV4dDAsIHBvaW50c1tuZXh0SW5kZXggKyAxXSk7CiAgICAgIGhlaWdodEFuZENvbmNhdmVzLnB1c2goCiAgICAgICAgMCwKICAgICAgICBlbmNvZGVDb25jYXZlKHRydWUsIGlzQ29uY2F2ZSwgdHJ1ZSksCiAgICAgICAgcG9pbnQxWzJdLAogICAgICAgIGVuY29kZUNvbmNhdmUoZmFsc2UsIGlzQ29uY2F2ZSwgdHJ1ZSkKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IGNvdW50ID0gaW5kaWNlc09mZnNldFN0YXJ0ICsgaSAqIDQ7CiAgICBpbmRpY2VzLnB1c2goCiAgICAgIGNvdW50LAogICAgICBjb3VudCArIDIsCiAgICAgIGNvdW50ICsgMywKICAgICAgY291bnQsCiAgICAgIGNvdW50ICsgMywKICAgICAgY291bnQgKyAxCiAgICApOwogIH0KICBwcm9qZWN0VmVydGljZXModmVydGljZXMsIGNvbmZpZyk7CiAgcmV0dXJuIHsKICAgIHZlcnRpY2VzLAogICAgaW5kaWNlcywKICAgIG5vcm1hbHMsCiAgICBjb2xvcnMsCiAgICBoZWlnaHRBbmRDb25jYXZlcwogIH07Cn0KZnVuY3Rpb24gZ2V0SWNvblZlcnRleERhdGEoaWNvbk5hbWUsIGljb25ab29tKSB7CiAgY29uc3QgaWNvbkluZm8gPSBnZXRJY29uSW5mbyhpY29uTmFtZSk7CiAgaWYgKCFpY29uSW5mbykgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGNvbnN0IHJhdGlvID0gMjsKICBjb25zdCBpY29uV2lkdGggPSBpY29uSW5mb1swXSAvIHJhdGlvICogaWNvblpvb207CiAgY29uc3QgaWNvbkhlaWdodCA9IGljb25JbmZvWzFdIC8gcmF0aW8gKiBpY29uWm9vbTsKICBjb25zdCB4MCA9IE1hdGgucm91bmQoLWljb25XaWR0aCAvIDIpOwogIGNvbnN0IHkwID0gTWF0aC5yb3VuZCgtaWNvbkhlaWdodCAvIDIpOwogIGNvbnN0IHgxID0geDAgKyBpY29uV2lkdGg7CiAgY29uc3QgeTEgPSB5MDsKICBjb25zdCB4MiA9IHgxOwogIGNvbnN0IHkyID0geTEgKyBpY29uSGVpZ2h0OwogIGNvbnN0IHgzID0geDA7CiAgY29uc3QgeTMgPSB5MjsKICByZXR1cm4gewogICAgInZlcnRleCI6IFt4MCwgeTAsIHgxLCB5MSwgeDIsIHkyLCB4MCwgeTAsIHgyLCB5MiwgeDMsIHkzXSwKICAgICJ0ZXhjb29yZCI6IG51bGwsCiAgICAid2lkdGgiOiBpY29uV2lkdGgsCiAgICAiaGVpZ2h0IjogaWNvbkhlaWdodCwKICAgICJpY29uVHlwZSI6IGljb25OYW1lCiAgfTsKfQpmdW5jdGlvbiBnZXRJY29uSW5mbyhpY29uTmFtZSkgewogIGlmICghaWNvbk5hbWUpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBpZiAoaWNvbk5hbWUgPT09ICJkaXNla29uZyIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBsZXQgaWNvbkluZm8gPSBzZWxmLmljb25TZXRJbmZvW2ljb25OYW1lXSB8fCBzZWxmLmljb25TZXRJbmZvWyJNYXBSZXMvIiArIGljb25OYW1lXTsKICBpZiAoIWljb25JbmZvICYmIGljb25OYW1lKSB7CiAgICBpZiAoaWNvbk5hbWUuY2hhckNvZGVBdCgwKSA+PSA0OCAmJiBpY29uTmFtZS5jaGFyQ29kZUF0KDApIDw9IDU3KSB7CiAgICAgIGljb25JbmZvID0gc2VsZi5pY29uU2V0SW5mb1siXyIgKyBpY29uTmFtZV07CiAgICB9CiAgfQogIHJldHVybiBpY29uSW5mbzsKfQpmdW5jdGlvbiBjb252ZXJ0UE9JUG9zaXRpb24oeCwgeSwgeiwgY29uZmlnLCBvdXRwdXQpIHsKICBjb25zdCBzY2FsZSA9IDEwMDsKICBsZXQgbWN4ID0gTWF0aC5yb3VuZCh4IC8gc2NhbGUpOwogIGxldCBtY3kgPSBNYXRoLnJvdW5kKHkgLyBzY2FsZSk7CiAgY29uc3QgdGlsZVNpemUgPSBnZXRUaWxlU2l6ZUJ5Wihjb25maWcueiwgY29uZmlnKTsKICBfcG9pbnRJbi54ID0gbWN4IC8gdGlsZVNpemUgLSAwLjU7CiAgX3BvaW50SW4ueSA9IG1jeSAvIHRpbGVTaXplIC0gMC41OwogIF9wb2ludEluLnogPSB6IHx8IDA7CiAgdGlsZU5vcm1hbGl6ZWRQb3NpdGlvblRvTWV0ZXIoX3BvaW50SW4sIGNvbmZpZywgX3BvaW50T3V0KTsKICBpZiAoIWNvbmZpZy5pc05vcm1hbGl6ZWQpIHsKICAgIGNvbmZpZy5zb3VyY2VQcm9qZWN0aW9uLnVucHJvamVjdENvb3JkaW5hdGUoX3BvaW50T3V0LCBfcG9pbnRJbik7CiAgICBjb25maWcudGFyZ2V0UHJvamVjdGlvbi5wcm9qZWN0Q29vcmRpbmF0ZShfcG9pbnRJbiwgX3BvaW50T3V0KTsKICB9CiAgb3V0cHV0WzBdID0gX3BvaW50T3V0Lng7CiAgb3V0cHV0WzFdID0gX3BvaW50T3V0Lnk7CiAgb3V0cHV0WzJdID0gX3BvaW50T3V0Lno7CiAgcmV0dXJuIG91dHB1dDsKfQpmdW5jdGlvbiBjcmVhdGVQT0koZ2VvT2JqZWN0LCBzdHlsZUlkLCBjb25maWcsIHN0eWxlQ29uZmlnKSB7CiAgY29uc3Qgc3R5bGVUZXh0ID0gc3R5bGVDb25maWcuc3R5bGVUZXh0OwogIGNvbnN0IHRleHQgPSBnZW9PYmplY3QubmFtZTsKICBjb25zdCBkaXJlY3Rpb24gPSBnZW9PYmplY3QuZGlyZWN0aW9uOwogIGxldCBpY29uOwogIGxldCBpY29uUG9zOwogIGxldCBpY29uV2lkdGggPSAwOwogIGxldCBpY29uSGVpZ2h0ID0gMDsKICBsZXQgdGV4dERyYXdPbkljb24gPSBmYWxzZTsKICBjb25zdCBoYXNUZXh0ID0gdGV4dCAhPT0gIiIgJiYgISFzdHlsZVRleHQ7CiAgaWYgKHN0eWxlQ29uZmlnLnN0eWxlUHQpIHsKICAgIGxldCBpY29uWm9vbSA9IChzdHlsZUNvbmZpZy5zdHlsZVB0Lnpvb20gfHwgMTAwKSAvIDEwMDsKICAgIGNvbnN0IHN0eWxlUHQgPSBzdHlsZUNvbmZpZy5zdHlsZVB0OwogICAgaWNvbiA9IHN0eWxlUHQuaWNvbjsKICAgIGNvbnN0IGljb25JbmZvID0gZ2V0SWNvbkluZm8oaWNvbik7CiAgICB0ZXh0RHJhd09uSWNvbiA9ICEhKGRpcmVjdGlvbiA9PT0gUE9JX0lDT05fRElSX0NFTlRFUiAmJiBoYXNUZXh0ICYmIGljb25JbmZvKTsKICAgIGlmIChpY29uICE9PSBudWxsICYmICF0ZXh0RHJhd09uSWNvbikgewogICAgICBpY29uUG9zID0gZ2V0SWNvblZlcnRleERhdGEoaWNvbiwgaWNvblpvb20pOwogICAgICBpZiAoaWNvblBvcykgewogICAgICAgIGljb25XaWR0aCA9IGljb25Qb3Mud2lkdGg7CiAgICAgICAgaWNvbkhlaWdodCA9IGljb25Qb3MuaGVpZ2h0OwogICAgICB9CiAgICB9IGVsc2UgaWYgKGljb25JbmZvKSB7CiAgICAgIGljb25XaWR0aCA9IGljb25JbmZvWzBdOwogICAgICBpY29uSGVpZ2h0ID0gaWNvbkluZm9bMV07CiAgICB9CiAgfQogIHN0eWxlQ29uZmlnID0gc3R5bGVDb25maWcuc3R5bGVUZXh0OwogIGxldCBwb3NpdGlvbiA9IFswLCAwLCAwXTsKICBwb3NpdGlvbiA9IGNvbnZlcnRQT0lQb3NpdGlvbihnZW9PYmplY3QucG9zeCwgZ2VvT2JqZWN0LnBvc3ksIHNlbGYuekluZGV4LCBjb25maWcsIHBvc2l0aW9uKTsKICByZXR1cm4gewogICAgcG9zaXRpb24sCiAgICB0ZXh0OiBnZW9PYmplY3QubmFtZSwKICAgIHN0eWxlSWQsCiAgICBzdHlsZUNvbmZpZywKICAgIGljb25Db25maWc6IHsKICAgICAgaWNvbiwKICAgICAgcG9zOiBpY29uUG9zLAogICAgICBzaXplOiBbaWNvbldpZHRoLCBpY29uSGVpZ2h0XSwKICAgICAgdGV4dERyYXdPbkljb24KICAgIH0sCiAgICBoYXNUZXh0LAogICAgLi4uZ2VvT2JqZWN0CiAgfTsKfQpmdW5jdGlvbiBjcmVhdGVMYWJlbFBvaShwb2lzLCBsYWJlbCwgdXNlWm9vbSwgY29uZmlnLCBzdHlsZUNvbmZpZykgewogIGNvbnN0IHNjYWxlID0gMTAwICogQVRUQUNIX1NDQUxFOwogIGNvbnN0IGNvb3JkQ291bnQgPSAyOwogIGxldCB3b3JkQ291bnQgPSBsYWJlbC5uYW1lTGVuIHx8IGxhYmVsLm5hbWUuc3BsaXQoIiIpLmxlbmd0aDsKICBpZiAod29yZENvdW50ID09PSAwKSB7CiAgICByZXR1cm47CiAgfQogIGxldCB6VmVjdG9yID0gbGFiZWwuenZlY3RvcjsKICBsZXQgbGFiZWxQb3MgPSBsYWJlbC54OwogIGxldCByZXZlcnNlcyA9IGxhYmVsLnJldmVyc2U7CiAgbGV0IHRyYWNlcnMgPSBsYWJlbC50cmFjZXI7CiAgbGV0IGNvdW50ID0gdHJhY2Vycy5sZW5ndGg7CiAgbGV0IGxhYmVsUG9zWiA9IFt6VmVjdG9yWzBdXTsKICBsZXQgcHJvY2Vzc2VkTGFiZWxQb3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChsYWJlbFBvcy5zbGljZSgwLCBjb29yZENvdW50KSk7CiAgZm9yIChsZXQgayA9IGNvb3JkQ291bnQsIGxheWVySW5kaWNlcyA9IDE7IGsgPCBsYWJlbFBvcy5sZW5ndGg7IGsgKz0gY29vcmRDb3VudCwgbGF5ZXJJbmRpY2VzKyspIHsKICAgIHByb2Nlc3NlZExhYmVsUG9zW2tdID0gcHJvY2Vzc2VkTGFiZWxQb3NbayAtIGNvb3JkQ291bnRdICsgbGFiZWxQb3Nba107CiAgICBwcm9jZXNzZWRMYWJlbFBvc1trICsgMV0gPSBwcm9jZXNzZWRMYWJlbFBvc1trIC0gKGNvb3JkQ291bnQgLSAxKV0gKyBsYWJlbFBvc1trICsgMV07CiAgICBpZiAoelZlY3Rvci5sZW5ndGggPT09IDEpIHsKICAgICAgbGFiZWxQb3NaW2xheWVySW5kaWNlc10gPSB6VmVjdG9yWzBdOwogICAgfSBlbHNlIGlmICh6VmVjdG9yLmxlbmd0aCA+IDEpIHsKICAgICAgbGFiZWxQb3NaW2xheWVySW5kaWNlc10gPSBsYWJlbFBvc1pbbGF5ZXJJbmRpY2VzIC0gMV0gKyB6VmVjdG9yW2xheWVySW5kaWNlc107CiAgICB9CiAgfQogIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgbGV0IHRyYWNlciA9IHRyYWNlcnNbaV07CiAgICBsZXQgcmV2ZXJzZSA9IHJldmVyc2VzW2ldOwogICAgaWYgKCFpc1Zpc2libGUodHJhY2VyLCBjb25maWcpKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQogICAgbGV0IHN0YXJ0SW5kZXggPSBpICogd29yZENvdW50ICogY29vcmRDb3VudDsKICAgIGxhYmVsUG9zID0gcHJvY2Vzc2VkTGFiZWxQb3Muc2xpY2Uoc3RhcnRJbmRleCwgc3RhcnRJbmRleCArIHdvcmRDb3VudCAqIGNvb3JkQ291bnQpOwogICAgbGV0IHogPSAwOwogICAgaWYgKHpWZWN0b3IubGVuZ3RoID4gMCkgewogICAgICB6ID0gbGFiZWxQb3NaW2kgKiB3b3JkQ291bnRdIC8gc2NhbGU7CiAgICB9CiAgICBsZXQgcG9zaXRpb24gPSBbMCwgMCwgMF07CiAgICBwb3NpdGlvbiA9IGNvbnZlcnRQT0lQb3NpdGlvbihsYWJlbFBvc1swXSwgbGFiZWxQb3NbMV0sIHogKyAoc2VsZi56SW5kZXggfHwgMCksIGNvbmZpZywgcG9zaXRpb24pOwogICAgbGV0IHhEaWZmID0gbGFiZWxQb3NbKHdvcmRDb3VudCAtIDEpICogY29vcmRDb3VudF0gLSBsYWJlbFBvc1swXTsKICAgIGxldCB5RGlmZiA9IGxhYmVsUG9zWyh3b3JkQ291bnQgLSAxKSAqIGNvb3JkQ291bnQgKyAxXSAtIGxhYmVsUG9zWzFdOwogICAgbGV0IHJvdGF0ZVogPSBNYXRoLmF0YW4yKC15RGlmZiwgLXhEaWZmKSArIE1hdGguUEk7CiAgICBpZiAocmV2ZXJzZSA9PT0gMSkgewogICAgICByb3RhdGVaICs9IE1hdGguUEk7CiAgICB9CiAgICBwb2lzLnB1c2goewogICAgICB0eXBlOiAibGFiZWxwIiwKICAgICAgcG9zaXRpb24sCiAgICAgIHRleHQ6IGxhYmVsLm5hbWUsCiAgICAgIHJvdGF0ZVosCiAgICAgIHN0eWxlQ29uZmlnLAogICAgICBoYXNUZXh0OiB0cnVlLAogICAgICAuLi5sYWJlbAogICAgfSk7CiAgfQp9CmZ1bmN0aW9uIHBhcnNlRmVhdHVyZShtaWRQb2ludHMsIGRpbSkgewogIGRpbSA9IGRpbSB8fCAyOwogIGxldCBvZmZzZXRBcnJheSA9IG5ldyBBcnJheShkaW0pLmZpbGwoMCk7CiAgY29uc3QgcmVzdWx0ID0gW107CiAgZm9yIChsZXQgaSA9IDAsIGxhc3QgPSBtaWRQb2ludHMubGVuZ3RoIC0gKGRpbSAtIDEpOyBpIDwgbGFzdDsgaSArPSBkaW0pIHsKICAgIGNvbnN0IHZhbHVlcyA9IFtdOwogICAgZm9yIChsZXQgaiA9IDA7IGogPCBkaW07IGorKykgewogICAgICBvZmZzZXRBcnJheVtqXSArPSBtaWRQb2ludHNbaSArIGpdOwogICAgICB2YWx1ZXMucHVzaChvZmZzZXRBcnJheVtqXSAvIDEwMCk7CiAgICB9CiAgICBpZiAoZGltID4gMSkgewogICAgICByZXN1bHQucHVzaCh2YWx1ZXMpOwogICAgfSBlbHNlIHsKICAgICAgcmVzdWx0LnB1c2godmFsdWVzWzBdKTsKICAgIH0KICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiBwYXJzZU1pZFBvaW50cyhtaWRQb2ludHMsIHogPSAwLCBjb25maWcpIHsKICBjb25zdCBnYXAgPSAxIC8gMjU2OwogIGNvbnN0IGdhcE1pbiA9IC0wLjUgKyBnYXA7CiAgY29uc3QgZ2FwTWF4ID0gMC41IC0gZ2FwOwogIGxldCB0aWxlU2l6ZSA9IGdldFRpbGVNYXhWYWx1ZUJ5Wihjb25maWcueiwgY29uZmlnKTsKICBsZXQgcHR4ID0gMDsKICBsZXQgcHR5ID0gMDsKICBsZXQgbnggPSAwOwogIGxldCBueSA9IDA7CiAgY29uc3QgcmVzdWx0ID0gW107CiAgZm9yIChsZXQgaSA9IDAsIGxhc3QgPSBtaWRQb2ludHMubGVuZ3RoIC0gMTsgaSA8IGxhc3Q7IGkgKz0gMikgewogICAgcHR4ICs9IG1pZFBvaW50c1tpXTsKICAgIHB0eSArPSBtaWRQb2ludHNbaSArIDFdOwogICAgbnggPSBwdHggLyB0aWxlU2l6ZSAtIDAuNTsKICAgIG55ID0gcHR5IC8gdGlsZVNpemUgLSAwLjU7CiAgICBpZiAoc2VsZi5pc0F0dGFjaCkgewogICAgICBpZiAobnggPCBnYXBNaW4pIHsKICAgICAgICBueCA9IC0wLjU7CiAgICAgIH0KICAgICAgaWYgKG54ID4gZ2FwTWF4KSB7CiAgICAgICAgbnggPSAwLjU7CiAgICAgIH0KICAgICAgaWYgKG55IDwgZ2FwTWluKSB7CiAgICAgICAgbnkgPSAtMC41OwogICAgICB9CiAgICAgIGlmIChueSA+IGdhcE1heCkgewogICAgICAgIG55ID0gMC41OwogICAgICB9CiAgICB9CiAgICByZXN1bHQucHVzaChbbngsIG55LCB6XSk7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0Kc2VsZi5oYW5kbGVDaGFuZ2VTdHlsZSA9IChtZXNzYWdlRGF0YSkgPT4gewogIHNlbGYuZmVhdHVyZVN0eWxlcyA9IG1lc3NhZ2VEYXRhLmZlYXR1cmVTdHlsZXM7CiAgc2VsZi5jYWNoZWRTdHlsZXMgPSB7fTsKfTsKc2VsZi5oYW5kbGVDaGFuZ2VJY29uU2V0SW5mbyA9IChtZXNzYWdlRGF0YSkgPT4gewogIHNlbGYuaWNvblNldEluZm8gPSBtZXNzYWdlRGF0YS5pY29uU2V0SW5mbzsKfTsKZnVuY3Rpb24gZ2V0U3R5bGVDb25maWcoY2F0YWxvZ1R5cGUsIHN0eWxlSWQsIHpvb20sIHN0eWxlVHlwZSA9IFBPTFlHT05fU1RZTEUsIHRpbGVDb25maWcpIHsKICBjb25zdCB6b29tU3R5bGVzID0gc2VsZi5mZWF0dXJlU3R5bGVzWzFdOwogIGNvbnN0IGRyYXdTdHlsZXMgPSBzZWxmLmZlYXR1cmVTdHlsZXNbMl07CiAgem9vbSArPSB0aWxlQ29uZmlnLndvcmtlck9wdGlvbnMuc3R5bGVab29tT2Zmc2V0IHx8IDA7CiAgaWYgKHN0eWxlVHlwZSA9PT0gUE9JTlRfVEVYVF9TVFlMRSAmJiB6b29tID09PSA5KSB7CiAgICB6b29tID0gODsKICB9CiAgbGV0IGN1cnJlbnRab29tU3R5bGVzID0gem9vbVN0eWxlc1t6b29tXVswXTsKICBpZiAoIWN1cnJlbnRab29tU3R5bGVzKSB7CiAgICByZXR1cm47CiAgfQogIGxldCBzdHlsZURyYXdzID0gY3VycmVudFpvb21TdHlsZXNbc3R5bGVJZF07CiAgaWYgKCFzdHlsZURyYXdzICYmIChzdHlsZVR5cGUgPT09IFBPSU5UX1RFWFRfU1RZTEUgfHwgc3R5bGVUeXBlID09PSBQT0xZR09OM0RfU1RZTEUpKSB7CiAgICBjdXJyZW50Wm9vbVN0eWxlcyA9IHpvb21TdHlsZXNbem9vbSArIDFdICYmIHpvb21TdHlsZXNbem9vbSArIDFdWzBdOwogICAgc3R5bGVEcmF3cyA9IGN1cnJlbnRab29tU3R5bGVzICYmIGN1cnJlbnRab29tU3R5bGVzW3N0eWxlSWRdOwogIH0KICBpZiAoIXN0eWxlRHJhd3MpIHsKICAgIHJldHVybjsKICB9CiAgbGV0IGRyYXdJZDsKICBsZXQgZHJhd1N0eWxlOwogIGZvciAobGV0IGkgPSAwOyBpIDwgc3R5bGVEcmF3cy5sZW5ndGg7IGkrKykgewogICAgZHJhd0lkID0gc3R5bGVEcmF3c1tpXTsKICAgIGlmIChzZWxmLmNhY2hlZFN0eWxlc1tgJHtjYXRhbG9nVHlwZX1fJHtzdHlsZVR5cGV9XyR7ZHJhd0lkfWBdKSB7CiAgICAgIHJldHVybiBzZWxmLmNhY2hlZFN0eWxlc1tgJHtjYXRhbG9nVHlwZX1fJHtzdHlsZVR5cGV9XyR7ZHJhd0lkfWBdOwogICAgfQogICAgZHJhd1N0eWxlID0gZHJhd1N0eWxlc1tzdHlsZVR5cGVdW2RyYXdJZF07CiAgICBpZiAoZHJhd1N0eWxlKSB7CiAgICAgIGJyZWFrOwogICAgfQogIH0KICBpZiAoIWRyYXdTdHlsZSkgewogICAgcmV0dXJuOwogIH0KICBsZXQgc3R5bGVDb25maWcgPSBudWxsOwogIGlmIChzdHlsZVR5cGUgPT09IFBPTFlHT05fU1RZTEUpIHsKICAgIHN0eWxlQ29uZmlnID0gewogICAgICBjb2xvcjogZ2V0Q29sb3JBcnIoZHJhd1N0eWxlWzBdKSwKICAgICAgYm9yZGVyUmdiYTogZ2V0Q29sb3JBcnIoZHJhd1N0eWxlWzFdKSwKICAgICAgYm9yZGVyV2lkdGg6IGRyYXdTdHlsZVsyXSwKICAgICAgYm9yZGVyVGV4dHVyZTogZHJhd1N0eWxlWzNdLAogICAgICB3YXRlclN0eWxlOiBkcmF3U3R5bGVbNV0sCiAgICAgIGhhbG9TdHlsZTogZHJhd1N0eWxlWzZdLAogICAgICB0ZXh0dXJlU3R5bGU6IGRyYXdTdHlsZVs3XSwKICAgICAgdGhpY2tSZ2JhOiBnZXRDb2xvckFycihkcmF3U3R5bGVbOF0pCiAgICB9OwogIH0gZWxzZSBpZiAoc3R5bGVUeXBlID09PSBMSU5FX1NUWUxFKSB7CiAgICBzdHlsZUNvbmZpZyA9IHsKICAgICAgYm9yZGVyQ29sb3I6IGdldENvbG9yQXJyKGRyYXdTdHlsZVswXSksCiAgICAgIGZpbGxDb2xvcjogZ2V0Q29sb3JBcnIoZHJhd1N0eWxlWzFdKSwKICAgICAgYm9yZGVyV2lkdGg6IGRyYXdTdHlsZVsyXSwKICAgICAgZmlsbFdpZHRoOiBkcmF3U3R5bGVbM10sCiAgICAgIGJvcmRlckNhcDogZHJhd1N0eWxlWzRdLAogICAgICBmaWxsQ2FwOiBkcmF3U3R5bGVbNV0sCiAgICAgIGhhdmVCb3JkZXJMaW5lOiBkcmF3U3R5bGVbNl0sCiAgICAgIGhhdmVGaWxsVGV4dHVyZTogZHJhd1N0eWxlWzhdLAogICAgICBmaWxsVGV4dHVyZTogZHJhd1N0eWxlWzEyXQogICAgfTsKICB9IGVsc2UgaWYgKHN0eWxlVHlwZSA9PT0gUE9MWUdPTjNEX1NUWUxFKSB7CiAgICBzdHlsZUNvbmZpZyA9IHsKICAgICAgZmlsdGVyOiBkcmF3U3R5bGVbMF0sCiAgICAgIHJhdGlvOiBkcmF3U3R5bGVbMV0sCiAgICAgIGhhdmVCb3JkZXI6IGRyYXdTdHlsZVsyXSwKICAgICAgYm9yZGVyV2lkdGg6IGRyYXdTdHlsZVszXSwKICAgICAgYm9yZGVyUmdiYTogZ2V0Q29sb3JBcnIoZHJhd1N0eWxlWzRdKSwKICAgICAgZmlsbFRvcDogZ2V0Q29sb3JBcnIoZHJhd1N0eWxlWzVdKSwKICAgICAgZmlsbFNpZGU6IGdldENvbG9yQXJyKGRyYXdTdHlsZVs2XSkKICAgIH07CiAgfSBlbHNlIGlmIChzdHlsZVR5cGUgPT09IFBPSU5UX1RFWFRfU1RZTEUpIHsKICAgIHN0eWxlQ29uZmlnID0gewogICAgICBmb250UmdiYTogZ2V0Q29sb3JSZ2JhKGRyYXdTdHlsZVswXSksCiAgICAgIGhhbG9SZ2JhOiBnZXRDb2xvclJnYmEoZHJhd1N0eWxlWzFdKSwKICAgICAgYmFja1JnYmE6IGdldENvbG9yUmdiYShkcmF3U3R5bGVbMl0pLAogICAgICBmb250U2l6ZTogZHJhd1N0eWxlWzNdLAogICAgICBoYWxvU2l6ZTogZHJhd1N0eWxlWzRdLAogICAgICBmb250V2VpZ2h0OiBkcmF3U3R5bGVbNV0sCiAgICAgIGZvbnRTdHlsZTogZHJhd1N0eWxlWzZdLAogICAgICBkZW5zaXR5OiBkcmF3U3R5bGVbN10KICAgIH07CiAgfSBlbHNlIGlmIChzdHlsZVR5cGUgPT09IFBPSU5UX1NUWUxFKSB7CiAgICBzdHlsZUNvbmZpZyA9IHsKICAgICAgcmFuazogZHJhd1N0eWxlWzBdLAogICAgICB1Y2ZsYWc6IGRyYXdTdHlsZVsxXSwKICAgICAgaWNvbjogZHJhd1N0eWxlWzJdLAogICAgICBpY29uVHlwZTogZHJhd1N0eWxlWzNdLAogICAgICBuaW5lR0c6IGRyYXdTdHlsZVs0XSwKICAgICAgZGVuc2l0eTogZHJhd1N0eWxlWzVdLAogICAgICB6b29tOiBkcmF3U3R5bGVbNl0KICAgIH07CiAgfQogIGlmIChkcmF3SWQpIHsKICAgIHNlbGYuY2FjaGVkU3R5bGVzW2Ake2NhdGFsb2dUeXBlfV8ke3N0eWxlVHlwZX1fJHtkcmF3SWR9YF0gPSBzdHlsZUNvbmZpZzsKICB9CiAgcmV0dXJuIHN0eWxlQ29uZmlnOwp9CmZ1bmN0aW9uIGNyb3NzVmVjdG9yczMoYSwgYikgewogIGNvbnN0IHJlc3VsdCA9IFtdOwogIHJlc3VsdFswXSA9IGFbMV0gKiBiWzJdIC0gYVsyXSAqIGJbMV07CiAgcmVzdWx0WzFdID0gYVsyXSAqIGJbMF0gLSBhWzBdICogYlsyXTsKICByZXN1bHRbMl0gPSBhWzBdICogYlsxXSAtIGFbMV0gKiBiWzBdOwogIHJldHVybiByZXN1bHQ7Cn0K",WW="undefined"!=typeof window&&window.Blob&&new Blob([atob(VW)],{type:"text/javascript;charset=utf-8"});function EW(){const e=WW&&(window.URL||window.webkitURL).createObjectURL(WW);try{return e?new Worker(e):new Worker("data:application/javascript;base64,"+VW,{type:"module"})}finally{e&&(window.URL||window.webkitURL).revokeObjectURL(e)}}function NW(e="",t,i=3){return function e(t,n){return i--,fetch(t,n).then((e=>{if(200===e.status)return e})).catch((s=>{if(i>0)return e(t,n)}))}(e,t)}function FW(e,t,i){let n,s,o,r="";const a=[],l="jsonp"+Math.ceil(1e5*Math.random()),g=e.indexOf("?")>0?"&":"?";i=Object.assign({},{jsonpCallback:"jsonp",timeout:5e4,jsonp:"callback"},i);for(let d in t)({}).hasOwnProperty.call(t,d)&&(r="object"==typeof t[d]?d+"="+JSON.stringify(t[d]):d+"="+t[d],a.push(r));function c(){s.parentNode&&s.parentNode.removeChild(s),n&&clearTimeout(n),window[l]=null}return e+=g+a.join("&"),o=document.getElementsByTagName("script")[0]||document.head,e=e+"&"+i.jsonp+"="+l,s=document.createElement("script"),s.src=e,s.type="text/javascript",o.parentNode.appendChild(s,o),new Promise(((e,t)=>{window[l]=t=>{if(t&&"string"==typeof t)try{t=JSON.parse(t)}catch(pb){t={},console.error("[ERROR] Parse Error.")}e(t),c()},s.onerror=e=>{c(),t({errno:-2,errmsg:`[ERROR] Load Error: ${e}`,data:{}})},i.timeout&&(n=setTimeout((()=>{c(),t({errno:-3,errmsg:"[ERROR] Time out.",data:{}})}),i.timeout))}))}const XW=(e,t)=>fetch(e,Object.assign(t,{credentials:"include"})).then((e=>{if(e.ok)return e.json();throw Error("")})).then((e=>e)).catch((()=>{}));function HW(){let e,t;const i=new Promise((function(i,n){e=i,t=n}));return{resolve:e,reject:t,promise:i}}const zW=Object.freeze(Object.defineProperty({__proto__:null,reFetch:NW,jsonp:FW,request:XW,get:e=>XW(e,{method:"GET"}),post:(e,t)=>XW(e,{method:"POST",body:t}),defer:HW},Symbol.toStringTag,{value:"Module"})),LW=as.merge([ws.fog,ws.lights,{opacity:{value:1},uColor:{value:[0,1,1]},vertexColors:{value:!1},vertexZIndex:{value:!1},maxLayerIndex:{value:0},isEmissive:{value:!1},depthRange:{value:new bt(0,1)},concaveIntensity:{value:.2},heightIntensity:{value:.4}}]);class DW extends mx{constructor(e){super(),this.name="BaiduVectorMaterial",this.type="BaiduVectorMaterial",this.isBaiduVectorMaterial=!0,this.lights=!0,this.fog=!0,this.fragmentShader="#define GLSLIFY 1\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n\n#ifdef MVT_USE_VERTEX_COLOR\n    varying vec4 vColor;\n#else\n    uniform vec3 color;\n#endif\nuniform float opacity;\n\n#ifdef USE_AO\n    uniform float concaveIntensity;\n    uniform float heightIntensity;\n\n    varying float v_concave;\n    varying float v_ground;\n    varying float v_h;\n#endif\n\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n\n#include <mvt_depth_range_pars_fragment>\n\nvoid main() {\n\n    vec4 diffuseColor = vec4(0.0);\n    #ifdef MVT_USE_VERTEX_COLOR\n        diffuseColor = vColor;\n    #else\n        diffuseColor = vec4(color, 1.0);\n    #endif\n\n    diffuseColor.a *= opacity;\n    if (diffuseColor.a <= 0.) {\n        discard;\n    }\n\n    #if ( NUM_DIR_LIGHTS > 0 )\n        // 根据方向光的方向与法向，来计算颜色衰减程度，值范围为-1~1，给重映射到0.8~1的范围\n        float normalLightIntensity = dot(vNormal, directionalLights[0].direction);\n        gl_FragColor = vec4(diffuseColor.rgb * (normalLightIntensity / 10.0 + 0.9), diffuseColor.a);\n    #else \n        gl_FragColor = diffuseColor;\n    #endif\n\n    #ifdef OPAQUE\n        gl_FragColor.a = 1.0;\n    #endif\n\n    #ifdef USE_AO\n        float ao_shade = 1.0;\n        float concave = v_concave * v_concave;\n        float intensity = concaveIntensity;\n        float x_shade = mix(1.0, mix(0.6, 0.75, min(0.01, 1.0)), intensity) + 0.1 * intensity;\n        ao_shade *= mix(1.0, x_shade * x_shade * x_shade, concave);\n\n        intensity = heightIntensity;\n        float h_floors = v_h / 3.0;\n        float y_shade = 1.0 - 0.9 * intensity * min(v_ground, 1.0);\n        ao_shade *= (1.0 - 0.08 * intensity) * (y_shade + (1.0 - y_shade) * (1.0 - pow(1.0 - min(h_floors / 16.0, 1.0), 16.0))) + 0.08 * intensity * min(h_floors / 160.0, 1.0);\n\n        gl_FragColor.rgb *= ao_shade;\n    #endif\n\n    #include <fog_fragment>\n    #include <logdepthbuf_fragment>\n    #include <tonemapping_fragment>\n    #include <colorspace_fragment>\n    \n    #include <mvt_depth_range_fragment>\n}\n\n",this.vertexShader="#define GLSLIFY 1\n#include <common>\n\n#ifdef MVT_USE_VERTEX_COLOR\n    varying vec4 vColor;\n#endif\n\n#include <normal_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n\n#ifdef MVT_USE_VERTEX_ZINDEX\nattribute float layerIndex;\nuniform float maxLayerIndex;\nvarying float vLayerIndex;\n\n#define WORLD_DISTANCE_NEAR 100000.0\n#define WORLD_DISTANCE_MID 1500000.0\n#define WORLD_DISTANCE_FAR 6000000.0\n#define LAYER_INDEX (maxLayerIndex - layerIndex)\n// 在mid和far交接那块，因为线数据特别碎，导致layerIndex很多，地面会陷很深，还没找到比较好的函数来解决这个case\n\nfloat y1(float x) {\n    return pow(LAYER_INDEX * log2(x * 5.), 1.5);\n}\n\nfloat y2(float x) {\n    float xx = x - WORLD_DISTANCE_NEAR;\n    return LAYER_INDEX * log2(xx) + y1(WORLD_DISTANCE_NEAR);\n}\n\nfloat y3(float x) {\n    float xx = x - WORLD_DISTANCE_MID;\n    return log2(LAYER_INDEX * xx) + y2(WORLD_DISTANCE_MID);\n}\n\nfloat y4(float x) {\n    return 110. * LAYER_INDEX + y3(WORLD_DISTANCE_FAR);\n}\n\n/**\ny1 = pow(x, 2)                  x: (0, near]\ny2 = (x - near) + y1(near)      x: (near, mid]\ny3 = sqrt(x - mid) + y2(mid)    x: (mid, far]\ny4 = n + y3(far)                x: (far, +∞)\n*/\nfloat y(float x) {\n    if (x <= WORLD_DISTANCE_NEAR) {\n        return y1(x);\n    }\n    if (x > WORLD_DISTANCE_NEAR && x <= WORLD_DISTANCE_MID) {\n        return y2(x);\n    }\n    else if (x > WORLD_DISTANCE_MID && x <= WORLD_DISTANCE_FAR) {\n        return y3(x);\n    }\n    else if (x > WORLD_DISTANCE_FAR) {\n        return y4(x);\n    }\n}\n#endif\n\n#ifdef USE_AO\nattribute vec2 heightAndConcave;\n\nvarying float v_concave;\nvarying float v_h;\nvarying float v_ground;\n#endif\n\n#ifdef MVT_USE_VERTEX_COLOR\n    #ifdef MVT_USE_COLOR4\n        attribute vec4 aColor;\n    #endif\n#endif\n\nvoid main() {\n\n    #ifdef MVT_USE_VERTEX_COLOR\n        #ifdef MVT_USE_COLOR4\n            vColor = aColor;\n        #else \n            vColor = vec4(color, 1.0);\n        #endif\n    #endif\n\n    #include <begin_vertex>\n    vec4 worldPosition = modelMatrix * vec4(transformed, 1.0);\n\n    #ifdef MVT_USE_VERTEX_ZINDEX\n        // vec3 worldToEye = cameraPosition - worldPosition.xyz;\n        // float dis = length(worldToEye);\n        // float layerGap = maxLayerIndex - layerIndex;\n        // // float zOffset = log2(layerGap * dis + 1.0);\n        // // float zOffset = exp(layerGap * log2(dis * 10.));\n        // float zOffset = y(dis);\n        // // if (dis > WORLD_DISTANCE_NEAR && dis <= WORLD_DISTANCE_MID) {\n        // //     zOffset = layerGap * dis * 0.0001;\n        // // }\n        // // else if (dis > WORLD_DISTANCE_MID && dis <= WORLD_DISTANCE_FAR) {\n        // //     zOffset = layerGap * dis * 0.001;\n        // // }\n        // // else if (dis > WORLD_DISTANCE_FAR) {\n        // //     zOffset = layerGap * dis * 0.01;\n        // // }\n        // worldPosition.z -= zOffset;\n\n        vLayerIndex = layerIndex;\n    #endif\n\n    #ifdef USE_AO\n        v_h = heightAndConcave.x;\n        float encodeConcave = heightAndConcave.y;\n        v_ground = mod(encodeConcave, 2.0);\n        float concave = mod(floor(encodeConcave * 0.5), 2.0);\n        float start = mod(floor(encodeConcave * 0.25), 2.0);\n        concave = pow(concave, 2.2);\n        v_concave = mix(concave, -concave, start);\n    #endif\n\n    vec4 mvPosition = viewMatrix * worldPosition;\n    gl_Position = projectionMatrix * mvPosition;\n\n    // #ifdef MVT_USE_VERTEX_ZINDEX\n    //     float depth = layerGap * 1000.0;\n    //     gl_Position.z = gl_Position.z + depth;\n    // #endif\n\n    #include <beginnormal_vertex>\n    #include <defaultnormal_vertex>\n    #include <normal_vertex>\n\n    #include <fog_vertex>\n    #include <logdepthbuf_vertex>\n\n}\n\n",Object.assign(this.uniforms,as.clone(LW)),fy(this,["opacity","maxLayerIndex","isEmissive","concaveIntensity","heightIntensity"]),by(this,["color"]),_y(this,[["vertexColors","MVT_USE_VERTEX_COLOR"],["vertexZIndex","MVT_USE_VERTEX_ZINDEX"],["enableDepthRange","MVT_USE_DEPTH_RANGE"],["isColor4","MVT_USE_COLOR4"],["useAO","USE_AO"]]),this.setValues(e)}}const KW=new Dl,YW=as.merge([ws.fog,Ay,my,{antialias:{value:!1},lineWidth:{value:100},keepSize:{value:!1},map:{value:null},useMap:{value:!1},mapGap:{value:50},color:{value:[0,1,1]},height:{value:0},opacity:{value:1},resolution:{value:new bt(1,1)},sizeAttenuation:{value:1},dashArray:{value:20},dashOffset:{value:0},dashRatio:{value:.5},alphaTest:{value:0},repeat:{value:new bt(1,1)},vertexColors:{value:!1},vertexZIndex:{value:!1},maxLayerIndex:{value:0},elapsedTime:{value:0},enableAnimation:{value:!1},enableAnimationChaos:{value:!1},animationInterval:{value:0},animationSpeed:{value:1},animationTailType:{value:1},animationTailRatio:{value:.2},animationTailLength:{value:100},animationIdle:{value:1e3},isEmissive:{value:!1},keepDashLength:{value:!0},depthRange:{value:new bt(0,1)},viewportTransform:{value:new Bi},cameraNear:{value:0},cameraFar:{value:0},fovX:{value:0},fovY:{value:0},uZoomUnits:{value:1},flipUv:{value:!1},useZoomUnits:{value:!1},isSingle:{value:!1}}]);class PW extends mx{constructor(e){super(),this.name="FatLineMaterial",this.isFatLineMaterial=!0,this.fog=!0,this.fragmentShader="#define GLSLIFY 1\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <mvt_depth_range_pars_fragment>\n\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n#ifdef MVT_USE_EXTENT_CLIP\nvarying vec2 vExtentVertex;\n#endif\n\nuniform sampler2D map;\nuniform bool useMap;\nuniform bool keepSize;\nuniform bool antialias;\nuniform float lineWidth;\nuniform float mapGap;\nuniform float opacity;\nuniform float alphaTest;\nuniform float elapsedTime;\nuniform bool flipUv;\nuniform bool isSingle;\n\nvarying vec2 vUV;\nvarying vec3 vNormal;\nvarying vec4 vColor;\nvarying float vAliasPart;\nvarying float vCounter;\nvarying float vLength;\nvarying float vTotalLength;\nvarying float vZoomUnits;\n\n#ifdef USE_ANIMATION\nuniform float animationInterval;\nvarying float vAnimationOpacity;\n#endif\n\n#ifdef USE_DASH\n#ifdef MVT_USE_VERTEX_DASHARRAY\nvarying float vDashArray;\n#else\nuniform float dashArray;\n#endif\nuniform float dashOffset;\n#ifdef MVT_USE_VERTEX_DASHRATIO\nvarying float vDashRatio;\n#else\nuniform float dashRatio;\n#endif\nuniform bool keepDashLength;\nvarying float vDashOpacity;\n#endif\n\nvarying float vClippedLength;\n\nvec2 branchFreeTernary(bool comparison, vec2 a, vec2 b) {\n    float useA = float(comparison);\n    return a * useA + b * (1.0 - useA);\n}\nvoid main() {\n\n   vec4 c = vColor;\n\n    #ifdef MVT_USE_EXTENT_CLIP\n    if (vExtentVertex.x < 0.0 || vExtentVertex.x > 1.0 || vExtentVertex.y < 0.0 || vExtentVertex.y > 1.0) {\n        discard;\n    }\n    #endif\n \n    if(useMap) {\n        // icon之间的间隔，经验值为间隔50倍宽度，比较稀疏且好看\n        float margin = lineWidth * mapGap;\n        float halfMargin = margin / 2.0;\n        float texWidth = lineWidth;\n        if (keepSize) {\n            margin *= vZoomUnits;\n            texWidth *= vZoomUnits;\n        }\n        float delta = mod(vClippedLength, texWidth + margin);\n        float uvx;\n        if (isSingle) {\n            uvx = vClippedLength / vTotalLength;\n        }\n        else {\n            uvx = (delta - halfMargin) / texWidth;\n        }\n        if (delta >= halfMargin && delta <= halfMargin + texWidth) {\n            vec2 uv = branchFreeTernary(flipUv, vec2(vUV.y, uvx), vec2(uvx, vUV.y));\n            vec4 texture = texture2D(map, uv);\n            // c = texture.a >= 0.5 ? texture : c;\n            c = texture;\n        }\n    }\n\n    #ifdef USE_ANIMATION\n        float animationAlpha = vAnimationOpacity;\n        if (animationInterval > 0.0) {\n            animationAlpha = mod(vAnimationOpacity, animationInterval);\n        }\n        if (animationAlpha > 1.0 || animationAlpha < 0.0) {\n            discard;\n        }\n        c.a *= animationAlpha;\n    #endif\n\n    #ifdef USE_DASH\n        #ifdef MVT_USE_VERTEX_DASHARRAY\n        float darray = vDashArray;\n        #else\n        float darray = dashArray;\n        #endif\n\n        #ifdef MVT_USE_VERTEX_DASHRATIO\n        float dratio = vDashRatio;\n        #else\n        float dratio = dashRatio;\n        #endif\n        if (keepSize && keepDashLength) {\n            darray *= vZoomUnits;\n        }\n        c.a *= step(mod(vClippedLength + dashOffset, darray), (darray * dratio));\n    #endif\n\n    if (c.a < alphaTest) {\n        discard;\n    }\n\n    // 抗锯齿 make line edge antialias\n    if (antialias) {\n        float blur = 1.0;\n        // blur = 1.0 - smoothstep(vAliasPart, 1.0, length(vNormal));\n        blur = 1.0 - (length(vNormal) - vAliasPart) / (1.0 - vAliasPart);\n        c.a *= blur;\n    }\n\n    gl_FragColor = c;\n\n    gl_FragColor.a *= opacity;\n    #ifdef OPAQUE\n        gl_FragColor.a = 1.0;\n    #endif\n\n    #include <fog_fragment>\n    #include <logdepthbuf_fragment>\n    #include <tonemapping_fragment>\n    #include <colorspace_fragment>\n    \n    #include <mvt_depth_range_fragment>\n}",this.vertexShader="#define GLSLIFY 1\n#include <common>\n\n#ifdef MVT_USE_VERTEX_COLOR\n    attribute vec4 aColor;\n#else\n    uniform vec3 color;\n#endif\n\nattribute float totalLength;\nattribute float lengths;\nattribute float randomFactor;\n\n#ifdef USE_PREV_NEXT\nuniform float cameraNear;\nuniform float cameraFar;\nuniform mat4 viewportTransform;\nuniform float fovX;\nuniform float fovY;\nattribute vec3 prev;\nattribute vec3 next;\nattribute vec2 expandAndPrev;\n#else\nattribute float aWidth;\n#endif\n\n#ifdef MVT_USE_EXTENT_CLIP\nattribute vec2 extentVertex;\nvarying vec2 vExtentVertex;\n#endif\n\nuniform float elapsedTime;\nuniform bool vertexColors;\nuniform bool antialias;\nuniform float lineWidth;\nuniform float height;\nuniform float uZoomUnits;\nuniform bool useZoomUnits;\n\nvarying vec2 vUV;\nvarying vec3 vNormal;\nvarying vec4 vColor;\nvarying float vAliasPart;\nvarying float vCounter;\nvarying float vLength;\nvarying float vTotalLength;\nvarying float vZoomUnits;\nvarying float vClippedLength;\n\n#ifdef USE_ANIMATION\nuniform float animationSpeed;\nuniform float animationTailType;\nuniform float animationTailRatio;\nuniform float animationTailLength;\nuniform float animationIdle;\nvarying float vAnimationOpacity;\n#endif\n\n#ifdef MVT_USE_VERTEX_DASHARRAY\nattribute float aDashArray;\nvarying float vDashArray;\n#endif\n\n#ifdef MVT_USE_VERTEX_DASHRATIO\nattribute float aDashRatio;\nvarying float vDashRatio;\n#endif\n\nattribute vec2 prevAndNextLength;\n\n#ifdef USE_DASH\nvarying vec2 vPrevAndNextLength;\n#endif\n\nfloat branchFreeTernary(bool comparison, float a, float b) {\n    float useA = float(comparison);\n    return a * useA + b * (1.0 - useA);\n}\n\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <mvt_keepsize_pars_vertex>\n#include <mvt_extra_vertex_utils>\n\n#ifdef MVT_USE_VERTEX_ZINDEX\nattribute float layerIndex;\nuniform float maxLayerIndex;\n\n#define WORLD_DISTANCE_NEAR 100000.0\n#define WORLD_DISTANCE_MID 1500000.0\n#define WORLD_DISTANCE_FAR 6000000.0\n#define LAYER_INDEX (maxLayerIndex - layerIndex)\n// 在mid和far交接那块，因为线数据特别碎，导致layerIndex很多，地面会陷很深，还没找到比较好的函数来解决这个case\n\nfloat y1(float x) {\n    return pow(LAYER_INDEX * log2(x * 5.), 1.5);\n}\n\nfloat y2(float x) {\n    float xx = x - WORLD_DISTANCE_NEAR;\n    return LAYER_INDEX * log2(xx) + y1(WORLD_DISTANCE_NEAR);\n}\n\nfloat y3(float x) {\n    float xx = x - WORLD_DISTANCE_MID;\n    return log2(LAYER_INDEX * xx) + y2(WORLD_DISTANCE_MID);\n}\n\nfloat y4(float x) {\n    return 110. * LAYER_INDEX + y3(WORLD_DISTANCE_FAR);\n}\n\n/**\ny1 = pow(x, 2)                  x: (0, near]\ny2 = (x - near) + y1(near)      x: (near, mid]\ny3 = sqrt(x - mid) + y2(mid)    x: (mid, far]\ny4 = n + y3(far)                x: (far, +∞)\n*/\nfloat y(float x) {\n    if (x <= WORLD_DISTANCE_NEAR) {\n        return y1(x);\n    }\n    if (x > WORLD_DISTANCE_NEAR && x <= WORLD_DISTANCE_MID) {\n        return y2(x);\n    }\n    else if (x > WORLD_DISTANCE_MID && x <= WORLD_DISTANCE_FAR) {\n        return y3(x);\n    }\n    else if (x > WORLD_DISTANCE_FAR) {\n        return y4(x);\n    }\n}\nvarying float vLayerIndex;\n#endif\n\n#ifdef USE_PREV_NEXT\n\nvec4 eyeToWindowCoordinates(vec4 positionEC) {\n    vec4 q = projectionMatrix * positionEC;\n    q.xyz /= q.w;\n    q.xyz = (viewportTransform * vec4(q.xyz, 1.0)).xyz;\n\n    return q;\n}\n\nvoid clipLineSegmentWithLengthToNearPlane(\n    vec3 p0,\n    vec3 p1,\n    float l0,\n    float l1,\n    out vec4 positionWC,\n    out bool clipped,\n    out bool culledByNearPlane,\n    out vec4 clippedPositionEC,\n    out float clippedLength\n)\n{\n    culledByNearPlane = false;\n    clippedLength = l0;\n    clipped = false;\n\n    vec3 p0ToP1 = p1 - p0;\n    float magnitude = length(p0ToP1);\n    vec3 direction = normalize(p0ToP1);\n    float lengthDistance = l1 - l0;\n\n    float endPoint0Distance = cameraNear + p0.z;\n\n    float denominator = -direction.z;\n\n    if (endPoint0Distance > 0.0 && abs(denominator) < 0.0000001)\n    {\n        culledByNearPlane = true;\n    }\n    else if (endPoint0Distance > 0.0)\n    {\n        float t = endPoint0Distance / denominator;\n        if (t < 0.0 || t > magnitude)\n        {\n            culledByNearPlane = true;\n        }\n        else\n        {\n            // Segment crosses the near plane, update p0 to lie exactly on it.\n            p0 = p0 + t * direction;\n            p0.z = min(p0.z, -cameraNear);\n\n            l0 = mix(l0, l1, t / magnitude);\n\n            // clippedLength = l0 + (t / ma)\n\n            clipped = true;\n        }\n    }\n\n    // 视锥体参数\n    float tanHalfFovX = tan(fovX / 2.0 * 1.5);\n    float tanHalfFovY = tan(fovY / 2.0 * 1.5);\n\n    vec4 planes[4];\n    planes[0] = vec4( 1,  0,  tanHalfFovX, 0); // Left\n    planes[1] = vec4(-1,  0,  tanHalfFovX, 0); // Right\n    planes[2] = vec4( 0,  1,  tanHalfFovY, 0); // Bottom\n    planes[3] = vec4( 0, -1,  tanHalfFovY, 0); // Top\n\n    vec3 p0Clone = p0;\n    float lengthClone = l0;\n    float mint = 10.0;\n    for (int i = 0; i < 2; i++) {\n        vec4 plane = planes[i];\n        float d0 = dot(vec4(p0, 1.0), plane);\n        float d1 = dot(vec4(p1, 1.0), plane);\n\n        if (d0 > 0.0 && d1 > 0.0) {\n            // 线段完全在该裁剪平面外，剔除\n            culledByNearPlane = true;\n        }\n        else if (d0 > 0.0) {\n            // p0 在外，p1 在内，计算交点\n            mint = min(mint, d0 / (d0 - d1));\n            p0Clone = mix(p0, p1, mint);\n            lengthClone = mix(l0, l1, mint);\n            // clippedLength = l0 - (mint / lengthDistance);\n            clipped = true;\n        }\n    }\n\n    p0 = p0Clone;\n    l0 = lengthClone;\n    mint = 10.0;\n    for (int i = 2; i < 4; i++) {\n        vec4 plane = planes[i];\n        float d0 = dot(vec4(p0, 1.0), plane);\n        float d1 = dot(vec4(p1, 1.0), plane);\n\n        if (d0 > 0.0 && d1 > 0.0) {\n            // 线段完全在该裁剪平面外，剔除\n            culledByNearPlane = true;\n        }\n        else if (d0 > 0.0) {\n            // p0 在外，p1 在内，计算交点\n            mint = min(mint, d0 / (d0 - d1));\n            p0Clone = mix(p0, p1, mint);\n            lengthClone = mix(l0, l1, mint);\n            // clippedLength = l0 + (mint * lengthDistance);\n            // clippedLength = l0 - (mint / lengthDistance);\n            clipped = true;\n        }\n    }\n\n    p0 = p0Clone;\n    clippedLength = lengthClone;\n\n    clippedPositionEC = vec4(p0, 1.0);\n    positionWC = eyeToWindowCoordinates(clippedPositionEC);\n\n}\n\nvoid clipLineSegmentToNearPlane(\n    vec3 p0,\n    vec3 p1,\n    out vec4 positionWC,\n    out bool clipped,\n    out bool culledByNearPlane,\n    out vec4 clippedPositionEC)\n{\n    culledByNearPlane = false;\n    clipped = false;\n\n    vec3 p0ToP1 = p1 - p0;\n    float magnitude = length(p0ToP1);\n    vec3 direction = normalize(p0ToP1);\n\n    float endPoint0Distance = cameraNear + p0.z;\n\n    float denominator = -direction.z;\n\n    if (endPoint0Distance > 0.0 && abs(denominator) < 0.0000001)\n    {\n        culledByNearPlane = true;\n    }\n    else if (endPoint0Distance > 0.0)\n    {\n        float t = endPoint0Distance / denominator;\n        if (t < 0.0 || t > magnitude)\n        {\n            culledByNearPlane = true;\n        }\n        else\n        {\n            // Segment crosses the near plane, update p0 to lie exactly on it.\n            p0 = p0 + t * direction;\n            p0.z = min(p0.z, -cameraNear);\n\n            clipped = true;\n        }\n    }\n\n    // 视锥体参数\n    float tanHalfFovX = tan(fovX / 2.0 * 1.5);\n    float tanHalfFovY = tan(fovY / 2.0 * 1.5);\n\n    vec4 planes[4];\n    planes[0] = vec4( 1,  0,  tanHalfFovX, 0); // Left\n    planes[1] = vec4(-1,  0,  tanHalfFovX, 0); // Right\n    planes[2] = vec4( 0,  1,  tanHalfFovY, 0); // Bottom\n    planes[3] = vec4( 0, -1,  tanHalfFovY, 0); // Top\n\n    vec3 p0Clone = p0;\n    float mint = 10.0;\n    for (int i = 0; i < 2; i++) {\n        vec4 plane = planes[i];\n        float d0 = dot(vec4(p0, 1.0), plane);\n        float d1 = dot(vec4(p1, 1.0), plane);\n\n        if (d0 > 0.0 && d1 > 0.0) {\n            // 线段完全在该裁剪平面外，剔除\n            culledByNearPlane = true;\n        }\n        else if (d0 > 0.0) {\n            // p0 在外，p1 在内，计算交点\n            mint = min(mint, d0 / (d0 - d1));\n            p0Clone = mix(p0, p1, mint);\n            clipped = true;\n        }\n    }\n\n    p0 = p0Clone;\n    mint = 10.0;\n    for (int i = 2; i < 4; i++) {\n        vec4 plane = planes[i];\n        float d0 = dot(vec4(p0, 1.0), plane);\n        float d1 = dot(vec4(p1, 1.0), plane);\n\n        if (d0 > 0.0 && d1 > 0.0) {\n            // 线段完全在该裁剪平面外，剔除\n            culledByNearPlane = true;\n        }\n        else if (d0 > 0.0) {\n            // p0 在外，p1 在内，计算交点\n            mint = min(mint, d0 / (d0 - d1));\n            p0Clone = mix(p0, p1, mint);\n            clipped = true;\n        }\n    }\n\n    p0 = p0Clone;\n\n    clippedPositionEC = vec4(p0, 1.0);\n    positionWC = eyeToWindowCoordinates(clippedPositionEC);\n\n}\n\n#endif\n\nvoid main() {\n\n    #ifdef MVT_USE_VERTEX_COLOR\n        vColor = aColor;\n    #else\n        vColor = vec4(color, 1.0);\n    #endif\n\n    vUV = uv;\n    // vCounter = counter;\n    // vLength = uv.x;\n    vTotalLength = totalLength;\n\n    #ifdef MVT_USE_EXTENT_CLIP\n    vExtentVertex = extentVertex;\n    #endif\n\n    #include <begin_vertex>\n\n    #ifdef USE_PREV_NEXT\n        float width = expandAndPrev.x;\n        float pixelSize;\n        vec4 worldPosition;\n        if (keepSize) {\n            vec4 prevEC = modelViewMatrix * vec4(prev, 1.0);\n            vec4 nextEC = modelViewMatrix * vec4(next, 1.0);\n            vec4 positionEC = modelViewMatrix * vec4(transformed, 1.0);\n\n            bool usePrevious = expandAndPrev.y > 0.0;\n\n            vec4 clippedPrevWC, clippedPrevEC;\n            bool prevSegmentClipped, prevSegmentCulled;\n            clipLineSegmentToNearPlane(prevEC.xyz, positionEC.xyz, clippedPrevWC, prevSegmentClipped, prevSegmentCulled, clippedPrevEC);\n\n            vec4 clippedNextWC, clippedNextEC;\n            bool nextSegmentClipped, nextSegmentCulled;\n            clipLineSegmentToNearPlane(nextEC.xyz, positionEC.xyz, clippedNextWC, nextSegmentClipped, nextSegmentCulled, clippedNextEC);\n\n            bool segmentClipped, segmentCulled;\n            vec4 clippedPositionWC, clippedPositionEC;\n            float clippedLength;\n            clipLineSegmentWithLengthToNearPlane(\n                positionEC.xyz,\n                usePrevious ? prevEC.xyz : nextEC.xyz,\n                uv.x,\n                usePrevious ? prevAndNextLength.x : prevAndNextLength.y,\n                clippedPositionWC,\n                segmentClipped,\n                segmentCulled,\n                clippedPositionEC,\n                clippedLength\n            );\n\n            vClippedLength = clippedLength;\n            \n            vec2 directionToPrevWC = normalize(clippedPrevWC.xy - clippedPositionWC.xy);\n            vec2 directionToNextWC = normalize(clippedNextWC.xy - clippedPositionWC.xy);\n\n            vec4 prevWorld = modelMatrix * vec4(prev, 1.0);\n            vec4 nextWorld = modelMatrix * vec4(next, 1.0);\n            vec2 directionToPrevWC1 = normalize(nextWorld.xy - prevWorld.xy);\n            vec2 directionNormal = vec2(-directionToPrevWC1.y, directionToPrevWC1.x);\n            worldPosition = inverse(viewMatrix) * (clippedPositionEC);\n            pixelSize = getPixelSize(worldPosition.xyz);\n        }\n        else {\n            worldPosition = modelMatrix * vec4(transformed, 1.0);\n            pixelSize = getPixelSize(worldPosition.xyz);\n            vClippedLength = uv.x;\n        }\n    #else \n        vec4 worldPosition = modelMatrix * vec4(transformed, 1.0);\n        float pixelSize = getPixelSize(worldPosition.xyz);\n        float width = aWidth;\n        vClippedLength = uv.x;\n    #endif\n\n    // pixelSize不如统一的zoomUnits的效果\n    // vZoomUnits = branchFreeTernary(useZoomUnits, uZoomUnits, pixelSize);\n    vZoomUnits = branchFreeTernary(useZoomUnits, uZoomUnits, zoomUnits);\n\n    float aliasFeatureWidth = 0.5;\n    vec3 extrude = normal.xyz * width / 2.0;\n    float pixelWidth = width;\n    if (keepSize) {\n        extrude *= pixelSize;\n        pixelWidth *= pixelSize;\n        aliasFeatureWidth *= pixelSize;\n    }\n    if (antialias) {\n        extrude += normal.xyz * aliasFeatureWidth;\n        vNormal = normalize(normal.xyz);\n        vAliasPart = 1. - (2. * aliasFeatureWidth / (pixelWidth / 2. + aliasFeatureWidth));\n    }\n    worldPosition.xyz += extrude;\n    // worldPosition.z += height;\n\n    #ifdef MVT_USE_VERTEX_ZINDEX\n        // vec3 worldToEye = cameraPosition - worldPosition.xyz;\n        // float dis = length(worldToEye);\n        // float layerGap = maxLayerIndex - layerIndex;\n        // float zOffset = log2(layerGap * dis + 1.0);\n        // float zOffset = exp(layerGap * log2(dis * 10.0));\n        // float zOffset = pow(layerGap * log2(dis * 5.0), 1.5);\n        // float zOffset = y(dis);\n        // worldPosition.z -= zOffset;\n        vLayerIndex = layerIndex;\n    #endif\n    \n    #ifdef USE_ANIMATION\n        float tailLength = animationTailType == 1.0 ? vTotalLength * animationTailRatio : animationTailLength;\n\n        #ifdef ANIMATION_CHAOS\n            float currentTime = elapsedTime + randomFactor * 1000.0 * 3600.;\n        #else\n            float currentTime = elapsedTime;\n        #endif\n        float currentLength = mod(currentTime * animationSpeed, vTotalLength + tailLength + animationIdle * animationSpeed);\n        vAnimationOpacity = (vClippedLength - (currentLength - tailLength)) / tailLength;\n    #endif\n\n    vec4 mvPosition = viewMatrix * worldPosition;\n    gl_Position = projectionMatrix * mvPosition;\n\n    // #ifdef MVT_USE_VERTEX_ZINDEX\n    //     float depth = layerGap * 10.0;\n    //     gl_Position.z = gl_Position.z + depth;\n    // #endif\n\n    #ifdef MVT_USE_VERTEX_DASHARRAY\n    vDashArray = aDashArray;\n    #endif\n\n    #ifdef MVT_USE_VERTEX_DASHRATIO\n    vDashRatio = aDashRatio;\n    #endif\n\n    #include <beginnormal_vertex>\n    #include <fog_vertex>\n    #include <logdepthbuf_vertex>\n}",Object.assign(this.uniforms,as.clone(YW)),fy(this,["antialias","mapGap","isSingle","flipUv","lineWidth","keepSize","height","opacity","dashArray","dashOffset","dashRatio","alphaTest","maxLayerIndex","animationInterval","animationSpeed","animationTailType","animationTailRatio","animationTailLength","animationIdle","isEmissive","keepDashLength","depthRange"]),by(this,["color"]),_y(this,[["vertexColors","MVT_USE_VERTEX_COLOR"],["vertexZIndex","MVT_USE_VERTEX_ZINDEX"],["enableAnimation","USE_ANIMATION"],["enableAnimationChaos","ANIMATION_CHAOS"],["dashed","USE_DASH"],["enableDepthRange","MVT_USE_DEPTH_RANGE"],["enableExtentClip","MVT_USE_EXTENT_CLIP"],["vertexDashArray","MVT_USE_VERTEX_DASHARRAY"],["vertexDashRatio","MVT_USE_VERTEX_DASHRATIO"],["enablePrevAndNext","USE_PREV_NEXT"]]),By(this),Object.defineProperties(this,{mapSrc:{get:function(){return this.uniforms.map.value},set:function(e){const t=this.mapSrc,i="url_map";if(this.userData[i]===e)return;if(t&&t.dispose(),!e)return this.uniforms.map.value=null,this.uniforms.useMap.value=!1,void delete this.userData[i];const n=KW.load(e);n.wrapS=n.wrapT=M,this.uniforms.map.value=n,this.userData[i]=e,this.uniforms.useMap.value=!0}},map:{get:function(){return this.uniforms.map.value},set:function(e){const t=this.map;if(!e)return t.dispose(),this.uniforms.map.value=null,void(this.uniforms.useMap.value=!1);this.uniforms.map.value=e,this.uniforms.useMap.value=!0}},zoomUnits:{get:function(){return this.uniforms.uZoomUnits.value},set:function(e){this.uniforms.uZoomUnits.value=e,this.uniforms.useZoomUnits.value=!0}}}),this.emissiveEnabled=!0,this.emissive=[0,0,0],this.setValues(e)}dispose(){this.uniforms.map.value&&this.uniforms.map.value.dispose(),super.dispose()}}const kW=(new Dl).load("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAJ5JREFUeNrsllEKgCAMhp14rsqT1X08Q6VdbDmYLxGUoO5lg72J+9i/3wmIaCTDGuFQAAVQANfyshCCSkBx5pwlAZackUEmSQkIJH2BjJiBAnK8gQBtwzy9I1cidWTLeUm5wHNHduqIlXagEyhMDlmLBNDyR8QvIf4pPNIFkZ3gn8V7SxB52tOwZVRTuCeArzkM+i1XAAVQAGmAW4ABAOOjKXrLR4xWAAAAAElFTkSuQmCC");kW.anisotropy=8;let OW=as.merge([{u_draw_part:{value:0},u_image:{value:kW},color:{value:new In(16711680)},u_scale:{value:1},isGlobe:{value:!1}}]);class UW extends mx{constructor(e){super(),__publicField(this,"name","ArrowMaterial"),__publicField(this,"isArrowMaterial",!0),this.vertexShader="#define GLSLIFY 1\n#include <common>\n\nattribute vec3 a_diff;\nattribute vec3 a_normal;\nattribute vec2 a_uv;\n\nvarying vec2 vUv;\n\n// uniform float u_scale;\n// uniform bool u_flat;\n\n#ifdef MVT_USE_VERTEX_ZINDEX\nattribute float layerIndex;\nuniform float maxLayerIndex;\n\n#define WORLD_DISTANCE_NEAR 100000.0\n#define WORLD_DISTANCE_MID 1500000.0\n#define WORLD_DISTANCE_FAR 6000000.0\n#define LAYER_INDEX (maxLayerIndex - layerIndex)\n// 在mid和far交接那块，因为线数据特别碎，导致layerIndex很多，地面会陷很深，还没找到比较好的函数来解决这个case\n\nfloat y1(float x) {\n    return pow(LAYER_INDEX * log2(x * 5.), 1.5);\n}\n\nfloat y2(float x) {\n    float xx = x - WORLD_DISTANCE_NEAR;\n    return LAYER_INDEX * log2(xx) + y1(WORLD_DISTANCE_NEAR);\n}\n\nfloat y3(float x) {\n    float xx = x - WORLD_DISTANCE_MID;\n    return log2(LAYER_INDEX * xx) + y2(WORLD_DISTANCE_MID);\n}\n\nfloat y4(float x) {\n    return 110. * LAYER_INDEX + y3(WORLD_DISTANCE_FAR);\n}\n\n/**\ny1 = pow(x, 2)                  x: (0, near]\ny2 = (x - near) + y1(near)      x: (near, mid]\ny3 = sqrt(x - mid) + y2(mid)    x: (mid, far]\ny4 = n + y3(far)                x: (far, +∞)\n*/\nfloat y(float x) {\n    if (x <= WORLD_DISTANCE_NEAR) {\n        return y1(x);\n    }\n    if (x > WORLD_DISTANCE_NEAR && x <= WORLD_DISTANCE_MID) {\n        return y2(x);\n    }\n    else if (x > WORLD_DISTANCE_MID && x <= WORLD_DISTANCE_FAR) {\n        return y3(x);\n    }\n    else if (x > WORLD_DISTANCE_FAR) {\n        return y4(x);\n    }\n}\n#endif\n\n#include <mvt_selective_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <mvt_keepsize_pars_vertex>\n#include <mvt_extra_vertex_utils>\nvoid main() {\n    #include <mvt_selective_vertex>\n    \n    vec3 currentPosition = position;\n\n    vec4 worldPosition = modelMatrix * vec4(currentPosition, 1.0);\n    float pixelSize = getPixelSize(worldPosition.xyz) * 1.0;\n\n    float scale = 1.4;\n    currentPosition.xyz = currentPosition.xyz + (a_diff * scale * pixelSize) + normalize(a_normal) * 2.5 * scale * pixelSize;\n\n    worldPosition = modelMatrix * vec4(currentPosition, 1.0);\n\n    #ifdef MVT_USE_VERTEX_ZINDEX\n        vec3 worldToEye = cameraPosition - worldPosition.xyz;\n        float dis = length(worldToEye);\n        float layerGap = maxLayerIndex - layerIndex;\n        // float zOffset = log2(layerGap * dis + 1.0);\n        // float zOffset = exp(layerGap * log2(dis * 10.0));\n        // float zOffset = pow(layerGap * log2(dis * 5.0), 1.5);\n        float zOffset = y(dis);\n        worldPosition.z -= zOffset;\n    #endif\n\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(currentPosition, 1.0);\n\n    vUv = a_uv;\n\n    #include <logdepthbuf_vertex>\n    // gl_PointSize = 10000000000.0; // 设置点的大小\n}",this.fragmentShader="#define GLSLIFY 1\n#include <common>\n\nuniform sampler2D u_image;\nuniform int u_draw_part;\n\nvarying vec2 vUv;\n// varying float v_z;\n\n#include <mvt_selective_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n\nvoid main() {\n    // if (u_draw_part == 1) {\n    //     if (v_z > 0.0) {\n    //         discard;\n    //     }\n    // } else if (u_draw_part == 2) {\n    //     if (v_z == 0.0) {\n    //        discard;\n    //     }\n    // }\n\n    gl_FragColor = texture2D(u_image, vUv);\n    gl_FragColor.rgb *= (1.0 - max(0.6, 1.0 - gl_FragColor.a));\n\n    #include <mvt_selective_fragment>\n    #include <logdepthbuf_fragment> \n    #include <tonemapping_fragment>\n    #include <colorspace_fragment>\n}\n",Object.assign(this.uniforms,as.clone(OW)),by(["color"]),fy(this,["u_draw_part","u_image"]),_y(this,[["vertexZIndex","MVT_USE_VERTEX_ZINDEX"],["isGlobe","IS_GLOBE"]]),this.setValues(e)}set color(e){this.uniforms.color.value=e}}const QW=256*Math.pow(2,18)/2,JW=QW/20037724.16;class jW extends UV{constructor(e,t,i){super(e,t,i),__publicField(this,"_maxLevel",19),__publicField(this,"_shouldCheckTileBoundingRange",!0),this._coordLevelTileCounts=[1];let n=1;for(let s=1;s<=19;++s)this._coordLevelTileCounts[s]=n,n*=2}getRootTiles(){const e=new kV(this,0,0,0);return e.projectedBoundingBox=new qt(new Qt(-QW,-QW,-100),new Qt(QW,QW,100)),e.geoBoundingBox=new qt(new Qt(-180*JW,-90*JW,-100),new Qt(180*JW,90*JW,100)),[e]}getRootBoundingBox(){return this._rootBoundingBox}getTileReverseY(e){return Math.pow(2,e.z-1)-e.y-1}getTileSizeAtLevel(e){return 256*Math.pow(2,18-e)}getTileCoordX(e,t,i){return(e+QW)/t}getTileCoordY(e,t,i){return(e+QW)/t}_quadCoordToTileCoord(e,t){return e>=t?e-t:"M"+(t-e)}getRasterTileCoord(e,t,i){const n=this._coordLevelTileCounts[e];return[e,this._quadCoordToTileCoord(t,n),this._quadCoordToTileCoord(i,n)]}get zeroLevelPixelSize(){return this._zeroLevelPixelSize||(this._zeroLevelPixelSize=262216.13723289885),this._zeroLevelPixelSize}}const qW={3:2,5:4,7:4,9:4,10:2,12:8,15:2,17:4},$W={0:0,1:1,2:2,3:3,5:4,7:6,9:8,10:10,12:11,15:14,17:15,19:17},eE={0:{start:0,base:0},1:{start:0,base:1},2:{start:2,base:2},3:{start:3,base:3},4:{start:4,base:5},5:{start:4,base:5},6:{start:6,base:7},7:{start:6,base:7},8:{start:8,base:9},9:{start:8,base:9},10:{start:10,base:10},11:{start:11,base:12},12:{start:11,base:12},13:{start:11,base:12},14:{start:14,base:15},15:{start:14,base:15},16:{start:16,base:17},17:{start:16,base:17},18:{start:18,base:19},19:{start:18,base:19},20:{start:18,base:19},21:{start:18,base:19}};Object.freeze(eE);class tE extends jW{constructor(e,t,i){super(e,t,i),__publicField(this,"name",TV),__publicField(this,"_maxLevel",21),__publicField(this,"_levels",[0,1,2,3,5,7,9,10,12,15,17,19]);let n=1;this._coordLevelTileCounts={0:1,1:1};for(let s=1;s<this._levels.length;s++){const e=this._levels[s],t=this._levels[s-1];s<2||(n*=void 0!==qW[t]?qW[t]:2,this._coordLevelTileCounts[e]=n)}}_quadCoordToTileCoord(e,t,i){let n=e-t;return Math.floor(n/1)}getRasterTileCoord(e,t,i){let n=this._coordLevelTileCounts[e];return[e,this._quadCoordToTileCoord(t,n,e),this._quadCoordToTileCoord(i,n,e)]}getNextLevelTileCount(e){return qW[e]||2}getQuadTreeLevelGap(e,t){const i=eE[e].base,n=eE[t].base;return $W[n]-$W[i]}getTileLoaderConfig(e){const t=eE[e.z];return{baseZ:t.base,startZ:t.start}}}const iE={0:{start:0,end:0,base:0},1:{start:1,end:1,base:1},2:{start:2,end:2,base:2},3:{start:3,end:4,base:3},4:{start:3,end:4,base:3},5:{start:5,end:6,base:5},6:{start:5,end:6,base:5},7:{start:7,end:8,base:7},8:{start:7,end:8,base:7},9:{start:9,end:9,base:9},10:{start:10,end:12,base:10},11:{start:10,end:12,base:10},12:{start:10,end:12,base:10},13:{start:13,end:14,base:13},14:{start:13,end:14,base:13},15:{start:15,end:16,base:14},16:{start:15,end:16,base:14},17:{start:17,end:23,base:16},18:{start:17,end:23,base:16},19:{start:17,end:23,base:16},20:{start:17,end:23,base:16},21:{start:17,end:23,base:16},22:{start:17,end:23,base:16},23:{start:17,end:23,base:16}};Object.freeze(iE);class nE extends UV{constructor(){super(...arguments),__publicField(this,"name",ZV),__publicField(this,"_maxLevel",21),__publicField(this,"_rootBoundingBox",new qt(new Qt(-20037508.3427892,-20037508.3427892,-100),new Qt(20037508.3427892,20037508.3427892,100)))}getRootTiles(){const e=new kV(this,0,0,0);return e.projectedBoundingBox=this._rootBoundingBox,e.geoBoundingBox=new qt(new Qt(-180,-90,-100),new Qt(180,90,100)),[e]}getRootBoundingBox(){return this._rootBoundingBox}getQuadTreeLevelGap(e,t){const i=iE[e].base;return iE[t].base-i}getTileLoaderConfig(e){const t=iE[e.z];return{baseZ:t.base,startZ:t.start}}}class sE{constructor(){__publicField(this,"_retryTimes",3),__publicField(this,"_queued",{}),__publicField(this,"_cached",{})}async generate(e){return{}}async get(e){if(this._cached[e])return this._cached[e];let t=!1;this._queued[e]||(this._queued[e]=[],t=!0);const i=new Promise(((t,i)=>{this._queued[e].push([t,i])})),n=this._queued[e];if(t){for(let t=0;t<this._retryTimes;t++)try{const t=await this.generate(e);this._cached[e]=t;for(const e of n)e[0](t);break}catch(s){console.warn(s)}for(const e of n)e[1]()}return i}get keys(){return Object.keys(this._cached)}delete(e){delete this._cached[e],delete this._queued[e]}clear(){this._cached={},this._queued={}}}class oE{}__publicField(oE,"ak",null);class rE{}__publicField(rE,"accessToken",null);class aE{}__publicField(aE,"tk",null);const lE=("http:"===window.location.protocol?"http:":"https:")+"//api.map.baidu.com";const gE=new class{constructor(){__publicField(this,"sendMessage",(e=>{})),this.device={PC:0,NA:1},this.config={mask:["FFFFFFFF"],open:!1,reset:36e5},this.url=lE+"?qt=jsapi_log",this.startTime=Date.now(),this.mark={},this.records={},this.ak=""}init(e,t){this.kill();let i=this;this.config.open=!!e,(t=t||{}).reset&&(this.config.reset=t.reset),this.sendMessage=function(e){let t=e||1e3;var n;return i._idleWorkerTicker=(n=i,function(){n.runJob()}),function(e){if(window.navigator&&!navigator.onLine)return;Date.now()-i.startTime>i.config.reset&&(i.startTime=Date.now(),i.mark={},i.records={});const n=e.join("-");i.mark[n]||(i.mark[n]=!0,i.records[n]=e),i.checkJob(t)}}(t.timers)}runJob(){if(0===Object.keys(this.records).length)return clearInterval(this.idleWork),void(this.idleWork=null);let e=Object.keys(this.records)[0],t=(new Date).getTime();if(this.config.open)try{const i=this.ak||oE.ak;FW(this.url,{ak:i,mapvthree:1,device:0,module:this.records[e][0]||"",func:this.records[e][1]||"",subfunc:this.records[e][2]||"",t:t}).then((t=>{delete this.records[e]}))}catch(pb){}0===Object.keys(this.records).length&&(clearInterval(this.idleWork),this.idleWork=null)}checkJob(e){!this.idleWork&&this._idleWorkerTicker&&(this.idleWork=setInterval(this._idleWorkerTicker,e))}kill(){this.idleWork&&(clearInterval(this.idleWork),this.idleWork=null),this._idleWorkerTicker=null,this.mark={},this.records={}}};gE.init(!0,{reset:12e5}),new Qt,new Qt;const cE="http:"===window.location.protocol?"http:":"https:",dE=[`${cE}//maponline0.bdimg.com`,`${cE}//maponline1.bdimg.com`,`${cE}//maponline2.bdimg.com`,`${cE}//maponline3.bdimg.com`],hE=(e,t,i)=>.2*Math.tan(t/2)*e/i,uE=new Dl,IE=new sE;IE.generate=async e=>new Promise(((t,i)=>{uE.load(e,(e=>{t(e)}),null,i)}));let pE=null;const mE={default:0,"grayed-out":1},AE={fontRgba:[0,0,0,0],fontSize:16,fontWeight:"400",haloRgba:[0,0,0,0],haloSize:0};const CE={0:"top",1:"left",2:"bottom",3:"right"};class fE extends RW{constructor(e={}){super(e),__publicField(this,"name","BaiduVectorTileProvider"),__publicField(this,"isBaiduProvider",!0),__publicField(this,"_shouldRenderPlaceholder",!0),__publicField(this,"_isAttach",!0),__publicField(this,"_supportAllProjections",!0),__publicField(this,"_defaultStartLevel",2),__publicField(this,"_defaultMaxLevel",16),__publicField(this,"_labels",{}),__publicField(this,"_loadStyle",(async()=>{let e=null;if(this._isOffline){let t=this._styleUrl||mm("assets/map/style/default.json");e=await NW(t).then((e=>e.json())),e.data&&e.data.style&&(e=e.data.style)}else this._styleUrl?(e=await NW(this._styleUrl).then((e=>e.json())),e.data&&e.data.style&&(e=e.data.style)):(pE||(await(t="https://maponline0.bdimg.com/sty/fs.js",new Promise(((e,i)=>{const n=document.createElement("script");n.src=t,n.async=!0,n.onload=e,n.onerror=()=>i(new Error(`failed to load script: ${t}`)),document.head.appendChild(n)}))),pE=window.FeatureStyle),e=pE);var t;this._dataLoader.postMessageToAll({type:"changeStyle",featureStyles:e})})),__publicField(this,"_getMapStyleFile",(async e=>{let t=!0;"string"==typeof e&&"default"!==e&&(t=!1);const i=t?"":"_"+(mE[e]-1);let n="http://10.228.107.23:8140";this._staticUrl?n=this._staticUrl:window.BMAPGL_STATIC_URL?n=window.BMAPGL_STATIC_URL:this._url&&(n=this._url);const s=`${n}/sty/`;this._vctMapStyleDomain=s,this._vctMapStyleUrl=s+"icons_2x"+i+".js";const o=await async function(e){try{const t=document.createElement("script");return t.src=e,document.head.appendChild(t),new Promise(((i,n)=>{t.onload=()=>{i(window.iconSetInfo_high)},t.onerror=()=>{n(new Error(`Failed to load script: ${e}`))}}))}catch(t){throw console.error("Error loading icon set:",t),t}}(this._vctMapStyleUrl);this._dataLoader.postMessageToAll({type:"changeIconSetInfo",iconSetInfo:o})}));const t=e.ak||oE.ak;if(this._displayOptions=e.displayOptions,this._url=e.url,this._styleUrl=e.styleUrl,this._isOffline=e.isOffline,this._isOffline)this._staticUrl=e.staticUrl,this._sourceProjectionName=lm(e.projection,Tb),this._isWebMercator=!(this._sourceProjectionName!==Tb);else{if(!t)throw new Error("没有有效百度地图AK，请设置BaiduMapConfig.ak或options.ak");this._staticUrl="https://maponline0.bdimg.com",this._sourceProjectionName=Vb,this._isWebMercator=!1,gE.ak=t,gE.sendMessage(["layer","vector","normal"])}this._isWebMercator?(this._isAttach=lm(e.isAttach,!0),this._defaultMinLevel=2,this._defaultMaxLevel=20):(this._isAttach=!1,this._defaultMinLevel=3,this._defaultMaxLevel=21)}initProjectionAndGrid(){this._sourceProjection=Tv(this._sourceProjectionName),this._sourceProjectionName===Vb?this._grid=new tE(this._engine,this._sourceProjection,this._targetProjection):this._grid=new nE(this._engine,this._sourceProjection,this._targetProjection)}async _asyncInit(){this._dataLoader||(this._dataLoader=new ZW(this,EW,2)),await this._loadStyle(),await this._getMapStyleFile("default")}getTileURL(e,t,i,n){return n.loaderConfig&&(e=n.loaderConfig.baseZ),this._isOffline?this._getOfflineTileURL(e,t,i,n):this._getOnlineTileURL(e,t,i,n)}_getOnlineTileURL(e,t,i,n){const[s,o,r]=n.grid.getRasterTileCoord(e,t,i);const a=`x=${o}&y=${r}&z=${s}&styles=pl&textimg=0&v=088&udt=20190618&json=0`;return`${dE[Math.abs(t+i)%4]}/pvd/?qt=vtile&param=`+window.encodeURIComponent(function(e){let t,i,n="";for(t=0;t<e.length;t++){i=e.charCodeAt(t)<<1;let s=i.toString(2),o=s;s.length<8&&(o="00000000"+s,o=o.substr(s.length,8)),n+=o}let s=5-n.length%5,o=[];for(t=0;t<s;t++)o[t]="0";n=o.join("")+n;let r=[];for(t=0;t<n.length/5;t++){i=n.substr(5*t,5);let e=parseInt(i,2)+50;r.push(String.fromCharCode(e))}return r.join("")+s.toString()}(a))}_getOfflineTileURL(e,t,i,n){let s=e,o=t,r=i;this._isWebMercator||([s,o,r]=n.grid.getRasterTileCoord(e,t,i));let a=`http://10.228.107.23:8140/pvd/?qt=vtile&x=${o}&y=${r}&z=${s}&styles=pl&textimg=0&v=088&udt=20190618&json=0&ApiAuthorization=USER_AK`;return this._url?a=`${this._url}/pvd/?qt=vtile&x=${o}&y=${r}&z=${s}&styles=pl&textimg=0&v=088&udt=20190618&json=0&ApiAuthorization=USER_AK`:window.BMAPGL_URL&&(a=`${window.BMAPGL_URL}/pvd/?qt=vtile&x=${o}&y=${r}&z=${s}&styles=pl&textimg=0&v=088&udt=20190618&json=0&ApiAuthorization=USER_AK`),a+="&customid=vector-tile",a}getWorkerOptions(){return{isAttach:this._isAttach,displayOptions:this._displayOptions,styleZoomOffset:this._isWebMercator?0:-1}}getFetchOptions(e){return{...e.loaderConfig}}async doRequestTileData(e){const t=await this._dataLoader.requestTile(e),{polygon:i,polygonOpacity:n,line:s,dashLine:o,textureLine:r,gaoqingLine:a,polygon3d:l,building3d:g,poi:c,arrow:d,maxLayerIndex:h}=t.content,u=t.isNormalized,I=this._engine.rendering.features.antialias.samples>0,p=new qr,m=new qr;if(i&&i.indices){const e=new Fn,t=new aa(i.attributes,10);e.setAttribute("position",new ga(t,3,0)),e.setAttribute("normal",new ga(t,3,3)),e.setAttribute("color",new ga(t,3,6)),e.setAttribute("layerIndex",new ga(t,1,9)),e.setIndex(new Bn(i.indices,1));const n=new DW({depthTest:!0,vertexColors:!0,vertexZIndex:!0,maxLayerIndex:h,enableDepthRange:!0});n.setCommonUniforms(this._engine.rendering.uniforms);const s=new ts(e,n);s.name="Polygons",m.add(s)}if(n&&n.indices){const e=new Fn,t=new aa(n.attributes,11);e.setAttribute("position",new ga(t,3,0)),e.setAttribute("normal",new ga(t,3,3)),e.setAttribute("aColor",new ga(t,4,6)),e.setAttribute("layerIndex",new ga(t,1,10)),e.setIndex(new Bn(n.indices,1));const i=new DW({depthTest:!0,transparent:!0,isColor4:!0,vertexColors:!0,vertexZIndex:!0,maxLayerIndex:h,enableDepthRange:!0});i.setCommonUniforms(this._engine.rendering.uniforms);const s=new ts(e,i);s.name="Polygons",m.add(s)}if(s&&s.indices){const e=new Fn,t=new aa(s.attributes,12);e.setAttribute("position",new ga(t,3,0)),e.setAttribute("normal",new ga(t,3,3)),e.setAttribute("aColor",new ga(t,4,6)),e.setAttribute("layerIndex",new ga(t,1,10)),e.setAttribute("aWidth",new ga(t,1,11)),e.setIndex(new Bn(s.indices,1));const i=new PW({keepSize:!0,depthTest:!0,transparent:!I,antialias:!I,lineWidth:1,vertexColors:!0,vertexZIndex:!0,maxLayerIndex:h,enableDepthRange:!0});i.setCommonUniforms(this._engine.rendering.uniforms);const n=new ts(e,i);n.name="Links",m.add(n)}if(o){const t=Object.keys(o);for(let i=0;i<t.length;i++){const n=t[i],s=o[n],r=this._vctMapStyleDomain+"map_icons2x/"+n+".png",a=new Fn,l=new aa(s.attributes,14);a.setAttribute("position",new ga(l,3,0)),a.setAttribute("normal",new ga(l,3,3)),a.setAttribute("aColor",new ga(l,4,6)),a.setAttribute("layerIndex",new ga(l,1,10)),a.setAttribute("aWidth",new ga(l,1,11)),a.setAttribute("uv",new ga(l,2,12)),a.setIndex(new Bn(s.indices,1));const g=new PW({keepSize:!0,antialias:!0,depthTest:!0,transparent:!0,lineWidth:100,mapGap:0,vertexColors:!0,vertexZIndex:!0,maxLayerIndex:h,enableDepthRange:!0});g.flipUv=!0,g.setCommonUniforms(this._engine.rendering.uniforms);const c=new ts(a,g);c.onBeforeRender=()=>{const t=e.targetCenter,i=this._engine.camera,n=this._engine.rendering.renderState,s=i.position,o=t.clone();o.x-=n.cameraOffset.x,o.y-=n.cameraOffset.y,o.z-=n.cameraOffset.z;const r=s.distanceTo(o),a=hE(r,i.fov*Math.PI/180,this._engine.container.clientHeight);g.zoomUnits=a},c.name="Links",IE.get(r).then((e=>{e.wrapS=e.wrapT=G,e.generateMipmaps=!1,e.colorSpace=Ye,g.useMap=!0,g.map=e,m.add(c)}))}}if(r){const e=Object.keys(r);for(let t=0;t<e.length;t++){const i=e[t],n=r[i],s=this._vctMapStyleDomain+"map_icons2x/"+i+".png",o=new Fn,a=new aa(n.attributes,15);o.setAttribute("position",new ga(a,3,0)),o.setAttribute("normal",new ga(a,3,3)),o.setAttribute("aColor",new ga(a,4,6)),o.setAttribute("layerIndex",new ga(a,1,10)),o.setAttribute("aWidth",new ga(a,1,11)),o.setAttribute("uv",new ga(a,2,12)),o.setAttribute("totalLength",new ga(a,1,14)),o.setIndex(new Bn(n.indices,1));const l=new PW({keepSize:!1,depthTest:!0,transparent:!0,mapGap:0,lineWidth:100,vertexColors:!0,vertexZIndex:!0,maxLayerIndex:h,enableDepthRange:!0});l.isSingle=!0,l.flipUv=!0,l.setCommonUniforms(this._engine.rendering.uniforms);const g=new ts(o,l);g.name="Links",IE.get(s).then((e=>{e.wrapS=e.wrapT=G,e.generateMipmaps=!1,e.colorSpace=Ye,l.useMap=!0,l.map=e,m.add(g)}))}}if(a){const e=Object.keys(a);for(let t=0;t<e.length;t++){const i=e[t],n=a[i],s=this._vctMapStyleDomain+"map_icons2x/"+i+".png",o=new Fn,r=new aa(n.attributes,14);o.setAttribute("position",new ga(r,3,0)),o.setAttribute("normal",new ga(r,3,3)),o.setAttribute("aColor",new ga(r,4,6)),o.setAttribute("layerIndex",new ga(r,1,10)),o.setAttribute("aWidth",new ga(r,1,11)),o.setAttribute("uv",new ga(r,2,12)),o.setIndex(new Bn(n.indices,1));const l=new PW({keepSize:!1,antialias:!0,depthTest:!0,transparent:!0,lineWidth:1,mapGap:0,vertexColors:!0,vertexZIndex:!0,maxLayerIndex:h,enableDepthRange:!0});l.flipUv=!0,l.setCommonUniforms(this._engine.rendering.uniforms);const g=new ts(o,l);g.name="Links",IE.get(s).then((e=>{e.wrapS=e.wrapT=G,e.generateMipmaps=!1,e.colorSpace=Ye,l.useMap=!0,l.map=e,m.add(g)}))}}if(l&&l.indices){const e=new Fn,t=new aa(l.attributes,10);e.setAttribute("position",new ga(t,3,0)),e.setAttribute("normal",new ga(t,3,3)),e.setAttribute("color",new ga(t,3,6)),e.setAttribute("layerIndex",new ga(t,1,9)),e.setIndex(new Bn(l.indices,1));const i=new DW({depthTest:!0,vertexColors:!0,vertexZIndex:!0,maxLayerIndex:h,enableDepthRange:!0});i.setCommonUniforms(this._engine.rendering.uniforms);const n=new ts(e,i);n.name="Polygons3D",m.add(n)}if(g&&g.indices){const e=new Fn,t=new aa(g.attributes,11);e.setAttribute("position",new ga(t,3,0)),e.setAttribute("normal",new ga(t,3,3)),e.setAttribute("color",new ga(t,3,6)),e.setAttribute("heightAndConcave",new ga(t,2,9)),e.setIndex(new Bn(g.indices,1));const i=new DW({depthTest:!0,vertexColors:!0});i.useAO=!0,i.setCommonUniforms(this._engine.rendering.uniforms);const n=new ts(e,i);n.name="Building3D",p.add(n)}if(d&&d.indices){const e=new Fn,t=new aa(d.attributes,12);e.setAttribute("position",new ga(t,3,0)),e.setAttribute("a_normal",new ga(t,3,3)),e.setAttribute("a_uv",new ga(t,2,6)),e.setAttribute("a_diff",new ga(t,3,8)),e.setAttribute("layerIndex",new ga(t,1,11)),e.setIndex(new Bn(d.indices,1));const i=new UW({transparent:!0,vertexZIndex:!0,isGlobe:!!this._engine.map.isGlobe});i.setCommonUniforms(this._engine.rendering.uniforms);const n=new ts(e,i);n.name="Arrow",p.add(n)}if(c&&c.length){let t=[];const i=this._engine.map.projectionName,n=`${e.x}-${e.y}-${e.z}`;for(let e=0;e<c.length;e++){const s=c[e].position,o=`${s[0]}-${s[1]}-${s[2]}`;let r=c[e].uid?`${c[e].uid}_${n}`:`${c[e].name}-${o}`;const a=c[e].hasText?c[e].styleConfig:AE,l=lm(c[e].iconConfig,{}),g=l.icon?this._vctMapStyleDomain+"map_icons2x/"+l.icon+".png":"",d=lm(l.size,[0,0]),h=lm(CE[c[e].direction],"center"),u=l.textDrawOnIcon,I=c[e].hasText;let p="text_fix";g&&(p="icon",I&&(p="icon_text")),I&&!c[e].text||t.push({crs:i,id:r,forceProjected:i===Rb,type:c[e].type?c[e].type:p,rotateZ:"rotateZ"in c[e]?c[e].rotateZ:void 0,position:s,text:c[e].text,rank:c[e].rank,textFillStyle:a.fontRgba,textSize:a.fontSize/2,textWeight:a.fontWeight,textStrokeStyle:a.haloRgba,textStrokeWidth:Math.min(a.haloSize/2,4),textAnchor:h,styleId:c[e].styleId,icon:g,iconSize:d,hasText:c[e].hasText,textDrawOnIcon:u})}p.poiLabels=t}return u?(e.projectedBoundingBox.getSize(p.scale),p.scale.z=1,m.scale.copy(p.scale),p.position.copy(e.targetCenter),m.position.copy(e.targetCenter)):(p.position.copy(e.targetCenter),m.position.copy(e.targetCenter)),[p,m]}_calculateTolerance(e,t,i){const n=e.tile.z;let s=0;return 5===n&&"中华人民共和国"===i.text&&(s=-3),6===n&&"广州"===i.text&&(s=-4),7===n?(s=4,"三沙"!==i.text&&"三亚"!==i.text&&"儋州"!==i.text||(s=-1)):n>7&&(s=12),"香港"!==i.text&&"澳门"!==i.text&&"台北"!==i.text||(s=-3),s}_addTilePOI(e,t){if(e.object&&e.object.poiLabels){const i=e.dataTile.key,n=e.tile._distance,s=e.tile.z<10,o=[];for(let a=0;a<e.object.poiLabels.length;a++){const r=e.object.poiLabels[a];this._labels[r.id]||(this._labels[r.id]=r,r.bucket=i,r.distance=n,r.checkVisible=s,r.tolerance=this._calculateTolerance(e,t,r),o.push(r))}const r=e.dataTile.key;t.rendering.label.addLabels(o,r)}}_removeTilePOI(e,t){if(e.object&&e.object.poiLabels){const i=[],n=e.dataTile.key;for(let t=0;t<e.object.poiLabels.length;t++){const n=e.object.poiLabels[t];this._labels[n.id]&&(delete this._labels[n.id],i.push(n))}t.rendering.label.removeLabels(i,n)}}onSurfaceTileAdded(e,t){e.isMeetSSE&&this._addTilePOI(e,t)}onSurfaceTileRemoved(e,t){this._removeTilePOI(e,t)}onSurfaceTileSSEChanged(e,t){e.isMeetSSE?this._addTilePOI(e,t):this._removeTilePOI(e,t)}addAllSymbols(){Object.keys(this._labels).forEach((e=>{const t=this._labels[e];t.isHidden&&(t.isHidden=!1,this._engine.rendering.label.addLabel(t))}))}removeAllSymbols(){Object.keys(this._labels).forEach((e=>{const t=this._labels[e];t.isHidden||(t.isHidden=!0,this._engine.rendering.label.removeLabel(t))}))}}new Qt,new Qt;class bE extends ot{constructor(e,t={}){super(),__publicField(this,"_engine"),__publicField(this,"_map"),__publicField(this,"_container"),__publicField(this,"_mapType"),__publicField(this,"handleViewChange",(()=>{this._engine.rendering.requestRender()})),__publicField(this,"handleResolutionChange",(e=>{this._engine.rendering.setResolution(e)})),this._engine=e,this._options=t;const i=e.container;let n=Tv(t.projection||Tb),s=n.name;if(i instanceof HTMLElement)if(t.customMap){const s=t.customMap;this._map=new s(e,i,t),this._container=i,this._mapType="custom",n=Tv(this._map.projectionName||Tb)}else s===Zb?(this._map=new lZ(e,i,t),this._container=i,this._mapType="earth",this.isGlobe=!0):!1===t.is3DControl?(this._map=new fS(e,i,t),this._container=i,this._mapType="blank"):(this._map=new QS(e,i,t),this._container=i,this._mapType="blank_3dcontrol");else window.BMapGL&&i instanceof BMapGL.Map?(this._map=new JS(e,i,t),this._container=i.container,this._mapType="bmapgl",n=Tv(t.projection||Vb)):i._mapId&&(this._map=new jS(e,i,t),this._container=i._container,this._mapType="mapbox");if(!this._map)throw new Error("map is invalid");this._projection=n,this._map.projection=n,this._map.projectionName=n.name}init(){this._map.init(),this._map.onViewChanged=this.handleViewChange,this._map.onResolutionChanged=this.handleResolutionChange}afterInit(){const e=this._engine,n=this._map;n.canvas=e.rendering.canvas,n.camera=e.rendering.camera,i(this._container,`${t}-container`),n.afterInit();const s=this._options;am(s.center)?n.lookAt(s.center,{range:s.range,heading:s.heading,pitch:s.pitch}):(am(s.heading)&&n.setHeading(s.heading),am(s.pitch)&&n.setPitch(s.pitch),am(s.range)&&n.setRange(s.range));let o=s.provider;if(null===o)return;if(o||(o=new fE),!o)return;let r=null,a=null;if(o.isVectorTileProvider)a=o;else{if(!o.isImageryTileProvider)throw new Error("invalid tile provider");r=o}this._mapView=this._engine.add(new GW({vectorProvider:a,imageryProvider:r}))}setCenter(e){this._map.setCenter(e)}setZoom(e){this._map.setZoom(e)}setHeading(e){this._map.setHeading(e)}setPitch(e){this._map.setPitch(e)}setRange(e){this._map.setRange(e)}setBounds(e){this._map.setBounds(e)}lockDrag(e){this._map.lockDrag(e)}setMaxRange(e){this._map.setMaxRange(e)}lookAt(e,t={}){e?this._map.lookAt(e,t):console.error("engine.map.lookAt: target is required")}getBoundingBox(){return this._map.getBounds()}getCenter(){return this._map.getCenter()}getRange(){return this._map.getRange()}getZoom(){return this._map.getZoom()}getZoomUnits(){return this._map.getZoomUnits()}getZoomByZoomUnits(e){return this._map.getZoomByZoomUnits(e)}getZoomUnitsByZoom(e){return this._map.getZoomUnitsByZoom(e)}getHeading(){return this._map.getHeading()}flyTo(e,t={}){if(this._map.flyTo)return this._map.flyTo(e,t);var i;(i="flyTo is not supported by this map")in iw||(iw[i]=!0,console.error(i))}getPitch(){return this._map.getPitch()}getProjectionCenter(){return this._map.getProjectionCenter()}getCameraDistance(e){return this._map.getCameraDistance(e)}getBounds(){return this._map.getBounds()}getProjectionBounds(){return this._map.getProjectionBounds()}getResolution(){return this._map.getResolution()}projectArrayCoordinate(e,t){return this._map.projectArrayCoordinate(e,t)}unprojectArrayCoordinate(e,t){return this._map.unprojectArrayCoordinate(e,t)}projectPointArr(e,t){return console.warn("projectPointArr is deprecated, use projectArrayCoordinate instead"),this.projectArrayCoordinate(e,t)}unprojectPointArr(e,t){return console.warn("unprojectPointArr is deprecated, use unprojectArrayCoordinate instead"),this.unprojectArrayCoordinate(e,t)}projectCoordinate(e,t){return this._projection.projectCoordinate(e,t)}unprojectCoordinate(e,t){return this._projection.unprojectCoordinate(e,t)}projectArrayCoordinates(e){if(Array.isArray(e[0])){const t=[];for(let i of e)t.push(this.projectArrayCoordinates(i));return t}if("number"==typeof e[0]||"string"==typeof e[0])return this.projectArrayCoordinate(e)}enableControl(){this._map.enableControl()}disableControl(){this._map.disableControl()}updateCamera(){this._map.updateCamera()}getScaleAt(e){return 1/Math.cos(Math.PI*e[1]/180)}zoomIn(){this._map.zoomIn()}zoomOut(){this._map.zoomOut()}zoomTo(e,t={range:0,zoom:0}){let i=null;if(e.is3DTiles)i=e.getBounds();else if(e.isInstancedMesh)e.computeBoundingBox(),i=e.boundingBox,i=i.clone(),i.applyMatrix4(e.matrixWorld);else if(e.isMesh||e.isPoints){const t=e.geometry;i=t.boundingBox,i||(t.computeBoundingBox(),i=t.boundingBox),i=i.clone(),i.applyMatrix4(e.matrixWorld)}else e.boundingBox&&(i=e.boundingBox,i=i.clone(),i.applyMatrix4(e.matrixWorld));if(!i)return;const n=this.getResolution(),s=(i.max.x-i.min.x)/n.x,o=(i.max.y-i.min.y)/n.y,r=Math.max(s,o),a=this._map.getZoomByZoomUnits(r),l=[(i.max.x+i.min.x)/2,(i.max.y+i.min.y)/2,(i.max.z+i.min.z)/2];if(this._map.isBlankMap3D||this.isGlobe){let e=Math.max(i.max.x-i.min.x,i.max.y-i.min.y)/Math.tan(this.fov/2*Math.PI/180);this.lookAt(l,{range:e+t.range}),this._map.range=e+t.range}else this._map.setProjectionCenter(l),this._map.setZoom(a+t.zoom);this._engine.requestRender()}getViewHeight(){return this._map.getViewHeight()}getCameraLocation(e){return this._map.getCameraLocation(e)}setViewport(e,t={range:0,zoom:0}){if(!e||e.length<2)return void console.warn("setViewport: points require Array with at least 2 points");let i=new qt,n=e.map((e=>{let t=this.projectArrayCoordinate(e);return new Qt(t[0],t[1],t[2]||0)}));i.setFromPoints(n);const s=this.getResolution(),o=(i.max.x-i.min.x)/s.x,r=(i.max.y-i.min.y)/s.y,a=Math.max(o,r),l=Math.min(30,this._map.getZoomByZoomUnits(a)),g=[(i.max.x+i.min.x)/2,(i.max.y+i.min.y)/2,(i.max.z+i.min.z)/2];if(this._map.isBlankMap3D||this.isGlobe){let e=Math.max(i.max.x-i.min.x,i.max.y-i.min.y)/Math.tan(this.fov/2*Math.PI/180);this.lookAt(g,{range:e+t.range}),this._map.range=e+t.range}else this._map.setProjectionCenter(g),this._map.setZoom(l+t.zoom);this._engine.requestRender()}bindCanvas(){this._map.bindCanvas()}releaseCanvas(){this._map.releaseCanvas()}pickSeaLevelWorldPosition(e){return this._map.pickSeaLevelWorldPosition(e)}dispose(){this._map.dispose()}set onResolutionChanged(e){this._map.onResolutionChanged=e}get projectionName(){return this._projection.name}get map(){return this._map}get mapType(){return this._mapType}get container(){return this._container}get fov(){return this._map.fov}set fov(e){this._map.fov=e,this._engine.camera.fov=e}get near(){return this._map.near}get far(){return this._map.far}get projection(){return this._projection}set projection(e){this._projection=e}get mapView(){return this._mapView}}class yE extends Ji{constructor(){super(),__publicField(this,"_boxGeometry"),__publicField(this,"_boxMesh"),this._boxMaterial=new Cn({transparent:!0,color:16711680,opacity:.3})}attach(e){this._object=e;const t=e.geometry;t.boundingBox||t.computeBoundingBox(),this._boxGeometry&&this._boxGeometry.dispose();const i=t.boundingBox;if(this._boxGeometry=new ns(i.max.x-i.min.x,i.max.y-i.min.y,i.max.z-i.min.z),this._boxMesh)this._boxMesh.geometry=this._boxGeometry;else{const e=this._boxMesh=new ts(this._boxGeometry,this._boxMaterial);this.add(e)}}detach(){this._object=null,this.remove(this._boxMesh),this._boxMesh=null}onBeforeScenePrepareRender(){if(this._object){this._object.updateMatrixWorld();const e=this._boxMesh;this._object.matrixWorld.decompose(e.position,e.rotation,e.scale)}}}const _E=new yg,vE=new Qt,xE=new Qt,BE=new Ut,wE={X:new Qt(1,0,0),Y:new Qt(0,1,0),Z:new Qt(0,0,1)},SE={type:"change"},GE={type:"pointerdown"},ME={type:"pointerup",mode:null},RE={type:"pointermove",mode:null},TE={type:"objectChange"};class ZE extends Ji{constructor(e,t){super(),__publicField(this,"_cameraScale"),__publicField(this,"_endNorm"),__publicField(this,"_gizmo"),__publicField(this,"_getPointer"),__publicField(this,"_onPointerDown"),__publicField(this,"_onPointerHover"),__publicField(this,"_onPointerMove"),__publicField(this,"_onPointerUp"),__publicField(this,"_parentPosition"),__publicField(this,"_parentQuaternion"),__publicField(this,"_parentQuaternionInv"),__publicField(this,"_parentScale"),__publicField(this,"_plane"),__publicField(this,"_positionStart"),__publicField(this,"_quaternionStart"),__publicField(this,"_scaleStart"),__publicField(this,"_startNorm"),__publicField(this,"_worldQuaternionInv"),__publicField(this,"_worldScale"),__publicField(this,"_worldScaleStart"),__publicField(this,"_offset"),__publicField(this,"isTransformControls"),void 0===t&&(console.warn('THREE.TransformControls: The second parameter "domElement" is now mandatory.'),t=document),this.visible=!1,this.domElement=t,this.domElement.style.touchAction="none";const i=new $E;this._gizmo=i,this.add(i);const n=new eN;this._plane=n,this.add(n);const s=this;function o(e,t){let o=t;Object.defineProperty(s,e,{get:function(){return void 0!==o?o:t},set:function(t){o!==t&&(o=t,n[e]=t,i[e]=t,s.dispatchEvent({type:e+"-changed",value:t}),s.dispatchEvent(SE))}}),s[e]=t,n[e]=t,i[e]=t}o("camera",e),o("object",void 0),o("enabled",!0),o("axis",null),o("mode","translate"),o("translationSnap",null),o("rotationSnap",null),o("scaleSnap",null),o("space","local"),o("size",.7),o("dragging",!1),o("showX",!0),o("showY",!0),o("showZ",!0);const r=new Qt,a=new Qt,l=new Ut,g=new Ut,c=new Qt,d=new Ut,h=new Qt,u=new Qt,I=new Qt,p=new Qt;o("worldPosition",r),o("worldPositionStart",a),o("worldQuaternion",l),o("worldQuaternionStart",g),o("cameraPosition",c),o("cameraQuaternion",d),o("pointStart",h),o("pointEnd",u),o("rotationAxis",I),o("rotationAngle",0),o("eye",p),this._offset=new Qt,this._startNorm=new Qt,this._endNorm=new Qt,this._cameraScale=new Qt,this._parentPosition=new Qt,this._parentQuaternion=new Ut,this._parentQuaternionInv=new Ut,this._parentScale=new Qt,this._worldScaleStart=new Qt,this._worldQuaternionInv=new Ut,this._worldScale=new Qt,this._positionStart=new Qt,this._quaternionStart=new Ut,this._scaleStart=new Qt,this._getPointer=VE.bind(this),this._onPointerDown=EE.bind(this),this._onPointerHover=WE.bind(this),this._onPointerMove=NE.bind(this),this._onPointerUp=FE.bind(this),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp)}updateMatrixWorld(){void 0!==this.object&&(this.object.updateMatrixWorld(),null===this.object.parent?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(this._parentPosition,this._parentQuaternion,this._parentScale),this.object.matrixWorld.decompose(this.worldPosition,this.worldQuaternion,this._worldScale),this._parentQuaternionInv.copy(this._parentQuaternion).invert(),this._worldQuaternionInv.copy(this.worldQuaternion).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(this.cameraPosition,this.cameraQuaternion,this._cameraScale),this.eye.copy(this.cameraPosition).sub(this.worldPosition).normalize(),super.updateMatrixWorld(this)}pointerHover(e){if(void 0===this.object||!0===this.dragging)return;_E.setFromCamera(e,this.camera);const t=XE(this._gizmo.picker[this.mode],_E);this.axis=t?t.object.name:null}pointerDown(e){if(void 0!==this.object&&!0!==this.dragging&&0===e.button&&null!==this.axis){_E.setFromCamera(e,this.camera);const t=XE(this._plane,_E,!0);t&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(t.point).sub(this.worldPositionStart)),this.dragging=!0,GE.mode=this.mode,this.dispatchEvent(GE)}}pointerMove(e){const t=this.axis,i=this.mode,n=this.object;let s=this.space;if("scale"===i?s="local":"E"!==t&&"XYZE"!==t&&"XYZ"!==t||(s="world"),void 0===n||null===t||!1===this.dragging||-1!==e.button)return;_E.setFromCamera(e,this.camera);const o=XE(this._plane,_E,!0);if(o){if(this.pointEnd.copy(o.point).sub(this.worldPositionStart),"translate"===i)this._offset.copy(this.pointEnd).sub(this.pointStart),"local"===s&&"XYZ"!==t&&this._offset.applyQuaternion(this._worldQuaternionInv),-1===t.indexOf("X")&&(this._offset.x=0),-1===t.indexOf("Y")&&(this._offset.y=0),-1===t.indexOf("Z")&&(this._offset.z=0),"local"===s&&"XYZ"!==t?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),n.position.copy(this._offset).add(this._positionStart),this.translationSnap&&("local"===s&&(n.position.applyQuaternion(BE.copy(this._quaternionStart).invert()),-1!==t.search("X")&&(n.position.x=Math.round(n.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(n.position.y=Math.round(n.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(n.position.z=Math.round(n.position.z/this.translationSnap)*this.translationSnap),n.position.applyQuaternion(this._quaternionStart)),"world"===s&&(n.parent&&n.position.add(vE.setFromMatrixPosition(n.parent.matrixWorld)),-1!==t.search("X")&&(n.position.x=Math.round(n.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(n.position.y=Math.round(n.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(n.position.z=Math.round(n.position.z/this.translationSnap)*this.translationSnap),n.parent&&n.position.sub(vE.setFromMatrixPosition(n.parent.matrixWorld))));else if("scale"===i){if(-1!==t.search("XYZ")){let e=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(e*=-1),xE.set(e,e,e)}else vE.copy(this.pointStart),xE.copy(this.pointEnd),vE.applyQuaternion(this._worldQuaternionInv),xE.applyQuaternion(this._worldQuaternionInv),xE.divide(vE),-1===t.search("X")&&(xE.x=1),-1===t.search("Y")&&(xE.y=1),-1===t.search("Z")&&(xE.z=1);n.scale.copy(this._scaleStart).multiply(xE),this.scaleSnap&&(-1!==t.search("X")&&(n.scale.x=Math.round(n.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Y")&&(n.scale.y=Math.round(n.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Z")&&(n.scale.z=Math.round(n.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if("rotate"===i){this._offset.copy(this.pointEnd).sub(this.pointStart);const e=20/this.worldPosition.distanceTo(vE.setFromMatrixPosition(this.camera.matrixWorld));"E"===t?(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1):"XYZE"===t?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(vE.copy(this.rotationAxis).cross(this.eye))*e):"X"!==t&&"Y"!==t&&"Z"!==t||(this.rotationAxis.copy(wE[t]),vE.copy(wE[t]),"local"===s&&vE.applyQuaternion(this.worldQuaternion),this.rotationAngle=this._offset.dot(vE.cross(this.eye).normalize())*e),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),"local"===s&&"E"!==t&&"XYZE"!==t?(n.quaternion.copy(this._quaternionStart),n.quaternion.multiply(BE.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),n.quaternion.copy(BE.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),n.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(SE),this.dispatchEvent(TE),RE.mode=this.mode,this.dispatchEvent(RE)}}pointerUp(e){0===e.button&&(this.dragging&&null!==this.axis&&(ME.mode=this.mode,this.dispatchEvent(ME)),this.dragging=!1,this.axis=null)}dispose(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.traverse((function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}))}attach(e){return this.object=e,this.visible=!0,this}detach(){return this.object=void 0,this.visible=!1,this.axis=null,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(SE),this.dispatchEvent(TE),this.pointStart.copy(this.pointEnd))}getRaycaster(){return _E}getMode(){return this.mode}setMode(e){this.mode=e}setTranslationSnap(e){this.translationSnap=e}setRotationSnap(e){this.rotationSnap=e}setScaleSnap(e){this.scaleSnap=e}setSize(e){this.size=e}setSpace(e){this.space=e}update(){console.warn("THREE.TransformControls: update function has no more functionality and therefore has been deprecated.")}}function VE(e){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:e.button};{const t=this.domElement.getBoundingClientRect();return{x:(e.clientX-t.left)/t.width*2-1,y:-(e.clientY-t.top)/t.height*2+1,button:e.button}}}function WE(e){if(this.enabled)switch(e.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(e))}}function EE(e){this.enabled&&(this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(e)),this.pointerDown(this._getPointer(e)))}function NE(e){this.enabled&&this.pointerMove(this._getPointer(e))}function FE(e){this.enabled&&(this.domElement.releasePointerCapture(e.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(e)))}function XE(e,t,i){const n=t.intersectObject(e,!0);for(let s=0;s<n.length;s++)if(n[s].object.visible||i)return n[s];return!1}ZE.prototype.isTransformControls=!0;const HE=new Ei,zE=new Qt(0,1,0),LE=new Qt(0,0,0),DE=new Bi,KE=new Ut,YE=new Ut,PE=new Qt,kE=new Bi,OE=new Qt(1,0,0),UE=new Qt(0,1,0),QE=new Qt(0,0,1),JE=new Qt,jE=new Qt,qE=new Qt;class $E extends Ji{constructor(){super(),this.type="TransformControlsGizmo";const e=new Cn({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),t=new Wa({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),i=e.clone();i.opacity=.15;const n=t.clone();n.opacity=.5;const s=e.clone();s.color.setHex(16711680);const o=e.clone();o.color.setHex(65280);const r=e.clone();r.color.setHex(255);const a=e.clone();a.color.setHex(16711680),a.opacity=.5;const l=e.clone();l.color.setHex(65280),l.opacity=.5;const g=e.clone();g.color.setHex(255),g.opacity=.5;const c=e.clone();c.opacity=.25;const d=e.clone();d.color.setHex(16776960),d.opacity=.25;e.clone().color.setHex(16776960);const h=e.clone();h.color.setHex(7895160);const u=new nl(0,.04,.1,12);u.translate(0,.05,0);const I=new ns(.08,.08,.08);I.translate(0,.04,0);const p=new Fn;p.setAttribute("position",new Mn([0,0,0,1,0,0],3));const m=new nl(.0075,.0075,.5,3);function A(e,t){const i=new hl(e,.0075,3,64,t*Math.PI*2);return i.rotateY(Math.PI/2),i.rotateX(Math.PI/2),i}m.translate(0,.25,0);const C={X:[[new ts(u,s),[.5,0,0],[0,0,-Math.PI/2]],[new ts(u,s),[-.5,0,0],[0,0,Math.PI/2]],[new ts(m,s),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new ts(u,o),[0,.5,0]],[new ts(u,o),[0,-.5,0],[Math.PI,0,0]],[new ts(m,o)]],Z:[[new ts(u,r),[0,0,.5],[Math.PI/2,0,0]],[new ts(u,r),[0,0,-.5],[-Math.PI/2,0,0]],[new ts(m,r),null,[Math.PI/2,0,0]]],XYZ:[[new ts(new cl(.1,0),c.clone()),[0,0,0]]],XY:[[new ts(new ns(.15,.15,.01),g.clone()),[.15,.15,0]]],YZ:[[new ts(new ns(.15,.15,.01),a.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new ts(new ns(.15,.15,.01),l.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},f={X:[[new ts(new nl(.2,0,.6,4),i),[.3,0,0],[0,0,-Math.PI/2]],[new ts(new nl(.2,0,.6,4),i),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new ts(new nl(.2,0,.6,4),i),[0,.3,0]],[new ts(new nl(.2,0,.6,4),i),[0,-.3,0],[0,0,Math.PI]]],Z:[[new ts(new nl(.2,0,.6,4),i),[0,0,.3],[Math.PI/2,0,0]],[new ts(new nl(.2,0,.6,4),i),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new ts(new cl(.2,0),i)]],XY:[[new ts(new ns(.2,.2,.01),i),[.15,.15,0]]],YZ:[[new ts(new ns(.2,.2,.01),i),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new ts(new ns(.2,.2,.01),i),[.15,0,.15],[-Math.PI/2,0,0]]]},b={START:[[new ts(new cl(.01,2),n),null,null,null,"helper"]],END:[[new ts(new cl(.01,2),n),null,null,null,"helper"]],DELTA:[[new za(function(){const e=new Fn;return e.setAttribute("position",new Mn([0,0,0,1,1,1],3)),e}(),n),null,null,null,"helper"]],X:[[new za(p,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new za(p,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new za(p,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},y={XYZE:[[new ts(A(.5,1),h),null,[0,Math.PI/2,0]]],X:[[new ts(A(.5,.5),s)]],Y:[[new ts(A(.5,.5),o),null,[0,0,-Math.PI/2]]],Z:[[new ts(A(.5,.5),r),null,[0,Math.PI/2,0]]],E:[[new ts(A(.75,1),d),null,[0,Math.PI/2,0]]]},_={AXIS:[[new za(p,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},v={XYZE:[[new ts(new dl(.25,10,8),i)]],X:[[new ts(new hl(.5,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new ts(new hl(.5,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new ts(new hl(.5,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new ts(new hl(.75,.1,2,24),i)]]},x={X:[[new ts(I,s),[.5,0,0],[0,0,-Math.PI/2]],[new ts(m,s),[0,0,0],[0,0,-Math.PI/2]],[new ts(I,s),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new ts(I,o),[0,.5,0]],[new ts(m,o)],[new ts(I,o),[0,-.5,0],[0,0,Math.PI]]],Z:[[new ts(I,r),[0,0,.5],[Math.PI/2,0,0]],[new ts(m,r),[0,0,0],[Math.PI/2,0,0]],[new ts(I,r),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new ts(new ns(.15,.15,.01),g),[.15,.15,0]]],YZ:[[new ts(new ns(.15,.15,.01),a),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new ts(new ns(.15,.15,.01),l),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new ts(new ns(.1,.1,.1),c.clone())]]},B={X:[[new ts(new nl(.2,0,.6,4),i),[.3,0,0],[0,0,-Math.PI/2]],[new ts(new nl(.2,0,.6,4),i),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new ts(new nl(.2,0,.6,4),i),[0,.3,0]],[new ts(new nl(.2,0,.6,4),i),[0,-.3,0],[0,0,Math.PI]]],Z:[[new ts(new nl(.2,0,.6,4),i),[0,0,.3],[Math.PI/2,0,0]],[new ts(new nl(.2,0,.6,4),i),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new ts(new ns(.2,.2,.01),i),[.15,.15,0]]],YZ:[[new ts(new ns(.2,.2,.01),i),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new ts(new ns(.2,.2,.01),i),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new ts(new ns(.2,.2,.2),i),[0,0,0]]]},w={X:[[new za(p,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new za(p,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new za(p,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function S(e){const t=new Ji;for(const i in e)for(let n=e[i].length;n--;){const s=e[i][n][0].clone(),o=e[i][n][1],r=e[i][n][2],a=e[i][n][3],l=e[i][n][4];s.name=i,s.tag=l,o&&s.position.set(o[0],o[1],o[2]),r&&s.rotation.set(r[0],r[1],r[2]),a&&s.scale.set(a[0],a[1],a[2]),s.updateMatrix();const g=s.geometry.clone();g.applyMatrix4(s.matrix),s.geometry=g,s.renderOrder=1/0,s.position.set(0,0,0),s.rotation.set(0,0,0),s.scale.set(1,1,1),t.add(s)}return t}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=S(C)),this.add(this.gizmo.rotate=S(y)),this.add(this.gizmo.scale=S(x)),this.add(this.picker.translate=S(f)),this.add(this.picker.rotate=S(v)),this.add(this.picker.scale=S(B)),this.add(this.helper.translate=S(b)),this.add(this.helper.rotate=S(_)),this.add(this.helper.scale=S(w)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}onBeforeScenePrepareRender(){const e="local"===("scale"===this.mode?"local":this.space)?this.worldQuaternion:YE;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;let t=[];t=t.concat(this.picker[this.mode].children),t=t.concat(this.gizmo[this.mode].children),t=t.concat(this.helper[this.mode].children);for(let i=0;i<t.length;i++){const n=t[i];let s;if(n.visible=!0,n.rotation.set(0,0,0),n.position.copy(this.worldPosition),s=this.camera.isOrthographicCamera?(this.camera.top-this.camera.bottom)/this.camera.zoom:this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),n.scale.set(1,1,1).multiplyScalar(s*this.size/4),"helper"!==n.tag){if(n.quaternion.copy(e),"translate"===this.mode||"scale"===this.mode){const t=.99,i=.2;"X"===n.name&&Math.abs(zE.copy(OE).applyQuaternion(e).dot(this.eye))>t&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"Y"===n.name&&Math.abs(zE.copy(UE).applyQuaternion(e).dot(this.eye))>t&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"Z"===n.name&&Math.abs(zE.copy(QE).applyQuaternion(e).dot(this.eye))>t&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"XY"===n.name&&Math.abs(zE.copy(QE).applyQuaternion(e).dot(this.eye))<i&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"YZ"===n.name&&Math.abs(zE.copy(OE).applyQuaternion(e).dot(this.eye))<i&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"XZ"===n.name&&Math.abs(zE.copy(UE).applyQuaternion(e).dot(this.eye))<i&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1)}else"rotate"===this.mode&&(KE.copy(e),zE.copy(this.eye).applyQuaternion(BE.copy(e).invert()),-1!==n.name.search("E")&&n.quaternion.setFromRotationMatrix(DE.lookAt(this.eye,LE,UE)),"X"===n.name&&(BE.setFromAxisAngle(OE,Math.atan2(-zE.y,zE.z)),BE.multiplyQuaternions(KE,BE),n.quaternion.copy(BE)),"Y"===n.name&&(BE.setFromAxisAngle(UE,Math.atan2(zE.x,zE.z)),BE.multiplyQuaternions(KE,BE),n.quaternion.copy(BE)),"Z"===n.name&&(BE.setFromAxisAngle(QE,Math.atan2(zE.y,zE.x)),BE.multiplyQuaternions(KE,BE),n.quaternion.copy(BE)));n.visible=n.visible&&(-1===n.name.indexOf("X")||this.showX),n.visible=n.visible&&(-1===n.name.indexOf("Y")||this.showY),n.visible=n.visible&&(-1===n.name.indexOf("Z")||this.showZ),n.visible=n.visible&&(-1===n.name.indexOf("E")||this.showX&&this.showY&&this.showZ),n.material._color=n.material._color||n.material.color.clone(),n.material._opacity=n.material._opacity||n.material.opacity,n.material.color.copy(n.material._color),n.material.opacity=n.material._opacity,this.enabled&&this.axis&&(n.name===this.axis||this.axis.split("").some((function(e){return n.name===e})))&&(n.material.color.setHex(16776960),n.material.opacity=1)}else n.visible=!1,"AXIS"===n.name?(n.position.copy(this.worldPositionStart),n.visible=!!this.axis,"X"===this.axis&&(BE.setFromEuler(HE.set(0,0,0)),n.quaternion.copy(e).multiply(BE),Math.abs(zE.copy(OE).applyQuaternion(e).dot(this.eye))>.9&&(n.visible=!1)),"Y"===this.axis&&(BE.setFromEuler(HE.set(0,0,Math.PI/2)),n.quaternion.copy(e).multiply(BE),Math.abs(zE.copy(UE).applyQuaternion(e).dot(this.eye))>.9&&(n.visible=!1)),"Z"===this.axis&&(BE.setFromEuler(HE.set(0,Math.PI/2,0)),n.quaternion.copy(e).multiply(BE),Math.abs(zE.copy(QE).applyQuaternion(e).dot(this.eye))>.9&&(n.visible=!1)),"XYZE"===this.axis&&(BE.setFromEuler(HE.set(0,Math.PI/2,0)),zE.copy(this.rotationAxis),n.quaternion.setFromRotationMatrix(DE.lookAt(LE,zE,UE)),n.quaternion.multiply(BE),n.visible=this.dragging),"E"===this.axis&&(n.visible=!1)):"START"===n.name?(n.position.copy(this.worldPositionStart),n.visible=this.dragging):"END"===n.name?(n.position.copy(this.worldPosition),n.visible=this.dragging):"DELTA"===n.name?(n.position.copy(this.worldPositionStart),n.quaternion.copy(this.worldQuaternionStart),vE.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),vE.applyQuaternion(this.worldQuaternionStart.clone().invert()),n.scale.copy(vE),n.visible=this.dragging):(n.quaternion.copy(e),this.dragging?n.position.copy(this.worldPositionStart):n.position.copy(this.worldPosition),this.axis&&(n.visible=-1!==this.axis.search(n.name)))}}}$E.prototype.isTransformControlsGizmo=!0;class eN extends ts{constructor(){super(new xs(1e5,1e5,2,2),new Cn({visible:!1,wireframe:!0,side:2,transparent:!0,opacity:.1,toneMapped:!1})),this.type="TransformControlsPlane"}updateMatrixWorld(e){let t=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(t="local"),JE.copy(OE).applyQuaternion("local"===t?this.worldQuaternion:YE),jE.copy(UE).applyQuaternion("local"===t?this.worldQuaternion:YE),qE.copy(QE).applyQuaternion("local"===t?this.worldQuaternion:YE),zE.copy(jE),this.mode){case"translate":case"scale":switch(this.axis){case"X":zE.copy(this.eye).cross(JE),PE.copy(JE).cross(zE);break;case"Y":zE.copy(this.eye).cross(jE),PE.copy(jE).cross(zE);break;case"Z":zE.copy(this.eye).cross(qE),PE.copy(qE).cross(zE);break;case"XY":PE.copy(qE);break;case"YZ":PE.copy(JE);break;case"XZ":zE.copy(qE),PE.copy(jE);break;case"XYZ":case"E":PE.set(0,0,0)}break;default:PE.set(0,0,0)}0===PE.length()?this.quaternion.copy(this.cameraQuaternion):(kE.lookAt(vE.set(0,0,0),PE,zE),this.quaternion.setFromRotationMatrix(kE)),super.updateMatrixWorld(e)}raycast(e,t){t.length||super.raycast(e,t)}}eN.prototype.isTransformControlsPlane=!0;class tN extends ZE{constructor(e){super(e.camera,e.map.container),__publicField(this,"_enableKeyboardEvent",!1),__publicField(this,"handleKeyboardEvent",(e=>{switch(e.keyCode){case 81:this.setSpace("local"===this.space?"world":"local");break;case 87:this.setMode("translate");break;case 69:this.setMode("rotate");break;case 82:this.setMode("scale");break;case 187:case 107:this.setSize(this.size+.1);break;case 189:case 109:this.setSize(Math.max(this.size-.1,.1));break;case 88:this.showX=!this.showX;break;case 89:this.showY=!this.showY;break;case 90:this.showZ=!this.showZ;break;case 32:this.enabled=!this.enabled;break;case 27:this.reset()}})),this.engine=e,this.addEventListener("change",(t=>{e.requestRender()})),this.addEventListener("objectChange",(t=>{e.requestRender()})),this.addEventListener("dragging-changed",(t=>{t.value?e.map.disableControl():e.map.enableControl()}))}dispose(){super.dispose(),this.enableKeyboardEvent=!1}set enableKeyboardEvent(e){e!==this._enableKeyboardEvent&&(this._enableKeyboardEvent=e,e?window.addEventListener("keydown",this.handleKeyboardEvent):window.removeEventListener("keydown",this.handleKeyboardEvent))}}class iN extends ot{constructor(e,t={}){super(),__publicField(this,"_engine"),__publicField(this,"_boundingBoxHelper"),__publicField(this,"_selectedObject"),__publicField(this,"_transformControl"),this._engine=e}isSelected(e){return e===this._selectedObject}select(e){e.__engine_selected||(this._selectedObject&&(this._selectedObject.__engine_selected=!1),this._boundingBoxHelper||(this._boundingBoxHelper=new yE,this._engine.add(this._boundingBoxHelper)),this._boundingBoxHelper.attach(e),this._selectedObject=e,e.__engine_selected=!0,this._engine.requestRender())}deselect(e){this.isSelected(e)&&(this._boundingBoxHelper.detach(),this._selectedObject=null,e.__engine_selected=!1,this._engine.requestRender())}get transformControl(){return this._transformControl||(this._transformControl=new tN(this._engine),this._transformControl.enableKeyboardEvent=!0),this._transformControl}attachTransform(e){const t=this._engine,i=this.transformControl;t.add(i),i.attach(e),i.updateMatrixWorld(),t.requestRender()}detachTransform(){const e=this._engine,t=this.transformControl;e.remove(t),t.detach()}dispose(){}}class nN{constructor(e,t,i=null){__publicField(this,"_container"),__publicField(this,"_enabled"),__publicField(this,"_options",{}),__publicField(this,"_element"),__publicField(this,"_engine"),this._container=e,this._engine=i,t&&"object"==typeof t?(this._options=t,this._enabled=t.enabled):this._enabled=!1,this._element=null,this._enabled&&this.init()}init(){let e=this._element=this.createDom();this._container.appendChild(e),this.afterInit()}afterInit(){}createDom(){return null}dispose(){this._element&&(this.onDispose(),this._element.remove())}onDispose(){}get container(){return this._container}get element(){return this._element}get enabled(){return this._enabled}set enabled(e){const t=!!e;if(this._enabled!==t){const e=t?"visible":"hidden";this._element?(this._element.style.visibility=e,this.onDispose()):e&&this.init(),this._enabled=t}}}class sN extends nN{afterInit(){this._options&&this._options.url&&(this.url=this._options.url)}createDom(){return this._element=document.createElement("img"),i(this._element,"logo"),this._url=this._url||mm("assets/images/bdImg.png"),this._element.src=this._url,this._element}set url(e){this._element&&(this._element.src=e),this._url=e}get url(){return this._url}}class oN extends nN{createDom(){this.handleZoomIn=this.handleZoomIn.bind(this),this.handleZoomOut=this.handleZoomOut.bind(this),this._element=document.createElement("div"),i(this._element,"zoom");const e=this._zoomAdd=document.createElement("div");i(e,"zoom-add");const t=document.createElement("div");i(t,"zoom-add-tag"),t.setAttribute("style",`background-image: url(${mm("assets/images/mapZoom2x.png")});`),e.addEventListener(fw.DOWN,this.handleZoomIn),e.appendChild(t);const n=this._zoomSub=document.createElement("div");i(n,"zoom-sub");const s=document.createElement("div");return i(s,"zoom-sub-tag"),s.setAttribute("style",`background-image: url(${mm("assets/images/mapZoom2x.png")});`),n.addEventListener(fw.DOWN,this.handleZoomOut),n.appendChild(s),this._element.appendChild(e),this._element.appendChild(n),this._element}handleZoomIn(){this._engine.map.zoomIn()}handleZoomOut(){this._engine.map.zoomOut()}onDispose(){this._zoomAdd.removeEventListener(fw.DOWN,this.handleZoomIn),this._zoomSub.removeEventListener(fw.DOWN,this.handleZoomOut)}}class rN extends nN{createDom(){this._element=document.createElement("div"),i(this._element,"scale"),this._text=document.createElement("div"),i(this._text,"scale-text"),this._text.innerText="20km";const e=document.createElement("div");i(e,"scale-line");const t=document.createElement("div");i(t,"scale-line-mid");const n=document.createElement("div");i(n,"scale-line-left");const s=document.createElement("div");return i(s,"scale-line-right"),e.appendChild(t),e.appendChild(n),e.appendChild(s),this._element.appendChild(this._text),this._element.appendChild(e),this.calculateScale=this.calculateScale.bind(this),this._engine.rendering.addPrepareRenderListener(this.calculateScale),this._element}calculateScale(){const e=this._engine.map.getZoomUnitsByZoom(this._engine.map.getZoom());let t=0;const i=[.05,.1,.2];for(let n=0;n<3&&t<7;n++){const s=i[n]*Math.pow(10,t),o=s/e;if(o>=50&&o<=150){if(this._element.style.width=o+"px",t<1)this._text.innerText=(s<.1?5:100*s)+"cm";else if(t<2)this._text.innerText=(s<1?5:10*s)+"dm";else{const e=s/1e3,t=e<1;this._text.innerText=t?s+"m":e+"km"}break}n<1&&t<1&&o>150&&(this._element.style.width="150px",this._text.innerText="< 5cm"),n>1&&(t++,n=0)}}onDispose(){this._engine.rendering.removePrepareRenderListener(this.calculateScale)}}const aN="M358.4 768H426.666667v85.333333H213.333333v-213.333333h85.333334v68.266667l128-128 59.733333 59.733333-128 128z m345.6 0l-128-128 59.733333-59.733333 132.266667 132.266666V640h85.333333v213.333333h-213.333333v-85.333333h64zM358.4 298.666667l128 128-59.733333 59.733333-128-128V426.666667H213.333333V213.333333h213.333334v85.333334H358.4z m345.6 0H640V213.333333h213.333333v213.333334h-85.333333V354.133333l-132.266667 132.266667-59.733333-59.733333 128-128z";class lN extends nN{createDom(){this.handleClick=this.handleClick.bind(this),this.handleFullscreenChange=this.handleFullscreenChange.bind(this),this._element=document.createElement("div"),i(this._element,"fullscreen");const e=document.createElementNS("http://www.w3.org/2000/svg","svg");return e.setAttribute("class","widgets-group-svg fullscreen-svg"),e.setAttribute("viewBox","0 0 1024 1024"),e.setAttribute("version","1.1"),this._path=document.createElementNS("http://www.w3.org/2000/svg","path"),this._path.setAttribute("d",aN),this._path.setAttribute("class","fullscreen-path"),e.appendChild(this._path),this._flag=!0,this._element.addEventListener(fw.DOWN,this.handleClick),document.addEventListener("fullscreenchange",this.handleFullscreenChange),this._element.appendChild(e),this._element}handleClick(){const e=this._engine.container,t=e instanceof HTMLElement||e&&"object"==typeof e&&1===e.nodeType&&"string"==typeof e.nodeName?e:e.container||e._container;this._flag?t.requestFullscreen?t.requestFullscreen():t.msRequestFullscreen?t.msRequestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullScreen&&t.webkitRequestFullScreen():document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen()}handleFullscreenChange(){this._flag=!this._flag,this._flag?this._path.setAttribute("d",aN):this._path.setAttribute("d","M298.666667 631.466667H226.133333v-81.066667h217.6v204.8h-85.333333v-68.266667l-128 128L170.666667 759.466667l128-128z m422.4 0l128 128-59.733334 59.733333-128-128v68.266667h-85.333333V554.666667h217.6v81.066666h-72.533333zM298.666667 341.333333L187.733333 230.4 243.2 170.666667l115.2 115.2V217.6h85.333333v204.8H226.133333V341.333333H298.666667z m430.933333 0h64v81.066667h-217.6V217.6h85.333333v72.533333L780.8 170.666667l59.733333 59.733333L729.6 341.333333z")}onDispose(){this._element.removeEventListener(fw.DOWN,this.handleClick),document.removeEventListener("fullscreenchange",this.handleFullscreenChange)}}class gN extends nN{createDom(){this.locate=this.locate.bind(this),this._element=document.createElement("div"),i(this._element,"geo-locate");const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("class","widgets-group-svg geo-locate-svg"),e.setAttribute("viewBox","0 0 1024 1024"),e.setAttribute("version","1.1");const t=document.createElementNS("http://www.w3.org/2000/svg","path");return t.setAttribute("d","M87.424 469.312A426.816 426.816 0 0 1 469.312 87.424V0h85.376v87.424a426.816 426.816 0 0 1 381.888 381.888H1024v85.376h-87.424a426.816 426.816 0 0 1-381.888 381.888V1024h-85.376v-87.424A426.816 426.816 0 0 1 87.424 554.688H0v-85.376h87.424z m424.576 384a341.312 341.312 0 1 0 0-682.624 341.312 341.312 0 0 0 0 682.624z m0-170.624a170.688 170.688 0 1 0 0-341.376 170.688 170.688 0 0 0 0 341.376z"),t.setAttribute("class","geo-locate-path"),e.appendChild(t),this._element.addEventListener(fw.DOWN,this.locate),this._element.appendChild(e),this._element}locate(){window.navigator.geolocation.getCurrentPosition((e=>{var t;const{longitude:i,latitude:n}=null!=(t=e.coords)?t:{};isNaN(i)||isNaN(n)?console.error("定位出错，请重新定位！"):(this._engine.map.setCenter([i,n]),this._engine.map.setZoom(18))}),(e=>{console.error("定位未开启")}))}onDispose(){this._element.removeEventListener(fw.DOWN,this.locate)}}class cN extends nN{constructor(){super(...arguments),__publicField(this,"screenshot",((e,t)=>{const i=this._engine.rendering.canvas,n=this._engine.map.mapType,s=document.createElement("canvas"),o=s.getContext("2d");if(s.width=i.width,s.height=i.height,"bmapgl"===n){const e=this._engine.container._webglPainter._canvas;o.drawImage(e,0,0,e.width,e.height)}else if("mapbox"===n){const e=this._engine.container._canvas;o.drawImage(e,0,0,e.width,e.height)}o.drawImage(i,0,0,i.width,i.height);let r=s.toDataURL();if(t){e=e||"download.png";const t=document.createElement("a");t.href=r,t.download=e,t.click()}return r}))}createDom(){this.handleClick=this.handleClick.bind(this),this._element=document.createElement("div"),i(this._element,"export-image");const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("class","widgets-group-svg export-image-svg"),e.setAttribute("viewBox","0 0 1024 1024"),e.setAttribute("version","1.1");const t=document.createElementNS("http://www.w3.org/2000/svg","path");return t.setAttribute("d","M867.90864 574.538232V257.779543a50.844091 50.844091 0 0 0-50.844092-50.844091h-610.129096a50.844091 50.844091 0 0 0-50.844092 50.844091v499.797418l430.141013-257.779543a152.532274 152.532274 0 0 1 157.108243 0z m0 118.466733l-177.445879-106.264151a50.844091 50.844091 0 0 0-50.844092 0L254.220457 817.064548h562.844091a50.844091 50.844091 0 0 0 50.844092-50.844091z m-660.973188-587.757696h610.129096a152.532274 152.532274 0 0 1 152.532274 152.532274v508.440914a152.532274 152.532274 0 0 1-152.532274 152.532274h-610.129096a152.532274 152.532274 0 0 1-152.532274-152.532274v-508.440914a152.532274 152.532274 0 0 1 152.532274-152.532274z m127.110228 355.90864a76.266137 76.266137 0 1 1 76.266137-76.266137 76.266137 76.266137 0 0 1-76.266137 76.266137z"),e.appendChild(t),this._element.addEventListener(fw.DOWN,this.handleClick),this._element.appendChild(e),this._element}handleClick(){this.screenshot("download.png",!0)}onDispose(){this._element.removeEventListener(fw.DOWN,this.handleClick)}}class dN extends nN{constructor(){super(...arguments),__publicField(this,"_mapInfo",{pitch:0,heading:0,zoom:0,range:0,center:[0,0],mousePoint:[0,0]}),__publicField(this,"_prefix",{M:"指针位置",C:"中心点",Z:"级别",H:"旋转角",P:"倾角",R:"视野距离"}),__publicField(this,"_separator"," | "),__publicField(this,"_template","CR")}afterInit(){this._options&&this._options.template&&(this.template=this._options.template),this._options&&this._options.prefix&&(this.prefix=this._options.prefix),this._options&&this._options.separator&&(this.separator=this._options.separator)}createDom(){return this._element=document.createElement("div"),i(this._element,"mouse-location"),this._enableMousePositionTracking=!1,this._eventName="pointerdown",this.eventCallback=this.update.bind(this),this._engine.map.addEventListener(this._eventName,this.eventCallback),this._viewChangedCallback=()=>{if(this._engine.rendering.renderState.viewChanged){const e=this._engine.map,t=e.getCenter();this._mapInfo.pitch=hN(e.getPitch()),this._mapInfo.heading=hN(e.getHeading()),this._mapInfo.zoom=hN(e.getZoom()),this._mapInfo.center=[t[0].toFixed(6),t[1].toFixed(6)],this._mapInfo.range=hN(e.getRange()),this.updateInfoText()}},this._engine.rendering.addPrepareRenderListener(this._viewChangedCallback),this._element}update(e){const t=e.point;t&&/M/gi.test(this._template)&&(this._mapInfo.mousePoint=[t[0].toFixed(6),t[1].toFixed(6)],this.updateInfoText())}updateInfoText(){const{center:e,heading:t,pitch:i,zoom:n,range:s,mousePoint:o}=this._mapInfo,r={M:o,C:e,Z:n,H:t,P:i,R:s},a=this.template.replace(/[MCZHPR]/gi,(e=>`${this.prefix[e.toUpperCase()]}: ${r[e.toUpperCase()]}${this.separator}`)).slice(0,-this.separator.length);this._element.innerText=a}get enableMousePositionTracking(){return this._enableMousePositionTracking}set enableMousePositionTracking(e){this._enableMousePositionTracking!==e&&(this._enableMousePositionTracking=e,this._engine.map.removeEventListener(this._eventName,this.eventCallback),this._eventName=e?"mousemove":"pointerdown",this._engine.map.addEventListener(this._eventName,this.eventCallback))}get template(){return this._template}set template(e){this._template=e,this.updateInfoText()}get separator(){return this._separator}set separator(e){this._separator=e,this.updateInfoText()}get prefix(){return this._prefix}set prefix(e){this._prefix=e,this.updateInfoText()}onDispose(){this._engine.map.removeEventListener(this._eventName,this.eventCallback),this._engine.rendering.removePrepareRenderListener(this._viewChangedCallback)}}function hN(e,t){if(!t)return Math.round(e);const i=10*t;return Math.round(e*i)/i}class uN extends nN{afterInit(){if(this._options&&this._options.draws){const e=this._options.draws,n=e&&e.length>0?e.length:0,s=document.getElementById(`${t}-drawer-content`);if(this._drawerCheckboxs=[],n>0){const t=this.addChangeListener.bind(this);for(let o=0;o<n;o++){const n=e[o],r=document.createElement("div");i(r,"drawer-item");const a=document.createElement("input");i(a,"drawer-item-check"),t(a,(e=>{e.stopPropagation();const t=e.target.checked;n.onChange&&n.onChange(t,n.data,this._engine)})),a.setAttribute("type","checkbox"),n.defaultChecked&&(a.setAttribute("checked",n.defaultChecked),n.onChange&&n.onChange(!0,n.data,this._engine)),this._drawerCheckboxs.push(a);const l=document.createElement("span");i(l,"drawer-item-name"),l.innerText=n.name,l.onclick=()=>{a.click()},r.appendChild(a),r.appendChild(l),s.appendChild(r)}}}}createDom(){this._element=document.createElement("div"),i(this._element,"drawer");const e=this._drawerBtn=document.createElement("div");i(e,"drawer-btn");const n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("class","drawer-icon"),n.setAttribute("viewBox","0 0 1024 1024"),n.setAttribute("version","1.1");const s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("d","M512 821.504l-416-208-96 48 512 256 512-256-96-48-416 208z m0-181.173333l-416-208-96 48 512 256 512-256-96-48-416 208zM1024 298.666667L512 42.666667 0 298.666667l512 256 512-256zM512 138.058667L833.184 298.666667 512 459.274667 190.816 298.666667 512 138.058667z"),n.appendChild(s),e.addEventListener(fw.DOWN,this.openDrawer.bind(this)),e.appendChild(n);const o=this._drawerList=document.createElement("div");i(o,"drawer-list"),o.setAttribute("id",`${t}-drawer-list`),o.style.display="none";const r=document.createElement("div");i(r,"drawer-content"),r.setAttribute("id",`${t}-drawer-content`);const a=document.createElement("div");return i(a,"drawer-arrow"),o.appendChild(r),o.appendChild(a),this._element.appendChild(e),this._element.appendChild(o),this._element}addChangeListener(e,t){this._eventMap||(this._eventMap=new WeakMap),e.addEventListener("change",t),this._eventMap.set(e,t)}removeChangeListener(e){const t=this._eventMap.get(e);e.removeEventListener("change",t),this._eventMap.delete(e)}openDrawer(){const e=this._drawerList;e.style.display="none"===e.style.display?"block":"none"}onDispose(){this._drawerBtn.removeEventListener(fw.DOWN,this.openDrawer.bind(this));for(let e=0;e<this._drawerCheckboxs.length;e++)this.removeChangeListener(this._drawerCheckboxs[e])}}class IN extends nN{createDom(){this.handleUpBtnClick=this.handleUpBtnClick.bind(this),this.handleDownBtnClick=this.handleDownBtnClick.bind(this),this.handleLeftBtnClick=this.handleLeftBtnClick.bind(this),this.handleRightBtnClick=this.handleRightBtnClick.bind(this),this.handleCenterBtnClick=this.handleCenterBtnClick.bind(this),this._element=document.createElement("div"),i(this._element,"compass"),this._element.setAttribute("style",`background-image: url(${mm("assets/images/mapCompass.png")});`),this._up=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._up.setAttribute("class","compass-up"),this._up.setAttribute("viewBox","0 0 1024 1024"),this._up.setAttribute("version","1.1");const e=document.createElementNS("http://www.w3.org/2000/svg","path");e.setAttribute("d","M910.222222 796.444444c-17.066667 0-34.133333-5.688889-45.511111-17.066666L551.822222 409.6c-11.377778-5.688889-17.066667-11.377778-34.133333-11.377778-5.688889 0-22.755556 5.688889-28.444445 11.377778l-329.955555 364.088889c-22.755556 22.755556-56.888889 22.755556-79.644445 5.688889-22.755556-22.755556-22.755556-56.888889-5.688888-79.644445l329.955555-364.088889c28.444444-34.133333 73.955556-51.2 119.466667-51.2s85.333333 22.755556 119.466666 56.888889l312.888889 364.088889c22.755556 22.755556 17.066667 56.888889-5.688889 79.644445-11.377778 5.688889-28.444444 11.377778-39.822222 11.377777z"),this._up.addEventListener(fw.DOWN,this.handleUpBtnClick),this._up.appendChild(e),this._down=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._down.setAttribute("class","compass-down"),this._down.setAttribute("viewBox","0 0 1024 1024"),this._down.setAttribute("version","1.1");const t=document.createElementNS("http://www.w3.org/2000/svg","path");return t.setAttribute("d","M517.688889 796.444444c-45.511111 0-85.333333-17.066667-119.466667-51.2L73.955556 381.155556c-22.755556-22.755556-17.066667-56.888889 5.688888-79.644445 22.755556-22.755556 56.888889-17.066667 79.644445 5.688889l329.955555 364.088889c5.688889 5.688889 17.066667 11.377778 28.444445 11.377778s22.755556-5.688889 34.133333-17.066667l312.888889-364.088889c22.755556-22.755556 56.888889-28.444444 79.644445-5.688889 22.755556 22.755556 28.444444 56.888889 5.688888 79.644445L637.155556 739.555556c-28.444444 39.822222-68.266667 56.888889-119.466667 56.888888 5.688889 0 0 0 0 0z"),this._down.addEventListener(fw.DOWN,this.handleDownBtnClick),this._down.appendChild(t),this._left=document.createElement("div"),i(this._left,"compass-left"),this._left.setAttribute("style",`background-image: url(${mm("assets/images/mapCompass.png")});`),this._left.addEventListener(fw.DOWN,this.handleLeftBtnClick),this._right=document.createElement("div"),i(this._right,"compass-right"),this._right.setAttribute("style",`background-image: url(${mm("assets/images/mapCompass.png")});`),this._right.addEventListener(fw.DOWN,this.handleRightBtnClick),this._compass=document.createElement("div"),i(this._compass,"compass-center"),this._compass.setAttribute("style",`background-image: url(${mm("assets/images/mapCompass.png")});`),this._compass.addEventListener(fw.DOWN,this.handleCenterBtnClick),this._element.appendChild(this._up),this._element.appendChild(this._down),this._element.appendChild(this._left),this._element.appendChild(this._right),this._element.appendChild(this._compass),this._engine.rendering.addPrepareRenderListener((()=>{this._compass.style.transform=`rotate(-${this._engine.map.getHeading()}deg)`})),this._element}handleUpBtnClick(){const e=this._engine.map.getPitch();let t=e+2;t=t>89?89:t<0?0:t,e!==t&&this._engine.map.setPitch(t)}handleDownBtnClick(){const e=this._engine.map.getPitch();let t=e-2;t=t>89?89:t<0?0:t,e!==t&&this._engine.map.setPitch(t)}handleLeftBtnClick(){let e=this._engine.map.getHeading()-2;this._engine.map.setHeading((e+360)%360)}handleRightBtnClick(){let e=this._engine.map.getHeading()+2;this._engine.map.setHeading(e%360)}handleCenterBtnClick(){this._engine.map.setHeading(0)}onDispose(){this._up.removeEventListener(fw.DOWN,this.handleUpBtnClick),this._down.removeEventListener(fw.DOWN,this.handleDownBtnClick),this._left.removeEventListener(fw.DOWN,this.handleLeftBtnClick),this._right.removeEventListener(fw.DOWN,this.handleRightBtnClick),this._compass.removeEventListener(fw.DOWN,this.handleCenterBtnClick)}}class pN{constructor(e,n={}){__publicField(this,"_container"),__publicField(this,"_engine"),__publicField(this,"_logo"),__publicField(this,"_zoom"),__publicField(this,"_scale"),__publicField(this,"_fullscreen"),__publicField(this,"_geoLocate"),__publicField(this,"_exportImage"),__publicField(this,"_mapInfo"),__publicField(this,"_compass"),__publicField(this,"_drawer");const s=e.container,o=s instanceof HTMLElement||s&&"object"==typeof s&&1===s.nodeType&&"string"==typeof s.nodeName;this._container=o?s:s.container||s._container;const r=this._control=document.createElement("div");r.id=`${t}-widgets`,i(r,`${t}-widgets-pane`),this._container.appendChild(r);const a=document.createElement("div");i(a,"bottom-right-anchor"),this._zoom=new oN(a,n.zoom,e),this._compass=new IN(a,n.compass,e),r.appendChild(a);const l=document.createElement("div");i(l,"bottom-left-anchor"),r.appendChild(l),this._fullscreen=new lN(l,n.fullscreen,e),this._exportImage=new cN(l,n.exportImage,e),this._geoLocate=new gN(l,n.geoLocate,e),this._logo=new sN(r,n.logo,e),this._scale=new rN(r,n.scale,e),this._mapInfo=new dN(r,n.mapInfo,e),this._drawer=new uN(r,n.drawer,e)}dispose(){this._logo.dispose(),this._zoom.dispose(),this._scale.dispose(),this._fullscreen.dispose(),this._geoLocate.dispose(),this._exportImage.dispose(),this._mapInfo.dispose(),this._compass.dispose(),this._drawer.dispose(),this._control.remove()}get container(){return this._container}get engine(){return this._engine}get compass(){return this._compass}get logo(){return this._logo}get zoom(){return this._zoom}get scale(){return this._scale}get fullscreen(){return this._fullscreen}get geoLocate(){return this._geoLocate}get exportImage(){return this._exportImage}get mapInfo(){return this._mapInfo}get drawer(){return this._drawer}}Bs.mvt_uniform_zoomunits_pars="#define GLSLIFY 1\n",Bs.mvt_extra_vertex_utils="#define GLSLIFY 1\nuniform float zoomUnits;\n\n// position为world coord\nfloat getPixelSize(vec3 position) {\n    if (isOrthographic) {\n        return zoomUnits;\n    }\n    else {\n        // projectionMatrix第5位含义为tan(fov / 2) = 2 * near / (top - bottom)\n        return 0.2 * projectionMatrix[1][1] / resolution.y * distance(cameraPosition, position);\n    }\n}\n",Bs.mvt_selective_pars_vertex="#define GLSLIFY 1\n#ifdef MVT_ENABLE_SELECTIVE\nattribute float objectIndex;\nuniform float selectedObjectIndex;\nvarying float isSelected;\n#endif",Bs.mvt_selective_vertex="#define GLSLIFY 1\n#ifdef MVT_ENABLE_SELECTIVE\nif (objectIndex == selectedObjectIndex) {\n\tisSelected = 1.0;\n} else {\n\tisSelected = 0.0;\n}\n#endif",Bs.mvt_selective_pars_fragment="#define GLSLIFY 1\n#ifdef MVT_ENABLE_SELECTIVE\nvarying float isSelected;\nuniform vec4 selectedObjectColor;\nuniform float selectedObjectColorMode;\n#endif",Bs.mvt_selective_fragment="#define GLSLIFY 1\n#ifdef MVT_ENABLE_SELECTIVE\nif (isSelected == 1.0) {\n\tif (selectedObjectColorMode == 1.) {\n\t\tgl_FragColor = selectedObjectColor;\n\t} else {\n\t\tgl_FragColor.rgb = selectedObjectColor.rgb * selectedObjectColor.a + gl_FragColor.rgb * (1.0 - selectedObjectColor.a);\n\t}\n\t\n}\n#endif",Bs.mvt_keepsize_pars_vertex="#define GLSLIFY 1\nuniform bool keepSize;\nuniform float pixelRatio;\nuniform vec2 resolution;\n",Bs.mvt_keepsize_vertex="#define GLSLIFY 1\nvec4 worldPosition = (modelMatrix * vec4(transformed, 1.0));\nfloat pixelSize = getPixelSize(worldPosition.xyz);\nif (keepSize) {\n    transformed *= pixelSize;\n}\n",Bs.mvt_emissive_pars_fragment="#define GLSLIFY 1\n#define MVT_EMISSIVE_SHADER\n\nuniform vec3 emissive;",Bs.mvt_emissive_fragment="#define GLSLIFY 1\n#ifdef MVT_EMISSIVE_SHADER\n    vec4 out_emissive = vec4(emissive.rgb, 1.0);\n#endif",Bs.mvt_override_standard_emissivemap_pars_fragment="#define GLSLIFY 1\n#ifdef USE_EMISSIVEMAP\n\n\tuniform sampler2D emissiveMap;\n\n#endif",Bs.mvt_override_standard_emissivemap_fragment="#define GLSLIFY 1\n#ifdef USE_EMISSIVEMAP\n\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\n\t// emissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n\n    \n#endif\n\nif (isEmissive) {\n    gl_FragColor = vec4(totalEmissiveRadiance, 1.0);\n\t#if defined( TONE_MAPPING )\n\t    gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n    #endif\n    return;\n}",Bs.mvt_override_basic_color_pars_fragment="#define GLSLIFY 1\n#ifdef USE_COLOR\n\n\tvarying vec3 vColor;\n\n#endif",Bs.mvt_override_basic_color_fragment="#define GLSLIFY 1\nif (isEmissive) {\n    gl_FragColor = vec4(emissive, 1.0);\n    #if defined( TONE_MAPPING )\n\t    gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n    #endif\n    return;\n}\n#ifdef USE_COLOR\n\n\tdiffuseColor.rgb *= vColor;\n\n#endif",Bs.mvt_animation_pars_vertex="#define GLSLIFY 1\nuniform bool animationPeriodOffset;\n\n#ifdef ENABLE_ANIMATION_ROTATE\nuniform float animationRotatePeriod;\n#endif\n\n#ifdef ENABLE_ANIMATION_JUMP\nuniform float animationJumpPeriod;\nuniform float animationJumpHeight;\n#endif\n\n#ifdef ENABLE_ANIMATION_SCALE\nuniform float animationPeriod;\nuniform float targetScale;\nuniform bool opacityGradient;\n#endif\n\n#ifdef ENABLE_ANIMATION_BREATH\nuniform float animationPeriod;\nuniform float maxScale;\nuniform float minScale;\nuniform bool opacityGradient;\n#endif",Bs.mvt_animation_vertex="#define GLSLIFY 1\n#ifdef ENABLE_ANIMATION_ROTATE\n    float rotateRatio = mod(elapsedTime, animationRotatePeriod) / animationRotatePeriod;\n    if (animationPeriodOffset) {\n        rotateRatio = mod(rotateRatio + instancedRandomFactor, 1.0);\n    }\n    float rotation = rotateRatio * 6.28;\n    vec2 rotatedPosition;\n    rotatedPosition.x = cos( rotation ) * transformed.x - sin( rotation ) * transformed.y;\n    rotatedPosition.y = sin( rotation ) * transformed.x + cos( rotation ) * transformed.y;\n    transformed.xy = rotatedPosition;\n#endif\n\n#ifdef ENABLE_ANIMATION_JUMP\n    float jumpRatio = mod(elapsedTime, animationJumpPeriod) / animationJumpPeriod;\n    if (animationPeriodOffset) {\n        jumpRatio = mod(jumpRatio + instancedRandomFactor, 1.0);\n    }\n    if (jumpRatio <= 0.5) {\n        jumpRatio *= 2.0;\n        jumpRatio = jumpRatio * jumpRatio * jumpRatio;\n    } else {\n        jumpRatio = (1.0 - jumpRatio) * 2.0;\n        jumpRatio = jumpRatio * jumpRatio * jumpRatio;\n    }\n    #ifdef USE_SIZE3\n        transformed.z += jumpRatio * animationJumpHeight / size3.z;\n    #else\n        transformed.z += jumpRatio * animationJumpHeight / size;\n    #endif\n#endif\n\n#ifdef ENABLE_ANIMATION_SCALE\n    float scaleRatio = mod(elapsedTime, animationPeriod) / animationPeriod;\n    if (animationPeriodOffset) {\n        scaleRatio = mod(scaleRatio + instancedRandomFactor, 1.0);\n    }\n\n    vScale *= 1.0 + (targetScale - 1.0) * scaleRatio;\n\n    if (opacityGradient) {\n        if (targetScale > 1.0) {\n            opacityRatio = 1.0 - (targetScale - 1.0) * scaleRatio;\n        } else {\n            opacityRatio = 1.0 + (targetScale - 1.0) * scaleRatio;\n        }\n    }\n\n#endif\n\n#ifdef ENABLE_ANIMATION_BREATH\n    float scaleRatio = mod(elapsedTime, animationPeriod) / animationPeriod;\n    if (animationPeriodOffset) {\n        scaleRatio = mod(scaleRatio + instancedRandomFactor, 1.0);\n    }\n    float repeatNum = scaleRatio / 0.25;\n    float scaleFactor = mod(scaleRatio, 0.25) / 0.25;\n    float scaleNum = scaleFactor * (maxScale - 1.0);\n    float balance = (maxScale + minScale) / 2.0;\n\n    if (repeatNum > 1.0 && repeatNum < 3.0) {\n        // 下降\n        if (repeatNum < 2.0) {\n            scaleNum = (1.0 - scaleFactor) * (maxScale - balance);\n        } else {\n            scaleNum = -scaleFactor * (balance - minScale);\n        }\n    } else if (repeatNum >= 3.0) {\n        scaleNum = -(1.0 - scaleFactor) * (balance - minScale);\n    }\n\n    vScale *= balance + scaleNum;\n\n    if (opacityGradient) {\n        opacityRatio = (balance + scaleNum) / maxScale;\n    }\n\n#endif",Bs.mvt_mrt_output_pars_fragment="#define GLSLIFY 1\n#ifndef DISABLE_MRT\n    // layout(location = 1) out highp vec4 pc_fragColor1;\n    // layout(location = 2) out highp vec4 pc_fragColor2;\n    // layout(location = 3) out highp vec4 pc_fragColor3;\n    // layout(location = 4) out highp vec4 pc_fragColor4;\n    // layout(location = 5) out highp vec4 pc_fragColor5;\n    // layout(location = 6) out highp vec4 pc_fragColor6;\n    // layout(location = 7) out highp vec4 pc_fragColor7;\n    #if defined(MVT_MRT_OUT_EMISSIVE)\n        layout(location = MVT_MRT_OUT_EMISSIVE) out highp vec4 mvt_pc_emissive;\n    #endif\n\n    #if defined(MVT_MRT_OUT_NORMAL)\n        layout(location = MVT_MRT_OUT_NORMAL) out highp vec4 mvt_pc_normal;\n    #endif\n\n    #if defined(MVT_MRT_OUT_METALLICROUGH)\n        layout(location = MVT_MRT_OUT_METALLICROUGH) out highp vec4 mvt_pc_metallicRough;\n    #endif\n#endif\n\n#if defined(MVT_EMISSIVE_UNIFORM)\n// 发光颜色自定义\n    #if defined(MVT_EMISSIVE_COLOR)\n        uniform vec3 mvt_emissive;\n    #endif  \n    uniform float mvt_emissiveIntensity;\n#endif",Bs.mvt_mrt_output_fragment="#define GLSLIFY 1\n#ifndef DISABLE_MRT\n    // 自定义发光颜色，完全由着色器控制 在着色器中输出 vec4 out_emissive;\n    #ifdef MVT_MRT_OUT_EMISSIVE\n        #if defined(MVT_EMISSIVE_SHADER)\n            mvt_pc_emissive = out_emissive;\n        #elif defined(STANDARD)\n            mvt_pc_emissive.rgb = totalEmissiveRadiance;\n            mvt_pc_emissive.a = pc_fragColor.a;\n        #elif defined(PHONG)\n            mvt_pc_emissive.rgb = totalEmissiveRadiance;\n            mvt_pc_emissive.a = pc_fragColor.a;\n        #elif defined(BASIC)\n            mvt_pc_emissive.rgb = emissive;\n            mvt_pc_emissive.a = pc_fragColor.a;\n        // 通过传入的uniform变量颜色自发光\n        #elif defined(MVT_EMISSIVE_UNIFORM)\n            // 发光颜色自定义\n            #if defined(MVT_EMISSIVE_COLOR)\n                mvt_pc_emissive.rgb = mvt_emissive * mvt_emissiveIntensity;\n                mvt_pc_emissive.a = pc_fragColor.a;\n            #else  \n                mvt_pc_emissive = pc_fragColor * mvt_emissiveIntensity;\n            #endif\n        #else\n            mvt_pc_emissive = vec4(0.0, 0.0, 0.0, 0.0);\n        #endif  \n    #endif\n\n    #ifdef MVT_MRT_OUT_NORMAL\n        #if defined(STANDARD)\n            #ifndef FLAT_SHADED\n                mvt_pc_normal = vec4(packNormalToRGB(vNormal), gl_FragCoord.z);\n            #else\n                mvt_pc_normal = vec4(0.0, 0.0, 0.0, 0.0);\n            #endif\n        #else\n            #if defined(MVT_FRAG_NORMAL)\n                mvt_pc_normal = vec4(packNormalToRGB(mvt_frag_normal), 1.0);\n            #else\n                mvt_pc_normal = vec4(0.0, 0.0, 0.0, 0.0);\n            #endif\n        #endif\n    #endif\n\n    #ifdef MVT_MRT_OUT_METALLICROUGH\n        #if defined(STANDARD)\n            mvt_pc_metallicRough = vec4(1.0 - material.roughness, 0.0, 0.0, 1.0);\n        #else\n            float temp_reflectionFactor = 0.0;\n            #if defined(MVT_FRAG_REFLECTION_FACTOR)\n                temp_reflectionFactor = mvt_frag_reflectionFactor;\n            #endif\n            mvt_pc_metallicRough = vec4(temp_reflectionFactor, 0.0, 0.0, 0.0);\n        #endif\n    #endif\n    \n    // pc_fragColor4 = vec4(1.0, 0.0, 1.0, 1.0);\n    // pc_fragColor5 = vec4(0.0, 1.0, 0.0, 1.0);\n    // pc_fragColor6 = vec4(0.0, 1.0, 0.0, 1.0);\n    // pc_fragColor7 = vec4(0.0, 1.0, 0.0, 1.0);\n#endif\n",Bs.mvt_nmrt_output_pars_fragment="#define GLSLIFY 1\n#if defined(MVT_EMISSIVE_UNIFORM)\n    // 发光颜色自定义\n    #if defined(MVT_EMISSIVE_COLOR)\n        uniform vec3 mvt_emissive;\n    #endif  \n    uniform float mvt_emissiveIntensity;\n#endif\nuniform bool isEmissive;",Bs.mvt_nmrt_output_fragment="#define GLSLIFY 1\n// if (isEmissive) {\n#if defined(MVT_MODE_EMISSIVE)\n    #if defined(MVT_EMISSIVE_SHADER)\n        gl_FragColor = out_emissive;\n    #elif defined(STANDARD)\n        gl_FragColor.rgb = totalEmissiveRadiance;\n    #elif defined(PHONG)\n        gl_FragColor.rgb = totalEmissiveRadiance;\n    #elif defined(BASIC)\n        gl_FragColor.rgb = emissive;\n    // 通过传入的uniform变量颜色自发光\n    #elif defined(MVT_EMISSIVE_UNIFORM)\n        // 发光颜色自定义\n        #if defined(MVT_EMISSIVE_COLOR)\n            gl_FragColor.rgb = mvt_emissive * mvt_emissiveIntensity;\n        #else\n            gl_FragColor = gl_FragColor * mvt_emissiveIntensity;\n        #endif\n    #else\n        gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);\n    #endif\n#endif\n//}",Bs.mvt_extra_meshbasic_frag_pars="#define GLSLIFY 1\n#define BASIC\nuniform vec3 emissive;",Bs.mvt_clip_pars_vertex="#define GLSLIFY 1\n#ifdef USE_CLIP\n    varying vec3 clip_position;\n    varying mat4 clip_modelMat4;\n    #ifdef IS_INSTANCE\n        varying mat4 clip_instanceMat4;\n    #endif\n#endif",Bs.mvt_clip_vertex="#define GLSLIFY 1\n#ifdef USE_CLIP\n    clip_position = position;\n    clip_modelMat4 = modelMatrix;\n    #ifdef IS_INSTANCE\n        clip_instanceMat4 = instanceMatrix;\n    #endif\n#endif\n",Bs.mvt_clip_pars_fragment="#define GLSLIFY 1\n#ifdef USE_CLIP\n\n    varying vec3 clip_position;\n    varying mat4 clip_modelMat4;\n    #ifdef IS_INSTANCE\n        varying mat4 clip_instanceMat4;\n    #endif\n\n    struct ClipParameters {\n        vec2 u_polygon[20];\n        vec4 polygonBounds;\n        int clip_type;\n        bool clip_inside;\n        vec2 clip_point;\n        float clip_radius;\n        float clip_maxDiff;\n        vec2 clip_size;\n    };\n\n    uniform ClipParameters mvt_clipParameters;\n\n    int areIntersecting(\n        float v1x1, float v1y1, float v1x2, float v1y2,\n        float v2x1, float v2y1, float v2x2, float v2y2\n    ) {\n        float d1, d2;\n        float a1, a2, b1, b2, c1, c2;\n\n        a1 = v1y2 - v1y1;\n        b1 = v1x1 - v1x2;\n        c1 = (v1x2 * v1y1) - (v1x1 * v1y2);\n\n        d1 = (a1 * v2x1) + (b1 * v2y1) + c1;\n        d2 = (a1 * v2x2) + (b1 * v2y2) + c1;\n\n        if (d1 > 0.0 && d2 > 0.0) return 0;\n        if (d1 <= 0.0 && d2 <= 0.0) return 0;\n\n        a2 = v2y2 - v2y1;\n        b2 = v2x1 - v2x2;\n        c2 = (v2x2 * v2y1) - (v2x1 * v2y2);\n\n        d1 = (a2 * v1x1) + (b2 * v1y1) + c2;\n        d2 = (a2 * v1x2) + (b2 * v1y2) + c2;\n\n        if (d1 > 0.0 && d2 > 0.0) return 0;\n        if (d1 < 0.0 && d2 < 0.0) return 0;\n\n        if ((a1 * b2) - (a2 * b1) == 0.0) return 2;\n\n        return 1;\n    }\n\n    bool pointInPolygon(vec2 p) {\n        vec4 polygonBounds = mvt_clipParameters.polygonBounds;\n        float minX = polygonBounds.x;\n        float minY = polygonBounds.y;\n        float maxX = polygonBounds.z;\n        float maxY = polygonBounds.w;\n        if (p.x > maxX || p.x < minX || p.y > maxY || p.y < minY)\n        {\n            return false;\n        }\n\n        vec2 points[20] = mvt_clipParameters.u_polygon;\n        float maxDiff = mvt_clipParameters.clip_maxDiff;\n        int intersectCount = 0;\n\n        #ifdef USE_CLIPCOUNT\n            for (int i = 0; i < USE_CLIPCOUNT; i++) {\n                vec2 vertex = points[i];\n\n                vec2 vertex2;\n                if (i == USE_CLIPCOUNT - 1) {\n                    vertex2 = points[0];\n                }\n                else {\n                    vertex2 = points[i + 1];\n                }\n\n                bool intersection = areIntersecting(p.x, p.y, p.x + maxDiff * 2.0, p.y, vertex.x, vertex.y, vertex2.x, vertex2.y) != 0;\n                if (intersection) {\n                    intersectCount++;\n                }\n            }\n            return (intersectCount % 2) == 1;\n        #else\n            return false;\n        #endif\n    }\n\n    bool pointInCircle(vec2 point) {\n        float distance = length(point - mvt_clipParameters.clip_point);\n        return distance < mvt_clipParameters.clip_radius;\n    }\n\n    bool pointInRect(vec2 point) {\n        return (point.x > mvt_clipParameters.clip_point.x \n            && point.x < mvt_clipParameters.clip_point.x + mvt_clipParameters.clip_size.x\n            && point.y > mvt_clipParameters.clip_point.y \n            && point.y < mvt_clipParameters.clip_point.y + mvt_clipParameters.clip_size.y);\n    }\n\n#endif",Bs.mvt_clip_fragment="#define GLSLIFY 1\n#ifdef USE_CLIP\n    vec4 worldCoord;\n\n    #ifdef CUSTOM_WORLD_COORD\n        worldCoord = vec4(vMP, 1.0);\n    #else\n        #ifdef IS_INSTANCE\n            worldCoord = clip_modelMat4 * clip_instanceMat4 * vec4(clip_position, 1.0);\n        #else\n            worldCoord = clip_modelMat4 * vec4(clip_position, 1.0);\n        #endif\n    #endif\n    bool isInside = false;\n    if (mvt_clipParameters.clip_type == 0) {\n        isInside = pointInPolygon(worldCoord.xy / worldCoord.w);\n    }\n    else if (mvt_clipParameters.clip_type == 1) {\n        isInside = pointInCircle(worldCoord.xy / worldCoord.w);\n    }\n    else if (mvt_clipParameters.clip_type == 2) {\n        isInside = pointInRect(worldCoord.xy / worldCoord.w);\n    }\n    \n    bool clipInside = mvt_clipParameters.clip_inside;\n    if (clipInside) {\n        if (isInside) {\n            discard;\n        }\n    }\n    else {\n        if (!isInside) {\n            discard;\n        }\n    }\n#endif",Bs.mvt_depth_packing="#define GLSLIFY 1\nfloat mvt_linearize_depth(in float depth, in float cameraNear, in float cameraFar){\n    float a = cameraFar / (cameraFar - cameraNear);\n    float b = cameraFar * cameraNear / (cameraNear - cameraFar);\n    return a + b / depth;\n}\n\nfloat mvt_reconstruct_depth(sampler2D tDepth, const in vec2 uv, in float cameraNear, in float cameraFar){\n    float depth = texture2D(tDepth, uv).x;\n    return pow(2.0, depth * log2(cameraFar + 1.0)) - 1.0;\n}\n\nfloat mvtGetDepthFromTexture(sampler2D tDepth, vec2 uv, in float cameraNear, in float cameraFar) {\n    #if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n        return mvt_linearize_depth(mvt_reconstruct_depth(tDepth, uv, cameraNear, cameraFar), cameraNear, cameraFar);\n    #else\n        return texture2D(tDepth, uv).x;\n    #endif\n}\nvec3 mvtGetWorldPositionByDepth(float depth, vec2 uv, mat4 projectionInverseMatrix, mat4 viewInverseMatrix) {\n    float z = depth * 2.0 - 1.0;\n    vec4 clipSpacePosition = vec4(uv * 2.0 - 1.0, z, 1.0);\n\n    // float viewZ = perspectiveDepthToViewZ(depth, cameraNear, cameraFar);\n    // float clipW = mvt_projectionMatrix[2][3] * viewZ + mvt_projectionMatrix[3][3];\n    // clipSpacePosition *= clipW;\n    vec4 viewSpacePosition = projectionInverseMatrix * clipSpacePosition;\n    \n    // viewSpacePosition /= viewSpacePosition.w;\n    // return viewSpacePosition.xyz;\n    vec4 worldSpacePosition = viewInverseMatrix * viewSpacePosition;\n\n    return worldSpacePosition.xyz / worldSpacePosition.w;\n}\n\nvec3 mvtGetViewPositionByDepth(float depth, vec2 uv, mat4 projectionInverseMatrix) {\n    float z = depth * 2.0 - 1.0;\n    vec4 clipSpacePosition = vec4(uv * 2.0 - 1.0, z, 1.0);\n\n    // float viewZ = perspectiveDepthToViewZ(depth, cameraNear, cameraFar);\n    // float clipW = mvt_projectionMatrix[2][3] * viewZ + mvt_projectionMatrix[3][3];\n    // clipSpacePosition *= clipW;\n    vec4 viewSpacePosition = projectionInverseMatrix * clipSpacePosition;\n    \n    viewSpacePosition /= viewSpacePosition.w;\n    return viewSpacePosition.xyz;\n\n}\n",Bs.mvt_depth_range_pars_fragment="#define GLSLIFY 1\n#ifdef MVT_USE_DEPTH_RANGE\n\nuniform vec2 depthRange;\n\nlayout(location = 1) out highp vec4 pc_fragColor1;\n\nfloat mvt_remapDepth(float depth) {\n    return depth * (depthRange.y - depthRange.x) + depthRange.x;\n}\n#endif\n\n#ifdef MVT_USE_VERTEX_ZINDEX\n    varying float vLayerIndex;\n#endif\n\n",Bs.mvt_depth_range_fragment="#define GLSLIFY 1\n#ifdef MVT_USE_DEPTH_RANGE\n    #ifdef OPAQUE\n        pc_fragColor1 = packDepthToRGBA(gl_FragDepthEXT);\n        // pc_fragColor1 = vec4(gl_FragDepthEXT, 0., 0., 1);\n    #else\n        // 禁止半透明区域混合深度\n        pc_fragColor1 = vec4(1., 1., 1., 0);\n    #endif\n    // pc_fragColor = packDepthToRGBA(gl_FragDepthEXT);\n    #ifdef MVT_USE_VERTEX_ZINDEX\n        gl_FragDepthEXT = mvt_remapDepth(gl_FragDepthEXT - vLayerIndex * 0.01);\n    #else\n        gl_FragDepthEXT = mvt_remapDepth(gl_FragDepthEXT);\n    #endif\n#endif",Bs.output_fragment="#define GLSLIFY 1\nif (isLinearToneMapping) {\n    gl_FragColor.rgb = LinearToneMapping( gl_FragColor.rgb );\n}\nelse if (isReinhardToneMapping) {\n    gl_FragColor.rgb = ReinhardToneMapping( gl_FragColor.rgb );\n}\nelse if (isCineonToneMapping) {\n    gl_FragColor.rgb = OptimizedCineonToneMapping( gl_FragColor.rgb );\n}\nelse if (isACESFilmicToneMapping) {\n    gl_FragColor.rgb = ACESFilmicToneMapping( gl_FragColor.rgb );\n}\n\nif (srgbTransformer) {\n    gl_FragColor = sRGBTransferOETF( gl_FragColor );\n}",Bs.output_pars_fragment="#define GLSLIFY 1\nuniform bool srgbTransformer;\nuniform bool isLinearToneMapping;\nuniform bool isReinhardToneMapping;\nuniform bool isCineonToneMapping;\nuniform bool isACESFilmicToneMapping;",Cn.prototype.emissiveIntensity=1,Ss.basic.uniforms.emissive={value:new In(0)},Ss.basic.uniforms.isEmissive={value:!1};class mN extends ts{constructor(){super(),__publicField(this,"_fsQuad"),__publicField(this,"_hasPaintedScatterBuffer"),__publicField(this,"_scatteringMaterial"),__publicField(this,"_scatteringRenderTarget"),__publicField(this,"_transmittanceMaterial"),__publicField(this,"_transmittanceRenderTarget"),__publicField(this,"_viewMaterial"),__publicField(this,"_viewRenderTarget"),this.geometry=new dl(1,32,32),this.frustumCulled=!1;const e=[256,64],t=[32,32],i=[400,400],n=this._transmittanceRenderTarget=new Yt(e[0],e[1],{type:Y,depthBuffer:!1});n.texture.name="SkyAtmosphere.transmittance",this._transmittanceMaterial=new ls({uniforms:as.clone(Tm.uniforms),vertexShader:Tm.vertexShader,fragmentShader:Tm.fragmentShader});const s=this._scatteringRenderTarget=new Yt(t[0],t[1],{type:Y,depthBuffer:!1});s.texture.name="SkyAtmosphere.scattering",this._scatteringMaterial=new ls({uniforms:as.clone(Zm.uniforms),vertexShader:Zm.vertexShader,fragmentShader:Zm.fragmentShader}),this._scatteringMaterial.uniforms.transmittanceTexture.value=n.texture,this._scatteringMaterial.uniforms.transmittanceResolution.value=[e[0],e[1]],this._fsQuad=new wm(null);const o=this._viewRenderTarget=new Yt(i[0],i[1],{type:Y,depthBuffer:!1});o.texture.name="SkyAtmosphere.view";const r=this._viewMaterial=new ls({uniforms:as.clone(Vm.uniforms),vertexShader:Vm.vertexShader,fragmentShader:Vm.fragmentShader});r.uniforms.transmittanceTexture.value=n.texture,r.uniforms.transmittanceResolution.value=[e[0],e[1]],r.uniforms.scatteringTexture.value=s.texture,r.uniforms.scatteringResolution.value=[t[0],t[1]];const a=this.material=new ls({uniforms:as.clone(Rm.uniforms),vertexShader:Rm.vertexShader,fragmentShader:Rm.fragmentShader,side:2});a.uniforms.transmittanceTexture.value=n.texture,a.uniforms.transmittanceResolution.value=[e[0],e[1]],a.uniforms.scatteringTexture.value=s.texture,a.uniforms.scatteringResolution.value=[t[0],t[1]],a.uniforms.viewTexture.value=o.texture,a.uniforms.viewResolution.value=[i[0],i[1]],Object.defineProperties(this.material,{isEmissive:{get:function(){return this.uniforms.isEmissive.value},set:function(e){this.uniforms.isEmissive.value=e}},uTime:{get:function(){return this.uniforms.uTime.value},set:function(e){this.uniforms.uTime.value=e}},uStarVisible:{get:function(){return this.uniforms.uStarVisible.value},set:function(e){this.uniforms.uStarVisible.value=e}},uMoonMap:{get:function(){return this.uniforms.uMoonMap.value},set:function(e){this.uniforms.uMoonMap.value=e}}}),this._fsQuad=new wm(null),this.scale.multiplyScalar(1e4),this.altitude=0}onBeforeRender(e,t,i){}updateRenderTargets(e,t){const i=this._fsQuad;this._hasPaintedScatterBuffer||(i.material=this._transmittanceMaterial,e.setRenderTarget(this._transmittanceRenderTarget),e.clear(),i.render(e),i.material=this._scatteringMaterial,e.setRenderTarget(this._scatteringRenderTarget),e.clear(),i.render(e),this._hasPaintedScatterBuffer=!0),i.material=this._viewMaterial,e.setRenderTarget(this._viewRenderTarget),e.clear(),i.render(e),e.setRenderTarget(null)}dispose(){this.geometry.dispose(),this._transmittanceRenderTarget.dispose(),this._scatteringRenderTarget.dispose(),this._viewRenderTarget.dispose(),this._transmittanceMaterial.dispose(),this._scatteringMaterial.dispose(),this._viewMaterial.dispose(),this.material.dispose(),this._fsQuad.dispose()}get altitude(){return this.material.uniforms.altitude.value}set altitude(e){this._transmittanceMaterial.uniforms.altitude.value=e,this._scatteringMaterial.uniforms.altitude.value=e,this._viewMaterial.uniforms.altitude.value=e,this.material.uniforms.altitude.value=e}get viewHeight(){return this.material.uniforms.viewHeight.value}set viewHeight(e){this._transmittanceMaterial.uniforms.viewHeight.value=e,this._scatteringMaterial.uniforms.viewHeight.value=e,this._viewMaterial.uniforms.viewHeight.value=e,this.material.uniforms.viewHeight.value=e}get mixGrayFactor(){return this._viewMaterial.uniforms.mixGrayFactor.value}set mixGrayFactor(e){this._viewMaterial.uniforms.mixGrayFactor.value=e}}const AN=new Qt,CN=new Qt(0,0,1);class fN extends vm{constructor(){super(),this.uniforms=as.clone(Wm.uniforms),this.material=new ls({defines:{MVT_USE_NORMAL_TEXTURE:!1},uniforms:this.uniforms,vertexShader:Sm.vertexShader,fragmentShader:Wm.fragmentShader,depthTest:!1,depthWrite:!1,name:"SkyAtmospherePass"}),this.needsSwap=!0,this.fsQuad=new wm(null),this.needsDepthTexture=!0,this.needsNormalTextureWhenMRT=!0}_consoleIfBigDiff(e,t,i){const n=e.pitch,s=e.roll,o=e.heading;this[t]&&(Math.abs(n-this[t].pitch),Math.abs(s-this[t].roll),Math.abs(o-this[t].heading)),this[t]={pitch:n,roll:s,heading:o}}render(e,t,i){const n=this.sky;if(!n)return;const s=this.rendering,o=s.camera,r=n.skyAtmosphere,a=this.uniforms;a.altitude.value=r.altitude,a.tDiffuse.value=i.texture,a.tDepth.value=s.main.sceneRendering.depthTexture,a.tAtmosphere.value=r.material.uniforms.viewTexture.value,a.isGlobe.value=r.material.uniforms.isGlobe.value,a.projectionInverseMatrix.value.copy(o.projectionMatrixInverse),a.viewInverseMatrix.value.copy(o.matrixWorld),a.cameraNear.value=o.near,a.cameraFar.value=o.far,a.cameraPosition.value.copy(o.position),a.viewHeight.value=r.material.uniforms.viewHeight.value,a.transmittanceTexture.value=r.material.uniforms.transmittanceTexture.value,a.transmittanceResolution.value=r.material.uniforms.transmittanceResolution.value,a.scatteringTexture.value=r.material.uniforms.scatteringTexture.value,a.scatteringResolution.value=r.material.uniforms.scatteringResolution.value,a.viewTexture.value=r.material.uniforms.viewTexture.value,a.viewResolution.value=r.material.uniforms.viewResolution.value,a.mvt_viewMatrix.value.copy(o.matrixWorldInverse),a.resolution=s.uniforms.resolution,a.sunDirection.value.copy(n.localSunDirection);const l=s.main.sceneRendering.normalTexture;a.tNormal.value=l;const g=!!l;g!==this.material.defines.MVT_USE_NORMAL_TEXTURE&&(this.material.defines.MVT_USE_NORMAL_TEXTURE=g,this.material.needsUpdate=!0);let c=0,d=1;if("earth"===s._engine.map.mapType){let e=s._engine.map._map._ellipsoidCamera;if(e.positionCartographic.z,!this._sphereCamera){const e=new eA(6371e3,6371e3,6371e3);this._sphereCamera=new Uf({_ellipsoid:e,mapProjection:new tA(e),camera:o})}const t=this._sphereCamera;t.position.copy(e.position),t.direction.copy(e.direction),t.up.copy(e.up),t.right.copy(e.right),r._transformChanged=!0,e=t,a.viewInverseMatrix.value.copy(e.getLocalTransform());const i=a.viewInverseMatrix.value.elements;AN.set(i[8],i[9],i[10]);const n=ft.clamp(AN.dot(CN),.1,1),l=1e6*a.viewHeight.value/n,g=ft.mapLinear(Math.sqrt(10*a.viewHeight.value),0,1,20,2),h=Math.max(l+100,l*g);c=s.renderState.getDepthByDistance(l),d=s.renderState.getDepthByDistance(h)}a.fogDepthRange.value.set(c,d);const h=e.autoClear,u=e.getRenderTarget();e.autoClear=!1,this.fsQuad.material=this.material,e.setRenderTarget(this.renderToScreen?null:t),e.clear(!0,!1,!1),this.fsQuad.render(e),e.autoClear=h,e.setRenderTarget(u)}dispose(){this.material.dispose(),this.fsQuad.dispose()}}const bN='#define GLSLIFY 1\n// Himalayas. Created by Reinder Nijhoff 2018\n// @reindernijhoff\n//\n// https://www.shadertoy.com/view/MdGfzh\n//\n// This is my first attempt to render volumetric clouds in a fragment shader.\n//\n// 1 unit correspondents to SCENE_SCALE meter.\n\n#define SCENE_SCALE (1.)\n#define INV_SCENE_SCALE (1.)\n\n// #define MOUNTAIN_HEIGHT (5000.)\n// #define MOUNTAIN_HW_RATIO (0.00016)\n\n// #define SUN_DIR normalize(vec3(-.1,.4,.15))\n// #define SUN_COLOR (vec3(1.,.9,.85)*1.4)\n\n#define FLAG_POSITION (vec3(3900.5,720.,-2516.)*INV_SCENE_SCALE)\n#define HUMANOID_SCALE (2.)\n\n// #define CAMERA_RO (vec3(3980.,730.,-2650.)*INV_SCENE_SCALE)\n// #define CAMERA_FL 2.\n\n#define HEIGHT_BASED_FOG_B 0.02\n#define HEIGHT_BASED_FOG_C 0.05\n\n// mat3 getCamera( in float time, in vec4 mouse, inout vec3 ro, inout vec3 ta ) {\n//     ro = CAMERA_RO;\n//     vec3 cw;\n//     if (mouse.z > 0.) {\n//         vec2 m = (mouse.xy - .5) * 2.3;\n//         float my = -sin(m.y);\n//         cw = normalize(vec3(-sin(-m.x), my+.15, cos(-m.x)));\n//     } else {\n//     \tro.x += -cos(time*.13)*5.*INV_SCENE_SCALE;\n//     \tro.z += (-cos(time*.1)*100.+20.)*INV_SCENE_SCALE;\n//     \tcw = normalize(vec3(-.1,.18,1.));\n//     }   \n//     ta = ro + cw*(200.*INV_SCENE_SCALE);\n// \tvec3 cp = vec3(0.0,1.0, 0.0);\n// \tvec3 cu = normalize( cross(cw,cp) );\n// \tvec3 cv = normalize( cross(cu,cw) );\n//     return mat3( cu, cv, cw );\n// }\n\n// void getRay( in float time, in vec2 fragCoord, in vec2 resolution, in vec4 mouse, inout vec3 ro, inout vec3 rd) {\n// \tvec3 ta;\n// \tmat3 cam = getCamera( time, mouse, ro, ta );\n//     vec2 p = (-resolution.xy + 2.0*(fragCoord))/resolution.y;\n//     rd = cam * normalize(vec3(p,CAMERA_FL));     \n// }\n\n//\n// To reduce noise I use temporal reprojection (both for clouds (Buffer D) and the terrain \n// (Buffer C) seperatly. The temporal repojection code is based on code from the shader\n// "Rain Forest" (again by Íñigo Quílez):\n//\n// https://www.shadertoy.com/view/4ttSWf\n// \n// vec4 saveCamera( in float time, in vec2 fragCoord, in vec4 mouse ) {   \n//     vec3 ro, ta;\n//     mat3 cam = getCamera( time, mouse, ro, ta );\n//     vec4 fragColor;\n    \n//     if( abs(fragCoord.x-4.5)<0.5 ) fragColor = vec4( cam[2], -dot(cam[2],ro) );\n//     if( abs(fragCoord.x-3.5)<0.5 ) fragColor = vec4( cam[1], -dot(cam[1],ro) );\n//     if( abs(fragCoord.x-2.5)<0.5 ) fragColor = vec4( cam[0], -dot(cam[0],ro) );\n    \n//     return fragColor;\n// }\n\n// vec2 reprojectPos( in vec3 pos, in vec2 resolution, in sampler2D storage ) {\n//     mat4 oldCam = mat4( texelFetch(storage,ivec2(2,0),0),\n//                         texelFetch(storage,ivec2(3,0),0),\n//                         texelFetch(storage,ivec2(4,0),0),\n//                         0.0, 0.0, 0.0, 1.0 );\n\n//     vec4 wpos = vec4(pos,1.0);\n//     vec3 cpos = (wpos*oldCam).xyz; \n//     vec2 npos = CAMERA_FL * cpos.xy / cpos.z;\n//     return 0.5 + 0.5*npos*vec2(resolution.y/resolution.x,1.0);\n// }\n\n//\n// Fast skycolor function by Íñigo Quílez\n// https://www.shadertoy.com/view/MdX3Rr\n//\n// vec3 getSkyColor(vec3 rd) {\n//     float sundot = clamp(dot(rd,SUN_DIR),0.0,1.0);\n// \tvec3 col = vec3(0.2,0.5,0.85)*1.1 - max(rd.y,0.01)*max(rd.y,0.01)*0.5;\n//     col = mix( col, 0.85*vec3(0.7,0.75,0.85), pow(1.0-max(rd.y,0.0), 6.0) );\n\n//     col += 0.25*vec3(1.0,0.7,0.4)*pow( sundot,5.0 );\n//     col += 0.25*vec3(1.0,0.8,0.6)*pow( sundot,64.0 );\n//     col += 0.20*vec3(1.0,0.8,0.6)*pow( sundot,512.0 );\n    \n//     col += clamp((0.1-rd.y)*10., 0., 1.) * vec3(.0,.1,.2);\n//     col += 0.2*vec3(1.0,0.8,0.6)*pow( sundot, 8.0 );\n//     return col;\n// }\n\n// bool letterBox(vec2 fragCoord, const vec2 resolution, const float aspect) { \n//     if( fragCoord.x < 0. || fragCoord.x > resolution.x ||\n//         abs(2.*fragCoord.y-resolution.y) > resolution.x * (1./aspect) ) {\n//         return true;\n//     } else {\n//         return false;\n//     }\n// }\n\n//\n// Noise functions\n//\n// Hash without Sine by DaveHoskins \n//\n// https://www.shadertoy.com/view/4djSRW\n//\nfloat hash12( vec2 p ) {\n    p  = 50.0*fract( p*0.3183099 );\n    return fract( p.x*p.y*(p.x+p.y) );\n}\n\nfloat hash13(vec3 p3) {\n    p3  = fract(p3 * 1031.1031);\n    p3 += dot(p3, p3.yzx + 19.19);\n    return fract((p3.x + p3.y) * p3.z);\n}\n\nvec3 hash33(vec3 p3) {\n\tp3 = fract(p3 * vec3(.1031, .1030, .0973));\n    p3 += dot(p3, p3.yxz+19.19);\n    return fract((p3.xxy + p3.yxx)*p3.zyx);\n}\n\nfloat valueHash(vec3 p3) {\n    p3  = fract(p3 * 0.1031);\n    p3 += dot(p3, p3.yzx + 19.19);\n    return fract((p3.x + p3.y) * p3.z);\n}\n\n//\n// Noise functions used for cloud shapes\n//\nfloat valueNoise( in vec3 x, float tile ) {\n    vec3 p = floor(x);\n    vec3 f = fract(x);\n    f = f*f*(3.0-2.0*f);\n\t\n    return mix(mix(mix( valueHash(mod(p+vec3(0,0,0),tile)), \n                        valueHash(mod(p+vec3(1,0,0),tile)),f.x),\n                   mix( valueHash(mod(p+vec3(0,1,0),tile)), \n                        valueHash(mod(p+vec3(1,1,0),tile)),f.x),f.y),\n               mix(mix( valueHash(mod(p+vec3(0,0,1),tile)), \n                        valueHash(mod(p+vec3(1,0,1),tile)),f.x),\n                   mix( valueHash(mod(p+vec3(0,1,1),tile)), \n                        valueHash(mod(p+vec3(1,1,1),tile)),f.x),f.y),f.z);\n}\n\nfloat voronoi( vec3 x, float tile ) {\n    vec3 p = floor(x);\n    vec3 f = fract(x);\n\n    float res = 100.;\n    for(int k=-1; k<=1; k++){\n        for(int j=-1; j<=1; j++) {\n            for(int i=-1; i<=1; i++) {\n                vec3 b = vec3(i, j, k);\n                vec3 c = p + b;\n\n                if( tile > 0. ) {\n                    c = mod( c, vec3(tile) );\n                }\n\n                vec3 r = vec3(b) - f + hash13( c );\n                float d = dot(r, r);\n\n                if(d < res) {\n                    res = d;\n                }\n            }\n        }\n    }\n\n    return 1.-res;\n}\n\nfloat tilableVoronoi( vec3 p, const int octaves, float tile ) {\n    float f = 1.;\n    float a = 1.;\n    float c = 0.;\n    float w = 0.;\n\n    if( tile > 0. ) f = tile;\n\n    for (int i = 0; i < 100; i++) {\n        if (i >= octaves) break;\n        c += a*voronoi( p * f, f );\n        f *= 2.0;\n        w += a;\n        a *= 0.5;\n    }\n\n    return c / w;\n}\n\nfloat tilableFbm( vec3 p, const int octaves, float tile ) {\n    float f = 1.;\n    float a = 1.;\n    float c = 0.;\n    float w = 0.;\n\n    if( tile > 0. ) f = tile;\n\n    for (int i = 0; i < 100; i++) {\n        if (i >= octaves) break;\n        c += a*valueNoise( p * f, f );\n        f *= 2.0;\n        w += a;\n        a *= 0.5;\n    }\n\n    return c / w;\n}\n\n',yN="#define GLSLIFY 1\nvarying vec3 vWorldPosition;\nvarying vec2 vUv;\nvoid main() {\n    vUv = uv;\n    vWorldPosition = normalize(vec3(position.x, position.y, position.z));\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    // gl_Position.z = gl_Position.w;\n}\n",_N={uniforms:{},vertexShader:yN,fragmentShader:bN+"\n#define GLSLIFY 1\n// Himalayas. Created by Reinder Nijhoff 2018\n// @reindernijhoff\n//\n// https://www.shadertoy.com/view/MdGfzh\n//\n// This is my first attempt to render volumetric clouds in a fragment shader.\n//\n// Buffer A: The main look-up texture for the cloud shapes. \n// Buffer B: A 3D (32x32x32) look-up texture with Worley Noise used to add small details \n//           to the shapes of the clouds. I have packed this 3D texture into a 2D buffer.\n// \nvarying vec2 vUv;\nvoid main() { \n\n    vec3 coord = fract(vec3(vUv + vec2(.2,0.62), .5));\n    \n    vec4 col = vec4(1);\n    \n    float mfbm = 0.9;\n    float mvor = 0.7;\n    \n    col.r = mix(1., tilableFbm( coord, 7, 4. ), mfbm) * \n            mix(1., tilableVoronoi( coord, 8, 9. ), mvor);\n    col.g = 0.625 * tilableVoronoi( coord + 0., 3, 15. ) +\n            0.250 * tilableVoronoi(  coord + 0., 3, 19. ) +\n            0.125 * tilableVoronoi( coord + 0., 3, 23. ) \n            -1.;\n    col.b = 1. - tilableVoronoi( coord + 0.5, 6, 9. );\n    \n    gl_FragColor = col;\n}"},vN={uniforms:{},vertexShader:yN,fragmentShader:bN+"\n#define GLSLIFY 1\n// Himalayas. Created by Reinder Nijhoff 2018\n// @reindernijhoff\n//\n// https://www.shadertoy.com/view/MdGfzh\n//\n// This is my first attempt to render volumetric clouds in a fragment shader.\n//\n// Buffer A: The main look-up texture for the cloud shapes. \n// Buffer B: A 3D (32x32x32) look-up texture with Worley Noise used to add small details \n//           to the shapes of the clouds. I have packed this 3D texture into a 2D buffer.\n// \n\nvoid main() { \n    \n        // pack 32x32x32 3d texture in 2d texture (with padding)\n    float z = floor(gl_FragCoord.x/34.) + 8.*floor(gl_FragCoord.y/34.);\n    vec2 uv = mod(gl_FragCoord.xy, 34.) - 1.;\n    vec3 coord = vec3(uv, z) / 32.;\n\n    float r = tilableVoronoi( coord, 16,  3. );\n    float g = tilableVoronoi( coord,  4,  8. );\n    float b = tilableVoronoi( coord,  4, 16. );\n\n    float c = max(0., 1.-(r + g * .5 + b * .25) / 1.75);\n\n    gl_FragColor = vec4(c,c,c,c);\n\n}"},xN={uniforms:{tShape:{value:null},tPrevious:{value:null},tDepth:{value:null},tDetail:{value:null},tDiffuse:{value:null},tBlueNoise:{value:null},tWeather:{value:null},tNoise:{value:null},resolution:{value:new bt(1,1)},iTime:{value:0},mvt_projectionMatrixInverse:{value:new Bi},mvt_viewMatrixInverse:{value:new Bi},uCameraMatrix:{value:new Bi},uLastCameraMatrix:{value:new Bi},mvt_cameraPosition:{value:new Qt},sunColor:{value:new Qt(1,1,1)},sunDirection:{value:new Qt(0,1,0)},coverage:{value:.52},density:{value:.03},speed:{value:1},cameraChanged:{value:!1},ambientColorBottom:{value:new Qt(.2,.35,.5)},shapeScale:{value:new Dt(5.51,50,1,1)},previousRatio:{value:.5}},vertexShader:yN,fragmentShader:bN+'\n#define GLSLIFY 1\n// Himalayas. Created by Reinder Nijhoff 2018\n// @reindernijhoff\n//\n// https://www.shadertoy.com/view/MdGfzh\n//\n// This is my first attempt to render volumetric clouds in a fragment shader.\n//\n// I started this shader by trying to implement the clouds of Horizon Zero Dawn, as\n// described in "The real-time volumetric cloudscapes of Horizon Zero Dawn" by \n// Andrew Schneider and Nathan Vos.[1] To model the shape of the clouds, two look-up\n// textures are created with different frequencies of (Perlin -) Worley noise:\n//\n// Buffer A: The main look-up texture for the cloud shapes. \n// Buffer B: A 3D (32x32x32) look-up texture with Worley Noise used to add small details \n//           to the shapes of the clouds. I have packed this 3D texture into a 2D buffer.\n//           \n// Because it is not possible (yet) to create buffers with fixed size, or 3D buffers, the\n// look-up texture in Buffer A is 2D, and a slice of the volume that is described in the \n// article. Therefore, and because I didn\'t have any slots left (in Buffer C) to use a \n// cloud type/cloud coverage texture, the modelling of the cloud shapes in this shader is \n// in the end mostly based on trial and error, and is probably far from the code used in \n// Horizon Zero Dawn.\n//\n// Buffer D: Rendering of the clouds.\n//\n// I render the clouds using the improved integration method of volumetric media, as described \n// in "Physically Based Sky, Atmosphere and Cloud Rendering in Frostbite" by \n// Sébastien Hillaire.[2]\n//\n// You can find the (excellent) example shaders of Sébastien Hillaire (SebH) here:\n//\n// https://www.shadertoy.com/view/XlBSRz\n// https://www.shadertoy.com/view/MdlyDs\n//\n// #define MVT_CLOUD_MARCH_STEPS 8\n// #define MVT_CLOUD_SELF_SHADOW_STEPS 3\n\n#define EARTH_RADIUS    (637100.) // (6371000.)\n#define CLOUDS_BOTTOM   (1350.)\n#define CLOUDS_TOP      (2350.)\n\n#define CLOUDS_LAYER_BOTTOM   (-150.)\n#define CLOUDS_LAYER_TOP      (-70.)\n\n#define CLOUDS_LAYER_COVERAGE (.41)\n\n#define CLOUDS_DETAIL_STRENGTH (.225)\n#define CLOUDS_BASE_EDGE_SOFTNESS (.1)\n#define CLOUDS_BOTTOM_SOFTNESS (.25)\n#define CLOUDS_SHADOW_MARGE_STEP_SIZE (10.)\n#define CLOUDS_LAYER_SHADOW_MARGE_STEP_SIZE (4.)\n#define CLOUDS_SHADOW_MARGE_STEP_MULTIPLY (1.3)\n#define CLOUDS_FORWARD_SCATTERING_G (.8)\n#define CLOUDS_BACKWARD_SCATTERING_G (-.2)\n#define CLOUDS_SCATTERING_LERP (.5)\n\n#define CLOUDS_AMBIENT_COLOR_TOP (vec3(149., 167., 200.)*(1.5/255.))\n// #define ambientColorBottom (vec3(39., 67., 87.)*(1.5/255.))\n// #define ambientColorBottom (vec3(20., 20., 20.)*(1.5/255.))\n#define CLOUDS_MIN_TRANSMITTANCE .1\n\n// #define shapeScale 5.51\n#define CLOUDS_DETAIL_SCALE 50.\n\n#ifdef MVT_USE_VOULEMTRIC\nuniform sampler2D tShape; // cloud shape\nuniform sampler2D tPrevious; // previous frame\nuniform sampler2D tDetail; // cloud detail\n#else\nuniform sampler2D tWeather; // cloud shape\nuniform sampler2D tNoise; // cloud detail\n#endif\nuniform sampler2D tDepth; // depth buffer\nuniform sampler2D tDiffuse;\nuniform sampler2D tBlueNoise;\nuniform vec2 resolution;\nuniform float iTime;\nuniform vec3 cameraDirection;\nuniform mat4 mvt_viewMatrixInverse;\nuniform mat4 mvt_projectionMatrixInverse;\nuniform vec3 mvt_cameraPosition;\nuniform mat4 uCameraMatrix;\nuniform mat4 uLastCameraMatrix;\nuniform vec3 sunColor;\nuniform vec3 sunDirection;\nuniform float coverage;\nuniform float density;\nuniform float speed;\nuniform bool cameraChanged;\nuniform vec3 ambientColorBottom;\nuniform float previousRatio;\n// .x baseScale .y detailScale\nuniform vec4 shapeScale;\n//\n// Cloud shape modelling and rendering \n//\n\nfloat HenyeyGreenstein( float sundotrd, float g) {\n\tfloat gg = g * g;\n\treturn (1. - gg) / pow( 1. + gg - 2. * g * sundotrd, 1.5);\n}\n\n// float interectCloudSphere( vec3 rd, float r ) {\n//     float b = EARTH_RADIUS * rd.y;\n//     float d = b * b + r * r + 2. * EARTH_RADIUS * r;\n//     return -b + sqrt( d );\n// }\n\nfloat interectCloudSphere(vec3 ro, vec3 rd, float rad) {\n    rad += EARTH_RADIUS;\n    float b = dot(ro, rd);\n    float c = dot(ro, ro) - rad*rad;\n    if (c > 0.0 && b > 0.0) return -1.0;\n    float discr = b*b - c;\n    if (discr < 0.0) return -1.0;\n    // Special case: inside sphere, use far discriminant\n    if (discr > b*b) return (-b + sqrt(discr));\n    return -b - sqrt(discr);\n}\n\nfloat linearstep( const float s, const float e, float v ) {\n    return clamp( (v-s)*(1./(e-s)), 0., 1. );\n}\n\nfloat linearstep0( const float e, float v ) {\n    return min( v*(1./e), 1. );\n}\n\nfloat remap(float v, float s, float e) {\n\treturn (v - s) / (e - s);\n}\n\nfloat remap2(float v, float l0, float h0, float ln, float hn) {\n    return ln + (v - l0) * (hn - ln) / (h0 - l0);\n}\n#ifdef MVT_USE_VOULEMTRIC\nfloat cloudMapBase(vec3 p, float norY) {\n\tvec3 uv = p * (0.00005 * shapeScale.x);\n    vec3 cloud = texture2D(tShape, uv.xz * 2.5 + iTime * 0.002 * speed).rgb;\n   \n    float n = norY*norY;\n    n *= cloud.b ;\n        n+= pow(1.-norY, 16.); \n\treturn remap( cloud.r - n, cloud.g, 1.);\n}\n\nfloat cloudMapDetail(vec3 p) { \n    // 3d lookup in 2d texture :(\n    p = abs(p) * (0.0016 * shapeScale.x * shapeScale.y);\n    p += iTime * 0.02 * speed;\n    float yi = mod(p.y,32.);\n    ivec2 offset = ivec2(mod(yi,8.), mod(floor(yi/8.),4.))*34 + 1;\n    float a = texture2D(tDetail, (mod(p.xz,32.)+vec2(offset.xy)+1.)/resolution.xy).r;\n    \n    yi = mod(p.y+1.,32.);\n    offset = ivec2(mod(yi,8.), mod(floor(yi/8.),4.))*34 + 1;\n    float b = texture2D(tDetail, (mod(p.xz,32.)+vec2(offset.xy)+1.)/resolution.xy).r;\n    \n    return mix(a,b,fract(p.y));\n}\n\nfloat cloudGradient( float norY ) {\n    return linearstep( 0., .05, norY ) - linearstep( .8, 1.2, norY);\n}\n\nfloat cloudMap(vec3 pos, vec3 rd, float norY) {\n    vec3 ps = pos;\n    \n    float m = cloudMapBase(ps, norY);\n\tm *= cloudGradient( norY );\n\n\tfloat dstrength = smoothstep(1., 0.5, m);\n    \n    // erode with detail\n    if(dstrength > 0.) {\n\t\tm -= cloudMapDetail( ps ) * dstrength * CLOUDS_DETAIL_STRENGTH;\n    }\n\n\tm = smoothstep( 0., CLOUDS_BASE_EDGE_SOFTNESS, m+(coverage-1.) );\n    m *= linearstep0(CLOUDS_BOTTOM_SOFTNESS, norY);\n\n    return clamp(m * density * (1.+max((ps.x-100000.)*0.005,0.)), 0., 1.);\n}\n\nfloat volumetricShadow(in vec3 from, in float sundotrd ) {\n    float dd = CLOUDS_SHADOW_MARGE_STEP_SIZE;\n    vec3 rd = sunDirection;\n    float d = dd * .5;\n    float shadow = 1.0;\n\n    for(int s=0; s<MVT_CLOUD_SELF_SHADOW_STEPS; s++) {\n        vec3 pos = from + rd * d;\n        float norY = (length(pos) - (EARTH_RADIUS + CLOUDS_BOTTOM)) * (1./(CLOUDS_TOP - CLOUDS_BOTTOM));\n\n        if(norY > 1.) return shadow;\n\n        float muE = cloudMap( pos, rd, norY );\n        shadow *= exp(-muE * dd);\n\n        dd *= CLOUDS_SHADOW_MARGE_STEP_MULTIPLY;\n        d += dd;\n    }\n    return shadow;\n}\n\nvec4 renderClouds( vec3 ro, vec3 rd, inout float dist ) {\n    if( rd.y < 0. ) {\n        return vec4(0,0,0,1);\n    }\n\n    // ro.x += -cos(iTime * 0.13) * 0.5;\n    // ro.z += (-cos(iTime * 0.1) * 100. + 20.) * 0.1;\n    // ro += rand();\n    // ro.xz *= SCENE_SCALE;\n    // 位置\n    // ro.x += iTime * 0.;\n    ro.y += EARTH_RADIUS;\n    // ro.y = sqrt(EARTH_RADIUS*EARTH_RADIUS-dot(ro.xz,ro.xz));\n\n    float start = interectCloudSphere(ro, rd, CLOUDS_BOTTOM );\n    float end  = interectCloudSphere(ro,  rd, CLOUDS_TOP );\n    \n    if (start > dist) {\n        return vec4(0,0,0,1);\n    }\n    \n    end = min(end, dist);\n    \n    float sundotrd = dot( rd, -sunDirection);\n\n    // raymarch\n    float d = start;\n    float dD = (end-start) / float(MVT_CLOUD_MARCH_STEPS);\n\n    float h = hash13(rd + fract(iTime) );\n    d -= dD * h;\n\n    float scattering =  mix( HenyeyGreenstein(sundotrd, CLOUDS_FORWARD_SCATTERING_G),\n        HenyeyGreenstein(sundotrd, CLOUDS_BACKWARD_SCATTERING_G), CLOUDS_SCATTERING_LERP );\n\n    float transmittance = 1.0;\n    vec3 scatteredLight = vec3(0.0, 0.0, 0.0);\n\n    dist = EARTH_RADIUS;\n\n    for(int s=0; s<MVT_CLOUD_MARCH_STEPS; s++) {\n        vec3 p = ro + d * rd;\n\n        float norY = clamp( (length(p) - (EARTH_RADIUS + CLOUDS_BOTTOM)) * (1./(CLOUDS_TOP - CLOUDS_BOTTOM)), 0., 1.);\n\n        float alpha = cloudMap( p, rd, norY );\n\n        if( alpha > 0. ) {\n            dist = min( dist, d);\n            vec3 ambientLight = mix( ambientColorBottom, CLOUDS_AMBIENT_COLOR_TOP, norY );\n\n            vec3 S = (ambientLight + sunColor * (scattering * volumetricShadow(p, sundotrd))) * alpha;\n            float dTrans = exp(-alpha * dD);\n            vec3 Sint = (S - S * dTrans) * (1. / alpha);\n            scatteredLight += transmittance * Sint; \n            transmittance *= dTrans;\n        }\n\n        if( transmittance <= CLOUDS_MIN_TRANSMITTANCE ) break;\n\n        d += dD;\n    }\n\n    return vec4(scatteredLight, transmittance);\n}\n//\n//\n// !Because I wanted a second cloud layer (below the horizon), I copy-pasted \n// almost all of the code above:\n//\n\nfloat cloudMapLayer(vec3 pos, vec3 rd, float norY) {\n    vec3 ps = pos;\n\n    float m = cloudMapBase(ps, norY);\n\t// m *= cloudGradient( norY );\n\tfloat dstrength = smoothstep(1., 0.5, m);\n    \n    // erode with detail\n    if (dstrength > 0.) {\n\t\tm -= cloudMapDetail( ps ) * dstrength * CLOUDS_DETAIL_STRENGTH;\n    }\n\n\tm = smoothstep( 0., CLOUDS_BASE_EDGE_SOFTNESS, m+(CLOUDS_LAYER_COVERAGE-1.) );\n\n    return clamp(m * density, 0., 1.);\n}\n\nfloat volumetricShadowLayer(in vec3 from, in float sundotrd ) {\n    float dd = CLOUDS_LAYER_SHADOW_MARGE_STEP_SIZE;\n    vec3 rd = sunDirection;\n    float d = dd * .5;\n    float shadow = 1.0;\n\n    for(int s=0; s<MVT_CLOUD_SELF_SHADOW_STEPS; s++) {\n        vec3 pos = from + rd * d;\n        float norY = clamp( (pos.y - CLOUDS_LAYER_BOTTOM ) * (1./(CLOUDS_LAYER_TOP - CLOUDS_LAYER_BOTTOM)), 0., 1.);\n\n        if(norY > 1.) return shadow;\n\n        float muE = cloudMapLayer( pos, rd, norY );\n        shadow *= exp(-muE * dd);\n\n        dd *= CLOUDS_SHADOW_MARGE_STEP_MULTIPLY;\n        d += dd;\n    }\n    return shadow;\n}\n\nvec4 renderCloudLayer( vec3 ro, vec3 rd, inout float dist ) {\n    if( rd.y > 0. ) {\n        return vec4(0,0,0,10);\n    }\n\n    ro.xz *= SCENE_SCALE;\n    ro.y += EARTH_RADIUS;\n    // ro.y = 0.;\n\n    float start = CLOUDS_LAYER_TOP/rd.y;\n    float end  = CLOUDS_LAYER_BOTTOM/rd.y;\n    \n    if (start > dist) {\n        return vec4(0,0,0,10);\n    }\n    \n    end = min(end, dist);\n    \n    float sundotrd = dot( rd, -sunDirection);\n\n    // raymarch\n    float d = start;\n    float dD = (end-start) / float(MVT_CLOUD_MARCH_STEPS);\n\n    float h = hash13(rd + fract(iTime) );\n    d -= dD * h;\n\n    float scattering =  mix( HenyeyGreenstein(sundotrd, CLOUDS_FORWARD_SCATTERING_G),\n        HenyeyGreenstein(sundotrd, CLOUDS_BACKWARD_SCATTERING_G), CLOUDS_SCATTERING_LERP );\n\n    float transmittance = 1.0;\n    vec3 scatteredLight = vec3(0.0, 0.0, 0.0);\n\n    dist = EARTH_RADIUS;\n\n    for(int s=0; s<MVT_CLOUD_MARCH_STEPS; s++) {\n        vec3 p = ro + d * rd;\n\n        float norY = clamp( (p.y - CLOUDS_LAYER_BOTTOM ) * (1./(CLOUDS_LAYER_TOP - CLOUDS_LAYER_BOTTOM)), 0., 1.);\n\n        float alpha = cloudMapLayer( p, rd, norY );\n\n        if( alpha > 0. ) {\n            dist = min( dist, d);\n            vec3 ambientLight = mix( ambientColorBottom, CLOUDS_AMBIENT_COLOR_TOP, norY );\n\n            vec3 S = .7 * (ambientLight +  sunColor * (scattering * volumetricShadowLayer(p, sundotrd))) * alpha;\n            float dTrans = exp(-alpha * dD);\n            vec3 Sint = (S - S * dTrans) * (1. / alpha);\n            scatteredLight += transmittance * Sint; \n            transmittance *= dTrans;\n        }\n\n        if( transmittance <= CLOUDS_MIN_TRANSMITTANCE ) break;\n\n        d += dD;\n    }\n\n    return vec4(scatteredLight, transmittance);\n}\n\nvec2 reprojectPos( in vec3 pos, in vec2 resolution, in sampler2D storage ) {\n    vec4 wpos = vec4(pos.xyz,1.0);\n    vec3 cpos = (wpos*uLastCameraMatrix).xzy; \n    vec2 npos = 2. * cpos.xy / cpos.z;\n    return 0.5 + 0.5*npos*vec2(resolution.y/resolution.x,1.0);\n}\n#else\n/**\n* simple cloud\n*/\nvec4 renderClouds( vec3 ro, vec3 rd, inout float dist ) {\n    if( rd.y < 0. ) {\n        return vec4(0,0,0,1);\n    }\n    ro.y += EARTH_RADIUS;\n\n    vec3 p = ro + rd * 60000.;\n    vec4 col = vec4(1.0);\n\n    // vec2 cloudUV = p.xz * 0.1;\n    float r = sqrt(2.0 * (1.0 - rd.y));\n    float theta = atan(rd.x, rd.z);\n\n    vec2 cloudUV = vec2(r * cos(theta) * 0.5 + 0.5, r * sin(theta) * 0.5 + 0.5) * 10000.0;\n    float uvOffset = iTime / 1000.0 * speed;\n    vec4 weatherColor = texture2D(tWeather, cloudUV * 0.00003 + uvOffset);\n    float wmc = max(weatherColor.x, clamp(coverage * 1.0 - 0.5, 0.0, 1.0) * weatherColor.y * 2.0);\n    // clouDensity = max(clouDensity, texture2D(noiseMap, cloudUV).x);\n    // SNsample = R(snr, (sng ×0.625+snb ×0.25+sna ×0.125)−1, 1, 0, 1)\n    vec4 noiseColor = texture2D(tNoise, (cloudUV + uvOffset) * 1.0);\n    float sn_sample = remap2(noiseColor.x, noiseColor.y * 0.625 + noiseColor.z * 0.25 + 1.0 * 0.125 - 1.0, 1.0, 0.0, 1.0);\n    float sn = clamp(remap2(sn_sample, 1.0 - coverage * 1.0 * wmc, 1.0, 0.0, 1.0), 0.0, 1.0);\n \n    float thickness = clamp(sn * 1.0 + 0.1, 0.0, 1.0);\n    float cloudAlpha = clamp(thickness, 0.0, 1.0); // remap2(clamp(sn, 0.0, 1. - thickness), 0.0, 1. - thickness, 0.0, 1.0);\n    // vec3 cloudColor = vec3(remap2(clamp(cloudAlpha, 0.0, 1.0), 0.0, 1.0, 1.0, 0.6));\n    vec3 cloudColor = vec3(cloudAlpha);\n    // 太阳散射，根据厚度发生变化\n    // vec3 sunLightColor = texture(sunLightMap, vec2((1.0 + sin(skyAltitude)) * 0.5, 0.5)).xyz;\n    // if (mixGrayFactor > 0.0) {\n    //     vec3 gray = vec3((sunLightColor.x + sunLightColor.y + sunLightColor.z) / 3.0);\n    //     sunLightColor = mix(sunLightColor, gray, mixGrayFactor);\n    // }\n    // cloudColor = sunLightColor;\n    // cloudColor = sunLightColor * (remap(thickness, 0.0, 1.0, 1.5, 0.5));\n    \n    // // 天空大气颜色\n    // vec3 sunDir = getSunDir();\n    // vec3 rayDir = normalize(vWorldPosition.xzy);\n\n    // cloudColor *= clamp(remap(dot(rayDir, sunDir), -1.0, 1.0, 0.75, 2.0), 0.75, 2.0);\n\n    // vec3 atmosphereColor = getValFromSkyLUT(rayDir, sunDir);\n    // atmosphereColor *= 100.0;\n    // atmosphereColor = jodieReinhardTonemap(atmosphereColor);\n    // atmosphereColor = pow(atmosphereColor, vec3(1.0/2.2));\n    // atmosphereColor = toLinear(vec4(atmosphereColor, 1.0)).xyz;\n\n    // float atmosphereColorFactor = remap(clamp(thickness, 0.5, 1.0), 0.5, 1.0, 0.0, 1.0);\n    // atmosphereColorFactor = 0.5 - abs(0.5 - atmosphereColorFactor);\n    // cloudColor = mix(cloudColor, atmosphereColor, atmosphereColorFactor);\n\n    // // 和天空大气混合\n    // cloudColor = mix(cloudColor, atmosphereColor, 1.0 - clamp((vWorldPosition.z + 0.02) * 10.0, 0.0, 1.0));\n\n    // cloudColor = atmosphereColor; // lum;\n    // vec3 cloudColor = texture2D(skyMap, cloudUV * 2.0).xyz * 10.0;\n    return vec4(cloudColor, 1.0 - cloudAlpha);\n    // return vec4(cloudUV, 0.0, 1.0);\n    // return col;\n}\n#endif\nfloat getDepthValue(sampler2D depthTexture, vec2 uv) {\n    return texture2D(depthTexture, uv).r;\n}\n\nvec3 ReinhardToneMapping( vec3 color ) {\n\treturn clamp( color / ( vec3( 1.0 ) + color ), 0.0, 1.0 );\n\n}\n\nvoid main() {\n    // if (gl_FragCoord.y < 1.5) {\n    //     gl_FragColor = saveCamera(iTime, gl_FragCoord, iMouse/resolution.xyxy);\n    //     if( abs(gl_FragCoord.x-1.5)<0.5 ) gl_FragColor = vec4(iMouse);\n    //     if( abs(gl_FragCoord.x-0.5)<0.5 ) gl_FragColor = mouseChanged() ? vec4(0) : vec4(resolution.xy,0,0);\n    // } else {\n    //     if( letterBox(gl_FragCoord, resolution.xy, 2.25) ) {\n    //     \tgl_FragColor = vec4( 0., 0., 0., 1. );\n    //    \t\treturn;\n    //     } else {\n    float depthValue = texelFetch(tDepth, ivec2(gl_FragCoord), 0).r;\n    // vec2 depthValueUV = gl_FragCoord.xy / resolution;\n    // float depthValue = getDepthValue(tDepth, depthValueUV);\n    if (depthValue < 0.99) {\n        gl_FragColor = vec4(0,0,0,1);\n        return;\n    }\n    float dist = 60000.0; // texelFetch(tDepth, ivec2(gl_FragCoord),0).w * SCENE_SCALE;\n    // dist = 30000.0 * SCENE_SCALE;\n    vec4 col = vec4(0,0,0,1);\n    vec3 camRight   = vec3( uCameraMatrix[0][0],  uCameraMatrix[0][1],  uCameraMatrix[0][2]);\n    vec3 camUp      = vec3( uCameraMatrix[1][0],  uCameraMatrix[1][1],  uCameraMatrix[1][2]);\n\tvec3 camForward = vec3(-uCameraMatrix[2][0], -uCameraMatrix[2][1], -uCameraMatrix[2][2]);\n\n\t// calculate unique seed for rng() function\n\t// seed = uvec2(uFrameCounter, uFrameCounter + 1.0) * uvec2(gl_FragCoord);\n\t// initialize rand() variables\n\t// randNumber = 0.0; // the final randomly-generated number (range: 0.0 to 1.0)\n\tfloat blueNoise = texelFetch(tBlueNoise, ivec2(mod(floor(gl_FragCoord.xy), 128.0)), 0).r * 0.5;\n    // vec2 blueNoiseUV = mod(gl_FragCoord.xy, vec2(128.0)) / 128.0;\n    // float blueNoise = getDepthValue(tBlueNoise, blueNoiseUV) * 0.5;\n\n\t// vec2 pixelOffset = vec2( tentFilter(rand()), tentFilter(rand()) ) * 0.5;\n\t// // we must map pixelPos into the range -1.0 to +1.0\n\n    float camFOVWidth = 35.0 / 180.0 * 3.1415926;\n    float camHeightScale = tan(camFOVWidth / 2.0);\n    float camWidthScale = camHeightScale * resolution.x / resolution.y;\n    vec2 uv = (gl_FragCoord.xy + vec2(0.5) + blueNoise) / resolution;\n\tvec2 pixelPos = uv * 2.0 - 1.0;\n\n\tvec3 rayDir = normalize( pixelPos.x * camRight * camWidthScale + pixelPos.y * camUp * camHeightScale + camForward );\n\n\t// depth of field\n\t// vec3 focalPoint = uFocusDistance * rayDir;\n\t// float randomAngle = rng() * TWO_PI; // pick random point on aperture\n\t// float randomRadius = rng() * uApertureSize;\n\t// vec3  randomAperturePos = ( cos(randomAngle) * camRight + sin(randomAngle) * camUp ) * sqrt(randomRadius);\n\t// // point on aperture to focal point\n\t// vec3 finalRayDir = normalize(focalPoint - randomAperturePos);\n\n\t// vec3 ro = vec3(0., 0., 0.); // cameraPosition.xzy; // CAMERA_RO; // cameraPosition.xzy / 10.;\n    vec3 ro = mvt_cameraPosition.xzy;\n    // ro += blueNoise;\n\tvec3 rd = rayDir.xzy;\n    if( rd.y > 0. ) {\n        // clouds\n        col = renderClouds(ro, rd, dist);\n        // TODO: 调整云的高光区域，防止过曝\n       //  col.rgb = ReinhardToneMapping(col.rgb);\n        // float fogAmount = 1.-(.1 + exp(-dist*0.000001));\n        float fogAmount = 1.0 - clamp(rd.y * 20.0, 0.0, 1.0);\n        // vec3 skyColor = getSkyColor(rd);\n        vec3 skyColor = clamp(texture2D(tDiffuse, uv).rgb, 0.0, 1.0);\n        col.rgb = mix(col.rgb, skyColor*(1.-col.a), fogAmount);\n    } else {\n        // cloud layer below horizon\n        // col = renderCloudLayer(ro, rd, dist);\n        // // height based fog, see https://iquilezles.org/articles/fog\n        // float fogAmount = HEIGHT_BASED_FOG_C * \n        //     (1.-exp( -dist*rd.y*(INV_SCENE_SCALE*HEIGHT_BASED_FOG_B)))/rd.y;\n        // vec3 skyColor = texture(tDiffuse, uv).rgb;\n        // col.rgb = mix(col.rgb, skyColor*(1.-col.a), clamp(fogAmount,0.,1.));\n    }\n    // vec4 previousColor = texelFetch(tPrevious, ivec2(gl_FragCoord.xy), 0);\n    // gl_FragColor = col * 0.1 + previousColor * 0.9;\t\n    #ifdef MVT_USE_VOULEMTRIC\n    if( col.w > 1. ) {\n         gl_FragColor = vec4(0,0,0,1);\n    } else {\n        // float ratio = 0.3;\n        // if (!cameraChanged) {\n        //     // vec2 spos = reprojectPos(ro+rd*dist, resolution.xy, tPrevious);\n        //     // 简化叠加\n        //     // col.r = ocol.a;\n        //     // col.x += 0.5;\n        //     ratio = 0.2;\n        // }\n        // else {\n\n        // }\n        vec2 spos = uv;\n        vec4 ocol = texture2D( tPrevious, spos, 0.0 ).xyzw;\n        col = mix(ocol, col, previousRatio);\n    }\n    #endif\n    gl_FragColor = col;\n}'};class BN extends vm{constructor(e={}){super(),__publicField(this,"_coverage",.56),__publicField(this,"_density",.015),__publicField(this,"_speed",1),__publicField(this,"_shapeBaseScale",.55),__publicField(this,"_shapeDetailScale",20),__publicField(this,"_sunColor",new Qt(1,1,1)),__publicField(this,"_sunDirection",new Qt(0,1,0)),__publicField(this,"_ambientColorBottom",new Qt(.2,.35,.5)),__publicField(this,"_useVolumetric",!0),this._fsQuad=new wm(null),this._shapeRenderTarget=new Yt(1280,720,{format:"RGBA",depthBuffer:!1,stencilBuffer:!1}),this._shapeRenderTarget.texture.generateMipmaps=!1,this._shapeRenderTarget.texture.minFilter=W,this._shapeRenderTarget.texture.magFilter=W,this._shapeRenderTarget.texture.wrapS=G,this._shapeRenderTarget.texture.wrapT=G,this._shapeMaterial=new ls({uniforms:as.clone(_N.uniforms),vertexShader:_N.vertexShader,fragmentShader:_N.fragmentShader,depthTest:!1,depthWrite:!1}),this._detailRenderTarget=new Yt(1024,512,{format:"RGBA",depthBuffer:!1,stencilBuffer:!1}),this._detailRenderTarget.texture.generateMipmaps=!1,this._detailRenderTarget.texture.wrapS=G,this._detailRenderTarget.texture.wrapT=G,this._detailRenderTarget.texture.minFilter=W,this._detailRenderTarget.texture.magFilter=W,this._detailMaterial=new ls({uniforms:as.clone(vN.uniforms),vertexShader:vN.vertexShader,fragmentShader:vN.fragmentShader,depthTest:!1,depthWrite:!1});const t={MVT_CLOUD_MARCH_STEPS:8,MVT_CLOUD_SELF_SHADOW_STEPS:3};this._useVolumetric&&(t.MVT_USE_VOULEMTRIC=!0);const i=this._mainMaterial=new ls({uniforms:as.clone(xN.uniforms),vertexShader:xN.vertexShader,fragmentShader:xN.fragmentShader,defines:t,depthTest:!1,depthWrite:!1,name:"VolumetricCloudsShader"});i.uniforms.tShape.value=this._shapeRenderTarget.texture,i.uniforms.tDetail.value=this._detailRenderTarget.texture,i.uniforms.tBlueNoise.value=e.tBlueNoise,i.uniforms.tWeather.value=e.tWeather,i.uniforms.tNoise.value=e.tNoise,this._previousRenderTarget=new Yt(1,1,{format:"RGBA",depthBuffer:!1,stencilBuffer:!1}),this._copyMaterial=new ls({uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:Sm.vertexShader,fragmentShader:Sm.fragmentShader,name:"VolumetricCloudsCopyShader",depthTest:!1,depthWrite:!1}),i.uniforms.tPrevious.value=this._previousRenderTarget.texture,this._compostionMaterial=new ls({uniforms:{tDiffuse:{value:null},tClold:{value:null}},vertexShader:Sm.vertexShader,fragmentShader:"\n    uniform sampler2D tDiffuse;\n    uniform sampler2D tClold;\n    varying vec2 vUv;\n    void main() {\n        vec4 color = texture2D(tDiffuse, vUv);\n        vec4 cloud = texture2D(tClold, vUv);\n        // gl_FragColor.rgb = mix(color.rgb, cloud.rgb, 1.0 - clamp(cloud.a, 0.0, 1.0));\n        gl_FragColor.rgb = cloud.rgb + color.rgb * cloud.a;\n        gl_FragColor.a = 1.0;\n        // gl_FragColor.rgb += cloud.rgb;\n        // gl_FragColor = cloud;\n        // gl_FragColor = vec4(cloud.a, 0.0, 0.0, 1.0);\n        // gl_FragColor = vec4(cloud.rgb, 1.0);\n    }\n",name:"VolumetricCloudsCompostionShader",depthTest:!1,depthWrite:!1}),this.needsDepthTexture=!0}render(e,t,i,n,s){if(!this.sky)return;const o=this.rendering,r=o.camera,a=o.resolution,l=o.pixelRatio,g=e.autoClear,c=this._mainMaterial,d=this._copyMaterial,h=this._fsQuad;if(e.autoClear=!1,!this._hasRenderShapeTexture||o.renderState.isRendererRecreated){h.material=this._shapeMaterial,e.setRenderTarget(this._shapeRenderTarget),e.clear(!0,!1,!1),h.render(e);const t=this._detailMaterial;h.material=t,e.setRenderTarget(this._detailRenderTarget),e.clear(!0,!1,!1),h.render(e),this._hasRenderShapeTexture=!0}if(c.uniforms.tDiffuse.value=i.texture,c.uniforms.tDepth.value=this.rendering.main.sceneRendering.depthTexture,c.uniforms.mvt_projectionMatrixInverse.value.copy(r.projectionMatrixInverse),c.uniforms.mvt_viewMatrixInverse.value.copy(r.matrixWorld),c.uniforms.cameraChanged.value=o.renderState.viewChanged,c.uniforms.speed.value=this._speed,c.uniforms.ambientColorBottom.value.copy(this._ambientColorBottom),c.uniforms.sunColor.value.copy(this._sunColor),c.uniforms.sunDirection.value.copy(this._sunDirection),c.uniforms.coverage.value=this._coverage,c.uniforms.density.value=this._density,c.uniforms.shapeScale.value.set(this._shapeBaseScale,this._shapeDetailScale,1,1),o._engine.map.isGlobe){let e=o._engine.map._map._ellipsoidCamera;c.uniforms.uCameraMatrix.value.copy(e.getLocalTransform());const t=e.positionCartographic.z;c.uniforms.mvt_cameraPosition.value.set(0,0,t)}else c.uniforms.uCameraMatrix.value.copy(r.matrixWorld),c.uniforms.mvt_cameraPosition.value.set(0,0,0);c.uniforms.coverage.value=this._coverage,c.uniforms.density.value=this._density,c.uniforms.iTime.value+=n;let u=!1;this._previousRenderTarget.width===a.x*l&&this._previousRenderTarget.height===a.y*l||(this._previousRenderTarget.setSize(a.x*l,a.y*l),c.uniforms.resolution.value.set(a.x*l,a.y*l),u=!0);const I=o.renderState.viewChanged;u?(c.previousRatio=0,this._stableFrames=0):I?(c.uniforms.previousRatio.value=.5,this._stableFrames=0):(c.uniforms.previousRatio.value=.1,this._stableFrames++),this._stableFrames<30&&o.requestRender();const p=o.sharedFullScreenRenderTargets.getAvailableRenderTarget();e.setRenderTarget(p),h.material=c,e.clear(!0,!1,!1),h.render(e),e.setRenderTarget(this._previousRenderTarget),d.uniforms.tDiffuse.value=p.texture,h.material=d,e.clear(!0,!1,!1),h.render(e);const m=this._compostionMaterial;m.uniforms.tDiffuse.value=i.texture,m.uniforms.tClold.value=p.texture,h.material=m,e.setRenderTarget(this.renderToScreen?null:t),e.clear(!0,!1,!1),h.render(e),c.uniforms.uLastCameraMatrix.value.copy(c.uniforms.uCameraMatrix.value),e.autoClear=g}getCurrentUsedTextures(){return[this._shapeRenderTarget.texture,this._detailRenderTarget.texture]}_resetStableState(){this._stableFrames=0}get coverage(){return this._coverage}set coverage(e){this._coverage=e,this._mainMaterial.uniforms.coverage.value=e,this._resetStableState()}get density(){return this._density}set density(e){this._density=e,this._mainMaterial.uniforms.density.value=e,this._resetStableState()}get speed(){return this._speed}set speed(e){this._speed=e,this._mainMaterial.uniforms.speed.value=e,this._resetStableState()}get sunColor(){return this._sunColor}set sunColor(e){this._sunColor.copy(e),this._mainMaterial.uniforms.sunColor.value.copy(e),this._resetStableState()}get sunDirection(){return this._sunDirection}set sunDirection(e){this._sunDirection.copy(e),this._mainMaterial.uniforms.sunDirection.value.copy(e),this._resetStableState()}get ambientColorBottom(){return this._ambientColorBottom}set ambientColorBottom(e){this._ambientColorBottom.copy(e),this._mainMaterial.uniforms.ambientColorBottom.value.copy(e),this._resetStableState()}get shapeBaseScale(){return this._shapeBaseScale}set shapeBaseScale(e){this._shapeBaseScale=e,this._mainMaterial.uniforms.shapeScale.value.x=e,this._resetStableState()}get shapeDetailScale(){return this._shapeDetailScale}set shapeDetailScale(e){this._shapeDetailScale=e,this._mainMaterial.uniforms.shapeScale.value.y=e,this._resetStableState()}get useVolumetric(){return this._useVolumetric}set useVolumetric(e){this._useVolumetric=e,e?this._mainMaterial.defines.MVT_USE_VOULEMTRIC=!0:delete this._mainMaterial.defines.MVT_USE_VOULEMTRIC,this._mainMaterial.needsUpdate=!0,this._resetStableState()}get marchSteps(){return this._mainMaterial.defines.MVT_CLOUD_MARCH_STEPS}set marchSteps(e){this._mainMaterial.defines.MVT_CLOUD_MARCH_STEPS=parseInt(e,10),this._mainMaterial.needsUpdate=!0}get selfShadowSteps(){return this._mainMaterial.defines.MVT_CLOUD_SELF_SHADOW_STEPS}set selfShadowSteps(e){this._mainMaterial.defines.MVT_CLOUD_SELF_SHADOW_STEPS=parseInt(e,10),this._mainMaterial.needsUpdate=!0}}const wN=new Qt,SN=new In,GN=new Bi;new Cs(new Qt(0,0,1),0);const MN=["//tile.osm.org","//a.tile.osm.org","//b.tile.osm.org","//c.tile.osm.org"];const RN={UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,getSizeInBytes:function(e){switch(e){case RN.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case RN.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case RN.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT}throw new Lm("indexDatatype is required and must be a valid IndexDatatype constant.")},fromSizeInBytes:function(e){switch(e){case 2:return RN.UNSIGNED_SHORT;case 4:return RN.UNSIGNED_INT;case 1:return RN.UNSIGNED_BYTE;default:throw new Lm("Size in bytes cannot be mapped to an IndexDatatype")}},validate:function(e){return am(e)&&(e===RN.UNSIGNED_BYTE||e===RN.UNSIGNED_SHORT||e===RN.UNSIGNED_INT)},createTypedArray:function(e,t){if(!am(e))throw new Lm("numberOfVertices is required.");return e>=Km.SIXTY_FOUR_KILOBYTES?new Uint32Array(t):new Uint16Array(t)},createTypedArrayFromArrayBuffer:function(e,t,i,n){if(!am(e))throw new Lm("numberOfVertices is required.");if(!am(t))throw new Lm("sourceArray is required.");if(!am(i))throw new Lm("byteOffset is required.");return e>=Km.SIXTY_FOUR_KILOBYTES?new Uint32Array(t,i,n):new Uint16Array(t,i,n)},fromTypedArray:function(e){if(e instanceof Uint8Array)return RN.UNSIGNED_BYTE;if(e instanceof Uint16Array)return RN.UNSIGNED_SHORT;if(e instanceof Uint32Array)return RN.UNSIGNED_INT;throw new Lm("array must be a Uint8Array, Uint16Array, or Uint32Array.")}},TN=Object.freeze(RN),ZN=[];function VN(e,t,i){ZN.length=e.length;let n=!1;for(let s=0,o=e.length;s<o;++s)ZN[s]=e[s],n=n||s>0&&t(e[s-1],e[s])>0;return n?(ZN.sort(t),TN.createTypedArray(i,ZN)):e}function WN(e){return e>>1^-(1&e)}class EN{constructor(e){if(!am(e)||!am(e.quantizedVertices))throw new Lm("options.quantizedVertices is required.");if(!am(e.indices))throw new Lm("options.indices is required.");if(!am(e.minimumHeight))throw new Lm("options.minimumHeight is required.");if(!am(e.maximumHeight))throw new Lm("options.maximumHeight is required.");if(!am(e.maximumHeight))throw new Lm("options.maximumHeight is required.");if(!am(e.westIndices))throw new Lm("options.westIndices is required.");if(!am(e.southIndices))throw new Lm("options.southIndices is required.");if(!am(e.eastIndices))throw new Lm("options.eastIndices is required.");if(!am(e.northIndices))throw new Lm("options.northIndices is required.");this._quantizedVertices=e.quantizedVertices,this._encodedNormals=e.encodedNormals,this._indices=e.indices,this._minimumHeight=e.minimumHeight,this._maximumHeight=e.maximumHeight,this._boundingSphere=e.boundingSphere,this._horizonOcclusionPoint=e.horizonOcclusionPoint;const t=this._quantizedVertices.length/3,i=this._uValues=this._quantizedVertices.subarray(0,t),n=this._vValues=this._quantizedVertices.subarray(t,2*t);function s(e,t){return n[e]-n[t]}function o(e,t){return i[e]-i[t]}this._heightValues=this._quantizedVertices.subarray(2*t,3*t),this._westIndices=VN(e.westIndices,s,t),this._southIndices=VN(e.southIndices,o,t),this._eastIndices=VN(e.eastIndices,s,t),this._northIndices=VN(e.northIndices,o,t),this._childTileMask=lm(e.childTileMask,15),this._mesh=void 0}static createQuantizedMeshTerrainData(e){let t=0;const i=3*Float64Array.BYTES_PER_ELEMENT,n=4*Float64Array.BYTES_PER_ELEMENT,s=3*Uint16Array.BYTES_PER_ELEMENT;let o=Uint16Array.BYTES_PER_ELEMENT,r=3*o;const a=new DataView(e);t+=i;const l=a.getFloat32(t,!0);t+=Float32Array.BYTES_PER_ELEMENT;const g=a.getFloat32(t,!0);t+=Float32Array.BYTES_PER_ELEMENT;const c={center:new Qt(a.getFloat64(t,!0),a.getFloat64(t+8,!0),a.getFloat64(t+16,!0)),radius:a.getFloat64(t+i,!0)};t+=n;const d=new Qt(a.getFloat64(t,!0),a.getFloat64(t+8,!0),a.getFloat64(t+16,!0));t+=i;const h=a.getUint32(t,!0);t+=Uint32Array.BYTES_PER_ELEMENT;const u=new Uint16Array(e,t,3*h);t+=h*s,h>65536&&(o=Uint32Array.BYTES_PER_ELEMENT,r=3*o);!function(e,t,i){const n=e.length;let s=0,o=0,r=0;for(let a=0;a<n;++a)s+=WN(e[a]),o+=WN(t[a]),e[a]=s,t[a]=o,am(i)&&(r+=WN(i[a]),i[a]=r)}(u.subarray(0,h),u.subarray(h,2*h),u.subarray(2*h,3*h)),t%o!=0&&(t+=o-t%o);const I=a.getUint32(t,!0);t+=Uint32Array.BYTES_PER_ELEMENT;const p=TN.createTypedArrayFromArrayBuffer(h,e,t,3*I);t+=I*r;let m=0;const A=p.length;for(let w=0;w<A;++w){const e=p[w];p[w]=m-e,0===e&&++m}const C=a.getUint32(t,!0);t+=Uint32Array.BYTES_PER_ELEMENT;const f=TN.createTypedArrayFromArrayBuffer(h,e,t,C);t+=C*o;const b=a.getUint32(t,!0);t+=Uint32Array.BYTES_PER_ELEMENT;const y=TN.createTypedArrayFromArrayBuffer(h,e,t,b);t+=b*o;const _=a.getUint32(t,!0);t+=Uint32Array.BYTES_PER_ELEMENT;const v=TN.createTypedArrayFromArrayBuffer(h,e,t,_);t+=_*o;const x=a.getUint32(t,!0);t+=Uint32Array.BYTES_PER_ELEMENT;const B=TN.createTypedArrayFromArrayBuffer(h,e,t,x);return t+=x*o,new EN({minimumHeight:l,maximumHeight:g,boundingSphere:c,horizonOcclusionPoint:d,quantizedVertices:u,indices:p,westIndices:f,southIndices:y,eastIndices:v,northIndices:B})}}class NN{constructor(e,t,i,n,s,o,r,a,l,g,c,d,h,u,I,p){this.center=e,this.vertices=t,this.stride=lm(g,6),this.indices=i,this.indexCountWithoutSkirts=n,this.vertexCountWithoutSkirts=s,this.minimumHeight=o,this.maximumHeight=r,this.boundingSphere3D=a,this.occludeePointInScaledSpace=l,this.orientedBoundingBox=c,this.encoding=d,this.westIndicesSouthToNorth=h,this.southIndicesEastToWest=u,this.eastIndicesNorthToSouth=I,this.northIndicesWestToEast=p}}class FN{constructor(e,t,i){this.provider=e,this._workerTaskScheduler=new TW(t,i),this._workerTaskScheduler.getResponseMessageId=this.getResponseMessageId,this._workerTaskScheduler.isMessageCompleted=this.isMessageCompleted}isMessageCompleted(e,t){return"terrainMeshCreated"===e.type||"terrainDataUpsampled"===e.type}getResponseMessageId(e,t){return e.tileKey}_vectorToArray(e){return[e.x,e.y,e.z]}_boxToArray(e){return[e.min.x,e.min.y,e.min.z,e.max.x,e.max.y,e.max.z]}async upsample(e,t,i){const n=this.provider,s=n._engine.map.map._ellipsoid,o=t.x,r=t.y,a=i.x,l=i.y;if(!am(e)||!am(e._mesh))return;const g=e._mesh,c=2*o!==a,d=2*r!==l,h=IA.fromBox(i.geoBoundingBox),u="upsampleTerrainData",I={type:u,tileKey:i.key,isEastChild:c,isNorthChild:d,childRectangle:h,ellipsoid:s,vertices:g.vertices,indices:g.indices,vertexCountWithoutSkirts:g.vertexCountWithoutSkirts,indexCountWithoutSkirts:g.indexCountWithoutSkirts,minimumHeight:g.minimumHeight,maximumHeight:g.maximumHeight};if(n.getFetchOptions){const e=n.getFetchOptions(i);I.fetchOptions=e}if(n.getWorkerOptions){const e=n.getWorkerOptions(i);I.workerOptions=e}let p=await this._workerTaskScheduler.postMessage(I,[],u+"-"+i.key);p=p.content;const m=new Uint16Array(p.vertices),A=TN.createTypedArray(m.length/3,p.indices);return new EN({quantizedVertices:m,indices:A,minimumHeight:p.minimumHeight,maximumHeight:p.maximumHeight,westIndices:p.westIndices,southIndices:p.southIndices,eastIndices:p.eastIndices,northIndices:p.northIndices,childTileMask:0})}async requestTile(e){const t=this.provider;let i,n=t.getTileURL(e.z,e.x,e.y,e);try{const s=t.getFetchOptions(e);i=await NW(n,{responseType:"arraybuffer",...s}).then((e=>e.arrayBuffer()))}catch(s){return void console.warn("no tile")}if(!i)return Promise.reject("Mesh buffer dosen't exist");return EN.createQuantizedMeshTerrainData(i)}async createMesh(e,t,i){const n=this.provider,s=n._engine.map.map._ellipsoid,o=IA.fromBox(t.geoBoundingBox),r="createTerrainMesh";let a=t.targetCenter;const l={type:r,tileKey:t.key,tileCenter:a,minimumHeight:e._minimumHeight,maximumHeight:e._maximumHeight,quantizedVertices:e._quantizedVertices,indices:e._indices,westIndices:e._westIndices,southIndices:e._southIndices,eastIndices:e._eastIndices,northIndices:e._northIndices,rectangle:o,level:t.z,ellipsoid:s};if(n.getFetchOptions){const e=n.getFetchOptions(t);l.fetchOptions=e}if(n.getWorkerOptions){const e=n.getWorkerOptions(t);l.workerOptions=e}const g=await this._workerTaskScheduler.postMessage(l,[],r+"-"+t.key);if(!am(g.content))return;const c=g.content,d=e._quantizedVertices.length/3,h=d+e._westIndices.length+e._southIndices.length+e._eastIndices.length+e._northIndices.length,u=TN.createTypedArray(h,c.indices),I=new Float32Array(c.vertices),p=c.center,m=c.minimumHeight,A=c.maximumHeight;return e._mesh=new NN(p,I,u,c.indexCountWithoutSkirts,d,m,A,void 0,void 0,void 0,void 0,void 0,c.westIndicesSouthToNorth,c.southIndicesEastToWest,c.eastIndicesNorthToSouth,c.northIndicesWestToEast),e._quantizedVertices=void 0,e._encodedNormals=void 0,e._indices=void 0,e._uValues=void 0,e._vValues=void 0,e._heightValues=void 0,e._westIndices=void 0,e._southIndices=void 0,e._eastIndices=void 0,e._northIndices=void 0,e._mesh}postMessageToAll(e,t){this._workerTaskScheduler.initWorkers(),this._workerTaskScheduler.postMessageToAll(e,t)}}const XN="dmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKdmFyIF9fZGVmTm9ybWFsUHJvcCA9IChvYmosIGtleSwgdmFsdWUpID0+IGtleSBpbiBvYmogPyBfX2RlZlByb3Aob2JqLCBrZXksIHsgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSwgdmFsdWUgfSkgOiBvYmpba2V5XSA9IHZhbHVlOwp2YXIgX19wdWJsaWNGaWVsZCA9IChvYmosIGtleSwgdmFsdWUpID0+IHsKICBfX2RlZk5vcm1hbFByb3Aob2JqLCB0eXBlb2Yga2V5ICE9PSAic3ltYm9sIiA/IGtleSArICIiIDoga2V5LCB2YWx1ZSk7CiAgcmV0dXJuIHZhbHVlOwp9OwovKioKICogQGxpY2Vuc2UKICogQ29weXJpZ2h0IDIwMTAtMjAyMyBUaHJlZS5qcyBBdXRob3JzCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNSVQKICovCmNvbnN0IFJFVklTSU9OID0gIjE1OCI7CmNvbnN0IF9sdXQgPSBbIjAwIiwgIjAxIiwgIjAyIiwgIjAzIiwgIjA0IiwgIjA1IiwgIjA2IiwgIjA3IiwgIjA4IiwgIjA5IiwgIjBhIiwgIjBiIiwgIjBjIiwgIjBkIiwgIjBlIiwgIjBmIiwgIjEwIiwgIjExIiwgIjEyIiwgIjEzIiwgIjE0IiwgIjE1IiwgIjE2IiwgIjE3IiwgIjE4IiwgIjE5IiwgIjFhIiwgIjFiIiwgIjFjIiwgIjFkIiwgIjFlIiwgIjFmIiwgIjIwIiwgIjIxIiwgIjIyIiwgIjIzIiwgIjI0IiwgIjI1IiwgIjI2IiwgIjI3IiwgIjI4IiwgIjI5IiwgIjJhIiwgIjJiIiwgIjJjIiwgIjJkIiwgIjJlIiwgIjJmIiwgIjMwIiwgIjMxIiwgIjMyIiwgIjMzIiwgIjM0IiwgIjM1IiwgIjM2IiwgIjM3IiwgIjM4IiwgIjM5IiwgIjNhIiwgIjNiIiwgIjNjIiwgIjNkIiwgIjNlIiwgIjNmIiwgIjQwIiwgIjQxIiwgIjQyIiwgIjQzIiwgIjQ0IiwgIjQ1IiwgIjQ2IiwgIjQ3IiwgIjQ4IiwgIjQ5IiwgIjRhIiwgIjRiIiwgIjRjIiwgIjRkIiwgIjRlIiwgIjRmIiwgIjUwIiwgIjUxIiwgIjUyIiwgIjUzIiwgIjU0IiwgIjU1IiwgIjU2IiwgIjU3IiwgIjU4IiwgIjU5IiwgIjVhIiwgIjViIiwgIjVjIiwgIjVkIiwgIjVlIiwgIjVmIiwgIjYwIiwgIjYxIiwgIjYyIiwgIjYzIiwgIjY0IiwgIjY1IiwgIjY2IiwgIjY3IiwgIjY4IiwgIjY5IiwgIjZhIiwgIjZiIiwgIjZjIiwgIjZkIiwgIjZlIiwgIjZmIiwgIjcwIiwgIjcxIiwgIjcyIiwgIjczIiwgIjc0IiwgIjc1IiwgIjc2IiwgIjc3IiwgIjc4IiwgIjc5IiwgIjdhIiwgIjdiIiwgIjdjIiwgIjdkIiwgIjdlIiwgIjdmIiwgIjgwIiwgIjgxIiwgIjgyIiwgIjgzIiwgIjg0IiwgIjg1IiwgIjg2IiwgIjg3IiwgIjg4IiwgIjg5IiwgIjhhIiwgIjhiIiwgIjhjIiwgIjhkIiwgIjhlIiwgIjhmIiwgIjkwIiwgIjkxIiwgIjkyIiwgIjkzIiwgIjk0IiwgIjk1IiwgIjk2IiwgIjk3IiwgIjk4IiwgIjk5IiwgIjlhIiwgIjliIiwgIjljIiwgIjlkIiwgIjllIiwgIjlmIiwgImEwIiwgImExIiwgImEyIiwgImEzIiwgImE0IiwgImE1IiwgImE2IiwgImE3IiwgImE4IiwgImE5IiwgImFhIiwgImFiIiwgImFjIiwgImFkIiwgImFlIiwgImFmIiwgImIwIiwgImIxIiwgImIyIiwgImIzIiwgImI0IiwgImI1IiwgImI2IiwgImI3IiwgImI4IiwgImI5IiwgImJhIiwgImJiIiwgImJjIiwgImJkIiwgImJlIiwgImJmIiwgImMwIiwgImMxIiwgImMyIiwgImMzIiwgImM0IiwgImM1IiwgImM2IiwgImM3IiwgImM4IiwgImM5IiwgImNhIiwgImNiIiwgImNjIiwgImNkIiwgImNlIiwgImNmIiwgImQwIiwgImQxIiwgImQyIiwgImQzIiwgImQ0IiwgImQ1IiwgImQ2IiwgImQ3IiwgImQ4IiwgImQ5IiwgImRhIiwgImRiIiwgImRjIiwgImRkIiwgImRlIiwgImRmIiwgImUwIiwgImUxIiwgImUyIiwgImUzIiwgImU0IiwgImU1IiwgImU2IiwgImU3IiwgImU4IiwgImU5IiwgImVhIiwgImViIiwgImVjIiwgImVkIiwgImVlIiwgImVmIiwgImYwIiwgImYxIiwgImYyIiwgImYzIiwgImY0IiwgImY1IiwgImY2IiwgImY3IiwgImY4IiwgImY5IiwgImZhIiwgImZiIiwgImZjIiwgImZkIiwgImZlIiwgImZmIl07CmxldCBfc2VlZCA9IDEyMzQ1Njc7CmNvbnN0IERFRzJSQUQgPSBNYXRoLlBJIC8gMTgwOwpjb25zdCBSQUQyREVHID0gMTgwIC8gTWF0aC5QSTsKZnVuY3Rpb24gZ2VuZXJhdGVVVUlEKCkgewogIGNvbnN0IGQwID0gTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTUgfCAwOwogIGNvbnN0IGQxID0gTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTUgfCAwOwogIGNvbnN0IGQyID0gTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTUgfCAwOwogIGNvbnN0IGQzID0gTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTUgfCAwOwogIGNvbnN0IHV1aWQgPSBfbHV0W2QwICYgMjU1XSArIF9sdXRbZDAgPj4gOCAmIDI1NV0gKyBfbHV0W2QwID4+IDE2ICYgMjU1XSArIF9sdXRbZDAgPj4gMjQgJiAyNTVdICsgIi0iICsgX2x1dFtkMSAmIDI1NV0gKyBfbHV0W2QxID4+IDggJiAyNTVdICsgIi0iICsgX2x1dFtkMSA+PiAxNiAmIDE1IHwgNjRdICsgX2x1dFtkMSA+PiAyNCAmIDI1NV0gKyAiLSIgKyBfbHV0W2QyICYgNjMgfCAxMjhdICsgX2x1dFtkMiA+PiA4ICYgMjU1XSArICItIiArIF9sdXRbZDIgPj4gMTYgJiAyNTVdICsgX2x1dFtkMiA+PiAyNCAmIDI1NV0gKyBfbHV0W2QzICYgMjU1XSArIF9sdXRbZDMgPj4gOCAmIDI1NV0gKyBfbHV0W2QzID4+IDE2ICYgMjU1XSArIF9sdXRbZDMgPj4gMjQgJiAyNTVdOwogIHJldHVybiB1dWlkLnRvTG93ZXJDYXNlKCk7Cn0KZnVuY3Rpb24gY2xhbXAodmFsdWUsIG1pbiwgbWF4KSB7CiAgcmV0dXJuIE1hdGgubWF4KG1pbiwgTWF0aC5taW4obWF4LCB2YWx1ZSkpOwp9CmZ1bmN0aW9uIGV1Y2xpZGVhbk1vZHVsbyhuLCBtKSB7CiAgcmV0dXJuIChuICUgbSArIG0pICUgbTsKfQpmdW5jdGlvbiBtYXBMaW5lYXIoeCwgYTEsIGEyLCBiMSwgYjIpIHsKICByZXR1cm4gYjEgKyAoeCAtIGExKSAqIChiMiAtIGIxKSAvIChhMiAtIGExKTsKfQpmdW5jdGlvbiBpbnZlcnNlTGVycCh4LCB5LCB2YWx1ZSkgewogIGlmICh4ICE9PSB5KSB7CiAgICByZXR1cm4gKHZhbHVlIC0geCkgLyAoeSAtIHgpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gMDsKICB9Cn0KZnVuY3Rpb24gbGVycCh4LCB5LCB0KSB7CiAgcmV0dXJuICgxIC0gdCkgKiB4ICsgdCAqIHk7Cn0KZnVuY3Rpb24gZGFtcCh4LCB5LCBsYW1iZGEsIGR0KSB7CiAgcmV0dXJuIGxlcnAoeCwgeSwgMSAtIE1hdGguZXhwKC1sYW1iZGEgKiBkdCkpOwp9CmZ1bmN0aW9uIHBpbmdwb25nKHgsIGxlbmd0aCA9IDEpIHsKICByZXR1cm4gbGVuZ3RoIC0gTWF0aC5hYnMoZXVjbGlkZWFuTW9kdWxvKHgsIGxlbmd0aCAqIDIpIC0gbGVuZ3RoKTsKfQpmdW5jdGlvbiBzbW9vdGhzdGVwKHgsIG1pbiwgbWF4KSB7CiAgaWYgKHggPD0gbWluKQogICAgcmV0dXJuIDA7CiAgaWYgKHggPj0gbWF4KQogICAgcmV0dXJuIDE7CiAgeCA9ICh4IC0gbWluKSAvIChtYXggLSBtaW4pOwogIHJldHVybiB4ICogeCAqICgzIC0gMiAqIHgpOwp9CmZ1bmN0aW9uIHNtb290aGVyc3RlcCh4LCBtaW4sIG1heCkgewogIGlmICh4IDw9IG1pbikKICAgIHJldHVybiAwOwogIGlmICh4ID49IG1heCkKICAgIHJldHVybiAxOwogIHggPSAoeCAtIG1pbikgLyAobWF4IC0gbWluKTsKICByZXR1cm4geCAqIHggKiB4ICogKHggKiAoeCAqIDYgLSAxNSkgKyAxMCk7Cn0KZnVuY3Rpb24gcmFuZEludChsb3csIGhpZ2gpIHsKICByZXR1cm4gbG93ICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKGhpZ2ggLSBsb3cgKyAxKSk7Cn0KZnVuY3Rpb24gcmFuZEZsb2F0KGxvdywgaGlnaCkgewogIHJldHVybiBsb3cgKyBNYXRoLnJhbmRvbSgpICogKGhpZ2ggLSBsb3cpOwp9CmZ1bmN0aW9uIHJhbmRGbG9hdFNwcmVhZChyYW5nZSkgewogIHJldHVybiByYW5nZSAqICgwLjUgLSBNYXRoLnJhbmRvbSgpKTsKfQpmdW5jdGlvbiBzZWVkZWRSYW5kb20ocykgewogIGlmIChzICE9PSB2b2lkIDApCiAgICBfc2VlZCA9IHM7CiAgbGV0IHQgPSBfc2VlZCArPSAxODMxNTY1ODEzOwogIHQgPSBNYXRoLmltdWwodCBeIHQgPj4+IDE1LCB0IHwgMSk7CiAgdCBePSB0ICsgTWF0aC5pbXVsKHQgXiB0ID4+PiA3LCB0IHwgNjEpOwogIHJldHVybiAoKHQgXiB0ID4+PiAxNCkgPj4+IDApIC8gNDI5NDk2NzI5NjsKfQpmdW5jdGlvbiBkZWdUb1JhZChkZWdyZWVzKSB7CiAgcmV0dXJuIGRlZ3JlZXMgKiBERUcyUkFEOwp9CmZ1bmN0aW9uIHJhZFRvRGVnKHJhZGlhbnMpIHsKICByZXR1cm4gcmFkaWFucyAqIFJBRDJERUc7Cn0KZnVuY3Rpb24gaXNQb3dlck9mVHdvKHZhbHVlKSB7CiAgcmV0dXJuICh2YWx1ZSAmIHZhbHVlIC0gMSkgPT09IDAgJiYgdmFsdWUgIT09IDA7Cn0KZnVuY3Rpb24gY2VpbFBvd2VyT2ZUd28odmFsdWUpIHsKICByZXR1cm4gTWF0aC5wb3coMiwgTWF0aC5jZWlsKE1hdGgubG9nKHZhbHVlKSAvIE1hdGguTE4yKSk7Cn0KZnVuY3Rpb24gZmxvb3JQb3dlck9mVHdvKHZhbHVlKSB7CiAgcmV0dXJuIE1hdGgucG93KDIsIE1hdGguZmxvb3IoTWF0aC5sb2codmFsdWUpIC8gTWF0aC5MTjIpKTsKfQpmdW5jdGlvbiBzZXRRdWF0ZXJuaW9uRnJvbVByb3BlckV1bGVyKHEsIGEsIGIsIGMsIG9yZGVyKSB7CiAgY29uc3QgY29zID0gTWF0aC5jb3M7CiAgY29uc3Qgc2luID0gTWF0aC5zaW47CiAgY29uc3QgYzIgPSBjb3MoYiAvIDIpOwogIGNvbnN0IHMyID0gc2luKGIgLyAyKTsKICBjb25zdCBjMTMgPSBjb3MoKGEgKyBjKSAvIDIpOwogIGNvbnN0IHMxMyA9IHNpbigoYSArIGMpIC8gMik7CiAgY29uc3QgYzFfMyA9IGNvcygoYSAtIGMpIC8gMik7CiAgY29uc3QgczFfMyA9IHNpbigoYSAtIGMpIC8gMik7CiAgY29uc3QgYzNfMSA9IGNvcygoYyAtIGEpIC8gMik7CiAgY29uc3QgczNfMSA9IHNpbigoYyAtIGEpIC8gMik7CiAgc3dpdGNoIChvcmRlcikgewogICAgY2FzZSAiWFlYIjoKICAgICAgcS5zZXQoYzIgKiBzMTMsIHMyICogYzFfMywgczIgKiBzMV8zLCBjMiAqIGMxMyk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiWVpZIjoKICAgICAgcS5zZXQoczIgKiBzMV8zLCBjMiAqIHMxMywgczIgKiBjMV8zLCBjMiAqIGMxMyk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiWlhaIjoKICAgICAgcS5zZXQoczIgKiBjMV8zLCBzMiAqIHMxXzMsIGMyICogczEzLCBjMiAqIGMxMyk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiWFpYIjoKICAgICAgcS5zZXQoYzIgKiBzMTMsIHMyICogczNfMSwgczIgKiBjM18xLCBjMiAqIGMxMyk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiWVhZIjoKICAgICAgcS5zZXQoczIgKiBjM18xLCBjMiAqIHMxMywgczIgKiBzM18xLCBjMiAqIGMxMyk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAiWllaIjoKICAgICAgcS5zZXQoczIgKiBzM18xLCBzMiAqIGMzXzEsIGMyICogczEzLCBjMiAqIGMxMyk7CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgY29uc29sZS53YXJuKCJUSFJFRS5NYXRoVXRpbHM6IC5zZXRRdWF0ZXJuaW9uRnJvbVByb3BlckV1bGVyKCkgZW5jb3VudGVyZWQgYW4gdW5rbm93biBvcmRlcjogIiArIG9yZGVyKTsKICB9Cn0KZnVuY3Rpb24gZGVub3JtYWxpemUodmFsdWUsIGFycmF5KSB7CiAgc3dpdGNoIChhcnJheS5jb25zdHJ1Y3RvcikgewogICAgY2FzZSBGbG9hdDMyQXJyYXk6CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIGNhc2UgVWludDMyQXJyYXk6CiAgICAgIHJldHVybiB2YWx1ZSAvIDQyOTQ5NjcyOTU7CiAgICBjYXNlIFVpbnQxNkFycmF5OgogICAgICByZXR1cm4gdmFsdWUgLyA2NTUzNTsKICAgIGNhc2UgVWludDhBcnJheToKICAgICAgcmV0dXJuIHZhbHVlIC8gMjU1OwogICAgY2FzZSBJbnQzMkFycmF5OgogICAgICByZXR1cm4gTWF0aC5tYXgodmFsdWUgLyAyMTQ3NDgzNjQ3LCAtMSk7CiAgICBjYXNlIEludDE2QXJyYXk6CiAgICAgIHJldHVybiBNYXRoLm1heCh2YWx1ZSAvIDMyNzY3LCAtMSk7CiAgICBjYXNlIEludDhBcnJheToKICAgICAgcmV0dXJuIE1hdGgubWF4KHZhbHVlIC8gMTI3LCAtMSk7CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgY29tcG9uZW50IHR5cGUuIik7CiAgfQp9CmZ1bmN0aW9uIG5vcm1hbGl6ZSh2YWx1ZSwgYXJyYXkpIHsKICBzd2l0Y2ggKGFycmF5LmNvbnN0cnVjdG9yKSB7CiAgICBjYXNlIEZsb2F0MzJBcnJheToKICAgICAgcmV0dXJuIHZhbHVlOwogICAgY2FzZSBVaW50MzJBcnJheToKICAgICAgcmV0dXJuIE1hdGgucm91bmQodmFsdWUgKiA0Mjk0OTY3Mjk1KTsKICAgIGNhc2UgVWludDE2QXJyYXk6CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKHZhbHVlICogNjU1MzUpOwogICAgY2FzZSBVaW50OEFycmF5OgogICAgICByZXR1cm4gTWF0aC5yb3VuZCh2YWx1ZSAqIDI1NSk7CiAgICBjYXNlIEludDMyQXJyYXk6CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKHZhbHVlICogMjE0NzQ4MzY0Nyk7CiAgICBjYXNlIEludDE2QXJyYXk6CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKHZhbHVlICogMzI3NjcpOwogICAgY2FzZSBJbnQ4QXJyYXk6CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKHZhbHVlICogMTI3KTsKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBjb21wb25lbnQgdHlwZS4iKTsKICB9Cn0KY29uc3QgTWF0aFV0aWxzID0gewogIERFRzJSQUQsCiAgUkFEMkRFRywKICBnZW5lcmF0ZVVVSUQsCiAgY2xhbXAsCiAgZXVjbGlkZWFuTW9kdWxvLAogIG1hcExpbmVhciwKICBpbnZlcnNlTGVycCwKICBsZXJwLAogIGRhbXAsCiAgcGluZ3BvbmcsCiAgc21vb3Roc3RlcCwKICBzbW9vdGhlcnN0ZXAsCiAgcmFuZEludCwKICByYW5kRmxvYXQsCiAgcmFuZEZsb2F0U3ByZWFkLAogIHNlZWRlZFJhbmRvbSwKICBkZWdUb1JhZCwKICByYWRUb0RlZywKICBpc1Bvd2VyT2ZUd28sCiAgY2VpbFBvd2VyT2ZUd28sCiAgZmxvb3JQb3dlck9mVHdvLAogIHNldFF1YXRlcm5pb25Gcm9tUHJvcGVyRXVsZXIsCiAgbm9ybWFsaXplLAogIGRlbm9ybWFsaXplCn07CmNsYXNzIFZlY3RvcjIgewogIGNvbnN0cnVjdG9yKHggPSAwLCB5ID0gMCkgewogICAgVmVjdG9yMi5wcm90b3R5cGUuaXNWZWN0b3IyID0gdHJ1ZTsKICAgIHRoaXMueCA9IHg7CiAgICB0aGlzLnkgPSB5OwogIH0KICBnZXQgd2lkdGgoKSB7CiAgICByZXR1cm4gdGhpcy54OwogIH0KICBzZXQgd2lkdGgodmFsdWUpIHsKICAgIHRoaXMueCA9IHZhbHVlOwogIH0KICBnZXQgaGVpZ2h0KCkgewogICAgcmV0dXJuIHRoaXMueTsKICB9CiAgc2V0IGhlaWdodCh2YWx1ZSkgewogICAgdGhpcy55ID0gdmFsdWU7CiAgfQogIHNldCh4LCB5KSB7CiAgICB0aGlzLnggPSB4OwogICAgdGhpcy55ID0geTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRTY2FsYXIoc2NhbGFyKSB7CiAgICB0aGlzLnggPSBzY2FsYXI7CiAgICB0aGlzLnkgPSBzY2FsYXI7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0WCh4KSB7CiAgICB0aGlzLnggPSB4OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldFkoeSkgewogICAgdGhpcy55ID0geTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRDb21wb25lbnQoaW5kZXgsIHZhbHVlKSB7CiAgICBzd2l0Y2ggKGluZGV4KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICB0aGlzLnggPSB2YWx1ZTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMueSA9IHZhbHVlOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgb3V0IG9mIHJhbmdlOiAiICsgaW5kZXgpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIGdldENvbXBvbmVudChpbmRleCkgewogICAgc3dpdGNoIChpbmRleCkgewogICAgICBjYXNlIDA6CiAgICAgICAgcmV0dXJuIHRoaXMueDsKICAgICAgY2FzZSAxOgogICAgICAgIHJldHVybiB0aGlzLnk7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJpbmRleCBpcyBvdXQgb2YgcmFuZ2U6ICIgKyBpbmRleCk7CiAgICB9CiAgfQogIGNsb25lKCkgewogICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMueCwgdGhpcy55KTsKICB9CiAgY29weSh2KSB7CiAgICB0aGlzLnggPSB2Lng7CiAgICB0aGlzLnkgPSB2Lnk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgYWRkKHYpIHsKICAgIHRoaXMueCArPSB2Lng7CiAgICB0aGlzLnkgKz0gdi55OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFkZFNjYWxhcihzKSB7CiAgICB0aGlzLnggKz0gczsKICAgIHRoaXMueSArPSBzOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFkZFZlY3RvcnMoYSwgYikgewogICAgdGhpcy54ID0gYS54ICsgYi54OwogICAgdGhpcy55ID0gYS55ICsgYi55OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFkZFNjYWxlZFZlY3Rvcih2LCBzKSB7CiAgICB0aGlzLnggKz0gdi54ICogczsKICAgIHRoaXMueSArPSB2LnkgKiBzOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHN1Yih2KSB7CiAgICB0aGlzLnggLT0gdi54OwogICAgdGhpcy55IC09IHYueTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzdWJTY2FsYXIocykgewogICAgdGhpcy54IC09IHM7CiAgICB0aGlzLnkgLT0gczsKICAgIHJldHVybiB0aGlzOwogIH0KICBzdWJWZWN0b3JzKGEsIGIpIHsKICAgIHRoaXMueCA9IGEueCAtIGIueDsKICAgIHRoaXMueSA9IGEueSAtIGIueTsKICAgIHJldHVybiB0aGlzOwogIH0KICBtdWx0aXBseSh2KSB7CiAgICB0aGlzLnggKj0gdi54OwogICAgdGhpcy55ICo9IHYueTsKICAgIHJldHVybiB0aGlzOwogIH0KICBtdWx0aXBseVNjYWxhcihzY2FsYXIpIHsKICAgIHRoaXMueCAqPSBzY2FsYXI7CiAgICB0aGlzLnkgKj0gc2NhbGFyOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGRpdmlkZSh2KSB7CiAgICB0aGlzLnggLz0gdi54OwogICAgdGhpcy55IC89IHYueTsKICAgIHJldHVybiB0aGlzOwogIH0KICBkaXZpZGVTY2FsYXIoc2NhbGFyKSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseVNjYWxhcigxIC8gc2NhbGFyKTsKICB9CiAgYXBwbHlNYXRyaXgzKG0pIHsKICAgIGNvbnN0IHggPSB0aGlzLngsIHkgPSB0aGlzLnk7CiAgICBjb25zdCBlID0gbS5lbGVtZW50czsKICAgIHRoaXMueCA9IGVbMF0gKiB4ICsgZVszXSAqIHkgKyBlWzZdOwogICAgdGhpcy55ID0gZVsxXSAqIHggKyBlWzRdICogeSArIGVbN107CiAgICByZXR1cm4gdGhpczsKICB9CiAgbWluKHYpIHsKICAgIHRoaXMueCA9IE1hdGgubWluKHRoaXMueCwgdi54KTsKICAgIHRoaXMueSA9IE1hdGgubWluKHRoaXMueSwgdi55KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBtYXgodikgewogICAgdGhpcy54ID0gTWF0aC5tYXgodGhpcy54LCB2LngpOwogICAgdGhpcy55ID0gTWF0aC5tYXgodGhpcy55LCB2LnkpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGNsYW1wKG1pbiwgbWF4KSB7CiAgICB0aGlzLnggPSBNYXRoLm1heChtaW4ueCwgTWF0aC5taW4obWF4LngsIHRoaXMueCkpOwogICAgdGhpcy55ID0gTWF0aC5tYXgobWluLnksIE1hdGgubWluKG1heC55LCB0aGlzLnkpKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjbGFtcFNjYWxhcihtaW5WYWwsIG1heFZhbCkgewogICAgdGhpcy54ID0gTWF0aC5tYXgobWluVmFsLCBNYXRoLm1pbihtYXhWYWwsIHRoaXMueCkpOwogICAgdGhpcy55ID0gTWF0aC5tYXgobWluVmFsLCBNYXRoLm1pbihtYXhWYWwsIHRoaXMueSkpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGNsYW1wTGVuZ3RoKG1pbiwgbWF4KSB7CiAgICBjb25zdCBsZW5ndGggPSB0aGlzLmxlbmd0aCgpOwogICAgcmV0dXJuIHRoaXMuZGl2aWRlU2NhbGFyKGxlbmd0aCB8fCAxKS5tdWx0aXBseVNjYWxhcihNYXRoLm1heChtaW4sIE1hdGgubWluKG1heCwgbGVuZ3RoKSkpOwogIH0KICBmbG9vcigpIHsKICAgIHRoaXMueCA9IE1hdGguZmxvb3IodGhpcy54KTsKICAgIHRoaXMueSA9IE1hdGguZmxvb3IodGhpcy55KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjZWlsKCkgewogICAgdGhpcy54ID0gTWF0aC5jZWlsKHRoaXMueCk7CiAgICB0aGlzLnkgPSBNYXRoLmNlaWwodGhpcy55KTsKICAgIHJldHVybiB0aGlzOwogIH0KICByb3VuZCgpIHsKICAgIHRoaXMueCA9IE1hdGgucm91bmQodGhpcy54KTsKICAgIHRoaXMueSA9IE1hdGgucm91bmQodGhpcy55KTsKICAgIHJldHVybiB0aGlzOwogIH0KICByb3VuZFRvWmVybygpIHsKICAgIHRoaXMueCA9IE1hdGgudHJ1bmModGhpcy54KTsKICAgIHRoaXMueSA9IE1hdGgudHJ1bmModGhpcy55KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBuZWdhdGUoKSB7CiAgICB0aGlzLnggPSAtdGhpcy54OwogICAgdGhpcy55ID0gLXRoaXMueTsKICAgIHJldHVybiB0aGlzOwogIH0KICBkb3QodikgewogICAgcmV0dXJuIHRoaXMueCAqIHYueCArIHRoaXMueSAqIHYueTsKICB9CiAgY3Jvc3ModikgewogICAgcmV0dXJuIHRoaXMueCAqIHYueSAtIHRoaXMueSAqIHYueDsKICB9CiAgbGVuZ3RoU3EoKSB7CiAgICByZXR1cm4gdGhpcy54ICogdGhpcy54ICsgdGhpcy55ICogdGhpcy55OwogIH0KICBsZW5ndGgoKSB7CiAgICByZXR1cm4gTWF0aC5zcXJ0KHRoaXMueCAqIHRoaXMueCArIHRoaXMueSAqIHRoaXMueSk7CiAgfQogIG1hbmhhdHRhbkxlbmd0aCgpIHsKICAgIHJldHVybiBNYXRoLmFicyh0aGlzLngpICsgTWF0aC5hYnModGhpcy55KTsKICB9CiAgbm9ybWFsaXplKCkgewogICAgcmV0dXJuIHRoaXMuZGl2aWRlU2NhbGFyKHRoaXMubGVuZ3RoKCkgfHwgMSk7CiAgfQogIGFuZ2xlKCkgewogICAgY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKC10aGlzLnksIC10aGlzLngpICsgTWF0aC5QSTsKICAgIHJldHVybiBhbmdsZTsKICB9CiAgYW5nbGVUbyh2KSB7CiAgICBjb25zdCBkZW5vbWluYXRvciA9IE1hdGguc3FydCh0aGlzLmxlbmd0aFNxKCkgKiB2Lmxlbmd0aFNxKCkpOwogICAgaWYgKGRlbm9taW5hdG9yID09PSAwKQogICAgICByZXR1cm4gTWF0aC5QSSAvIDI7CiAgICBjb25zdCB0aGV0YSA9IHRoaXMuZG90KHYpIC8gZGVub21pbmF0b3I7CiAgICByZXR1cm4gTWF0aC5hY29zKGNsYW1wKHRoZXRhLCAtMSwgMSkpOwogIH0KICBkaXN0YW5jZVRvKHYpIHsKICAgIHJldHVybiBNYXRoLnNxcnQodGhpcy5kaXN0YW5jZVRvU3F1YXJlZCh2KSk7CiAgfQogIGRpc3RhbmNlVG9TcXVhcmVkKHYpIHsKICAgIGNvbnN0IGR4ID0gdGhpcy54IC0gdi54LCBkeSA9IHRoaXMueSAtIHYueTsKICAgIHJldHVybiBkeCAqIGR4ICsgZHkgKiBkeTsKICB9CiAgbWFuaGF0dGFuRGlzdGFuY2VUbyh2KSB7CiAgICByZXR1cm4gTWF0aC5hYnModGhpcy54IC0gdi54KSArIE1hdGguYWJzKHRoaXMueSAtIHYueSk7CiAgfQogIHNldExlbmd0aChsZW5ndGgpIHsKICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKGxlbmd0aCk7CiAgfQogIGxlcnAodiwgYWxwaGEpIHsKICAgIHRoaXMueCArPSAodi54IC0gdGhpcy54KSAqIGFscGhhOwogICAgdGhpcy55ICs9ICh2LnkgLSB0aGlzLnkpICogYWxwaGE7CiAgICByZXR1cm4gdGhpczsKICB9CiAgbGVycFZlY3RvcnModjEsIHYyLCBhbHBoYSkgewogICAgdGhpcy54ID0gdjEueCArICh2Mi54IC0gdjEueCkgKiBhbHBoYTsKICAgIHRoaXMueSA9IHYxLnkgKyAodjIueSAtIHYxLnkpICogYWxwaGE7CiAgICByZXR1cm4gdGhpczsKICB9CiAgZXF1YWxzKHYpIHsKICAgIHJldHVybiB2LnggPT09IHRoaXMueCAmJiB2LnkgPT09IHRoaXMueTsKICB9CiAgZnJvbUFycmF5KGFycmF5LCBvZmZzZXQgPSAwKSB7CiAgICB0aGlzLnggPSBhcnJheVtvZmZzZXRdOwogICAgdGhpcy55ID0gYXJyYXlbb2Zmc2V0ICsgMV07CiAgICByZXR1cm4gdGhpczsKICB9CiAgdG9BcnJheShhcnJheSA9IFtdLCBvZmZzZXQgPSAwKSB7CiAgICBhcnJheVtvZmZzZXRdID0gdGhpcy54OwogICAgYXJyYXlbb2Zmc2V0ICsgMV0gPSB0aGlzLnk7CiAgICByZXR1cm4gYXJyYXk7CiAgfQogIGZyb21CdWZmZXJBdHRyaWJ1dGUoYXR0cmlidXRlLCBpbmRleCkgewogICAgdGhpcy54ID0gYXR0cmlidXRlLmdldFgoaW5kZXgpOwogICAgdGhpcy55ID0gYXR0cmlidXRlLmdldFkoaW5kZXgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJvdGF0ZUFyb3VuZChjZW50ZXIsIGFuZ2xlKSB7CiAgICBjb25zdCBjID0gTWF0aC5jb3MoYW5nbGUpLCBzID0gTWF0aC5zaW4oYW5nbGUpOwogICAgY29uc3QgeCA9IHRoaXMueCAtIGNlbnRlci54OwogICAgY29uc3QgeSA9IHRoaXMueSAtIGNlbnRlci55OwogICAgdGhpcy54ID0geCAqIGMgLSB5ICogcyArIGNlbnRlci54OwogICAgdGhpcy55ID0geCAqIHMgKyB5ICogYyArIGNlbnRlci55OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJhbmRvbSgpIHsKICAgIHRoaXMueCA9IE1hdGgucmFuZG9tKCk7CiAgICB0aGlzLnkgPSBNYXRoLnJhbmRvbSgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHlpZWxkIHRoaXMueDsKICAgIHlpZWxkIHRoaXMueTsKICB9Cn0KY2xhc3MgUXVhdGVybmlvbiB7CiAgY29uc3RydWN0b3IoeCA9IDAsIHkgPSAwLCB6ID0gMCwgdyA9IDEpIHsKICAgIHRoaXMuaXNRdWF0ZXJuaW9uID0gdHJ1ZTsKICAgIHRoaXMuX3ggPSB4OwogICAgdGhpcy5feSA9IHk7CiAgICB0aGlzLl96ID0gejsKICAgIHRoaXMuX3cgPSB3OwogIH0KICBzdGF0aWMgc2xlcnBGbGF0KGRzdCwgZHN0T2Zmc2V0LCBzcmMwLCBzcmNPZmZzZXQwLCBzcmMxLCBzcmNPZmZzZXQxLCB0KSB7CiAgICBsZXQgeDAgPSBzcmMwW3NyY09mZnNldDAgKyAwXSwgeTAgPSBzcmMwW3NyY09mZnNldDAgKyAxXSwgejAgPSBzcmMwW3NyY09mZnNldDAgKyAyXSwgdzAgPSBzcmMwW3NyY09mZnNldDAgKyAzXTsKICAgIGNvbnN0IHgxID0gc3JjMVtzcmNPZmZzZXQxICsgMF0sIHkxID0gc3JjMVtzcmNPZmZzZXQxICsgMV0sIHoxID0gc3JjMVtzcmNPZmZzZXQxICsgMl0sIHcxID0gc3JjMVtzcmNPZmZzZXQxICsgM107CiAgICBpZiAodCA9PT0gMCkgewogICAgICBkc3RbZHN0T2Zmc2V0ICsgMF0gPSB4MDsKICAgICAgZHN0W2RzdE9mZnNldCArIDFdID0geTA7CiAgICAgIGRzdFtkc3RPZmZzZXQgKyAyXSA9IHowOwogICAgICBkc3RbZHN0T2Zmc2V0ICsgM10gPSB3MDsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHQgPT09IDEpIHsKICAgICAgZHN0W2RzdE9mZnNldCArIDBdID0geDE7CiAgICAgIGRzdFtkc3RPZmZzZXQgKyAxXSA9IHkxOwogICAgICBkc3RbZHN0T2Zmc2V0ICsgMl0gPSB6MTsKICAgICAgZHN0W2RzdE9mZnNldCArIDNdID0gdzE7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh3MCAhPT0gdzEgfHwgeDAgIT09IHgxIHx8IHkwICE9PSB5MSB8fCB6MCAhPT0gejEpIHsKICAgICAgbGV0IHMgPSAxIC0gdDsKICAgICAgY29uc3QgY29zID0geDAgKiB4MSArIHkwICogeTEgKyB6MCAqIHoxICsgdzAgKiB3MSwgZGlyID0gY29zID49IDAgPyAxIDogLTEsIHNxclNpbiA9IDEgLSBjb3MgKiBjb3M7CiAgICAgIGlmIChzcXJTaW4gPiBOdW1iZXIuRVBTSUxPTikgewogICAgICAgIGNvbnN0IHNpbiA9IE1hdGguc3FydChzcXJTaW4pLCBsZW4gPSBNYXRoLmF0YW4yKHNpbiwgY29zICogZGlyKTsKICAgICAgICBzID0gTWF0aC5zaW4ocyAqIGxlbikgLyBzaW47CiAgICAgICAgdCA9IE1hdGguc2luKHQgKiBsZW4pIC8gc2luOwogICAgICB9CiAgICAgIGNvbnN0IHREaXIgPSB0ICogZGlyOwogICAgICB4MCA9IHgwICogcyArIHgxICogdERpcjsKICAgICAgeTAgPSB5MCAqIHMgKyB5MSAqIHREaXI7CiAgICAgIHowID0gejAgKiBzICsgejEgKiB0RGlyOwogICAgICB3MCA9IHcwICogcyArIHcxICogdERpcjsKICAgICAgaWYgKHMgPT09IDEgLSB0KSB7CiAgICAgICAgY29uc3QgZiA9IDEgLyBNYXRoLnNxcnQoeDAgKiB4MCArIHkwICogeTAgKyB6MCAqIHowICsgdzAgKiB3MCk7CiAgICAgICAgeDAgKj0gZjsKICAgICAgICB5MCAqPSBmOwogICAgICAgIHowICo9IGY7CiAgICAgICAgdzAgKj0gZjsKICAgICAgfQogICAgfQogICAgZHN0W2RzdE9mZnNldF0gPSB4MDsKICAgIGRzdFtkc3RPZmZzZXQgKyAxXSA9IHkwOwogICAgZHN0W2RzdE9mZnNldCArIDJdID0gejA7CiAgICBkc3RbZHN0T2Zmc2V0ICsgM10gPSB3MDsKICB9CiAgc3RhdGljIG11bHRpcGx5UXVhdGVybmlvbnNGbGF0KGRzdCwgZHN0T2Zmc2V0LCBzcmMwLCBzcmNPZmZzZXQwLCBzcmMxLCBzcmNPZmZzZXQxKSB7CiAgICBjb25zdCB4MCA9IHNyYzBbc3JjT2Zmc2V0MF07CiAgICBjb25zdCB5MCA9IHNyYzBbc3JjT2Zmc2V0MCArIDFdOwogICAgY29uc3QgejAgPSBzcmMwW3NyY09mZnNldDAgKyAyXTsKICAgIGNvbnN0IHcwID0gc3JjMFtzcmNPZmZzZXQwICsgM107CiAgICBjb25zdCB4MSA9IHNyYzFbc3JjT2Zmc2V0MV07CiAgICBjb25zdCB5MSA9IHNyYzFbc3JjT2Zmc2V0MSArIDFdOwogICAgY29uc3QgejEgPSBzcmMxW3NyY09mZnNldDEgKyAyXTsKICAgIGNvbnN0IHcxID0gc3JjMVtzcmNPZmZzZXQxICsgM107CiAgICBkc3RbZHN0T2Zmc2V0XSA9IHgwICogdzEgKyB3MCAqIHgxICsgeTAgKiB6MSAtIHowICogeTE7CiAgICBkc3RbZHN0T2Zmc2V0ICsgMV0gPSB5MCAqIHcxICsgdzAgKiB5MSArIHowICogeDEgLSB4MCAqIHoxOwogICAgZHN0W2RzdE9mZnNldCArIDJdID0gejAgKiB3MSArIHcwICogejEgKyB4MCAqIHkxIC0geTAgKiB4MTsKICAgIGRzdFtkc3RPZmZzZXQgKyAzXSA9IHcwICogdzEgLSB4MCAqIHgxIC0geTAgKiB5MSAtIHowICogejE7CiAgICByZXR1cm4gZHN0OwogIH0KICBnZXQgeCgpIHsKICAgIHJldHVybiB0aGlzLl94OwogIH0KICBzZXQgeCh2YWx1ZSkgewogICAgdGhpcy5feCA9IHZhbHVlOwogICAgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogIH0KICBnZXQgeSgpIHsKICAgIHJldHVybiB0aGlzLl95OwogIH0KICBzZXQgeSh2YWx1ZSkgewogICAgdGhpcy5feSA9IHZhbHVlOwogICAgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogIH0KICBnZXQgeigpIHsKICAgIHJldHVybiB0aGlzLl96OwogIH0KICBzZXQgeih2YWx1ZSkgewogICAgdGhpcy5feiA9IHZhbHVlOwogICAgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogIH0KICBnZXQgdygpIHsKICAgIHJldHVybiB0aGlzLl93OwogIH0KICBzZXQgdyh2YWx1ZSkgewogICAgdGhpcy5fdyA9IHZhbHVlOwogICAgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogIH0KICBzZXQoeCwgeSwgeiwgdykgewogICAgdGhpcy5feCA9IHg7CiAgICB0aGlzLl95ID0geTsKICAgIHRoaXMuX3ogPSB6OwogICAgdGhpcy5fdyA9IHc7CiAgICB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgY2xvbmUoKSB7CiAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5feCwgdGhpcy5feSwgdGhpcy5feiwgdGhpcy5fdyk7CiAgfQogIGNvcHkocXVhdGVybmlvbikgewogICAgdGhpcy5feCA9IHF1YXRlcm5pb24ueDsKICAgIHRoaXMuX3kgPSBxdWF0ZXJuaW9uLnk7CiAgICB0aGlzLl96ID0gcXVhdGVybmlvbi56OwogICAgdGhpcy5fdyA9IHF1YXRlcm5pb24udzsKICAgIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRGcm9tRXVsZXIoZXVsZXIsIHVwZGF0ZSkgewogICAgY29uc3QgeCA9IGV1bGVyLl94LCB5ID0gZXVsZXIuX3ksIHogPSBldWxlci5feiwgb3JkZXIgPSBldWxlci5fb3JkZXI7CiAgICBjb25zdCBjb3MgPSBNYXRoLmNvczsKICAgIGNvbnN0IHNpbiA9IE1hdGguc2luOwogICAgY29uc3QgYzEgPSBjb3MoeCAvIDIpOwogICAgY29uc3QgYzIgPSBjb3MoeSAvIDIpOwogICAgY29uc3QgYzMgPSBjb3MoeiAvIDIpOwogICAgY29uc3QgczEgPSBzaW4oeCAvIDIpOwogICAgY29uc3QgczIgPSBzaW4oeSAvIDIpOwogICAgY29uc3QgczMgPSBzaW4oeiAvIDIpOwogICAgc3dpdGNoIChvcmRlcikgewogICAgICBjYXNlICJYWVoiOgogICAgICAgIHRoaXMuX3ggPSBzMSAqIGMyICogYzMgKyBjMSAqIHMyICogczM7CiAgICAgICAgdGhpcy5feSA9IGMxICogczIgKiBjMyAtIHMxICogYzIgKiBzMzsKICAgICAgICB0aGlzLl96ID0gYzEgKiBjMiAqIHMzICsgczEgKiBzMiAqIGMzOwogICAgICAgIHRoaXMuX3cgPSBjMSAqIGMyICogYzMgLSBzMSAqIHMyICogczM7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIllYWiI6CiAgICAgICAgdGhpcy5feCA9IHMxICogYzIgKiBjMyArIGMxICogczIgKiBzMzsKICAgICAgICB0aGlzLl95ID0gYzEgKiBzMiAqIGMzIC0gczEgKiBjMiAqIHMzOwogICAgICAgIHRoaXMuX3ogPSBjMSAqIGMyICogczMgLSBzMSAqIHMyICogYzM7CiAgICAgICAgdGhpcy5fdyA9IGMxICogYzIgKiBjMyArIHMxICogczIgKiBzMzsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiWlhZIjoKICAgICAgICB0aGlzLl94ID0gczEgKiBjMiAqIGMzIC0gYzEgKiBzMiAqIHMzOwogICAgICAgIHRoaXMuX3kgPSBjMSAqIHMyICogYzMgKyBzMSAqIGMyICogczM7CiAgICAgICAgdGhpcy5feiA9IGMxICogYzIgKiBzMyArIHMxICogczIgKiBjMzsKICAgICAgICB0aGlzLl93ID0gYzEgKiBjMiAqIGMzIC0gczEgKiBzMiAqIHMzOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJaWVgiOgogICAgICAgIHRoaXMuX3ggPSBzMSAqIGMyICogYzMgLSBjMSAqIHMyICogczM7CiAgICAgICAgdGhpcy5feSA9IGMxICogczIgKiBjMyArIHMxICogYzIgKiBzMzsKICAgICAgICB0aGlzLl96ID0gYzEgKiBjMiAqIHMzIC0gczEgKiBzMiAqIGMzOwogICAgICAgIHRoaXMuX3cgPSBjMSAqIGMyICogYzMgKyBzMSAqIHMyICogczM7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIllaWCI6CiAgICAgICAgdGhpcy5feCA9IHMxICogYzIgKiBjMyArIGMxICogczIgKiBzMzsKICAgICAgICB0aGlzLl95ID0gYzEgKiBzMiAqIGMzICsgczEgKiBjMiAqIHMzOwogICAgICAgIHRoaXMuX3ogPSBjMSAqIGMyICogczMgLSBzMSAqIHMyICogYzM7CiAgICAgICAgdGhpcy5fdyA9IGMxICogYzIgKiBjMyAtIHMxICogczIgKiBzMzsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiWFpZIjoKICAgICAgICB0aGlzLl94ID0gczEgKiBjMiAqIGMzIC0gYzEgKiBzMiAqIHMzOwogICAgICAgIHRoaXMuX3kgPSBjMSAqIHMyICogYzMgLSBzMSAqIGMyICogczM7CiAgICAgICAgdGhpcy5feiA9IGMxICogYzIgKiBzMyArIHMxICogczIgKiBjMzsKICAgICAgICB0aGlzLl93ID0gYzEgKiBjMiAqIGMzICsgczEgKiBzMiAqIHMzOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIGNvbnNvbGUud2FybigiVEhSRUUuUXVhdGVybmlvbjogLnNldEZyb21FdWxlcigpIGVuY291bnRlcmVkIGFuIHVua25vd24gb3JkZXI6ICIgKyBvcmRlcik7CiAgICB9CiAgICBpZiAodXBkYXRlICE9PSBmYWxzZSkKICAgICAgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldEZyb21BeGlzQW5nbGUoYXhpcywgYW5nbGUpIHsKICAgIGNvbnN0IGhhbGZBbmdsZSA9IGFuZ2xlIC8gMiwgcyA9IE1hdGguc2luKGhhbGZBbmdsZSk7CiAgICB0aGlzLl94ID0gYXhpcy54ICogczsKICAgIHRoaXMuX3kgPSBheGlzLnkgKiBzOwogICAgdGhpcy5feiA9IGF4aXMueiAqIHM7CiAgICB0aGlzLl93ID0gTWF0aC5jb3MoaGFsZkFuZ2xlKTsKICAgIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRGcm9tUm90YXRpb25NYXRyaXgobSkgewogICAgY29uc3QgdGUgPSBtLmVsZW1lbnRzLCBtMTEgPSB0ZVswXSwgbTEyID0gdGVbNF0sIG0xMyA9IHRlWzhdLCBtMjEgPSB0ZVsxXSwgbTIyID0gdGVbNV0sIG0yMyA9IHRlWzldLCBtMzEgPSB0ZVsyXSwgbTMyID0gdGVbNl0sIG0zMyA9IHRlWzEwXSwgdHJhY2UgPSBtMTEgKyBtMjIgKyBtMzM7CiAgICBpZiAodHJhY2UgPiAwKSB7CiAgICAgIGNvbnN0IHMgPSAwLjUgLyBNYXRoLnNxcnQodHJhY2UgKyAxKTsKICAgICAgdGhpcy5fdyA9IDAuMjUgLyBzOwogICAgICB0aGlzLl94ID0gKG0zMiAtIG0yMykgKiBzOwogICAgICB0aGlzLl95ID0gKG0xMyAtIG0zMSkgKiBzOwogICAgICB0aGlzLl96ID0gKG0yMSAtIG0xMikgKiBzOwogICAgfSBlbHNlIGlmIChtMTEgPiBtMjIgJiYgbTExID4gbTMzKSB7CiAgICAgIGNvbnN0IHMgPSAyICogTWF0aC5zcXJ0KDEgKyBtMTEgLSBtMjIgLSBtMzMpOwogICAgICB0aGlzLl93ID0gKG0zMiAtIG0yMykgLyBzOwogICAgICB0aGlzLl94ID0gMC4yNSAqIHM7CiAgICAgIHRoaXMuX3kgPSAobTEyICsgbTIxKSAvIHM7CiAgICAgIHRoaXMuX3ogPSAobTEzICsgbTMxKSAvIHM7CiAgICB9IGVsc2UgaWYgKG0yMiA+IG0zMykgewogICAgICBjb25zdCBzID0gMiAqIE1hdGguc3FydCgxICsgbTIyIC0gbTExIC0gbTMzKTsKICAgICAgdGhpcy5fdyA9IChtMTMgLSBtMzEpIC8gczsKICAgICAgdGhpcy5feCA9IChtMTIgKyBtMjEpIC8gczsKICAgICAgdGhpcy5feSA9IDAuMjUgKiBzOwogICAgICB0aGlzLl96ID0gKG0yMyArIG0zMikgLyBzOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgcyA9IDIgKiBNYXRoLnNxcnQoMSArIG0zMyAtIG0xMSAtIG0yMik7CiAgICAgIHRoaXMuX3cgPSAobTIxIC0gbTEyKSAvIHM7CiAgICAgIHRoaXMuX3ggPSAobTEzICsgbTMxKSAvIHM7CiAgICAgIHRoaXMuX3kgPSAobTIzICsgbTMyKSAvIHM7CiAgICAgIHRoaXMuX3ogPSAwLjI1ICogczsKICAgIH0KICAgIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRGcm9tVW5pdFZlY3RvcnModkZyb20sIHZUbykgewogICAgbGV0IHIgPSB2RnJvbS5kb3QodlRvKSArIDE7CiAgICBpZiAociA8IE51bWJlci5FUFNJTE9OKSB7CiAgICAgIHIgPSAwOwogICAgICBpZiAoTWF0aC5hYnModkZyb20ueCkgPiBNYXRoLmFicyh2RnJvbS56KSkgewogICAgICAgIHRoaXMuX3ggPSAtdkZyb20ueTsKICAgICAgICB0aGlzLl95ID0gdkZyb20ueDsKICAgICAgICB0aGlzLl96ID0gMDsKICAgICAgICB0aGlzLl93ID0gcjsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl94ID0gMDsKICAgICAgICB0aGlzLl95ID0gLXZGcm9tLno7CiAgICAgICAgdGhpcy5feiA9IHZGcm9tLnk7CiAgICAgICAgdGhpcy5fdyA9IHI7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3ggPSB2RnJvbS55ICogdlRvLnogLSB2RnJvbS56ICogdlRvLnk7CiAgICAgIHRoaXMuX3kgPSB2RnJvbS56ICogdlRvLnggLSB2RnJvbS54ICogdlRvLno7CiAgICAgIHRoaXMuX3ogPSB2RnJvbS54ICogdlRvLnkgLSB2RnJvbS55ICogdlRvLng7CiAgICAgIHRoaXMuX3cgPSByOwogICAgfQogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplKCk7CiAgfQogIGFuZ2xlVG8ocSkgewogICAgcmV0dXJuIDIgKiBNYXRoLmFjb3MoTWF0aC5hYnMoY2xhbXAodGhpcy5kb3QocSksIC0xLCAxKSkpOwogIH0KICByb3RhdGVUb3dhcmRzKHEsIHN0ZXApIHsKICAgIGNvbnN0IGFuZ2xlID0gdGhpcy5hbmdsZVRvKHEpOwogICAgaWYgKGFuZ2xlID09PSAwKQogICAgICByZXR1cm4gdGhpczsKICAgIGNvbnN0IHQgPSBNYXRoLm1pbigxLCBzdGVwIC8gYW5nbGUpOwogICAgdGhpcy5zbGVycChxLCB0KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBpZGVudGl0eSgpIHsKICAgIHJldHVybiB0aGlzLnNldCgwLCAwLCAwLCAxKTsKICB9CiAgaW52ZXJ0KCkgewogICAgcmV0dXJuIHRoaXMuY29uanVnYXRlKCk7CiAgfQogIGNvbmp1Z2F0ZSgpIHsKICAgIHRoaXMuX3ggKj0gLTE7CiAgICB0aGlzLl95ICo9IC0xOwogICAgdGhpcy5feiAqPSAtMTsKICAgIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBkb3QodikgewogICAgcmV0dXJuIHRoaXMuX3ggKiB2Ll94ICsgdGhpcy5feSAqIHYuX3kgKyB0aGlzLl96ICogdi5feiArIHRoaXMuX3cgKiB2Ll93OwogIH0KICBsZW5ndGhTcSgpIHsKICAgIHJldHVybiB0aGlzLl94ICogdGhpcy5feCArIHRoaXMuX3kgKiB0aGlzLl95ICsgdGhpcy5feiAqIHRoaXMuX3ogKyB0aGlzLl93ICogdGhpcy5fdzsKICB9CiAgbGVuZ3RoKCkgewogICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLl94ICogdGhpcy5feCArIHRoaXMuX3kgKiB0aGlzLl95ICsgdGhpcy5feiAqIHRoaXMuX3ogKyB0aGlzLl93ICogdGhpcy5fdyk7CiAgfQogIG5vcm1hbGl6ZSgpIHsKICAgIGxldCBsID0gdGhpcy5sZW5ndGgoKTsKICAgIGlmIChsID09PSAwKSB7CiAgICAgIHRoaXMuX3ggPSAwOwogICAgICB0aGlzLl95ID0gMDsKICAgICAgdGhpcy5feiA9IDA7CiAgICAgIHRoaXMuX3cgPSAxOwogICAgfSBlbHNlIHsKICAgICAgbCA9IDEgLyBsOwogICAgICB0aGlzLl94ID0gdGhpcy5feCAqIGw7CiAgICAgIHRoaXMuX3kgPSB0aGlzLl95ICogbDsKICAgICAgdGhpcy5feiA9IHRoaXMuX3ogKiBsOwogICAgICB0aGlzLl93ID0gdGhpcy5fdyAqIGw7CiAgICB9CiAgICB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgbXVsdGlwbHkocSkgewogICAgcmV0dXJuIHRoaXMubXVsdGlwbHlRdWF0ZXJuaW9ucyh0aGlzLCBxKTsKICB9CiAgcHJlbXVsdGlwbHkocSkgewogICAgcmV0dXJuIHRoaXMubXVsdGlwbHlRdWF0ZXJuaW9ucyhxLCB0aGlzKTsKICB9CiAgbXVsdGlwbHlRdWF0ZXJuaW9ucyhhLCBiKSB7CiAgICBjb25zdCBxYXggPSBhLl94LCBxYXkgPSBhLl95LCBxYXogPSBhLl96LCBxYXcgPSBhLl93OwogICAgY29uc3QgcWJ4ID0gYi5feCwgcWJ5ID0gYi5feSwgcWJ6ID0gYi5feiwgcWJ3ID0gYi5fdzsKICAgIHRoaXMuX3ggPSBxYXggKiBxYncgKyBxYXcgKiBxYnggKyBxYXkgKiBxYnogLSBxYXogKiBxYnk7CiAgICB0aGlzLl95ID0gcWF5ICogcWJ3ICsgcWF3ICogcWJ5ICsgcWF6ICogcWJ4IC0gcWF4ICogcWJ6OwogICAgdGhpcy5feiA9IHFheiAqIHFidyArIHFhdyAqIHFieiArIHFheCAqIHFieSAtIHFheSAqIHFieDsKICAgIHRoaXMuX3cgPSBxYXcgKiBxYncgLSBxYXggKiBxYnggLSBxYXkgKiBxYnkgLSBxYXogKiBxYno7CiAgICB0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2xlcnAocWIsIHQpIHsKICAgIGlmICh0ID09PSAwKQogICAgICByZXR1cm4gdGhpczsKICAgIGlmICh0ID09PSAxKQogICAgICByZXR1cm4gdGhpcy5jb3B5KHFiKTsKICAgIGNvbnN0IHggPSB0aGlzLl94LCB5ID0gdGhpcy5feSwgeiA9IHRoaXMuX3osIHcgPSB0aGlzLl93OwogICAgbGV0IGNvc0hhbGZUaGV0YSA9IHcgKiBxYi5fdyArIHggKiBxYi5feCArIHkgKiBxYi5feSArIHogKiBxYi5fejsKICAgIGlmIChjb3NIYWxmVGhldGEgPCAwKSB7CiAgICAgIHRoaXMuX3cgPSAtcWIuX3c7CiAgICAgIHRoaXMuX3ggPSAtcWIuX3g7CiAgICAgIHRoaXMuX3kgPSAtcWIuX3k7CiAgICAgIHRoaXMuX3ogPSAtcWIuX3o7CiAgICAgIGNvc0hhbGZUaGV0YSA9IC1jb3NIYWxmVGhldGE7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmNvcHkocWIpOwogICAgfQogICAgaWYgKGNvc0hhbGZUaGV0YSA+PSAxKSB7CiAgICAgIHRoaXMuX3cgPSB3OwogICAgICB0aGlzLl94ID0geDsKICAgICAgdGhpcy5feSA9IHk7CiAgICAgIHRoaXMuX3ogPSB6OwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGNvbnN0IHNxclNpbkhhbGZUaGV0YSA9IDEgLSBjb3NIYWxmVGhldGEgKiBjb3NIYWxmVGhldGE7CiAgICBpZiAoc3FyU2luSGFsZlRoZXRhIDw9IE51bWJlci5FUFNJTE9OKSB7CiAgICAgIGNvbnN0IHMgPSAxIC0gdDsKICAgICAgdGhpcy5fdyA9IHMgKiB3ICsgdCAqIHRoaXMuX3c7CiAgICAgIHRoaXMuX3ggPSBzICogeCArIHQgKiB0aGlzLl94OwogICAgICB0aGlzLl95ID0gcyAqIHkgKyB0ICogdGhpcy5feTsKICAgICAgdGhpcy5feiA9IHMgKiB6ICsgdCAqIHRoaXMuX3o7CiAgICAgIHRoaXMubm9ybWFsaXplKCk7CiAgICAgIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBjb25zdCBzaW5IYWxmVGhldGEgPSBNYXRoLnNxcnQoc3FyU2luSGFsZlRoZXRhKTsKICAgIGNvbnN0IGhhbGZUaGV0YSA9IE1hdGguYXRhbjIoc2luSGFsZlRoZXRhLCBjb3NIYWxmVGhldGEpOwogICAgY29uc3QgcmF0aW9BID0gTWF0aC5zaW4oKDEgLSB0KSAqIGhhbGZUaGV0YSkgLyBzaW5IYWxmVGhldGEsIHJhdGlvQiA9IE1hdGguc2luKHQgKiBoYWxmVGhldGEpIC8gc2luSGFsZlRoZXRhOwogICAgdGhpcy5fdyA9IHcgKiByYXRpb0EgKyB0aGlzLl93ICogcmF0aW9COwogICAgdGhpcy5feCA9IHggKiByYXRpb0EgKyB0aGlzLl94ICogcmF0aW9COwogICAgdGhpcy5feSA9IHkgKiByYXRpb0EgKyB0aGlzLl95ICogcmF0aW9COwogICAgdGhpcy5feiA9IHogKiByYXRpb0EgKyB0aGlzLl96ICogcmF0aW9COwogICAgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNsZXJwUXVhdGVybmlvbnMocWEsIHFiLCB0KSB7CiAgICByZXR1cm4gdGhpcy5jb3B5KHFhKS5zbGVycChxYiwgdCk7CiAgfQogIHJhbmRvbSgpIHsKICAgIGNvbnN0IHUxID0gTWF0aC5yYW5kb20oKTsKICAgIGNvbnN0IHNxcnQxdTEgPSBNYXRoLnNxcnQoMSAtIHUxKTsKICAgIGNvbnN0IHNxcnR1MSA9IE1hdGguc3FydCh1MSk7CiAgICBjb25zdCB1MiA9IDIgKiBNYXRoLlBJICogTWF0aC5yYW5kb20oKTsKICAgIGNvbnN0IHUzID0gMiAqIE1hdGguUEkgKiBNYXRoLnJhbmRvbSgpOwogICAgcmV0dXJuIHRoaXMuc2V0KAogICAgICBzcXJ0MXUxICogTWF0aC5jb3ModTIpLAogICAgICBzcXJ0dTEgKiBNYXRoLnNpbih1MyksCiAgICAgIHNxcnR1MSAqIE1hdGguY29zKHUzKSwKICAgICAgc3FydDF1MSAqIE1hdGguc2luKHUyKQogICAgKTsKICB9CiAgZXF1YWxzKHF1YXRlcm5pb24pIHsKICAgIHJldHVybiBxdWF0ZXJuaW9uLl94ID09PSB0aGlzLl94ICYmIHF1YXRlcm5pb24uX3kgPT09IHRoaXMuX3kgJiYgcXVhdGVybmlvbi5feiA9PT0gdGhpcy5feiAmJiBxdWF0ZXJuaW9uLl93ID09PSB0aGlzLl93OwogIH0KICBmcm9tQXJyYXkoYXJyYXksIG9mZnNldCA9IDApIHsKICAgIHRoaXMuX3ggPSBhcnJheVtvZmZzZXRdOwogICAgdGhpcy5feSA9IGFycmF5W29mZnNldCArIDFdOwogICAgdGhpcy5feiA9IGFycmF5W29mZnNldCArIDJdOwogICAgdGhpcy5fdyA9IGFycmF5W29mZnNldCArIDNdOwogICAgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHRvQXJyYXkoYXJyYXkgPSBbXSwgb2Zmc2V0ID0gMCkgewogICAgYXJyYXlbb2Zmc2V0XSA9IHRoaXMuX3g7CiAgICBhcnJheVtvZmZzZXQgKyAxXSA9IHRoaXMuX3k7CiAgICBhcnJheVtvZmZzZXQgKyAyXSA9IHRoaXMuX3o7CiAgICBhcnJheVtvZmZzZXQgKyAzXSA9IHRoaXMuX3c7CiAgICByZXR1cm4gYXJyYXk7CiAgfQogIGZyb21CdWZmZXJBdHRyaWJ1dGUoYXR0cmlidXRlLCBpbmRleCkgewogICAgdGhpcy5feCA9IGF0dHJpYnV0ZS5nZXRYKGluZGV4KTsKICAgIHRoaXMuX3kgPSBhdHRyaWJ1dGUuZ2V0WShpbmRleCk7CiAgICB0aGlzLl96ID0gYXR0cmlidXRlLmdldFooaW5kZXgpOwogICAgdGhpcy5fdyA9IGF0dHJpYnV0ZS5nZXRXKGluZGV4KTsKICAgIHJldHVybiB0aGlzOwogIH0KICB0b0pTT04oKSB7CiAgICByZXR1cm4gdGhpcy50b0FycmF5KCk7CiAgfQogIF9vbkNoYW5nZShjYWxsYmFjaykgewogICAgdGhpcy5fb25DaGFuZ2VDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIF9vbkNoYW5nZUNhbGxiYWNrKCkgewogIH0KICAqW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICB5aWVsZCB0aGlzLl94OwogICAgeWllbGQgdGhpcy5feTsKICAgIHlpZWxkIHRoaXMuX3o7CiAgICB5aWVsZCB0aGlzLl93OwogIH0KfQpjbGFzcyBWZWN0b3IzIHsKICBjb25zdHJ1Y3Rvcih4ID0gMCwgeSA9IDAsIHogPSAwKSB7CiAgICBWZWN0b3IzLnByb3RvdHlwZS5pc1ZlY3RvcjMgPSB0cnVlOwogICAgdGhpcy54ID0geDsKICAgIHRoaXMueSA9IHk7CiAgICB0aGlzLnogPSB6OwogIH0KICBzZXQoeCwgeSwgeikgewogICAgaWYgKHogPT09IHZvaWQgMCkKICAgICAgeiA9IHRoaXMuejsKICAgIHRoaXMueCA9IHg7CiAgICB0aGlzLnkgPSB5OwogICAgdGhpcy56ID0gejsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRTY2FsYXIoc2NhbGFyKSB7CiAgICB0aGlzLnggPSBzY2FsYXI7CiAgICB0aGlzLnkgPSBzY2FsYXI7CiAgICB0aGlzLnogPSBzY2FsYXI7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0WCh4KSB7CiAgICB0aGlzLnggPSB4OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldFkoeSkgewogICAgdGhpcy55ID0geTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRaKHopIHsKICAgIHRoaXMueiA9IHo7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0Q29tcG9uZW50KGluZGV4LCB2YWx1ZSkgewogICAgc3dpdGNoIChpbmRleCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy54ID0gdmFsdWU7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLnkgPSB2YWx1ZTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMueiA9IHZhbHVlOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgb3V0IG9mIHJhbmdlOiAiICsgaW5kZXgpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIGdldENvbXBvbmVudChpbmRleCkgewogICAgc3dpdGNoIChpbmRleCkgewogICAgICBjYXNlIDA6CiAgICAgICAgcmV0dXJuIHRoaXMueDsKICAgICAgY2FzZSAxOgogICAgICAgIHJldHVybiB0aGlzLnk7CiAgICAgIGNhc2UgMjoKICAgICAgICByZXR1cm4gdGhpcy56OwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiaW5kZXggaXMgb3V0IG9mIHJhbmdlOiAiICsgaW5kZXgpOwogICAgfQogIH0KICBjbG9uZSgpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLngsIHRoaXMueSwgdGhpcy56KTsKICB9CiAgY29weSh2KSB7CiAgICB0aGlzLnggPSB2Lng7CiAgICB0aGlzLnkgPSB2Lnk7CiAgICB0aGlzLnogPSB2Lno7CiAgICByZXR1cm4gdGhpczsKICB9CiAgYWRkKHYpIHsKICAgIHRoaXMueCArPSB2Lng7CiAgICB0aGlzLnkgKz0gdi55OwogICAgdGhpcy56ICs9IHYuejsKICAgIHJldHVybiB0aGlzOwogIH0KICBhZGRTY2FsYXIocykgewogICAgdGhpcy54ICs9IHM7CiAgICB0aGlzLnkgKz0gczsKICAgIHRoaXMueiArPSBzOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFkZFZlY3RvcnMoYSwgYikgewogICAgdGhpcy54ID0gYS54ICsgYi54OwogICAgdGhpcy55ID0gYS55ICsgYi55OwogICAgdGhpcy56ID0gYS56ICsgYi56OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFkZFNjYWxlZFZlY3Rvcih2LCBzKSB7CiAgICB0aGlzLnggKz0gdi54ICogczsKICAgIHRoaXMueSArPSB2LnkgKiBzOwogICAgdGhpcy56ICs9IHYueiAqIHM7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc3ViKHYpIHsKICAgIHRoaXMueCAtPSB2Lng7CiAgICB0aGlzLnkgLT0gdi55OwogICAgdGhpcy56IC09IHYuejsKICAgIHJldHVybiB0aGlzOwogIH0KICBzdWJTY2FsYXIocykgewogICAgdGhpcy54IC09IHM7CiAgICB0aGlzLnkgLT0gczsKICAgIHRoaXMueiAtPSBzOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHN1YlZlY3RvcnMoYSwgYikgewogICAgdGhpcy54ID0gYS54IC0gYi54OwogICAgdGhpcy55ID0gYS55IC0gYi55OwogICAgdGhpcy56ID0gYS56IC0gYi56OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIG11bHRpcGx5KHYpIHsKICAgIHRoaXMueCAqPSB2Lng7CiAgICB0aGlzLnkgKj0gdi55OwogICAgdGhpcy56ICo9IHYuejsKICAgIHJldHVybiB0aGlzOwogIH0KICBtdWx0aXBseVNjYWxhcihzY2FsYXIpIHsKICAgIHRoaXMueCAqPSBzY2FsYXI7CiAgICB0aGlzLnkgKj0gc2NhbGFyOwogICAgdGhpcy56ICo9IHNjYWxhcjsKICAgIHJldHVybiB0aGlzOwogIH0KICBtdWx0aXBseVZlY3RvcnMoYSwgYikgewogICAgdGhpcy54ID0gYS54ICogYi54OwogICAgdGhpcy55ID0gYS55ICogYi55OwogICAgdGhpcy56ID0gYS56ICogYi56OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFwcGx5RXVsZXIoZXVsZXIpIHsKICAgIHJldHVybiB0aGlzLmFwcGx5UXVhdGVybmlvbihfcXVhdGVybmlvbiQ0LnNldEZyb21FdWxlcihldWxlcikpOwogIH0KICBhcHBseUF4aXNBbmdsZShheGlzLCBhbmdsZSkgewogICAgcmV0dXJuIHRoaXMuYXBwbHlRdWF0ZXJuaW9uKF9xdWF0ZXJuaW9uJDQuc2V0RnJvbUF4aXNBbmdsZShheGlzLCBhbmdsZSkpOwogIH0KICBhcHBseU1hdHJpeDMobSkgewogICAgY29uc3QgeCA9IHRoaXMueCwgeSA9IHRoaXMueSwgeiA9IHRoaXMuejsKICAgIGNvbnN0IGUgPSBtLmVsZW1lbnRzOwogICAgdGhpcy54ID0gZVswXSAqIHggKyBlWzNdICogeSArIGVbNl0gKiB6OwogICAgdGhpcy55ID0gZVsxXSAqIHggKyBlWzRdICogeSArIGVbN10gKiB6OwogICAgdGhpcy56ID0gZVsyXSAqIHggKyBlWzVdICogeSArIGVbOF0gKiB6OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFwcGx5Tm9ybWFsTWF0cml4KG0pIHsKICAgIHJldHVybiB0aGlzLmFwcGx5TWF0cml4MyhtKS5ub3JtYWxpemUoKTsKICB9CiAgYXBwbHlNYXRyaXg0KG0pIHsKICAgIGNvbnN0IHggPSB0aGlzLngsIHkgPSB0aGlzLnksIHogPSB0aGlzLno7CiAgICBjb25zdCBlID0gbS5lbGVtZW50czsKICAgIGNvbnN0IHcgPSAxIC8gKGVbM10gKiB4ICsgZVs3XSAqIHkgKyBlWzExXSAqIHogKyBlWzE1XSk7CiAgICB0aGlzLnggPSAoZVswXSAqIHggKyBlWzRdICogeSArIGVbOF0gKiB6ICsgZVsxMl0pICogdzsKICAgIHRoaXMueSA9IChlWzFdICogeCArIGVbNV0gKiB5ICsgZVs5XSAqIHogKyBlWzEzXSkgKiB3OwogICAgdGhpcy56ID0gKGVbMl0gKiB4ICsgZVs2XSAqIHkgKyBlWzEwXSAqIHogKyBlWzE0XSkgKiB3OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGFwcGx5UXVhdGVybmlvbihxKSB7CiAgICBjb25zdCB2eCA9IHRoaXMueCwgdnkgPSB0aGlzLnksIHZ6ID0gdGhpcy56OwogICAgY29uc3QgcXggPSBxLngsIHF5ID0gcS55LCBxeiA9IHEueiwgcXcgPSBxLnc7CiAgICBjb25zdCB0eCA9IDIgKiAocXkgKiB2eiAtIHF6ICogdnkpOwogICAgY29uc3QgdHkgPSAyICogKHF6ICogdnggLSBxeCAqIHZ6KTsKICAgIGNvbnN0IHR6ID0gMiAqIChxeCAqIHZ5IC0gcXkgKiB2eCk7CiAgICB0aGlzLnggPSB2eCArIHF3ICogdHggKyBxeSAqIHR6IC0gcXogKiB0eTsKICAgIHRoaXMueSA9IHZ5ICsgcXcgKiB0eSArIHF6ICogdHggLSBxeCAqIHR6OwogICAgdGhpcy56ID0gdnogKyBxdyAqIHR6ICsgcXggKiB0eSAtIHF5ICogdHg7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcHJvamVjdChjYW1lcmEpIHsKICAgIHJldHVybiB0aGlzLmFwcGx5TWF0cml4NChjYW1lcmEubWF0cml4V29ybGRJbnZlcnNlKS5hcHBseU1hdHJpeDQoY2FtZXJhLnByb2plY3Rpb25NYXRyaXgpOwogIH0KICB1bnByb2plY3QoY2FtZXJhKSB7CiAgICByZXR1cm4gdGhpcy5hcHBseU1hdHJpeDQoY2FtZXJhLnByb2plY3Rpb25NYXRyaXhJbnZlcnNlKS5hcHBseU1hdHJpeDQoY2FtZXJhLm1hdHJpeFdvcmxkKTsKICB9CiAgdHJhbnNmb3JtRGlyZWN0aW9uKG0pIHsKICAgIGNvbnN0IHggPSB0aGlzLngsIHkgPSB0aGlzLnksIHogPSB0aGlzLno7CiAgICBjb25zdCBlID0gbS5lbGVtZW50czsKICAgIHRoaXMueCA9IGVbMF0gKiB4ICsgZVs0XSAqIHkgKyBlWzhdICogejsKICAgIHRoaXMueSA9IGVbMV0gKiB4ICsgZVs1XSAqIHkgKyBlWzldICogejsKICAgIHRoaXMueiA9IGVbMl0gKiB4ICsgZVs2XSAqIHkgKyBlWzEwXSAqIHo7CiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemUoKTsKICB9CiAgZGl2aWRlKHYpIHsKICAgIHRoaXMueCAvPSB2Lng7CiAgICB0aGlzLnkgLz0gdi55OwogICAgdGhpcy56IC89IHYuejsKICAgIHJldHVybiB0aGlzOwogIH0KICBkaXZpZGVTY2FsYXIoc2NhbGFyKSB7CiAgICByZXR1cm4gdGhpcy5tdWx0aXBseVNjYWxhcigxIC8gc2NhbGFyKTsKICB9CiAgbWluKHYpIHsKICAgIHRoaXMueCA9IE1hdGgubWluKHRoaXMueCwgdi54KTsKICAgIHRoaXMueSA9IE1hdGgubWluKHRoaXMueSwgdi55KTsKICAgIHRoaXMueiA9IE1hdGgubWluKHRoaXMueiwgdi56KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBtYXgodikgewogICAgdGhpcy54ID0gTWF0aC5tYXgodGhpcy54LCB2LngpOwogICAgdGhpcy55ID0gTWF0aC5tYXgodGhpcy55LCB2LnkpOwogICAgdGhpcy56ID0gTWF0aC5tYXgodGhpcy56LCB2LnopOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGNsYW1wKG1pbiwgbWF4KSB7CiAgICB0aGlzLnggPSBNYXRoLm1heChtaW4ueCwgTWF0aC5taW4obWF4LngsIHRoaXMueCkpOwogICAgdGhpcy55ID0gTWF0aC5tYXgobWluLnksIE1hdGgubWluKG1heC55LCB0aGlzLnkpKTsKICAgIHRoaXMueiA9IE1hdGgubWF4KG1pbi56LCBNYXRoLm1pbihtYXgueiwgdGhpcy56KSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgY2xhbXBTY2FsYXIobWluVmFsLCBtYXhWYWwpIHsKICAgIHRoaXMueCA9IE1hdGgubWF4KG1pblZhbCwgTWF0aC5taW4obWF4VmFsLCB0aGlzLngpKTsKICAgIHRoaXMueSA9IE1hdGgubWF4KG1pblZhbCwgTWF0aC5taW4obWF4VmFsLCB0aGlzLnkpKTsKICAgIHRoaXMueiA9IE1hdGgubWF4KG1pblZhbCwgTWF0aC5taW4obWF4VmFsLCB0aGlzLnopKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjbGFtcExlbmd0aChtaW4sIG1heCkgewogICAgY29uc3QgbGVuZ3RoID0gdGhpcy5sZW5ndGgoKTsKICAgIHJldHVybiB0aGlzLmRpdmlkZVNjYWxhcihsZW5ndGggfHwgMSkubXVsdGlwbHlTY2FsYXIoTWF0aC5tYXgobWluLCBNYXRoLm1pbihtYXgsIGxlbmd0aCkpKTsKICB9CiAgZmxvb3IoKSB7CiAgICB0aGlzLnggPSBNYXRoLmZsb29yKHRoaXMueCk7CiAgICB0aGlzLnkgPSBNYXRoLmZsb29yKHRoaXMueSk7CiAgICB0aGlzLnogPSBNYXRoLmZsb29yKHRoaXMueik7CiAgICByZXR1cm4gdGhpczsKICB9CiAgY2VpbCgpIHsKICAgIHRoaXMueCA9IE1hdGguY2VpbCh0aGlzLngpOwogICAgdGhpcy55ID0gTWF0aC5jZWlsKHRoaXMueSk7CiAgICB0aGlzLnogPSBNYXRoLmNlaWwodGhpcy56KTsKICAgIHJldHVybiB0aGlzOwogIH0KICByb3VuZCgpIHsKICAgIHRoaXMueCA9IE1hdGgucm91bmQodGhpcy54KTsKICAgIHRoaXMueSA9IE1hdGgucm91bmQodGhpcy55KTsKICAgIHRoaXMueiA9IE1hdGgucm91bmQodGhpcy56KTsKICAgIHJldHVybiB0aGlzOwogIH0KICByb3VuZFRvWmVybygpIHsKICAgIHRoaXMueCA9IE1hdGgudHJ1bmModGhpcy54KTsKICAgIHRoaXMueSA9IE1hdGgudHJ1bmModGhpcy55KTsKICAgIHRoaXMueiA9IE1hdGgudHJ1bmModGhpcy56KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBuZWdhdGUoKSB7CiAgICB0aGlzLnggPSAtdGhpcy54OwogICAgdGhpcy55ID0gLXRoaXMueTsKICAgIHRoaXMueiA9IC10aGlzLno7CiAgICByZXR1cm4gdGhpczsKICB9CiAgZG90KHYpIHsKICAgIHJldHVybiB0aGlzLnggKiB2LnggKyB0aGlzLnkgKiB2LnkgKyB0aGlzLnogKiB2Lno7CiAgfQogIGxlbmd0aFNxKCkgewogICAgcmV0dXJuIHRoaXMueCAqIHRoaXMueCArIHRoaXMueSAqIHRoaXMueSArIHRoaXMueiAqIHRoaXMuejsKICB9CiAgbGVuZ3RoKCkgewogICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLnggKiB0aGlzLnggKyB0aGlzLnkgKiB0aGlzLnkgKyB0aGlzLnogKiB0aGlzLnopOwogIH0KICBtYW5oYXR0YW5MZW5ndGgoKSB7CiAgICByZXR1cm4gTWF0aC5hYnModGhpcy54KSArIE1hdGguYWJzKHRoaXMueSkgKyBNYXRoLmFicyh0aGlzLnopOwogIH0KICBub3JtYWxpemUoKSB7CiAgICByZXR1cm4gdGhpcy5kaXZpZGVTY2FsYXIodGhpcy5sZW5ndGgoKSB8fCAxKTsKICB9CiAgc2V0TGVuZ3RoKGxlbmd0aCkgewogICAgcmV0dXJuIHRoaXMubm9ybWFsaXplKCkubXVsdGlwbHlTY2FsYXIobGVuZ3RoKTsKICB9CiAgbGVycCh2LCBhbHBoYSkgewogICAgdGhpcy54ICs9ICh2LnggLSB0aGlzLngpICogYWxwaGE7CiAgICB0aGlzLnkgKz0gKHYueSAtIHRoaXMueSkgKiBhbHBoYTsKICAgIHRoaXMueiArPSAodi56IC0gdGhpcy56KSAqIGFscGhhOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGxlcnBWZWN0b3JzKHYxLCB2MiwgYWxwaGEpIHsKICAgIHRoaXMueCA9IHYxLnggKyAodjIueCAtIHYxLngpICogYWxwaGE7CiAgICB0aGlzLnkgPSB2MS55ICsgKHYyLnkgLSB2MS55KSAqIGFscGhhOwogICAgdGhpcy56ID0gdjEueiArICh2Mi56IC0gdjEueikgKiBhbHBoYTsKICAgIHJldHVybiB0aGlzOwogIH0KICBjcm9zcyh2KSB7CiAgICByZXR1cm4gdGhpcy5jcm9zc1ZlY3RvcnModGhpcywgdik7CiAgfQogIGNyb3NzVmVjdG9ycyhhLCBiKSB7CiAgICBjb25zdCBheCA9IGEueCwgYXkgPSBhLnksIGF6ID0gYS56OwogICAgY29uc3QgYnggPSBiLngsIGJ5ID0gYi55LCBieiA9IGIuejsKICAgIHRoaXMueCA9IGF5ICogYnogLSBheiAqIGJ5OwogICAgdGhpcy55ID0gYXogKiBieCAtIGF4ICogYno7CiAgICB0aGlzLnogPSBheCAqIGJ5IC0gYXkgKiBieDsKICAgIHJldHVybiB0aGlzOwogIH0KICBwcm9qZWN0T25WZWN0b3IodikgewogICAgY29uc3QgZGVub21pbmF0b3IgPSB2Lmxlbmd0aFNxKCk7CiAgICBpZiAoZGVub21pbmF0b3IgPT09IDApCiAgICAgIHJldHVybiB0aGlzLnNldCgwLCAwLCAwKTsKICAgIGNvbnN0IHNjYWxhciA9IHYuZG90KHRoaXMpIC8gZGVub21pbmF0b3I7CiAgICByZXR1cm4gdGhpcy5jb3B5KHYpLm11bHRpcGx5U2NhbGFyKHNjYWxhcik7CiAgfQogIHByb2plY3RPblBsYW5lKHBsYW5lTm9ybWFsKSB7CiAgICBfdmVjdG9yJGIuY29weSh0aGlzKS5wcm9qZWN0T25WZWN0b3IocGxhbmVOb3JtYWwpOwogICAgcmV0dXJuIHRoaXMuc3ViKF92ZWN0b3IkYik7CiAgfQogIHJlZmxlY3Qobm9ybWFsKSB7CiAgICByZXR1cm4gdGhpcy5zdWIoX3ZlY3RvciRiLmNvcHkobm9ybWFsKS5tdWx0aXBseVNjYWxhcigyICogdGhpcy5kb3Qobm9ybWFsKSkpOwogIH0KICBhbmdsZVRvKHYpIHsKICAgIGNvbnN0IGRlbm9taW5hdG9yID0gTWF0aC5zcXJ0KHRoaXMubGVuZ3RoU3EoKSAqIHYubGVuZ3RoU3EoKSk7CiAgICBpZiAoZGVub21pbmF0b3IgPT09IDApCiAgICAgIHJldHVybiBNYXRoLlBJIC8gMjsKICAgIGNvbnN0IHRoZXRhID0gdGhpcy5kb3QodikgLyBkZW5vbWluYXRvcjsKICAgIHJldHVybiBNYXRoLmFjb3MoY2xhbXAodGhldGEsIC0xLCAxKSk7CiAgfQogIGRpc3RhbmNlVG8odikgewogICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLmRpc3RhbmNlVG9TcXVhcmVkKHYpKTsKICB9CiAgZGlzdGFuY2VUb1NxdWFyZWQodikgewogICAgY29uc3QgZHggPSB0aGlzLnggLSB2LngsIGR5ID0gdGhpcy55IC0gdi55LCBkeiA9IHRoaXMueiAtIHYuejsKICAgIHJldHVybiBkeCAqIGR4ICsgZHkgKiBkeSArIGR6ICogZHo7CiAgfQogIG1hbmhhdHRhbkRpc3RhbmNlVG8odikgewogICAgcmV0dXJuIE1hdGguYWJzKHRoaXMueCAtIHYueCkgKyBNYXRoLmFicyh0aGlzLnkgLSB2LnkpICsgTWF0aC5hYnModGhpcy56IC0gdi56KTsKICB9CiAgc2V0RnJvbVNwaGVyaWNhbChzKSB7CiAgICByZXR1cm4gdGhpcy5zZXRGcm9tU3BoZXJpY2FsQ29vcmRzKHMucmFkaXVzLCBzLnBoaSwgcy50aGV0YSk7CiAgfQogIHNldEZyb21TcGhlcmljYWxDb29yZHMocmFkaXVzLCBwaGksIHRoZXRhKSB7CiAgICBjb25zdCBzaW5QaGlSYWRpdXMgPSBNYXRoLnNpbihwaGkpICogcmFkaXVzOwogICAgdGhpcy54ID0gc2luUGhpUmFkaXVzICogTWF0aC5zaW4odGhldGEpOwogICAgdGhpcy55ID0gTWF0aC5jb3MocGhpKSAqIHJhZGl1czsKICAgIHRoaXMueiA9IHNpblBoaVJhZGl1cyAqIE1hdGguY29zKHRoZXRhKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRGcm9tQ3lsaW5kcmljYWwoYykgewogICAgcmV0dXJuIHRoaXMuc2V0RnJvbUN5bGluZHJpY2FsQ29vcmRzKGMucmFkaXVzLCBjLnRoZXRhLCBjLnkpOwogIH0KICBzZXRGcm9tQ3lsaW5kcmljYWxDb29yZHMocmFkaXVzLCB0aGV0YSwgeSkgewogICAgdGhpcy54ID0gcmFkaXVzICogTWF0aC5zaW4odGhldGEpOwogICAgdGhpcy55ID0geTsKICAgIHRoaXMueiA9IHJhZGl1cyAqIE1hdGguY29zKHRoZXRhKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRGcm9tTWF0cml4UG9zaXRpb24obSkgewogICAgY29uc3QgZSA9IG0uZWxlbWVudHM7CiAgICB0aGlzLnggPSBlWzEyXTsKICAgIHRoaXMueSA9IGVbMTNdOwogICAgdGhpcy56ID0gZVsxNF07CiAgICByZXR1cm4gdGhpczsKICB9CiAgc2V0RnJvbU1hdHJpeFNjYWxlKG0pIHsKICAgIGNvbnN0IHN4ID0gdGhpcy5zZXRGcm9tTWF0cml4Q29sdW1uKG0sIDApLmxlbmd0aCgpOwogICAgY29uc3Qgc3kgPSB0aGlzLnNldEZyb21NYXRyaXhDb2x1bW4obSwgMSkubGVuZ3RoKCk7CiAgICBjb25zdCBzeiA9IHRoaXMuc2V0RnJvbU1hdHJpeENvbHVtbihtLCAyKS5sZW5ndGgoKTsKICAgIHRoaXMueCA9IHN4OwogICAgdGhpcy55ID0gc3k7CiAgICB0aGlzLnogPSBzejsKICAgIHJldHVybiB0aGlzOwogIH0KICBzZXRGcm9tTWF0cml4Q29sdW1uKG0sIGluZGV4KSB7CiAgICByZXR1cm4gdGhpcy5mcm9tQXJyYXkobS5lbGVtZW50cywgaW5kZXggKiA0KTsKICB9CiAgc2V0RnJvbU1hdHJpeDNDb2x1bW4obSwgaW5kZXgpIHsKICAgIHJldHVybiB0aGlzLmZyb21BcnJheShtLmVsZW1lbnRzLCBpbmRleCAqIDMpOwogIH0KICBzZXRGcm9tRXVsZXIoZSkgewogICAgdGhpcy54ID0gZS5feDsKICAgIHRoaXMueSA9IGUuX3k7CiAgICB0aGlzLnogPSBlLl96OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHNldEZyb21Db2xvcihjKSB7CiAgICB0aGlzLnggPSBjLnI7CiAgICB0aGlzLnkgPSBjLmc7CiAgICB0aGlzLnogPSBjLmI7CiAgICByZXR1cm4gdGhpczsKICB9CiAgZXF1YWxzKHYpIHsKICAgIHJldHVybiB2LnggPT09IHRoaXMueCAmJiB2LnkgPT09IHRoaXMueSAmJiB2LnogPT09IHRoaXMuejsKICB9CiAgZnJvbUFycmF5KGFycmF5LCBvZmZzZXQgPSAwKSB7CiAgICB0aGlzLnggPSBhcnJheVtvZmZzZXRdOwogICAgdGhpcy55ID0gYXJyYXlbb2Zmc2V0ICsgMV07CiAgICB0aGlzLnogPSBhcnJheVtvZmZzZXQgKyAyXTsKICAgIHJldHVybiB0aGlzOwogIH0KICB0b0FycmF5KGFycmF5ID0gW10sIG9mZnNldCA9IDApIHsKICAgIGFycmF5W29mZnNldF0gPSB0aGlzLng7CiAgICBhcnJheVtvZmZzZXQgKyAxXSA9IHRoaXMueTsKICAgIGFycmF5W29mZnNldCArIDJdID0gdGhpcy56OwogICAgcmV0dXJuIGFycmF5OwogIH0KICBmcm9tQnVmZmVyQXR0cmlidXRlKGF0dHJpYnV0ZSwgaW5kZXgpIHsKICAgIHRoaXMueCA9IGF0dHJpYnV0ZS5nZXRYKGluZGV4KTsKICAgIHRoaXMueSA9IGF0dHJpYnV0ZS5nZXRZKGluZGV4KTsKICAgIHRoaXMueiA9IGF0dHJpYnV0ZS5nZXRaKGluZGV4KTsKICAgIHJldHVybiB0aGlzOwogIH0KICByYW5kb20oKSB7CiAgICB0aGlzLnggPSBNYXRoLnJhbmRvbSgpOwogICAgdGhpcy55ID0gTWF0aC5yYW5kb20oKTsKICAgIHRoaXMueiA9IE1hdGgucmFuZG9tKCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmFuZG9tRGlyZWN0aW9uKCkgewogICAgY29uc3QgdSA9IChNYXRoLnJhbmRvbSgpIC0gMC41KSAqIDI7CiAgICBjb25zdCB0ID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgY29uc3QgZiA9IE1hdGguc3FydCgxIC0gdSAqKiAyKTsKICAgIHRoaXMueCA9IGYgKiBNYXRoLmNvcyh0KTsKICAgIHRoaXMueSA9IGYgKiBNYXRoLnNpbih0KTsKICAgIHRoaXMueiA9IHU7CiAgICByZXR1cm4gdGhpczsKICB9CiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgeWllbGQgdGhpcy54OwogICAgeWllbGQgdGhpcy55OwogICAgeWllbGQgdGhpcy56OwogIH0KfQpjb25zdCBfdmVjdG9yJGIgPSAvKiBAX19QVVJFX18gKi8gbmV3IFZlY3RvcjMoKTsKY29uc3QgX3F1YXRlcm5pb24kNCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgUXVhdGVybmlvbigpOwppZiAodHlwZW9mIF9fVEhSRUVfREVWVE9PTFNfXyAhPT0gInVuZGVmaW5lZCIpIHsKICBfX1RIUkVFX0RFVlRPT0xTX18uZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoInJlZ2lzdGVyIiwgeyBkZXRhaWw6IHsKICAgIHJldmlzaW9uOiBSRVZJU0lPTgogIH0gfSkpOwp9CmlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIikgewogIGlmICh3aW5kb3cuX19USFJFRV9fKSB7CiAgICBjb25zb2xlLndhcm4oIldBUk5JTkc6IE11bHRpcGxlIGluc3RhbmNlcyBvZiBUaHJlZS5qcyBiZWluZyBpbXBvcnRlZC4iKTsKICB9IGVsc2UgewogICAgd2luZG93Ll9fVEhSRUVfXyA9IFJFVklTSU9OOwogIH0KfQpmdW5jdGlvbiBkZWZpbmVkJDEodmFsdWUpIHsKICByZXR1cm4gdmFsdWUgIT09IHZvaWQgMCAmJiB2YWx1ZSAhPT0gbnVsbDsKfQpmdW5jdGlvbiBkZWZhdWx0VmFsdWUoYSwgYikgewogIGlmIChhICE9PSB2b2lkIDAgJiYgYSAhPT0gbnVsbCkgewogICAgcmV0dXJuIGE7CiAgfQogIHJldHVybiBiOwp9CmRlZmF1bHRWYWx1ZS5FTVBUWV9PQkpFQ1QgPSBPYmplY3QuZnJlZXplKHt9KTsKZnVuY3Rpb24gRGV2ZWxvcGVyRXJyb3IobWVzc2FnZSkgewogIHRoaXMubmFtZSA9ICJEZXZlbG9wZXJFcnJvciI7CiAgdGhpcy5tZXNzYWdlID0gbWVzc2FnZTsKICBsZXQgc3RhY2s7CiAgdHJ5IHsKICAgIHRocm93IG5ldyBFcnJvcigpOwogIH0gY2F0Y2ggKGUpIHsKICAgIHN0YWNrID0gZS5zdGFjazsKICB9CiAgdGhpcy5zdGFjayA9IHN0YWNrOwp9CmlmIChkZWZpbmVkJDEoT2JqZWN0LmNyZWF0ZSkpIHsKICBEZXZlbG9wZXJFcnJvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEVycm9yLnByb3RvdHlwZSk7CiAgRGV2ZWxvcGVyRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRGV2ZWxvcGVyRXJyb3I7Cn0KRGV2ZWxvcGVyRXJyb3IucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgbGV0IHN0ciA9IHRoaXMubmFtZSArICI6ICIgKyB0aGlzLm1lc3NhZ2U7CiAgaWYgKGRlZmluZWQkMSh0aGlzLnN0YWNrKSkgewogICAgc3RyICs9ICJcbiIgKyB0aGlzLnN0YWNrLnRvU3RyaW5nKCk7CiAgfQogIHJldHVybiBzdHI7Cn07CkRldmVsb3BlckVycm9yLnRocm93SW5zdGFudGlhdGlvbkVycm9yID0gZnVuY3Rpb24oKSB7CiAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKAogICAgIlRoaXMgZnVuY3Rpb24gZGVmaW5lcyBhbiBpbnRlcmZhY2UgYW5kIHNob3VsZCBub3QgYmUgY2FsbGVkIGRpcmVjdGx5LiIKICApOwp9Owpjb25zdCBfQ2VzaXVtTWF0aCA9IGNsYXNzIHsKICBzdGF0aWMgZXF1YWxzRXBzaWxvbihsZWZ0LCByaWdodCwgcmVsYXRpdmVFcHNpbG9uLCBhYnNvbHV0ZUVwc2lsb24pIHsKICAgIHJlbGF0aXZlRXBzaWxvbiA9IGRlZmF1bHRWYWx1ZShyZWxhdGl2ZUVwc2lsb24sIDApOwogICAgYWJzb2x1dGVFcHNpbG9uID0gZGVmYXVsdFZhbHVlKGFic29sdXRlRXBzaWxvbiwgcmVsYXRpdmVFcHNpbG9uKTsKICAgIGNvbnN0IGFic0RpZmYgPSBNYXRoLmFicyhsZWZ0IC0gcmlnaHQpOwogICAgcmV0dXJuIGFic0RpZmYgPD0gYWJzb2x1dGVFcHNpbG9uIHx8IGFic0RpZmYgPD0gcmVsYXRpdmVFcHNpbG9uICogTWF0aC5tYXgoTWF0aC5hYnMobGVmdCksIE1hdGguYWJzKHJpZ2h0KSk7CiAgfQogIHN0YXRpYyB0b1JhZGlhbnMoZGVnKSB7CiAgICByZXR1cm4gTWF0aFV0aWxzLmRlZ1RvUmFkKGRlZyk7CiAgfQogIHN0YXRpYyBjbGFtcCh2YWx1ZSwgbWluLCBtYXgpIHsKICAgIHJldHVybiB2YWx1ZSA8IG1pbiA/IG1pbiA6IHZhbHVlID4gbWF4ID8gbWF4IDogdmFsdWU7CiAgfQogIHN0YXRpYyBhY29zQ2xhbXBlZCh2YWx1ZSkgewogICAgcmV0dXJuIE1hdGguYWNvcyhfQ2VzaXVtTWF0aC5jbGFtcCh2YWx1ZSwgLTEsIDEpKTsKICB9CiAgc3RhdGljIGFzaW5DbGFtcGVkKHZhbHVlKSB7CiAgICByZXR1cm4gTWF0aC5hc2luKF9DZXNpdW1NYXRoLmNsYW1wKHZhbHVlLCAtMSwgMSkpOwogIH0KICBzdGF0aWMgc2lnbih2YWx1ZSkgewogICAgcmV0dXJuIE1hdGguc2lnbih2YWx1ZSk7CiAgfQogIHN0YXRpYyB6ZXJvVG9Ud29QaShhbmdsZSkgewogICAgaWYgKGFuZ2xlID49IDAgJiYgYW5nbGUgPD0gX0Nlc2l1bU1hdGguVFdPX1BJKSB7CiAgICAgIHJldHVybiBhbmdsZTsKICAgIH0KICAgIGNvbnN0IG1vZCA9IF9DZXNpdW1NYXRoLm1vZChhbmdsZSwgX0Nlc2l1bU1hdGguVFdPX1BJKTsKICAgIGlmIChNYXRoLmFicyhtb2QpIDwgX0Nlc2l1bU1hdGguRVBTSUxPTjE0ICYmIE1hdGguYWJzKGFuZ2xlKSA+IF9DZXNpdW1NYXRoLkVQU0lMT04xNCkgewogICAgICByZXR1cm4gX0Nlc2l1bU1hdGguVFdPX1BJOwogICAgfQogICAgcmV0dXJuIG1vZDsKICB9CiAgc3RhdGljIG1vZChtLCBuKSB7CiAgICBpZiAoX0Nlc2l1bU1hdGguc2lnbihtKSA9PT0gX0Nlc2l1bU1hdGguc2lnbihuKSAmJiBNYXRoLmFicyhtKSA8IE1hdGguYWJzKG4pKSB7CiAgICAgIHJldHVybiBtOwogICAgfQogICAgcmV0dXJuIChtICUgbiArIG4pICUgbjsKICB9CiAgc3RhdGljIGNob3JkTGVuZ3RoKGFuZ2xlLCByYWRpdXMpIHsKICAgIHJldHVybiAyICogcmFkaXVzICogTWF0aC5zaW4oYW5nbGUgKiAwLjUpOwogIH0KICBzdGF0aWMgbmVnYXRpdmVQaVRvUGkoYW5nbGUpIHsKICAgIGlmICghZGVmaW5lZCQxKGFuZ2xlKSkgewogICAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoImFuZ2xlIGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgaWYgKGFuZ2xlID49IC1fQ2VzaXVtTWF0aC5QSSAmJiBhbmdsZSA8PSBfQ2VzaXVtTWF0aC5QSSkgewogICAgICByZXR1cm4gYW5nbGU7CiAgICB9CiAgICByZXR1cm4gX0Nlc2l1bU1hdGguemVyb1RvVHdvUGkoYW5nbGUgKyBfQ2VzaXVtTWF0aC5QSSkgLSBfQ2VzaXVtTWF0aC5QSTsKICB9CiAgc3RhdGljIG5vcm1hbGl6ZSh2YWx1ZSwgcmFuZ2VNaW5pbXVtLCByYW5nZU1heGltdW0pIHsKICAgIHJhbmdlTWF4aW11bSA9IE1hdGgubWF4KHJhbmdlTWF4aW11bSAtIHJhbmdlTWluaW11bSwgMCk7CiAgICByZXR1cm4gcmFuZ2VNYXhpbXVtID09PSAwID8gMCA6IF9DZXNpdW1NYXRoLmNsYW1wKCh2YWx1ZSAtIHJhbmdlTWluaW11bSkgLyByYW5nZU1heGltdW0sIDAsIDEpOwogIH0KfTsKbGV0IENlc2l1bU1hdGggPSBfQ2VzaXVtTWF0aDsKX19wdWJsaWNGaWVsZChDZXNpdW1NYXRoLCAiRVBTSUxPTjEiLCAwLjEpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJFUFNJTE9OMiIsIDAuMDEpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJFUFNJTE9OMyIsIDFlLTMpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJFUFNJTE9ONCIsIDFlLTQpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJFUFNJTE9ONSIsIDFlLTUpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJFUFNJTE9ONiIsIDFlLTYpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJFUFNJTE9ONyIsIDFlLTcpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJFUFNJTE9OOCIsIDFlLTgpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJFUFNJTE9OOSIsIDFlLTkpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJFUFNJTE9OMTAiLCAxZS0xMCk7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIkVQU0lMT04xMSIsIDFlLTExKTsKX19wdWJsaWNGaWVsZChDZXNpdW1NYXRoLCAiRVBTSUxPTjEyIiwgMWUtMTIpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJFUFNJTE9OMTMiLCAxZS0xMyk7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIkVQU0lMT04xNCIsIDFlLTE0KTsKX19wdWJsaWNGaWVsZChDZXNpdW1NYXRoLCAiRVBTSUxPTjE1IiwgMWUtMTUpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJFUFNJTE9OMTYiLCAxZS0xNik7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIkVQU0lMT04xNyIsIDFlLTE3KTsKX19wdWJsaWNGaWVsZChDZXNpdW1NYXRoLCAiRVBTSUxPTjE4IiwgMWUtMTgpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJFUFNJTE9OMTkiLCAxZS0xOSk7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIkVQU0lMT04yMCIsIDFlLTIwKTsKX19wdWJsaWNGaWVsZChDZXNpdW1NYXRoLCAiRVBTSUxPTjIxIiwgMWUtMjEpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJQSSIsIE1hdGguUEkpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJPTkVfT1ZFUl9QSSIsIDEgLyBNYXRoLlBJKTsKX19wdWJsaWNGaWVsZChDZXNpdW1NYXRoLCAiUElfT1ZFUl9UV08iLCBNYXRoLlBJIC8gMik7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIlBJX09WRVJfVEhSRUUiLCBNYXRoLlBJIC8gMyk7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIlBJX09WRVJfRk9VUiIsIE1hdGguUEkgLyA0KTsKX19wdWJsaWNGaWVsZChDZXNpdW1NYXRoLCAiUElfT1ZFUl9TSVgiLCBNYXRoLlBJIC8gNik7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIlRIUkVFX1BJX09WRVJfVFdPIiwgMyAqIE1hdGguUEkgLyAyKTsKX19wdWJsaWNGaWVsZChDZXNpdW1NYXRoLCAiVFdPX1BJIiwgMiAqIE1hdGguUEkpOwpfX3B1YmxpY0ZpZWxkKENlc2l1bU1hdGgsICJPTkVfT1ZFUl9UV09fUEkiLCAxIC8gKDIgKiBNYXRoLlBJKSk7Cl9fcHVibGljRmllbGQoQ2VzaXVtTWF0aCwgIlJBRElBTlNfUEVSX0RFR1JFRSIsIE1hdGguUEkgLyAxODApOwpjbGFzcyBSZWN0YW5nbGUgewogIGNvbnN0cnVjdG9yKHdlc3QsIHNvdXRoLCBlYXN0LCBub3J0aCkgewogICAgdGhpcy53ZXN0ID0gd2VzdCB8fCAwOwogICAgdGhpcy5zb3V0aCA9IHNvdXRoIHx8IDA7CiAgICB0aGlzLmVhc3QgPSBlYXN0IHx8IDA7CiAgICB0aGlzLm5vcnRoID0gbm9ydGggfHwgMDsKICB9CiAgZ2V0IHdpZHRoKCkgewogICAgcmV0dXJuIFJlY3RhbmdsZS5jb21wdXRlV2lkdGgodGhpcyk7CiAgfQogIGdldCBoZWlnaHQoKSB7CiAgICByZXR1cm4gUmVjdGFuZ2xlLmNvbXB1dGVIZWlnaHQodGhpcyk7CiAgfQp9ClJlY3RhbmdsZS5mcm9tRGVncmVlcyA9IGZ1bmN0aW9uKHdlc3QsIHNvdXRoLCBlYXN0LCBub3J0aCwgcmVzdWx0KSB7CiAgd2VzdCA9IE1hdGhVdGlscy5kZWdUb1JhZChkZWZhdWx0VmFsdWUod2VzdCwgMCkpOwogIHNvdXRoID0gTWF0aFV0aWxzLmRlZ1RvUmFkKGRlZmF1bHRWYWx1ZShzb3V0aCwgMCkpOwogIGVhc3QgPSBNYXRoVXRpbHMuZGVnVG9SYWQoZGVmYXVsdFZhbHVlKGVhc3QsIDApKTsKICBub3J0aCA9IE1hdGhVdGlscy5kZWdUb1JhZChkZWZhdWx0VmFsdWUobm9ydGgsIDApKTsKICBpZiAoIWRlZmluZWQkMShyZXN1bHQpKSB7CiAgICByZXR1cm4gbmV3IFJlY3RhbmdsZSh3ZXN0LCBzb3V0aCwgZWFzdCwgbm9ydGgpOwogIH0KICByZXN1bHQud2VzdCA9IHdlc3Q7CiAgcmVzdWx0LnNvdXRoID0gc291dGg7CiAgcmVzdWx0LmVhc3QgPSBlYXN0OwogIHJlc3VsdC5ub3J0aCA9IG5vcnRoOwogIHJldHVybiByZXN1bHQ7Cn07ClJlY3RhbmdsZS5jb21wdXRlV2lkdGggPSBmdW5jdGlvbihyZWN0YW5nbGUpIHsKICBsZXQgZWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogIGNvbnN0IHdlc3QgPSByZWN0YW5nbGUud2VzdDsKICBpZiAoZWFzdCA8IHdlc3QpIHsKICAgIGVhc3QgKz0gQ2VzaXVtTWF0aC5UV09fUEk7CiAgfQogIHJldHVybiBlYXN0IC0gd2VzdDsKfTsKUmVjdGFuZ2xlLmNvbXB1dGVIZWlnaHQgPSBmdW5jdGlvbihyZWN0YW5nbGUpIHsKICByZXR1cm4gcmVjdGFuZ2xlLm5vcnRoIC0gcmVjdGFuZ2xlLnNvdXRoOwp9OwpSZWN0YW5nbGUuY2xvbmUgPSBmdW5jdGlvbihyZWN0YW5nbGUsIHJlc3VsdCkgewogIGlmICghZGVmaW5lZCQxKHJlY3RhbmdsZSkpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgIHJldHVybiBuZXcgUmVjdGFuZ2xlKHJlY3RhbmdsZS53ZXN0LCByZWN0YW5nbGUuc291dGgsIHJlY3RhbmdsZS5lYXN0LCByZWN0YW5nbGUubm9ydGgpOwogIH0KICByZXN1bHQud2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogIHJlc3VsdC5zb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICByZXN1bHQuZWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogIHJlc3VsdC5ub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICByZXR1cm4gcmVzdWx0Owp9OwpSZWN0YW5nbGUuc291dGh3ZXN0ID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICBpZiAoIWRlZmluZWQkMShyZXN1bHQpKSB7CiAgICByZXR1cm4gbmV3IFZlY3RvcjMocmVjdGFuZ2xlLndlc3QsIHJlY3RhbmdsZS5zb3V0aCk7CiAgfQogIHJlc3VsdC54ID0gcmVjdGFuZ2xlLndlc3Q7CiAgcmVzdWx0LnkgPSByZWN0YW5nbGUuc291dGg7CiAgcmVzdWx0LnogPSAwOwogIHJldHVybiByZXN1bHQ7Cn07ClJlY3RhbmdsZS5ub3J0aGVhc3QgPSBmdW5jdGlvbihyZWN0YW5nbGUsIHJlc3VsdCkgewogIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgIHJldHVybiBuZXcgVmVjdG9yMyhyZWN0YW5nbGUuZWFzdCwgcmVjdGFuZ2xlLm5vcnRoKTsKICB9CiAgcmVzdWx0LnggPSByZWN0YW5nbGUuZWFzdDsKICByZXN1bHQueSA9IHJlY3RhbmdsZS5ub3J0aDsKICByZXN1bHQueiA9IDA7CiAgcmV0dXJuIHJlc3VsdDsKfTsKUmVjdGFuZ2xlLnNvdXRoZWFzdCA9IGZ1bmN0aW9uKHJlY3RhbmdsZSwgcmVzdWx0KSB7CiAgaWYgKCFkZWZpbmVkJDEocmVzdWx0KSkgewogICAgcmV0dXJuIG5ldyBWZWN0b3IzKHJlY3RhbmdsZS5lYXN0LCByZWN0YW5nbGUuc291dGgpOwogIH0KICByZXN1bHQueCA9IHJlY3RhbmdsZS5lYXN0OwogIHJlc3VsdC55ID0gcmVjdGFuZ2xlLnNvdXRoOwogIHJlc3VsdC56ID0gMDsKICByZXR1cm4gcmVzdWx0Owp9OwpSZWN0YW5nbGUubm9ydGh3ZXN0ID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCByZXN1bHQpIHsKICBpZiAoIWRlZmluZWQkMShyZXN1bHQpKSB7CiAgICByZXR1cm4gbmV3IFZlY3RvcjMocmVjdGFuZ2xlLndlc3QsIHJlY3RhbmdsZS5ub3J0aCk7CiAgfQogIHJlc3VsdC54ID0gcmVjdGFuZ2xlLndlc3Q7CiAgcmVzdWx0LnkgPSByZWN0YW5nbGUubm9ydGg7CiAgcmVzdWx0LnogPSAwOwogIHJldHVybiByZXN1bHQ7Cn07ClJlY3RhbmdsZS5jZW50ZXIgPSBmdW5jdGlvbihyZWN0YW5nbGUsIHJlc3VsdCkgewogIGxldCBlYXN0ID0gcmVjdGFuZ2xlLmVhc3Q7CiAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogIGlmIChlYXN0IDwgd2VzdCkgewogICAgZWFzdCArPSBDZXNpdW1NYXRoLlRXT19QSTsKICB9CiAgY29uc3QgbG9uZ2l0dWRlID0gQ2VzaXVtTWF0aC5uZWdhdGl2ZVBpVG9QaSgod2VzdCArIGVhc3QpICogMC41KTsKICBjb25zdCBsYXRpdHVkZSA9IChyZWN0YW5nbGUuc291dGggKyByZWN0YW5nbGUubm9ydGgpICogMC41OwogIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgIHJldHVybiBuZXcgVmVjdG9yMyhsb25naXR1ZGUsIGxhdGl0dWRlKTsKICB9CiAgcmVzdWx0LnggPSBsb25naXR1ZGU7CiAgcmVzdWx0LnkgPSBsYXRpdHVkZTsKICByZXN1bHQueiA9IDA7CiAgcmV0dXJuIHJlc3VsdDsKfTsKUmVjdGFuZ2xlLmNvbnRhaW5zID0gZnVuY3Rpb24ocmVjdGFuZ2xlLCBjYXJ0b2dyYXBoaWMpIHsKICBsZXQgbG9uZ2l0dWRlID0gY2FydG9ncmFwaGljLng7CiAgY29uc3QgbGF0aXR1ZGUgPSBjYXJ0b2dyYXBoaWMueTsKICBjb25zdCB3ZXN0ID0gcmVjdGFuZ2xlLndlc3Q7CiAgbGV0IGVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICBpZiAoZWFzdCA8IHdlc3QpIHsKICAgIGVhc3QgKz0gQ2VzaXVtTWF0aC5UV09fUEk7CiAgICBpZiAobG9uZ2l0dWRlIDwgMCkgewogICAgICBsb25naXR1ZGUgKz0gQ2VzaXVtTWF0aC5UV09fUEk7CiAgICB9CiAgfQogIHJldHVybiAobG9uZ2l0dWRlID4gd2VzdCB8fCBDZXNpdW1NYXRoLmVxdWFsc0Vwc2lsb24obG9uZ2l0dWRlLCB3ZXN0LCBDZXNpdW1NYXRoLkVQU0lMT04xNCkpICYmIChsb25naXR1ZGUgPCBlYXN0IHx8IENlc2l1bU1hdGguZXF1YWxzRXBzaWxvbihsb25naXR1ZGUsIGVhc3QsIENlc2l1bU1hdGguRVBTSUxPTjE0KSkgJiYgbGF0aXR1ZGUgPj0gcmVjdGFuZ2xlLnNvdXRoICYmIGxhdGl0dWRlIDw9IHJlY3RhbmdsZS5ub3J0aDsKfTsKY29uc3QgbWF4UEkgPSBNYXRoLlBJICsgMWUtNTsKY29uc3QgbWluUEkgPSAtTWF0aC5QSSAtIDFlLTU7CmNvbnN0IG1heFBJT3ZlclR3byA9IENlc2l1bU1hdGguUElfT1ZFUl9UV08gKyAxZS01Owpjb25zdCBtaW5QSU92ZXJUd28gPSAtQ2VzaXVtTWF0aC5QSV9PVkVSX1RXTyAtIDFlLTU7ClJlY3RhbmdsZS5mcm9tQm94ID0gZnVuY3Rpb24oYm94LCByZXN1bHQsIHJlc3RyaWN0ID0gZmFsc2UpIHsKICBjb25zdCBtaW4gPSBib3gubWluOwogIGNvbnN0IG1heCA9IGJveC5tYXg7CiAgbGV0IG1pbkxvbiA9IG1pbi54IC8gMTgwICogTWF0aC5QSTsKICBsZXQgbWluTGF0ID0gbWluLnkgLyAxODAgKiBNYXRoLlBJOwogIGxldCBtYXhMb24gPSBtYXgueCAvIDE4MCAqIE1hdGguUEk7CiAgbGV0IG1heExhdCA9IG1heC55IC8gMTgwICogTWF0aC5QSTsKICBpZiAocmVzdHJpY3QpIHsKICAgIGlmIChtaW5Mb24gPCBtaW5QSSkgewogICAgICBtaW5Mb24gPSAtTWF0aC5QSTsKICAgIH0KICAgIGlmIChtaW5Mb24gPiBtYXhQSSkgewogICAgICBtaW5Mb24gPSBNYXRoLlBJOwogICAgfQogICAgaWYgKG1pbkxhdCA8IG1pblBJT3ZlclR3bykgewogICAgICBtaW5MYXQgPSAtQ2VzaXVtTWF0aC5QSV9PVkVSX1RXTzsKICAgIH0KICAgIGlmIChtaW5MYXQgPiBtYXhQSU92ZXJUd28pIHsKICAgICAgbWluTGF0ID0gQ2VzaXVtTWF0aC5QSV9PVkVSX1RXTzsKICAgIH0KICAgIGlmIChtYXhMb24gPiBtYXhQSSkgewogICAgICBtYXhMb24gPSBNYXRoLlBJOwogICAgfQogICAgaWYgKG1heExvbiA8IG1pblBJKSB7CiAgICAgIG1heExvbiA9IC1NYXRoLlBJOwogICAgfQogICAgaWYgKG1heExhdCA+IG1heFBJT3ZlclR3bykgewogICAgICBtYXhMYXQgPSBDZXNpdW1NYXRoLlBJX09WRVJfVFdPOwogICAgfQogICAgaWYgKG1heExhdCA8IG1pblBJT3ZlclR3bykgewogICAgICBtYXhMYXQgPSAtQ2VzaXVtTWF0aC5QSV9PVkVSX1RXTzsKICAgIH0KICB9CiAgaWYgKCFkZWZpbmVkJDEocmVzdWx0KSkgewogICAgcmV0dXJuIG5ldyBSZWN0YW5nbGUobWluTG9uLCBtaW5MYXQsIG1heExvbiwgbWF4TGF0KTsKICB9CiAgcmVzdWx0Lndlc3QgPSBtaW5Mb247CiAgcmVzdWx0LnNvdXRoID0gbWluTGF0OwogIHJlc3VsdC5lYXN0ID0gbWF4TG9uOwogIHJlc3VsdC5ub3J0aCA9IG1heExhdDsKICByZXR1cm4gcmVzdWx0Owp9OwpSZWN0YW5nbGUuTUFYX1ZBTFVFID0gT2JqZWN0LmZyZWV6ZSgKICBuZXcgUmVjdGFuZ2xlKAogICAgLU1hdGguUEksCiAgICAtQ2VzaXVtTWF0aC5QSV9PVkVSX1RXTywKICAgIE1hdGguUEksCiAgICBDZXNpdW1NYXRoLlBJX09WRVJfVFdPCiAgKQopOwpjb25zdCBzY2FsZVRvR2VvZGV0aWNTdXJmYWNlSW50ZXJzZWN0aW9uID0gbmV3IFZlY3RvcjMoKTsKY29uc3Qgc2NhbGVUb0dlb2RldGljU3VyZmFjZUdyYWRpZW50ID0gbmV3IFZlY3RvcjMoKTsKZnVuY3Rpb24gc2NhbGVUb0dlb2RldGljU3VyZmFjZShjYXJ0ZXNpYW4sIG9uZU92ZXJSYWRpaSwgb25lT3ZlclJhZGlpU3F1YXJlZCwgY2VudGVyVG9sZXJhbmNlU3F1YXJlZCwgcmVzdWx0KSB7CiAgY29uc3QgcG9zaXRpb25YID0gY2FydGVzaWFuLng7CiAgY29uc3QgcG9zaXRpb25ZID0gY2FydGVzaWFuLnk7CiAgY29uc3QgcG9zaXRpb25aID0gY2FydGVzaWFuLno7CiAgY29uc3Qgb25lT3ZlclJhZGlpWCA9IG9uZU92ZXJSYWRpaS54OwogIGNvbnN0IG9uZU92ZXJSYWRpaVkgPSBvbmVPdmVyUmFkaWkueTsKICBjb25zdCBvbmVPdmVyUmFkaWlaID0gb25lT3ZlclJhZGlpLno7CiAgY29uc3QgeDIgPSBwb3NpdGlvblggKiBwb3NpdGlvblggKiBvbmVPdmVyUmFkaWlYICogb25lT3ZlclJhZGlpWDsKICBjb25zdCB5MiA9IHBvc2l0aW9uWSAqIHBvc2l0aW9uWSAqIG9uZU92ZXJSYWRpaVkgKiBvbmVPdmVyUmFkaWlZOwogIGNvbnN0IHoyID0gcG9zaXRpb25aICogcG9zaXRpb25aICogb25lT3ZlclJhZGlpWiAqIG9uZU92ZXJSYWRpaVo7CiAgY29uc3Qgc3F1YXJlZE5vcm0gPSB4MiArIHkyICsgejI7CiAgY29uc3QgcmF0aW8gPSBNYXRoLnNxcnQoMSAvIHNxdWFyZWROb3JtKTsKICBjb25zdCBpbnRlcnNlY3Rpb24gPSBzY2FsZVRvR2VvZGV0aWNTdXJmYWNlSW50ZXJzZWN0aW9uLmNvcHkoY2FydGVzaWFuKS5tdWx0aXBseVNjYWxhcihyYXRpbyk7CiAgaWYgKHNxdWFyZWROb3JtIDwgY2VudGVyVG9sZXJhbmNlU3F1YXJlZCkgewogICAgaWYgKCFyZXN1bHQpIHsKICAgICAgcmVzdWx0ID0gbmV3IFZlY3RvcjMoKTsKICAgIH0KICAgIHJldHVybiAhaXNGaW5pdGUocmF0aW8pID8gdm9pZCAwIDogcmVzdWx0LmNvcHkoaW50ZXJzZWN0aW9uKTsKICB9CiAgY29uc3Qgb25lT3ZlclJhZGlpU3F1YXJlZFggPSBvbmVPdmVyUmFkaWlTcXVhcmVkLng7CiAgY29uc3Qgb25lT3ZlclJhZGlpU3F1YXJlZFkgPSBvbmVPdmVyUmFkaWlTcXVhcmVkLnk7CiAgY29uc3Qgb25lT3ZlclJhZGlpU3F1YXJlZFogPSBvbmVPdmVyUmFkaWlTcXVhcmVkLno7CiAgY29uc3QgZ3JhZGllbnQgPSBzY2FsZVRvR2VvZGV0aWNTdXJmYWNlR3JhZGllbnQ7CiAgZ3JhZGllbnQueCA9IGludGVyc2VjdGlvbi54ICogb25lT3ZlclJhZGlpU3F1YXJlZFggKiAyOwogIGdyYWRpZW50LnkgPSBpbnRlcnNlY3Rpb24ueSAqIG9uZU92ZXJSYWRpaVNxdWFyZWRZICogMjsKICBncmFkaWVudC56ID0gaW50ZXJzZWN0aW9uLnogKiBvbmVPdmVyUmFkaWlTcXVhcmVkWiAqIDI7CiAgbGV0IGxhbWJkYSA9ICgxIC0gcmF0aW8pICogY2FydGVzaWFuLmxlbmd0aCgpIC8gKDAuNSAqIGdyYWRpZW50Lmxlbmd0aCgpKTsKICBsZXQgY29ycmVjdGlvbiA9IDA7CiAgbGV0IGZ1bmM7CiAgbGV0IGRlbm9taW5hdG9yOwogIGxldCB4TXVsdGlwbGllcjsKICBsZXQgeU11bHRpcGxpZXI7CiAgbGV0IHpNdWx0aXBsaWVyOwogIGxldCB4TXVsdGlwbGllcjI7CiAgbGV0IHlNdWx0aXBsaWVyMjsKICBsZXQgek11bHRpcGxpZXIyOwogIGxldCB4TXVsdGlwbGllcjM7CiAgbGV0IHlNdWx0aXBsaWVyMzsKICBsZXQgek11bHRpcGxpZXIzOwogIGRvIHsKICAgIGxhbWJkYSAtPSBjb3JyZWN0aW9uOwogICAgeE11bHRpcGxpZXIgPSAxIC8gKDEgKyBsYW1iZGEgKiBvbmVPdmVyUmFkaWlTcXVhcmVkWCk7CiAgICB5TXVsdGlwbGllciA9IDEgLyAoMSArIGxhbWJkYSAqIG9uZU92ZXJSYWRpaVNxdWFyZWRZKTsKICAgIHpNdWx0aXBsaWVyID0gMSAvICgxICsgbGFtYmRhICogb25lT3ZlclJhZGlpU3F1YXJlZFopOwogICAgeE11bHRpcGxpZXIyID0geE11bHRpcGxpZXIgKiB4TXVsdGlwbGllcjsKICAgIHlNdWx0aXBsaWVyMiA9IHlNdWx0aXBsaWVyICogeU11bHRpcGxpZXI7CiAgICB6TXVsdGlwbGllcjIgPSB6TXVsdGlwbGllciAqIHpNdWx0aXBsaWVyOwogICAgeE11bHRpcGxpZXIzID0geE11bHRpcGxpZXIyICogeE11bHRpcGxpZXI7CiAgICB5TXVsdGlwbGllcjMgPSB5TXVsdGlwbGllcjIgKiB5TXVsdGlwbGllcjsKICAgIHpNdWx0aXBsaWVyMyA9IHpNdWx0aXBsaWVyMiAqIHpNdWx0aXBsaWVyOwogICAgZnVuYyA9IHgyICogeE11bHRpcGxpZXIyICsgeTIgKiB5TXVsdGlwbGllcjIgKyB6MiAqIHpNdWx0aXBsaWVyMiAtIDE7CiAgICBkZW5vbWluYXRvciA9IHgyICogeE11bHRpcGxpZXIzICogb25lT3ZlclJhZGlpU3F1YXJlZFggKyB5MiAqIHlNdWx0aXBsaWVyMyAqIG9uZU92ZXJSYWRpaVNxdWFyZWRZICsgejIgKiB6TXVsdGlwbGllcjMgKiBvbmVPdmVyUmFkaWlTcXVhcmVkWjsKICAgIGxldCBkZXJpdmF0aXZlID0gLTIgKiBkZW5vbWluYXRvcjsKICAgIGNvcnJlY3Rpb24gPSBmdW5jIC8gZGVyaXZhdGl2ZTsKICB9IHdoaWxlIChNYXRoLmFicyhmdW5jKSA+IDFlLTEyKTsKICBpZiAoIXJlc3VsdCkgewogICAgcmV0dXJuIG5ldyBWZWN0b3IzKAogICAgICBwb3NpdGlvblggKiB4TXVsdGlwbGllciwKICAgICAgcG9zaXRpb25ZICogeU11bHRpcGxpZXIsCiAgICAgIHBvc2l0aW9uWiAqIHpNdWx0aXBsaWVyCiAgICApOwogIH0KICByZXN1bHQueCA9IHBvc2l0aW9uWCAqIHhNdWx0aXBsaWVyOwogIHJlc3VsdC55ID0gcG9zaXRpb25ZICogeU11bHRpcGxpZXI7CiAgcmVzdWx0LnogPSBwb3NpdGlvblogKiB6TXVsdGlwbGllcjsKICByZXR1cm4gcmVzdWx0Owp9CmNvbnN0IG1vc3RPcnRob2dvbmFsQXhpc1NjcmF0Y2ggPSBuZXcgVmVjdG9yMygpOwpsZXQgc2NyYXRjaE4gPSBuZXcgVmVjdG9yMygpOwpsZXQgc2NyYXRjaEsgPSBuZXcgVmVjdG9yMygpOwpjb25zdCB3Z3M4NFJhZGlpU3F1YXJlZCA9IG5ldyBWZWN0b3IzKAogIDYzNzgxMzcgKiA2Mzc4MTM3LAogIDYzNzgxMzcgKiA2Mzc4MTM3LAogIDYzNTY3NTIzMTQyNDUxNzllLTkgKiA2MzU2NzUyMzE0MjQ1MTc5ZS05Cik7CmNvbnN0IGFuZ2xlQmV0d2VlblNjcmF0Y2ggPSBuZXcgVmVjdG9yMygpOwpjb25zdCBhbmdsZUJldHdlZW5TY3JhdGNoMiA9IG5ldyBWZWN0b3IzKCk7CmNvbnN0IF9DYXJ0ZXNpYW4zID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKCkgewogICAgX19wdWJsaWNGaWVsZCh0aGlzLCAiQ09MVU1OMFJPVzAiLCAwKTsKICAgIF9fcHVibGljRmllbGQodGhpcywgIkNPTFVNTjBST1cxIiwgMSk7CiAgICBfX3B1YmxpY0ZpZWxkKHRoaXMsICJDT0xVTU4wUk9XMiIsIDIpOwogICAgX19wdWJsaWNGaWVsZCh0aGlzLCAiQ09MVU1OMVJPVzAiLCAzKTsKICAgIF9fcHVibGljRmllbGQodGhpcywgIkNPTFVNTjFST1cxIiwgNCk7CiAgICBfX3B1YmxpY0ZpZWxkKHRoaXMsICJDT0xVTU4xUk9XMiIsIDUpOwogICAgX19wdWJsaWNGaWVsZCh0aGlzLCAiQ09MVU1OMlJPVzAiLCA2KTsKICAgIF9fcHVibGljRmllbGQodGhpcywgIkNPTFVNTjJST1cxIiwgNyk7CiAgICBfX3B1YmxpY0ZpZWxkKHRoaXMsICJDT0xVTU4yUk9XMiIsIDgpOwogIH0KICBzdGF0aWMgY2xvbmUodjEsIHYyKSB7CiAgICBpZiAoIXYxKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICB2Mi5jb3B5KHYxKTsKICAgIHJldHVybiB2MjsKICB9CiAgc3RhdGljIGVxdWFscyh2MSwgdjIpIHsKICAgIGlmIChkZWZpbmVkJDEodjEpICYmIGRlZmluZWQkMSh2MikpIHsKICAgICAgcmV0dXJuIHYxLmVxdWFscyh2Mik7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHN0YXRpYyBub3JtYWxpemUodjEsIHYyKSB7CiAgICBpZiAodjEgPT09IHYyKSB7CiAgICAgIHYxLm5vcm1hbGl6ZSgpOwogICAgICByZXR1cm4gdjE7CiAgICB9CiAgICB2Mi5jb3B5KHYxKTsKICAgIHYyLm5vcm1hbGl6ZSgpOwogICAgcmV0dXJuIHYyOwogIH0KICBzdGF0aWMgYWRkKHYxLCB2MiwgcmVzdWx0KSB7CiAgICBpZiAoIXJlc3VsdCkgewogICAgICByZXN1bHQgPSBuZXcgVmVjdG9yMygpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdC5hZGRWZWN0b3JzKHYxLCB2Mik7CiAgfQogIHN0YXRpYyBkb3QodjEsIHYyKSB7CiAgICByZXR1cm4gdjEuZG90KHYyKTsKICB9CiAgc3RhdGljIGNyb3NzKHYxLCB2MiwgcmVzdWx0KSB7CiAgICBpZiAoIXJlc3VsdCkgewogICAgICByZXN1bHQgPSBuZXcgVmVjdG9yMygpOwogICAgfQogICAgcmVzdWx0LmNyb3NzVmVjdG9ycyh2MSwgdjIpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc3RhdGljIG1hZ25pdHVkZVNxdWFyZWQodjEpIHsKICAgIHJldHVybiB2MS5sZW5ndGhTcSgpOwogIH0KICBzdGF0aWMgbXVsdGlwbHlCeVNjYWxhcih2MSwgc2NhbGFyLCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3IzKCk7CiAgICB9CiAgICByZXN1bHQuY29weSh2MSkubXVsdGlwbHlTY2FsYXIoc2NhbGFyKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHN0YXRpYyBkaXZpZGVCeVNjYWxhcih2MSwgc2NhbGFyLCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3IzKCk7CiAgICB9CiAgICByZXN1bHQueCA9IHYxLnggLyBzY2FsYXI7CiAgICByZXN1bHQueSA9IHYxLnkgLyBzY2FsYXI7CiAgICByZXN1bHQueiA9IHYxLnogLyBzY2FsYXI7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBzdGF0aWMgc3VidHJhY3QodjEsIHYyLCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3IzKCk7CiAgICB9CiAgICByZXN1bHQuc3ViVmVjdG9ycyh2MSwgdjIpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc3RhdGljIGRpc3RhbmNlKHYxLCB2MikgewogICAgcmV0dXJuIHYxLmRpc3RhbmNlVG8odjIpOwogIH0KICBzdGF0aWMgbmVnYXRlKHYxLCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3IzKCk7CiAgICB9CiAgICByZXN1bHQuY29weSh2MSk7CiAgICByZXN1bHQubmVnYXRlKCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBzdGF0aWMgbXVsdGlwbHlDb21wb25lbnRzKHYxLCB2MiwgcmVzdWx0KSB7CiAgICBpZiAoIXJlc3VsdCkgewogICAgICByZXN1bHQgPSBuZXcgVmVjdG9yMygpOwogICAgfQogICAgcmVzdWx0Lm11bHRpcGx5VmVjdG9ycyh2MSwgdjIpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc3RhdGljIG1hZ25pdHVkZSh2KSB7CiAgICByZXR1cm4gdi5sZW5ndGgoKTsKICB9CiAgc3RhdGljIGVxdWFsc0Vwc2lsb24obGVmdCwgcmlnaHQsIHJlbGF0aXZlRXBzaWxvbiwgYWJzb2x1dGVFcHNpbG9uKSB7CiAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgfHwgZGVmaW5lZCQxKGxlZnQpICYmIGRlZmluZWQkMShyaWdodCkgJiYgQ2VzaXVtTWF0aC5lcXVhbHNFcHNpbG9uKAogICAgICBsZWZ0LngsCiAgICAgIHJpZ2h0LngsCiAgICAgIHJlbGF0aXZlRXBzaWxvbiwKICAgICAgYWJzb2x1dGVFcHNpbG9uCiAgICApICYmIENlc2l1bU1hdGguZXF1YWxzRXBzaWxvbigKICAgICAgbGVmdC55LAogICAgICByaWdodC55LAogICAgICByZWxhdGl2ZUVwc2lsb24sCiAgICAgIGFic29sdXRlRXBzaWxvbgogICAgKSAmJiBDZXNpdW1NYXRoLmVxdWFsc0Vwc2lsb24oCiAgICAgIGxlZnQueiwKICAgICAgcmlnaHQueiwKICAgICAgcmVsYXRpdmVFcHNpbG9uLAogICAgICBhYnNvbHV0ZUVwc2lsb24KICAgICk7CiAgfQogIHN0YXRpYyBmcm9tQ2FydGVzaWFuNCh2LCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3IzKCk7CiAgICB9CiAgICByZXN1bHQuc2V0KHYueCwgdi55LCB2LnopOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc3RhdGljIGZyb21FbGVtZW50cyh4LCB5LCB6LCByZXN1bHQpIHsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3IzKCk7CiAgICB9CiAgICByZXN1bHQuc2V0KHgsIHksIHopOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc3RhdGljIGZyb21SYWRpYW5zKGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCwgZWxsaXBzb2lkLCByZXN1bHQpIHsKICAgIGhlaWdodCA9IGRlZmF1bHRWYWx1ZShoZWlnaHQsIDApOwogICAgY29uc3QgcmFkaWlTcXVhcmVkID0gZGVmaW5lZCQxKGVsbGlwc29pZCkgPyBlbGxpcHNvaWQucmFkaWlTcXVhcmVkIDogd2dzODRSYWRpaVNxdWFyZWQ7CiAgICBjb25zdCBjb3NMYXRpdHVkZSA9IE1hdGguY29zKGxhdGl0dWRlKTsKICAgIHNjcmF0Y2hOLnggPSBjb3NMYXRpdHVkZSAqIE1hdGguY29zKGxvbmdpdHVkZSk7CiAgICBzY3JhdGNoTi55ID0gY29zTGF0aXR1ZGUgKiBNYXRoLnNpbihsb25naXR1ZGUpOwogICAgc2NyYXRjaE4ueiA9IE1hdGguc2luKGxhdGl0dWRlKTsKICAgIHNjcmF0Y2hOID0gX0NhcnRlc2lhbjMubm9ybWFsaXplKHNjcmF0Y2hOLCBzY3JhdGNoTik7CiAgICBfQ2FydGVzaWFuMy5tdWx0aXBseUNvbXBvbmVudHMocmFkaWlTcXVhcmVkLCBzY3JhdGNoTiwgc2NyYXRjaEspOwogICAgY29uc3QgZ2FtbWEgPSBNYXRoLnNxcnQoX0NhcnRlc2lhbjMuZG90KHNjcmF0Y2hOLCBzY3JhdGNoSykpOwogICAgc2NyYXRjaEsgPSBfQ2FydGVzaWFuMy5kaXZpZGVCeVNjYWxhcihzY3JhdGNoSywgZ2FtbWEsIHNjcmF0Y2hLKTsKICAgIHNjcmF0Y2hOID0gX0NhcnRlc2lhbjMubXVsdGlwbHlCeVNjYWxhcihzY3JhdGNoTiwgaGVpZ2h0LCBzY3JhdGNoTik7CiAgICBpZiAoIWRlZmluZWQkMShyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZWN0b3IzKCk7CiAgICB9CiAgICByZXR1cm4gX0NhcnRlc2lhbjMuYWRkKHNjcmF0Y2hLLCBzY3JhdGNoTiwgcmVzdWx0KTsKICB9CiAgc3RhdGljIGFuZ2xlQmV0d2VlbihsZWZ0LCByaWdodCkgewogICAgX0NhcnRlc2lhbjMubm9ybWFsaXplKGxlZnQsIGFuZ2xlQmV0d2VlblNjcmF0Y2gpOwogICAgX0NhcnRlc2lhbjMubm9ybWFsaXplKHJpZ2h0LCBhbmdsZUJldHdlZW5TY3JhdGNoMik7CiAgICBjb25zdCBjb3NpbmUgPSBfQ2FydGVzaWFuMy5kb3QoYW5nbGVCZXR3ZWVuU2NyYXRjaCwgYW5nbGVCZXR3ZWVuU2NyYXRjaDIpOwogICAgY29uc3Qgc2luZSA9IF9DYXJ0ZXNpYW4zLm1hZ25pdHVkZSgKICAgICAgX0NhcnRlc2lhbjMuY3Jvc3MoCiAgICAgICAgYW5nbGVCZXR3ZWVuU2NyYXRjaCwKICAgICAgICBhbmdsZUJldHdlZW5TY3JhdGNoMiwKICAgICAgICBhbmdsZUJldHdlZW5TY3JhdGNoCiAgICAgICkKICAgICk7CiAgICByZXR1cm4gTWF0aC5hdGFuMihzaW5lLCBjb3NpbmUpOwogIH0KICBzdGF0aWMgZnJvbURlZ3JlZXMobG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0LCBlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgbG9uZ2l0dWRlID0gQ2VzaXVtTWF0aC50b1JhZGlhbnMobG9uZ2l0dWRlKTsKICAgIGxhdGl0dWRlID0gQ2VzaXVtTWF0aC50b1JhZGlhbnMobGF0aXR1ZGUpOwogICAgcmV0dXJuIF9DYXJ0ZXNpYW4zLmZyb21SYWRpYW5zKGxvbmdpdHVkZSwgbGF0aXR1ZGUsIGhlaWdodCwgZWxsaXBzb2lkLCByZXN1bHQpOwogIH0KfTsKbGV0IENhcnRlc2lhbjMgPSBfQ2FydGVzaWFuMzsKX19wdWJsaWNGaWVsZChDYXJ0ZXNpYW4zLCAiWkVSTyIsIE9iamVjdC5mcmVlemUobmV3IFZlY3RvcjMoKSkpOwpfX3B1YmxpY0ZpZWxkKENhcnRlc2lhbjMsICJVTklUX1giLCBPYmplY3QuZnJlZXplKG5ldyBWZWN0b3IzKDEsIDAsIDApKSk7Cl9fcHVibGljRmllbGQoQ2FydGVzaWFuMywgIlVOSVRfWSIsIE9iamVjdC5mcmVlemUobmV3IFZlY3RvcjMoMCwgMSwgMCkpKTsKX19wdWJsaWNGaWVsZChDYXJ0ZXNpYW4zLCAiVU5JVF9aIiwgT2JqZWN0LmZyZWV6ZShuZXcgVmVjdG9yMygwLCAwLCAxKSkpOwpfX3B1YmxpY0ZpZWxkKENhcnRlc2lhbjMsICJhYnMiLCBmdW5jdGlvbihjYXJ0ZXNpYW4sIHJlc3VsdCkgewogIHJlc3VsdC54ID0gTWF0aC5hYnMoY2FydGVzaWFuLngpOwogIHJlc3VsdC55ID0gTWF0aC5hYnMoY2FydGVzaWFuLnkpOwogIHJlc3VsdC56ID0gTWF0aC5hYnMoY2FydGVzaWFuLnopOwogIHJldHVybiByZXN1bHQ7Cn0pOwpfX3B1YmxpY0ZpZWxkKENhcnRlc2lhbjMsICJtb3N0T3J0aG9nb25hbEF4aXMiLCBmdW5jdGlvbihjYXJ0ZXNpYW4sIHJlc3VsdCkgewogIGNvbnN0IGYgPSBfQ2FydGVzaWFuMy5ub3JtYWxpemUoY2FydGVzaWFuLCBtb3N0T3J0aG9nb25hbEF4aXNTY3JhdGNoKTsKICBfQ2FydGVzaWFuMy5hYnMoZiwgZik7CiAgaWYgKGYueCA8PSBmLnkpIHsKICAgIGlmIChmLnggPD0gZi56KSB7CiAgICAgIHJlc3VsdCA9IF9DYXJ0ZXNpYW4zLmNsb25lKF9DYXJ0ZXNpYW4zLlVOSVRfWCwgcmVzdWx0KTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdCA9IF9DYXJ0ZXNpYW4zLmNsb25lKF9DYXJ0ZXNpYW4zLlVOSVRfWiwgcmVzdWx0KTsKICAgIH0KICB9IGVsc2UgaWYgKGYueSA8PSBmLnopIHsKICAgIHJlc3VsdCA9IF9DYXJ0ZXNpYW4zLmNsb25lKF9DYXJ0ZXNpYW4zLlVOSVRfWSwgcmVzdWx0KTsKICB9IGVsc2UgewogICAgcmVzdWx0ID0gX0NhcnRlc2lhbjMuY2xvbmUoX0NhcnRlc2lhbjMuVU5JVF9aLCByZXN1bHQpOwogIH0KICByZXR1cm4gcmVzdWx0Owp9KTsKY29uc3QgX2lucHV0VmVjdG9yMyA9IG5ldyBWZWN0b3IzKCk7CmNvbnN0IF9vdXRwdXRWZWN0b3IzID0gbmV3IFZlY3RvcjMoKTsKY2xhc3MgRWxsaXBzb2lkIHsKICBjb25zdHJ1Y3Rvcih4LCB5LCB6KSB7CiAgICB0aGlzLl9yYWRpaSA9IG5ldyBWZWN0b3IzKHgsIHksIHopOwogICAgdGhpcy5fcmFkaWlTcXVhcmVkID0gbmV3IFZlY3RvcjMoeCAqIHgsIHkgKiB5LCB6ICogeik7CiAgICB0aGlzLl9yYWRpaVRvVGhlRm91cnRoID0gbmV3IFZlY3RvcjMoCiAgICAgIHggKiB4ICogeCAqIHgsCiAgICAgIHkgKiB5ICogeSAqIHksCiAgICAgIHogKiB6ICogeiAqIHoKICAgICk7CiAgICB0aGlzLl9vbmVPdmVyUmFkaWkgPSBuZXcgVmVjdG9yMygKICAgICAgeCA9PT0gMCA/IDAgOiAxIC8geCwKICAgICAgeSA9PT0gMCA/IDAgOiAxIC8geSwKICAgICAgeiA9PT0gMCA/IDAgOiAxIC8gegogICAgKTsKICAgIHRoaXMuX29uZU92ZXJSYWRpaVNxdWFyZWQgPSBuZXcgVmVjdG9yMygKICAgICAgeCA9PT0gMCA/IDAgOiAxIC8gKHggKiB4KSwKICAgICAgeSA9PT0gMCA/IDAgOiAxIC8gKHkgKiB5KSwKICAgICAgeiA9PT0gMCA/IDAgOiAxIC8gKHogKiB6KQogICAgKTsKICAgIHRoaXMuX21pbmltdW1SYWRpdXMgPSBNYXRoLm1pbih4LCB5LCB6KTsKICAgIHRoaXMuX21heGltdW1SYWRpdXMgPSBNYXRoLm1heCh4LCB5LCB6KTsKICAgIHRoaXMuX2NlbnRlclRvbGVyYW5jZVNxdWFyZWQgPSAwLjE7CiAgICBpZiAodGhpcy5fcmFkaWlTcXVhcmVkLnogIT09IDApIHsKICAgICAgdGhpcy5fc3F1YXJlZFhPdmVyU3F1YXJlZFogPSB0aGlzLl9yYWRpaVNxdWFyZWQueCAvIHRoaXMuX3JhZGlpU3F1YXJlZC56OwogICAgfQogIH0KICBzdGF0aWMgZnJvbUNhcnRlc2lhbjModmVjdG9yKSB7CiAgICByZXR1cm4gbmV3IEVsbGlwc29pZCh2ZWN0b3IueCwgdmVjdG9yLnksIHZlY3Rvci56KTsKICB9CiAgZ2VvZGV0aWNTdXJmYWNlTm9ybWFsQ2FydG9ncmFwaGljKGNhcnRvZ3JhcGhpYywgcmVzdWx0KSB7CiAgICBpZiAoIXJlc3VsdCkgewogICAgICByZXN1bHQgPSBuZXcgVmVjdG9yMygpOwogICAgfQogICAgY29uc3QgbG9uZ2l0dWRlID0gY2FydG9ncmFwaGljLng7CiAgICBjb25zdCBsYXRpdHVkZSA9IGNhcnRvZ3JhcGhpYy55OwogICAgY29uc3QgY29zTGF0aXR1ZGUgPSBNYXRoLmNvcyhsYXRpdHVkZSk7CiAgICBjb25zdCB4ID0gY29zTGF0aXR1ZGUgKiBNYXRoLmNvcyhsb25naXR1ZGUpOwogICAgY29uc3QgeSA9IGNvc0xhdGl0dWRlICogTWF0aC5zaW4obG9uZ2l0dWRlKTsKICAgIGNvbnN0IHogPSBNYXRoLnNpbihsYXRpdHVkZSk7CiAgICByZXN1bHQuc2V0KHgsIHksIHopOwogICAgcmVzdWx0Lm5vcm1hbGl6ZSgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgY2FydG9ncmFwaGljRGVncmVlVG9DYXJ0ZXNpYW4oY2FydG9ncmFwaGljRGVncmVlLCByZXN1bHQpIHsKICAgIF9pbnB1dFZlY3RvcjMuc2V0KAogICAgICBNYXRoVXRpbHMuZGVnVG9SYWQoY2FydG9ncmFwaGljRGVncmVlLngpLAogICAgICBNYXRoVXRpbHMuZGVnVG9SYWQoY2FydG9ncmFwaGljRGVncmVlLnkpLAogICAgICBjYXJ0b2dyYXBoaWNEZWdyZWUuegogICAgKTsKICAgIHJldHVybiB0aGlzLmNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKF9pbnB1dFZlY3RvcjMsIHJlc3VsdCk7CiAgfQogIGNhcnRvZ3JhcGhpY1RvQ2FydGVzaWFuKGNhcnRvZ3JhcGhpYywgaykgewogICAgY29uc3Qgbm9ybWFsID0gdGhpcy5nZW9kZXRpY1N1cmZhY2VOb3JtYWxDYXJ0b2dyYXBoaWMoY2FydG9ncmFwaGljKTsKICAgIGlmICghaykgewogICAgICBrID0gbmV3IFZlY3RvcjMoKTsKICAgIH0KICAgIGsubXVsdGlwbHlWZWN0b3JzKHRoaXMuX3JhZGlpU3F1YXJlZCwgbm9ybWFsKTsKICAgIGNvbnN0IGdhbW1hID0gTWF0aC5zcXJ0KG5vcm1hbC5jbG9uZSgpLmRvdChrKSk7CiAgICBrLmRpdmlkZVNjYWxhcihnYW1tYSk7CiAgICBub3JtYWwubXVsdGlwbHlTY2FsYXIoY2FydG9ncmFwaGljLnopOwogICAgay5hZGQobm9ybWFsKTsKICAgIHJldHVybiBrOwogIH0KICBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpY0RlZ3JlZShjYXJ0ZXNpYW4sIHJlc3VsdCkgewogICAgY29uc3QgdGVtcFJlc3VsdCA9IHRoaXMuY2FydGVzaWFuVG9DYXJ0b2dyYXBoaWMoY2FydGVzaWFuLCByZXN1bHQpOwogICAgaWYgKCF0ZW1wUmVzdWx0KSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICByZXN1bHQgPSB0ZW1wUmVzdWx0OwogICAgcmVzdWx0LnggPSBNYXRoVXRpbHMucmFkVG9EZWcocmVzdWx0LngpOwogICAgcmVzdWx0LnkgPSBNYXRoVXRpbHMucmFkVG9EZWcocmVzdWx0LnkpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgc2NhbGVUb0dlb2RldGljU3VyZmFjZShjYXJ0ZXNpYW4sIHJlc3VsdCkgewogICAgcmV0dXJuIHNjYWxlVG9HZW9kZXRpY1N1cmZhY2UoCiAgICAgIGNhcnRlc2lhbiwKICAgICAgdGhpcy5fb25lT3ZlclJhZGlpLAogICAgICB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkLAogICAgICB0aGlzLl9jZW50ZXJUb2xlcmFuY2VTcXVhcmVkLAogICAgICByZXN1bHQKICAgICk7CiAgfQogIHNjYWxlVG9HZW9jZW50cmljU3VyZmFjZShjYXJ0ZXNpYW4sIHJlc3VsdCkgewogICAgaWYgKCFyZXN1bHQpIHsKICAgICAgcmVzdWx0ID0gbmV3IFZlY3RvcjMoKTsKICAgIH0KICAgIGNvbnN0IHBvc2l0aW9uWCA9IGNhcnRlc2lhbi54OwogICAgY29uc3QgcG9zaXRpb25ZID0gY2FydGVzaWFuLnk7CiAgICBjb25zdCBwb3NpdGlvblogPSBjYXJ0ZXNpYW4uejsKICAgIGNvbnN0IG9uZU92ZXJSYWRpaVNxdWFyZWQgPSB0aGlzLl9vbmVPdmVyUmFkaWlTcXVhcmVkOwogICAgY29uc3QgYmV0YSA9IDEgLyBNYXRoLnNxcnQoCiAgICAgIHBvc2l0aW9uWCAqIHBvc2l0aW9uWCAqIG9uZU92ZXJSYWRpaVNxdWFyZWQueCArIHBvc2l0aW9uWSAqIHBvc2l0aW9uWSAqIG9uZU92ZXJSYWRpaVNxdWFyZWQueSArIHBvc2l0aW9uWiAqIHBvc2l0aW9uWiAqIG9uZU92ZXJSYWRpaVNxdWFyZWQuegogICAgKTsKICAgIHJldHVybiByZXN1bHQuY29weShjYXJ0ZXNpYW4pLm11bHRpcGx5U2NhbGFyKGJldGEpOwogIH0KICBjYXJ0ZXNpYW5Ub0NhcnRvZ3JhcGhpYyhjYXJ0ZXNpYW4sIHJlc3VsdCkgewogICAgY29uc3QgcCA9IHRoaXMuc2NhbGVUb0dlb2RldGljU3VyZmFjZSgKICAgICAgY2FydGVzaWFuLAogICAgICBfb3V0cHV0VmVjdG9yMwogICAgKTsKICAgIGlmICghcCkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgY29uc3QgbiA9IHRoaXMuZ2VvZGV0aWNTdXJmYWNlTm9ybWFsKHApOwogICAgY29uc3QgaCA9IGNhcnRlc2lhbi5jbG9uZSgpOwogICAgaC5zdWIocCk7CiAgICBjb25zdCBsb25naXR1ZGUgPSBNYXRoLmF0YW4yKG4ueSwgbi54KTsKICAgIGNvbnN0IGxhdGl0dWRlID0gTWF0aC5hc2luKG4ueik7CiAgICBjb25zdCBoZWlnaHQgPSBNYXRoLnNpZ24oaC5kb3QoY2FydGVzaWFuKSkgKiBoLmxlbmd0aCgpOwogICAgaWYgKCFyZXN1bHQpIHsKICAgICAgcmVzdWx0ID0gbmV3IFZlY3RvcjMoKTsKICAgIH0KICAgIHJlc3VsdC5zZXQobG9uZ2l0dWRlLCBsYXRpdHVkZSwgaGVpZ2h0KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGdlb2RldGljU3VyZmFjZU5vcm1hbChjYXJ0ZXNpYW4sIHJlc3VsdCkgewogICAgaWYgKCFkZWZpbmVkJDEocmVzdWx0KSkgewogICAgICByZXN1bHQgPSBuZXcgVmVjdG9yMygpOwogICAgfQogICAgcmVzdWx0Lm11bHRpcGx5VmVjdG9ycyhjYXJ0ZXNpYW4sIHRoaXMuX29uZU92ZXJSYWRpaVNxdWFyZWQpOwogICAgcmVzdWx0Lm5vcm1hbGl6ZSgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZ2V0U3VyZmFjZU5vcm1hbEludGVyc2VjdGlvbldpdGhaQXhpcyhwb3NpdGlvbiwgYnVmZmVyLCByZXN1bHQpIHsKICAgIGJ1ZmZlciA9IGRlZmF1bHRWYWx1ZShidWZmZXIsIDApOwogICAgY29uc3Qgc3F1YXJlZFhPdmVyU3F1YXJlZFogPSB0aGlzLl9zcXVhcmVkWE92ZXJTcXVhcmVkWjsKICAgIGlmICghZGVmaW5lZCQxKHJlc3VsdCkpIHsKICAgICAgcmVzdWx0ID0gbmV3IFZlY3RvcjMoKTsKICAgIH0KICAgIHJlc3VsdC54ID0gMDsKICAgIHJlc3VsdC55ID0gMDsKICAgIHJlc3VsdC56ID0gcG9zaXRpb24ueiAqICgxIC0gc3F1YXJlZFhPdmVyU3F1YXJlZFopOwogICAgaWYgKE1hdGguYWJzKHJlc3VsdC56KSA+PSB0aGlzLl9yYWRpaS56IC0gYnVmZmVyKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICB0cmFuc2Zvcm1Qb3NpdGlvblRvU2NhbGVkU3BhY2UocG9zaXRpb24sIHJlc3VsdCkgewogICAgcmV0dXJuIENhcnRlc2lhbjMubXVsdGlwbHlDb21wb25lbnRzKHBvc2l0aW9uLCB0aGlzLl9vbmVPdmVyUmFkaWksIHJlc3VsdCk7CiAgfQogIHN0YXRpYyBjbG9uZShlbGxpcHNvaWQsIHJlc3VsdCkgewogICAgaWYgKCFlbGxpcHNvaWQpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIGNvbnN0IHJhZGlpID0gZWxsaXBzb2lkLl9yYWRpaTsKICAgIGlmICghcmVzdWx0KSB7CiAgICAgIHJldHVybiBuZXcgRWxsaXBzb2lkKHJhZGlpLngsIHJhZGlpLnksIHJhZGlpLnopOwogICAgfQogICAgQ2FydGVzaWFuMy5jbG9uZShyYWRpaSwgcmVzdWx0Ll9yYWRpaSk7CiAgICBDYXJ0ZXNpYW4zLmNsb25lKGVsbGlwc29pZC5fcmFkaWlTcXVhcmVkLCByZXN1bHQuX3JhZGlpU3F1YXJlZCk7CiAgICBDYXJ0ZXNpYW4zLmNsb25lKGVsbGlwc29pZC5fcmFkaWlUb1RoZUZvdXJ0aCwgcmVzdWx0Ll9yYWRpaVRvVGhlRm91cnRoKTsKICAgIENhcnRlc2lhbjMuY2xvbmUoZWxsaXBzb2lkLl9vbmVPdmVyUmFkaWksIHJlc3VsdC5fb25lT3ZlclJhZGlpKTsKICAgIENhcnRlc2lhbjMuY2xvbmUoZWxsaXBzb2lkLl9vbmVPdmVyUmFkaWlTcXVhcmVkLCByZXN1bHQuX29uZU92ZXJSYWRpaVNxdWFyZWQpOwogICAgcmVzdWx0Ll9taW5pbXVtUmFkaXVzID0gZWxsaXBzb2lkLl9taW5pbXVtUmFkaXVzOwogICAgcmVzdWx0Ll9tYXhpbXVtUmFkaXVzID0gZWxsaXBzb2lkLl9tYXhpbXVtUmFkaXVzOwogICAgcmVzdWx0Ll9jZW50ZXJUb2xlcmFuY2VTcXVhcmVkID0gZWxsaXBzb2lkLl9jZW50ZXJUb2xlcmFuY2VTcXVhcmVkOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZ2V0IHJhZGlpKCkgewogICAgcmV0dXJuIHRoaXMuX3JhZGlpOwogIH0KICBnZXQgcmFkaWlTcXVhcmVkKCkgewogICAgcmV0dXJuIHRoaXMuX3JhZGlpU3F1YXJlZDsKICB9CiAgZ2V0IHJhZGlpVG9UaGVGb3VydGgoKSB7CiAgICByZXR1cm4gdGhpcy5yYWRpaVRvVGhlRm91cnRoOwogIH0KICBnZXQgb25lT3ZlclJhZGlpKCkgewogICAgcmV0dXJuIHRoaXMuX29uZU92ZXJSYWRpaTsKICB9CiAgZ2V0IG9uZU92ZXJSYWRpaVNxdWFyZWQoKSB7CiAgICByZXR1cm4gdGhpcy5fb25lT3ZlclJhZGlpU3F1YXJlZDsKICB9CiAgZ2V0IG1heGltdW1SYWRpdXMoKSB7CiAgICByZXR1cm4gdGhpcy5fbWF4aW11bVJhZGl1czsKICB9CiAgZ2V0IG1pbmltdW1SYWRpdXMoKSB7CiAgICByZXR1cm4gdGhpcy5fbWluaW11bVJhZGl1czsKICB9Cn0KRWxsaXBzb2lkLldHUzg0ID0gT2JqZWN0LmZyZWV6ZSgKICBuZXcgRWxsaXBzb2lkKDYzNzgxMzcsIDYzNzgxMzcsIDYzNTY3NTIzMTQyNDUxNzllLTkpCik7CmZ1bmN0aW9uIGRlZmluZWQodmFsdWUpIHsKICByZXR1cm4gdmFsdWUgIT09IHZvaWQgMCAmJiB2YWx1ZSAhPT0gbnVsbDsKfQpjb25zdCBJbnRlcnNlY3Rpb25zMkQgPSB7fTsKSW50ZXJzZWN0aW9uczJELmNsaXBUcmlhbmdsZUF0QXhpc0FsaWduZWRUaHJlc2hvbGQgPSBmdW5jdGlvbih0aHJlc2hvbGQsIGtlZXBBYm92ZSwgdTAsIHUxLCB1MiwgcmVzdWx0KSB7CiAgaWYgKCFkZWZpbmVkKHRocmVzaG9sZCkpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigidGhyZXNob2xkIGlzIHJlcXVpcmVkLiIpOwogIH0KICBpZiAoIWRlZmluZWQoa2VlcEFib3ZlKSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJrZWVwQWJvdmUgaXMgcmVxdWlyZWQuIik7CiAgfQogIGlmICghZGVmaW5lZCh1MCkpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigidTAgaXMgcmVxdWlyZWQuIik7CiAgfQogIGlmICghZGVmaW5lZCh1MSkpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigidTEgaXMgcmVxdWlyZWQuIik7CiAgfQogIGlmICghZGVmaW5lZCh1MikpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigidTIgaXMgcmVxdWlyZWQuIik7CiAgfQogIGlmICghZGVmaW5lZChyZXN1bHQpKSB7CiAgICByZXN1bHQgPSBbXTsKICB9IGVsc2UgewogICAgcmVzdWx0Lmxlbmd0aCA9IDA7CiAgfQogIGxldCB1MEJlaGluZDsKICBsZXQgdTFCZWhpbmQ7CiAgbGV0IHUyQmVoaW5kOwogIGlmIChrZWVwQWJvdmUpIHsKICAgIHUwQmVoaW5kID0gdTAgPCB0aHJlc2hvbGQ7CiAgICB1MUJlaGluZCA9IHUxIDwgdGhyZXNob2xkOwogICAgdTJCZWhpbmQgPSB1MiA8IHRocmVzaG9sZDsKICB9IGVsc2UgewogICAgdTBCZWhpbmQgPSB1MCA+IHRocmVzaG9sZDsKICAgIHUxQmVoaW5kID0gdTEgPiB0aHJlc2hvbGQ7CiAgICB1MkJlaGluZCA9IHUyID4gdGhyZXNob2xkOwogIH0KICBjb25zdCBudW1CZWhpbmQgPSB1MEJlaGluZCArIHUxQmVoaW5kICsgdTJCZWhpbmQ7CiAgbGV0IHUwMVJhdGlvOwogIGxldCB1MDJSYXRpbzsKICBsZXQgdTEyUmF0aW87CiAgbGV0IHUxMFJhdGlvOwogIGxldCB1MjBSYXRpbzsKICBsZXQgdTIxUmF0aW87CiAgaWYgKG51bUJlaGluZCA9PT0gMSkgewogICAgaWYgKHUwQmVoaW5kKSB7CiAgICAgIHUwMVJhdGlvID0gKHRocmVzaG9sZCAtIHUwKSAvICh1MSAtIHUwKTsKICAgICAgdTAyUmF0aW8gPSAodGhyZXNob2xkIC0gdTApIC8gKHUyIC0gdTApOwogICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgIGlmICh1MDJSYXRpbyAhPT0gMSkgewogICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICByZXN1bHQucHVzaCgwKTsKICAgICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgICByZXN1bHQucHVzaCh1MDJSYXRpbyk7CiAgICAgIH0KICAgICAgaWYgKHUwMVJhdGlvICE9PSAxKSB7CiAgICAgICAgcmVzdWx0LnB1c2goLTEpOwogICAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICAgIHJlc3VsdC5wdXNoKDEpOwogICAgICAgIHJlc3VsdC5wdXNoKHUwMVJhdGlvKTsKICAgICAgfQogICAgfSBlbHNlIGlmICh1MUJlaGluZCkgewogICAgICB1MTJSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MSkgLyAodTIgLSB1MSk7CiAgICAgIHUxMFJhdGlvID0gKHRocmVzaG9sZCAtIHUxKSAvICh1MCAtIHUxKTsKICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICBpZiAodTEwUmF0aW8gIT09IDEpIHsKICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgcmVzdWx0LnB1c2godTEwUmF0aW8pOwogICAgICB9CiAgICAgIGlmICh1MTJSYXRpbyAhPT0gMSkgewogICAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgICByZXN1bHQucHVzaCh1MTJSYXRpbyk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodTJCZWhpbmQpIHsKICAgICAgdTIwUmF0aW8gPSAodGhyZXNob2xkIC0gdTIpIC8gKHUwIC0gdTIpOwogICAgICB1MjFSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MikgLyAodTEgLSB1Mik7CiAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgaWYgKHUyMVJhdGlvICE9PSAxKSB7CiAgICAgICAgcmVzdWx0LnB1c2goLTEpOwogICAgICAgIHJlc3VsdC5wdXNoKDIpOwogICAgICAgIHJlc3VsdC5wdXNoKDEpOwogICAgICAgIHJlc3VsdC5wdXNoKHUyMVJhdGlvKTsKICAgICAgfQogICAgICBpZiAodTIwUmF0aW8gIT09IDEpIHsKICAgICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgICAgcmVzdWx0LnB1c2godTIwUmF0aW8pOwogICAgICB9CiAgICB9CiAgfSBlbHNlIGlmIChudW1CZWhpbmQgPT09IDIpIHsKICAgIGlmICghdTBCZWhpbmQgJiYgdTAgIT09IHRocmVzaG9sZCkgewogICAgICB1MTBSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MSkgLyAodTAgLSB1MSk7CiAgICAgIHUyMFJhdGlvID0gKHRocmVzaG9sZCAtIHUyKSAvICh1MCAtIHUyKTsKICAgICAgcmVzdWx0LnB1c2goMCk7CiAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICByZXN1bHQucHVzaCh1MTBSYXRpbyk7CiAgICAgIHJlc3VsdC5wdXNoKC0xKTsKICAgICAgcmVzdWx0LnB1c2goMik7CiAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICByZXN1bHQucHVzaCh1MjBSYXRpbyk7CiAgICB9IGVsc2UgaWYgKCF1MUJlaGluZCAmJiB1MSAhPT0gdGhyZXNob2xkKSB7CiAgICAgIHUyMVJhdGlvID0gKHRocmVzaG9sZCAtIHUyKSAvICh1MSAtIHUyKTsKICAgICAgdTAxUmF0aW8gPSAodGhyZXNob2xkIC0gdTApIC8gKHUxIC0gdTApOwogICAgICByZXN1bHQucHVzaCgxKTsKICAgICAgcmVzdWx0LnB1c2goLTEpOwogICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgIHJlc3VsdC5wdXNoKHUyMVJhdGlvKTsKICAgICAgcmVzdWx0LnB1c2goLTEpOwogICAgICByZXN1bHQucHVzaCgwKTsKICAgICAgcmVzdWx0LnB1c2goMSk7CiAgICAgIHJlc3VsdC5wdXNoKHUwMVJhdGlvKTsKICAgIH0gZWxzZSBpZiAoIXUyQmVoaW5kICYmIHUyICE9PSB0aHJlc2hvbGQpIHsKICAgICAgdTAyUmF0aW8gPSAodGhyZXNob2xkIC0gdTApIC8gKHUyIC0gdTApOwogICAgICB1MTJSYXRpbyA9ICh0aHJlc2hvbGQgLSB1MSkgLyAodTIgLSB1MSk7CiAgICAgIHJlc3VsdC5wdXNoKDIpOwogICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgIHJlc3VsdC5wdXNoKDApOwogICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgcmVzdWx0LnB1c2godTAyUmF0aW8pOwogICAgICByZXN1bHQucHVzaCgtMSk7CiAgICAgIHJlc3VsdC5wdXNoKDEpOwogICAgICByZXN1bHQucHVzaCgyKTsKICAgICAgcmVzdWx0LnB1c2godTEyUmF0aW8pOwogICAgfQogIH0gZWxzZSBpZiAobnVtQmVoaW5kICE9PSAzKSB7CiAgICByZXN1bHQucHVzaCgwKTsKICAgIHJlc3VsdC5wdXNoKDEpOwogICAgcmVzdWx0LnB1c2goMik7CiAgfQogIHJldHVybiByZXN1bHQ7Cn07CkludGVyc2VjdGlvbnMyRC5jb21wdXRlQmFyeWNlbnRyaWNDb29yZGluYXRlcyA9IGZ1bmN0aW9uKHgsIHksIHgxLCB5MSwgeDIsIHkyLCB4MywgeTMsIHJlc3VsdCkgewogIGlmICghZGVmaW5lZCh4KSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJ4IGlzIHJlcXVpcmVkLiIpOwogIH0KICBpZiAoIWRlZmluZWQoeSkpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigieSBpcyByZXF1aXJlZC4iKTsKICB9CiAgaWYgKCFkZWZpbmVkKHgxKSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJ4MSBpcyByZXF1aXJlZC4iKTsKICB9CiAgaWYgKCFkZWZpbmVkKHkxKSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJ5MSBpcyByZXF1aXJlZC4iKTsKICB9CiAgaWYgKCFkZWZpbmVkKHgyKSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJ4MiBpcyByZXF1aXJlZC4iKTsKICB9CiAgaWYgKCFkZWZpbmVkKHkyKSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJ5MiBpcyByZXF1aXJlZC4iKTsKICB9CiAgaWYgKCFkZWZpbmVkKHgzKSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJ4MyBpcyByZXF1aXJlZC4iKTsKICB9CiAgaWYgKCFkZWZpbmVkKHkzKSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJ5MyBpcyByZXF1aXJlZC4iKTsKICB9CiAgY29uc3QgeDFteDMgPSB4MSAtIHgzOwogIGNvbnN0IHgzbXgyID0geDMgLSB4MjsKICBjb25zdCB5Mm15MyA9IHkyIC0geTM7CiAgY29uc3QgeTFteTMgPSB5MSAtIHkzOwogIGNvbnN0IGludmVyc2VEZXRlcm1pbmFudCA9IDEgLyAoeTJteTMgKiB4MW14MyArIHgzbXgyICogeTFteTMpOwogIGNvbnN0IHlteTMgPSB5IC0geTM7CiAgY29uc3QgeG14MyA9IHggLSB4MzsKICBjb25zdCBsMSA9ICh5Mm15MyAqIHhteDMgKyB4M214MiAqIHlteTMpICogaW52ZXJzZURldGVybWluYW50OwogIGNvbnN0IGwyID0gKC15MW15MyAqIHhteDMgKyB4MW14MyAqIHlteTMpICogaW52ZXJzZURldGVybWluYW50OwogIGNvbnN0IGwzID0gMSAtIGwxIC0gbDI7CiAgaWYgKGRlZmluZWQocmVzdWx0KSkgewogICAgcmVzdWx0LnggPSBsMTsKICAgIHJlc3VsdC55ID0gbDI7CiAgICByZXN1bHQueiA9IGwzOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgcmV0dXJuIG5ldyBWZWN0b3IzKGwxLCBsMiwgbDMpOwp9OwpJbnRlcnNlY3Rpb25zMkQuY29tcHV0ZUxpbmVTZWdtZW50TGluZVNlZ21lbnRJbnRlcnNlY3Rpb24gPSBmdW5jdGlvbih4MDAsIHkwMCwgeDAxLCB5MDEsIHgxMCwgeTEwLCB4MTEsIHkxMSwgcmVzdWx0KSB7CiAgY29uc3QgbnVtZXJhdG9yMUEgPSAoeDExIC0geDEwKSAqICh5MDAgLSB5MTApIC0gKHkxMSAtIHkxMCkgKiAoeDAwIC0geDEwKTsKICBjb25zdCBudW1lcmF0b3IxQiA9ICh4MDEgLSB4MDApICogKHkwMCAtIHkxMCkgLSAoeTAxIC0geTAwKSAqICh4MDAgLSB4MTApOwogIGNvbnN0IGRlbm9taW5hdG9yMSA9ICh5MTEgLSB5MTApICogKHgwMSAtIHgwMCkgLSAoeDExIC0geDEwKSAqICh5MDEgLSB5MDApOwogIGlmIChkZW5vbWluYXRvcjEgPT09IDApIHsKICAgIHJldHVybjsKICB9CiAgY29uc3QgdWExID0gbnVtZXJhdG9yMUEgLyBkZW5vbWluYXRvcjE7CiAgY29uc3QgdWIxID0gbnVtZXJhdG9yMUIgLyBkZW5vbWluYXRvcjE7CiAgaWYgKHVhMSA+PSAwICYmIHVhMSA8PSAxICYmIHViMSA+PSAwICYmIHViMSA8PSAxKSB7CiAgICBpZiAoIWRlZmluZWQocmVzdWx0KSkgewogICAgICByZXN1bHQgPSBuZXcgVmVjdG9yMigpOwogICAgfQogICAgcmVzdWx0LnggPSB4MDAgKyB1YTEgKiAoeDAxIC0geDAwKTsKICAgIHJlc3VsdC55ID0geTAwICsgdWExICogKHkwMSAtIHkwMCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KfTsKY29uc3QgSW5kZXhEYXRhdHlwZSA9IHsKICBVTlNJR05FRF9CWVRFOiA1MTIxLAogIFVOU0lHTkVEX1NIT1JUOiA1MTIzLAogIFVOU0lHTkVEX0lOVDogNTEyNQp9OwpJbmRleERhdGF0eXBlLmdldFNpemVJbkJ5dGVzID0gZnVuY3Rpb24oaW5kZXhEYXRhdHlwZSkgewogIHN3aXRjaCAoaW5kZXhEYXRhdHlwZSkgewogICAgY2FzZSBJbmRleERhdGF0eXBlLlVOU0lHTkVEX0JZVEU6CiAgICAgIHJldHVybiBVaW50OEFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwogICAgY2FzZSBJbmRleERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUOgogICAgICByZXR1cm4gVWludDE2QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICBjYXNlIEluZGV4RGF0YXR5cGUuVU5TSUdORURfSU5UOgogICAgICByZXR1cm4gVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgfQogIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigKICAgICJpbmRleERhdGF0eXBlIGlzIHJlcXVpcmVkIGFuZCBtdXN0IGJlIGEgdmFsaWQgSW5kZXhEYXRhdHlwZSBjb25zdGFudC4iCiAgKTsKfTsKSW5kZXhEYXRhdHlwZS5mcm9tU2l6ZUluQnl0ZXMgPSBmdW5jdGlvbihzaXplSW5CeXRlcykgewogIHN3aXRjaCAoc2l6ZUluQnl0ZXMpIHsKICAgIGNhc2UgMjoKICAgICAgcmV0dXJuIEluZGV4RGF0YXR5cGUuVU5TSUdORURfU0hPUlQ7CiAgICBjYXNlIDQ6CiAgICAgIHJldHVybiBJbmRleERhdGF0eXBlLlVOU0lHTkVEX0lOVDsKICAgIGNhc2UgMToKICAgICAgcmV0dXJuIEluZGV4RGF0YXR5cGUuVU5TSUdORURfQllURTsKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigKICAgICAgICAiU2l6ZSBpbiBieXRlcyBjYW5ub3QgYmUgbWFwcGVkIHRvIGFuIEluZGV4RGF0YXR5cGUiCiAgICAgICk7CiAgfQp9OwpJbmRleERhdGF0eXBlLnZhbGlkYXRlID0gZnVuY3Rpb24oaW5kZXhEYXRhdHlwZSkgewogIHJldHVybiBkZWZpbmVkKGluZGV4RGF0YXR5cGUpICYmIChpbmRleERhdGF0eXBlID09PSBJbmRleERhdGF0eXBlLlVOU0lHTkVEX0JZVEUgfHwgaW5kZXhEYXRhdHlwZSA9PT0gSW5kZXhEYXRhdHlwZS5VTlNJR05FRF9TSE9SVCB8fCBpbmRleERhdGF0eXBlID09PSBJbmRleERhdGF0eXBlLlVOU0lHTkVEX0lOVCk7Cn07CkluZGV4RGF0YXR5cGUuY3JlYXRlVHlwZWRBcnJheSA9IGZ1bmN0aW9uKG51bWJlck9mVmVydGljZXMsIGluZGljZXNMZW5ndGhPckFycmF5KSB7CiAgaWYgKCFkZWZpbmVkKG51bWJlck9mVmVydGljZXMpKSB7CiAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoIm51bWJlck9mVmVydGljZXMgaXMgcmVxdWlyZWQuIik7CiAgfQogIGlmIChudW1iZXJPZlZlcnRpY2VzID49IENlc2l1bU1hdGguU0lYVFlfRk9VUl9LSUxPQllURVMpIHsKICAgIHJldHVybiBuZXcgVWludDMyQXJyYXkoaW5kaWNlc0xlbmd0aE9yQXJyYXkpOwogIH0KICByZXR1cm4gbmV3IFVpbnQxNkFycmF5KGluZGljZXNMZW5ndGhPckFycmF5KTsKfTsKSW5kZXhEYXRhdHlwZS5jcmVhdGVUeXBlZEFycmF5RnJvbUFycmF5QnVmZmVyID0gZnVuY3Rpb24obnVtYmVyT2ZWZXJ0aWNlcywgc291cmNlQXJyYXksIGJ5dGVPZmZzZXQsIGxlbmd0aCkgewogIGlmICghZGVmaW5lZChudW1iZXJPZlZlcnRpY2VzKSkgewogICAgdGhyb3cgbmV3IERldmVsb3BlckVycm9yKCJudW1iZXJPZlZlcnRpY2VzIGlzIHJlcXVpcmVkLiIpOwogIH0KICBpZiAoIWRlZmluZWQoc291cmNlQXJyYXkpKSB7CiAgICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoInNvdXJjZUFycmF5IGlzIHJlcXVpcmVkLiIpOwogIH0KICBpZiAoIWRlZmluZWQoYnl0ZU9mZnNldCkpIHsKICAgIHRocm93IG5ldyBEZXZlbG9wZXJFcnJvcigiYnl0ZU9mZnNldCBpcyByZXF1aXJlZC4iKTsKICB9CiAgaWYgKG51bWJlck9mVmVydGljZXMgPj0gQ2VzaXVtTWF0aC5TSVhUWV9GT1VSX0tJTE9CWVRFUykgewogICAgcmV0dXJuIG5ldyBVaW50MzJBcnJheShzb3VyY2VBcnJheSwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKICB9CiAgcmV0dXJuIG5ldyBVaW50MTZBcnJheShzb3VyY2VBcnJheSwgYnl0ZU9mZnNldCwgbGVuZ3RoKTsKfTsKSW5kZXhEYXRhdHlwZS5mcm9tVHlwZWRBcnJheSA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgaWYgKGFycmF5IGluc3RhbmNlb2YgVWludDhBcnJheSkgewogICAgcmV0dXJuIEluZGV4RGF0YXR5cGUuVU5TSUdORURfQllURTsKICB9CiAgaWYgKGFycmF5IGluc3RhbmNlb2YgVWludDE2QXJyYXkpIHsKICAgIHJldHVybiBJbmRleERhdGF0eXBlLlVOU0lHTkVEX1NIT1JUOwogIH0KICBpZiAoYXJyYXkgaW5zdGFuY2VvZiBVaW50MzJBcnJheSkgewogICAgcmV0dXJuIEluZGV4RGF0YXR5cGUuVU5TSUdORURfSU5UOwogIH0KICB0aHJvdyBuZXcgRGV2ZWxvcGVyRXJyb3IoCiAgICAiYXJyYXkgbXVzdCBiZSBhIFVpbnQ4QXJyYXksIFVpbnQxNkFycmF5LCBvciBVaW50MzJBcnJheS4iCiAgKTsKfTsKdmFyIEluZGV4RGF0YXR5cGUkMSA9IE9iamVjdC5mcmVlemUoSW5kZXhEYXRhdHlwZSk7CmNsYXNzIFZlcnRleCB7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLnZlcnRleEJ1ZmZlciA9IHZvaWQgMDsKICAgIHRoaXMuaW5kZXggPSB2b2lkIDA7CiAgICB0aGlzLmZpcnN0ID0gdm9pZCAwOwogICAgdGhpcy5zZWNvbmQgPSB2b2lkIDA7CiAgICB0aGlzLnJhdGlvID0gdm9pZCAwOwogIH0KICBjbG9uZShyZXN1bHQpIHsKICAgIGlmICghZGVmaW5lZChyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCA9IG5ldyBWZXJ0ZXgoKTsKICAgIH0KICAgIHJlc3VsdC51QnVmZmVyID0gdGhpcy51QnVmZmVyOwogICAgcmVzdWx0LnZCdWZmZXIgPSB0aGlzLnZCdWZmZXI7CiAgICByZXN1bHQuaGVpZ2h0QnVmZmVyID0gdGhpcy5oZWlnaHRCdWZmZXI7CiAgICByZXN1bHQubm9ybWFsQnVmZmVyID0gdGhpcy5ub3JtYWxCdWZmZXI7CiAgICByZXN1bHQuaW5kZXggPSB0aGlzLmluZGV4OwogICAgcmVzdWx0LmZpcnN0ID0gdGhpcy5maXJzdDsKICAgIHJlc3VsdC5zZWNvbmQgPSB0aGlzLnNlY29uZDsKICAgIHJlc3VsdC5yYXRpbyA9IHRoaXMucmF0aW87CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBpbml0aWFsaXplSW5kZXhlZCh1QnVmZmVyLCB2QnVmZmVyLCBoZWlnaHRCdWZmZXIsIG5vcm1hbEJ1ZmZlciwgaW5kZXgpIHsKICAgIHRoaXMudUJ1ZmZlciA9IHVCdWZmZXI7CiAgICB0aGlzLnZCdWZmZXIgPSB2QnVmZmVyOwogICAgdGhpcy5oZWlnaHRCdWZmZXIgPSBoZWlnaHRCdWZmZXI7CiAgICB0aGlzLm5vcm1hbEJ1ZmZlciA9IG5vcm1hbEJ1ZmZlcjsKICAgIHRoaXMuaW5kZXggPSBpbmRleDsKICAgIHRoaXMuZmlyc3QgPSB2b2lkIDA7CiAgICB0aGlzLnNlY29uZCA9IHZvaWQgMDsKICAgIHRoaXMucmF0aW8gPSB2b2lkIDA7CiAgfQogIGluaXRpYWxpemVGcm9tQ2xpcFJlc3VsdChjbGlwUmVzdWx0LCBpbmRleCwgdmVydGljZXMpIHsKICAgIGxldCBuZXh0SW5kZXggPSBpbmRleCArIDE7CiAgICBpZiAoY2xpcFJlc3VsdFtpbmRleF0gIT09IC0xKSB7CiAgICAgIHZlcnRpY2VzW2NsaXBSZXN1bHRbaW5kZXhdXS5jbG9uZSh0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMudmVydGV4QnVmZmVyID0gdm9pZCAwOwogICAgICB0aGlzLmluZGV4ID0gdm9pZCAwOwogICAgICB0aGlzLmZpcnN0ID0gdmVydGljZXNbY2xpcFJlc3VsdFtuZXh0SW5kZXhdXTsKICAgICAgKytuZXh0SW5kZXg7CiAgICAgIHRoaXMuc2Vjb25kID0gdmVydGljZXNbY2xpcFJlc3VsdFtuZXh0SW5kZXhdXTsKICAgICAgKytuZXh0SW5kZXg7CiAgICAgIHRoaXMucmF0aW8gPSBjbGlwUmVzdWx0W25leHRJbmRleF07CiAgICAgICsrbmV4dEluZGV4OwogICAgfQogICAgcmV0dXJuIG5leHRJbmRleDsKICB9CiAgZ2V0SCgpIHsKICAgIGlmIChkZWZpbmVkKHRoaXMuaW5kZXgpKSB7CiAgICAgIHJldHVybiB0aGlzLmhlaWdodEJ1ZmZlclt0aGlzLmluZGV4XTsKICAgIH0KICAgIHJldHVybiBNYXRoVXRpbHMubGVycCh0aGlzLmZpcnN0LmdldEgoKSwgdGhpcy5zZWNvbmQuZ2V0SCgpLCB0aGlzLnJhdGlvKTsKICB9CiAgZ2V0VSgpIHsKICAgIGlmIChkZWZpbmVkKHRoaXMuaW5kZXgpKSB7CiAgICAgIHJldHVybiB0aGlzLnVCdWZmZXJbdGhpcy5pbmRleF07CiAgICB9CiAgICByZXR1cm4gTWF0aFV0aWxzLmxlcnAodGhpcy5maXJzdC5nZXRVKCksIHRoaXMuc2Vjb25kLmdldFUoKSwgdGhpcy5yYXRpbyk7CiAgfQogIGdldFYoKSB7CiAgICBpZiAoZGVmaW5lZCh0aGlzLmluZGV4KSkgewogICAgICByZXR1cm4gdGhpcy52QnVmZmVyW3RoaXMuaW5kZXhdOwogICAgfQogICAgcmV0dXJuIE1hdGhVdGlscy5sZXJwKHRoaXMuZmlyc3QuZ2V0VigpLCB0aGlzLnNlY29uZC5nZXRWKCksIHRoaXMucmF0aW8pOwogIH0KICBpc0luZGV4ZWQoKSB7CiAgICByZXR1cm4gZGVmaW5lZCh0aGlzLmluZGV4KTsKICB9CiAgZ2V0S2V5KCkgewogICAgaWYgKHRoaXMuaXNJbmRleGVkKCkpIHsKICAgICAgcmV0dXJuIHRoaXMuaW5kZXg7CiAgICB9CiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoewogICAgICBmaXJzdDogdGhpcy5maXJzdC5nZXRLZXkoKSwKICAgICAgc2Vjb25kOiB0aGlzLnNlY29uZC5nZXRLZXkoKSwKICAgICAgcmF0aW86IHRoaXMucmF0aW8KICAgIH0pOwogIH0KfQpjb25zdCBwb2x5Z29uVmVydGljZXMgPSBbXTsKcG9seWdvblZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKcG9seWdvblZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKcG9seWdvblZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKcG9seWdvblZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKc2VsZi5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgKG1lc3NhZ2UpID0+IHsKICBjb25zdCBtZXNzYWdlRGF0YSA9IG1lc3NhZ2UuZGF0YTsKICBjb25zdCB7CiAgICB0eXBlCiAgfSA9IG1lc3NhZ2VEYXRhOwogIGlmICh0eXBlID09PSAiY3JlYXRlVGVycmFpbk1lc2giKSB7CiAgICBzZWxmLmNyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoKG1lc3NhZ2VEYXRhKTsKICB9IGVsc2UgaWYgKHR5cGUgPT09ICJ1cHNhbXBsZVRlcnJhaW5EYXRhIikgewogICAgc2VsZi51cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoKG1lc3NhZ2VEYXRhKTsKICB9IGVsc2UgewogICAgY29uc29sZS5sb2cobWVzc2FnZURhdGEpOwogIH0KfSk7CnNlbGYuY2FsY3VsYXRlVXZGcm9tUG9zaXRpb25zID0gKHBvc2l0aW9ucykgPT4gewogIGNvbnN0IHV2cyA9IFtdOwogIGZvciAobGV0IGkgPSAwLCBsZW5ndGggPSBwb3NpdGlvbnMubGVuZ3RoIC0gMjsgaSA8IGxlbmd0aDsgaSArPSAzKSB7CiAgICB1dnMucHVzaCgKICAgICAgcG9zaXRpb25zW2ldLAogICAgICBwb3NpdGlvbnNbaSArIDFdCiAgICApOwogIH0KICByZXR1cm4gdXZzOwp9OwpzZWxmLnppZ1phZ0RlY29kZSA9ICh2YWx1ZSkgPT4gewogIHJldHVybiB2YWx1ZSA+PiAxIF4gLSh2YWx1ZSAmIDEpOwp9OwpzZWxmLmRlY29kZUluZGljZXMgPSAoaW5kaWNlcykgPT4gewogIGxldCBoaWdoZXN0ID0gMDsKICBmb3IgKGxldCBpID0gMDsgaSA8IGluZGljZXMubGVuZ3RoOyArK2kpIHsKICAgIGxldCBjb2RlID0gaW5kaWNlc1tpXTsKICAgIGluZGljZXNbaV0gPSBoaWdoZXN0IC0gY29kZTsKICAgIGlmIChjb2RlID09PSAwKSB7CiAgICAgICsraGlnaGVzdDsKICAgIH0KICB9Cn07CmNvbnN0IG1heFNob3J0ID0gMzI3Njc7CmNvbnN0IGhhbGZNYXhTaG9ydCA9IG1heFNob3J0IC8gMiB8IDA7CmNvbnN0IGNsaXBTY3JhdGNoID0gW107CmNvbnN0IGNsaXBTY3JhdGNoMiA9IFtdOwpjb25zdCB1U2NyYXRjaCA9IFtdOwpjb25zdCB2U2NyYXRjaCA9IFtdOwpjb25zdCBoZWlnaHRTY3JhdGNoID0gW107CmNvbnN0IG5vcm1hbFNjcmF0Y2ggPSBbXTsKY29uc3QgaW5kaWNlc1NjcmF0Y2ggPSBbXTsKY29uc3QgZGVjb2RlVGV4Q29vcmRzU2NyYXRjaCA9IG5ldyBWZWN0b3IyKCk7CmNvbnN0IHNjcmF0Y2hNaW5pbXVtID0gbmV3IFZlY3RvcjMoKTsKY29uc3Qgc2NyYXRjaE1heGltdW0gPSBuZXcgVmVjdG9yMygpOwpjb25zdCBjYXJ0b2dyYXBoaWNTY3JhdGNoID0gbmV3IFZlY3RvcjMoKTsKY29uc3QgY2FydGVzaWFuM1NjcmF0Y2ggPSBuZXcgVmVjdG9yMygpOwpjb25zdCBvcmlnaW5DZW50ZXIgPSBuZXcgVmVjdG9yMygwLCAwLCAwKTsKc2VsZi51cHNhbXBsZVF1YW50aXplZFRlcnJhaW5NZXNoID0gKHBhcmFtZXRlcnMpID0+IHsKICBjb25zdCBpc0Vhc3RDaGlsZCA9IHBhcmFtZXRlcnMuaXNFYXN0Q2hpbGQ7CiAgY29uc3QgaXNOb3J0aENoaWxkID0gcGFyYW1ldGVycy5pc05vcnRoQ2hpbGQ7CiAgY29uc3QgbWluVSA9IGlzRWFzdENoaWxkID8gaGFsZk1heFNob3J0IDogMDsKICBjb25zdCBtYXhVID0gaXNFYXN0Q2hpbGQgPyBtYXhTaG9ydCA6IGhhbGZNYXhTaG9ydDsKICBjb25zdCBtaW5WID0gaXNOb3J0aENoaWxkID8gaGFsZk1heFNob3J0IDogMDsKICBjb25zdCBtYXhWID0gaXNOb3J0aENoaWxkID8gbWF4U2hvcnQgOiBoYWxmTWF4U2hvcnQ7CiAgY29uc3QgdUJ1ZmZlciA9IHVTY3JhdGNoOwogIGNvbnN0IHZCdWZmZXIgPSB2U2NyYXRjaDsKICBjb25zdCBoZWlnaHRCdWZmZXIgPSBoZWlnaHRTY3JhdGNoOwogIGNvbnN0IG5vcm1hbEJ1ZmZlciA9IG5vcm1hbFNjcmF0Y2g7CiAgY29uc3QgaW5kaWNlcyA9IGluZGljZXNTY3JhdGNoOwogIHVCdWZmZXIubGVuZ3RoID0gMDsKICB2QnVmZmVyLmxlbmd0aCA9IDA7CiAgaGVpZ2h0QnVmZmVyLmxlbmd0aCA9IDA7CiAgbm9ybWFsQnVmZmVyLmxlbmd0aCA9IDA7CiAgaW5kaWNlcy5sZW5ndGggPSAwOwogIGNvbnN0IHZlcnRleE1hcCA9IHt9OwogIGNvbnN0IHBhcmVudFZlcnRpY2VzID0gcGFyYW1ldGVycy52ZXJ0aWNlczsKICBsZXQgcGFyZW50SW5kaWNlcyA9IHBhcmFtZXRlcnMuaW5kaWNlczsKICBwYXJlbnRJbmRpY2VzID0gcGFyZW50SW5kaWNlcy5zdWJhcnJheSgwLCBwYXJhbWV0ZXJzLmluZGV4Q291bnRXaXRob3V0U2tpcnRzKTsKICBsZXQgdmVydGV4Q291bnQgPSAwOwogIGNvbnN0IHF1YW50aXplZFZlcnRleENvdW50ID0gcGFyYW1ldGVycy52ZXJ0ZXhDb3VudFdpdGhvdXRTa2lydHM7CiAgY29uc3QgcGFyZW50TWluaW11bUhlaWdodCA9IHBhcmFtZXRlcnMubWluaW11bUhlaWdodDsKICBjb25zdCBwYXJlbnRNYXhpbXVtSGVpZ2h0ID0gcGFyYW1ldGVycy5tYXhpbXVtSGVpZ2h0OwogIGNvbnN0IHBhcmVudFVCdWZmZXIgPSBuZXcgQXJyYXkocXVhbnRpemVkVmVydGV4Q291bnQpOwogIGNvbnN0IHBhcmVudFZCdWZmZXIgPSBuZXcgQXJyYXkocXVhbnRpemVkVmVydGV4Q291bnQpOwogIGNvbnN0IHBhcmVudEhlaWdodEJ1ZmZlciA9IG5ldyBBcnJheShxdWFudGl6ZWRWZXJ0ZXhDb3VudCk7CiAgY29uc3QgcGFyZW50Tm9ybWFsQnVmZmVyID0gdm9pZCAwOwogIGNvbnN0IHRocmVzaG9sZCA9IDIwOwogIGxldCBoZWlnaHQ7CiAgbGV0IGk7CiAgbGV0IG47CiAgbGV0IHU7CiAgbGV0IHY7CiAgZm9yIChpID0gMCwgbiA9IDA7IGkgPCBxdWFudGl6ZWRWZXJ0ZXhDb3VudDsgKytpLCBuICs9IDIpIHsKICAgIGNvbnN0IHRleENvb3JkcyA9IHNlbGYuZGVjb2RlVGV4dHVyZUNvb3JkaW5hdGVzKHBhcmVudFZlcnRpY2VzLCBpLCBkZWNvZGVUZXhDb29yZHNTY3JhdGNoKTsKICAgIGhlaWdodCA9IHNlbGYuZGVjb2RlSGVpZ2h0KHBhcmVudFZlcnRpY2VzLCBpKTsKICAgIHUgPSBNYXRoVXRpbHMuY2xhbXAodGV4Q29vcmRzLnggKiBtYXhTaG9ydCB8IDAsIDAsIG1heFNob3J0KTsKICAgIHYgPSBNYXRoVXRpbHMuY2xhbXAodGV4Q29vcmRzLnkgKiBtYXhTaG9ydCB8IDAsIDAsIG1heFNob3J0KTsKICAgIHBhcmVudEhlaWdodEJ1ZmZlcltpXSA9IE1hdGhVdGlscy5jbGFtcCgKICAgICAgKGhlaWdodCAtIHBhcmVudE1pbmltdW1IZWlnaHQpIC8gKHBhcmVudE1heGltdW1IZWlnaHQgLSBwYXJlbnRNaW5pbXVtSGVpZ2h0KSAqIG1heFNob3J0IHwgMCwKICAgICAgMCwKICAgICAgbWF4U2hvcnQKICAgICk7CiAgICBpZiAodSA8IHRocmVzaG9sZCkgewogICAgICB1ID0gMDsKICAgIH0KICAgIGlmICh2IDwgdGhyZXNob2xkKSB7CiAgICAgIHYgPSAwOwogICAgfQogICAgaWYgKG1heFNob3J0IC0gdSA8IHRocmVzaG9sZCkgewogICAgICB1ID0gbWF4U2hvcnQ7CiAgICB9CiAgICBpZiAobWF4U2hvcnQgLSB2IDwgdGhyZXNob2xkKSB7CiAgICAgIHYgPSBtYXhTaG9ydDsKICAgIH0KICAgIHBhcmVudFVCdWZmZXJbaV0gPSB1OwogICAgcGFyZW50VkJ1ZmZlcltpXSA9IHY7CiAgICBpZiAoKGlzRWFzdENoaWxkICYmIHUgPj0gaGFsZk1heFNob3J0IHx8ICFpc0Vhc3RDaGlsZCAmJiB1IDw9IGhhbGZNYXhTaG9ydCkgJiYgKGlzTm9ydGhDaGlsZCAmJiB2ID49IGhhbGZNYXhTaG9ydCB8fCAhaXNOb3J0aENoaWxkICYmIHYgPD0gaGFsZk1heFNob3J0KSkgewogICAgICB2ZXJ0ZXhNYXBbaV0gPSB2ZXJ0ZXhDb3VudDsKICAgICAgdUJ1ZmZlci5wdXNoKHUpOwogICAgICB2QnVmZmVyLnB1c2godik7CiAgICAgIGhlaWdodEJ1ZmZlci5wdXNoKHBhcmVudEhlaWdodEJ1ZmZlcltpXSk7CiAgICAgICsrdmVydGV4Q291bnQ7CiAgICB9CiAgfQogIGNvbnN0IHRyaWFuZ2xlVmVydGljZXMgPSBbXTsKICB0cmlhbmdsZVZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICB0cmlhbmdsZVZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICB0cmlhbmdsZVZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICBjb25zdCBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlcyA9IFtdOwogIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzLnB1c2gobmV3IFZlcnRleCgpKTsKICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlcy5wdXNoKG5ldyBWZXJ0ZXgoKSk7CiAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXMucHVzaChuZXcgVmVydGV4KCkpOwogIGxldCBjbGlwcGVkSW5kZXg7CiAgbGV0IGNsaXBwZWQyOwogIGZvciAoaSA9IDA7IGkgPCBwYXJlbnRJbmRpY2VzLmxlbmd0aDsgaSArPSAzKSB7CiAgICBjb25zdCBpMCA9IHBhcmVudEluZGljZXNbaV07CiAgICBjb25zdCBpMSA9IHBhcmVudEluZGljZXNbaSArIDFdOwogICAgY29uc3QgaTIgPSBwYXJlbnRJbmRpY2VzW2kgKyAyXTsKICAgIGNvbnN0IHUwID0gcGFyZW50VUJ1ZmZlcltpMF07CiAgICBjb25zdCB1MSA9IHBhcmVudFVCdWZmZXJbaTFdOwogICAgY29uc3QgdTIgPSBwYXJlbnRVQnVmZmVyW2kyXTsKICAgIHRyaWFuZ2xlVmVydGljZXNbMF0uaW5pdGlhbGl6ZUluZGV4ZWQoCiAgICAgIHBhcmVudFVCdWZmZXIsCiAgICAgIHBhcmVudFZCdWZmZXIsCiAgICAgIHBhcmVudEhlaWdodEJ1ZmZlciwKICAgICAgcGFyZW50Tm9ybWFsQnVmZmVyLAogICAgICBpMAogICAgKTsKICAgIHRyaWFuZ2xlVmVydGljZXNbMV0uaW5pdGlhbGl6ZUluZGV4ZWQoCiAgICAgIHBhcmVudFVCdWZmZXIsCiAgICAgIHBhcmVudFZCdWZmZXIsCiAgICAgIHBhcmVudEhlaWdodEJ1ZmZlciwKICAgICAgcGFyZW50Tm9ybWFsQnVmZmVyLAogICAgICBpMQogICAgKTsKICAgIHRyaWFuZ2xlVmVydGljZXNbMl0uaW5pdGlhbGl6ZUluZGV4ZWQoCiAgICAgIHBhcmVudFVCdWZmZXIsCiAgICAgIHBhcmVudFZCdWZmZXIsCiAgICAgIHBhcmVudEhlaWdodEJ1ZmZlciwKICAgICAgcGFyZW50Tm9ybWFsQnVmZmVyLAogICAgICBpMgogICAgKTsKICAgIGNvbnN0IGNsaXBwZWQgPSBJbnRlcnNlY3Rpb25zMkQuY2xpcFRyaWFuZ2xlQXRBeGlzQWxpZ25lZFRocmVzaG9sZCgKICAgICAgaGFsZk1heFNob3J0LAogICAgICBpc0Vhc3RDaGlsZCwKICAgICAgdTAsCiAgICAgIHUxLAogICAgICB1MiwKICAgICAgY2xpcFNjcmF0Y2gKICAgICk7CiAgICBjbGlwcGVkSW5kZXggPSAwOwogICAgaWYgKGNsaXBwZWRJbmRleCA+PSBjbGlwcGVkLmxlbmd0aCkgewogICAgICBjb250aW51ZTsKICAgIH0KICAgIGNsaXBwZWRJbmRleCA9IGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzBdLmluaXRpYWxpemVGcm9tQ2xpcFJlc3VsdCgKICAgICAgY2xpcHBlZCwKICAgICAgY2xpcHBlZEluZGV4LAogICAgICB0cmlhbmdsZVZlcnRpY2VzCiAgICApOwogICAgaWYgKGNsaXBwZWRJbmRleCA+PSBjbGlwcGVkLmxlbmd0aCkgewogICAgICBjb250aW51ZTsKICAgIH0KICAgIGNsaXBwZWRJbmRleCA9IGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzFdLmluaXRpYWxpemVGcm9tQ2xpcFJlc3VsdCgKICAgICAgY2xpcHBlZCwKICAgICAgY2xpcHBlZEluZGV4LAogICAgICB0cmlhbmdsZVZlcnRpY2VzCiAgICApOwogICAgaWYgKGNsaXBwZWRJbmRleCA+PSBjbGlwcGVkLmxlbmd0aCkgewogICAgICBjb250aW51ZTsKICAgIH0KICAgIGNsaXBwZWRJbmRleCA9IGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzJdLmluaXRpYWxpemVGcm9tQ2xpcFJlc3VsdCgKICAgICAgY2xpcHBlZCwKICAgICAgY2xpcHBlZEluZGV4LAogICAgICB0cmlhbmdsZVZlcnRpY2VzCiAgICApOwogICAgY2xpcHBlZDIgPSBJbnRlcnNlY3Rpb25zMkQuY2xpcFRyaWFuZ2xlQXRBeGlzQWxpZ25lZFRocmVzaG9sZCgKICAgICAgaGFsZk1heFNob3J0LAogICAgICBpc05vcnRoQ2hpbGQsCiAgICAgIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzBdLmdldFYoKSwKICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMV0uZ2V0VigpLAogICAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlc1syXS5nZXRWKCksCiAgICAgIGNsaXBTY3JhdGNoMgogICAgKTsKICAgIGFkZENsaXBwZWRQb2x5Z29uKAogICAgICB1QnVmZmVyLAogICAgICB2QnVmZmVyLAogICAgICBoZWlnaHRCdWZmZXIsCiAgICAgIG5vcm1hbEJ1ZmZlciwKICAgICAgaW5kaWNlcywKICAgICAgdmVydGV4TWFwLAogICAgICBjbGlwcGVkMiwKICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXMsCiAgICAgIGZhbHNlCiAgICApOwogICAgaWYgKGNsaXBwZWRJbmRleCA8IGNsaXBwZWQubGVuZ3RoKSB7CiAgICAgIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzJdLmNsb25lKGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzFdKTsKICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMl0uaW5pdGlhbGl6ZUZyb21DbGlwUmVzdWx0KAogICAgICAgIGNsaXBwZWQsCiAgICAgICAgY2xpcHBlZEluZGV4LAogICAgICAgIHRyaWFuZ2xlVmVydGljZXMKICAgICAgKTsKICAgICAgY2xpcHBlZDIgPSBJbnRlcnNlY3Rpb25zMkQuY2xpcFRyaWFuZ2xlQXRBeGlzQWxpZ25lZFRocmVzaG9sZCgKICAgICAgICBoYWxmTWF4U2hvcnQsCiAgICAgICAgaXNOb3J0aENoaWxkLAogICAgICAgIGNsaXBwZWRUcmlhbmdsZVZlcnRpY2VzWzBdLmdldFYoKSwKICAgICAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlc1sxXS5nZXRWKCksCiAgICAgICAgY2xpcHBlZFRyaWFuZ2xlVmVydGljZXNbMl0uZ2V0VigpLAogICAgICAgIGNsaXBTY3JhdGNoMgogICAgICApOwogICAgICBhZGRDbGlwcGVkUG9seWdvbigKICAgICAgICB1QnVmZmVyLAogICAgICAgIHZCdWZmZXIsCiAgICAgICAgaGVpZ2h0QnVmZmVyLAogICAgICAgIG5vcm1hbEJ1ZmZlciwKICAgICAgICBpbmRpY2VzLAogICAgICAgIHZlcnRleE1hcCwKICAgICAgICBjbGlwcGVkMiwKICAgICAgICBjbGlwcGVkVHJpYW5nbGVWZXJ0aWNlcywKICAgICAgICBmYWxzZQogICAgICApOwogICAgfQogIH0KICBjb25zdCB1T2Zmc2V0ID0gaXNFYXN0Q2hpbGQgPyAtbWF4U2hvcnQgOiAwOwogIGNvbnN0IHZPZmZzZXQgPSBpc05vcnRoQ2hpbGQgPyAtbWF4U2hvcnQgOiAwOwogIGNvbnN0IHdlc3RJbmRpY2VzID0gW107CiAgY29uc3Qgc291dGhJbmRpY2VzID0gW107CiAgY29uc3QgZWFzdEluZGljZXMgPSBbXTsKICBjb25zdCBub3J0aEluZGljZXMgPSBbXTsKICBsZXQgbWluaW11bUhlaWdodCA9IE51bWJlci5NQVhfVkFMVUU7CiAgbGV0IG1heGltdW1IZWlnaHQgPSAtbWluaW11bUhlaWdodDsKICBjb25zdCByZWN0YW5nbGUgPSBSZWN0YW5nbGUuY2xvbmUocGFyYW1ldGVycy5jaGlsZFJlY3RhbmdsZSk7CiAgcmVjdGFuZ2xlLmVhc3Q7CiAgcmVjdGFuZ2xlLndlc3Q7CiAgZm9yIChpID0gMDsgaSA8IHVCdWZmZXIubGVuZ3RoOyBpKyspIHsKICAgIHUgPSBNYXRoLnJvdW5kKHVCdWZmZXJbaV0pOwogICAgaWYgKHUgPD0gbWluVSkgewogICAgICB3ZXN0SW5kaWNlcy5wdXNoKGkpOwogICAgICB1ID0gMDsKICAgIH0gZWxzZSBpZiAodSA+PSBtYXhVKSB7CiAgICAgIGVhc3RJbmRpY2VzLnB1c2goaSk7CiAgICAgIHUgPSBtYXhTaG9ydDsKICAgIH0gZWxzZSB7CiAgICAgIHUgPSB1ICogMiArIHVPZmZzZXQ7CiAgICB9CiAgICB1QnVmZmVyW2ldID0gdTsKICAgIHYgPSBNYXRoLnJvdW5kKHZCdWZmZXJbaV0pOwogICAgaWYgKHYgPD0gbWluVikgewogICAgICBzb3V0aEluZGljZXMucHVzaChpKTsKICAgICAgdiA9IDA7CiAgICB9IGVsc2UgaWYgKHYgPj0gbWF4VikgewogICAgICBub3J0aEluZGljZXMucHVzaChpKTsKICAgICAgdiA9IG1heFNob3J0OwogICAgfSBlbHNlIHsKICAgICAgdiA9IHYgKiAyICsgdk9mZnNldDsKICAgIH0KICAgIHZCdWZmZXJbaV0gPSB2OwogICAgaGVpZ2h0ID0gTWF0aFV0aWxzLmxlcnAocGFyZW50TWluaW11bUhlaWdodCwgcGFyZW50TWF4aW11bUhlaWdodCwgaGVpZ2h0QnVmZmVyW2ldIC8gbWF4U2hvcnQpOwogICAgbWluaW11bUhlaWdodCA9IE1hdGgubWluKG1pbmltdW1IZWlnaHQsIGhlaWdodCk7CiAgICBtYXhpbXVtSGVpZ2h0ID0gTWF0aC5tYXgobWF4aW11bUhlaWdodCwgaGVpZ2h0KTsKICAgIGhlaWdodEJ1ZmZlcltpXSA9IGhlaWdodDsKICB9CiAgY29uc3QgaGVpZ2h0UmFuZ2UgPSBtYXhpbXVtSGVpZ2h0IC0gbWluaW11bUhlaWdodDsKICBjb25zdCB2ZXJ0aWNlcyA9IG5ldyBVaW50MTZBcnJheSgKICAgIHVCdWZmZXIubGVuZ3RoICsgdkJ1ZmZlci5sZW5ndGggKyBoZWlnaHRCdWZmZXIubGVuZ3RoCiAgKTsKICBmb3IgKGkgPSAwOyBpIDwgdUJ1ZmZlci5sZW5ndGg7ICsraSkgewogICAgdmVydGljZXNbaV0gPSB1QnVmZmVyW2ldOwogIH0KICBsZXQgc3RhcnQgPSB1QnVmZmVyLmxlbmd0aDsKICBmb3IgKGkgPSAwOyBpIDwgdkJ1ZmZlci5sZW5ndGg7ICsraSkgewogICAgdmVydGljZXNbc3RhcnQgKyBpXSA9IHZCdWZmZXJbaV07CiAgfQogIHN0YXJ0ICs9IHZCdWZmZXIubGVuZ3RoOwogIGZvciAoaSA9IDA7IGkgPCBoZWlnaHRCdWZmZXIubGVuZ3RoOyArK2kpIHsKICAgIGNvbnN0IGhlaWdodDIgPSBtYXhTaG9ydCAqIChoZWlnaHRCdWZmZXJbaV0gLSBtaW5pbXVtSGVpZ2h0KSAvIGhlaWdodFJhbmdlOwogICAgdmVydGljZXNbc3RhcnQgKyBpXSA9IGhlaWdodDI7CiAgfQogIGNvbnN0IGluZGljZXNUeXBlZEFycmF5ID0gSW5kZXhEYXRhdHlwZSQxLmNyZWF0ZVR5cGVkQXJyYXkoCiAgICB1QnVmZmVyLmxlbmd0aCwKICAgIGluZGljZXMKICApOwogIGNvbnN0IHJlc3VsdCA9IHsKICAgIHZlcnRpY2VzOiB2ZXJ0aWNlcy5idWZmZXIsCiAgICBpbmRpY2VzOiBpbmRpY2VzVHlwZWRBcnJheS5idWZmZXIsCiAgICBtaW5pbXVtSGVpZ2h0LAogICAgbWF4aW11bUhlaWdodCwKICAgIHdlc3RJbmRpY2VzLAogICAgc291dGhJbmRpY2VzLAogICAgZWFzdEluZGljZXMsCiAgICBub3J0aEluZGljZXMKICB9OwogIGNvbnN0IHRyYW5zZmVyYWJsZURhdGEgPSBbCiAgICB2ZXJ0aWNlcy5idWZmZXIsCiAgICBpbmRpY2VzVHlwZWRBcnJheS5idWZmZXIKICBdOwogIGNvbnN0IHR5cGUgPSBwYXJhbWV0ZXJzLnR5cGU7CiAgc2VsZi5wb3N0TWVzc2FnZSh7CiAgICB0eXBlOiAidGVycmFpbkRhdGFVcHNhbXBsZWQiLAogICAgdGlsZUtleTogdHlwZSArICItIiArIHBhcmFtZXRlcnMudGlsZUtleSwKICAgIGNvbnRlbnQ6IHJlc3VsdAogIH0sIHRyYW5zZmVyYWJsZURhdGEpOwp9OwpzZWxmLmRlY29kZVRleHR1cmVDb29yZGluYXRlcyA9IChidWZmZXIsIGluZGV4LCByZXN1bHQpID0+IHsKICBpZiAoIXJlc3VsdCkgewogICAgcmVzdWx0ID0gbmV3IFZlY3RvcjIoKTsKICB9CiAgaW5kZXggKj0gNjsKICByZXN1bHQueCA9IGJ1ZmZlcltpbmRleCArIDRdOwogIHJlc3VsdC55ID0gYnVmZmVyW2luZGV4ICsgNV07CiAgcmV0dXJuIHJlc3VsdDsKfTsKc2VsZi5kZWNvZGVIZWlnaHQgPSAoYnVmZmVyLCBpbmRleCkgPT4gewogIGluZGV4ICo9IDY7CiAgcmV0dXJuIGJ1ZmZlcltpbmRleCArIDNdOwp9OwpzZWxmLmNyZWF0ZVZlcnRpY2VzRnJvbVF1YW50aXplZFRlcnJhaW5NZXNoID0gKHBhcmFtZXRlcnMpID0+IHsKICBjb25zdCB0aWxlS2V5ID0gcGFyYW1ldGVycy50aWxlS2V5OwogIGNvbnN0IHRpbGVDZW50ZXIgPSBwYXJhbWV0ZXJzLnRpbGVDZW50ZXI7CiAgY29uc3QgcXVhbnRpemVkVmVydGljZXMgPSBwYXJhbWV0ZXJzLnF1YW50aXplZFZlcnRpY2VzOwogIGNvbnN0IHF1YW50aXplZFZlcnRleENvdW50ID0gcXVhbnRpemVkVmVydGljZXMubGVuZ3RoIC8gMzsKICBjb25zdCBlZGdlVmVydGV4Q291bnQgPSBwYXJhbWV0ZXJzLndlc3RJbmRpY2VzLmxlbmd0aCArIHBhcmFtZXRlcnMuZWFzdEluZGljZXMubGVuZ3RoICsgcGFyYW1ldGVycy5zb3V0aEluZGljZXMubGVuZ3RoICsgcGFyYW1ldGVycy5ub3J0aEluZGljZXMubGVuZ3RoOwogIGNvbnN0IHJlY3RhbmdsZSA9IFJlY3RhbmdsZS5jbG9uZShwYXJhbWV0ZXJzLnJlY3RhbmdsZSk7CiAgY29uc3Qgd2VzdCA9IHJlY3RhbmdsZS53ZXN0OwogIGNvbnN0IHNvdXRoID0gcmVjdGFuZ2xlLnNvdXRoOwogIGNvbnN0IGVhc3QgPSByZWN0YW5nbGUuZWFzdDsKICBjb25zdCBub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICBjb25zdCBlbGxpcHNvaWQgPSBFbGxpcHNvaWQuY2xvbmUocGFyYW1ldGVycy5lbGxpcHNvaWQpOwogIGNvbnN0IG1pbmltdW1IZWlnaHQgPSBwYXJhbWV0ZXJzLm1pbmltdW1IZWlnaHQ7CiAgY29uc3QgbWF4aW11bUhlaWdodCA9IHBhcmFtZXRlcnMubWF4aW11bUhlaWdodDsKICBjb25zdCB1QnVmZmVyID0gcXVhbnRpemVkVmVydGljZXMuc3ViYXJyYXkoMCwgcXVhbnRpemVkVmVydGV4Q291bnQpOwogIGNvbnN0IHZCdWZmZXIgPSBxdWFudGl6ZWRWZXJ0aWNlcy5zdWJhcnJheSgKICAgIHF1YW50aXplZFZlcnRleENvdW50LAogICAgMiAqIHF1YW50aXplZFZlcnRleENvdW50CiAgKTsKICBjb25zdCBoZWlnaHRCdWZmZXIgPSBxdWFudGl6ZWRWZXJ0aWNlcy5zdWJhcnJheSgKICAgIHF1YW50aXplZFZlcnRleENvdW50ICogMiwKICAgIDMgKiBxdWFudGl6ZWRWZXJ0ZXhDb3VudAogICk7CiAgY29uc3QgdXZzID0gbmV3IEFycmF5KHF1YW50aXplZFZlcnRleENvdW50KTsKICBjb25zdCBoZWlnaHRzID0gbmV3IEFycmF5KHF1YW50aXplZFZlcnRleENvdW50KTsKICBjb25zdCBwb3NpdGlvbnMgPSBuZXcgQXJyYXkocXVhbnRpemVkVmVydGV4Q291bnQpOwogIGNvbnN0IG1pbmltdW0gPSBzY3JhdGNoTWluaW11bTsKICBtaW5pbXVtLnggPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgbWluaW11bS55ID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogIG1pbmltdW0ueiA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICBjb25zdCBtYXhpbXVtID0gc2NyYXRjaE1heGltdW07CiAgbWF4aW11bS54ID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogIG1heGltdW0ueSA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKICBtYXhpbXVtLnogPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgbGV0IG1pbkxvbmdpdHVkZSA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICBsZXQgbWF4TG9uZ2l0dWRlID0gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZOwogIGxldCBtaW5MYXRpdHVkZSA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICBsZXQgbWF4TGF0aXR1ZGUgPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBxdWFudGl6ZWRWZXJ0ZXhDb3VudDsgaSsrKSB7CiAgICBjb25zdCByYXdVID0gdUJ1ZmZlcltpXTsKICAgIGNvbnN0IHJhd1YgPSB2QnVmZmVyW2ldOwogICAgY29uc3QgdSA9IHJhd1UgLyBtYXhTaG9ydDsKICAgIGNvbnN0IHYgPSByYXdWIC8gbWF4U2hvcnQ7CiAgICBjb25zdCBoZWlnaHQgPSBNYXRoVXRpbHMubGVycCgKICAgICAgbWluaW11bUhlaWdodCwKICAgICAgbWF4aW11bUhlaWdodCwKICAgICAgaGVpZ2h0QnVmZmVyW2ldIC8gbWF4U2hvcnQKICAgICk7CiAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLnggPSBNYXRoVXRpbHMubGVycCh3ZXN0LCBlYXN0LCB1KTsKICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gueSA9IE1hdGhVdGlscy5sZXJwKHNvdXRoLCBub3J0aCwgdik7CiAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLnogPSBoZWlnaHQ7CiAgICBtaW5Mb25naXR1ZGUgPSBNYXRoLm1pbihjYXJ0b2dyYXBoaWNTY3JhdGNoLngsIG1pbkxvbmdpdHVkZSk7CiAgICBtYXhMb25naXR1ZGUgPSBNYXRoLm1heChjYXJ0b2dyYXBoaWNTY3JhdGNoLngsIG1heExvbmdpdHVkZSk7CiAgICBtaW5MYXRpdHVkZSA9IE1hdGgubWluKGNhcnRvZ3JhcGhpY1NjcmF0Y2gueSwgbWluTGF0aXR1ZGUpOwogICAgbWF4TGF0aXR1ZGUgPSBNYXRoLm1heChjYXJ0b2dyYXBoaWNTY3JhdGNoLnksIG1heExhdGl0dWRlKTsKICAgIGxldCBwb3NpdGlvbjsKICAgIGlmIChkZWZpbmVkKGVsbGlwc29pZCkpIHsKICAgICAgcG9zaXRpb24gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oY2FydG9ncmFwaGljU2NyYXRjaCk7CiAgICB9IGVsc2UgewogICAgICBwb3NpdGlvbiA9IG5ldyBWZWN0b3IzKHUgLSAwLjUsIHYgLSAwLjUsIGhlaWdodCk7CiAgICB9CiAgICB1dnNbaV0gPSBuZXcgVmVjdG9yMih1LCB2KTsKICAgIGhlaWdodHNbaV0gPSBoZWlnaHQ7CiAgICBwb3NpdGlvbnNbaV0gPSBwb3NpdGlvbjsKICB9CiAgY29uc3Qgd2VzdEluZGljZXNTb3V0aFRvTm9ydGggPSBwYXJhbWV0ZXJzLndlc3RJbmRpY2VzLnNsaWNlKCkuc29ydCgoYSwgYikgPT4gewogICAgcmV0dXJuIHV2c1thXS55IC0gdXZzW2JdLnk7CiAgfSk7CiAgY29uc3QgZWFzdEluZGljZXNOb3J0aFRvU291dGggPSBwYXJhbWV0ZXJzLmVhc3RJbmRpY2VzLnNsaWNlKCkuc29ydCgoYSwgYikgPT4gewogICAgcmV0dXJuIHV2c1tiXS55IC0gdXZzW2FdLnk7CiAgfSk7CiAgY29uc3Qgc291dGhJbmRpY2VzRWFzdFRvV2VzdCA9IHBhcmFtZXRlcnMuc291dGhJbmRpY2VzLnNsaWNlKCkuc29ydCgoYSwgYikgPT4gewogICAgcmV0dXJuIHV2c1tiXS54IC0gdXZzW2FdLng7CiAgfSk7CiAgY29uc3Qgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdCA9IHBhcmFtZXRlcnMubm9ydGhJbmRpY2VzLnNsaWNlKCkuc29ydCgoYSwgYikgPT4gewogICAgcmV0dXJuIHV2c1thXS54IC0gdXZzW2JdLng7CiAgfSk7CiAgY29uc3QgbGV2ZWwgPSBwYXJhbWV0ZXJzLmxldmVsOwogIGNvbnN0IHNraXJ0RGVwdGggPSA2MzdlNCAvICgyIDw8IGxldmVsKSAvIDI7CiAgY29uc3QgZWRnZVRyaWFuZ2xlQ291bnQgPSBNYXRoLm1heCgwLCAoZWRnZVZlcnRleENvdW50IC0gNCkgKiAyKTsKICBjb25zdCBpbmRleEJ1ZmZlckxlbmd0aCA9IHBhcmFtZXRlcnMuaW5kaWNlcy5sZW5ndGggKyBlZGdlVHJpYW5nbGVDb3VudCAqIDM7CiAgY29uc3QgaW5kZXhCdWZmZXIgPSBJbmRleERhdGF0eXBlJDEuY3JlYXRlVHlwZWRBcnJheSgKICAgIHF1YW50aXplZFZlcnRleENvdW50ICsgZWRnZVRyaWFuZ2xlQ291bnQsCiAgICBpbmRleEJ1ZmZlckxlbmd0aAogICk7CiAgaW5kZXhCdWZmZXIuc2V0KHBhcmFtZXRlcnMuaW5kaWNlcywgMCk7CiAgY29uc3QgcGVyY2VudGFnZSA9IDFlLTQ7CiAgY29uc3QgbG9uT2Zmc2V0ID0gKG1heExvbmdpdHVkZSAtIG1pbkxvbmdpdHVkZSkgKiBwZXJjZW50YWdlOwogIGNvbnN0IGxhdE9mZnNldCA9IChtYXhMYXRpdHVkZSAtIG1pbkxhdGl0dWRlKSAqIHBlcmNlbnRhZ2U7CiAgY29uc3Qgd2VzdExvbmdpdHVkZU9mZnNldCA9IC1sb25PZmZzZXQ7CiAgY29uc3Qgd2VzdExhdGl0dWRlT2Zmc2V0ID0gMDsKICBjb25zdCBlYXN0TG9uZ2l0dWRlT2Zmc2V0ID0gbG9uT2Zmc2V0OwogIGNvbnN0IGVhc3RMYXRpdHVkZU9mZnNldCA9IDA7CiAgY29uc3Qgbm9ydGhMb25naXR1ZGVPZmZzZXQgPSAwOwogIGNvbnN0IG5vcnRoTGF0aXR1ZGVPZmZzZXQgPSBsYXRPZmZzZXQ7CiAgY29uc3Qgc291dGhMb25naXR1ZGVPZmZzZXQgPSAwOwogIGNvbnN0IHNvdXRoTGF0aXR1ZGVPZmZzZXQgPSAtbGF0T2Zmc2V0OwogIGxldCBidWZmZXJJbmRleCA9IDA7CiAgY29uc3Qgc2l6ZSA9IHF1YW50aXplZFZlcnRleENvdW50ICogNiArIGVkZ2VWZXJ0ZXhDb3VudCAqIDY7CiAgY29uc3QgdmVydGV4QnVmZmVyID0gbmV3IEZsb2F0MzJBcnJheShzaXplKTsKICBmb3IgKGxldCBpID0gMCwgbCA9IHF1YW50aXplZFZlcnRleENvdW50OyBpIDwgbDsgaSsrKSB7CiAgICBidWZmZXJJbmRleCA9IHNlbGYuZW5jb2RlKAogICAgICB2ZXJ0ZXhCdWZmZXIsCiAgICAgIGJ1ZmZlckluZGV4LAogICAgICBkZWZpbmVkKGVsbGlwc29pZCkgPyB0aWxlQ2VudGVyIDogb3JpZ2luQ2VudGVyLAogICAgICBwb3NpdGlvbnNbaV0sCiAgICAgIHV2c1tpXSwKICAgICAgaGVpZ2h0c1tpXQogICAgKTsKICB9CiAgbGV0IG9mZnNldCA9IHBhcmFtZXRlcnMuaW5kaWNlcy5sZW5ndGg7CiAgbGV0IHZlcnRleEluZGV4ID0gcG9zaXRpb25zLmxlbmd0aDsKICBsZXQgb2Zmc2V0QW5kQnVmZmVySW5kZXggPSBzZWxmLmFkZFNraXJ0KAogICAgdmVydGV4QnVmZmVyLAogICAgdmVydGV4SW5kZXgsCiAgICBpbmRleEJ1ZmZlciwKICAgIHRpbGVDZW50ZXIsCiAgICBidWZmZXJJbmRleCwKICAgIHV2cywKICAgIGhlaWdodHMsCiAgICB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCwKICAgIHNraXJ0RGVwdGgsCiAgICBvZmZzZXQsCiAgICB3ZXN0TG9uZ2l0dWRlT2Zmc2V0LAogICAgd2VzdExhdGl0dWRlT2Zmc2V0LAogICAgcmVjdGFuZ2xlLAogICAgZWxsaXBzb2lkCiAgKTsKICBvZmZzZXQgPSBvZmZzZXRBbmRCdWZmZXJJbmRleC5vZmZzZXQ7CiAgYnVmZmVySW5kZXggPSBvZmZzZXRBbmRCdWZmZXJJbmRleC5idWZmZXJJbmRleDsKICB2ZXJ0ZXhJbmRleCArPSB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aC5sZW5ndGg7CiAgb2Zmc2V0QW5kQnVmZmVySW5kZXggPSBzZWxmLmFkZFNraXJ0KAogICAgdmVydGV4QnVmZmVyLAogICAgdmVydGV4SW5kZXgsCiAgICBpbmRleEJ1ZmZlciwKICAgIHRpbGVDZW50ZXIsCiAgICBidWZmZXJJbmRleCwKICAgIHV2cywKICAgIGhlaWdodHMsCiAgICBzb3V0aEluZGljZXNFYXN0VG9XZXN0LAogICAgc2tpcnREZXB0aCwKICAgIG9mZnNldCwKICAgIHNvdXRoTG9uZ2l0dWRlT2Zmc2V0LAogICAgc291dGhMYXRpdHVkZU9mZnNldCwKICAgIHJlY3RhbmdsZSwKICAgIGVsbGlwc29pZAogICk7CiAgb2Zmc2V0ID0gb2Zmc2V0QW5kQnVmZmVySW5kZXgub2Zmc2V0OwogIGJ1ZmZlckluZGV4ID0gb2Zmc2V0QW5kQnVmZmVySW5kZXguYnVmZmVySW5kZXg7CiAgdmVydGV4SW5kZXggKz0gc291dGhJbmRpY2VzRWFzdFRvV2VzdC5sZW5ndGg7CiAgb2Zmc2V0QW5kQnVmZmVySW5kZXggPSBzZWxmLmFkZFNraXJ0KAogICAgdmVydGV4QnVmZmVyLAogICAgdmVydGV4SW5kZXgsCiAgICBpbmRleEJ1ZmZlciwKICAgIHRpbGVDZW50ZXIsCiAgICBidWZmZXJJbmRleCwKICAgIHV2cywKICAgIGhlaWdodHMsCiAgICBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCwKICAgIHNraXJ0RGVwdGgsCiAgICBvZmZzZXQsCiAgICBlYXN0TG9uZ2l0dWRlT2Zmc2V0LAogICAgZWFzdExhdGl0dWRlT2Zmc2V0LAogICAgcmVjdGFuZ2xlLAogICAgZWxsaXBzb2lkCiAgKTsKICBvZmZzZXQgPSBvZmZzZXRBbmRCdWZmZXJJbmRleC5vZmZzZXQ7CiAgYnVmZmVySW5kZXggPSBvZmZzZXRBbmRCdWZmZXJJbmRleC5idWZmZXJJbmRleDsKICB2ZXJ0ZXhJbmRleCArPSBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aC5sZW5ndGg7CiAgc2VsZi5hZGRTa2lydCgKICAgIHZlcnRleEJ1ZmZlciwKICAgIHZlcnRleEluZGV4LAogICAgaW5kZXhCdWZmZXIsCiAgICB0aWxlQ2VudGVyLAogICAgYnVmZmVySW5kZXgsCiAgICB1dnMsCiAgICBoZWlnaHRzLAogICAgbm9ydGhJbmRpY2VzV2VzdFRvRWFzdCwKICAgIHNraXJ0RGVwdGgsCiAgICBvZmZzZXQsCiAgICBub3J0aExvbmdpdHVkZU9mZnNldCwKICAgIG5vcnRoTGF0aXR1ZGVPZmZzZXQsCiAgICByZWN0YW5nbGUsCiAgICBlbGxpcHNvaWQKICApOwogIGNvbnN0IHJlc3VsdCA9IHsKICAgIHZlcnRpY2VzOiB2ZXJ0ZXhCdWZmZXIsCiAgICBidWZmZXJJbmRleCwKICAgIGluZGV4Q291bnRXaXRob3V0U2tpcnRzOiBwYXJhbWV0ZXJzLmluZGljZXMubGVuZ3RoLAogICAgaW5kaWNlczogaW5kZXhCdWZmZXIsCiAgICB3ZXN0SW5kaWNlc1NvdXRoVG9Ob3J0aCwKICAgIHNvdXRoSW5kaWNlc0Vhc3RUb1dlc3QsCiAgICBlYXN0SW5kaWNlc05vcnRoVG9Tb3V0aCwKICAgIG5vcnRoSW5kaWNlc1dlc3RUb0Vhc3QsCiAgICBtaW5pbXVtSGVpZ2h0LAogICAgbWF4aW11bUhlaWdodAogIH07CiAgY29uc3QgdHJhbnNmZXJhYmxlRGF0YSA9IFsKICAgIHZlcnRleEJ1ZmZlci5idWZmZXIsCiAgICBpbmRleEJ1ZmZlci5idWZmZXIKICBdOwogIGNvbnN0IHR5cGUgPSBwYXJhbWV0ZXJzLnR5cGU7CiAgc2VsZi5wb3N0TWVzc2FnZSh7CiAgICB0eXBlOiAidGVycmFpbk1lc2hDcmVhdGVkIiwKICAgIHRpbGVLZXk6IHR5cGUgKyAiLSIgKyB0aWxlS2V5LAogICAgY29udGVudDogcmVzdWx0CiAgfSwgdHJhbnNmZXJhYmxlRGF0YSk7Cn07CnNlbGYuZW5jb2RlID0gKHZlcnRleEJ1ZmZlciwgYnVmZmVySW5kZXgsIGNlbnRlciwgcG9zaXRpb24sIHV2LCBoZWlnaHQpID0+IHsKICBjb25zdCB1ID0gdXYueDsKICBjb25zdCB2ID0gdXYueTsKICBDYXJ0ZXNpYW4zLnN1YnRyYWN0KHBvc2l0aW9uLCBjZW50ZXIsIGNhcnRlc2lhbjNTY3JhdGNoKTsKICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSBjYXJ0ZXNpYW4zU2NyYXRjaC54OwogIHZlcnRleEJ1ZmZlcltidWZmZXJJbmRleCsrXSA9IGNhcnRlc2lhbjNTY3JhdGNoLnk7CiAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gY2FydGVzaWFuM1NjcmF0Y2guejsKICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSBoZWlnaHQ7CiAgdmVydGV4QnVmZmVyW2J1ZmZlckluZGV4KytdID0gdTsKICB2ZXJ0ZXhCdWZmZXJbYnVmZmVySW5kZXgrK10gPSB2OwogIHJldHVybiBidWZmZXJJbmRleDsKfTsKc2VsZi5hZGRTa2lydCA9ICh2ZXJ0ZXhCdWZmZXIsIHZlcnRleEluZGV4LCBpbmRleEJ1ZmZlciwgdGlsZUNlbnRlciwgYnVmZmVySW5kZXgsIHV2cywgaGVpZ2h0cywgc2tpcnRWZXJ0ZXhJbmRpY2VzLCBza2lydEhlaWdodCwgb2Zmc2V0LCBsb25ndGl0dWRlT2Zmc2V0LCBsYXRpdHVkZU9mZnNldCwgcmVjdGFuZ2xlLCBlbGxpcHNvaWQpID0+IHsKICBjb25zdCBub3J0aCA9IHJlY3RhbmdsZS5ub3J0aDsKICBjb25zdCBzb3V0aCA9IHJlY3RhbmdsZS5zb3V0aDsKICBsZXQgZWFzdCA9IHJlY3RhbmdsZS5lYXN0OwogIGNvbnN0IHdlc3QgPSByZWN0YW5nbGUud2VzdDsKICBpZiAoZWFzdCA8IHdlc3QpIHsKICAgIGVhc3QgKz0gQ2VzaXVtTWF0aC5UV09fUEk7CiAgfQogIGNvbnN0IGxlbmd0aCA9IHNraXJ0VmVydGV4SW5kaWNlcy5sZW5ndGg7CiAgbGV0IHByZXZpb3VzSW5kZXggPSBza2lydFZlcnRleEluZGljZXNbMF07CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgY29uc3QgaiA9IHNraXJ0VmVydGV4SW5kaWNlc1tpXTsKICAgIGNvbnN0IGhlaWdodCA9IGhlaWdodHNbal07CiAgICBjb25zdCB1diA9IHV2c1tqXTsKICAgIGlmIChkZWZpbmVkKGVsbGlwc29pZCkpIHsKICAgICAgY2FydG9ncmFwaGljU2NyYXRjaC54ID0gTWF0aFV0aWxzLmxlcnAod2VzdCwgZWFzdCwgdXYueCkgKyBsb25ndGl0dWRlT2Zmc2V0OwogICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLnkgPSBNYXRoVXRpbHMubGVycChzb3V0aCwgbm9ydGgsIHV2LnkpICsgbGF0aXR1ZGVPZmZzZXQ7CiAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2gueiA9IGhlaWdodCAtIHNraXJ0SGVpZ2h0ICogMjsKICAgICAgY29uc3QgcG9zaXRpb24gPSBlbGxpcHNvaWQuY2FydG9ncmFwaGljVG9DYXJ0ZXNpYW4oCiAgICAgICAgY2FydG9ncmFwaGljU2NyYXRjaCwKICAgICAgICBjYXJ0ZXNpYW4zU2NyYXRjaAogICAgICApOwogICAgICBidWZmZXJJbmRleCA9IHNlbGYuZW5jb2RlKAogICAgICAgIHZlcnRleEJ1ZmZlciwKICAgICAgICBidWZmZXJJbmRleCwKICAgICAgICB0aWxlQ2VudGVyLAogICAgICAgIHBvc2l0aW9uLAogICAgICAgIHV2LAogICAgICAgIGNhcnRvZ3JhcGhpY1NjcmF0Y2guegogICAgICApOwogICAgfSBlbHNlIHsKICAgICAgY2FydGVzaWFuM1NjcmF0Y2guc2V0KHV2LnggLSAwLjUsIHV2LnkgLSAwLjUsIGhlaWdodCAtIHNraXJ0SGVpZ2h0ICogMik7CiAgICAgIGJ1ZmZlckluZGV4ID0gc2VsZi5lbmNvZGUoCiAgICAgICAgdmVydGV4QnVmZmVyLAogICAgICAgIGJ1ZmZlckluZGV4LAogICAgICAgIG9yaWdpbkNlbnRlciwKICAgICAgICBjYXJ0ZXNpYW4zU2NyYXRjaCwKICAgICAgICB1diwKICAgICAgICBjYXJ0b2dyYXBoaWNTY3JhdGNoLnoKICAgICAgKTsKICAgIH0KICAgIGlmIChpID09PSAwKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQogICAgY29uc3QgdGwgPSBwcmV2aW91c0luZGV4OwogICAgY29uc3QgYmwgPSB2ZXJ0ZXhJbmRleCArIGkgLSAxOwogICAgY29uc3QgdHIgPSBqOwogICAgY29uc3QgYnIgPSB2ZXJ0ZXhJbmRleCArIGk7CiAgICBpbmRleEJ1ZmZlcltvZmZzZXQrK10gPSB0bDsKICAgIGluZGV4QnVmZmVyW29mZnNldCsrXSA9IHRyOwogICAgaW5kZXhCdWZmZXJbb2Zmc2V0KytdID0gYmw7CiAgICBpbmRleEJ1ZmZlcltvZmZzZXQrK10gPSBibDsKICAgIGluZGV4QnVmZmVyW29mZnNldCsrXSA9IHRyOwogICAgaW5kZXhCdWZmZXJbb2Zmc2V0KytdID0gYnI7CiAgICBwcmV2aW91c0luZGV4ID0gajsKICB9CiAgcmV0dXJuIHsKICAgIG9mZnNldCwKICAgIGJ1ZmZlckluZGV4CiAgfTsKfTsKZnVuY3Rpb24gYWRkQ2xpcHBlZFBvbHlnb24odUJ1ZmZlciwgdkJ1ZmZlciwgaGVpZ2h0QnVmZmVyLCBub3JtYWxCdWZmZXIsIGluZGljZXMsIHZlcnRleE1hcCwgY2xpcHBlZCwgdHJpYW5nbGVWZXJ0aWNlcywgaGFzVmVydGV4Tm9ybWFscykgewogIGhhc1ZlcnRleE5vcm1hbHMgPSBmYWxzZTsKICBpZiAoY2xpcHBlZC5sZW5ndGggPT09IDApIHsKICAgIHJldHVybjsKICB9CiAgbGV0IG51bVZlcnRpY2VzID0gMDsKICBsZXQgY2xpcHBlZEluZGV4ID0gMDsKICB3aGlsZSAoY2xpcHBlZEluZGV4IDwgY2xpcHBlZC5sZW5ndGgpIHsKICAgIGNsaXBwZWRJbmRleCA9IHBvbHlnb25WZXJ0aWNlc1tudW1WZXJ0aWNlcysrXS5pbml0aWFsaXplRnJvbUNsaXBSZXN1bHQoCiAgICAgIGNsaXBwZWQsCiAgICAgIGNsaXBwZWRJbmRleCwKICAgICAgdHJpYW5nbGVWZXJ0aWNlcwogICAgKTsKICB9CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1WZXJ0aWNlczsgKytpKSB7CiAgICBjb25zdCBwb2x5Z29uVmVydGV4ID0gcG9seWdvblZlcnRpY2VzW2ldOwogICAgaWYgKCFwb2x5Z29uVmVydGV4LmlzSW5kZXhlZCgpKSB7CiAgICAgIGNvbnN0IGtleSA9IHBvbHlnb25WZXJ0ZXguZ2V0S2V5KCk7CiAgICAgIGlmIChkZWZpbmVkKHZlcnRleE1hcFtrZXldKSkgewogICAgICAgIHBvbHlnb25WZXJ0ZXgubmV3SW5kZXggPSB2ZXJ0ZXhNYXBba2V5XTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBuZXdJbmRleCA9IHVCdWZmZXIubGVuZ3RoOwogICAgICAgIHVCdWZmZXIucHVzaChwb2x5Z29uVmVydGV4LmdldFUoKSk7CiAgICAgICAgdkJ1ZmZlci5wdXNoKHBvbHlnb25WZXJ0ZXguZ2V0VigpKTsKICAgICAgICBoZWlnaHRCdWZmZXIucHVzaChwb2x5Z29uVmVydGV4LmdldEgoKSk7CiAgICAgICAgaWYgKGhhc1ZlcnRleE5vcm1hbHMpIHsKICAgICAgICAgIG5vcm1hbEJ1ZmZlci5wdXNoKHBvbHlnb25WZXJ0ZXguZ2V0Tm9ybWFsWCgpKTsKICAgICAgICAgIG5vcm1hbEJ1ZmZlci5wdXNoKHBvbHlnb25WZXJ0ZXguZ2V0Tm9ybWFsWSgpKTsKICAgICAgICB9CiAgICAgICAgcG9seWdvblZlcnRleC5uZXdJbmRleCA9IG5ld0luZGV4OwogICAgICAgIHZlcnRleE1hcFtrZXldID0gbmV3SW5kZXg7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHBvbHlnb25WZXJ0ZXgubmV3SW5kZXggPSB2ZXJ0ZXhNYXBbcG9seWdvblZlcnRleC5pbmRleF07CiAgICAgIHBvbHlnb25WZXJ0ZXgudUJ1ZmZlciA9IHVCdWZmZXI7CiAgICAgIHBvbHlnb25WZXJ0ZXgudkJ1ZmZlciA9IHZCdWZmZXI7CiAgICAgIHBvbHlnb25WZXJ0ZXguaGVpZ2h0QnVmZmVyID0gaGVpZ2h0QnVmZmVyOwogICAgICBpZiAoaGFzVmVydGV4Tm9ybWFscykgewogICAgICAgIHBvbHlnb25WZXJ0ZXgubm9ybWFsQnVmZmVyID0gbm9ybWFsQnVmZmVyOwogICAgICB9CiAgICB9CiAgfQogIGlmIChudW1WZXJ0aWNlcyA9PT0gMykgewogICAgaW5kaWNlcy5wdXNoKHBvbHlnb25WZXJ0aWNlc1swXS5uZXdJbmRleCk7CiAgICBpbmRpY2VzLnB1c2gocG9seWdvblZlcnRpY2VzWzFdLm5ld0luZGV4KTsKICAgIGluZGljZXMucHVzaChwb2x5Z29uVmVydGljZXNbMl0ubmV3SW5kZXgpOwogIH0gZWxzZSBpZiAobnVtVmVydGljZXMgPT09IDQpIHsKICAgIGluZGljZXMucHVzaChwb2x5Z29uVmVydGljZXNbMF0ubmV3SW5kZXgpOwogICAgaW5kaWNlcy5wdXNoKHBvbHlnb25WZXJ0aWNlc1sxXS5uZXdJbmRleCk7CiAgICBpbmRpY2VzLnB1c2gocG9seWdvblZlcnRpY2VzWzJdLm5ld0luZGV4KTsKICAgIGluZGljZXMucHVzaChwb2x5Z29uVmVydGljZXNbMF0ubmV3SW5kZXgpOwogICAgaW5kaWNlcy5wdXNoKHBvbHlnb25WZXJ0aWNlc1syXS5uZXdJbmRleCk7CiAgICBpbmRpY2VzLnB1c2gocG9seWdvblZlcnRpY2VzWzNdLm5ld0luZGV4KTsKICB9Cn0K",HN="undefined"!=typeof window&&window.Blob&&new Blob([atob(XN)],{type:"text/javascript;charset=utf-8"});function zN(){const e=HN&&(window.URL||window.webkitURL).createObjectURL(HN);try{return e?new Worker(e):new Worker("data:application/javascript;base64,"+XN,{type:"module"})}finally{e&&(window.URL||window.webkitURL).revokeObjectURL(e)}}const LN=new Qt;new Qt;const DN=new Qt;function KN(e,t){if(0===t)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(2===t||1===t){let i=e.getIndex();if(null===i){const t=[],n=e.getAttribute("position");if(void 0===n)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<n.count;e++)t.push(e);e.setIndex(t),i=e.getIndex()}const n=i.count-2,s=[];if(2===t)for(let e=1;e<=n;e++)s.push(i.getX(0)),s.push(i.getX(e)),s.push(i.getX(e+1));else for(let e=0;e<n;e++)e%2==0?(s.push(i.getX(e)),s.push(i.getX(e+1)),s.push(i.getX(e+2))):(s.push(i.getX(e+2)),s.push(i.getX(e+1)),s.push(i.getX(e)));s.length/3!==n&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const o=e.clone();return o.setIndex(s),o.clearGroups(),o}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e}const YN=parseInt(o,10)>=165,PN=parseInt(o,10)>=166,kN=new Bg,ON=new Dt,UN=new bt,QN=new class{constructor(){this._renderer=new oa,this._target=new Yt(1,1),this._texTarget=new Yt,this._quad=new wm(new ls({blending:5,blendDst:h,blendSrc:u,uniforms:{map:{value:null},pixel:{value:new bt}},vertexShader:"\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\t\t\t\tuniform sampler2D map;\n\t\t\t\tuniform ivec2 pixel;\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tgl_FragColor = texelFetch( map, pixel, 0 );\n\n\t\t\t\t}\n\t\t\t"}))}increaseSizeTo(e){this._target.setSize(Math.max(this._target.width,e),1)}readDataAsync(e){const{_renderer:t,_target:i}=this;return YN?t.readRenderTargetPixelsAsync(i,0,0,e.length/4,1,e):Promise.resolve().then((()=>this.readData(e)))}readData(e){const{_renderer:t,_target:i}=this;t.readRenderTargetPixels(i,0,0,e.length/4,1,e)}renderPixelToTarget(e,t,i){const{_quad:n,_renderer:s,_target:o,_texTarget:r}=this;if(PN)kN.min.copy(t),kN.max.copy(t),kN.max.x+=1,kN.max.y+=1,s.initRenderTarget(o),s.copyTextureToTexture(e,o.texture,kN,i,0);else{const a=s.autoClear,l=s.getRenderTarget(),g=s.getScissorTest();s.getScissor(ON),r.setSize(e.image.width,e.image.height),s.setRenderTarget(r),UN.set(0,0),YN?s.copyTextureToTexture(e,r.texture,null,UN):s.copyTextureToTexture(UN,e,r.texture),n.material.uniforms.map.value=r.texture,n.material.uniforms.pixel.value.copy(t),s.setRenderTarget(o),s.setScissorTest(!0),s.setScissor(i.x,i.y,1,1),s.autoClear=!1,n.render(s),s.setScissorTest(g),s.setScissor(ON),s.setRenderTarget(l),s.autoClear=a,r.dispose()}}},JN=new bt,jN=new bt,qN=new bt;function $N(e,t,i,n,s){const[o,r,a]=n,l=function(e,t){return 0===t?e.getAttribute("uv"):e.getAttribute(`uv${t}`)}(e,t);JN.fromBufferAttribute(l,o),jN.fromBufferAttribute(l,r),qN.fromBufferAttribute(l,a),s.set(0,0,0).addScaledVector(JN,i.x).addScaledVector(jN,i.y).addScaledVector(qN,i.z)}function eF(e,t,i,n){const s=e.x-Math.floor(e.x),o=e.y-Math.floor(e.y),r=Math.floor(s*t%t),a=Math.floor(o*i%i);return n.set(r,a),n}const tF=new bt,iF=new bt,nF=new bt;class sF{constructor(e,t,i){this.geometry=e,this.textures=t,this.data=i,this._asyncRead=!1,this.featureIds=i.featureIds.map((e=>{const{texture:t,...i}=e,n={label:null,propertyTable:null,nullFeatureId:null,...i};return t&&(n.texture={texCoord:0,channels:[0],...t}),n}))}getTextures(){return this.textures}getFeatureInfo(){return this.featureIds}getFeaturesAsync(...e){this._asyncRead=!0;const t=this.getFeatures(...e);return this._asyncRead=!1,t}getFeatures(e,t){const{geometry:i,textures:n,featureIds:s}=this,o=new Array(s.length).fill(null),r=s.length;QN.increaseSizeTo(r);const a=function(e,t,i=new Array(3)){let n=3*t,s=3*t+1,o=3*t+2;return e.index&&(n=e.index.getX(n),s=e.index.getX(s),o=e.index.getX(o)),i[0]=n,i[1]=s,i[2]=o,i}(i,e),l=a[function(e){return e.x>e.y&&e.x>e.z?0:e.y>e.z?1:2}(t)];for(let d=0,h=s.length;d<h;d++){const e=s[d],r="nullFeatureId"in e?e.nullFeatureId:null;if("texture"in e){const s=n[e.texture.index];$N(i,e.texture.texCoord,t,a,tF),eF(tF,s.image.width,s.image.height,iF),nF.set(d,0),QN.renderPixelToTarget(n[e.texture.index],iF,nF)}else if("attribute"in e){const t=i.getAttribute(`_feature_id_${e.attribute}`).getX(l);t!==r&&(o[d]=t)}else{const e=l;e!==r&&(o[d]=e)}}const g=new Uint8Array(4*r);return this._asyncRead?QN.readDataAsync(g).then((()=>(c(),o))):(QN.readData(g),c(),o);function c(){const e=new Uint32Array(1);for(let t=0,i=s.length;t<i;t++){const i=s[t],n="nullFeatureId"in i?i.nullFeatureId:null;if("texture"in i){const{channels:s}=i.texture,r=s.map((e=>g[4*t+e]));new Uint8Array(e.buffer).set(r);const a=e[0];a!==n&&(o[t]=a)}}}}dispose(){this.textures.forEach((e=>{e&&(e.dispose(),e.image instanceof ImageBitmap&&e.image.close())}))}}const oF="EXT_mesh_features";function rF(e,t,i){e.traverse((e=>{if(t.associations.has(e)){const{meshes:n,primitives:s}=t.associations.get(e);if(am(n)&&am(s)){const o=t.json.meshes[n].primitives[s];o&&o.extensions&&o.extensions[oF]&&i(e,o.extensions[oF])}}}))}class aF{constructor(e){this.parser=e,this.name=oF}async afterRoot({scene:e,parser:t}){var i;const n=t.json.extensionsUsed;if(!n||!n.includes(oF))return;const s=(null==(i=t.json.textures)?void 0:i.length)||0,o=new Array(s).fill(null);rF(e,t,((e,{featureIds:i})=>{i.forEach((e=>{if(e.texture&&null===o[e.texture.index]){const i=e.texture.index;o[i]=t.loadTexture(i)}}))}));const r=await Promise.all(o);rF(e,t,((e,t)=>{e.userData.meshFeatures=new sF(e.geometry,r,t)}))}}class lF{constructor(e){e=lm(e,lm.EMPTY_OBJECT),this._schema=e.schema;const t=e.propertyTables;this._propertyTableCount=am(t)?t.length:0,this._propertyTables=t,this._propertyTextures=e.propertyTextures,this._propertyAttributes=e.propertyAttributes,this._statistics=e.statistics,this._extras=e.extras,this._extensions=e.extensions}get schema(){return this._schema}get statistics(){return this._statistics}get extras(){return this._extras}get extensions(){return this._extensions}get propertyTableCount(){return this._propertyTableCount}get propertyTables(){return this._propertyTables}get propertyTextures(){return this._propertyTextures}get propertyAttributes(){return this._propertyAttributes}get propertyTablesByteLength(){if(!am(this._propertyTables))return 0;let e=0;const t=this._propertyTables.length;for(let i=0;i<t;i++)e+=this._propertyTables[i].byteLength;return e}getPropertyTable(e){return this._propertyTables[e]}getPropertyTexture(e){return this._propertyTextures[e]}getPropertyAttribute(e){return this._propertyAttributes[e]}dispose(){}}function gF(){return"undefined"!=typeof BigInt}const cF={INT8:"INT8",UINT8:"UINT8",INT16:"INT16",UINT16:"UINT16",INT32:"INT32",UINT32:"UINT32",INT64:"INT64",UINT64:"UINT64",FLOAT32:"FLOAT32",FLOAT64:"FLOAT64",getMinimum:function(e){switch(e){case cF.INT8:return-128;case cF.UINT8:return 0;case cF.INT16:return-32768;case cF.UINT16:return 0;case cF.INT32:return-2147483648;case cF.UINT32:return 0;case cF.INT64:return gF()?BigInt("-9223372036854775808"):-Math.pow(2,63);case cF.UINT64:return gF()?BigInt(0):0;case cF.FLOAT32:return-34028234663852886e22;case cF.FLOAT64:return-Number.MAX_VALUE}},getMaximum:function(e){switch(e){case cF.INT8:return 127;case cF.UINT8:return 255;case cF.INT16:return 32767;case cF.UINT16:return 65535;case cF.INT32:return 2147483647;case cF.UINT32:return 4294967295;case cF.INT64:return gF()?BigInt("9223372036854775807"):Math.pow(2,63)-1;case cF.UINT64:return gF()?BigInt("18446744073709551615"):Math.pow(2,64)-1;case cF.FLOAT32:return 34028234663852886e22;case cF.FLOAT64:return Number.MAX_VALUE}},isIntegerType:function(e){switch(e){case cF.INT8:case cF.UINT8:case cF.INT16:case cF.UINT16:case cF.INT32:case cF.UINT32:case cF.INT64:case cF.UINT64:return!0;default:return!1}},isUnsignedIntegerType:function(e){switch(e){case cF.UINT8:case cF.UINT16:case cF.UINT32:case cF.UINT64:return!0;default:return!1}},isVectorCompatible:function(e){switch(e){case cF.INT8:case cF.UINT8:case cF.INT16:case cF.UINT16:case cF.INT32:case cF.UINT32:case cF.FLOAT32:case cF.FLOAT64:return!0;default:return!1}},normalize:function(e,t){return Math.max(Number(e)/Number(cF.getMaximum(t)),-1)},unnormalize:function(e,t){const i=cF.getMaximum(t),n=cF.isUnsignedIntegerType(t)?0:-i;return e=Km.sign(e)*Math.round(Math.abs(e)*Number(i)),t!==cF.INT64&&t!==cF.UINT64||!gF()||(e=BigInt(e)),e>i?i:e<n?n:e},applyValueTransform:function(e,t,i){return i*e+t},unapplyValueTransform:function(e,t,i){return 0===i?0:(e-t)/i},getSizeInBytes:function(e){switch(e){case cF.INT8:case cF.UINT8:return 1;case cF.INT16:case cF.UINT16:return 2;case cF.INT32:case cF.UINT32:return 4;case cF.INT64:case cF.UINT64:return 8;case cF.FLOAT32:return 4;case cF.FLOAT64:return 8}}},dF=Object.freeze(cF);class hF{constructor(e){const t=(e=lm(e,{})).value,i=e.name;this._value=t,this._name=i,this._description=e.description,this._extras=cm(e.extras,!0),this._extensions=cm(e.extensions,!0)}static fromJson(e){return new hF({value:e.value,name:e.name,description:e.description,extras:e.extras,extensions:e.extensions})}get value(){return this._value}get name(){return this._name}get description(){return this._description}get extras(){return this._extras}get extensions(){return this._extensions}}class uF{constructor(e){const t=(e=lm(e,{})).id,i=e.values,n={},s={},o=i.length;for(let a=0;a<o;++a){const e=i[a];n[e.value]=e.name,s[e.name]=e.value}const r=lm(e.valueType,dF.UINT16);this._values=i,this._namesByValue=n,this._valuesByName=s,this._valueType=r,this._id=t,this._name=e.name,this._description=e.description,this._extras=cm(e.extras,!0),this._extensions=cm(e.extensions,!0)}static fromJson(e){const t=(e=lm(e,{})).id,i=e.enum,n=i.values.map((function(e){return hF.fromJson(e)}));return new uF({id:t,values:n,valueType:dF[i.valueType],name:i.name,description:i.description,extras:i.extras,extensions:i.extensions})}get values(){return this._values}get namesByValue(){return this._namesByValue}get valuesByName(){return this._valuesByName}get valueType(){return this._valueType}get id(){return this._id}get name(){return this._name}get extras(){return this._extras}get extensions(){return this._extensions}}const IF={SCALAR:"SCALAR",VEC2:"VEC2",VEC3:"VEC3",VEC4:"VEC4",MAT2:"MAT2",MAT3:"MAT3",MAT4:"MAT4",BOOLEAN:"BOOLEAN",STRING:"STRING",ENUM:"ENUM"};IF.isVectorType=function(e){switch(e){case IF.VEC2:case IF.VEC3:case IF.VEC4:return!0;default:return!1}},IF.isMatrixType=function(e){switch(e){case IF.MAT2:case IF.MAT3:case IF.MAT4:return!0;default:return!1}},IF.getComponentCount=function(e){switch(e){case IF.SCALAR:case IF.STRING:case IF.ENUM:case IF.BOOLEAN:return 1;case IF.VEC2:return 2;case IF.VEC3:return 3;case IF.VEC4:case IF.MAT2:return 4;case IF.MAT3:return 9;case IF.MAT4:return 16;default:throw new Error(`Invalid metadata type ${e}`)}},IF.getMathType=function(e){switch(e){case IF.VEC2:return bt;case IF.VEC3:return Qt;case IF.VEC4:return Dt;case IF.MAT2:return void console.warn("not support mat2");case IF.MAT3:return yt;case IF.MAT4:return Bi;default:return}};class pF{constructor(e){const t=(e=lm(e,{})).id,i=e.type,n=e.componentType,s=e.enumType,o=am(n)&&dF.isIntegerType(n)&&lm(e.normalized,!1);this._id=t,this._name=e.name,this._description=e.description,this._semantic=e.semantic,this._isLegacyExtension=e.isLegacyExtension,this._type=i,this._componentType=n,this._enumType=s,this._valueType=am(s)?s.valueType:n,this._isArray=lm(e.isArray,!1),this._isVariableLengthArray=lm(e.isVariableLengthArray,!1),this._arrayLength=e.arrayLength,this._min=cm(e.min,!0),this._max=cm(e.max,!0),this._normalized=o;let r=cm(e.offset,!0),a=cm(e.scale,!0);const l=am(r)||am(a);am(r)||(r=this.expandConstant(0,true)),am(a)||(a=this.expandConstant(1,true)),this._offset=r,this._scale=a,this._hasValueTransform=l,this._noData=cm(e.noData,!0),this._default=cm(e.default,!0),this._required=lm(e.required,!0),this._extras=cm(e.extras,!0),this._extensions=cm(e.extensions,!0)}static fromJson(e){const t=(e=lm(e,{})).id,i=e.property,n=function(e){if("ARRAY"===e.type)return!0;const t=e.type;if(t===IF.SCALAR||IF.isMatrixType(t)||IF.isVectorType(t))return!1;if(am(dF[t]))return!0;if(am(e.noData)||am(e.scale)||am(e.offset)||am(e.required)||am(e.count)||am(e.array))return!1;if(am(e.optional))return!1;return}(i),s=function(e,t){const i=e.type,n=e.componentType,s="ARRAY"===i;let o,r,a,l;s?(o=!0,r=e.componentCount,a=!am(r)):e.array?(o=!0,r=e.count,a=!am(e.count)):(o=!1,r=void 0,a=!1);am(e.enumType)&&(l=t[e.enumType]);if(i===IF.ENUM)return{type:i,componentType:void 0,enumType:l,valueType:l.valueType,isArray:o,isVariableLengthArray:a,arrayLength:r};if(s&&n===IF.ENUM)return{type:n,componentType:void 0,enumType:l,valueType:l.valueType,isArray:o,isVariableLengthArray:a,arrayLength:r};if(i===IF.SCALAR||IF.isMatrixType(i)||IF.isVectorType(i))return{type:i,componentType:n,enumType:void 0,valueType:n,isArray:o,isVariableLengthArray:a,arrayLength:r};if(i===IF.BOOLEAN||i===IF.STRING)return{type:i,componentType:void 0,enumType:void 0,valueType:void 0,isArray:o,isVariableLengthArray:a,arrayLength:r};if(s&&(n===IF.BOOLEAN||n===IF.STRING))return{type:n,componentType:void 0,enumType:void 0,valueType:void 0,isArray:o,isVariableLengthArray:a,arrayLength:r};if(am(n)&&am(dF[n]))return{type:IF.SCALAR,componentType:n,enumType:void 0,valueType:n,isArray:o,isVariableLengthArray:a,arrayLength:r};if(am(dF[i]))return{type:IF.SCALAR,componentType:i,enumType:void 0,valueType:i,isArray:o,isVariableLengthArray:a,arrayLength:r};throw new Error(`unknown metadata type {type: ${i}, componentType: ${n})`)}(i,e.enums);let o;return o=!!am(n)&&(n?!am(i.optional)||!i.optional:lm(i.required,!1)),new pF({id:t,type:s.type,componentType:s.componentType,enumType:s.enumType,isArray:s.isArray,isVariableLengthArray:s.isVariableLengthArray,arrayLength:s.arrayLength,normalized:i.normalized,min:i.min,max:i.max,offset:i.offset,scale:i.scale,noData:i.noData,default:i.default,required:o,name:i.name,description:i.description,semantic:i.semantic,extras:i.extras,extensions:i.extensions,isLegacyExtension:n})}normalize(e){return this._normalized?mF(e,this._valueType,dF.normalize):e}unnormalize(e){return this._normalized?mF(e,this._valueType,dF.unnormalize):e}applyValueTransform(e){return!this._hasValueTransform||this._isVariableLengthArray?e:pF.valueTransformInPlace(e,this._offset,this._scale,dF.applyValueTransform)}unapplyValueTransform(e){return!this._hasValueTransform||this._isVariableLengthArray?e:pF.valueTransformInPlace(e,this._offset,this._scale,dF.unapplyValueTransform)}expandConstant(e,t){t=lm(t,!1);const i=this._isArray,n=this._arrayLength,s=IF.getComponentCount(this._type),o=i&&s>1;if(!i&&1===s)return e;if(!i)return new Array(s).fill(e);if(!o)return new Array(n).fill(e);if(!t)return new Array(this._arrayLength*s).fill(e);const r=new Array(s).fill(e);return new Array(this._arrayLength).fill(r)}handleNoData(e){const t=this._noData;return am(t)&&AF(e,t)?void 0:e}unpackVectorAndMatrixTypes(e,t){t=lm(t,!1);const i=IF.getMathType(this._type),n=this._isArray,s=IF.getComponentCount(this._type),o=n&&s>1;return am(i)?t&&o?e.map((function(e){return(new i).fromArray(e)})):n?function(e,t,i){const n=t.length;am(i)?i.length=n/2:i=new Array(n/2);for(let s=0;s<n;s+=2){const n=s/2;am(i[n])||(i[n]=new e),i[n]=i[n].fromArray(t,s)}return i}(i,e):(new i).fromArray(e):e}packVectorAndMatrixTypes(e){if(am(e)||!am(this._default))return this._required&&!am(e)?"required property must have a value":this._isArray?function(e,t){if(!Array.isArray(t))return`value ${t} must be an array`;const i=t.length;if(!e._isVariableLengthArray&&i!==e._arrayLength)return"Array length does not match property.arrayLength";for(let n=0;n<i;n++){const i=CF(e,t[n]);if(am(i))return i}}(this,e):CF(this,e)}valueTransformInPlace(e,t,i,n){if(!Array.isArray(e))return n(e,t,i);for(let s=0;s<e.length;s++)e[s]=pF.valueTransformInPlace(e[s],t[s],i[s],n);return e}get id(){return this._id}get name(){return this._name}get description(){return this._description}get type(){return this._type}get enumType(){return this._enumType}get componentType(){return this._componentType}get valueType(){return this._valueType}get isArray(){return this._isArray}get isVariableLengthArray(){return this._isVariableLengthArray}get arrayLength(){return this._arrayLength}get normalized(){return this._normalized}get max(){return this._max}get min(){return this._min}get noData(){return this._noData}get default(){return this._default}get required(){return this._required}get semantic(){return this._semantic}get hasValueTransform(){return this._hasValueTransform}get offset(){return this._offset}get scale(){return this._scale}get extras(){return this._extras}get extensions(){return this._extensions}}function mF(e,t,i){if(!Array.isArray(e))return i(e,t);for(let n=0;n<e.length;n++)e[n]=mF(e[n],t,i);return e}function AF(e,t){if(!Array.isArray(e))return e===t;if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!AF(e[i],t[i]))return!1;return!0}function CF(e,t){const i=e._type,n=e._componentType,s=e._enumType,o=e._normalized;return IF.isVectorType(i)?function(e,t,i){if(!dF.isVectorCompatible(i))return`componentType ${i} is incompatible with vector type ${t}`;if(t===IF.VEC2&&!(e instanceof bt))return`vector value ${e} must be a Vector2`;if(t===IF.VEC3&&!(e instanceof Qt))return`vector value ${e} must be a Vector3`;if(t===IF.VEC4&&!(e instanceof Dt))return`vector value ${e} must be a Vector4`}(t,i,n):IF.isMatrixType(i)?function(e,t,i){if(!dF.isVectorCompatible(i))return`componentType ${i} is incompatible with matrix type ${t}`;t===IF.MAT2&&console.warn("not support mat2");if(t===IF.MAT3&&!(e instanceof yt))return`matrix value ${e} must be a Matrix3`;if(t===IF.MAT4&&!(e instanceof Bi))return`matrix value ${e} must be a Matrix4`}(t,i,n):i===IF.STRING?function(e){if("string"!=typeof e)return fF(e,IF.STRING)}(t):i===IF.BOOLEAN?function(e){if("boolean"!=typeof e)return fF(e,IF.BOOLEAN)}(t):i===IF.ENUM?function(e,t){const i=typeof e;if(am(t))return"string"===i&&am(t.valuesByName[e])?void 0:`value ${e} is not a valid enum name for ${t.id}`}(t,s):function(e,t,i){const n=typeof e;switch(t){case dF.INT8:case dF.UINT8:case dF.INT16:case dF.UINT16:case dF.INT32:case dF.UINT32:case dF.FLOAT32:case dF.FLOAT64:return"number"!==n?fF(e,t):isFinite(e)?yF(e,t,i):_F(e,t);case dF.INT64:case dF.UINT64:return"number"!==n&&"bigint"!==n?fF(e,t):"number"!==n||isFinite(e)?yF(e,t,i):_F(e,t)}}(t,n,o)}function fF(e,t){return`value ${e} does not match type ${t}`}function bF(e,t,i){let n=`value ${e} is out of range for type ${t}`;return i&&(n+=" (normalized)"),n}function yF(e,t,i){if(i){return e<(dF.isUnsignedIntegerType(t)?0:-1)||e>1?bF(e,t,i):void 0}if(e<dF.getMinimum(t)||e>dF.getMaximum(t))return bF(e,t,i)}function _F(e,t){return`value ${e} of type ${t} must be finite`}const vF=class{constructor(e){const t=(e=lm(e,{})).id,i=lm(e.properties,{}),n={};for(const s in i)if(i.hasOwnProperty(s)){const e=i[s];am(e.semantic)&&(n[e.semantic]=e)}this._id=t,this._name=e.name,this._description=e.description,this._properties=i,this._propertiesBySemantic=n,this._extras=cm(e.extras,!0),this._extensions=cm(e.extensions,!0)}static fromJson(e){const t=(e=lm(e,{})).id,i=e.class,n={};for(const s in i.properties)if(i.properties.hasOwnProperty(s)){const t=pF.fromJson({id:s,property:i.properties[s],enums:e.enums});n[s]=t}return new vF({id:t,name:i.name,description:i.description,properties:n,extras:i.extras,extensions:i.extensions})}get properties(){return this._properties}get propertiesBySemantic(){return this._propertiesBySemantic}get id(){return this._id}get name(){return this._name}get description(){return this._description}get extras(){return this._extras}get extensions(){return this._extensions}};let xF=vF;__publicField(xF,"BATCH_TABLE_CLASS_NAME","_batchTable");class BF{constructor(e){e=lm(e,{});const t=lm(e.classes,{}),i=lm(e.enums,{});this._classes=t,this._enums=i,this._id=e.id,this._name=e.name,this._description=e.description,this._version=e.version,this._extras=cm(e.extras,!0),this._extensions=cm(e.extensions,!0)}static fromJson(e){const t={};if(am(e.enums))for(const n in e.enums)e.enums.hasOwnProperty(n)&&(t[n]=uF.fromJson({id:n,enum:e.enums[n]}));const i={};if(am(e.classes))for(const n in e.classes)e.classes.hasOwnProperty(n)&&(i[n]=xF.fromJson({id:n,class:e.classes[n],enums:t}));return new BF({id:e.id,name:e.name,description:e.description,version:e.version,classes:i,enums:t,extras:e.extras,extensions:e.extensions})}get classes(){return this._classes}get enums(){return this._enums}get id(){return this._id}get name(){return this._name}get description(){return this._description}get version(){return this._version}get extras(){return this._extras}get extensions(){return this._extensions}}class wF{static hasProperty(e,t,i){if(am(t[e]))return!0;const n=i.properties;if(!am(n))return!1;const s=n[e];return!(!am(s)||!am(s.default))}static hasPropertyBySemantic(e,t,i){const n=i.propertiesBySemantic;if(!am(n))return!1;return am(n[e])}static getPropertyIds(e,t,i){(i=am(i)?i:[]).length=0;for(const s in e)e.hasOwnProperty(s)&&am(e[s])&&i.push(s);const n=t.properties;if(am(n))for(const s in n)n.hasOwnProperty(s)&&!am(e[s])&&am(n[s].default)&&i.push(s);return i}static getProperty(e,t,i){const n=i.properties[e];let s=t[e];Array.isArray(s)&&(s=s.slice());return s=n.handleNoData(s),!am(s)&&am(n.default)?(s=cm(n.default,!0),n.unpackVectorAndMatrixTypes(s,true)):am(s)?(s=n.normalize(s),s=n.unpackVectorAndMatrixTypes(s,true),s):void 0}static setProperty(e,t,i,n){const s=n.properties[e];t=s.packVectorAndMatrixTypes(t);const o=s.transform(t);return!!am(o)&&(Array.isArray(o)?i[e]=o.slice():i[e]=o,!0)}static getPropertyBySemantic(e,t,i){const n=i.propertiesBySemantic;if(!am(n))return;const s=n[e];return am(s)?wF.getProperty(s.id,t,i):void 0}static setPropertyBySemantic(e,t,i,n){const s=n.propertiesBySemantic;if(!am(s))return!1;const o=s[e];return!!am(o)&&wF.setProperty(o.id,t,i,n)}}const SF=Object.freeze({UNISSUED:0,ISSUED:1,ACTIVE:2,RECEIVED:3,CANCELLED:4,FAILED:5});class GF{constructor(e={}){const t=lm(e.throttleByServer,!1),i=lm(e.throttle,!1);this.url=e.url,this.requestFunction=e.requestFunction,this.cancelFunction=e.cancelFunction,this.priorityFunction=e.priorityFunction,this.priority=lm(e.priority,0),this.throttle=i,this.throttleByServer=t,this.serverKey=e.serverKey,this.state=SF.UNISSUED,this.deferred=void 0,this.cancelled=!1}cancel(){this.cancelled=!0}clone(e){return am(e)?(e.url=this.url,e.requestFunction=this.requestFunction,e.cancelFunction=this.cancelFunction,e.priorityFunction=this.priorityFunction,e.priority=this.priority,e.throttle=this.throttle,e.throttleByServer=this.throttleByServer,e.type=this.type,e.serverKey=this.serverKey,e.state=SF.UNISSUED,e.deferred=void 0,e.cancelled=!1,e):new GF(this)}}function MF(e,t,i){if(!am(e))throw new Error("uint8Array is required.");if(t<0)throw new Error("byteOffset cannot be negative.");if(i<0)throw new Error("byteLength cannot be negative.");if(t+i>e.byteLength)throw new Error("sub-region exceeds array bounds.");return t=lm(t,0),i=lm(i,e.byteLength-t),e=e.subarray(t,t+i),MF.decode(e)}function RF(e,t,i){return t<=e&&e<=i}function TF(e,t){return MF(e,t=lm(t,0),Math.min(4,e.length))}MF.decodeWithTextDecoder=function(e){return new TextDecoder("utf-8").decode(e)},MF.decodeWithFromCharCode=function(e){let t="";const i=function(e){let t=0,i=0,n=0,s=128,o=191;const r=[],a=e.length;for(let l=0;l<a;++l){const a=e[l];if(0===n){if(RF(a,0,127)){r.push(a);continue}if(RF(a,194,223)){n=1,t=31&a;continue}if(RF(a,224,239)){224===a&&(s=160),237===a&&(o=159),n=2,t=15&a;continue}if(RF(a,240,244)){240===a&&(s=144),244===a&&(o=143),n=3,t=7&a;continue}throw new Error("String decoding failed.")}RF(a,s,o)?(s=128,o=191,t=t<<6|63&a,++i,i===n&&(r.push(t),t=n=i=0)):(t=n=i=0,s=128,o=191,--l)}return r}(e),n=i.length;for(let s=0;s<n;++s){let e=i[s];e<=65535?t+=String.fromCharCode(e):(e-=65536,t+=String.fromCharCode(55296+(e>>10),56320+(1023&e)))}return t},"undefined"!=typeof TextDecoder?MF.decode=MF.decodeWithTextDecoder:MF.decode=MF.decodeWithFromCharCode;class ZF{constructor(e){const t=(e=lm(e,lm.EMPTY_OBJECT)).count,i=e.property,n=e.classProperty,s=e.bufferViews,o=n.type,r=n.isArray,a=n.isVariableLengthArray;let l=n.valueType;const g=n.enumType,c=o===IF.STRING,d=o===IF.BOOLEAN;let h,u=0;if(a){let e=lm(i.arrayOffsetType,i.offsetType);e=lm(dF[e],dF.UINT32);h=new VF(s[lm(i.arrayOffsets,i.arrayOffsetBufferView)],e,t+1),u+=h.typedArray.byteLength}const I=IF.getComponentCount(o);let p;p=a?h.get(t)-h.get(0):r?t*n.arrayLength:t;const m=I*p;let A,C;if(c){let e=lm(i.stringOffsetType,i.offsetType);e=lm(dF[e],dF.UINT32);A=new VF(s[lm(i.stringOffsets,i.stringOffsetBufferView)],e,m+1),u+=A.typedArray.byteLength}(c||d)&&(l=dF.UINT8),C=c?A.get(m)-A.get(0):d?Math.ceil(m/8):m;const f=new VF(s[lm(i.values,i.bufferView)],l,C);u+=f.typedArray.byteLength;let b=i.offset,y=i.scale;const _=n.hasValueTransform||am(b)||am(y);let v,x;b=lm(b,n.offset),y=lm(y,n.scale),b=WF(b),y=WF(y);const B=this;c?v=function(e){return function(e,t,i){const n=i.get(e),s=i.get(e+1)-n;return MF(t.typedArray,n,s)}(e,B._values,B._stringOffsets)}:d?(v=function(e){return function(e,t){const i=e>>3,n=e%8;return 1==(t.typedArray[i]>>n&1)}(e,B._values)},x=function(e,t){!function(e,t,i){const n=e>>3,s=e%8;i?t.typedArray[n]|=1<<s:t.typedArray[n]&=~(1<<s)}(e,B._values,t)}):am(g)?(v=function(e){const t=B._values.get(e);return g.namesByValue[t]},x=function(e,t){const i=g.valuesByName[t];B._values.set(e,i)}):(v=function(e){return B._values.get(e)},x=function(e,t){B._values.set(e,t)}),this._arrayOffsets=h,this._stringOffsets=A,this._values=f,this._classProperty=n,this._count=t,this._vectorComponentCount=I,this._min=i.min,this._max=i.max,this._offset=b,this._scale=y,this._hasValueTransform=_,this._getValue=v,this._setValue=x,this._unpackedValues=void 0,this._extras=i.extras,this._extensions=i.extensions,this._byteLength=u}get(e){let t=function(e,t){NF(e)&&FF(e);const i=e._classProperty,n=i.isArray,s=i.type,o=IF.getComponentCount(s);if(am(e._unpackedValues)){const i=e._unpackedValues[t];return n?cm(i,!0):i}if(!n&&1===o)return e._getValue(t);return EF(e,i,t)}(this,e);return t=this._classProperty.handleNoData(t),am(t)?(t=this._classProperty.normalize(t),t=function(e,t){const i=e._classProperty.isVariableLengthArray;if(!e._hasValueTransform||i)return t;return pF.valueTransformInPlace(t,e._offset,e._scale,dF.applyValueTransform)}(this,t),this._classProperty.unpackVectorAndMatrixTypes(t)):(t=this._classProperty.default,this._classProperty.unpackVectorAndMatrixTypes(t))}set(e,t){const i=this._classProperty;t=function(e,t){const i=e._classProperty,n=i.isVariableLengthArray;if(!e._hasValueTransform||n)return t;return pF.valueTransformInPlace(t,e._offset,e._scale,dF.unapplyValueTransform)}(this,t=i.packVectorAndMatrixTypes(t)),function(e,t,i){(function(e,t,i){if(NF(e))return!0;const n=e._arrayOffsets;if(am(n)){if(n.get(t+1)-n.get(t)!==i.length)return!0}return!1})(e,t,i)&&FF(e);const n=e._classProperty,s=n.isArray,o=n.type,r=IF.getComponentCount(o);if(am(e._unpackedValues))return n.isArray&&(i=cm(i,!0)),void(e._unpackedValues[t]=i);if(!s&&1===r)return void e._setValue(t,i);let a,l;if(n.isVariableLengthArray)a=e._arrayOffsets.get(t),l=e._arrayOffsets.get(t+1)-a;else{const i=lm(n.arrayLength,1)*e._vectorComponentCount;a=t*i,l=i}for(let g=0;g<l;++g)e._setValue(a+g,i[g])}(this,e,t=i.unnormalize(t))}getTypedArray(){if(am(this._values))return this._values.typedArray}get hasValueTransform(){return this._hasValueTransform}get offset(){return this._offset}get scale(){return this._scale}get extensions(){return this._extensions}get byteLength(){return this._byteLength}}function VF(e,t,i){const n=this;let s,o,r;t===dF.INT64?XF()?HF()?(s=new BigInt64Array(e.buffer,e.byteOffset,i),r=function(e,t){n.typedArray[e]=BigInt(t)}):(s=new Uint8Array(e.buffer,e.byteOffset,8*i),o=function(e){return function(e,t){const i=t.dataView,n=8*e;let s=BigInt(0);const o=(128&i.getUint8(n+7))>0;let r=!0;for(let a=0;a<8;++a){let e=i.getUint8(n+a);o&&(r?0!==e&&(e=255&~(e-1),r=!1):e=255&~e),s+=BigInt(e)*(BigInt(1)<<BigInt(8*a))}o&&(s=-s);return s}(e,n)}):(tw("INT64 type is not fully supported on this platform. Values greater than 2^53 - 1 or less than -(2^53 - 1) may lose precision when read."),s=new Uint8Array(e.buffer,e.byteOffset,8*i),o=function(e){return function(e,t){const i=t.dataView,n=8*e;let s=0;const o=(128&i.getUint8(n+7))>0;let r=!0;for(let a=0;a<8;++a){let e=i.getUint8(n+a);o&&(r?0!==e&&(e=255&~(e-1),r=!1):e=255&~e),s+=e*Math.pow(256,a)}o&&(s=-s);return s}(e,n)}):t===dF.UINT64?XF()?zF()?(s=new BigUint64Array(e.buffer,e.byteOffset,i),r=function(e,t){n.typedArray[e]=BigInt(t)}):(s=new Uint8Array(e.buffer,e.byteOffset,8*i),o=function(e){return function(e,t){const i=t.dataView,n=8*e,s=BigInt(i.getUint32(n,!0)),o=BigInt(i.getUint32(n+4,!0));return s+BigInt(4294967296)*o}(e,n)}):(tw("UINT64 type is not fully supported on this platform. Values greater than 2^53 - 1 may lose precision when read."),s=new Uint8Array(e.buffer,e.byteOffset,8*i),o=function(e){return function(e,t){const i=t.dataView,n=8*e,s=i.getUint32(n,!0),o=i.getUint32(n+4,!0);return s+4294967296*o}(e,n)}):(s=function(e,t,i,n){switch(e){case dF.INT8:return new Int8Array(t,i,n);case dF.UINT8:return new Uint8Array(t,i,n);case dF.INT16:return new Int16Array(t,i,n);case dF.UINT16:return new Uint16Array(t,i,n);case dF.INT32:return new Int32Array(t,i,n);case dF.UINT32:return new Uint32Array(t,i,n);case dF.FLOAT32:return new Float32Array(t,i,n);case dF.FLOAT64:return new Float64Array(t,i,n);default:throw new Error(`Unsupported component type: ${e}`)}}(t,e.buffer,e.byteOffset,i),r=function(e,t){n.typedArray[e]=t}),am(o)||(o=function(e){return n.typedArray[e]}),this.typedArray=s,this.dataView=new DataView(s.buffer,s.byteOffset),this.get=o,this.set=r,this._componentType=t}function WF(e){if(!Array.isArray(e))return e;const t=[];for(let i=0;i<e.length;i++){const n=e[i];Array.isArray(n)?t.push.apply(t,n):t.push(n)}return t}function EF(e,t,i){let n,s;if(t.isVariableLengthArray){n=e._arrayOffsets.get(i),s=e._arrayOffsets.get(i+1)-n;const o=IF.getComponentCount(t.type);n*=o,s*=o}else{const o=lm(t.arrayLength,1)*e._vectorComponentCount;n=i*o,s=o}const o=new Array(s);for(let r=0;r<s;r++)o[r]=e._getValue(n+r);return o}function NF(e){if(am(e._unpackedValues))return!1;const t=e._classProperty,i=t.type,n=t.valueType;return i===IF.STRING||(n===dF.INT64&&!HF()||n===dF.UINT64&&!zF())}function FF(e){e._unpackedValues=function(e){const t=e._count,i=new Array(t),n=e._classProperty,s=n.isArray,o=n.type,r=IF.getComponentCount(o);if(!s&&1===r){for(let n=0;n<t;++n)i[n]=e._getValue(n);return i}for(let a=0;a<t;a++)i[a]=EF(e,n,a);return i}(e),e._arrayOffsets=void 0,e._stringOffsets=void 0,e._values=void 0}function XF(){return"undefined"!=typeof BigInt}function HF(){return"undefined"!=typeof BigInt64Array}function zF(){return"undefined"!=typeof BigUint64Array}class LF{constructor(e={}){e=lm(e,lm.EMPTY_OBJECT);const{count:t,properties:i,class:n,bufferViews:s}=e;if(this._count=t,this._class=n,this._properties={},this._byteLength=0,am(i))for(const o in i)if(i.hasOwnProperty(o)){const e=new ZF({count:t,property:i[o],classProperty:n.properties[o],bufferViews:s});this._properties[o]=e,this._byteLength+=e.byteLength}}get count(){return this._count}get class(){return this._class}get byteLength(){return this._byteLength}hasProperty(e){return wF.hasProperty(e,this._properties,this._class)}hasPropertyBySemantic(e){return wF.hasPropertyBySemantic(e,this._properties,this._class)}getPropertyIds(e=[]){return wF.getPropertyIds(this._properties,this._class,e)}getProperty(e,t){const i=this._properties[t];let n;return n=am(i)?i.get(e):function(e,t){const i=e.properties;if(!am(i))return;const n=i[t];if(am(n)&&am(n.default)){let e=n.default;return n.isArray&&(e=cm(e,!0)),e=n.normalize(e),n.unpackVectorAndMatrixTypes(e)}}(this._class,t),n}setProperty(e,t,i){const n=this._properties[t];return!!am(n)&&(n.set(e,i),!0)}getPropertyBySemantic(e,t){let i;const n=this._class.propertiesBySemantic;if(am(n)&&(i=n[t]),am(i))return this.getProperty(e,i.id)}setPropertyBySemantic(e,t,i){let n;const s=this._class.propertiesBySemantic;return am(s)&&(n=s[t]),!!am(n)&&this.setProperty(e,n.id,i)}getPropertyTypedArray(e){const t=this._properties[e];if(am(t))return t.getTypedArray()}getPropertyTypedArrayBySemantic(e){let t;const i=this._class.propertiesBySemantic;if(am(i)&&(t=i[e]),am(t))return this.getPropertyTypedArray(t.id)}}const DF={};class KF{constructor(e){this._count=e.count,this._properties=cm(e.properties,!0)}hasProperty(e){return wF.hasProperty(e,this._properties,DF)}getPropertyIds(e=[]){return wF.getPropertyIds(this._properties,DF,e)}getProperty(e,t){const i=this._properties[t];if(am(i))return cm(i[e],!0)}setProperty(e,t,i){let n=this._properties[t];am(n)||(n=new Array(this._count),this._properties[t]=n),n[e]=cm(i,!0)}}const YF=[];class PF{constructor(e=lm.EMPTY_OBJECT){this._name=e.name,this._id=e.id,this._count=e.count,this._extras=e.extras,this._extensions=e.extensions,this._metadataTable=e.metadataTable,this._jsonMetadataTable=e.jsonMetadataTable,this._batchTableHierarchy=e.batchTableHierarchy}get name(){return this._name}get id(){return this._id}get count(){return this._count}get class(){return this._metadataTable?this._metadataTable.class:void 0}get extras(){return this._extras}get extensions(){return this._extensions}get byteLength(){let e=0;return this._metadataTable&&(e+=this._metadataTable.byteLength),this._batchTableHierarchy&&(e+=this._batchTableHierarchy.byteLength),e}hasProperty(e,t){return!(!this._metadataTable||!this._metadataTable.hasProperty(t))||(!(!this._batchTableHierarchy||!this._batchTableHierarchy.hasProperty(e,t))||!(!this._jsonMetadataTable||!this._jsonMetadataTable.hasProperty(t)))}hasPropertyBySemantic(e,t){return!!this._metadataTable&&this._metadataTable.hasPropertyBySemantic(t)}propertyExists(e){return!(!this._metadataTable||!this._metadataTable.hasProperty(e))||(!(!this._batchTableHierarchy||!this._batchTableHierarchy.propertyExists(e))||!(!this._jsonMetadataTable||!this._jsonMetadataTable.hasProperty(e)))}propertyExistsBySemantic(e){return!!this._metadataTable&&this._metadataTable.hasPropertyBySemantic(e)}getPropertyIds(e,t=[]){return t.length=0,this._metadataTable&&t.push(...this._metadataTable.getPropertyIds(YF)),this._batchTableHierarchy&&t.push(...this._batchTableHierarchy.getPropertyIds(e,YF)),this._jsonMetadataTable&&t.push(...this._jsonMetadataTable.getPropertyIds(YF)),t}getProperty(e,t){let i;return this._metadataTable&&(i=this._metadataTable.getProperty(e,t),i)||this._batchTableHierarchy&&(i=this._batchTableHierarchy.getProperty(e,t),i)||this._jsonMetadataTable&&(i=this._jsonMetadataTable.getProperty(e,t),i)?i:void 0}setProperty(e,t,i){this._metadataTable&&this._metadataTable.setProperty(e,t,i)||this._batchTableHierarchy&&this._batchTableHierarchy.setProperty(e,t,i)||(this._jsonMetadataTable||(this._jsonMetadataTable=new KF({count:this._count,properties:{}})),this._jsonMetadataTable.setProperty(e,t,i))}getPropertyBySemantic(e,t){return this._metadataTable?this._metadataTable.getPropertyBySemantic(e,t):void 0}setPropertyBySemantic(e,t,i){return!!this._metadataTable&&this._metadataTable.setPropertyBySemantic(e,t,i)}getPropertyTypedArray(e){return this._metadataTable?this._metadataTable.getPropertyTypedArray(e):void 0}getPropertyTypedArrayBySemantic(e){return this._metadataTable?this._metadataTable.getPropertyTypedArrayBySemantic(e):void 0}isClass(e,t){return!!this._batchTableHierarchy&&this._batchTableHierarchy.isClass(e,t)}isExactClass(e,t){return this.getExactClassName(e)===t}getExactClassName(e){return this._batchTableHierarchy?this._batchTableHierarchy.getClassName(e):void 0}}class kF{constructor(e){const t=(e=lm(e,lm.EMPTY_OBJECT)).property,i=e.classProperty,n=e.textures,s=am(t.channels)?t.channels:[0],o=t;this._textureInfo=o,this._channels=function(e){return e.map((function(e){return"rgba".charAt(e)})).join("")}(s),this._texture=n[o.index],this._min=t.min,this._max=t.max;let r=t.offset,a=t.scale;const l=i.hasValueTransform||am(r)||am(a);r=lm(r,i.offset),a=lm(a,i.scale),r=i.unpackVectorAndMatrixTypes(r),a=i.unpackVectorAndMatrixTypes(a),this._offset=r,this._scale=a,this._hasValueTransform=l,this._classProperty=i,this._extras=t.extras,this._extensions=t.extensions}get texture(){return this._texture}get channels(){return this._channels}get offset(){return this._offset}get scale(){return this._scale}get extra(){return this._extras}get extensions(){return this._extensions}get classProperty(){return this._classProperty}get textureInfo(){return this._textureInfo}}class OF{constructor(e){const t=(e=lm(e,lm.EMPTY_OBJECT)).propertyTexture,i=e.class,n=e.textures,s=t.extensions,o=t.extras,r={};if(am(t.properties))for(const a in t.properties)t.properties.hasOwnProperty(a)&&(r[a]=new kF({property:t.properties[a],classProperty:i.properties[a],textures:n}));this._name=e.name,this._id=e.id,this._class=i,this._properties=r,this._extras=o,this._extensions=s}get name(){return this._name}get id(){return this._id}get class(){return this._class}get properties(){return this._properties}get extras(){return this._extras}get extensions(){return this._extensions}getProperty(e){return this._properties[e]}}class UF{constructor(e){const t=(e=lm(e,lm.EMPTY_OBJECT)).property,i=e.classProperty;this._attribute=t.attribute,this._classProperty=i,this._min=t.min,this._max=t.max;let n=t.offset,s=t.scale;const o=i.hasValueTransform||am(n)||am(s);n=lm(n,i.offset),s=lm(s,i.scale),n=i.unpackVectorAndMatrixTypes(n),s=i.unpackVectorAndMatrixTypes(s),this._offset=n,this._scale=s,this._hasValueTransform=o,this._extras=t.extras,this._extensions=t.extensions}get attribute(){return this._attribute}get hasValueTransform(){return this._hasValueTransform}get offset(){return this._offset}get scale(){return this._scale}get classProperty(){return this._classProperty}get extras(){return this._extras}get extensions(){return this._extensions}}class QF{constructor(e){const t=(e=lm(e,lm.EMPTY_OBJECT)).propertyAttribute,i=e.class,n={};if(am(t.properties))for(const s in t.properties)t.properties.hasOwnProperty(s)&&(n[s]=new UF({property:t.properties[s],classProperty:i.properties[s]}));this._name=e.name,this._id=e.id,this._class=i,this._properties=n,this._extras=t.extras,this._extensions=t.extensions}get name(){return this._name}get id(){return this._id}get class(){return this._class}get properties(){return this._properties}get extras(){return this._extras}get extensions(){return this._extensions}getProperty(e){return this._properties[e]}}const JF="EXT_structural_metadata";function jF(e,t=[]){var i;const n=(null==(i=e.json.textures)?void 0:i.length)||0,s=new Array(n).fill(null);return t.forEach((({properties:t})=>{for(const i in t)if(t.hasOwnProperty(i)){const{index:n}=t[i];null===s[n]&&(s[n]=e.loadTexture(n))}})),Promise.all(s)}function qF(e,t=[]){var i;const n=(null==(i=e.json.bufferViews)?void 0:i.length)||0,s=new Array(n).fill(null);return t.forEach((({properties:t})=>{for(const i in t)if(t.hasOwnProperty(i)){const{values:n,arrayOffsets:o,stringOffsets:r}=t[i];null===s[n]&&(s[n]=e.loadBufferView(n)),null===s[o]&&(s[o]=e.loadBufferView(o)),null===s[r]&&(s[r]=e.loadBufferView(r))}})),Promise.all(s)}class $F{constructor(e){this.parser=e,this.name=JF}async afterRoot({scene:e,parser:t}){const i=t.json.extensionsUsed;if(!i||!i.includes(JF))return;let n=null,s=t.json.extensions[JF];if(s.schemaUri){const{manager:e,path:i,requestHeader:o,crossOrigin:r}=t.options,a=new URL(s.schemaUri,i).toString(),l=new zl(e);l.setCrossOrigin(r),l.setResponseType("json"),l.setRequestHeader(o),n=l.loadAsync(a).then((e=>{s={...s,schema:e}}))}const[o,r]=await Promise.all([jF(t,s.propertyTextures),qF(t,s.propertyTables),n]),a=r.map((e=>{if(e)return new Uint8Array(e)})),l=BF.fromJson(s.schema),g=function(e){const t=(e=lm(e,lm.EMPTY_OBJECT)).extension,i=e.schema,n=[];if(am(t.propertyTables))for(let r=0;r<t.propertyTables.length;r++){const s=t.propertyTables[r],o=i.classes[s.class],a=new LF({count:s.count,properties:s.properties,class:o,bufferViews:e.bufferViews});n.push(new PF({id:r,name:s.name,count:s.count,metadataTable:a,extras:s.extras,extensions:s.extensions}))}const s=[];if(am(t.propertyTextures))for(let r=0;r<t.propertyTextures.length;r++){const n=t.propertyTextures[r];s.push(new OF({id:r,name:n.name,propertyTexture:n,class:i.classes[n.class],textures:e.textures}))}const o=[];if(am(t.propertyAttributes))for(let r=0;r<t.propertyAttributes.length;r++){const e=t.propertyAttributes[r];o.push(new QF({id:r,name:e.name,class:i.classes[e.class],propertyAttribute:e}))}return new lF({schema:i,propertyTables:n,propertyTextures:s,propertyAttributes:o,statistics:t.statistics,extras:t.extras,extensions:t.extensions})}({extension:s,schema:l,bufferViews:a,textures:o});e.userData.structuralMetadata=g,e.traverse((e=>{if(t.associations.has(e)){const{meshes:i,primitives:n}=t.associations.get(e);if(am(i)&&am(n)){const s=t.json.meshes[i].primitives[n];if(s&&s.extensions&&s.extensions[JF]){const t=s.extensions[JF];e.userData.structuralMetadata=function(e,t){let i=[],n=[];if(t){if(t.propertyTextures){const n=e.propertyTextures;i=t.propertyTextures.map((e=>n[e]))}if(t.propertyAttributes){const i=e.propertyAttributes;n=t.propertyAttributes.map((e=>i[e]))}}return new lF({schema:e.schema,propertyTables:e.propertyTables,propertyTextures:i,propertyAttributes:n,extras:e.extras,extensions:e.extensions})}(g,t)}else e.userData.structuralMetadata=g}}}))}}class eX extends Fl{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.forceUnlit=!1,this.pluginCallbacks=[],this.register((function(e){return new rX(e)})),this.register((function(e){return new IX(e)})),this.register((function(e){return new pX(e)})),this.register((function(e){return new mX(e)})),this.register((function(e){return new lX(e)})),this.register((function(e){return new gX(e)})),this.register((function(e){return new cX(e)})),this.register((function(e){return new dX(e)})),this.register((function(e){return new oX(e)})),this.register((function(e){return new hX(e)})),this.register((function(e){return new aX(e)})),this.register((function(e){return new uX(e)})),this.register((function(e){return new nX(e)})),this.register((function(e){return new AX(e)})),this.register((function(e){return new CX(e)})),this.register((function(e){return new aF(e)})),this.register((function(e){return new $F(e)}))}load(e,t,i,n){const s=this;let o;o=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:sg.extractUrlBase(e),this.manager.itemStart(e);const r=function(t){n?n(t):console.error(t),s.manager.itemError(e),s.manager.itemEnd(e)},a=new zl(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,(function(i){try{s.parse(i,o,(function(i){t(i),s.manager.itemEnd(e)}),r)}catch(pb){r(pb)}}),i,r)}setForceUnlit(e){return this.forceUnlit=e,this}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,i,n){let s;const o={},r={},a=new TextDecoder;if("string"==typeof e)s=JSON.parse(e);else if(e instanceof ArrayBuffer){const t=a.decode(new Uint8Array(e,0,4));if(t===bX||t===fX){try{o[iX.KHR_BINARY_GLTF]=new vX(e)}catch(g){return void(n&&n(g))}s=JSON.parse(o[iX.KHR_BINARY_GLTF].content)}else s=JSON.parse(a.decode(e))}else s=e;if(void 0===s.asset||s.asset.version[0]<2)return void(n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new UX(s,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder,forceUnlit:this.forceUnlit});l.fileLoader.setRequestHeader(this.requestHeader);for(let c=0;c<this.pluginCallbacks.length;c++){const e=this.pluginCallbacks[c](l);r[e.name]=e,o[e.name]=!0}if(s.extensionsUsed)for(let c=0;c<s.extensionsUsed.length;++c){const e=s.extensionsUsed[c],t=s.extensionsRequired||[];switch(e){case iX.KHR_MATERIALS_UNLIT:o[e]=new sX;break;case iX.KHR_DRACO_MESH_COMPRESSION:o[e]=new xX(s,this.dracoLoader);break;case iX.KHR_TEXTURE_TRANSFORM:o[e]=new BX;break;case iX.KHR_MESH_QUANTIZATION:o[e]=new wX;break;case iX.KHR_TEXTURE_BASISU:o[e]=new IX(l);break;default:t.indexOf(e)>=0&&void 0===r[e]&&console.warn('THREE.GLTFLoader: Unknown extension "'+e+'".')}}if(s.textures)for(let c=0,d=s.textures.length;c<d;c++){const e=s.textures[c];e.extensions&&e.extensions.KHR_texture_basisu&&"number"==typeof e.extensions.KHR_texture_basisu.source&&(e.source=e.source||e.extensions.KHR_texture_basisu.source);"image/ktx2"===s.images[e.source].mimeType&&(o.KHR_texture_basisu=new IX(l),s.textures[c].extensions={KHR_texture_basisu:e})}this.forceUnlit&&(o.KHR_materials_unlit=new sX),l.setExtensions(o),l.setPlugins(r),l.parse(i,n)}parseAsync(e,t){const i=this;return new Promise((function(n,s){i.parse(e,t,n,s)}))}}function tX(){let e={};return{get:function(t){return e[t]},add:function(t,i){e[t]=i},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const iX={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class nX{constructor(e){this.parser=e,this.name=iX.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let i=0,n=t.length;i<n;i++){const n=t[i];n.extensions&&n.extensions[this.name]&&void 0!==n.extensions[this.name].light&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,i="light:"+e;let n=t.cache.get(i);if(n)return n;const s=t.json,o=((s.extensions&&s.extensions[this.name]||{}).lights||[])[e];let r;const a=new In(16777215);void 0!==o.color&&a.fromArray(o.color);const l=void 0!==o.range?o.range:0;switch(o.type){case"directional":r=new ig(a),r.target.position.set(0,0,-1),r.add(r.target);break;case"point":r=new eg(a),r.distance=l;break;case"spot":r=new Ql(a),r.distance=l,o.spot=o.spot||{},o.spot.innerConeAngle=void 0!==o.spot.innerConeAngle?o.spot.innerConeAngle:0,o.spot.outerConeAngle=void 0!==o.spot.outerConeAngle?o.spot.outerConeAngle:Math.PI/4,r.angle=o.spot.outerConeAngle,r.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,r.target.position.set(0,0,-1),r.add(r.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+o.type)}return r.position.set(0,0,0),r.decay=2,DX(r,o),void 0!==o.intensity&&(r.intensity=o.intensity),r.name=t.createUniqueName(o.name||"light_"+e),n=Promise.resolve(r),t.cache.add(i,n),n}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,i=this.parser,n=i.json.nodes[e],s=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===s?null:this._loadLight(s).then((function(e){return i._getNodeRef(t.cache,s,e)}))}}class sX{constructor(){this.name=iX.KHR_MATERIALS_UNLIT}getMaterialType(){return Cn}extendParams(e,t,i){const n=[];e.color=new In(1,1,1),e.opacity=1;const s=t.pbrMetallicRoughness;if(s){if(Array.isArray(s.baseColorFactor)){const t=s.baseColorFactor;e.color.fromArray(t),e.opacity=t[3]}void 0!==s.baseColorTexture&&n.push(i.assignTexture(e,"map",s.baseColorTexture,Ye))}return Promise.all(n)}}class oX{constructor(e){this.parser=e,this.name=iX.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name].emissiveStrength;return void 0!==n&&(t.emissiveIntensity=n),Promise.resolve()}}class rX{constructor(e){this.parser=e,this.name=iX.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?pl:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];if(void 0!==o.clearcoatFactor&&(t.clearcoat=o.clearcoatFactor),void 0!==o.clearcoatTexture&&s.push(i.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),void 0!==o.clearcoatRoughnessFactor&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),void 0!==o.clearcoatRoughnessTexture&&s.push(i.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),void 0!==o.clearcoatNormalTexture&&(s.push(i.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),void 0!==o.clearcoatNormalTexture.scale)){const e=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new bt(e,e)}return Promise.all(s)}}class aX{constructor(e){this.parser=e,this.name=iX.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?pl:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return void 0!==o.iridescenceFactor&&(t.iridescence=o.iridescenceFactor),void 0!==o.iridescenceTexture&&s.push(i.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),void 0!==o.iridescenceIor&&(t.iridescenceIOR=o.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==o.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),void 0!==o.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),void 0!==o.iridescenceThicknessTexture&&s.push(i.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(s)}}class lX{constructor(e){this.parser=e,this.name=iX.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?pl:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[];t.sheenColor=new In(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=n.extensions[this.name];return void 0!==o.sheenColorFactor&&t.sheenColor.fromArray(o.sheenColorFactor),void 0!==o.sheenRoughnessFactor&&(t.sheenRoughness=o.sheenRoughnessFactor),void 0!==o.sheenColorTexture&&s.push(i.assignTexture(t,"sheenColorMap",o.sheenColorTexture,Ye)),void 0!==o.sheenRoughnessTexture&&s.push(i.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(s)}}class gX{constructor(e){this.parser=e,this.name=iX.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?pl:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return void 0!==o.transmissionFactor&&(t.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&s.push(i.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(s)}}class cX{constructor(e){this.parser=e,this.name=iX.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?pl:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];t.thickness=void 0!==o.thicknessFactor?o.thicknessFactor:0,void 0!==o.thicknessTexture&&s.push(i.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const r=o.attenuationColor||[1,1,1];return t.attenuationColor=new In(r[0],r[1],r[2]),Promise.all(s)}}class dX{constructor(e){this.parser=e,this.name=iX.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?pl:null}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name];return t.ior=void 0!==n.ior?n.ior:1.5,Promise.resolve()}}class hX{constructor(e){this.parser=e,this.name=iX.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?pl:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];t.specularIntensity=void 0!==o.specularFactor?o.specularFactor:1,void 0!==o.specularTexture&&s.push(i.assignTexture(t,"specularIntensityMap",o.specularTexture));const r=o.specularColorFactor||[1,1,1];return t.specularColor=new In(r[0],r[1],r[2]),void 0!==o.specularColorTexture&&s.push(i.assignTexture(t,"specularColorMap",o.specularColorTexture,Ye)),Promise.all(s)}}class uX{constructor(e){this.parser=e,this.name=iX.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?pl:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return void 0!==o.anisotropyStrength&&(t.anisotropy=o.anisotropyStrength),void 0!==o.anisotropyRotation&&(t.anisotropyRotation=o.anisotropyRotation),void 0!==o.anisotropyTexture&&s.push(i.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(s)}}class IX{constructor(e){this.parser=e,this.name=iX.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,i=t.json,n=i.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const s=n.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,s.source,o)}}class pX{constructor(e){this.parser=e,this.name=iX.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,i=this.parser,n=i.json,s=n.textures[e];if(!s.extensions||!s.extensions[t])return null;const o=s.extensions[t],r=n.images[o.source];let a=i.textureLoader;if(r.uri){const e=i.options.manager.getHandler(r.uri);null!==e&&(a=e)}return this.detectSupport().then((function(s){if(s)return i.loadTextureImage(e,o.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return i.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class mX{constructor(e){this.parser=e,this.name=iX.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,i=this.parser,n=i.json,s=n.textures[e];if(!s.extensions||!s.extensions[t])return null;const o=s.extensions[t],r=n.images[o.source];let a=i.textureLoader;if(r.uri){const e=i.options.manager.getHandler(r.uri);null!==e&&(a=e)}return this.detectSupport().then((function(s){if(s)return i.loadTextureImage(e,o.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return i.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class AX{constructor(e){this.name=iX.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,i=t.bufferViews[e];if(i.extensions&&i.extensions[this.name]){const e=i.extensions[this.name],n=this.parser.getDependency("buffer",e.buffer),s=this.parser.options.meshoptDecoder;if(!s||!s.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then((function(t){const i=e.byteOffset||0,n=e.byteLength||0,o=e.count,r=e.byteStride,a=new Uint8Array(t,i,n);return s.decodeGltfBufferAsync?s.decodeGltfBufferAsync(o,r,a,e.mode,e.filter).then((function(e){return e.buffer})):s.ready.then((function(){const t=new ArrayBuffer(o*r);return s.decodeGltfBuffer(new Uint8Array(t),o,r,a,e.mode,e.filter),t}))}))}return null}}class CX{constructor(e){this.name=iX.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,i=t.nodes[e];if(!i.extensions||!i.extensions[this.name]||void 0===i.mesh)return null;const n=t.meshes[i.mesh];for(const a of n.primitives)if(a.mode!==RX.TRIANGLES&&a.mode!==RX.TRIANGLE_STRIP&&a.mode!==RX.TRIANGLE_FAN&&void 0!==a.mode)return null;const s=i.extensions[this.name].attributes,o=[],r={};for(const a in s)o.push(this.parser.getDependency("accessor",s[a]).then((e=>(r[a]=e,r[a]))));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then((e=>{const t=e.pop(),i=t.isGroup?t.children:[t],n=e[0].count,s=[];for(const o of i){const e=new Bi,t=new Qt,i=new Ut,a=new Qt(1,1,1),l=new Va(o.geometry,o.material,n);for(let s=0;s<n;s++)r.TRANSLATION&&t.fromBufferAttribute(r.TRANSLATION,s),r.ROTATION&&i.fromBufferAttribute(r.ROTATION,s),r.SCALE&&a.fromBufferAttribute(r.SCALE,s),l.setMatrixAt(s,e.compose(t,i,a));for(const n in r)"TRANSLATION"!==n&&"ROTATION"!==n&&"SCALE"!==n&&o.geometry.setAttribute(n,r[n]);Ji.prototype.copy.call(l,o),this.parser.assignFinalMaterial(l),s.push(l)}return t.isGroup?(t.clear(),t.add(...s),t):s[0]})))}}const fX="embf",bX="glTF",yX=1313821514,_X=5130562;class vX{constructor(e){this.name=iX.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new TextDecoder;let i=0;if(t.decode(new Uint8Array(e.slice(0,4)))===fX){if(1===new Uint8Array(e,4,1)[0]){i=6+new Uint8Array(e,5,1)[0]}}const n=new DataView(e,i,12);if(this.header={magic:t.decode(new Uint8Array(e.slice(i,i+4))),version:n.getUint32(4,!0),length:n.getUint32(8,!0)},this.header.magic!==bX)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const s=this.header.length-12+i,o=new DataView(e,12);let r=i;for(;r<s;){const i=o.getUint32(r,!0);r+=4;const n=o.getUint32(r,!0);if(r+=4,n===yX){const n=new Uint8Array(e,12+r,i);this.content=t.decode(n)}else if(n===_X){const t=12+r;this.body=e.slice(t,t+i)}r+=i}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class xX{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=iX.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const i=this.json,n=this.dracoLoader,s=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,r={},a={},l={};for(const g in o){const e=EX[g]||g.toLowerCase();r[e]=o[g]}for(const g in e.attributes){const t=EX[g]||g.toLowerCase();if(void 0!==o[g]){const n=i.accessors[e.attributes[g]],s=TX[n.componentType];l[t]=s.name,a[t]=!0===n.normalized}}return t.getDependency("bufferView",s).then((function(e){return new Promise((function(t){n.decodeDracoFile(e,(function(e){for(const t in e.attributes){const i=e.attributes[t],n=a[t];void 0!==n&&(i.normalized=n)}t(e)}),r,l)}))}))}}class BX{constructor(){this.name=iX.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class wX{constructor(){this.name=iX.KHR_MESH_QUANTIZATION}}class SX extends bl{constructor(e,t,i,n){super(e,t,i,n)}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,n=this.valueSize,s=e*n*3+n;for(let o=0;o!==n;o++)t[o]=i[s+o];return t}interpolate_(e,t,i,n){const s=this.resultBuffer,o=this.sampleValues,r=this.valueSize,a=2*r,l=3*r,g=n-t,c=(i-t)/g,d=c*c,h=d*c,u=e*l,I=u-l,p=-2*h+3*d,m=h-d,A=1-p,C=m-d+c;for(let f=0;f!==r;f++){const e=o[I+f+r],t=o[I+f+a]*g,i=o[u+f+r],n=o[u+f]*g;s[f]=A*e+C*t+p*i+m*n}return s}}const GX=new Ut;class MX extends SX{interpolate_(e,t,i,n){const s=super.interpolate_(e,t,i,n);return GX.fromArray(s).normalize().toArray(s),s}}const RX={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},TX={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ZX={9728:T,9729:W,9984:Z,9985:E,9986:V,9987:N},VX={33071:M,33648:R,10497:G},WX={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},EX={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},NX={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},FX={CUBICSPLINE:void 0,LINEAR:Ee,STEP:We},XX="OPAQUE",HX="MASK",zX="BLEND";function LX(e,t,i){for(const n in i.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=i.extensions[n])}function DX(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function KX(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let i=0,n=t.weights.length;i<n;i++)e.morphTargetInfluences[i]=t.weights[i];if(t.extras&&Array.isArray(t.extras.targetNames)){const i=t.extras.targetNames;if(e.morphTargetInfluences.length===i.length){e.morphTargetDictionary={};for(let t=0,n=i.length;t<n;t++)e.morphTargetDictionary[i[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function YX(e){let t;const i=e.extensions&&e.extensions[iX.KHR_DRACO_MESH_COMPRESSION];if(t=i?"draco:"+i.bufferView+":"+i.indices+":"+PX(i.attributes):e.indices+":"+PX(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,s=e.targets.length;n<s;n++)t+=":"+PX(e.targets[n]);return t}function PX(e){let t="";const i=Object.keys(e).sort();for(let n=0,s=i.length;n<s;n++)t+=i[n]+":"+e[i[n]]+";";return t}function kX(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const OX=new Bi;class UX{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new tX,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let i=!1,n=!1,s=-1;"undefined"!=typeof navigator&&(i=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),n=navigator.userAgent.indexOf("Firefox")>-1,s=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||i||n&&s<98?this.textureLoader=new Dl(this.options.manager):this.textureLoader=new rg(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new zl(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const i=this,n=this.json,s=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])})).then((function(t){const o={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:i,userData:{}};LX(s,o,n),DX(o,n),Promise.all(i._invokeAll((function(e){return e.afterRoot&&e.afterRoot(o)}))).then((function(){e(o)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[];for(let n=0,s=t.length;n<s;n++){const i=t[n].joints;for(let t=0,n=i.length;t<n;t++)e[i[t]].isBone=!0}for(let n=0,s=e.length;n<s;n++){const t=e[n];void 0!==t.mesh&&(this._addNodeRef(this.meshCache,t.mesh),void 0!==t.skin&&(i[t.mesh].isSkinnedMesh=!0)),void 0!==t.camera&&this._addNodeRef(this.cameraCache,t.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,i){if(e.refs[t]<=1)return i;const n=i.clone(),s=(e,t)=>{const i=this.associations.get(e);null!=i&&this.associations.set(t,i);for(const[n,o]of e.children.entries())s(o,t.children[n])};return s(i,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let i=0;i<t.length;i++){const n=e(t[i]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const i=[];for(let n=0;n<t.length;n++){const s=e(t[n]);s&&i.push(s)}return i}getDependency(e,t){const i=e+":"+t;let n=this.cache.get(i);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne((function(e){return e.loadNode&&e.loadNode(t)}));break;case"mesh":n=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":n=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne((function(i){return i!=this&&i.getDependency&&i.getDependency(e,t)})),!n)throw new Error("Unknown type: "+e)}this.cache.add(i,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const i=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map((function(t,n){return i.getDependency(e,n)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],i=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[iX.KHR_BINARY_GLTF].body);const n=this.options;return new Promise((function(e,s){i.load(sg.resolveURL(t.uri,n.path),e,void 0,(function(){s(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const i=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+i)}))}loadAccessor(e){const t=this,i=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse){const e=WX[n.type],t=TX[n.componentType],i=!0===n.normalized,s=new t(n.count*e);return Promise.resolve(new Bn(s,e,i))}const s=[];return void 0!==n.bufferView?s.push(this.getDependency("bufferView",n.bufferView)):s.push(null),void 0!==n.sparse&&(s.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),s.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(s).then((function(e){const s=e[0],o=WX[n.type],r=TX[n.componentType],a=r.BYTES_PER_ELEMENT,l=a*o,g=n.byteOffset||0,c=void 0!==n.bufferView?i.bufferViews[n.bufferView].byteStride:void 0,d=!0===n.normalized;let h,u;if(c&&c!==l){const e=Math.floor(g/c),i="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+e+":"+n.count;let l=t.cache.get(i);l||(h=new r(s,e*c,n.count*c/a),l=new aa(h,c/a),t.cache.add(i,l)),u=new ga(l,o,g%c/a,d)}else h=null===s?new r(n.count*o):new r(s,g,n.count*o),u=new Bn(h,o,d);if(void 0!==n.sparse){const t=WX.SCALAR,i=TX[n.sparse.indices.componentType],a=n.sparse.indices.byteOffset||0,l=n.sparse.values.byteOffset||0,g=new i(e[1],a,n.sparse.count*t),c=new r(e[2],l,n.sparse.count*o);null!==s&&(u=new Bn(u.array.slice(),u.itemSize,u.normalized));for(let e=0,n=g.length;e<n;e++){const t=g[e];if(u.setX(t,c[e*o]),o>=2&&u.setY(t,c[e*o+1]),o>=3&&u.setZ(t,c[e*o+2]),o>=4&&u.setW(t,c[e*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return u}))}loadTexture(e){const t=this.json,i=this.options,n=t.textures[e].source,s=t.images[n],o=this.extensions;let r=this.textureLoader;if("image/ktx2"===s.mimeType&&o[iX.KHR_TEXTURE_BASISU])return o[iX.KHR_TEXTURE_BASISU].loadTexture(e);if(s.uri){const e=i.manager.getHandler(s.uri);null!==e&&(r=e)}return this.loadTextureImage(e,n,r)}loadTextureImage(e,t,i){const n=this,s=this.json,o=s.textures[e],r=s.images[t],a=(r.uri||r.bufferView)+":"+o.sampler;if(this.textureCache[a])return this.textureCache[a];const l=this.loadImageSource(t,i).then((function(t){t.flipY=!1,t.name=o.name||r.name||"",""===t.name&&"string"==typeof r.uri&&!1===r.uri.startsWith("data:image/")&&(t.name=r.uri);const i=(s.samplers||{})[o.sampler]||{};return t.magFilter=ZX[i.magFilter]||W,t.minFilter=ZX[i.minFilter]||N,t.wrapS=VX[i.wrapS]||G,t.wrapT=VX[i.wrapT]||G,n.associations.set(t,{textures:e}),t})).catch((function(){return null}));return this.textureCache[a]=l,l}loadImageSource(e,t){const i=this,n=this.json,s=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const o=n.images[e],r=self.URL||self.webkitURL;let a=o.uri||"",l=!1;if(void 0!==o.bufferView)a=i.getDependency("bufferView",o.bufferView).then((function(e){l=!0;const t=new Blob([e],{type:o.mimeType});return a=r.createObjectURL(t),a}));else if(void 0===o.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const g=Promise.resolve(a).then((function(e){return new Promise((function(i,n){let o=i;!0===t.isImageBitmapLoader&&(o=function(e){const t=new Lt(e);t.needsUpdate=!0,i(t)}),t.load(sg.resolveURL(e,s.path),o,void 0,n)}))})).then((function(e){var t;return!0===l&&r.revokeObjectURL(a),e.userData.mimeType=o.mimeType||((t=o.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e}));return this.sourceCache[e]=g,g}assignTexture(e,t,i,n){const s=this;return this.getDependency("texture",i.index).then((function(o){if(!o)return null;if(void 0!==i.texCoord&&i.texCoord>0&&((o=o.clone()).channel=i.texCoord),s.extensions[iX.KHR_TEXTURE_TRANSFORM]){const e=void 0!==i.extensions?i.extensions[iX.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=s.associations.get(o);o=s.extensions[iX.KHR_TEXTURE_TRANSFORM].extendTexture(o,e),s.associations.set(o,t)}}return void 0!==n&&(o.colorSpace=n),e[t]=o,o}))}assignFinalMaterial(e){const t=e.geometry;let i=e.material;const n=void 0===t.attributes.tangent,s=void 0!==t.attributes.color,o=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+i.uuid;let t=this.cache.get(e);t||(t=new Pa,An.prototype.copy.call(t,i),t.color.copy(i.color),t.map=i.map,t.sizeAttenuation=!1,this.cache.add(e,t)),i=t}else if(e.isLine){const e="LineBasicMaterial:"+i.uuid;let t=this.cache.get(e);t||(t=new Wa,An.prototype.copy.call(t,i),t.color.copy(i.color),t.map=i.map,this.cache.add(e,t)),i=t}if(n||s||o){let e="ClonedMaterial:"+i.uuid+":";n&&(e+="derivative-tangents:"),s&&(e+="vertex-colors:"),o&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=i.clone(),s&&(t.vertexColors=!0),o&&(t.flatShading=!0),n&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(i))),i=t}e.material=i}getMaterialType(){return Il}loadMaterial(e){const t=this,i=this.json,n=this.extensions,s=i.materials[e];let o;const r={},a=[];if((s.extensions||{})[iX.KHR_MATERIALS_UNLIT]||t.options.forceUnlit){const e=n[iX.KHR_MATERIALS_UNLIT];o=e.getMaterialType(),a.push(e.extendParams(r,s,t))}else{const i=s.pbrMetallicRoughness||{};if(r.color=new In(1,1,1),r.opacity=1,Array.isArray(i.baseColorFactor)){const e=i.baseColorFactor;r.color.fromArray(e),r.opacity=e[3]}void 0!==i.baseColorTexture&&a.push(t.assignTexture(r,"map",i.baseColorTexture,Ye)),r.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,r.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(a.push(t.assignTexture(r,"metalnessMap",i.metallicRoughnessTexture)),a.push(t.assignTexture(r,"roughnessMap",i.metallicRoughnessTexture))),o=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),a.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,r)}))))}!0===s.doubleSided&&(r.side=2);const l=s.alphaMode||XX;if(l===zX?(r.transparent=!0,r.depthWrite=!1):(r.transparent=!1,l===HX&&(r.alphaTest=void 0!==s.alphaCutoff?s.alphaCutoff:.5)),void 0!==s.normalTexture&&o!==Cn&&(a.push(t.assignTexture(r,"normalMap",s.normalTexture)),r.normalScale=new bt(1,1),void 0!==s.normalTexture.scale)){const e=s.normalTexture.scale;r.normalScale.set(e,e)}return void 0!==s.occlusionTexture&&o!==Cn&&(a.push(t.assignTexture(r,"aoMap",s.occlusionTexture)),void 0!==s.occlusionTexture.strength&&(r.aoMapIntensity=s.occlusionTexture.strength)),void 0!==s.emissiveFactor&&o!==Cn&&(r.emissive=(new In).fromArray(s.emissiveFactor)),void 0!==s.emissiveTexture&&o!==Cn&&a.push(t.assignTexture(r,"emissiveMap",s.emissiveTexture,Ye)),Promise.all(a).then((function(){const i=new o(r);return s.name&&(i.name=s.name),DX(i,s),t.associations.set(i,{materials:e}),s.extensions&&LX(n,i,s),i}))}createUniqueName(e){const t=mg.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,i=this.extensions,n=this.primitiveCache;function s(e){return i[iX.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(i){return QX(i,e,t)}))}const o=[];for(let r=0,a=e.length;r<a;r++){const i=e[r],a=YX(i),l=n[a];if(l)o.push(l.promise);else{let e;e=i.extensions&&i.extensions[iX.KHR_DRACO_MESH_COMPRESSION]?s(i):QX(new Fn,i,t),n[a]={primitive:i,promise:e},o.push(e)}}return Promise.all(o)}loadMesh(e){const t=this,i=this.json,n=this.extensions,s=i.meshes[e],o=s.primitives,r=[];for(let l=0,c=o.length;l<c;l++){const e=void 0===o[l].material?(void 0===(a=this.cache).DefaultMaterial&&(a.DefaultMaterial=new Il({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:g})),a.DefaultMaterial):this.getDependency("material",o[l].material);r.push(e)}var a;return r.push(t.loadGeometries(o)),Promise.all(r).then((function(i){const r=i.slice(0,i.length-1),a=i[i.length-1],l=[];for(let c=0,d=a.length;c<d;c++){const i=a[c],g=o[c];let d;const h=r[c];if(g.mode===RX.TRIANGLES||g.mode===RX.TRIANGLE_STRIP||g.mode===RX.TRIANGLE_FAN||void 0===g.mode)d=!0===s.isSkinnedMesh?new fa(i,h):new ts(i,h),!0===d.isSkinnedMesh&&d.normalizeSkinWeights(),g.mode===RX.TRIANGLE_STRIP?d.geometry=KN(d.geometry,1):g.mode===RX.TRIANGLE_FAN&&(d.geometry=KN(d.geometry,2));else if(g.mode===RX.LINES)d=new Ka(i,h);else if(g.mode===RX.LINE_STRIP)d=new za(i,h);else if(g.mode===RX.LINE_LOOP)d=new Ya(i,h);else{if(g.mode!==RX.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+g.mode);d=new Ja(i,h)}Object.keys(d.geometry.morphAttributes).length>0&&KX(d,s),d.name=t.createUniqueName(s.name||"mesh_"+e),DX(d,s),g.extensions&&LX(n,d,g),t.assignFinalMaterial(d),l.push(d)}for(let n=0,s=l.length;n<s;n++)t.associations.set(l[n],{meshes:e,primitives:n});if(1===l.length)return s.extensions&&LX(n,l[0],s),l[0];const g=new qr;s.extensions&&LX(n,g,s),t.associations.set(g,{meshes:e});for(let e=0,t=l.length;e<t;e++)g.add(l[e]);return g}))}loadCamera(e){let t;const i=this.json.cameras[e],n=i[i.type];if(n)return"perspective"===i.type?t=new cs(ft.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===i.type&&(t=new Es(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),DX(t,i),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],i=[];for(let n=0,s=t.joints.length;n<s;n++)i.push(this._loadNodeShallow(t.joints[n]));return void 0!==t.inverseBindMatrices?i.push(this.getDependency("accessor",t.inverseBindMatrices)):i.push(null),Promise.all(i).then((function(e){const i=e.pop(),n=e,s=[],o=[];for(let r=0,a=n.length;r<a;r++){const e=n[r];if(e){s.push(e);const t=new Bi;null!==i&&t.fromArray(i.array,16*r),o.push(t)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[r])}return new xa(s,o)}))}loadAnimation(e){const t=this.json.animations[e],i=t.name?t.name:"animation_"+e,n=[],s=[],o=[],r=[],a=[];for(let l=0,g=t.channels.length;l<g;l++){const e=t.channels[l],i=t.samplers[e.sampler],g=e.target,c=g.node,d=void 0!==t.parameters?t.parameters[i.input]:i.input,h=void 0!==t.parameters?t.parameters[i.output]:i.output;void 0!==g.node&&(n.push(this.getDependency("node",c)),s.push(this.getDependency("accessor",d)),o.push(this.getDependency("accessor",h)),r.push(i),a.push(g))}return Promise.all([Promise.all(n),Promise.all(s),Promise.all(o),Promise.all(r),Promise.all(a)]).then((function(e){const t=e[0],n=e[1],s=e[2],o=e[3],r=e[4],a=[];for(let i=0,l=t.length;i<l;i++){const e=t[i],l=n[i],g=s[i],c=o[i],d=r[i];if(void 0===e)continue;let h;switch(e.updateMatrix(),NX[d.path]){case NX.weights:h=Sl;break;case NX.rotation:h=Ml;break;default:h=Tl}const u=e.name?e.name:e.uuid,I=void 0!==c.interpolation?FX[c.interpolation]:Ee,p=[];NX[d.path]===NX.weights?e.traverse((function(e){e.morphTargetInfluences&&p.push(e.name?e.name:e.uuid)})):p.push(u);let m=g.array;if(g.normalized){const e=kX(m.constructor),t=new Float32Array(m.length);for(let i=0,n=m.length;i<n;i++)t[i]=m[i]*e;m=t}for(let t=0,i=p.length;t<i;t++){const e=new h(p[t]+"."+NX[d.path],l.array,m,I);"CUBICSPLINE"===c.interpolation&&(e.createInterpolant=function(e){return new(this instanceof Ml?MX:SX)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),a.push(e)}}return new Zl(i,void 0,a)}))}createNodeMesh(e){const t=this.json,i=this,n=t.nodes[e];return void 0===n.mesh?null:i.getDependency("mesh",n.mesh).then((function(e){const t=i._getNodeRef(i.meshCache,n.mesh,e);return void 0!==n.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,i=n.weights.length;t<i;t++)e.morphTargetInfluences[t]=n.weights[t]})),t}))}loadNode(e){const t=this,i=this.json.nodes[e],n=t._loadNodeShallow(e),s=[],o=i.children||[];for(let a=0,l=o.length;a<l;a++)s.push(t.getDependency("node",o[a]));const r=void 0===i.skin?Promise.resolve(null):t.getDependency("skin",i.skin);return Promise.all([n,Promise.all(s),r]).then((function(e){const t=e[0],i=e[1],n=e[2];null!==n&&t.traverse((function(e){e.isSkinnedMesh&&e.bind(n,OX)}));for(let s=0,o=i.length;s<o;s++)t.add(i[s]);return t}))}_loadNodeShallow(e){const t=this.json,i=this.extensions,n=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const s=t.nodes[e],o=s.name?n.createUniqueName(s.name):"",r=[],a=n._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return a&&r.push(a),void 0!==s.camera&&r.push(n.getDependency("camera",s.camera).then((function(e){return n._getNodeRef(n.cameraCache,s.camera,e)}))),n._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){r.push(e)})),this.nodeCache[e]=Promise.all(r).then((function(t){let r;if(r=!0===s.isBone?new ba:t.length>1?new qr:1===t.length?t[0]:new Ji,r!==t[0])for(let e=0,i=t.length;e<i;e++)r.add(t[e]);if(s.name&&(r.userData.name=s.name,r.name=o),DX(r,s),s.extensions&&LX(i,r,s),void 0!==s.matrix){const e=new Bi;e.fromArray(s.matrix),r.applyMatrix4(e)}else void 0!==s.translation&&r.position.fromArray(s.translation),void 0!==s.rotation&&r.quaternion.fromArray(s.rotation),void 0!==s.scale&&r.scale.fromArray(s.scale);return n.associations.has(r)||n.associations.set(r,{}),n.associations.get(r).nodes=e,r})),this.nodeCache[e]}loadScene(e){const t=this.extensions,i=this.json.scenes[e],n=this,s=new qr;i.name&&(s.name=n.createUniqueName(i.name)),DX(s,i),i.extensions&&LX(t,s,i);const o=i.nodes||[],r=[];for(let a=0,l=o.length;a<l;a++)r.push(n.getDependency("node",o[a]));return Promise.all(r).then((function(e){for(let t=0,i=e.length;t<i;t++)s.add(e[t]);return n.associations=(e=>{const t=new Map;for(const[i,s]of n.associations)(i instanceof An||i instanceof Lt)&&t.set(i,s);return e.traverse((e=>{const i=n.associations.get(e);null!=i&&t.set(e,i)})),t})(s),s}))}}function QX(e,t,i){const n=t.attributes,s=[];function o(t,n){return i.getDependency("accessor",t).then((function(t){e.setAttribute(n,t)}))}for(const r in n){const t=EX[r]||r.toLowerCase();t in e.attributes||s.push(o(n[r],t))}if(void 0!==t.indices&&!e.index){const n=i.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));s.push(n)}return DX(e,t),function(e,t,i){const n=t.attributes,s=new qt;if(void 0===n.POSITION)return;{const e=i.json.accessors[n.POSITION],t=e.min,o=e.max;if(void 0===t||void 0===o)return void tw("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(s.set(new Qt(t[0],t[1],t[2]),new Qt(o[0],o[1],o[2])),e.normalized){const t=kX(TX[e.componentType]);s.min.multiplyScalar(t),s.max.multiplyScalar(t)}}const o=t.targets;if(void 0!==o){const e=new Qt,t=new Qt;for(let n=0,s=o.length;n<s;n++){const s=o[n];if(void 0!==s.POSITION){const n=i.json.accessors[s.POSITION],o=n.min,r=n.max;if(void 0!==o&&void 0!==r){if(t.setX(Math.max(Math.abs(o[0]),Math.abs(r[0]))),t.setY(Math.max(Math.abs(o[1]),Math.abs(r[1]))),t.setZ(Math.max(Math.abs(o[2]),Math.abs(r[2]))),n.normalized){const e=kX(TX[n.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}s.expandByVector(e)}e.boundingBox=s;const r=new mi;s.getCenter(r.center),r.radius=s.min.distanceTo(s.max)/2,e.boundingSphere=r}(e,t,i),Promise.all(s).then((function(){return void 0!==t.targets?function(e,t,i){let n=!1,s=!1,o=!1;for(let g=0,c=t.length;g<c;g++){const e=t[g];if(void 0!==e.POSITION&&(n=!0),void 0!==e.NORMAL&&(s=!0),void 0!==e.COLOR_0&&(o=!0),n&&s&&o)break}if(!n&&!s&&!o)return Promise.resolve(e);const r=[],a=[],l=[];for(let g=0,c=t.length;g<c;g++){const c=t[g];if(n){const t=void 0!==c.POSITION?i.getDependency("accessor",c.POSITION):e.attributes.position;r.push(t)}if(s){const t=void 0!==c.NORMAL?i.getDependency("accessor",c.NORMAL):e.attributes.normal;a.push(t)}if(o){const t=void 0!==c.COLOR_0?i.getDependency("accessor",c.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(r),Promise.all(a),Promise.all(l)]).then((function(t){const i=t[0],r=t[1],a=t[2];return n&&(e.morphAttributes.position=i),s&&(e.morphAttributes.normal=r),o&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e}))}(e,t.targets,i):e}))}var JX=function(){var e=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),t=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]);if("object"!=typeof WebAssembly)return{supported:!1};var i,n=WebAssembly.validate(e)?"b9H79TebbbeKl9Gbb9Gvuuuuueu9Giuuub9Geueuikqbbebeedddilve9Weeeviebeoweuec:q;Aekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbdY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVblE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtboK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbrL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbwl79IV9RbDq;t9tqlbzik9:evu8Jjjjjbcz9Rhbcbheincbhdcbhiinabcwfadfaicjuaead4ceGglE86bbaialfhiadcefgdcw9hmbkaec:q:yjjbfai86bbaecitc:q1jjbfab8Piw83ibaecefgecjd9hmbkk;h8JlHud97euo978Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Rad;8qbbcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhwcbhDinaDae9pmeawaeaD9RaDawfae6Egqcsfgoc9WGgkci2hxakcethmaocl4cifcd4hPabaDad2fhscbhzdnincehHalhOcbhAdninaraO9RaP6miavcj;cbfaAak2fhCaOaPfhlcbhidnakc;ab6mbaral9Rc;Gb6mbcbhoinaCaofhidndndndndnaOaoco4fRbbgXciGPlbedibkaipxbbbbbbbbbbbbbbbbpklbxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklbalczfhlkdndndndndnaXcd4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklzxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklzalczfhlkdndndndndnaXcl4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklaxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklaalczfhlkdndndndndnaXco4Plbedibkaipxbbbbbbbbbbbbbbbbpkl8WxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalclfaYpQbfaXc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalcwfaYpQbfaXc:q:yjjbfRbbfhlxekaialpbbbpkl8Walczfhlkaoc;abfhiaocjefak0meaihoaral9Rc;Fb0mbkkdndnaiak9pmbaici4hoinaral9RcK6mdaCaifhXdndndndndnaOaico4fRbbaocoG4ciGPlbedibkaXpxbbbbbbbbbbbbbbbbpklbxikaXalpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaXalpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaXalpbbbpklbalczfhlkaocdfhoaiczfgiak6mbkkalTmbaAci6hHalhOaAcefgohAaoclSmdxekkcbhlaHceGmdkdnakTmbavcjdfazfhiavazfpbdbhYcbhXinaiavcj;cbfaXfgopblbgLcep9TaLpxeeeeeeeeeeeeeeeegQp9op9Hp9rgLaoakfpblbg8Acep9Ta8AaQp9op9Hp9rg8ApmbzeHdOiAlCvXoQrLgEaoamfpblbg3cep9Ta3aQp9op9Hp9rg3aoaxfpblbg5cep9Ta5aQp9op9Hp9rg5pmbzeHdOiAlCvXoQrLg8EpmbezHdiOAlvCXorQLgQaQpmbedibedibedibediaYp9UgYp9AdbbaiadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaEa8EpmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwKDYq8AkEx3m5P8Es8FgLa3a5pmwKDYq8AkEx3m5P8Es8Fg8ApmbezHdiOAlvCXorQLgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfhiaXczfgXak6mbkkazclfgzad6mbkasavcjdfaqad2;8qbbavavcjdfaqcufad2fad;8qbbaqaDfhDc9:hoalmexikkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;kbf8Kjjjjbaokwbz:bjjjbk;uzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecje;8kbavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:EPliuo97eue978Jjjjjbca9Rhidndnadcl9hmbdnaec98GglTmbcbhvabhdinadadpbbbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpkbbadczfhdavclfgval6mbkkalae9pmeaiaeciGgvcdtgdVcbczad9R;8kbaiabalcdtfglad;8qbbdnavTmbaiaipblbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpklbkalaiad;8qbbskdnaec98GgxTmbcbhvabhdinadczfglalpbbbgopxbbbbbbFFbbbbbbFFgkp9oadpbbbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpkbbadaDakp9oawaopmbezHdiOAlvCXorQLp9qpkbbadcafhdavclfgvax6mbkkaxae9pmbaiaeciGgvcitgdfcbcaad9R;8kbaiabaxcitfglad;8qbbdnavTmbaiaipblzgopxbbbbbbFFbbbbbbFFgkp9oaipblbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpklzaiaDakp9oawaopmbezHdiOAlvCXorQLp9qpklbkalaiad;8qbbkk;4wllue97euv978Jjjjjbc8W9Rhidnaec98GglTmbcbhvabhoinaiaopbbbgraoczfgwpbbbgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklbaopxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblbpEb:T:j83ibaocwfarp5eaipblbpEe:T:j83ibawaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblbpEd:T:j83ibaocKfakp5eaipblbpEi:T:j83ibaocafhoavclfgval6mbkkdnalae9pmbaiaeciGgvcitgofcbcaao9R;8kbaiabalcitfgwao;8qbbdnavTmbaiaipblbgraipblzgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklaaipxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblapEb:T:j83ibaiarp5eaipblapEe:T:j83iwaiaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblapEd:T:j83izaiakp5eaipblapEi:T:j83iKkawaiao;8qbbkk:Pddiue978Jjjjjbc;ab9Rhidnadcd4ae2glc98GgvTmbcbhdabheinaeaepbbbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepkbbaeczfheadclfgdav6mbkkdnaval9pmbaialciGgdcdtgeVcbc;abae9R;8kbaiabavcdtfgvae;8qbbdnadTmbaiaipblbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepklbkavaiae;8qbbkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaikkkebcjwklz9Tbb":"b9H79Tebbbe8Fv9Gbb9Gvuuuuueu9Giuuub9Geueu9Giuuueuikqbeeedddillviebeoweuec:q;iekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbeY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVbdE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbiL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtblK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbol79IV9Rbrq:P8Yqdbk;3sezu8Jjjjjbcj;eb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Radz1jjjbhwcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhDcbhqinaqae9pmeaDaeaq9RaqaDfae6Egkcsfgocl4cifcd4hxdndndndnaoc9WGgmTmbcbhPcehsawcjdfhzalhHinaraH9Rax6midnaraHaxfgl9RcK6mbczhoinawcj;cbfaogifgoc9WfhOdndndndndnaHaic9WfgAco4fRbbaAci4coG4ciGPlbedibkaO9cb83ibaOcwf9cb83ibxikaOalRblalRbbgAco4gCaCciSgCE86bbaocGfalclfaCfgORbbaAcl4ciGgCaCciSgCE86bbaocVfaOaCfgORbbaAcd4ciGgCaCciSgCE86bbaoc7faOaCfgORbbaAciGgAaAciSgAE86bbaoctfaOaAfgARbbalRbegOco4gCaCciSgCE86bbaoc91faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc4faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc93faAaCfgARbbaOciGgOaOciSgOE86bbaoc94faAaOfgARbbalRbdgOco4gCaCciSgCE86bbaoc95faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc96faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc97faAaCfgARbbaOciGgOaOciSgOE86bbaoc98faAaOfgORbbalRbiglco4gAaAciSgAE86bbaoc99faOaAfgORbbalcl4ciGgAaAciSgAE86bbaoc9:faOaAfgORbbalcd4ciGgAaAciSgAE86bbaocufaOaAfgoRbbalciGglalciSglE86bbaoalfhlxdkaOalRbwalRbbgAcl4gCaCcsSgCE86bbaocGfalcwfaCfgORbbaAcsGgAaAcsSgAE86bbaocVfaOaAfgORbbalRbegAcl4gCaCcsSgCE86bbaoc7faOaCfgORbbaAcsGgAaAcsSgAE86bbaoctfaOaAfgORbbalRbdgAcl4gCaCcsSgCE86bbaoc91faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc4faOaAfgORbbalRbigAcl4gCaCcsSgCE86bbaoc93faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc94faOaAfgORbbalRblgAcl4gCaCcsSgCE86bbaoc95faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc96faOaAfgORbbalRbvgAcl4gCaCcsSgCE86bbaoc97faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc98faOaAfgORbbalRbogAcl4gCaCcsSgCE86bbaoc99faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc9:faOaAfgORbbalRbrglcl4gAaAcsSgAE86bbaocufaOaAfgoRbbalcsGglalcsSglE86bbaoalfhlxekaOal8Pbb83bbaOcwfalcwf8Pbb83bbalczfhlkdnaiam9pmbaiczfhoaral9RcL0mekkaiam6mialTmidnakTmbawaPfRbbhOcbhoazhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkkazcefhzaPcefgPad6hsalhHaPad9hmexvkkcbhlasceGmdxikalaxad2fhCdnakTmbcbhHcehsawcjdfhminaral9Rax6mialTmdalaxfhlawaHfRbbhOcbhoamhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkamcefhmaHcefgHad6hsaHad9hmbkaChlxikcbhocehsinaral9Rax6mdalTmealaxfhlaocefgoad6hsadao9hmbkaChlxdkcbhlasceGTmekc9:hoxikabaqad2fawcjdfakad2z1jjjb8Aawawcjdfakcufad2fadz1jjjb8Aakaqfhqalmbkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;ebf8Kjjjjbaok;yzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecjez:jjjjb8AavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:Lvoeue99dud99eud99dndnadcl9hmbaeTmeindndnabcdfgd8Sbb:Yab8Sbbgi:Ygl:l:tabcefgv8Sbbgo:Ygr:l:tgwJbb;:9cawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai86bbdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad86bbdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad86bbabclfhbaecufgembxdkkaeTmbindndnabclfgd8Ueb:Yab8Uebgi:Ygl:l:tabcdfgv8Uebgo:Ygr:l:tgwJb;:FSawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai87ebdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad87ebdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad87ebabcwfhbaecufgembkkk;siliui99iue99dnaeTmbcbhiabhlindndnJ;Zl81Zalcof8UebgvciV:Y:vgoal8Ueb:YNgrJb;:FSNJbbbZJbbb:;arJbbbb9GEMgw:lJbbb9p9DTmbaw:OhDxekcjjjj94hDkalclf8Uebhqalcdf8UebhkabavcefciGaiVcetfaD87ebdndnaoak:YNgwJb;:FSNJbbbZJbbb:;awJbbbb9GEMgx:lJbbb9p9DTmbax:Ohkxekcjjjj94hkkabavcdfciGaiVcetfak87ebdndnaoaq:YNgoJb;:FSNJbbbZJbbb:;aoJbbbb9GEMgx:lJbbb9p9DTmbax:Ohqxekcjjjj94hqkabavcufciGaiVcetfaq87ebdndnJbbjZararN:tawawN:taoaoN:tgrJbbbbarJbbbb9GE:rJb;:FSNJbbbZMgr:lJbbb9p9DTmbar:Ohqxekcjjjj94hqkabavciGaiVcetfaq87ebalcwfhlaiclfhiaecufgembkkk9mbdnadcd4ae2geTmbinababydbgdcwtcw91:Yadce91cjjj;8ifcjjj98G::NUdbabclfhbaecufgembkkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaik;LeeeudndnaeabVciGTmbabhixekdndnadcz9pmbabhixekabhiinaiaeydbBdbaiclfaeclfydbBdbaicwfaecwfydbBdbaicxfaecxfydbBdbaiczfhiaeczfheadc9Wfgdcs0mbkkadcl6mbinaiaeydbBdbaeclfheaiclfhiadc98fgdci0mbkkdnadTmbinaiaeRbb86bbaicefhiaecefheadcufgdmbkkabk;aeedudndnabciGTmbabhixekaecFeGc:b:c:ew2hldndnadcz9pmbabhixekabhiinaialBdbaicxfalBdbaicwfalBdbaiclfalBdbaiczfhiadc9Wfgdcs0mbkkadcl6mbinaialBdbaiclfhiadc98fgdci0mbkkdnadTmbinaiae86bbaicefhiadcufgdmbkkabkkkebcjwklz9Kbb",s=WebAssembly.instantiate(o(n),{}).then((function(e){(i=e.instance).exports.__wasm_call_ctors()}));function o(e){for(var i=new Uint8Array(e.length),n=0;n<e.length;++n){var s=e.charCodeAt(n);i[n]=s>96?s-97:s>64?s-39:s+4}var o=0;for(n=0;n<e.length;++n)i[o++]=i[n]<60?t[i[n]]:64*(i[n]-60)+i[++n];return i.buffer.slice(0,o)}function r(e,t,n,s,o,r){var a=i.exports.sbrk,l=n+3&-4,g=a(l*s),c=a(o.length),d=new Uint8Array(i.exports.memory.buffer);d.set(o,c);var h=e(g,n,s,c,o.length);if(0==h&&r&&r(g,l,s),t.set(d.subarray(g,g+n*s)),a(g-a(0)),0!=h)throw new Error("Malformed buffer data: "+h)}var a={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},l={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"},g=[],c=0;function d(e){var t={object:new Worker(e),pending:0,requests:{}};return t.object.onmessage=function(e){var i=e.data;t.pending-=i.count,t.requests[i.id][i.action](i.value),delete t.requests[i.id]},t}function h(e){for(var t="var instance; var ready = WebAssembly.instantiate(new Uint8Array(["+new Uint8Array(o(n))+"]), {}).then(function(result) { instance = result.instance; instance.exports.__wasm_call_ctors(); });self.onmessage = workerProcess;"+r.toString()+u.toString(),i=new Blob([t],{type:"text/javascript"}),s=URL.createObjectURL(i),a=0;a<e;++a)g[a]=d(s);URL.revokeObjectURL(s)}function u(e){s.then((function(){var t=e.data;try{var n=new Uint8Array(t.count*t.size);r(i.exports[t.mode],n,t.count,t.size,t.source,i.exports[t.filter]),self.postMessage({id:t.id,count:t.count,action:"resolve",value:n},[n.buffer])}catch(s){self.postMessage({id:t.id,count:t.count,action:"reject",value:s})}}))}return{ready:s,supported:!0,useWorkers:function(e){h(e)},decodeVertexBuffer:function(e,t,n,s,o){r(i.exports.meshopt_decodeVertexBuffer,e,t,n,s,i.exports[a[o]])},decodeIndexBuffer:function(e,t,n,s){r(i.exports.meshopt_decodeIndexBuffer,e,t,n,s)},decodeIndexSequence:function(e,t,n,s){r(i.exports.meshopt_decodeIndexSequence,e,t,n,s)},decodeGltfBuffer:function(e,t,n,s,o,g){r(i.exports[l[o]],e,t,n,s,i.exports[a[g]])},decodeGltfBufferAsync:function(e,t,n,o,d){return g.length>0?function(e,t,i,n,s){for(var o=g[0],r=1;r<g.length;++r)g[r].pending<o.pending&&(o=g[r]);return new Promise((function(r,a){var l=new Uint8Array(i),g=c++;o.pending+=e,o.requests[g]={resolve:r,reject:a},o.object.postMessage({id:g,count:e,size:t,source:l,mode:n,filter:s},[l.buffer])}))}(e,t,n,l[o],a[d]):s.then((function(){var s=new Uint8Array(e*t);return r(i.exports[l[o]],s,e,t,n,i.exports[a[d]]),s}))}}}();const jX=new WeakMap;function qX(){let e,t;function i(e,t,i,n,s,o){const r=o.num_components(),a=i.num_points()*r,l=a*s.BYTES_PER_ELEMENT,g=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,s),c=e._malloc(l);t.GetAttributeDataArrayForAllPoints(i,o,g,l,c);const d=new s(e.HEAPF32.buffer,c,a).slice();return e._free(c),{name:n,array:d,itemSize:r}}onmessage=function(n){const s=n.data;switch(s.type){case"init":e=s.decoderConfig,t=new Promise((function(t){e.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(e)}));break;case"decode":const n=s.buffer,o=s.taskConfig;t.then((e=>{const t=e.draco,r=new t.Decoder;try{const e=function(e,t,n,s){const o=s.attributeIDs,r=s.attributeTypes;let a,l;const g=t.GetEncodedGeometryType(n);if(g===e.TRIANGULAR_MESH)a=new e.Mesh,l=t.DecodeArrayToMesh(n,n.byteLength,a);else{if(g!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");a=new e.PointCloud,l=t.DecodeArrayToPointCloud(n,n.byteLength,a)}if(!l.ok()||0===a.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+l.error_msg());const c={index:null,attributes:[]};for(const d in o){const n=self[r[d]];let l,g;if(s.useUniqueIDs)g=o[d],l=t.GetAttributeByUniqueId(a,g);else{if(g=t.GetAttributeId(a,e[o[d]]),-1===g)continue;l=t.GetAttribute(a,g)}const h=i(e,t,a,d,n,l);"color"===d&&(h.vertexColorSpace=s.vertexColorSpace),c.attributes.push(h)}g===e.TRIANGULAR_MESH&&(c.index=function(e,t,i){const n=i.num_faces(),s=3*n,o=4*s,r=e._malloc(o);t.GetTrianglesUInt32Array(i,o,r);const a=new Uint32Array(e.HEAPF32.buffer,r,s).slice();return e._free(r),{array:a,itemSize:1}}(e,t,a));return e.destroy(a),c}(t,r,new Int8Array(n),o),a=e.attributes.map((e=>e.array.buffer));e.index&&a.push(e.index.array.buffer),self.postMessage({type:"decode",id:s.id,geometry:e},a)}catch(a){console.error(a),self.postMessage({type:"error",id:s.id,error:a.message})}finally{t.destroy(r)}}))}}}class $X{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const i=this.workersResolve[e];if(i&&i(t),this.queue.length){const{resolve:t,msg:i,transfer:n}=this.queue.shift();this.workersResolve[e]=t,this.workers[e].postMessage(i,n)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise((i=>{const n=this._getIdleWorker();-1!==n?(this._initWorker(n),this.workerStatus|=1<<n,this.workersResolve[n]=i,this.workers[n].postMessage(e,t)):this.queue.push({resolve:i,msg:e,transfer:t})}))}dispose(){this.workers.forEach((e=>e.terminate())),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const eH=2,tH=0,iH=1,nH=10;class sH{constructor(){this.vkFormat=0,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=0,this.levels=[],this.dataFormatDescriptor=[{vendorId:0,descriptorType:0,descriptorBlockSize:0,versionNumber:2,colorModel:0,colorPrimaries:1,transferFunction:2,flags:0,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class oH{constructor(e,t,i,n){this._dataView=new DataView(e.buffer,e.byteOffset+t,i),this._littleEndian=n,this._offset=0}_nextUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){const e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){const e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){const e=this._dataView.getUint32(this._offset,this._littleEndian)+2**32*this._dataView.getUint32(this._offset+4,this._littleEndian);return this._offset+=8,e}_nextInt32(){const e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_skip(e){return this._offset+=e,this}_scan(e,t=0){const i=this._offset;let n=0;for(;this._dataView.getUint8(this._offset)!==t&&n<e;)n++,this._offset++;return n<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+i,n)}}const rH=[171,75,84,88,32,50,48,187,13,10,26,10];function aH(e){return"undefined"!=typeof TextDecoder?(new TextDecoder).decode(e):Buffer.from(e).toString("utf8")}let lH,gH,cH;const dH={env:{emscripten_notify_memory_growth:function(e){cH=new Uint8Array(gH.exports.memory.buffer)}}};class hH{init(){return lH||(lH="undefined"!=typeof fetch?fetch("data:application/wasm;base64,"+uH).then((e=>e.arrayBuffer())).then((e=>WebAssembly.instantiate(e,dH))).then(this._init):WebAssembly.instantiate(Buffer.from(uH,"base64"),dH).then(this._init),lH)}_init(e){gH=e.instance,dH.env.emscripten_notify_memory_growth(0)}decode(e,t=0){if(!gH)throw new Error("ZSTDDecoder: Await .init() before decoding.");const i=e.byteLength,n=gH.exports.malloc(i);cH.set(e,n),t=t||Number(gH.exports.ZSTD_findDecompressedSize(n,i));const s=gH.exports.malloc(t),o=gH.exports.ZSTD_decompress(s,t,n,i),r=cH.slice(s,s+o);return gH.exports.free(n),gH.exports.free(s),r}}const uH="AGFzbQEAAAABpQEVYAF/AX9gAn9/AGADf39/AX9gBX9/f39/AX9gAX8AYAJ/fwF/YAR/f39/AX9gA39/fwBgBn9/f39/fwF/YAd/f39/f39/AX9gAn9/AX5gAn5+AX5gAABgBX9/f39/AGAGf39/f39/AGAIf39/f39/f38AYAl/f39/f39/f38AYAABf2AIf39/f39/f38Bf2ANf39/f39/f39/f39/fwF/YAF/AX4CJwEDZW52H2Vtc2NyaXB0ZW5fbm90aWZ5X21lbW9yeV9ncm93dGgABANpaAEFAAAFAgEFCwACAQABAgIFBQcAAwABDgsBAQcAEhMHAAUBDAQEAAANBwQCAgYCBAgDAwMDBgEACQkHBgICAAYGAgQUBwYGAwIGAAMCAQgBBwUGCgoEEQAEBAEIAwgDBQgDEA8IAAcABAUBcAECAgUEAQCAAgYJAX8BQaCgwAILB2AHBm1lbW9yeQIABm1hbGxvYwAoBGZyZWUAJgxaU1REX2lzRXJyb3IAaBlaU1REX2ZpbmREZWNvbXByZXNzZWRTaXplAFQPWlNURF9kZWNvbXByZXNzAEoGX3N0YXJ0ACQJBwEAQQELASQKussBaA8AIAAgACgCBCABajYCBAsZACAAKAIAIAAoAgRBH3F0QQAgAWtBH3F2CwgAIABBiH9LC34BBH9BAyEBIAAoAgQiA0EgTQRAIAAoAggiASAAKAIQTwRAIAAQDQ8LIAAoAgwiAiABRgRAQQFBAiADQSBJGw8LIAAgASABIAJrIANBA3YiBCABIARrIAJJIgEbIgJrIgQ2AgggACADIAJBA3RrNgIEIAAgBCgAADYCAAsgAQsUAQF/IAAgARACIQIgACABEAEgAgv3AQECfyACRQRAIABCADcCACAAQQA2AhAgAEIANwIIQbh/DwsgACABNgIMIAAgAUEEajYCECACQQRPBEAgACABIAJqIgFBfGoiAzYCCCAAIAMoAAA2AgAgAUF/ai0AACIBBEAgAEEIIAEQFGs2AgQgAg8LIABBADYCBEF/DwsgACABNgIIIAAgAS0AACIDNgIAIAJBfmoiBEEBTQRAIARBAWtFBEAgACABLQACQRB0IANyIgM2AgALIAAgAS0AAUEIdCADajYCAAsgASACakF/ai0AACIBRQRAIABBADYCBEFsDwsgAEEoIAEQFCACQQN0ams2AgQgAgsWACAAIAEpAAA3AAAgACABKQAINwAICy8BAX8gAUECdEGgHWooAgAgACgCAEEgIAEgACgCBGprQR9xdnEhAiAAIAEQASACCyEAIAFCz9bTvtLHq9lCfiAAfEIfiUKHla+vmLbem55/fgsdAQF/IAAoAgggACgCDEYEfyAAKAIEQSBGBUEACwuCBAEDfyACQYDAAE8EQCAAIAEgAhBnIAAPCyAAIAJqIQMCQCAAIAFzQQNxRQRAAkAgAkEBSARAIAAhAgwBCyAAQQNxRQRAIAAhAgwBCyAAIQIDQCACIAEtAAA6AAAgAUEBaiEBIAJBAWoiAiADTw0BIAJBA3ENAAsLAkAgA0F8cSIEQcAASQ0AIAIgBEFAaiIFSw0AA0AgAiABKAIANgIAIAIgASgCBDYCBCACIAEoAgg2AgggAiABKAIMNgIMIAIgASgCEDYCECACIAEoAhQ2AhQgAiABKAIYNgIYIAIgASgCHDYCHCACIAEoAiA2AiAgAiABKAIkNgIkIAIgASgCKDYCKCACIAEoAiw2AiwgAiABKAIwNgIwIAIgASgCNDYCNCACIAEoAjg2AjggAiABKAI8NgI8IAFBQGshASACQUBrIgIgBU0NAAsLIAIgBE8NAQNAIAIgASgCADYCACABQQRqIQEgAkEEaiICIARJDQALDAELIANBBEkEQCAAIQIMAQsgA0F8aiIEIABJBEAgACECDAELIAAhAgNAIAIgAS0AADoAACACIAEtAAE6AAEgAiABLQACOgACIAIgAS0AAzoAAyABQQRqIQEgAkEEaiICIARNDQALCyACIANJBEADQCACIAEtAAA6AAAgAUEBaiEBIAJBAWoiAiADRw0ACwsgAAsMACAAIAEpAAA3AAALQQECfyAAKAIIIgEgACgCEEkEQEEDDwsgACAAKAIEIgJBB3E2AgQgACABIAJBA3ZrIgE2AgggACABKAAANgIAQQALDAAgACABKAIANgAAC/cCAQJ/AkAgACABRg0AAkAgASACaiAASwRAIAAgAmoiBCABSw0BCyAAIAEgAhALDwsgACABc0EDcSEDAkACQCAAIAFJBEAgAwRAIAAhAwwDCyAAQQNxRQRAIAAhAwwCCyAAIQMDQCACRQ0EIAMgAS0AADoAACABQQFqIQEgAkF/aiECIANBAWoiA0EDcQ0ACwwBCwJAIAMNACAEQQNxBEADQCACRQ0FIAAgAkF/aiICaiIDIAEgAmotAAA6AAAgA0EDcQ0ACwsgAkEDTQ0AA0AgACACQXxqIgJqIAEgAmooAgA2AgAgAkEDSw0ACwsgAkUNAgNAIAAgAkF/aiICaiABIAJqLQAAOgAAIAINAAsMAgsgAkEDTQ0AIAIhBANAIAMgASgCADYCACABQQRqIQEgA0EEaiEDIARBfGoiBEEDSw0ACyACQQNxIQILIAJFDQADQCADIAEtAAA6AAAgA0EBaiEDIAFBAWohASACQX9qIgINAAsLIAAL8wICAn8BfgJAIAJFDQAgACACaiIDQX9qIAE6AAAgACABOgAAIAJBA0kNACADQX5qIAE6AAAgACABOgABIANBfWogAToAACAAIAE6AAIgAkEHSQ0AIANBfGogAToAACAAIAE6AAMgAkEJSQ0AIABBACAAa0EDcSIEaiIDIAFB/wFxQYGChAhsIgE2AgAgAyACIARrQXxxIgRqIgJBfGogATYCACAEQQlJDQAgAyABNgIIIAMgATYCBCACQXhqIAE2AgAgAkF0aiABNgIAIARBGUkNACADIAE2AhggAyABNgIUIAMgATYCECADIAE2AgwgAkFwaiABNgIAIAJBbGogATYCACACQWhqIAE2AgAgAkFkaiABNgIAIAQgA0EEcUEYciIEayICQSBJDQAgAa0iBUIghiAFhCEFIAMgBGohAQNAIAEgBTcDGCABIAU3AxAgASAFNwMIIAEgBTcDACABQSBqIQEgAkFgaiICQR9LDQALCyAACy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAIajYCACADCy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAFajYCACADCx8AIAAgASACKAIEEAg2AgAgARAEGiAAIAJBCGo2AgQLCAAgAGdBH3MLugUBDX8jAEEQayIKJAACfyAEQQNNBEAgCkEANgIMIApBDGogAyAEEAsaIAAgASACIApBDGpBBBAVIgBBbCAAEAMbIAAgACAESxsMAQsgAEEAIAEoAgBBAXRBAmoQECENQVQgAygAACIGQQ9xIgBBCksNABogAiAAQQVqNgIAIAMgBGoiAkF8aiEMIAJBeWohDiACQXtqIRAgAEEGaiELQQQhBSAGQQR2IQRBICAAdCIAQQFyIQkgASgCACEPQQAhAiADIQYCQANAIAlBAkggAiAPS3JFBEAgAiEHAkAgCARAA0AgBEH//wNxQf//A0YEQCAHQRhqIQcgBiAQSQR/IAZBAmoiBigAACAFdgUgBUEQaiEFIARBEHYLIQQMAQsLA0AgBEEDcSIIQQNGBEAgBUECaiEFIARBAnYhBCAHQQNqIQcMAQsLIAcgCGoiByAPSw0EIAVBAmohBQNAIAIgB0kEQCANIAJBAXRqQQA7AQAgAkEBaiECDAELCyAGIA5LQQAgBiAFQQN1aiIHIAxLG0UEQCAHKAAAIAVBB3EiBXYhBAwCCyAEQQJ2IQQLIAYhBwsCfyALQX9qIAQgAEF/anEiBiAAQQF0QX9qIgggCWsiEUkNABogBCAIcSIEQQAgESAEIABIG2shBiALCyEIIA0gAkEBdGogBkF/aiIEOwEAIAlBASAGayAEIAZBAUgbayEJA0AgCSAASARAIABBAXUhACALQX9qIQsMAQsLAn8gByAOS0EAIAcgBSAIaiIFQQN1aiIGIAxLG0UEQCAFQQdxDAELIAUgDCIGIAdrQQN0awshBSACQQFqIQIgBEUhCCAGKAAAIAVBH3F2IQQMAQsLQWwgCUEBRyAFQSBKcg0BGiABIAJBf2o2AgAgBiAFQQdqQQN1aiADawwBC0FQCyEAIApBEGokACAACwkAQQFBBSAAGwsMACAAIAEoAAA2AAALqgMBCn8jAEHwAGsiCiQAIAJBAWohDiAAQQhqIQtBgIAEIAVBf2p0QRB1IQxBACECQQEhBkEBIAV0IglBf2oiDyEIA0AgAiAORkUEQAJAIAEgAkEBdCINai8BACIHQf//A0YEQCALIAhBA3RqIAI2AgQgCEF/aiEIQQEhBwwBCyAGQQAgDCAHQRB0QRB1ShshBgsgCiANaiAHOwEAIAJBAWohAgwBCwsgACAFNgIEIAAgBjYCACAJQQN2IAlBAXZqQQNqIQxBACEAQQAhBkEAIQIDQCAGIA5GBEADQAJAIAAgCUYNACAKIAsgAEEDdGoiASgCBCIGQQF0aiICIAIvAQAiAkEBajsBACABIAUgAhAUayIIOgADIAEgAiAIQf8BcXQgCWs7AQAgASAEIAZBAnQiAmooAgA6AAIgASACIANqKAIANgIEIABBAWohAAwBCwsFIAEgBkEBdGouAQAhDUEAIQcDQCAHIA1ORQRAIAsgAkEDdGogBjYCBANAIAIgDGogD3EiAiAISw0ACyAHQQFqIQcMAQsLIAZBAWohBgwBCwsgCkHwAGokAAsjAEIAIAEQCSAAhUKHla+vmLbem55/fkLj3MqV/M7y9YV/fAsQACAAQn43AwggACABNgIACyQBAX8gAARAIAEoAgQiAgRAIAEoAgggACACEQEADwsgABAmCwsfACAAIAEgAi8BABAINgIAIAEQBBogACACQQRqNgIEC0oBAX9BoCAoAgAiASAAaiIAQX9MBEBBiCBBMDYCAEF/DwsCQCAAPwBBEHRNDQAgABBmDQBBiCBBMDYCAEF/DwtBoCAgADYCACABC9cBAQh/Qbp/IQoCQCACKAIEIgggAigCACIJaiIOIAEgAGtLDQBBbCEKIAkgBCADKAIAIgtrSw0AIAAgCWoiBCACKAIIIgxrIQ0gACABQWBqIg8gCyAJQQAQKSADIAkgC2o2AgACQAJAIAwgBCAFa00EQCANIQUMAQsgDCAEIAZrSw0CIAcgDSAFayIAaiIBIAhqIAdNBEAgBCABIAgQDxoMAgsgBCABQQAgAGsQDyEBIAIgACAIaiIINgIEIAEgAGshBAsgBCAPIAUgCEEBECkLIA4hCgsgCgubAgEBfyMAQYABayINJAAgDSADNgJ8AkAgAkEDSwRAQX8hCQwBCwJAAkACQAJAIAJBAWsOAwADAgELIAZFBEBBuH8hCQwEC0FsIQkgBS0AACICIANLDQMgACAHIAJBAnQiAmooAgAgAiAIaigCABA7IAEgADYCAEEBIQkMAwsgASAJNgIAQQAhCQwCCyAKRQRAQWwhCQwCC0EAIQkgC0UgDEEZSHINAUEIIAR0QQhqIQBBACECA0AgAiAATw0CIAJBQGshAgwAAAsAC0FsIQkgDSANQfwAaiANQfgAaiAFIAYQFSICEAMNACANKAJ4IgMgBEsNACAAIA0gDSgCfCAHIAggAxAYIAEgADYCACACIQkLIA1BgAFqJAAgCQsLACAAIAEgAhALGgsQACAALwAAIAAtAAJBEHRyCy8AAn9BuH8gAUEISQ0AGkFyIAAoAAQiAEF3Sw0AGkG4fyAAQQhqIgAgACABSxsLCwkAIAAgATsAAAsDAAELigYBBX8gACAAKAIAIgVBfnE2AgBBACAAIAVBAXZqQYQgKAIAIgQgAEYbIQECQAJAIAAoAgQiAkUNACACKAIAIgNBAXENACACQQhqIgUgA0EBdkF4aiIDQQggA0EISxtnQR9zQQJ0QYAfaiIDKAIARgRAIAMgAigCDDYCAAsgAigCCCIDBEAgAyACKAIMNgIECyACKAIMIgMEQCADIAIoAgg2AgALIAIgAigCACAAKAIAQX5xajYCAEGEICEAAkACQCABRQ0AIAEgAjYCBCABKAIAIgNBAXENASADQQF2QXhqIgNBCCADQQhLG2dBH3NBAnRBgB9qIgMoAgAgAUEIakYEQCADIAEoAgw2AgALIAEoAggiAwRAIAMgASgCDDYCBAsgASgCDCIDBEAgAyABKAIINgIAQYQgKAIAIQQLIAIgAigCACABKAIAQX5xajYCACABIARGDQAgASABKAIAQQF2akEEaiEACyAAIAI2AgALIAIoAgBBAXZBeGoiAEEIIABBCEsbZ0Efc0ECdEGAH2oiASgCACEAIAEgBTYCACACIAA2AgwgAkEANgIIIABFDQEgACAFNgIADwsCQCABRQ0AIAEoAgAiAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAigCACABQQhqRgRAIAIgASgCDDYCAAsgASgCCCICBEAgAiABKAIMNgIECyABKAIMIgIEQCACIAEoAgg2AgBBhCAoAgAhBAsgACAAKAIAIAEoAgBBfnFqIgI2AgACQCABIARHBEAgASABKAIAQQF2aiAANgIEIAAoAgAhAgwBC0GEICAANgIACyACQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgIoAgAhASACIABBCGoiAjYCACAAIAE2AgwgAEEANgIIIAFFDQEgASACNgIADwsgBUEBdkF4aiIBQQggAUEISxtnQR9zQQJ0QYAfaiICKAIAIQEgAiAAQQhqIgI2AgAgACABNgIMIABBADYCCCABRQ0AIAEgAjYCAAsLDgAgAARAIABBeGoQJQsLgAIBA38CQCAAQQ9qQXhxQYQgKAIAKAIAQQF2ayICEB1Bf0YNAAJAQYQgKAIAIgAoAgAiAUEBcQ0AIAFBAXZBeGoiAUEIIAFBCEsbZ0Efc0ECdEGAH2oiASgCACAAQQhqRgRAIAEgACgCDDYCAAsgACgCCCIBBEAgASAAKAIMNgIECyAAKAIMIgFFDQAgASAAKAIINgIAC0EBIQEgACAAKAIAIAJBAXRqIgI2AgAgAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAygCACECIAMgAEEIaiIDNgIAIAAgAjYCDCAAQQA2AgggAkUNACACIAM2AgALIAELtwIBA38CQAJAIABBASAAGyICEDgiAA0AAkACQEGEICgCACIARQ0AIAAoAgAiA0EBcQ0AIAAgA0EBcjYCACADQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgAgAEEIakYEQCABIAAoAgw2AgALIAAoAggiAQRAIAEgACgCDDYCBAsgACgCDCIBBEAgASAAKAIINgIACyACECchAkEAIQFBhCAoAgAhACACDQEgACAAKAIAQX5xNgIAQQAPCyACQQ9qQXhxIgMQHSICQX9GDQIgAkEHakF4cSIAIAJHBEAgACACaxAdQX9GDQMLAkBBhCAoAgAiAUUEQEGAICAANgIADAELIAAgATYCBAtBhCAgADYCACAAIANBAXRBAXI2AgAMAQsgAEUNAQsgAEEIaiEBCyABC7kDAQJ/IAAgA2ohBQJAIANBB0wEQANAIAAgBU8NAiAAIAItAAA6AAAgAEEBaiEAIAJBAWohAgwAAAsACyAEQQFGBEACQCAAIAJrIgZBB00EQCAAIAItAAA6AAAgACACLQABOgABIAAgAi0AAjoAAiAAIAItAAM6AAMgAEEEaiACIAZBAnQiBkHAHmooAgBqIgIQFyACIAZB4B5qKAIAayECDAELIAAgAhAMCyACQQhqIQIgAEEIaiEACwJAAkACQAJAIAUgAU0EQCAAIANqIQEgBEEBRyAAIAJrQQ9Kcg0BA0AgACACEAwgAkEIaiECIABBCGoiACABSQ0ACwwFCyAAIAFLBEAgACEBDAQLIARBAUcgACACa0EPSnINASAAIQMgAiEEA0AgAyAEEAwgBEEIaiEEIANBCGoiAyABSQ0ACwwCCwNAIAAgAhAHIAJBEGohAiAAQRBqIgAgAUkNAAsMAwsgACEDIAIhBANAIAMgBBAHIARBEGohBCADQRBqIgMgAUkNAAsLIAIgASAAa2ohAgsDQCABIAVPDQEgASACLQAAOgAAIAFBAWohASACQQFqIQIMAAALAAsLQQECfyAAIAAoArjgASIDNgLE4AEgACgCvOABIQQgACABNgK84AEgACABIAJqNgK44AEgACABIAQgA2tqNgLA4AELpgEBAX8gACAAKALs4QEQFjYCyOABIABCADcD+OABIABCADcDuOABIABBwOABakIANwMAIABBqNAAaiIBQYyAgOAANgIAIABBADYCmOIBIABCADcDiOEBIABCAzcDgOEBIABBrNABakHgEikCADcCACAAQbTQAWpB6BIoAgA2AgAgACABNgIMIAAgAEGYIGo2AgggACAAQaAwajYCBCAAIABBEGo2AgALYQEBf0G4fyEDAkAgAUEDSQ0AIAIgABAhIgFBA3YiADYCCCACIAFBAXE2AgQgAiABQQF2QQNxIgM2AgACQCADQX9qIgFBAksNAAJAIAFBAWsOAgEAAgtBbA8LIAAhAwsgAwsMACAAIAEgAkEAEC4LiAQCA38CfiADEBYhBCAAQQBBKBAQIQAgBCACSwRAIAQPCyABRQRAQX8PCwJAAkAgA0EBRg0AIAEoAAAiBkGo6r5pRg0AQXYhAyAGQXBxQdDUtMIBRw0BQQghAyACQQhJDQEgAEEAQSgQECEAIAEoAAQhASAAQQE2AhQgACABrTcDAEEADwsgASACIAMQLyIDIAJLDQAgACADNgIYQXIhAyABIARqIgVBf2otAAAiAkEIcQ0AIAJBIHEiBkUEQEFwIQMgBS0AACIFQacBSw0BIAVBB3GtQgEgBUEDdkEKaq2GIgdCA4h+IAd8IQggBEEBaiEECyACQQZ2IQMgAkECdiEFAkAgAkEDcUF/aiICQQJLBEBBACECDAELAkACQAJAIAJBAWsOAgECAAsgASAEai0AACECIARBAWohBAwCCyABIARqLwAAIQIgBEECaiEEDAELIAEgBGooAAAhAiAEQQRqIQQLIAVBAXEhBQJ+AkACQAJAIANBf2oiA0ECTQRAIANBAWsOAgIDAQtCfyAGRQ0DGiABIARqMQAADAMLIAEgBGovAACtQoACfAwCCyABIARqKAAArQwBCyABIARqKQAACyEHIAAgBTYCICAAIAI2AhwgACAHNwMAQQAhAyAAQQA2AhQgACAHIAggBhsiBzcDCCAAIAdCgIAIIAdCgIAIVBs+AhALIAMLWwEBf0G4fyEDIAIQFiICIAFNBH8gACACakF/ai0AACIAQQNxQQJ0QaAeaigCACACaiAAQQZ2IgFBAnRBsB5qKAIAaiAAQSBxIgBFaiABRSAAQQV2cWoFQbh/CwsdACAAKAKQ4gEQWiAAQQA2AqDiASAAQgA3A5DiAQu1AwEFfyMAQZACayIKJABBuH8hBgJAIAVFDQAgBCwAACIIQf8BcSEHAkAgCEF/TARAIAdBgn9qQQF2IgggBU8NAkFsIQYgB0GBf2oiBUGAAk8NAiAEQQFqIQdBACEGA0AgBiAFTwRAIAUhBiAIIQcMAwUgACAGaiAHIAZBAXZqIgQtAABBBHY6AAAgACAGQQFyaiAELQAAQQ9xOgAAIAZBAmohBgwBCwAACwALIAcgBU8NASAAIARBAWogByAKEFMiBhADDQELIAYhBEEAIQYgAUEAQTQQECEJQQAhBQNAIAQgBkcEQCAAIAZqIggtAAAiAUELSwRAQWwhBgwDBSAJIAFBAnRqIgEgASgCAEEBajYCACAGQQFqIQZBASAILQAAdEEBdSAFaiEFDAILAAsLQWwhBiAFRQ0AIAUQFEEBaiIBQQxLDQAgAyABNgIAQQFBASABdCAFayIDEBQiAXQgA0cNACAAIARqIAFBAWoiADoAACAJIABBAnRqIgAgACgCAEEBajYCACAJKAIEIgBBAkkgAEEBcXINACACIARBAWo2AgAgB0EBaiEGCyAKQZACaiQAIAYLxhEBDH8jAEHwAGsiBSQAQWwhCwJAIANBCkkNACACLwAAIQogAi8AAiEJIAIvAAQhByAFQQhqIAQQDgJAIAMgByAJIApqakEGaiIMSQ0AIAUtAAohCCAFQdgAaiACQQZqIgIgChAGIgsQAw0BIAVBQGsgAiAKaiICIAkQBiILEAMNASAFQShqIAIgCWoiAiAHEAYiCxADDQEgBUEQaiACIAdqIAMgDGsQBiILEAMNASAAIAFqIg9BfWohECAEQQRqIQZBASELIAAgAUEDakECdiIDaiIMIANqIgIgA2oiDiEDIAIhBCAMIQcDQCALIAMgEElxBEAgACAGIAVB2ABqIAgQAkECdGoiCS8BADsAACAFQdgAaiAJLQACEAEgCS0AAyELIAcgBiAFQUBrIAgQAkECdGoiCS8BADsAACAFQUBrIAktAAIQASAJLQADIQogBCAGIAVBKGogCBACQQJ0aiIJLwEAOwAAIAVBKGogCS0AAhABIAktAAMhCSADIAYgBUEQaiAIEAJBAnRqIg0vAQA7AAAgBUEQaiANLQACEAEgDS0AAyENIAAgC2oiCyAGIAVB2ABqIAgQAkECdGoiAC8BADsAACAFQdgAaiAALQACEAEgAC0AAyEAIAcgCmoiCiAGIAVBQGsgCBACQQJ0aiIHLwEAOwAAIAVBQGsgBy0AAhABIActAAMhByAEIAlqIgkgBiAFQShqIAgQAkECdGoiBC8BADsAACAFQShqIAQtAAIQASAELQADIQQgAyANaiIDIAYgBUEQaiAIEAJBAnRqIg0vAQA7AAAgBUEQaiANLQACEAEgACALaiEAIAcgCmohByAEIAlqIQQgAyANLQADaiEDIAVB2ABqEA0gBUFAaxANciAFQShqEA1yIAVBEGoQDXJFIQsMAQsLIAQgDksgByACS3INAEFsIQsgACAMSw0BIAxBfWohCQNAQQAgACAJSSAFQdgAahAEGwRAIAAgBiAFQdgAaiAIEAJBAnRqIgovAQA7AAAgBUHYAGogCi0AAhABIAAgCi0AA2oiACAGIAVB2ABqIAgQAkECdGoiCi8BADsAACAFQdgAaiAKLQACEAEgACAKLQADaiEADAEFIAxBfmohCgNAIAVB2ABqEAQgACAKS3JFBEAgACAGIAVB2ABqIAgQAkECdGoiCS8BADsAACAFQdgAaiAJLQACEAEgACAJLQADaiEADAELCwNAIAAgCk0EQCAAIAYgBUHYAGogCBACQQJ0aiIJLwEAOwAAIAVB2ABqIAktAAIQASAAIAktAANqIQAMAQsLAkAgACAMTw0AIAAgBiAFQdgAaiAIEAIiAEECdGoiDC0AADoAACAMLQADQQFGBEAgBUHYAGogDC0AAhABDAELIAUoAlxBH0sNACAFQdgAaiAGIABBAnRqLQACEAEgBSgCXEEhSQ0AIAVBIDYCXAsgAkF9aiEMA0BBACAHIAxJIAVBQGsQBBsEQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiIAIAYgBUFAayAIEAJBAnRqIgcvAQA7AAAgBUFAayAHLQACEAEgACAHLQADaiEHDAEFIAJBfmohDANAIAVBQGsQBCAHIAxLckUEQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiEHDAELCwNAIAcgDE0EQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiEHDAELCwJAIAcgAk8NACAHIAYgBUFAayAIEAIiAEECdGoiAi0AADoAACACLQADQQFGBEAgBUFAayACLQACEAEMAQsgBSgCREEfSw0AIAVBQGsgBiAAQQJ0ai0AAhABIAUoAkRBIUkNACAFQSA2AkQLIA5BfWohAgNAQQAgBCACSSAFQShqEAQbBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2oiACAGIAVBKGogCBACQQJ0aiIELwEAOwAAIAVBKGogBC0AAhABIAAgBC0AA2ohBAwBBSAOQX5qIQIDQCAFQShqEAQgBCACS3JFBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2ohBAwBCwsDQCAEIAJNBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2ohBAwBCwsCQCAEIA5PDQAgBCAGIAVBKGogCBACIgBBAnRqIgItAAA6AAAgAi0AA0EBRgRAIAVBKGogAi0AAhABDAELIAUoAixBH0sNACAFQShqIAYgAEECdGotAAIQASAFKAIsQSFJDQAgBUEgNgIsCwNAQQAgAyAQSSAFQRBqEAQbBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2oiACAGIAVBEGogCBACQQJ0aiICLwEAOwAAIAVBEGogAi0AAhABIAAgAi0AA2ohAwwBBSAPQX5qIQIDQCAFQRBqEAQgAyACS3JFBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2ohAwwBCwsDQCADIAJNBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2ohAwwBCwsCQCADIA9PDQAgAyAGIAVBEGogCBACIgBBAnRqIgItAAA6AAAgAi0AA0EBRgRAIAVBEGogAi0AAhABDAELIAUoAhRBH0sNACAFQRBqIAYgAEECdGotAAIQASAFKAIUQSFJDQAgBUEgNgIUCyABQWwgBUHYAGoQCiAFQUBrEApxIAVBKGoQCnEgBUEQahAKcRshCwwJCwAACwALAAALAAsAAAsACwAACwALQWwhCwsgBUHwAGokACALC7UEAQ5/IwBBEGsiBiQAIAZBBGogABAOQVQhBQJAIARB3AtJDQAgBi0ABCEHIANB8ARqQQBB7AAQECEIIAdBDEsNACADQdwJaiIJIAggBkEIaiAGQQxqIAEgAhAxIhAQA0UEQCAGKAIMIgQgB0sNASADQdwFaiEPIANBpAVqIREgAEEEaiESIANBqAVqIQEgBCEFA0AgBSICQX9qIQUgCCACQQJ0aigCAEUNAAsgAkEBaiEOQQEhBQNAIAUgDk9FBEAgCCAFQQJ0IgtqKAIAIQwgASALaiAKNgIAIAVBAWohBSAKIAxqIQoMAQsLIAEgCjYCAEEAIQUgBigCCCELA0AgBSALRkUEQCABIAUgCWotAAAiDEECdGoiDSANKAIAIg1BAWo2AgAgDyANQQF0aiINIAw6AAEgDSAFOgAAIAVBAWohBQwBCwtBACEBIANBADYCqAUgBEF/cyAHaiEJQQEhBQNAIAUgDk9FBEAgCCAFQQJ0IgtqKAIAIQwgAyALaiABNgIAIAwgBSAJanQgAWohASAFQQFqIQUMAQsLIAcgBEEBaiIBIAJrIgRrQQFqIQgDQEEBIQUgBCAIT0UEQANAIAUgDk9FBEAgBUECdCIJIAMgBEE0bGpqIAMgCWooAgAgBHY2AgAgBUEBaiEFDAELCyAEQQFqIQQMAQsLIBIgByAPIAogESADIAIgARBkIAZBAToABSAGIAc6AAYgACAGKAIENgIACyAQIQULIAZBEGokACAFC8ENAQt/IwBB8ABrIgUkAEFsIQkCQCADQQpJDQAgAi8AACEKIAIvAAIhDCACLwAEIQYgBUEIaiAEEA4CQCADIAYgCiAMampBBmoiDUkNACAFLQAKIQcgBUHYAGogAkEGaiICIAoQBiIJEAMNASAFQUBrIAIgCmoiAiAMEAYiCRADDQEgBUEoaiACIAxqIgIgBhAGIgkQAw0BIAVBEGogAiAGaiADIA1rEAYiCRADDQEgACABaiIOQX1qIQ8gBEEEaiEGQQEhCSAAIAFBA2pBAnYiAmoiCiACaiIMIAJqIg0hAyAMIQQgCiECA0AgCSADIA9JcQRAIAYgBUHYAGogBxACQQF0aiIILQAAIQsgBUHYAGogCC0AARABIAAgCzoAACAGIAVBQGsgBxACQQF0aiIILQAAIQsgBUFAayAILQABEAEgAiALOgAAIAYgBUEoaiAHEAJBAXRqIggtAAAhCyAFQShqIAgtAAEQASAEIAs6AAAgBiAFQRBqIAcQAkEBdGoiCC0AACELIAVBEGogCC0AARABIAMgCzoAACAGIAVB2ABqIAcQAkEBdGoiCC0AACELIAVB2ABqIAgtAAEQASAAIAs6AAEgBiAFQUBrIAcQAkEBdGoiCC0AACELIAVBQGsgCC0AARABIAIgCzoAASAGIAVBKGogBxACQQF0aiIILQAAIQsgBUEoaiAILQABEAEgBCALOgABIAYgBUEQaiAHEAJBAXRqIggtAAAhCyAFQRBqIAgtAAEQASADIAs6AAEgA0ECaiEDIARBAmohBCACQQJqIQIgAEECaiEAIAkgBUHYAGoQDUVxIAVBQGsQDUVxIAVBKGoQDUVxIAVBEGoQDUVxIQkMAQsLIAQgDUsgAiAMS3INAEFsIQkgACAKSw0BIApBfWohCQNAIAVB2ABqEAQgACAJT3JFBEAgBiAFQdgAaiAHEAJBAXRqIggtAAAhCyAFQdgAaiAILQABEAEgACALOgAAIAYgBUHYAGogBxACQQF0aiIILQAAIQsgBUHYAGogCC0AARABIAAgCzoAASAAQQJqIQAMAQsLA0AgBUHYAGoQBCAAIApPckUEQCAGIAVB2ABqIAcQAkEBdGoiCS0AACEIIAVB2ABqIAktAAEQASAAIAg6AAAgAEEBaiEADAELCwNAIAAgCkkEQCAGIAVB2ABqIAcQAkEBdGoiCS0AACEIIAVB2ABqIAktAAEQASAAIAg6AAAgAEEBaiEADAELCyAMQX1qIQADQCAFQUBrEAQgAiAAT3JFBEAgBiAFQUBrIAcQAkEBdGoiCi0AACEJIAVBQGsgCi0AARABIAIgCToAACAGIAVBQGsgBxACQQF0aiIKLQAAIQkgBUFAayAKLQABEAEgAiAJOgABIAJBAmohAgwBCwsDQCAFQUBrEAQgAiAMT3JFBEAgBiAFQUBrIAcQAkEBdGoiAC0AACEKIAVBQGsgAC0AARABIAIgCjoAACACQQFqIQIMAQsLA0AgAiAMSQRAIAYgBUFAayAHEAJBAXRqIgAtAAAhCiAFQUBrIAAtAAEQASACIAo6AAAgAkEBaiECDAELCyANQX1qIQADQCAFQShqEAQgBCAAT3JFBEAgBiAFQShqIAcQAkEBdGoiAi0AACEKIAVBKGogAi0AARABIAQgCjoAACAGIAVBKGogBxACQQF0aiICLQAAIQogBUEoaiACLQABEAEgBCAKOgABIARBAmohBAwBCwsDQCAFQShqEAQgBCANT3JFBEAgBiAFQShqIAcQAkEBdGoiAC0AACECIAVBKGogAC0AARABIAQgAjoAACAEQQFqIQQMAQsLA0AgBCANSQRAIAYgBUEoaiAHEAJBAXRqIgAtAAAhAiAFQShqIAAtAAEQASAEIAI6AAAgBEEBaiEEDAELCwNAIAVBEGoQBCADIA9PckUEQCAGIAVBEGogBxACQQF0aiIALQAAIQIgBUEQaiAALQABEAEgAyACOgAAIAYgBUEQaiAHEAJBAXRqIgAtAAAhAiAFQRBqIAAtAAEQASADIAI6AAEgA0ECaiEDDAELCwNAIAVBEGoQBCADIA5PckUEQCAGIAVBEGogBxACQQF0aiIALQAAIQIgBUEQaiAALQABEAEgAyACOgAAIANBAWohAwwBCwsDQCADIA5JBEAgBiAFQRBqIAcQAkEBdGoiAC0AACECIAVBEGogAC0AARABIAMgAjoAACADQQFqIQMMAQsLIAFBbCAFQdgAahAKIAVBQGsQCnEgBUEoahAKcSAFQRBqEApxGyEJDAELQWwhCQsgBUHwAGokACAJC8oCAQR/IwBBIGsiBSQAIAUgBBAOIAUtAAIhByAFQQhqIAIgAxAGIgIQA0UEQCAEQQRqIQIgACABaiIDQX1qIQQDQCAFQQhqEAQgACAET3JFBEAgAiAFQQhqIAcQAkEBdGoiBi0AACEIIAVBCGogBi0AARABIAAgCDoAACACIAVBCGogBxACQQF0aiIGLQAAIQggBUEIaiAGLQABEAEgACAIOgABIABBAmohAAwBCwsDQCAFQQhqEAQgACADT3JFBEAgAiAFQQhqIAcQAkEBdGoiBC0AACEGIAVBCGogBC0AARABIAAgBjoAACAAQQFqIQAMAQsLA0AgACADT0UEQCACIAVBCGogBxACQQF0aiIELQAAIQYgBUEIaiAELQABEAEgACAGOgAAIABBAWohAAwBCwsgAUFsIAVBCGoQChshAgsgBUEgaiQAIAILtgMBCX8jAEEQayIGJAAgBkEANgIMIAZBADYCCEFUIQQCQAJAIANBQGsiDCADIAZBCGogBkEMaiABIAIQMSICEAMNACAGQQRqIAAQDiAGKAIMIgcgBi0ABEEBaksNASAAQQRqIQogBkEAOgAFIAYgBzoABiAAIAYoAgQ2AgAgB0EBaiEJQQEhBANAIAQgCUkEQCADIARBAnRqIgEoAgAhACABIAU2AgAgACAEQX9qdCAFaiEFIARBAWohBAwBCwsgB0EBaiEHQQAhBSAGKAIIIQkDQCAFIAlGDQEgAyAFIAxqLQAAIgRBAnRqIgBBASAEdEEBdSILIAAoAgAiAWoiADYCACAHIARrIQhBACEEAkAgC0EDTQRAA0AgBCALRg0CIAogASAEakEBdGoiACAIOgABIAAgBToAACAEQQFqIQQMAAALAAsDQCABIABPDQEgCiABQQF0aiIEIAg6AAEgBCAFOgAAIAQgCDoAAyAEIAU6AAIgBCAIOgAFIAQgBToABCAEIAg6AAcgBCAFOgAGIAFBBGohAQwAAAsACyAFQQFqIQUMAAALAAsgAiEECyAGQRBqJAAgBAutAQECfwJAQYQgKAIAIABHIAAoAgBBAXYiAyABa0F4aiICQXhxQQhHcgR/IAIFIAMQJ0UNASACQQhqC0EQSQ0AIAAgACgCACICQQFxIAAgAWpBD2pBeHEiASAAa0EBdHI2AgAgASAANgIEIAEgASgCAEEBcSAAIAJBAXZqIAFrIgJBAXRyNgIAQYQgIAEgAkH/////B3FqQQRqQYQgKAIAIABGGyABNgIAIAEQJQsLygIBBX8CQAJAAkAgAEEIIABBCEsbZ0EfcyAAaUEBR2oiAUEESSAAIAF2cg0AIAFBAnRB/B5qKAIAIgJFDQADQCACQXhqIgMoAgBBAXZBeGoiBSAATwRAIAIgBUEIIAVBCEsbZ0Efc0ECdEGAH2oiASgCAEYEQCABIAIoAgQ2AgALDAMLIARBHksNASAEQQFqIQQgAigCBCICDQALC0EAIQMgAUEgTw0BA0AgAUECdEGAH2ooAgAiAkUEQCABQR5LIQIgAUEBaiEBIAJFDQEMAwsLIAIgAkF4aiIDKAIAQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgBGBEAgASACKAIENgIACwsgAigCACIBBEAgASACKAIENgIECyACKAIEIgEEQCABIAIoAgA2AgALIAMgAygCAEEBcjYCACADIAAQNwsgAwvhCwINfwV+IwBB8ABrIgckACAHIAAoAvDhASIINgJcIAEgAmohDSAIIAAoAoDiAWohDwJAAkAgBUUEQCABIQQMAQsgACgCxOABIRAgACgCwOABIREgACgCvOABIQ4gAEEBNgKM4QFBACEIA0AgCEEDRwRAIAcgCEECdCICaiAAIAJqQazQAWooAgA2AkQgCEEBaiEIDAELC0FsIQwgB0EYaiADIAQQBhADDQEgB0EsaiAHQRhqIAAoAgAQEyAHQTRqIAdBGGogACgCCBATIAdBPGogB0EYaiAAKAIEEBMgDUFgaiESIAEhBEEAIQwDQCAHKAIwIAcoAixBA3RqKQIAIhRCEIinQf8BcSEIIAcoAkAgBygCPEEDdGopAgAiFUIQiKdB/wFxIQsgBygCOCAHKAI0QQN0aikCACIWQiCIpyEJIBVCIIghFyAUQiCIpyECAkAgFkIQiKdB/wFxIgNBAk8EQAJAIAZFIANBGUlyRQRAIAkgB0EYaiADQSAgBygCHGsiCiAKIANLGyIKEAUgAyAKayIDdGohCSAHQRhqEAQaIANFDQEgB0EYaiADEAUgCWohCQwBCyAHQRhqIAMQBSAJaiEJIAdBGGoQBBoLIAcpAkQhGCAHIAk2AkQgByAYNwNIDAELAkAgA0UEQCACBEAgBygCRCEJDAMLIAcoAkghCQwBCwJAAkAgB0EYakEBEAUgCSACRWpqIgNBA0YEQCAHKAJEQX9qIgMgA0VqIQkMAQsgA0ECdCAHaigCRCIJIAlFaiEJIANBAUYNAQsgByAHKAJINgJMCwsgByAHKAJENgJIIAcgCTYCRAsgF6chAyALBEAgB0EYaiALEAUgA2ohAwsgCCALakEUTwRAIAdBGGoQBBoLIAgEQCAHQRhqIAgQBSACaiECCyAHQRhqEAQaIAcgB0EYaiAUQhiIp0H/AXEQCCAUp0H//wNxajYCLCAHIAdBGGogFUIYiKdB/wFxEAggFadB//8DcWo2AjwgB0EYahAEGiAHIAdBGGogFkIYiKdB/wFxEAggFqdB//8DcWo2AjQgByACNgJgIAcoAlwhCiAHIAk2AmggByADNgJkAkACQAJAIAQgAiADaiILaiASSw0AIAIgCmoiEyAPSw0AIA0gBGsgC0Egak8NAQsgByAHKQNoNwMQIAcgBykDYDcDCCAEIA0gB0EIaiAHQdwAaiAPIA4gESAQEB4hCwwBCyACIARqIQggBCAKEAcgAkERTwRAIARBEGohAgNAIAIgCkEQaiIKEAcgAkEQaiICIAhJDQALCyAIIAlrIQIgByATNgJcIAkgCCAOa0sEQCAJIAggEWtLBEBBbCELDAILIBAgAiAOayICaiIKIANqIBBNBEAgCCAKIAMQDxoMAgsgCCAKQQAgAmsQDyEIIAcgAiADaiIDNgJkIAggAmshCCAOIQILIAlBEE8EQCADIAhqIQMDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALDAELAkAgCUEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgCUECdCIDQcAeaigCAGoiAhAXIAIgA0HgHmooAgBrIQIgBygCZCEDDAELIAggAhAMCyADQQlJDQAgAyAIaiEDIAhBCGoiCCACQQhqIgJrQQ9MBEADQCAIIAIQDCACQQhqIQIgCEEIaiIIIANJDQAMAgALAAsDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALCyAHQRhqEAQaIAsgDCALEAMiAhshDCAEIAQgC2ogAhshBCAFQX9qIgUNAAsgDBADDQFBbCEMIAdBGGoQBEECSQ0BQQAhCANAIAhBA0cEQCAAIAhBAnQiAmpBrNABaiACIAdqKAJENgIAIAhBAWohCAwBCwsgBygCXCEIC0G6fyEMIA8gCGsiACANIARrSw0AIAQEfyAEIAggABALIABqBUEACyABayEMCyAHQfAAaiQAIAwLkRcCFn8FfiMAQdABayIHJAAgByAAKALw4QEiCDYCvAEgASACaiESIAggACgCgOIBaiETAkACQCAFRQRAIAEhAwwBCyAAKALE4AEhESAAKALA4AEhFSAAKAK84AEhDyAAQQE2AozhAUEAIQgDQCAIQQNHBEAgByAIQQJ0IgJqIAAgAmpBrNABaigCADYCVCAIQQFqIQgMAQsLIAcgETYCZCAHIA82AmAgByABIA9rNgJoQWwhECAHQShqIAMgBBAGEAMNASAFQQQgBUEESBshFyAHQTxqIAdBKGogACgCABATIAdBxABqIAdBKGogACgCCBATIAdBzABqIAdBKGogACgCBBATQQAhBCAHQeAAaiEMIAdB5ABqIQoDQCAHQShqEARBAksgBCAXTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEJIAcoAkggBygCREEDdGopAgAiH0IgiKchCCAeQiCIISAgHUIgiKchAgJAIB9CEIinQf8BcSIDQQJPBEACQCAGRSADQRlJckUEQCAIIAdBKGogA0EgIAcoAixrIg0gDSADSxsiDRAFIAMgDWsiA3RqIQggB0EoahAEGiADRQ0BIAdBKGogAxAFIAhqIQgMAQsgB0EoaiADEAUgCGohCCAHQShqEAQaCyAHKQJUISEgByAINgJUIAcgITcDWAwBCwJAIANFBEAgAgRAIAcoAlQhCAwDCyAHKAJYIQgMAQsCQAJAIAdBKGpBARAFIAggAkVqaiIDQQNGBEAgBygCVEF/aiIDIANFaiEIDAELIANBAnQgB2ooAlQiCCAIRWohCCADQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAg2AlQLICCnIQMgCQRAIAdBKGogCRAFIANqIQMLIAkgC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgAmohAgsgB0EoahAEGiAHIAcoAmggAmoiCSADajYCaCAKIAwgCCAJSxsoAgAhDSAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogB0EoaiAfQhiIp0H/AXEQCCEOIAdB8ABqIARBBHRqIgsgCSANaiAIazYCDCALIAg2AgggCyADNgIEIAsgAjYCACAHIA4gH6dB//8DcWo2AkQgBEEBaiEEDAELCyAEIBdIDQEgEkFgaiEYIAdB4ABqIRogB0HkAGohGyABIQMDQCAHQShqEARBAksgBCAFTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEIIAcoAkggBygCREEDdGopAgAiH0IgiKchCSAeQiCIISAgHUIgiKchDAJAIB9CEIinQf8BcSICQQJPBEACQCAGRSACQRlJckUEQCAJIAdBKGogAkEgIAcoAixrIgogCiACSxsiChAFIAIgCmsiAnRqIQkgB0EoahAEGiACRQ0BIAdBKGogAhAFIAlqIQkMAQsgB0EoaiACEAUgCWohCSAHQShqEAQaCyAHKQJUISEgByAJNgJUIAcgITcDWAwBCwJAIAJFBEAgDARAIAcoAlQhCQwDCyAHKAJYIQkMAQsCQAJAIAdBKGpBARAFIAkgDEVqaiICQQNGBEAgBygCVEF/aiICIAJFaiEJDAELIAJBAnQgB2ooAlQiCSAJRWohCSACQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAk2AlQLICCnIRQgCARAIAdBKGogCBAFIBRqIRQLIAggC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgDGohDAsgB0EoahAEGiAHIAcoAmggDGoiGSAUajYCaCAbIBogCSAZSxsoAgAhHCAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogByAHQShqIB9CGIinQf8BcRAIIB+nQf//A3FqNgJEIAcgB0HwAGogBEEDcUEEdGoiDSkDCCIdNwPIASAHIA0pAwAiHjcDwAECQAJAAkAgBygCvAEiDiAepyICaiIWIBNLDQAgAyAHKALEASIKIAJqIgtqIBhLDQAgEiADayALQSBqTw0BCyAHIAcpA8gBNwMQIAcgBykDwAE3AwggAyASIAdBCGogB0G8AWogEyAPIBUgERAeIQsMAQsgAiADaiEIIAMgDhAHIAJBEU8EQCADQRBqIQIDQCACIA5BEGoiDhAHIAJBEGoiAiAISQ0ACwsgCCAdpyIOayECIAcgFjYCvAEgDiAIIA9rSwRAIA4gCCAVa0sEQEFsIQsMAgsgESACIA9rIgJqIhYgCmogEU0EQCAIIBYgChAPGgwCCyAIIBZBACACaxAPIQggByACIApqIgo2AsQBIAggAmshCCAPIQILIA5BEE8EQCAIIApqIQoDQCAIIAIQByACQRBqIQIgCEEQaiIIIApJDQALDAELAkAgDkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgDkECdCIKQcAeaigCAGoiAhAXIAIgCkHgHmooAgBrIQIgBygCxAEhCgwBCyAIIAIQDAsgCkEJSQ0AIAggCmohCiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAKSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAKSQ0ACwsgCxADBEAgCyEQDAQFIA0gDDYCACANIBkgHGogCWs2AgwgDSAJNgIIIA0gFDYCBCAEQQFqIQQgAyALaiEDDAILAAsLIAQgBUgNASAEIBdrIQtBACEEA0AgCyAFSARAIAcgB0HwAGogC0EDcUEEdGoiAikDCCIdNwPIASAHIAIpAwAiHjcDwAECQAJAAkAgBygCvAEiDCAepyICaiIKIBNLDQAgAyAHKALEASIJIAJqIhBqIBhLDQAgEiADayAQQSBqTw0BCyAHIAcpA8gBNwMgIAcgBykDwAE3AxggAyASIAdBGGogB0G8AWogEyAPIBUgERAeIRAMAQsgAiADaiEIIAMgDBAHIAJBEU8EQCADQRBqIQIDQCACIAxBEGoiDBAHIAJBEGoiAiAISQ0ACwsgCCAdpyIGayECIAcgCjYCvAEgBiAIIA9rSwRAIAYgCCAVa0sEQEFsIRAMAgsgESACIA9rIgJqIgwgCWogEU0EQCAIIAwgCRAPGgwCCyAIIAxBACACaxAPIQggByACIAlqIgk2AsQBIAggAmshCCAPIQILIAZBEE8EQCAIIAlqIQYDQCAIIAIQByACQRBqIQIgCEEQaiIIIAZJDQALDAELAkAgBkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgBkECdCIGQcAeaigCAGoiAhAXIAIgBkHgHmooAgBrIQIgBygCxAEhCQwBCyAIIAIQDAsgCUEJSQ0AIAggCWohBiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAGSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAGSQ0ACwsgEBADDQMgC0EBaiELIAMgEGohAwwBCwsDQCAEQQNHBEAgACAEQQJ0IgJqQazQAWogAiAHaigCVDYCACAEQQFqIQQMAQsLIAcoArwBIQgLQbp/IRAgEyAIayIAIBIgA2tLDQAgAwR/IAMgCCAAEAsgAGoFQQALIAFrIRALIAdB0AFqJAAgEAslACAAQgA3AgAgAEEAOwEIIABBADoACyAAIAE2AgwgACACOgAKC7QFAQN/IwBBMGsiBCQAIABB/wFqIgVBfWohBgJAIAMvAQIEQCAEQRhqIAEgAhAGIgIQAw0BIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahASOgAAIAMgBEEIaiAEQRhqEBI6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0FIAEgBEEQaiAEQRhqEBI6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBSABIARBCGogBEEYahASOgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEjoAACABIAJqIABrIQIMAwsgAyAEQRBqIARBGGoQEjoAAiADIARBCGogBEEYahASOgADIANBBGohAwwAAAsACyAEQRhqIAEgAhAGIgIQAw0AIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahAROgAAIAMgBEEIaiAEQRhqEBE6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0EIAEgBEEQaiAEQRhqEBE6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBCABIARBCGogBEEYahAROgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEToAACABIAJqIABrIQIMAgsgAyAEQRBqIARBGGoQEToAAiADIARBCGogBEEYahAROgADIANBBGohAwwAAAsACyAEQTBqJAAgAgtpAQF/An8CQAJAIAJBB00NACABKAAAQbfIwuF+Rw0AIAAgASgABDYCmOIBQWIgAEEQaiABIAIQPiIDEAMNAhogAEKBgICAEDcDiOEBIAAgASADaiACIANrECoMAQsgACABIAIQKgtBAAsLrQMBBn8jAEGAAWsiAyQAQWIhCAJAIAJBCUkNACAAQZjQAGogAUEIaiIEIAJBeGogAEGY0AAQMyIFEAMiBg0AIANBHzYCfCADIANB/ABqIANB+ABqIAQgBCAFaiAGGyIEIAEgAmoiAiAEaxAVIgUQAw0AIAMoAnwiBkEfSw0AIAMoAngiB0EJTw0AIABBiCBqIAMgBkGAC0GADCAHEBggA0E0NgJ8IAMgA0H8AGogA0H4AGogBCAFaiIEIAIgBGsQFSIFEAMNACADKAJ8IgZBNEsNACADKAJ4IgdBCk8NACAAQZAwaiADIAZBgA1B4A4gBxAYIANBIzYCfCADIANB/ABqIANB+ABqIAQgBWoiBCACIARrEBUiBRADDQAgAygCfCIGQSNLDQAgAygCeCIHQQpPDQAgACADIAZBwBBB0BEgBxAYIAQgBWoiBEEMaiIFIAJLDQAgAiAFayEFQQAhAgNAIAJBA0cEQCAEKAAAIgZBf2ogBU8NAiAAIAJBAnRqQZzQAWogBjYCACACQQFqIQIgBEEEaiEEDAELCyAEIAFrIQgLIANBgAFqJAAgCAtGAQN/IABBCGohAyAAKAIEIQJBACEAA0AgACACdkUEQCABIAMgAEEDdGotAAJBFktqIQEgAEEBaiEADAELCyABQQggAmt0C4YDAQV/Qbh/IQcCQCADRQ0AIAItAAAiBEUEQCABQQA2AgBBAUG4fyADQQFGGw8LAn8gAkEBaiIFIARBGHRBGHUiBkF/Sg0AGiAGQX9GBEAgA0EDSA0CIAUvAABBgP4BaiEEIAJBA2oMAQsgA0ECSA0BIAItAAEgBEEIdHJBgIB+aiEEIAJBAmoLIQUgASAENgIAIAVBAWoiASACIANqIgNLDQBBbCEHIABBEGogACAFLQAAIgVBBnZBI0EJIAEgAyABa0HAEEHQEUHwEiAAKAKM4QEgACgCnOIBIAQQHyIGEAMiCA0AIABBmCBqIABBCGogBUEEdkEDcUEfQQggASABIAZqIAgbIgEgAyABa0GAC0GADEGAFyAAKAKM4QEgACgCnOIBIAQQHyIGEAMiCA0AIABBoDBqIABBBGogBUECdkEDcUE0QQkgASABIAZqIAgbIgEgAyABa0GADUHgDkGQGSAAKAKM4QEgACgCnOIBIAQQHyIAEAMNACAAIAFqIAJrIQcLIAcLrQMBCn8jAEGABGsiCCQAAn9BUiACQf8BSw0AGkFUIANBDEsNABogAkEBaiELIABBBGohCUGAgAQgA0F/anRBEHUhCkEAIQJBASEEQQEgA3QiB0F/aiIMIQUDQCACIAtGRQRAAkAgASACQQF0Ig1qLwEAIgZB//8DRgRAIAkgBUECdGogAjoAAiAFQX9qIQVBASEGDAELIARBACAKIAZBEHRBEHVKGyEECyAIIA1qIAY7AQAgAkEBaiECDAELCyAAIAQ7AQIgACADOwEAIAdBA3YgB0EBdmpBA2ohBkEAIQRBACECA0AgBCALRkUEQCABIARBAXRqLgEAIQpBACEAA0AgACAKTkUEQCAJIAJBAnRqIAQ6AAIDQCACIAZqIAxxIgIgBUsNAAsgAEEBaiEADAELCyAEQQFqIQQMAQsLQX8gAg0AGkEAIQIDfyACIAdGBH9BAAUgCCAJIAJBAnRqIgAtAAJBAXRqIgEgAS8BACIBQQFqOwEAIAAgAyABEBRrIgU6AAMgACABIAVB/wFxdCAHazsBACACQQFqIQIMAQsLCyEFIAhBgARqJAAgBQvjBgEIf0FsIQcCQCACQQNJDQACQAJAAkACQCABLQAAIgNBA3EiCUEBaw4DAwEAAgsgACgCiOEBDQBBYg8LIAJBBUkNAkEDIQYgASgAACEFAn8CQAJAIANBAnZBA3EiCEF+aiIEQQFNBEAgBEEBaw0BDAILIAVBDnZB/wdxIQQgBUEEdkH/B3EhAyAIRQwCCyAFQRJ2IQRBBCEGIAVBBHZB//8AcSEDQQAMAQsgBUEEdkH//w9xIgNBgIAISw0DIAEtAARBCnQgBUEWdnIhBEEFIQZBAAshBSAEIAZqIgogAksNAgJAIANBgQZJDQAgACgCnOIBRQ0AQQAhAgNAIAJBg4ABSw0BIAJBQGshAgwAAAsACwJ/IAlBA0YEQCABIAZqIQEgAEHw4gFqIQIgACgCDCEGIAUEQCACIAMgASAEIAYQXwwCCyACIAMgASAEIAYQXQwBCyAAQbjQAWohAiABIAZqIQEgAEHw4gFqIQYgAEGo0ABqIQggBQRAIAggBiADIAEgBCACEF4MAQsgCCAGIAMgASAEIAIQXAsQAw0CIAAgAzYCgOIBIABBATYCiOEBIAAgAEHw4gFqNgLw4QEgCUECRgRAIAAgAEGo0ABqNgIMCyAAIANqIgBBiOMBakIANwAAIABBgOMBakIANwAAIABB+OIBakIANwAAIABB8OIBakIANwAAIAoPCwJ/AkACQAJAIANBAnZBA3FBf2oiBEECSw0AIARBAWsOAgACAQtBASEEIANBA3YMAgtBAiEEIAEvAABBBHYMAQtBAyEEIAEQIUEEdgsiAyAEaiIFQSBqIAJLBEAgBSACSw0CIABB8OIBaiABIARqIAMQCyEBIAAgAzYCgOIBIAAgATYC8OEBIAEgA2oiAEIANwAYIABCADcAECAAQgA3AAggAEIANwAAIAUPCyAAIAM2AoDiASAAIAEgBGo2AvDhASAFDwsCfwJAAkACQCADQQJ2QQNxQX9qIgRBAksNACAEQQFrDgIAAgELQQEhByADQQN2DAILQQIhByABLwAAQQR2DAELIAJBBEkgARAhIgJBj4CAAUtyDQFBAyEHIAJBBHYLIQIgAEHw4gFqIAEgB2otAAAgAkEgahAQIQEgACACNgKA4gEgACABNgLw4QEgB0EBaiEHCyAHC0sAIABC+erQ0OfJoeThADcDICAAQgA3AxggAELP1tO+0ser2UI3AxAgAELW64Lu6v2J9eAANwMIIABCADcDACAAQShqQQBBKBAQGgviAgICfwV+IABBKGoiASAAKAJIaiECAn4gACkDACIDQiBaBEAgACkDECIEQgeJIAApAwgiBUIBiXwgACkDGCIGQgyJfCAAKQMgIgdCEol8IAUQGSAEEBkgBhAZIAcQGQwBCyAAKQMYQsXP2bLx5brqJ3wLIAN8IQMDQCABQQhqIgAgAk0EQEIAIAEpAAAQCSADhUIbiUKHla+vmLbem55/fkLj3MqV/M7y9YV/fCEDIAAhAQwBCwsCQCABQQRqIgAgAksEQCABIQAMAQsgASgAAK1Ch5Wvr5i23puef34gA4VCF4lCz9bTvtLHq9lCfkL5893xmfaZqxZ8IQMLA0AgACACSQRAIAAxAABCxc/ZsvHluuonfiADhUILiUKHla+vmLbem55/fiEDIABBAWohAAwBCwsgA0IhiCADhULP1tO+0ser2UJ+IgNCHYggA4VC+fPd8Zn2masWfiIDQiCIIAOFC+8CAgJ/BH4gACAAKQMAIAKtfDcDAAJAAkAgACgCSCIDIAJqIgRBH00EQCABRQ0BIAAgA2pBKGogASACECAgACgCSCACaiEEDAELIAEgAmohAgJ/IAMEQCAAQShqIgQgA2ogAUEgIANrECAgACAAKQMIIAQpAAAQCTcDCCAAIAApAxAgACkAMBAJNwMQIAAgACkDGCAAKQA4EAk3AxggACAAKQMgIABBQGspAAAQCTcDICAAKAJIIQMgAEEANgJIIAEgA2tBIGohAQsgAUEgaiACTQsEQCACQWBqIQMgACkDICEFIAApAxghBiAAKQMQIQcgACkDCCEIA0AgCCABKQAAEAkhCCAHIAEpAAgQCSEHIAYgASkAEBAJIQYgBSABKQAYEAkhBSABQSBqIgEgA00NAAsgACAFNwMgIAAgBjcDGCAAIAc3AxAgACAINwMICyABIAJPDQEgAEEoaiABIAIgAWsiBBAgCyAAIAQ2AkgLCy8BAX8gAEUEQEG2f0EAIAMbDwtBun8hBCADIAFNBH8gACACIAMQEBogAwVBun8LCy8BAX8gAEUEQEG2f0EAIAMbDwtBun8hBCADIAFNBH8gACACIAMQCxogAwVBun8LC6gCAQZ/IwBBEGsiByQAIABB2OABaikDAEKAgIAQViEIQbh/IQUCQCAEQf//B0sNACAAIAMgBBBCIgUQAyIGDQAgACgCnOIBIQkgACAHQQxqIAMgAyAFaiAGGyIKIARBACAFIAYbayIGEEAiAxADBEAgAyEFDAELIAcoAgwhBCABRQRAQbp/IQUgBEEASg0BCyAGIANrIQUgAyAKaiEDAkAgCQRAIABBADYCnOIBDAELAkACQAJAIARBBUgNACAAQdjgAWopAwBCgICACFgNAAwBCyAAQQA2ApziAQwBCyAAKAIIED8hBiAAQQA2ApziASAGQRRPDQELIAAgASACIAMgBSAEIAgQOSEFDAELIAAgASACIAMgBSAEIAgQOiEFCyAHQRBqJAAgBQtnACAAQdDgAWogASACIAAoAuzhARAuIgEQAwRAIAEPC0G4fyECAkAgAQ0AIABB7OABaigCACIBBEBBYCECIAAoApjiASABRw0BC0EAIQIgAEHw4AFqKAIARQ0AIABBkOEBahBDCyACCycBAX8QVyIERQRAQUAPCyAEIAAgASACIAMgBBBLEE8hACAEEFYgAAs/AQF/AkACQAJAIAAoAqDiAUEBaiIBQQJLDQAgAUEBaw4CAAECCyAAEDBBAA8LIABBADYCoOIBCyAAKAKU4gELvAMCB38BfiMAQRBrIgkkAEG4fyEGAkAgBCgCACIIQQVBCSAAKALs4QEiBRtJDQAgAygCACIHQQFBBSAFGyAFEC8iBRADBEAgBSEGDAELIAggBUEDakkNACAAIAcgBRBJIgYQAw0AIAEgAmohCiAAQZDhAWohCyAIIAVrIQIgBSAHaiEHIAEhBQNAIAcgAiAJECwiBhADDQEgAkF9aiICIAZJBEBBuH8hBgwCCyAJKAIAIghBAksEQEFsIQYMAgsgB0EDaiEHAn8CQAJAAkAgCEEBaw4CAgABCyAAIAUgCiAFayAHIAYQSAwCCyAFIAogBWsgByAGEEcMAQsgBSAKIAVrIActAAAgCSgCCBBGCyIIEAMEQCAIIQYMAgsgACgC8OABBEAgCyAFIAgQRQsgAiAGayECIAYgB2ohByAFIAhqIQUgCSgCBEUNAAsgACkD0OABIgxCf1IEQEFsIQYgDCAFIAFrrFINAQsgACgC8OABBEBBaiEGIAJBBEkNASALEEQhDCAHKAAAIAynRw0BIAdBBGohByACQXxqIQILIAMgBzYCACAEIAI2AgAgBSABayEGCyAJQRBqJAAgBgsuACAAECsCf0EAQQAQAw0AGiABRSACRXJFBEBBYiAAIAEgAhA9EAMNARoLQQALCzcAIAEEQCAAIAAoAsTgASABKAIEIAEoAghqRzYCnOIBCyAAECtBABADIAFFckUEQCAAIAEQWwsL0QIBB38jAEEQayIGJAAgBiAENgIIIAYgAzYCDCAFBEAgBSgCBCEKIAUoAgghCQsgASEIAkACQANAIAAoAuzhARAWIQsCQANAIAQgC0kNASADKAAAQXBxQdDUtMIBRgRAIAMgBBAiIgcQAw0EIAQgB2shBCADIAdqIQMMAQsLIAYgAzYCDCAGIAQ2AggCQCAFBEAgACAFEE5BACEHQQAQA0UNAQwFCyAAIAogCRBNIgcQAw0ECyAAIAgQUCAMQQFHQQAgACAIIAIgBkEMaiAGQQhqEEwiByIDa0EAIAMQAxtBCkdyRQRAQbh/IQcMBAsgBxADDQMgAiAHayECIAcgCGohCEEBIQwgBigCDCEDIAYoAgghBAwBCwsgBiADNgIMIAYgBDYCCEG4fyEHIAQNASAIIAFrIQcMAQsgBiADNgIMIAYgBDYCCAsgBkEQaiQAIAcLRgECfyABIAAoArjgASICRwRAIAAgAjYCxOABIAAgATYCuOABIAAoArzgASEDIAAgATYCvOABIAAgASADIAJrajYCwOABCwutAgIEfwF+IwBBQGoiBCQAAkACQCACQQhJDQAgASgAAEFwcUHQ1LTCAUcNACABIAIQIiEBIABCADcDCCAAQQA2AgQgACABNgIADAELIARBGGogASACEC0iAxADBEAgACADEBoMAQsgAwRAIABBuH8QGgwBCyACIAQoAjAiA2shAiABIANqIQMDQAJAIAAgAyACIARBCGoQLCIFEAMEfyAFBSACIAVBA2oiBU8NAUG4fwsQGgwCCyAGQQFqIQYgAiAFayECIAMgBWohAyAEKAIMRQ0ACyAEKAI4BEAgAkEDTQRAIABBuH8QGgwCCyADQQRqIQMLIAQoAighAiAEKQMYIQcgAEEANgIEIAAgAyABazYCACAAIAIgBmytIAcgB0J/URs3AwgLIARBQGskAAslAQF/IwBBEGsiAiQAIAIgACABEFEgAigCACEAIAJBEGokACAAC30BBH8jAEGQBGsiBCQAIARB/wE2AggCQCAEQRBqIARBCGogBEEMaiABIAIQFSIGEAMEQCAGIQUMAQtBVCEFIAQoAgwiB0EGSw0AIAMgBEEQaiAEKAIIIAcQQSIFEAMNACAAIAEgBmogAiAGayADEDwhBQsgBEGQBGokACAFC4cBAgJ/An5BABAWIQMCQANAIAEgA08EQAJAIAAoAABBcHFB0NS0wgFGBEAgACABECIiAhADRQ0BQn4PCyAAIAEQVSIEQn1WDQMgBCAFfCIFIARUIQJCfiEEIAINAyAAIAEQUiICEAMNAwsgASACayEBIAAgAmohAAwBCwtCfiAFIAEbIQQLIAQLPwIBfwF+IwBBMGsiAiQAAn5CfiACQQhqIAAgARAtDQAaQgAgAigCHEEBRg0AGiACKQMICyEDIAJBMGokACADC40BAQJ/IwBBMGsiASQAAkAgAEUNACAAKAKI4gENACABIABB/OEBaigCADYCKCABIAApAvThATcDICAAEDAgACgCqOIBIQIgASABKAIoNgIYIAEgASkDIDcDECACIAFBEGoQGyAAQQA2AqjiASABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALKgECfyMAQRBrIgAkACAAQQA2AgggAEIANwMAIAAQWCEBIABBEGokACABC4cBAQN/IwBBEGsiAiQAAkAgACgCAEUgACgCBEVzDQAgAiAAKAIINgIIIAIgACkCADcDAAJ/IAIoAgAiAQRAIAIoAghBqOMJIAERBQAMAQtBqOMJECgLIgFFDQAgASAAKQIANwL04QEgAUH84QFqIAAoAgg2AgAgARBZIAEhAwsgAkEQaiQAIAMLywEBAn8jAEEgayIBJAAgAEGBgIDAADYCtOIBIABBADYCiOIBIABBADYC7OEBIABCADcDkOIBIABBADYCpOMJIABBADYC3OIBIABCADcCzOIBIABBADYCvOIBIABBADYCxOABIABCADcCnOIBIABBpOIBakIANwIAIABBrOIBakEANgIAIAFCADcCECABQgA3AhggASABKQMYNwMIIAEgASkDEDcDACABKAIIQQh2QQFxIQIgAEEANgLg4gEgACACNgKM4gEgAUEgaiQAC3YBA38jAEEwayIBJAAgAARAIAEgAEHE0AFqIgIoAgA2AiggASAAKQK80AE3AyAgACgCACEDIAEgAigCADYCGCABIAApArzQATcDECADIAFBEGoQGyABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALzAEBAX8gACABKAK00AE2ApjiASAAIAEoAgQiAjYCwOABIAAgAjYCvOABIAAgAiABKAIIaiICNgK44AEgACACNgLE4AEgASgCuNABBEAgAEKBgICAEDcDiOEBIAAgAUGk0ABqNgIMIAAgAUGUIGo2AgggACABQZwwajYCBCAAIAFBDGo2AgAgAEGs0AFqIAFBqNABaigCADYCACAAQbDQAWogAUGs0AFqKAIANgIAIABBtNABaiABQbDQAWooAgA2AgAPCyAAQgA3A4jhAQs7ACACRQRAQbp/DwsgBEUEQEFsDwsgAiAEEGAEQCAAIAEgAiADIAQgBRBhDwsgACABIAIgAyAEIAUQZQtGAQF/IwBBEGsiBSQAIAVBCGogBBAOAn8gBS0ACQRAIAAgASACIAMgBBAyDAELIAAgASACIAMgBBA0CyEAIAVBEGokACAACzQAIAAgAyAEIAUQNiIFEAMEQCAFDwsgBSAESQR/IAEgAiADIAVqIAQgBWsgABA1BUG4fwsLRgEBfyMAQRBrIgUkACAFQQhqIAQQDgJ/IAUtAAkEQCAAIAEgAiADIAQQYgwBCyAAIAEgAiADIAQQNQshACAFQRBqJAAgAAtZAQF/QQ8hAiABIABJBEAgAUEEdCAAbiECCyAAQQh2IgEgAkEYbCIAQYwIaigCAGwgAEGICGooAgBqIgJBA3YgAmogAEGACGooAgAgAEGECGooAgAgAWxqSQs3ACAAIAMgBCAFQYAQEDMiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQMgVBuH8LC78DAQN/IwBBIGsiBSQAIAVBCGogAiADEAYiAhADRQRAIAAgAWoiB0F9aiEGIAUgBBAOIARBBGohAiAFLQACIQMDQEEAIAAgBkkgBUEIahAEGwRAIAAgAiAFQQhqIAMQAkECdGoiBC8BADsAACAFQQhqIAQtAAIQASAAIAQtAANqIgQgAiAFQQhqIAMQAkECdGoiAC8BADsAACAFQQhqIAAtAAIQASAEIAAtAANqIQAMAQUgB0F+aiEEA0AgBUEIahAEIAAgBEtyRQRAIAAgAiAFQQhqIAMQAkECdGoiBi8BADsAACAFQQhqIAYtAAIQASAAIAYtAANqIQAMAQsLA0AgACAES0UEQCAAIAIgBUEIaiADEAJBAnRqIgYvAQA7AAAgBUEIaiAGLQACEAEgACAGLQADaiEADAELCwJAIAAgB08NACAAIAIgBUEIaiADEAIiA0ECdGoiAC0AADoAACAALQADQQFGBEAgBUEIaiAALQACEAEMAQsgBSgCDEEfSw0AIAVBCGogAiADQQJ0ai0AAhABIAUoAgxBIUkNACAFQSA2AgwLIAFBbCAFQQhqEAobIQILCwsgBUEgaiQAIAILkgIBBH8jAEFAaiIJJAAgCSADQTQQCyEDAkAgBEECSA0AIAMgBEECdGooAgAhCSADQTxqIAgQIyADQQE6AD8gAyACOgA+QQAhBCADKAI8IQoDQCAEIAlGDQEgACAEQQJ0aiAKNgEAIARBAWohBAwAAAsAC0EAIQkDQCAGIAlGRQRAIAMgBSAJQQF0aiIKLQABIgtBAnRqIgwoAgAhBCADQTxqIAotAABBCHQgCGpB//8DcRAjIANBAjoAPyADIAcgC2siCiACajoAPiAEQQEgASAKa3RqIQogAygCPCELA0AgACAEQQJ0aiALNgEAIARBAWoiBCAKSQ0ACyAMIAo2AgAgCUEBaiEJDAELCyADQUBrJAALowIBCX8jAEHQAGsiCSQAIAlBEGogBUE0EAsaIAcgBmshDyAHIAFrIRADQAJAIAMgCkcEQEEBIAEgByACIApBAXRqIgYtAAEiDGsiCGsiC3QhDSAGLQAAIQ4gCUEQaiAMQQJ0aiIMKAIAIQYgCyAPTwRAIAAgBkECdGogCyAIIAUgCEE0bGogCCAQaiIIQQEgCEEBShsiCCACIAQgCEECdGooAgAiCEEBdGogAyAIayAHIA4QYyAGIA1qIQgMAgsgCUEMaiAOECMgCUEBOgAPIAkgCDoADiAGIA1qIQggCSgCDCELA0AgBiAITw0CIAAgBkECdGogCzYBACAGQQFqIQYMAAALAAsgCUHQAGokAA8LIAwgCDYCACAKQQFqIQoMAAALAAs0ACAAIAMgBCAFEDYiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQNAVBuH8LCyMAIAA/AEEQdGtB//8DakEQdkAAQX9GBEBBAA8LQQAQAEEBCzsBAX8gAgRAA0AgACABIAJBgCAgAkGAIEkbIgMQCyEAIAFBgCBqIQEgAEGAIGohACACIANrIgINAAsLCwYAIAAQAwsLqBUJAEGICAsNAQAAAAEAAAACAAAAAgBBoAgLswYBAAAAAQAAAAIAAAACAAAAJgAAAIIAAAAhBQAASgAAAGcIAAAmAAAAwAEAAIAAAABJBQAASgAAAL4IAAApAAAALAIAAIAAAABJBQAASgAAAL4IAAAvAAAAygIAAIAAAACKBQAASgAAAIQJAAA1AAAAcwMAAIAAAACdBQAASgAAAKAJAAA9AAAAgQMAAIAAAADrBQAASwAAAD4KAABEAAAAngMAAIAAAABNBgAASwAAAKoKAABLAAAAswMAAIAAAADBBgAATQAAAB8NAABNAAAAUwQAAIAAAAAjCAAAUQAAAKYPAABUAAAAmQQAAIAAAABLCQAAVwAAALESAABYAAAA2gQAAIAAAABvCQAAXQAAACMUAABUAAAARQUAAIAAAABUCgAAagAAAIwUAABqAAAArwUAAIAAAAB2CQAAfAAAAE4QAAB8AAAA0gIAAIAAAABjBwAAkQAAAJAHAACSAAAAAAAAAAEAAAABAAAABQAAAA0AAAAdAAAAPQAAAH0AAAD9AAAA/QEAAP0DAAD9BwAA/Q8AAP0fAAD9PwAA/X8AAP3/AAD9/wEA/f8DAP3/BwD9/w8A/f8fAP3/PwD9/38A/f//AP3//wH9//8D/f//B/3//w/9//8f/f//P/3//38AAAAAAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABEAAAASAAAAEwAAABQAAAAVAAAAFgAAABcAAAAYAAAAGQAAABoAAAAbAAAAHAAAAB0AAAAeAAAAHwAAAAMAAAAEAAAABQAAAAYAAAAHAAAACAAAAAkAAAAKAAAACwAAAAwAAAANAAAADgAAAA8AAAAQAAAAEQAAABIAAAATAAAAFAAAABUAAAAWAAAAFwAAABgAAAAZAAAAGgAAABsAAAAcAAAAHQAAAB4AAAAfAAAAIAAAACEAAAAiAAAAIwAAACUAAAAnAAAAKQAAACsAAAAvAAAAMwAAADsAAABDAAAAUwAAAGMAAACDAAAAAwEAAAMCAAADBAAAAwgAAAMQAAADIAAAA0AAAAOAAAADAAEAQeAPC1EBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAEAAAABQAAAAcAAAAIAAAACQAAAAoAAAALAAAADAAAAA0AAAAOAAAADwAAABAAQcQQC4sBAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABIAAAAUAAAAFgAAABgAAAAcAAAAIAAAACgAAAAwAAAAQAAAAIAAAAAAAQAAAAIAAAAEAAAACAAAABAAAAAgAAAAQAAAAIAAAAAAAQBBkBIL5gQBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAAAEAAAAEAAAACAAAAAAAAAABAAEBBgAAAAAAAAQAAAAAEAAABAAAAAAgAAAFAQAAAAAAAAUDAAAAAAAABQQAAAAAAAAFBgAAAAAAAAUHAAAAAAAABQkAAAAAAAAFCgAAAAAAAAUMAAAAAAAABg4AAAAAAAEFEAAAAAAAAQUUAAAAAAABBRYAAAAAAAIFHAAAAAAAAwUgAAAAAAAEBTAAAAAgAAYFQAAAAAAABwWAAAAAAAAIBgABAAAAAAoGAAQAAAAADAYAEAAAIAAABAAAAAAAAAAEAQAAAAAAAAUCAAAAIAAABQQAAAAAAAAFBQAAACAAAAUHAAAAAAAABQgAAAAgAAAFCgAAAAAAAAULAAAAAAAABg0AAAAgAAEFEAAAAAAAAQUSAAAAIAABBRYAAAAAAAIFGAAAACAAAwUgAAAAAAADBSgAAAAAAAYEQAAAABAABgRAAAAAIAAHBYAAAAAAAAkGAAIAAAAACwYACAAAMAAABAAAAAAQAAAEAQAAACAAAAUCAAAAIAAABQMAAAAgAAAFBQAAACAAAAUGAAAAIAAABQgAAAAgAAAFCQAAACAAAAULAAAAIAAABQwAAAAAAAAGDwAAACAAAQUSAAAAIAABBRQAAAAgAAIFGAAAACAAAgUcAAAAIAADBSgAAAAgAAQFMAAAAAAAEAYAAAEAAAAPBgCAAAAAAA4GAEAAAAAADQYAIABBgBcLhwIBAAEBBQAAAAAAAAUAAAAAAAAGBD0AAAAAAAkF/QEAAAAADwX9fwAAAAAVBf3/HwAAAAMFBQAAAAAABwR9AAAAAAAMBf0PAAAAABIF/f8DAAAAFwX9/38AAAAFBR0AAAAAAAgE/QAAAAAADgX9PwAAAAAUBf3/DwAAAAIFAQAAABAABwR9AAAAAAALBf0HAAAAABEF/f8BAAAAFgX9/z8AAAAEBQ0AAAAQAAgE/QAAAAAADQX9HwAAAAATBf3/BwAAAAEFAQAAABAABgQ9AAAAAAAKBf0DAAAAABAF/f8AAAAAHAX9//8PAAAbBf3//wcAABoF/f//AwAAGQX9//8BAAAYBf3//wBBkBkLhgQBAAEBBgAAAAAAAAYDAAAAAAAABAQAAAAgAAAFBQAAAAAAAAUGAAAAAAAABQgAAAAAAAAFCQAAAAAAAAULAAAAAAAABg0AAAAAAAAGEAAAAAAAAAYTAAAAAAAABhYAAAAAAAAGGQAAAAAAAAYcAAAAAAAABh8AAAAAAAAGIgAAAAAAAQYlAAAAAAABBikAAAAAAAIGLwAAAAAAAwY7AAAAAAAEBlMAAAAAAAcGgwAAAAAACQYDAgAAEAAABAQAAAAAAAAEBQAAACAAAAUGAAAAAAAABQcAAAAgAAAFCQAAAAAAAAUKAAAAAAAABgwAAAAAAAAGDwAAAAAAAAYSAAAAAAAABhUAAAAAAAAGGAAAAAAAAAYbAAAAAAAABh4AAAAAAAAGIQAAAAAAAQYjAAAAAAABBicAAAAAAAIGKwAAAAAAAwYzAAAAAAAEBkMAAAAAAAUGYwAAAAAACAYDAQAAIAAABAQAAAAwAAAEBAAAABAAAAQFAAAAIAAABQcAAAAgAAAFCAAAACAAAAUKAAAAIAAABQsAAAAAAAAGDgAAAAAAAAYRAAAAAAAABhQAAAAAAAAGFwAAAAAAAAYaAAAAAAAABh0AAAAAAAAGIAAAAAAAEAYDAAEAAAAPBgOAAAAAAA4GA0AAAAAADQYDIAAAAAAMBgMQAAAAAAsGAwgAAAAACgYDBABBpB0L2QEBAAAAAwAAAAcAAAAPAAAAHwAAAD8AAAB/AAAA/wAAAP8BAAD/AwAA/wcAAP8PAAD/HwAA/z8AAP9/AAD//wAA//8BAP//AwD//wcA//8PAP//HwD//z8A//9/AP///wD///8B////A////wf///8P////H////z////9/AAAAAAEAAAACAAAABAAAAAAAAAACAAAABAAAAAgAAAAAAAAAAQAAAAIAAAABAAAABAAAAAQAAAAEAAAABAAAAAgAAAAIAAAACAAAAAcAAAAIAAAACQAAAAoAAAALAEGgIAsDwBBQ",IH=new WeakMap;let pH,mH=0;class AH extends Fl{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new $X,this.workerSourceURL="",this.workerConfig=null,"undefined"!=typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerPool.setWorkerLimit(e),this}detectSupport(e){return!0===e.isWebGPURenderer?this.workerConfig={astcSupported:e.hasFeature("texture-compression-astc"),etc1Supported:!1,etc2Supported:e.hasFeature("texture-compression-etc2"),dxtSupported:e.hasFeature("texture-compression-bc"),bptcSupported:!1,pvrtcSupported:!1}:(this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},e.capabilities.isWebGL2&&(this.workerConfig.etc1Supported=!1)),this}init(){if(!this.transcoderPending){const e=new zl(this.manager);e.setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials);const t=e.loadAsync("basis_transcoder.js"),i=new zl(this.manager);i.setPath(this.transcoderPath),i.setResponseType("arraybuffer"),i.setWithCredentials(this.withCredentials);const n=i.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([t,n]).then((([e,t])=>{const i=AH.BasisWorker.toString(),n=["/* constants */","let _EngineFormat = "+JSON.stringify(AH.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(AH.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(AH.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([n])),this.transcoderBinary=t,this.workerPool.setWorkerCreator((()=>{const e=new Worker(this.workerSourceURL),t=this.transcoderBinary.slice(0);return e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:t},[t]),e}))})),mH>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),mH++}return this.transcoderPending}load(e,t,i,n){if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const s=new zl(this.manager);s.setResponseType("arraybuffer"),s.setWithCredentials(this.withCredentials),s.load(e,(e=>{if(IH.has(e)){return IH.get(e).promise.then(t).catch(n)}this._createTexture(e).then((e=>t?t(e):null)).catch(n)}),i,n)}_createTextureFrom(e,t){const{faces:i,width:n,height:s,format:o,type:r,error:a,dfdFlags:l}=e;if("error"===r)return Promise.reject(a);let g;if(6===t.faceCount)g=new tl(i,o,F);else{const e=i[0].mipmaps;g=t.layerCount>1?new el(e,n,s,t.layerCount,o,F):new $a(e,n,s,o,F)}return g.minFilter=1===i[0].mipmaps.length?W:N,g.magFilter=W,g.generateMipmaps=!1,g.needsUpdate=!0,g.colorSpace=yH(t),g.premultiplyAlpha=!!(1&l),g}async _createTexture(e,t={}){const i=function(e){const t=new Uint8Array(e.buffer,e.byteOffset,rH.length);if(t[0]!==rH[0]||t[1]!==rH[1]||t[2]!==rH[2]||t[3]!==rH[3]||t[4]!==rH[4]||t[5]!==rH[5]||t[6]!==rH[6]||t[7]!==rH[7]||t[8]!==rH[8]||t[9]!==rH[9]||t[10]!==rH[10]||t[11]!==rH[11])throw new Error("Missing KTX 2.0 identifier.");const i=new sH,n=17*Uint32Array.BYTES_PER_ELEMENT,s=new oH(e,rH.length,n,!0);i.vkFormat=s._nextUint32(),i.typeSize=s._nextUint32(),i.pixelWidth=s._nextUint32(),i.pixelHeight=s._nextUint32(),i.pixelDepth=s._nextUint32(),i.layerCount=s._nextUint32(),i.faceCount=s._nextUint32();const o=s._nextUint32();i.supercompressionScheme=s._nextUint32();const r=s._nextUint32(),a=s._nextUint32(),l=s._nextUint32(),g=s._nextUint32(),c=s._nextUint64(),d=s._nextUint64(),h=new oH(e,rH.length+n,3*o*8,!0);for(let V=0;V<o;V++)i.levels.push({levelData:new Uint8Array(e.buffer,e.byteOffset+h._nextUint64(),h._nextUint64()),uncompressedByteLength:h._nextUint64()});const u=new oH(e,r,a,!0),I={vendorId:u._skip(4)._nextUint16(),descriptorType:u._nextUint16(),versionNumber:u._nextUint16(),descriptorBlockSize:u._nextUint16(),colorModel:u._nextUint8(),colorPrimaries:u._nextUint8(),transferFunction:u._nextUint8(),flags:u._nextUint8(),texelBlockDimension:[u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8()],bytesPlane:[u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8()],samples:[]},p=(I.descriptorBlockSize/4-6)/4;for(let V=0;V<p;V++){const e={bitOffset:u._nextUint16(),bitLength:u._nextUint8(),channelType:u._nextUint8(),samplePosition:[u._nextUint8(),u._nextUint8(),u._nextUint8(),u._nextUint8()],sampleLower:-1/0,sampleUpper:1/0};64&e.channelType?(e.sampleLower=u._nextInt32(),e.sampleUpper=u._nextInt32()):(e.sampleLower=u._nextUint32(),e.sampleUpper=u._nextUint32()),I.samples[V]=e}i.dataFormatDescriptor.length=0,i.dataFormatDescriptor.push(I);const m=new oH(e,l,g,!0);for(;m._offset<g;){const e=m._nextUint32(),t=m._scan(e),n=aH(t),s=m._scan(e-t.byteLength);i.keyValue[n]=n.match(/^ktx/i)?aH(s):s,m._offset%4&&m._skip(4-m._offset%4)}if(d<=0)return i;const A=new oH(e,c,d,!0),C=A._nextUint16(),f=A._nextUint16(),b=A._nextUint32(),y=A._nextUint32(),_=A._nextUint32(),v=A._nextUint32(),x=[];for(let V=0;V<o;V++)x.push({imageFlags:A._nextUint32(),rgbSliceByteOffset:A._nextUint32(),rgbSliceByteLength:A._nextUint32(),alphaSliceByteOffset:A._nextUint32(),alphaSliceByteLength:A._nextUint32()});const B=c+A._offset,w=B+b,S=w+y,G=S+_,M=new Uint8Array(e.buffer,e.byteOffset+B,b),R=new Uint8Array(e.buffer,e.byteOffset+w,y),T=new Uint8Array(e.buffer,e.byteOffset+S,_),Z=new Uint8Array(e.buffer,e.byteOffset+G,v);return i.globalData={endpointCount:C,selectorCount:f,imageDescs:x,endpointsData:M,selectorsData:R,tablesData:T,extendedData:Z},i}(new Uint8Array(e));if(0!==i.vkFormat)return async function(e){const{vkFormat:t}=e;if(void 0===fH[t])throw new Error("THREE.KTX2Loader: Unsupported vkFormat.");let i;2===e.supercompressionScheme&&(pH||(pH=new Promise((async e=>{const t=new hH;await t.init(),e(t)}))),i=await pH);const n=[];for(let o=0;o<e.levels.length;o++){const s=Math.max(1,e.pixelWidth>>o),r=Math.max(1,e.pixelHeight>>o),a=e.pixelDepth?Math.max(1,e.pixelDepth>>o):0,l=e.levels[o];let g,c;if(0===e.supercompressionScheme)g=l.levelData;else{if(2!==e.supercompressionScheme)throw new Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");g=i.decode(l.levelData,l.uncompressedByteLength)}c=bH[t]===K?new Float32Array(g.buffer,g.byteOffset,g.byteLength/Float32Array.BYTES_PER_ELEMENT):bH[t]===Y?new Uint16Array(g.buffer,g.byteOffset,g.byteLength/Uint16Array.BYTES_PER_ELEMENT):g,n.push({data:c,width:s,height:r,depth:a})}let s;if(CH.has(fH[t]))s=0===e.pixelDepth?new ya(n[0].data,e.pixelWidth,e.pixelHeight):new kt(n[0].data,e.pixelWidth,e.pixelHeight,e.pixelDepth);else{if(e.pixelDepth>0)throw new Error("THREE.KTX2Loader: Unsupported pixelDepth.");s=new $a(n,e.pixelWidth,e.pixelHeight)}return s.mipmaps=n,s.type=bH[t],s.format=fH[t],s.colorSpace=yH(e),s.needsUpdate=!0,Promise.resolve(s)}(i);const n=t,s=this.init().then((()=>this.workerPool.postMessage({type:"transcode",buffer:e,taskConfig:n},[e]))).then((e=>this._createTextureFrom(e.data,i)));return IH.set(e,{promise:s}),s}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),mH--,this}}AH.BasisFormat={ETC1S:0,UASTC_4x4:1},AH.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},AH.EngineFormat={RGBAFormat:U,RGBA_ASTC_4x4_Format:Ie,RGBA_BPTC_Format:Ge,RGBA_ETC2_EAC_Format:ue,RGBA_PVRTC_4BPPV1_Format:ge,RGBA_S3TC_DXT5_Format:re,RGB_ETC1_Format:de,RGB_ETC2_Format:he,RGB_PVRTC_4BPPV1_Format:ae,RGB_S3TC_DXT1_Format:ne},AH.BasisWorker=function(){let e,t,i;const n=_EngineFormat,s=_TranscoderFormat,o=_BasisFormat;self.addEventListener("message",(function(r){const d=r.data;switch(d.type){case"init":e=d.config,h=d.transcoderBinary,t=new Promise((e=>{i={wasmBinary:h,onRuntimeInitialized:e},BASIS(i)})).then((()=>{i.initializeBasis(),void 0===i.KTX2File&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")}));break;case"transcode":t.then((()=>{try{const{faces:t,buffers:r,width:h,height:u,hasAlpha:I,format:p,dfdFlags:m}=function(t){const r=new i.KTX2File(new Uint8Array(t));function d(){r.close(),r.delete()}if(!r.isValid())throw d(),new Error("THREE.KTX2Loader:\tInvalid or unsupported .ktx2 file");const h=r.isUASTC()?o.UASTC_4x4:o.ETC1S,u=r.getWidth(),I=r.getHeight(),p=r.getLayers()||1,m=r.getLevels(),A=r.getFaces(),C=r.getHasAlpha(),f=r.getDFDFlags(),{transcoderFormat:b,engineFormat:y}=function(t,i,r,c){let d,h;const u=t===o.ETC1S?a:l;for(let n=0;n<u.length;n++){const s=u[n];if(e[s.if]&&(s.basisFormat.includes(t)&&!(c&&s.transcoderFormat.length<2)&&(!s.needsPowerOfTwo||g(i)&&g(r))))return d=s.transcoderFormat[c?1:0],h=s.engineFormat[c?1:0],{transcoderFormat:d,engineFormat:h}}return console.warn("THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32."),d=s.RGBA32,h=n.RGBAFormat,{transcoderFormat:d,engineFormat:h}}(h,u,I,C);if(!u||!I||!m)throw d(),new Error("THREE.KTX2Loader:\tInvalid texture");if(!r.startTranscoding())throw d(),new Error("THREE.KTX2Loader: .startTranscoding failed");const _=[],v=[];for(let e=0;e<A;e++){const t=[];for(let i=0;i<m;i++){const n=[];let s,o;for(let t=0;t<p;t++){const a=r.getImageLevelInfo(i,t,e);0!==e||0!==i||0!==t||a.origWidth%4==0&&a.origHeight%4==0||console.warn("THREE.KTX2Loader: ETC1S and UASTC textures should use multiple-of-four dimensions."),m>1?(s=a.origWidth,o=a.origHeight):(s=a.width,o=a.height);const l=new Uint8Array(r.getImageTranscodedSizeInBytes(i,t,0,b));if(!r.transcodeImage(l,i,t,e,b,0,-1,-1))throw d(),new Error("THREE.KTX2Loader: .transcodeImage failed.");n.push(l)}const a=c(n);t.push({data:a,width:s,height:o}),v.push(a.buffer)}_.push({mipmaps:t,width:u,height:I,format:y})}return d(),{faces:_,buffers:v,width:u,height:I,hasAlpha:C,format:y,dfdFlags:f}}(d.buffer);self.postMessage({type:"transcode",id:d.id,faces:t,width:h,height:u,hasAlpha:I,format:p,dfdFlags:m},r)}catch(t){console.error(t),self.postMessage({type:"error",id:d.id,error:t.message})}}))}var h}));const r=[{if:"astcSupported",basisFormat:[o.UASTC_4x4],transcoderFormat:[s.ASTC_4x4,s.ASTC_4x4],engineFormat:[n.RGBA_ASTC_4x4_Format,n.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[s.BC7_M5,s.BC7_M5],engineFormat:[n.RGBA_BPTC_Format,n.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[s.BC1,s.BC3],engineFormat:[n.RGB_S3TC_DXT1_Format,n.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[s.ETC1,s.ETC2],engineFormat:[n.RGB_ETC2_Format,n.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[s.ETC1],engineFormat:[n.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[s.PVRTC1_4_RGB,s.PVRTC1_4_RGBA],engineFormat:[n.RGB_PVRTC_4BPPV1_Format,n.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],a=r.sort((function(e,t){return e.priorityETC1S-t.priorityETC1S})),l=r.sort((function(e,t){return e.priorityUASTC-t.priorityUASTC}));function g(e){return e<=2||0==(e&e-1)&&0!==e}function c(e){if(1===e.length)return e[0];let t=0;for(let s=0;s<e.length;s++){t+=e[s].byteLength}const i=new Uint8Array(t);let n=0;for(let s=0;s<e.length;s++){const t=e[s];i.set(t,n),n+=t.byteLength}return i}};const CH=new Set([U,ee,q]),fH={109:U,97:U,37:U,43:U,103:ee,83:ee,16:ee,22:ee,100:q,76:q,15:q,9:q,166:Ce,165:Ce},bH={109:K,97:Y,37:F,43:F,103:K,83:Y,16:F,22:F,100:K,76:Y,15:F,9:F,166:F,165:F};function yH(e){const t=e.dataFormatDescriptor[0];return t.colorPrimaries===iH?t.transferFunction===eH?Ye:Pe:t.colorPrimaries===nH?t.transferFunction===eH?ke:Oe:(t.colorPrimaries===tH||console.warn(`THREE.KTX2Loader: Unsupported color primaries, "${t.colorPrimaries}"`),Ke)}const _H=new AH,vH=new oa;_H.detectSupport(vH),_H.setWorkerLimit=4,_H.setTranscoderPath(mm("assets/libs/basis/"));const xH=new class extends Fl{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,i,n){const s=new zl(this.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,(e=>{this.parse(e,t,n)}),i,n)}parse(e,t,i){this.decodeDracoFile(e,t,null,null,Ye).catch(i)}decodeDracoFile(e,t,i,n,s=Pe){const o={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:n||this.defaultAttributeTypes,useUniqueIDs:!!i,vertexColorSpace:s};return this.decodeGeometry(e,o).then(t)}decodeGeometry(e,t){const i=JSON.stringify(t);if(jX.has(e)){const t=jX.get(e);if(t.key===i)return t.promise;if(0===e.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let n;const s=this.workerNextTaskID++,o=e.byteLength,r=this._getWorker(s,o).then((i=>(n=i,new Promise(((i,o)=>{n._callbacks[s]={resolve:i,reject:o},n.postMessage({type:"decode",id:s,taskConfig:t,buffer:e},[e])}))))).then((e=>this._createGeometry(e.geometry)));return r.catch((()=>!0)).then((()=>{n&&s&&this._releaseTask(n,s)})),jX.set(e,{key:i,promise:r}),r}_createGeometry(e){const t=new Fn;e.index&&t.setIndex(new Bn(e.index.array,1));for(let i=0;i<e.attributes.length;i++){const n=e.attributes[i],s=n.name,o=n.array,r=n.itemSize,a=new Bn(o,r);"color"===s&&(this._assignVertexColorSpace(a,n.vertexColorSpace),a.normalized=o instanceof Float32Array==!1),t.setAttribute(s,a)}return t}_assignVertexColorSpace(e,t){if(t!==Ye)return;const i=new In;for(let n=0,s=e.count;n<s;n++)i.fromBufferAttribute(e,n).convertSRGBToLinear(),e.setXYZ(n,i.r,i.g,i.b)}_loadLibrary(e,t){const i=new zl(this.manager);return i.setPath(this.decoderPath),i.setResponseType(t),i.setWithCredentials(this.withCredentials),new Promise(((t,n)=>{i.load(e,t,void 0,n)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then((t=>{const i=t[0];e||(this.decoderConfig.wasmBinary=t[1]);const n=qX.toString(),s=["/* draco decoder */",i,"","/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([s]))})),this.decoderPending}_getWorker(e,t){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const e=new Worker(this.workerSourceURL);e._callbacks={},e._taskCosts={},e._taskLoad=0,e.postMessage({type:"init",decoderConfig:this.decoderConfig}),e.onmessage=function(t){const i=t.data;switch(i.type){case"decode":e._callbacks[i.id].resolve(i);break;case"error":e._callbacks[i.id].reject(i);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+i.type+'"')}},this.workerPool.push(e)}else this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const i=this.workerPool[this.workerPool.length-1];return i._taskCosts[e]=t,i._taskLoad+=t,i}))}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map((e=>e._taskLoad)))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,""!==this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),this}};function BH(){const e=new eX;return e.setMeshoptDecoder(JX),e.setDRACOLoader(xH),e.setKTX2Loader(_H),e}xH.setDecoderPath(mm("assets/libs/draco/gltf/")),xH.setDecoderConfig({type:"js"});let wH=BH();function SH(e){const t=new Map,i=new Map,n=e.clone();return GH(e,n,(function(e,n){t.set(n,e),i.set(e,n)})),n.traverse((function(e){if(!e.isSkinnedMesh)return;const n=e,s=t.get(e),o=s.skeleton.bones;n.skeleton=s.skeleton.clone(),n.bindMatrix.copy(s.bindMatrix),n.skeleton.bones=o.map((function(e){return i.get(e)})),n.bind(n.skeleton,n.bindMatrix)})),n}function GH(e,t,i){i(e,t);for(let n=0;n<e.children.length;n++)GH(e.children[n],t.children[n],i)}const MH=new sE;MH.generate=async e=>new Promise(((t,i)=>{wH.load(e,(e=>{t(e)}),null,i)}));const RH=new Qt,TH=new Qt,ZH=new Ei;new Bi;const VH=new Zx({max:100,onRemove(e){e.destroyModel()}});const WH=Object.freeze({UNLOADED:0,LOADING:1,PROCESSING:2,READY:3,EXPIRED:4,FAILED:5});function EH(e,t,i){const n=e[t];e[t]=e[i],e[i]=n}const NH=/^data:/i;const FH=/^blob:/i;const XH={numberOfAttemptedRequests:0,numberOfActiveRequests:0,numberOfCancelledRequests:0,numberOfCancelledActiveRequests:0,numberOfFailedRequests:0,numberOfActiveRequestsEver:0,lastNumberOfActiveRequests:0};let HH=20;const zH=new class{constructor(e){this._comparator=e.comparator,this._array=[],this._length=0,this._maximumLength=void 0}reserve(e){e=lm(e,this._length),this._array.length=e}heapify(e){e=lm(e,0);const t=this._length,i=this._comparator,n=this._array;let s=-1,o=!0;for(;o;){const r=2*(e+1),a=r-1;s=a<t&&i(n[a],n[e])<0?a:e,r<t&&i(n[r],n[s])<0&&(s=r),s!==e?(EH(n,s,e),e=s):o=!1}}resort(){const e=this._length;for(let t=Math.ceil(e/2);t>=0;--t)this.heapify(t)}insert(e){const t=this._array,i=this._comparator,n=this._maximumLength;let s,o=this._length++;for(o<t.length?t[o]=e:t.push(e);0!==o;){const e=Math.floor((o-1)/2);if(!(i(t[o],t[e])<0))break;EH(t,o,e),o=e}return am(n)&&this._length>n&&(s=t[n],this._length=n),s}pop(e){if(e=lm(e,0),0===this._length)return;const t=this._array,i=t[e];return EH(t,e,--this._length),this.heapify(e),t[this._length]=void 0,i}get length(){return this._length}get internalArray(){return this._array}get maximumLength(){return this._maximumLength}set maximumLength(e){const t=this._length;if(e<t){const i=this._array;for(let n=e;n<t;++n)i[n]=void 0;this._length=e,i.length=e}this._maximumLength=e}get comparator(){return this._comparator}}({comparator:function(e,t){return e.priority-t.priority}});zH.maximumLength=HH,zH.reserve(HH);const LH="undefined"!=typeof document?new sm(document.location.href):new sm,DH=[];let KH={};const YH=class{static get statistics(){return XH}static get priorityHeapLength(){return HH}static set priorityHeapLength(e){if(e<HH)for(;zH.length>e;){kH(zH.pop())}HH=e,zH.maximumLength=e,zH.reserve(e)}static update(){let e,t,i=0;const n=DH.length;for(e=0;e<n;e++)t=DH[e],t.cancelled&&kH(t),t.state===SF.ACTIVE?i>0&&(DH[e-i]=t):++i;DH.length-=i;const s=zH.internalArray,o=zH.length;for(e=0;e<o;++e)OH(s[e]);zH.resort();const r=Math.max(YH.maximumRequests-DH.length,0);let a=0;for(;a<r&&zH.length>0;)t=zH.pop(),t.cancelled?kH(t):!t.throttleByServer||YH.serverHasOpenSlots(t.serverKey)?(QH(t),++a):kH(t)}static request(e){if(t=e.url,NH.test(t)||function(e){return FH.test(e)}(e.url))return e.state=SF.RECEIVED,e.requestFunction();var t;if(++XH.numberOfAttemptedRequests,am(e.serverKey)||(e.serverKey=YH.getServerKey(e.url)),!e.throttle)return QH(e);if(DH.length>=YH.maximumRequests)return;OH(e);const i=zH.insert(e);if(am(i)){if(i===e)return;kH(i)}return UH(e)}};let PH=YH;function kH(e){const t=e.state===SF.ACTIVE;if(e.state=SF.CANCELLED,++XH.numberOfCancelledRequests,am(e.deferred)){const t=e.deferred;e.deferred=void 0,t.reject()}t&&(--XH.numberOfActiveRequests,--KH[e.serverKey],++XH.numberOfCancelledActiveRequests),am(e.cancelFunction)&&e.cancelFunction()}function OH(e){am(e.priorityFunction)&&(e.priority=e.priorityFunction())}function UH(e){return e.state===SF.UNISSUED&&(e.state=SF.ISSUED,e.deferred=HW()),e.deferred.promise}function QH(e){const t=UH(e);return e.state=SF.ACTIVE,DH.push(e),++XH.numberOfActiveRequests,++XH.numberOfActiveRequestsEver,++KH[e.serverKey],e.requestFunction().then(function(e){return function(t){if(e.state===SF.CANCELLED)return;const i=e.deferred;--XH.numberOfActiveRequests,--KH[e.serverKey],e.state=SF.RECEIVED,e.deferred=void 0,i.resolve(t)}}(e)).catch(function(e){return function(t){e.state!==SF.CANCELLED&&(++XH.numberOfFailedRequests,--XH.numberOfActiveRequests,--KH[e.serverKey],e.state=SF.FAILED,e.deferred.reject(t))}}(e)),t}__publicField(PH,"maximumRequests",50),__publicField(PH,"maximumRequestsPerServer",18),__publicField(PH,"requestsByServer",{}),__publicField(PH,"throttleRequests",!0),__publicField(PH,"debugShowStatistics",!1),__publicField(PH,"getServerKey",(function(e){let t=new sm(e);""===t.scheme()&&(t=t.absoluteTo(LH),t.normalize());let i=t.authority();/:/.test(i)||(i=`${i}:${"https"===t.scheme()?"443":"80"}`);return am(KH[i])||(KH[i]=0),i})),__publicField(PH,"serverHasOpenSlots",(function(e,t){t=lm(t,1);const i=lm(YH.requestsByServer[e],YH.maximumRequestsPerServer);return KH[e]+t<=i})),__publicField(PH,"heapHasOpenSlots",(function(e){return zH.length+e<=HH}));class JH{constructor(e,t,i){this.item=e,this.previous=t,this.next=i}}function jH(e,t){am(t.previous)&&am(t.next)?(t.previous.next=t.next,t.next.previous=t.previous):am(t.previous)?(t.previous.next=void 0,e.tail=t.previous):am(t.next)?(t.next.previous=void 0,e.head=t.next):(e.head=void 0,e.tail=void 0),t.next=void 0,t.previous=void 0}class qH{constructor(){this.head=void 0,this.tail=void 0,this._length=0}add(e){const t=new JH(e,this.tail,void 0);return am(this.tail)?(this.tail.next=t,this.tail=t):(this.head=t,this.tail=t),++this._length,t}remove(e){am(e)&&(jH(this,e),--this._length)}splice(e,t){if(e===t)return;jH(this,t);const i=e.next;e.next=t,this.tail===e?this.tail=t:i.previous=t,t.next=i,t.previous=e}get length(){return this._length}}class $H{constructor(){this._list=new qH,this._sentinel=this._list.add(),this.trimTiles=!1}reset(){this._list.splice(this._list.tail,this._sentinel)}touch(e){const t=e.cacheNode;am(t)&&this._list.splice(this._sentinel,t)}add(e){am(e.cachedNode)||(e.cacheNode=this._list.add(e))}unloadTile(e,t,i){const n=t.cacheNode;am(n)&&(this._list.remove(n),t.cacheNode=void 0,i(e,t))}unloadTiles(e,t){const i=this._trimTiles;this._trimTiles=!1;const n=this._list,s=this._sentinel;let o=n.head;for(;o!==s&&(e.totalMemoryUsageInBytes>e.cacheBytes||i);){const i=o.item;o=o.next,this.unloadTile(e,i,t)}}trim(){this._trimTiles=!0}}class ez{constructor(){this.selected=0,this.visited=0,this.numberOfAttemptedRequests=0,this.numberOfPendingRequests=0,this.numberOfTilesProcessing=0,this.numberOfTilesWithContentReady=0,this.numberOfTilesTotal=0,this.numberOfLoadedTilesTotal=0,this.numberOfTilesCulledWithChildrenUnion=0,this.totalByteLength=0}clear(){this.selected=0,this.visited=0,this.numberOfAttemptedRequests=0,this.numberOfTilesCulledWithChildrenUnion=0}incrementSelectionCounts(){tz(this,this.content,!1,!1)}incrementLoadCounts(e){tz(this,e,!1,!0)}decrementLoadCounts(e){tz(this,e,!0,!0)}}function tz(e,t,i,n){const s=t.innerContents;t.pointsLength,t.trianglesLength,t.featuresLength;const o=t.byteSize;if(n&&(e.totalByteLength+=i?-o:o),am(s)){const t=s.length;for(let o=0;o<t;++o)tz(e,s[o],i,n)}}function iz(e){const t=Object.keys(e);return 0===t.length?"":1!==t.length||am(e[t[0]])?`?${function(e){if(!am(e))throw new Error("obj is required.");let t="";for(const i in e)if(e.hasOwnProperty(i)){const n=e[i],s=`${encodeURIComponent(i)}=`;if(Array.isArray(n))for(let e=0,i=n.length;e<i;++e)t+=`${s+encodeURIComponent(n[e])}&`;else t+=`${s+encodeURIComponent(n)}&`}return t=t.slice(0,-1),t}(e)}`:`?${t[0]}`}function nz(e,t,i){i=lm(i,!1);const n={},s=am(e),o=am(t);let r,a,l;if(s)for(r in e)e.hasOwnProperty(r)&&(a=e[r],o&&i&&"object"==typeof a&&t.hasOwnProperty(r)?(l=t[r],n[r]="object"==typeof l?nz(a,l,i):a):n[r]=a);if(o)for(r in t)t.hasOwnProperty(r)&&!n.hasOwnProperty(r)&&(l=t[r],n[r]=l);return n}function sz(e,t){if(null===e||"object"!=typeof e)return e;t=lm(t,!1);const i=new e.constructor;for(const n in e)if(e.hasOwnProperty(n)){let s=e[n];t&&(s=sz(s,t)),i[n]=s}return i}function oz(e,t,i){if(!i)return nz(e,t);const n=sz(e,!0);for(const s in t)if(t.hasOwnProperty(s)){let e=n[s];const i=t[s];am(e)?(Array.isArray(e)||(e=n[s]=[e]),n[s]=e.concat(i)):n[s]=Array.isArray(i)?i.slice():i}return n}function rz(e){return 0===e.length?{}:-1===e.indexOf("=")?{[e]:void 0}:function(e){const t={};if(""===e)return t;const i=e.replace(/\+/g,"%20").split(/[&;]/);for(let n=0,s=i.length;n<s;++n){const e=i[n].split("="),s=decodeURIComponent(e[0]);let o=e[1];o=am(o)?decodeURIComponent(o):"";const r=t[s];"string"==typeof r?t[s]=[r,o]:Array.isArray(r)?r.push(o):t[s]=o}return t}(e)}class az{constructor(e){"string"==typeof(e=lm(e,{}))&&(e={url:e}),this._url=void 0,this._templateValues=lm(e.templateValues,{}),this._queryParameters=lm(e.queryParameters,{}),this.headers=lm(e.headers,{}),this.request=lm(e.request,new GF),this.proxy=e.proxy,this.retryCallback=e.retryCallback,this.retryAttempts=lm(e.retryAttempts,0),this._retryCount=0;lm(e.parseUrl,!0)?this.parseUrl(e.url,!0,!0):this._url=e.url}parseUrl(e,t,i,n){let s=new sm(e);const o=rz(s.query());this._queryParameters=t?oz(o,this.queryParameters,i):o,s.search(""),s.fragment(""),am(n)&&""===s.scheme()&&(s=s.absoluteTo(Am(n))),this._url=s.toString()}clone(e){return am(e)?(e._url=this._url,e._queryParameters=sz(this._queryParameters),e._templateValues=sz(this._templateValues),e.headers=sz(this.headers),e.proxy=this.proxy,e.retryCallback=this.retryCallback,e.retryAttempts=this.retryAttempts,e._retryCount=0,e.request=this.request.clone(),e):new az({url:this._url,queryParameters:this.queryParameters,templateValues:this.templateValues,headers:this.headers,proxy:this.proxy,retryCallback:this.retryCallback,retryAttempts:this.retryAttempts,request:this.request.clone(),parseUrl:!1,credits:am(this.credits)?this.credits.slice():void 0})}setQueryParameters(e,t){this._queryParameters=t?oz(this._queryParameters,e,!1):oz(e,this._queryParameters,!1)}getDerivedResource(e){const t=this.clone();if(t._retryCount=0,am(e.url)){const i=lm(e.preserveQueryParameters,!1);t.parseUrl(e.url,!0,i,this._url)}return am(e.queryParameters)&&(t._queryParameters=nz(e.queryParameters,t.queryParameters)),am(e.templateValues)&&(t._templateValues=nz(e.templateValues,t.templateValues)),am(e.headers)&&(t.headers=nz(e.headers,t.headers)),am(e.proxy)&&(t.proxy=e.proxy),am(e.request)&&(t.request=e.request),am(e.retryCallback)&&(t.retryCallback=e.retryCallback),am(e.retryAttempts)&&(t.retryAttempts=e.retryAttempts),t}fetchJson(){const e=this.fetch({responseType:"text",headers:{Accept:"application/json,*/*;q=0.01"}});if(am(e))return e.then((function(e){if(am(e))return JSON.parse(e)}))}fetchArrayBuffer(){return this.fetch({responseType:"arraybuffer"})}fetch(e){return(e=lm(e,{})).method="GET",this._makeRequest(e)}retryOnError(e){const t=this.retryCallback;if("function"!=typeof t||this._retryCount>=this.retryAttempts)return Promise.resolve(!1);const i=this;return Promise.resolve(t(this,e)).then((function(e){return++i._retryCount,e}))}_makeRequest(e){const t=this;!function(e){if(e.state===SF.ISSUED||e.state===SF.ACTIVE)throw new Error("The Resource is already being fetched.");e.state=SF.UNISSUED,e.deferred=void 0}(t.request);const i=t.request,n=t.url;i.url=n,i.requestFunction=function(){const s=e.responseType,o=nz(e.headers,t.headers),r=e.overrideMimeType,a=e.method,l=e.data,g=HW(),c=az._Implementations.loadWithXhr(n,s,a,l,o,g,r);return am(c)&&am(c.abort)&&(i.cancelFunction=function(){c.abort()}),g.promise};const s=PH.request(i);if(am(s))return s.then((function(e){return i.cancelFunction=void 0,e})).catch((function(n){return i.cancelFunction=void 0,i.state!==SF.FAILED?Promise.reject(n):t.retryOnError(n).then((function(s){return s?(i.state=SF.UNISSUED,i.deferred=void 0,t.fetch(e)):Promise.reject(n)}))}))}getUrlComponent(e,t){if(this.isDataUri)return this._url;let i=this._url;e&&(i=`${i}${iz(this.queryParameters||{})}`),i=i.replace(/%7B/g,"{").replace(/%7D/g,"}");const n=this._templateValues;return Object.keys(n).length>0&&(i=i.replace(/{(.*?)}/g,(function(e,t){const i=n[t];return am(i)?encodeURIComponent(i):e}))),t&&am(this.proxy)&&(i=this.proxy.getURL(i)),i}getBaseUri(e){return fm(this.getUrlComponent(e),e)}static createIfNeeded(e){return e instanceof az?e.getDerivedResource({request:e.request}):"string"!=typeof e?e:new az({url:e})}static fetchArrayBuffer(e){return new az(e).fetchArrayBuffer()}get url(){return this.getUrlComponent(!0,!0)}set url(e){this.parseUrl(e,!1,!1)}get queryParameters(){return this._queryParameters}get extension(){return Cm(this._url)}}const lz=/^data:(.*?)(;base64)?,(.*)$/;function gz(e,t){const i=decodeURIComponent(t);return e?atob(i):i}function cz(e,t){const i=gz(e,t),n=new ArrayBuffer(i.length),s=new Uint8Array(n);for(let o=0;o<i.length;o++)s[o]=i.charCodeAt(o);return n}const dz="undefined"==typeof XMLHttpRequest;az._Implementations={},az._Implementations.loadWithXhr=function(e,t,i,n,s,o,r){const a=lz.exec(e);if(null!==a)return void o.resolve(function(e,t){t=lm(t,"");const i=e[1],n=!!e[2],s=e[3];let o,r;switch(t){case"":case"text":return gz(n,s);case"arraybuffer":return cz(n,s);case"blob":return o=cz(n,s),new Blob([o],{type:i});case"document":return r=new DOMParser,r.parseFromString(gz(n,s),i);case"json":return JSON.parse(gz(n,s));default:throw new Error(`Unhandled responseType: ${t}`)}}(a,t));if(dz)return void function(e,t,i,n,s,o,r){fetch(e,{method:i,headers:s}).then((async e=>{if(!e.ok)return e.headers.forEach(((e,t)=>{})),void o.reject();switch(t){case"text":o.resolve(e.text());break;case"json":o.resolve(e.json());break;default:o.resolve(new Uint8Array(await e.arrayBuffer()).buffer)}})).catch((()=>{}))}(e,t,i,0,s,o);const l=new XMLHttpRequest;if(l.open(i,e,!0),am(r)&&am(l.overrideMimeType)&&l.overrideMimeType(r),am(s))for(const c in s)s.hasOwnProperty(c)&&l.setRequestHeader(c,s[c]);am(t)&&(l.responseType=t);let g=!1;return"string"==typeof e&&(g=0===e.indexOf("file://")||"undefined"!=typeof window&&"file://"===window.location.origin),l.onload=function(){if((l.status<200||l.status>=300)&&(!g||0!==l.status))return void o.reject();const e=l.response,n=l.responseType;if("HEAD"===i||"OPTIONS"===i){const e=l.getAllResponseHeaders().trim().split(/[\r\n]+/),t={};return e.forEach((function(e){const i=e.split(": "),n=i.shift();t[n]=i.join(": ")})),void o.resolve(t)}if(204===l.status)o.resolve(void 0);else if(!am(e)||am(t)&&n!==t)if("json"===t&&"string"==typeof e)try{o.resolve(JSON.parse(e))}catch(pb){o.reject(pb)}else(""===n||"document"===n)&&am(l.responseXML)&&l.responseXML.hasChildNodes()?o.resolve(l.responseXML):""!==n&&"text"!==n||!am(l.responseText)?o.reject(new Error("Invalid XMLHttpRequest response type.")):o.resolve(l.responseText);else o.resolve(e)},l.onerror=function(e){},l.send(n),l};const hz={},uz=new Qt,Iz={NOT_COMPUTED:-1,USE_OPTIMIZATION:1,SKIP_OPTIMIZATION:0};function pz(e){const t=e.boundingVolume;let i;return t.obb?i=t.obb:t.regionObb&&(i=t.regionObb),i}hz.checkChildrenWithinParent=function(e){const t=e.children,i=t.length,n=pz(e);if(n){e._optimChildrenWithinParent=Iz.USE_OPTIMIZATION;for(let s=0;s<i;++s){const i=pz(t[s]);if(!i){e._optimChildrenWithinParent=Iz.SKIP_OPTIMIZATION;break}const o=uz.subVectors(i.center,n.center),r=o.length();o.divideScalar(r);const a=n.halfAxes,l=Math.abs(a[0]*o.x)+Math.abs(a[1]*o.y)+Math.abs(a[2]*o.z)+Math.abs(a[3]*o.x)+Math.abs(a[4]*o.y)+Math.abs(a[5]*o.z)+Math.abs(a[6]*o.x)+Math.abs(a[7]*o.y)+Math.abs(a[8]*o.z),g=i.halfAxes;if(l<=Math.abs(g[0]*o.x)+Math.abs(g[1]*o.y)+Math.abs(g[2]*o.z)+Math.abs(g[3]*o.x)+Math.abs(g[4]*o.y)+Math.abs(g[5]*o.z)+Math.abs(g[6]*o.x)+Math.abs(g[7]*o.y)+Math.abs(g[8]*o.z)+r){e._optimChildrenWithinParent=Iz.SKIP_OPTIMIZATION;break}}}return e._optimChildrenWithinParent===Iz.USE_OPTIMIZATION};const mz=new yt;class Az extends ys{constructor(){super(),this.points=Array(8).fill().map((()=>new Qt))}setFromProjectionMatrix(e,t){super.setFromProjectionMatrix(e,t),this.calculateFrustumPoints()}calculateFrustumPoints(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach(((e,i)=>{!function(e,t,i,n){const s=mz.set(e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z,i.normal.x,i.normal.y,i.normal.z);n.set(-e.constant,-t.constant,-i.constant),n.applyMatrix3(s.invert())}(e[0],e[1],e[2],t[i])}))}}function Cz(e,t){this._tileset=e,this._tile=t,this.featurePropertiesDirty=!1}Object.defineProperties(Cz.prototype,{featuresLength:{get:function(){return 0}},pointsLength:{get:function(){return 0}},trianglesLength:{get:function(){return 0}},geometryByteLength:{get:function(){return 0}},texturesByteLength:{get:function(){return 0}},batchTableByteLength:{get:function(){return 0}},innerContents:{get:function(){}},ready:{get:function(){return!0}},tileset:{get:function(){return this._tileset}},tile:{get:function(){return this._tile}},url:{get:function(){}},metadata:{get:function(){},set:function(e){throw new Error("Empty3DTileContent cannot have content metadata")}},batchTable:{get:function(){}},group:{get:function(){},set:function(e){throw new Error("Empty3DTileContent cannot have group metadata")}}}),Cz.prototype.hasProperty=function(e,t){return!1},Cz.prototype.getFeature=function(e){},Cz.prototype.applyDebugSettings=function(e,t){},Cz.prototype.applyStyle=function(e){},Cz.prototype.update=function(e,t){},Cz.prototype.pick=function(e,t,i){},Cz.prototype.isDestroyed=function(){return!1},Cz.prototype.destroy=function(){return tG(this)};const fz={BATCHED_3D_MODEL:"b3dm",INSTANCED_3D_MODEL:"i3dm",COMPOSITE:"cmpt",POINT_CLOUD:"pnts",VECTOR:"vctr",GEOMETRY:"geom",GLTF:"gltf",GLTF_BINARY:"glb",IMPLICIT_SUBTREE:"subt",IMPLICIT_SUBTREE_JSON:"subtreeJson",EXTERNAL_TILESET:"externalTileset",MULTIPLE_CONTENT:"multipleContent",GEOJSON:"geoJson",VOXEL_BINARY:"voxl",VOXEL_JSON:"voxelJson",isBinaryFormat:function(e){switch(e){case fz.BATCHED_3D_MODEL:case fz.INSTANCED_3D_MODEL:case fz.COMPOSITE:case fz.POINT_CLOUD:case fz.VECTOR:case fz.GEOMETRY:case fz.IMPLICIT_SUBTREE:case fz.VOXEL_BINARY:case fz.GLTF_BINARY:return!0;default:return!1}}},bz=Object.freeze(fz);class yz{constructor(e,t,i){this.isTileset3DTileContent=!0,this._tileset=e,this._tile=t,this._resource=i,this.featurePropertiesDirty=null,this._metadata=void 0,this._group=void 0,this._ready=!1}static fromJson(e,t,i,n){const s=new yz(e,t,i);return s._tileset.loadTileset(s._resource,n,s._tile),s._ready=!0,s}hasProperty(e,t){return!1}getFeature(e){}applyDebugSettings(){}applyStyle(e){}update(e,t){}isDestroyed(){return!1}destroy(){return tG(this)}get featuresLength(){return 0}get pointsLength(){return 0}get trianglesLength(){return 0}get geometryByteLength(){return 0}get texturesByteLength(){return 0}get batchTableByteLength(){return 0}get innerContents(){}get ready(){return this._ready}get tileset(){return this._tileset}get tile(){return this._tile}get url(){return this._resource.getUrlComponent(!0)}get batchTable(){}get metadata(){return this._metadata}set metadata(e){this._metadata=e}get group(){return this._group}set group(e){this._group=e}}const _z=new TextDecoder;function vz(e){return _z.decode(e)}function xz(e,t,i,n,s,o){let r,a;switch(n){case"SCALAR":r=1;break;case"VEC2":r=2;break;case"VEC3":r=3;break;case"VEC4":r=4;break;default:throw new Error(`FeatureTable : Feature type not provided for "${o}".`)}const l=i*r;switch(s){case"BYTE":a=new Int8Array(e,t,l);break;case"UNSIGNED_BYTE":a=new Uint8Array(e,t,l);break;case"SHORT":a=new Int16Array(e,t,l);break;case"UNSIGNED_SHORT":a=new Uint16Array(e,t,l);break;case"INT":a=new Int32Array(e,t,l);break;case"UNSIGNED_INT":a=new Uint32Array(e,t,l);break;case"FLOAT":a=new Float32Array(e,t,l);break;case"DOUBLE":a=new Float64Array(e,t,l);break;default:throw new Error(`FeatureTable : Feature component type not provided for "${o}".`)}return a}class Bz{constructor(e,t,i,n){this.buffer=e,this.binOffset=t+i,this.binLength=n;let s=null;if(0!==i){const n=new Uint8Array(e,t,i);s=JSON.parse(vz(n))}else s={};this.header=s}getKeys(){return Object.keys(this.header)}getData(e,t,i=null,n=null){const s=this.header;if(!(e in s))return null;const o=s[e];if(!(o instanceof Object))return o;if(Array.isArray(o))return o;const{buffer:r,binOffset:a,binLength:l}=this,g=o.byteOffset||0,c=o.type||n,d=o.componentType||i;if("type"in o&&n&&o.type!==n)throw new Error("FeatureTable: Specified type does not match expected type.");const h=a+g,u=xz(r,h,t,c,d,e);if(h+u.byteLength>a+l)throw new Error("FeatureTable: Feature data read outside binary body length.");return u}getBuffer(e,t){const{buffer:i,binOffset:n}=this;return i.slice(n+e,n+e+t)}}class wz{constructor(e){var t;this.batchTable=e;const i=e.header.extensions["3DTILES_batch_table_hierarchy"];this.classes=i.classes;for(const s of this.classes){const e=s.instances;for(const t in e)e.hasOwnProperty(t)&&(s.instances[t]=this._parseProperty(e[t],s.length,t))}if(this.instancesLength=i.instancesLength,this.classIds=this._parseProperty(i.classIds,this.instancesLength,"classIds"),i.parentCounts?this.parentCounts=this._parseProperty(i.parentCounts,this.instancesLength,"parentCounts"):this.parentCounts=new Array(this.instancesLength).fill(1),i.parentIds){const e=this.parentCounts.reduce(((e,t)=>e+t),0);this.parentIds=this._parseProperty(i.parentIds,e,"parentIds")}else this.parentIds=null;this.instancesIds=[];const n={};for(const s of this.classIds)n[s]=null!=(t=n[s])?t:0,this.instancesIds.push(n[s]),n[s]++}_parseProperty(e,t,i){if(Array.isArray(e))return e;const{buffer:n,binOffset:s}=this.batchTable;return xz(n,s+e.byteOffset,t,"SCALAR",e.componentType||"UNSIGNED_SHORT",i)}getDataFromId(e,t={}){const i=this.parentCounts[e];if(this.parentIds&&i>0){let n=0;for(let t=0;t<e;t++)n+=this.parentCounts[t];for(let s=0;s<i;s++){const i=this.parentIds[n+s];i!==e&&this.getDataFromId(i,t)}}const n=this.classIds[e],s=this.classes[n].instances,o=this.classes[n].name,r=this.instancesIds[e];for(const a in s)s.hasOwnProperty(a)&&(t[o]=t[o]||{},t[o][a]=s[a][r]);return t}}class Sz extends Bz{constructor(e,t,i,n,s){super(e,i,n,s),this.batchSize=t,this.extensions={};const o=this.header.extensions;o&&o["3DTILES_batch_table_hierarchy"]&&(this.extensions["3DTILES_batch_table_hierarchy"]=new wz(this))}getData(e,t=null,i=null){return console.warn("BatchTable: BatchTable.getData is deprecated. Use BatchTable.getDataFromId instead."),super.getData(e,this.batchSize,t,i)}getDataFromId(e,t={}){if(e<0||e>=this.batchSize)throw new Error(`BatchTable: id value "${e}" out of bounds for "${this.batchSize}" features number.`);for(const i of this.getKeys())"extensions"!==i&&(t[i]=super.getData(i,this.batchSize)[e]);for(const i in this.extensions)if(this.extensions.hasOwnProperty(i)){const n=this.extensions[i];n.getDataFromId instanceof Function&&(t[i]=t[i]||{},n.getDataFromId(e,t[i]))}return t}}class Gz{constructor(){this.fetchOptions={},this.workingPath=""}load(e){return console.warn('Loader: "load" function has been deprecated in favor of "loadAsync".'),this.loadAsync(e)}loadAsync(e){return fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error(`Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()})).then((t=>(""===this.workingPath&&(this.workingPath=this.workingPathForURL(e)),this.parse(t))))}resolveExternalURL(e){return/^[^\\/]/.test(e)?this.workingPath+"/"+e:e}workingPathForURL(e){const t=e.split(/[\\/]/g);t.pop();return t.join("/")+"/"}parse(e){throw new Error("LoaderBase: Parse not implemented.")}}class Mz extends Gz{parse(e){const t=new DataView(e),i=t.getUint32(4,!0);console.assert(1===i);const n=t.getUint32(8,!0);console.assert(n===e.byteLength);const s=t.getUint32(12,!0),o=t.getUint32(16,!0),r=t.getUint32(20,!0),a=t.getUint32(24,!0),l=e.slice(28,28+s+o),g=new Bz(l,0,s,o),c=28+s+o,d=e.slice(c,c+r+a),h=new Sz(d,g.getData("BATCH_LENGTH"),0,r,a),u=c+r+a;return{version:i,featureTable:g,batchTable:h,glbBytes:new Uint8Array(e,u,n-u)}}}class Rz extends Fl{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new Nz(e)})),this.register((function(e){return new Yz(e)})),this.register((function(e){return new Pz(e)})),this.register((function(e){return new kz(e)})),this.register((function(e){return new Xz(e)})),this.register((function(e){return new Hz(e)})),this.register((function(e){return new zz(e)})),this.register((function(e){return new Lz(e)})),this.register((function(e){return new Ez(e)})),this.register((function(e){return new Dz(e)})),this.register((function(e){return new Fz(e)})),this.register((function(e){return new Kz(e)})),this.register((function(e){return new Vz(e)})),this.register((function(e){return new Oz(e)})),this.register((function(e){return new Uz(e)}))}load(e,t,i,n){const s=this;let o;o=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:sg.extractUrlBase(e),this.manager.itemStart(e);const r=function(t){n?n(t):console.error(t),s.manager.itemError(e),s.manager.itemEnd(e)},a=new zl(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,(function(i){try{s.parse(i,o,(function(i){t(i),s.manager.itemEnd(e)}),r)}catch(pb){r(pb)}}),i,r)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,i,n){let s;const o={},r={},a=new TextDecoder;if("string"==typeof e)s=JSON.parse(e);else if(e instanceof ArrayBuffer){if(a.decode(new Uint8Array(e,0,4))===Qz){try{o[Zz.KHR_BINARY_GLTF]=new qz(e)}catch(g){return void(n&&n(g))}s=JSON.parse(o[Zz.KHR_BINARY_GLTF].content)}else s=JSON.parse(a.decode(e))}else s=e;if(void 0===s.asset||s.asset.version[0]<2)return void(n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new vL(s,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let c=0;c<this.pluginCallbacks.length;c++){const e=this.pluginCallbacks[c](l);e.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),r[e.name]=e,o[e.name]=!0}if(s.extensionsUsed)for(let c=0;c<s.extensionsUsed.length;++c){const e=s.extensionsUsed[c],t=s.extensionsRequired||[];switch(e){case Zz.KHR_MATERIALS_UNLIT:o[e]=new Wz;break;case Zz.KHR_DRACO_MESH_COMPRESSION:o[e]=new $z(s,this.dracoLoader);break;case Zz.KHR_TEXTURE_TRANSFORM:o[e]=new eL;break;case Zz.KHR_MESH_QUANTIZATION:o[e]=new tL;break;default:t.indexOf(e)>=0&&void 0===r[e]&&console.warn('THREE.GLTFLoader: Unknown extension "'+e+'".')}}l.setExtensions(o),l.setPlugins(r),l.parse(i,n)}parseAsync(e,t){const i=this;return new Promise((function(n,s){i.parse(e,t,n,s)}))}}function Tz(){let e={};return{get:function(t){return e[t]},add:function(t,i){e[t]=i},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const Zz={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class Vz{constructor(e){this.parser=e,this.name=Zz.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let i=0,n=t.length;i<n;i++){const n=t[i];n.extensions&&n.extensions[this.name]&&void 0!==n.extensions[this.name].light&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,i="light:"+e;let n=t.cache.get(i);if(n)return n;const s=t.json,o=((s.extensions&&s.extensions[this.name]||{}).lights||[])[e];let r;const a=new In(16777215);void 0!==o.color&&a.setRGB(o.color[0],o.color[1],o.color[2],Pe);const l=void 0!==o.range?o.range:0;switch(o.type){case"directional":r=new ig(a),r.target.position.set(0,0,-1),r.add(r.target);break;case"point":r=new eg(a),r.distance=l;break;case"spot":r=new Ql(a),r.distance=l,o.spot=o.spot||{},o.spot.innerConeAngle=void 0!==o.spot.innerConeAngle?o.spot.innerConeAngle:0,o.spot.outerConeAngle=void 0!==o.spot.outerConeAngle?o.spot.outerConeAngle:Math.PI/4,r.angle=o.spot.outerConeAngle,r.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,r.target.position.set(0,0,-1),r.add(r.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+o.type)}return r.position.set(0,0,0),r.decay=2,AL(r,o),void 0!==o.intensity&&(r.intensity=o.intensity),r.name=t.createUniqueName(o.name||"light_"+e),n=Promise.resolve(r),t.cache.add(i,n),n}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,i=this.parser,n=i.json.nodes[e],s=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===s?null:this._loadLight(s).then((function(e){return i._getNodeRef(t.cache,s,e)}))}}class Wz{constructor(){this.name=Zz.KHR_MATERIALS_UNLIT}getMaterialType(){return Cn}extendParams(e,t,i){const n=[];e.color=new In(1,1,1),e.opacity=1;const s=t.pbrMetallicRoughness;if(s){if(Array.isArray(s.baseColorFactor)){const t=s.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],Pe),e.opacity=t[3]}void 0!==s.baseColorTexture&&n.push(i.assignTexture(e,"map",s.baseColorTexture,Ye))}return Promise.all(n)}}class Ez{constructor(e){this.parser=e,this.name=Zz.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name].emissiveStrength;return void 0!==n&&(t.emissiveIntensity=n),Promise.resolve()}}class Nz{constructor(e){this.parser=e,this.name=Zz.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?pl:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];if(void 0!==o.clearcoatFactor&&(t.clearcoat=o.clearcoatFactor),void 0!==o.clearcoatTexture&&s.push(i.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),void 0!==o.clearcoatRoughnessFactor&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),void 0!==o.clearcoatRoughnessTexture&&s.push(i.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),void 0!==o.clearcoatNormalTexture&&(s.push(i.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),void 0!==o.clearcoatNormalTexture.scale)){const e=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new bt(e,e)}return Promise.all(s)}}class Fz{constructor(e){this.parser=e,this.name=Zz.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?pl:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return void 0!==o.iridescenceFactor&&(t.iridescence=o.iridescenceFactor),void 0!==o.iridescenceTexture&&s.push(i.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),void 0!==o.iridescenceIor&&(t.iridescenceIOR=o.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==o.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),void 0!==o.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),void 0!==o.iridescenceThicknessTexture&&s.push(i.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(s)}}class Xz{constructor(e){this.parser=e,this.name=Zz.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?pl:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[];t.sheenColor=new In(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=n.extensions[this.name];if(void 0!==o.sheenColorFactor){const e=o.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],Pe)}return void 0!==o.sheenRoughnessFactor&&(t.sheenRoughness=o.sheenRoughnessFactor),void 0!==o.sheenColorTexture&&s.push(i.assignTexture(t,"sheenColorMap",o.sheenColorTexture,Ye)),void 0!==o.sheenRoughnessTexture&&s.push(i.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(s)}}class Hz{constructor(e){this.parser=e,this.name=Zz.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?pl:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return void 0!==o.transmissionFactor&&(t.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&s.push(i.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(s)}}class zz{constructor(e){this.parser=e,this.name=Zz.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?pl:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];t.thickness=void 0!==o.thicknessFactor?o.thicknessFactor:0,void 0!==o.thicknessTexture&&s.push(i.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const r=o.attenuationColor||[1,1,1];return t.attenuationColor=(new In).setRGB(r[0],r[1],r[2],Pe),Promise.all(s)}}class Lz{constructor(e){this.parser=e,this.name=Zz.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?pl:null}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name];return t.ior=void 0!==n.ior?n.ior:1.5,Promise.resolve()}}class Dz{constructor(e){this.parser=e,this.name=Zz.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?pl:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];t.specularIntensity=void 0!==o.specularFactor?o.specularFactor:1,void 0!==o.specularTexture&&s.push(i.assignTexture(t,"specularIntensityMap",o.specularTexture));const r=o.specularColorFactor||[1,1,1];return t.specularColor=(new In).setRGB(r[0],r[1],r[2],Pe),void 0!==o.specularColorTexture&&s.push(i.assignTexture(t,"specularColorMap",o.specularColorTexture,Ye)),Promise.all(s)}}class Kz{constructor(e){this.parser=e,this.name=Zz.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?pl:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return void 0!==o.anisotropyStrength&&(t.anisotropy=o.anisotropyStrength),void 0!==o.anisotropyRotation&&(t.anisotropyRotation=o.anisotropyRotation),void 0!==o.anisotropyTexture&&s.push(i.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(s)}}class Yz{constructor(e){this.parser=e,this.name=Zz.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,i=t.json,n=i.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const s=n.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,s.source,o)}}class Pz{constructor(e){this.parser=e,this.name=Zz.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,i=this.parser,n=i.json,s=n.textures[e];if(!s.extensions||!s.extensions[t])return null;const o=s.extensions[t],r=n.images[o.source];let a=i.textureLoader;if(r.uri){const e=i.options.manager.getHandler(r.uri);null!==e&&(a=e)}return this.detectSupport().then((function(s){if(s)return i.loadTextureImage(e,o.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return i.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class kz{constructor(e){this.parser=e,this.name=Zz.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,i=this.parser,n=i.json,s=n.textures[e];if(!s.extensions||!s.extensions[t])return null;const o=s.extensions[t],r=n.images[o.source];let a=i.textureLoader;if(r.uri){const e=i.options.manager.getHandler(r.uri);null!==e&&(a=e)}return this.detectSupport().then((function(s){if(s)return i.loadTextureImage(e,o.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return i.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class Oz{constructor(e){this.name=Zz.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,i=t.bufferViews[e];if(i.extensions&&i.extensions[this.name]){const e=i.extensions[this.name],n=this.parser.getDependency("buffer",e.buffer),s=this.parser.options.meshoptDecoder;if(!s||!s.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then((function(t){const i=e.byteOffset||0,n=e.byteLength||0,o=e.count,r=e.byteStride,a=new Uint8Array(t,i,n);return s.decodeGltfBufferAsync?s.decodeGltfBufferAsync(o,r,a,e.mode,e.filter).then((function(e){return e.buffer})):s.ready.then((function(){const t=new ArrayBuffer(o*r);return s.decodeGltfBuffer(new Uint8Array(t),o,r,a,e.mode,e.filter),t}))}))}return null}}class Uz{constructor(e){this.name=Zz.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,i=t.nodes[e];if(!i.extensions||!i.extensions[this.name]||void 0===i.mesh)return null;const n=t.meshes[i.mesh];for(const a of n.primitives)if(a.mode!==oL.TRIANGLES&&a.mode!==oL.TRIANGLE_STRIP&&a.mode!==oL.TRIANGLE_FAN&&void 0!==a.mode)return null;const s=i.extensions[this.name].attributes,o=[],r={};for(const a in s)o.push(this.parser.getDependency("accessor",s[a]).then((e=>(r[a]=e,r[a]))));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then((e=>{const t=e.pop(),i=t.isGroup?t.children:[t],n=e[0].count,s=[];for(const o of i){const e=new Bi,t=new Qt,i=new Ut,a=new Qt(1,1,1),l=new Va(o.geometry,o.material,n);for(let s=0;s<n;s++)r.TRANSLATION&&t.fromBufferAttribute(r.TRANSLATION,s),r.ROTATION&&i.fromBufferAttribute(r.ROTATION,s),r.SCALE&&a.fromBufferAttribute(r.SCALE,s),l.setMatrixAt(s,e.compose(t,i,a));for(const n in r)if("_COLOR_0"===n){const e=r[n];l.instanceColor=new Ba(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==n&&"ROTATION"!==n&&"SCALE"!==n&&o.geometry.setAttribute(n,r[n]);Ji.prototype.copy.call(l,o),this.parser.assignFinalMaterial(l),s.push(l)}return t.isGroup?(t.clear(),t.add(...s),t):s[0]})))}}const Qz="glTF",Jz=1313821514,jz=5130562;class qz{constructor(e){this.name=Zz.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),i=new TextDecoder;if(this.header={magic:i.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Qz)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-12,s=new DataView(e,12);let o=0;for(;o<n;){const t=s.getUint32(o,!0);o+=4;const n=s.getUint32(o,!0);if(o+=4,n===Jz){const n=new Uint8Array(e,12+o,t);this.content=i.decode(n)}else if(n===jz){const i=12+o;this.body=e.slice(i,i+t)}o+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class $z{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Zz.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const i=this.json,n=this.dracoLoader,s=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,r={},a={},l={};for(const g in o){const e=cL[g]||g.toLowerCase();r[e]=o[g]}for(const g in e.attributes){const t=cL[g]||g.toLowerCase();if(void 0!==o[g]){const n=i.accessors[e.attributes[g]],s=rL[n.componentType];l[t]=s.name,a[t]=!0===n.normalized}}return t.getDependency("bufferView",s).then((function(e){return new Promise((function(t){n.decodeDracoFile(e,(function(e){for(const t in e.attributes){const i=e.attributes[t],n=a[t];void 0!==n&&(i.normalized=n)}t(e)}),r,l)}))}))}}class eL{constructor(){this.name=Zz.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class tL{constructor(){this.name=Zz.KHR_MESH_QUANTIZATION}}class iL extends bl{constructor(e,t,i,n){super(e,t,i,n)}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,n=this.valueSize,s=e*n*3+n;for(let o=0;o!==n;o++)t[o]=i[s+o];return t}interpolate_(e,t,i,n){const s=this.resultBuffer,o=this.sampleValues,r=this.valueSize,a=2*r,l=3*r,g=n-t,c=(i-t)/g,d=c*c,h=d*c,u=e*l,I=u-l,p=-2*h+3*d,m=h-d,A=1-p,C=m-d+c;for(let f=0;f!==r;f++){const e=o[I+f+r],t=o[I+f+a]*g,i=o[u+f+r],n=o[u+f]*g;s[f]=A*e+C*t+p*i+m*n}return s}}const nL=new Ut;class sL extends iL{interpolate_(e,t,i,n){const s=super.interpolate_(e,t,i,n);return nL.fromArray(s).normalize().toArray(s),s}}const oL={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},rL={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},aL={9728:T,9729:W,9984:Z,9985:E,9986:V,9987:N},lL={33071:M,33648:R,10497:G},gL={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},cL={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},dL={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},hL={CUBICSPLINE:void 0,LINEAR:Ee,STEP:We},uL="OPAQUE",IL="MASK",pL="BLEND";function mL(e,t,i){for(const n in i.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=i.extensions[n])}function AL(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function CL(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let i=0,n=t.weights.length;i<n;i++)e.morphTargetInfluences[i]=t.weights[i];if(t.extras&&Array.isArray(t.extras.targetNames)){const i=t.extras.targetNames;if(e.morphTargetInfluences.length===i.length){e.morphTargetDictionary={};for(let t=0,n=i.length;t<n;t++)e.morphTargetDictionary[i[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function fL(e){let t;const i=e.extensions&&e.extensions[Zz.KHR_DRACO_MESH_COMPRESSION];if(t=i?"draco:"+i.bufferView+":"+i.indices+":"+bL(i.attributes):e.indices+":"+bL(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,s=e.targets.length;n<s;n++)t+=":"+bL(e.targets[n]);return t}function bL(e){let t="";const i=Object.keys(e).sort();for(let n=0,s=i.length;n<s;n++)t+=i[n]+":"+e[i[n]]+";";return t}function yL(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const _L=new Bi;class vL{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Tz,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let i=!1,n=!1,s=-1;"undefined"!=typeof navigator&&(i=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),n=navigator.userAgent.indexOf("Firefox")>-1,s=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||i||n&&s<98?this.textureLoader=new Dl(this.options.manager):this.textureLoader=new rg(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new zl(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const i=this,n=this.json,s=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])})).then((function(t){const o={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:i,userData:{}};return mL(s,o,n),AL(o,n),Promise.all(i._invokeAll((function(e){return e.afterRoot&&e.afterRoot(o)}))).then((function(){e(o)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[];for(let n=0,s=t.length;n<s;n++){const i=t[n].joints;for(let t=0,n=i.length;t<n;t++)e[i[t]].isBone=!0}for(let n=0,s=e.length;n<s;n++){const t=e[n];void 0!==t.mesh&&(this._addNodeRef(this.meshCache,t.mesh),void 0!==t.skin&&(i[t.mesh].isSkinnedMesh=!0)),void 0!==t.camera&&this._addNodeRef(this.cameraCache,t.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,i){if(e.refs[t]<=1)return i;const n=i.clone(),s=(e,t)=>{const i=this.associations.get(e);null!=i&&this.associations.set(t,i);for(const[n,o]of e.children.entries())s(o,t.children[n])};return s(i,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let i=0;i<t.length;i++){const n=e(t[i]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const i=[];for(let n=0;n<t.length;n++){const s=e(t[n]);s&&i.push(s)}return i}getDependency(e,t){const i=e+":"+t;let n=this.cache.get(i);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne((function(e){return e.loadNode&&e.loadNode(t)}));break;case"mesh":n=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":n=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne((function(i){return i!=this&&i.getDependency&&i.getDependency(e,t)})),!n)throw new Error("Unknown type: "+e)}this.cache.add(i,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const i=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map((function(t,n){return i.getDependency(e,n)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],i=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[Zz.KHR_BINARY_GLTF].body);const n=this.options;return new Promise((function(e,s){i.load(sg.resolveURL(t.uri,n.path),e,void 0,(function(){s(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const i=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+i)}))}loadAccessor(e){const t=this,i=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse){const e=gL[n.type],t=rL[n.componentType],i=!0===n.normalized,s=new t(n.count*e);return Promise.resolve(new Bn(s,e,i))}const s=[];return void 0!==n.bufferView?s.push(this.getDependency("bufferView",n.bufferView)):s.push(null),void 0!==n.sparse&&(s.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),s.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(s).then((function(e){const s=e[0],o=gL[n.type],r=rL[n.componentType],a=r.BYTES_PER_ELEMENT,l=a*o,g=n.byteOffset||0,c=void 0!==n.bufferView?i.bufferViews[n.bufferView].byteStride:void 0,d=!0===n.normalized;let h,u;if(c&&c!==l){const e=Math.floor(g/c),i="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+e+":"+n.count;let l=t.cache.get(i);l||(h=new r(s,e*c,n.count*c/a),l=new aa(h,c/a),t.cache.add(i,l)),u=new ga(l,o,g%c/a,d)}else h=null===s?new r(n.count*o):new r(s,g,n.count*o),u=new Bn(h,o,d);if(void 0!==n.sparse){const t=gL.SCALAR,i=rL[n.sparse.indices.componentType],a=n.sparse.indices.byteOffset||0,l=n.sparse.values.byteOffset||0,g=new i(e[1],a,n.sparse.count*t),c=new r(e[2],l,n.sparse.count*o);null!==s&&(u=new Bn(u.array.slice(),u.itemSize,u.normalized));for(let e=0,n=g.length;e<n;e++){const t=g[e];if(u.setX(t,c[e*o]),o>=2&&u.setY(t,c[e*o+1]),o>=3&&u.setZ(t,c[e*o+2]),o>=4&&u.setW(t,c[e*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return u}))}loadTexture(e){const t=this.json,i=this.options,n=t.textures[e].source,s=t.images[n];let o=this.textureLoader;if(s.uri){const e=i.manager.getHandler(s.uri);null!==e&&(o=e)}return this.loadTextureImage(e,n,o)}loadTextureImage(e,t,i){const n=this,s=this.json,o=s.textures[e],r=s.images[t],a=(r.uri||r.bufferView)+":"+o.sampler;if(this.textureCache[a])return this.textureCache[a];const l=this.loadImageSource(t,i).then((function(t){t.flipY=!1,t.name=o.name||r.name||"",""===t.name&&"string"==typeof r.uri&&!1===r.uri.startsWith("data:image/")&&(t.name=r.uri);const i=(s.samplers||{})[o.sampler]||{};return t.magFilter=aL[i.magFilter]||W,t.minFilter=aL[i.minFilter]||N,t.wrapS=lL[i.wrapS]||G,t.wrapT=lL[i.wrapT]||G,n.associations.set(t,{textures:e}),t})).catch((function(){return null}));return this.textureCache[a]=l,l}loadImageSource(e,t){const i=this,n=this.json,s=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const o=n.images[e],r=self.URL||self.webkitURL;let a=o.uri||"",l=!1;if(void 0!==o.bufferView)a=i.getDependency("bufferView",o.bufferView).then((function(e){l=!0;const t=new Blob([e],{type:o.mimeType});return a=r.createObjectURL(t),a}));else if(void 0===o.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const g=Promise.resolve(a).then((function(e){return new Promise((function(i,n){let o=i;!0===t.isImageBitmapLoader&&(o=function(e){const t=new Lt(e);t.needsUpdate=!0,i(t)}),t.load(sg.resolveURL(e,s.path),o,void 0,n)}))})).then((function(e){var t;return!0===l&&r.revokeObjectURL(a),e.userData.mimeType=o.mimeType||((t=o.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e}));return this.sourceCache[e]=g,g}assignTexture(e,t,i,n){const s=this;return this.getDependency("texture",i.index).then((function(o){if(!o)return null;if(void 0!==i.texCoord&&i.texCoord>0&&((o=o.clone()).channel=i.texCoord),s.extensions[Zz.KHR_TEXTURE_TRANSFORM]){const e=void 0!==i.extensions?i.extensions[Zz.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=s.associations.get(o);o=s.extensions[Zz.KHR_TEXTURE_TRANSFORM].extendTexture(o,e),s.associations.set(o,t)}}return void 0!==n&&(o.colorSpace=n),e[t]=o,o}))}assignFinalMaterial(e){const t=e.geometry;let i=e.material;const n=void 0===t.attributes.tangent,s=void 0!==t.attributes.color,o=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+i.uuid;let t=this.cache.get(e);t||(t=new Pa,An.prototype.copy.call(t,i),t.color.copy(i.color),t.map=i.map,t.sizeAttenuation=!1,this.cache.add(e,t)),i=t}else if(e.isLine){const e="LineBasicMaterial:"+i.uuid;let t=this.cache.get(e);t||(t=new Wa,An.prototype.copy.call(t,i),t.color.copy(i.color),t.map=i.map,this.cache.add(e,t)),i=t}if(n||s||o){let e="ClonedMaterial:"+i.uuid+":";n&&(e+="derivative-tangents:"),s&&(e+="vertex-colors:"),o&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=i.clone(),s&&(t.vertexColors=!0),o&&(t.flatShading=!0),n&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(i))),i=t}e.material=i}getMaterialType(){return Il}loadMaterial(e){const t=this,i=this.json,n=this.extensions,s=i.materials[e];let o;const r={},a=[];if((s.extensions||{})[Zz.KHR_MATERIALS_UNLIT]){const e=n[Zz.KHR_MATERIALS_UNLIT];o=e.getMaterialType(),a.push(e.extendParams(r,s,t))}else{const i=s.pbrMetallicRoughness||{};if(r.color=new In(1,1,1),r.opacity=1,Array.isArray(i.baseColorFactor)){const e=i.baseColorFactor;r.color.setRGB(e[0],e[1],e[2],Pe),r.opacity=e[3]}void 0!==i.baseColorTexture&&a.push(t.assignTexture(r,"map",i.baseColorTexture,Ye)),r.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,r.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(a.push(t.assignTexture(r,"metalnessMap",i.metallicRoughnessTexture)),a.push(t.assignTexture(r,"roughnessMap",i.metallicRoughnessTexture))),o=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),a.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,r)}))))}!0===s.doubleSided&&(r.side=2);const l=s.alphaMode||uL;if(l===pL?(r.transparent=!0,r.depthWrite=!1):(r.transparent=!1,l===IL&&(r.alphaTest=void 0!==s.alphaCutoff?s.alphaCutoff:.5)),void 0!==s.normalTexture&&o!==Cn&&(a.push(t.assignTexture(r,"normalMap",s.normalTexture)),r.normalScale=new bt(1,1),void 0!==s.normalTexture.scale)){const e=s.normalTexture.scale;r.normalScale.set(e,e)}if(void 0!==s.occlusionTexture&&o!==Cn&&(a.push(t.assignTexture(r,"aoMap",s.occlusionTexture)),void 0!==s.occlusionTexture.strength&&(r.aoMapIntensity=s.occlusionTexture.strength)),void 0!==s.emissiveFactor&&o!==Cn){const e=s.emissiveFactor;r.emissive=(new In).setRGB(e[0],e[1],e[2],Pe)}return void 0!==s.emissiveTexture&&o!==Cn&&a.push(t.assignTexture(r,"emissiveMap",s.emissiveTexture,Ye)),Promise.all(a).then((function(){const i=new o(r);return s.name&&(i.name=s.name),AL(i,s),t.associations.set(i,{materials:e}),s.extensions&&mL(n,i,s),i}))}createUniqueName(e){const t=mg.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,i=this.extensions,n=this.primitiveCache;function s(e){return i[Zz.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(i){return xL(i,e,t)}))}const o=[];for(let r=0,a=e.length;r<a;r++){const i=e[r],a=fL(i),l=n[a];if(l)o.push(l.promise);else{let e;e=i.extensions&&i.extensions[Zz.KHR_DRACO_MESH_COMPRESSION]?s(i):xL(new Fn,i,t),n[a]={primitive:i,promise:e},o.push(e)}}return Promise.all(o)}loadMesh(e){const t=this,i=this.json,n=this.extensions,s=i.meshes[e],o=s.primitives,r=[];for(let l=0,c=o.length;l<c;l++){const e=void 0===o[l].material?(void 0===(a=this.cache).DefaultMaterial&&(a.DefaultMaterial=new Il({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:g})),a.DefaultMaterial):this.getDependency("material",o[l].material);r.push(e)}var a;return r.push(t.loadGeometries(o)),Promise.all(r).then((function(i){const r=i.slice(0,i.length-1),a=i[i.length-1],l=[];for(let c=0,d=a.length;c<d;c++){const i=a[c],g=o[c];let d;const h=r[c];if(g.mode===oL.TRIANGLES||g.mode===oL.TRIANGLE_STRIP||g.mode===oL.TRIANGLE_FAN||void 0===g.mode)d=!0===s.isSkinnedMesh?new fa(i,h):new ts(i,h),!0===d.isSkinnedMesh&&d.normalizeSkinWeights(),g.mode===oL.TRIANGLE_STRIP?d.geometry=KN(d.geometry,1):g.mode===oL.TRIANGLE_FAN&&(d.geometry=KN(d.geometry,2));else if(g.mode===oL.LINES)d=new Ka(i,h);else if(g.mode===oL.LINE_STRIP)d=new za(i,h);else if(g.mode===oL.LINE_LOOP)d=new Ya(i,h);else{if(g.mode!==oL.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+g.mode);d=new Ja(i,h)}Object.keys(d.geometry.morphAttributes).length>0&&CL(d,s),d.name=t.createUniqueName(s.name||"mesh_"+e),AL(d,s),g.extensions&&mL(n,d,g),t.assignFinalMaterial(d),l.push(d)}for(let n=0,s=l.length;n<s;n++)t.associations.set(l[n],{meshes:e,primitives:n});if(1===l.length)return s.extensions&&mL(n,l[0],s),l[0];const g=new qr;s.extensions&&mL(n,g,s),t.associations.set(g,{meshes:e});for(let e=0,t=l.length;e<t;e++)g.add(l[e]);return g}))}loadCamera(e){let t;const i=this.json.cameras[e],n=i[i.type];if(n)return"perspective"===i.type?t=new cs(ft.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===i.type&&(t=new Es(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),AL(t,i),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],i=[];for(let n=0,s=t.joints.length;n<s;n++)i.push(this._loadNodeShallow(t.joints[n]));return void 0!==t.inverseBindMatrices?i.push(this.getDependency("accessor",t.inverseBindMatrices)):i.push(null),Promise.all(i).then((function(e){const i=e.pop(),n=e,s=[],o=[];for(let r=0,a=n.length;r<a;r++){const e=n[r];if(e){s.push(e);const t=new Bi;null!==i&&t.fromArray(i.array,16*r),o.push(t)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[r])}return new xa(s,o)}))}loadAnimation(e){const t=this.json,i=this,n=t.animations[e],s=n.name?n.name:"animation_"+e,o=[],r=[],a=[],l=[],g=[];for(let c=0,d=n.channels.length;c<d;c++){const e=n.channels[c],t=n.samplers[e.sampler],i=e.target,s=i.node,d=void 0!==n.parameters?n.parameters[t.input]:t.input,h=void 0!==n.parameters?n.parameters[t.output]:t.output;void 0!==i.node&&(o.push(this.getDependency("node",s)),r.push(this.getDependency("accessor",d)),a.push(this.getDependency("accessor",h)),l.push(t),g.push(i))}return Promise.all([Promise.all(o),Promise.all(r),Promise.all(a),Promise.all(l),Promise.all(g)]).then((function(e){const t=e[0],n=e[1],o=e[2],r=e[3],a=e[4],l=[];for(let s=0,g=t.length;s<g;s++){const e=t[s],g=n[s],c=o[s],d=r[s],h=a[s];if(void 0===e)continue;e.updateMatrix&&e.updateMatrix();const u=i._createAnimationTracks(e,g,c,d,h);if(u)for(let t=0;t<u.length;t++)l.push(u[t])}return new Zl(s,void 0,l)}))}createNodeMesh(e){const t=this.json,i=this,n=t.nodes[e];return void 0===n.mesh?null:i.getDependency("mesh",n.mesh).then((function(e){const t=i._getNodeRef(i.meshCache,n.mesh,e);return void 0!==n.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,i=n.weights.length;t<i;t++)e.morphTargetInfluences[t]=n.weights[t]})),t}))}loadNode(e){const t=this,i=this.json.nodes[e],n=t._loadNodeShallow(e),s=[],o=i.children||[];for(let a=0,l=o.length;a<l;a++)s.push(t.getDependency("node",o[a]));const r=void 0===i.skin?Promise.resolve(null):t.getDependency("skin",i.skin);return Promise.all([n,Promise.all(s),r]).then((function(e){const t=e[0],i=e[1],n=e[2];null!==n&&t.traverse((function(e){e.isSkinnedMesh&&e.bind(n,_L)}));for(let s=0,o=i.length;s<o;s++)t.add(i[s]);return t}))}_loadNodeShallow(e){const t=this.json,i=this.extensions,n=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const s=t.nodes[e],o=s.name?n.createUniqueName(s.name):"",r=[],a=n._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return a&&r.push(a),void 0!==s.camera&&r.push(n.getDependency("camera",s.camera).then((function(e){return n._getNodeRef(n.cameraCache,s.camera,e)}))),n._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){r.push(e)})),this.nodeCache[e]=Promise.all(r).then((function(t){let r;if(r=!0===s.isBone?new ba:t.length>1?new qr:1===t.length?t[0]:new Ji,r!==t[0])for(let e=0,i=t.length;e<i;e++)r.add(t[e]);if(s.name&&(r.userData.name=s.name,r.name=o),AL(r,s),s.extensions&&mL(i,r,s),void 0!==s.matrix){const e=new Bi;e.fromArray(s.matrix),r.applyMatrix4(e)}else void 0!==s.translation&&r.position.fromArray(s.translation),void 0!==s.rotation&&r.quaternion.fromArray(s.rotation),void 0!==s.scale&&r.scale.fromArray(s.scale);return n.associations.has(r)||n.associations.set(r,{}),n.associations.get(r).nodes=e,r})),this.nodeCache[e]}loadScene(e){const t=this.extensions,i=this.json.scenes[e],n=this,s=new qr;i.name&&(s.name=n.createUniqueName(i.name)),AL(s,i),i.extensions&&mL(t,s,i);const o=i.nodes||[],r=[];for(let a=0,l=o.length;a<l;a++)r.push(n.getDependency("node",o[a]));return Promise.all(r).then((function(e){for(let t=0,i=e.length;t<i;t++)s.add(e[t]);return n.associations=(e=>{const t=new Map;for(const[i,s]of n.associations)(i instanceof An||i instanceof Lt)&&t.set(i,s);return e.traverse((e=>{const i=n.associations.get(e);null!=i&&t.set(e,i)})),t})(s),s}))}_createAnimationTracks(e,t,i,n,s){const o=[],r=e.name?e.name:e.uuid,a=[];let l;switch(dL[s.path]===dL.weights?e.traverse((function(e){e.morphTargetInfluences&&a.push(e.name?e.name:e.uuid)})):a.push(r),dL[s.path]){case dL.weights:l=Sl;break;case dL.rotation:l=Ml;break;case dL.position:case dL.scale:l=Tl;break;default:if(1===i.itemSize)l=Sl;else l=Tl}const g=void 0!==n.interpolation?hL[n.interpolation]:Ee,c=this._getArrayFromAccessor(i);for(let d=0,h=a.length;d<h;d++){const e=new l(a[d]+"."+dL[s.path],t.array,c,g);"CUBICSPLINE"===n.interpolation&&this._createCubicSplineTrackInterpolant(e),o.push(e)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=yL(t.constructor),i=new Float32Array(t.length);for(let n=0,s=t.length;n<s;n++)i[n]=t[n]*e;t=i}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof Ml?sL:iL)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function xL(e,t,i){const n=t.attributes,s=[];function o(t,n){return i.getDependency("accessor",t).then((function(t){e.setAttribute(n,t)}))}for(const r in n){const t=cL[r]||r.toLowerCase();t in e.attributes||s.push(o(n[r],t))}if(void 0!==t.indices&&!e.index){const n=i.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));s.push(n)}return Zt.workingColorSpace!==Pe&&"COLOR_0"in n&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${Zt.workingColorSpace}" not supported.`),AL(e,t),function(e,t,i){const n=t.attributes,s=new qt;if(void 0===n.POSITION)return;{const e=i.json.accessors[n.POSITION],t=e.min,o=e.max;if(void 0===t||void 0===o)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(s.set(new Qt(t[0],t[1],t[2]),new Qt(o[0],o[1],o[2])),e.normalized){const t=yL(rL[e.componentType]);s.min.multiplyScalar(t),s.max.multiplyScalar(t)}}const o=t.targets;if(void 0!==o){const e=new Qt,t=new Qt;for(let n=0,s=o.length;n<s;n++){const s=o[n];if(void 0!==s.POSITION){const n=i.json.accessors[s.POSITION],o=n.min,r=n.max;if(void 0!==o&&void 0!==r){if(t.setX(Math.max(Math.abs(o[0]),Math.abs(r[0]))),t.setY(Math.max(Math.abs(o[1]),Math.abs(r[1]))),t.setZ(Math.max(Math.abs(o[2]),Math.abs(r[2]))),n.normalized){const e=yL(rL[n.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}s.expandByVector(e)}e.boundingBox=s;const r=new mi;s.getCenter(r.center),r.radius=s.min.distanceTo(s.max)/2,e.boundingSphere=r}(e,t,i),Promise.all(s).then((function(){return void 0!==t.targets?function(e,t,i){let n=!1,s=!1,o=!1;for(let g=0,c=t.length;g<c;g++){const e=t[g];if(void 0!==e.POSITION&&(n=!0),void 0!==e.NORMAL&&(s=!0),void 0!==e.COLOR_0&&(o=!0),n&&s&&o)break}if(!n&&!s&&!o)return Promise.resolve(e);const r=[],a=[],l=[];for(let g=0,c=t.length;g<c;g++){const c=t[g];if(n){const t=void 0!==c.POSITION?i.getDependency("accessor",c.POSITION):e.attributes.position;r.push(t)}if(s){const t=void 0!==c.NORMAL?i.getDependency("accessor",c.NORMAL):e.attributes.normal;a.push(t)}if(o){const t=void 0!==c.COLOR_0?i.getDependency("accessor",c.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(r),Promise.all(a),Promise.all(l)]).then((function(t){const i=t[0],r=t[1],a=t[2];return n&&(e.morphAttributes.position=i),s&&(e.morphAttributes.normal=r),o&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e}))}(e,t.targets,i):e}))}class BL extends Mz{constructor(e=Nl){super(),this.manager=e,this.adjustmentTransform=new Bi}parse(e){const t=super.parse(e),i=t.glbBytes.slice().buffer;return new Promise(((e,n)=>{const s=this.manager,o=this.fetchOptions,r=s.getHandler("path.gltf")||new Rz(s);"include"===o.credentials&&"cors"===o.mode&&r.setCrossOrigin("use-credentials"),"credentials"in o&&r.setWithCredentials("include"===o.credentials),o.headers&&r.setRequestHeader(o.headers);let a=this.workingPath;!/[\\/]$/.test(a)&&a.length&&(a+="/");const l=this.adjustmentTransform;r.parse(i,a,(i=>{const{batchTable:n,featureTable:s}=t,{scene:o}=i,r=s.getData("RTC_CENTER");r&&(o.position.x+=r[0],o.position.y+=r[1],o.position.z+=r[2]),i.scene.updateMatrix(),i.scene.matrix.multiply(l),i.scene.matrix.decompose(i.scene.position,i.scene.quaternion,i.scene.scale),i.batchTable=n,i.featureTable=s,o.batchTable=n,o.featureTable=s,e(i)}),n)}))}}class wL extends Gz{parse(e){const t=new DataView(e),i=t.getUint32(4,!0);console.assert(1===i);const n=t.getUint32(8,!0);console.assert(n===e.byteLength);const s=t.getUint32(12,!0),o=t.getUint32(16,!0),r=t.getUint32(20,!0),a=t.getUint32(24,!0),l=t.getUint32(28,!0),g=e.slice(32,32+s+o),c=new Bz(g,0,s,o),d=32+s+o,h=e.slice(d,d+r+a),u=new Sz(h,c.getData("INSTANCES_LENGTH"),0,r,a),I=d+r+a,p=new Uint8Array(e,I,n-I);let m=null,A=null;if(l)m=p,A=Promise.resolve();else{const e=this.resolveExternalURL(vz(p));A=fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()})).then((e=>{m=new Uint8Array(e)}))}return A.then((()=>({version:i,featureTable:c,batchTable:u,glbBytes:m})))}}const SL=new Qt,GL=new Qt,ML=new Qt,RL=new Qt,TL=new Ut,ZL=new Qt,VL=new Bi;class WL extends wL{constructor(e=Nl){super(),this.manager=e,this.adjustmentTransform=new Bi}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then((e=>{const{featureTable:t,batchTable:i}=e,n=e.glbBytes.slice().buffer;return new Promise(((e,s)=>{const o=this.fetchOptions,r=this.manager,a=r.getHandler("path.gltf")||new Rz(r);"include"===o.credentials&&"cors"===o.mode&&a.setCrossOrigin("use-credentials"),"credentials"in o&&a.setWithCredentials("include"===o.credentials),o.headers&&a.setRequestHeader(o.headers);let l=this.workingPath;/[\\/]$/.test(l)||(l+="/");const g=this.adjustmentTransform;a.parse(n,l,(n=>{const s=t.getData("INSTANCES_LENGTH"),o=t.getData("POSITION",s,"FLOAT","VEC3"),r=t.getData("NORMAL_UP",s,"FLOAT","VEC3"),a=t.getData("NORMAL_RIGHT",s,"FLOAT","VEC3"),l=t.getData("SCALE_NON_UNIFORM",s,"FLOAT","VEC3"),c=t.getData("SCALE",s,"FLOAT","SCALAR");["RTC_CENTER","QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","EAST_NORTH_UP","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach((e=>{e in t.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${e}" detected.`)}));const d=new Map,h=[];n.scene.traverse((e=>{if(e.isMesh){const{geometry:t,material:i}=e,n=new Va(t,i,s);n.position.copy(e.position),n.rotation.copy(e.rotation),n.scale.copy(e.scale),h.push(n),d.set(e,n)}}));const u=new Qt;for(let e=0;e<s;e++)u.x+=o[3*e+0]/s,u.y+=o[3*e+1]/s,u.z+=o[3*e+2]/s;d.forEach(((e,t)=>{const i=t.parent;i&&(i.remove(t),i.add(e),e.updateMatrixWorld(),e.position.copy(u).applyMatrix4(e.matrixWorld))}));for(let e=0;e<s;e++){RL.set(o[3*e+0]-u.x,o[3*e+1]-u.y,o[3*e+2]-u.z),r?(GL.set(r[3*e+0],r[3*e+1],r[3*e+2]),ML.set(a[3*e+0],a[3*e+1],a[3*e+2]),SL.crossVectors(ML,GL).normalize(),VL.makeBasis(ML,GL,SL),TL.setFromRotationMatrix(VL)):TL.set(0,0,0,1),c?ZL.setScalar(c[e]):l?ZL.set(l[3*e+0],l[3*e+1],l[3*e+2]):ZL.set(1,1,1),VL.compose(RL,TL,ZL).multiply(g);for(let t=0,i=h.length;t<i;t++){h[t].setMatrixAt(e,VL)}}n.batchTable=i,n.featureTable=t,n.scene.batchTable=i,n.scene.featureTable=t,e(n)}),s)}))}))}}class EL extends Gz{parse(e){const t=new DataView(e),i=t.getUint32(4,!0);console.assert(1===i);const n=t.getUint32(8,!0);console.assert(n===e.byteLength);const s=t.getUint32(12,!0),o=t.getUint32(16,!0),r=t.getUint32(20,!0),a=t.getUint32(24,!0),l=e.slice(28,28+s+o),g=new Bz(l,0,s,o),c=28+s+o,d=e.slice(c,c+r+a),h=new Sz(d,g.getData("BATCH_LENGTH")||g.getData("POINTS_LENGTH"),0,r,a);return Promise.resolve({version:i,featureTable:g,batchTable:h})}}const NL={RGB:"color",POSITION:"position"};class FL extends EL{constructor(e=Nl){super(),this.manager=e}parse(e){return super.parse(e).then((async e=>{const{featureTable:t,batchTable:i}=e,n=new Pa,s=t.header.extensions,o=new Qt;let r;if(s&&s["3DTILES_draco_point_compression"]){const{byteOffset:e,byteLength:i,properties:o}=s["3DTILES_draco_point_compression"],a=this.manager.getHandler("draco.drc");if(null==a)throw new Error("PNTSLoader: dracoLoader not available.");const l={};for(const t in o)if(t in NL&&t in o){l[NL[t]]=o[t]}const g={attributeIDs:l,attributeTypes:{position:"Float32Array",color:"Uint8Array"},useUniqueIDs:!0},c=t.getBuffer(e,i);r=await a.decodeGeometry(c,g),r.attributes.color&&(n.vertexColors=!0)}else{const e=t.getData("POINTS_LENGTH"),i=t.getData("POSITION",e,"FLOAT","VEC3"),s=t.getData("RGB",e,"UNSIGNED_BYTE","VEC3"),a=t.getData("RGBA",e,"UNSIGNED_BYTE","VEC4"),l=t.getData("RGB565",e,"UNSIGNED_SHORT","SCALAR"),g=t.getData("CONSTANT_RGBA",e,"UNSIGNED_BYTE","VEC4"),c=t.getData("POSITION_QUANTIZED",e,"UNSIGNED_SHORT","VEC3"),d=t.getData("QUANTIZED_VOLUME_SCALE",e,"FLOAT","VEC3"),h=t.getData("QUANTIZED_VOLUME_OFFSET",e,"FLOAT","VEC3");if(r=new Fn,c){const t=new Float32Array(3*e);for(let i=0;i<e;i++)for(let e=0;e<3;e++){const n=3*i+e;t[n]=c[n]/65535*d[e]}o.x=h[0],o.y=h[1],o.z=h[2],r.setAttribute("position",new Bn(t,3,!1))}else r.setAttribute("position",new Bn(i,3,!1));if(null!==a)r.setAttribute("color",new Bn(a,4,!0)),n.vertexColors=!0,n.transparent=!0,n.depthWrite=!1;else if(null!==s)r.setAttribute("color",new Bn(s,3,!0)),n.vertexColors=!0;else if(null!==l){const t=new Uint8Array(3*e);for(let i=0;i<e;i++){const e=Iy(l[i]);for(let n=0;n<3;n++){t[3*i+n]=e[n]}}r.setAttribute("color",new Bn(t,3,!0)),n.vertexColors=!0}else if(null!==g){const e=new In(g[0],g[1],g[2]);n.color=e;const t=g[3]/255;t<1&&(n.opacity=t,n.transparent=!0,n.depthWrite=!1)}}["BATCH_LENGTH","NORMAL","NORMAL_OCT16P"].forEach((e=>{e in t.header&&console.warn(`PNTSLoader: Unsupported FeatureTable feature "${e}" detected.`)}));const a=new Ja(r,n);a.position.copy(o),e.scene=a,e.scene.featureTable=t,e.scene.batchTable=i;const l=t.getData("RTC_CENTER");return l&&(e.scene.position.x+=l[0],e.scene.position.y+=l[1],e.scene.position.z+=l[2]),e}))}}function XL(e){let t;if(t=e instanceof DataView?e:new DataView(e),"{"===String.fromCharCode(t.getUint8(0)))return null;let i="";for(let n=0;n<4;n++)i+=String.fromCharCode(t.getUint8(n));return i}class HL extends Gz{parse(e){const t=new DataView(e),i=XL(t);console.assert("cmpt"===i,'CMPTLoader: The magic bytes equal "cmpt".');const n=t.getUint32(4,!0);console.assert(1===n,'CMPTLoader: The version listed in the header is "1".');const s=t.getUint32(8,!0);console.assert(s===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const o=t.getUint32(12,!0),r=[];let a=16;for(let l=0;l<o;l++){const t=new DataView(e,a,12),i=XL(t),n=t.getUint32(4,!0),s=t.getUint32(8,!0),o=new Uint8Array(e,a,s);r.push({type:i,buffer:o,version:n}),a+=s}return{version:n,tiles:r}}}class zL extends HL{constructor(e=Nl){super(),this.manager=e,this.adjustmentTransform=new Bi}parse(e){const t=super.parse(e),i=this.manager,n=this.adjustmentTransform,s=[];for(const o in t.tiles)if(t.tiles.hasOwnProperty(o)){const{type:e,buffer:r}=t.tiles[o];switch(e){case"b3dm":{const e=r.slice(),t=new BL(i);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions,t.adjustmentTransform.copy(n);const o=t.parse(e.buffer);s.push(o);break}case"pnts":{const e=r.slice(),t=new FL(i);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const n=t.parse(e.buffer);s.push(n);break}case"i3dm":{const e=r.slice(),t=new WL(i);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions,t.adjustmentTransform.copy(n);const o=t.parse(e.buffer);s.push(o);break}}}return Promise.all(s).then((e=>{const t=new qr;return e.forEach((e=>{t.add(e.scene)})),{tiles:e,scene:t}}))}}class LL extends Gz{constructor(e=Nl){super(),this.manager=e}parse(e){return new Promise(((t,i)=>{const n=this.manager,s=this.fetchOptions;let o=n.getHandler("path.gltf")||n.getHandler("path.glb");o||(o=new Rz(n)),"include"===s.credentials&&"cors"===s.mode&&o.setCrossOrigin("use-credentials"),"credentials"in s&&o.setWithCredentials("include"===s.credentials),s.headers&&o.setRequestHeader(s.headers);let r=o.resourcePath||o.path||this.workingPath;!/[\\/]$/.test(r)&&r.length&&(r+="/"),o.parse(e,r,(e=>{t(e)}),i)}))}}const DL={QUADTREE:"QUADTREE",OCTREE:"OCTREE",getBranchingFactor:function(e){switch(e){case DL.OCTREE:return 8;case DL.QUADTREE:return 4;default:throw new Error("subdivisionScheme is not a valid value.")}}};class KL{constructor(e){const t=e.lengthBits;let i=e.availableCount;const n=e.constant,s=e.bitstream;if(am(n))i=t;else{const n=Math.ceil(t/8);if(s.length!==n)throw new Error(`Availability bitstream must be exactly ${n} bytes long to store ${t} bits.\n                    Actual bitstream was ${s.length} bytes long.`);const o=lm(e.computeAvailableCountEnabled,!1);!am(i)&&o&&(i=function(e,t){let i=0;for(let n=0;n<t;n++){const t=n%8;i+=e[n>>3]>>t&1}return i}(s,t))}this._lengthBits=t,this._availableCount=i,this._constant=n,this._bitstream=s}getBit(e){if(am(this._constant))return this._constant;const t=e>>3,i=e%8;return 1==(this._bitstream[t]>>i&1)}get lengthBits(){return this._lengthBits}get availableCount(){return this._availableCount}}class YL{constructor(e){const t=(e=lm(e,{})).subtreeMetadata,i=e.class,n=am(t)?t.properties:{};this._class=i,this._properties=n,this._extras=t.extras,this._extensions=t.extensions}get class(){return this._class}get extras(){return this._extras}get extensions(){return this._extensions}hasProperty(e){return wF.hasProperty(e,this._properties,this._class)}hasPropertyBySemantic(e){return wF.hasPropertyBySemantic(e,this._properties,this._class)}getPropertyIds(e){return wF.getPropertyIds(this._properties,this._class,e)}getProperty(e){return wF.getProperty(e,this._properties,this._class)}setProperty(e,t){return wF.setProperty(e,t,this._properties,this._class)}getPropertyBySemantic(e){return wF.getPropertyBySemantic(e,this._properties,this._class)}setPropertyBySemantic(e,t){return wF.setPropertyBySemantic(e,t,this._properties,this._class)}}class PL{static getSchemaCacheKey(e){const{schema:t,resource:i}=e;return am(t)?`embedded-schema:${JSON.stringify(t)}`:`external-schema:${function(e){return Am(e.url)}(i)}`}}class kL{unload(){}process(){return!1}isDestroyed(){return!1}destroy(){return this.unload(),tG(this)}}const OL=Object.freeze({UNLOADED:0,LOADING:1,LOADED:2,PROCESSING:3,READY:4,FAILED:5});class UL extends kL{constructor(e){super(e);const t=(e=lm(e,{})).schema,i=e.resource,n=e.cacheKey;this._schema=am(t)?BF.fromJson(t):void 0,this._resource=i,this._cacheKey=n,this._state=OL.UNLOADED,this._promise=void 0}load(){return am(this._promise)?this._promise:am(this._schema)?(this._promise=Promise.resolve(this),this._promise):(this._promise=async function(e){const t=e._resource;e._state=OL.LOADING;try{const i=await t.fetchJson();if(e.isDestroyed())return;return e._schema=BF.fromJson(i),e._state=OL.READY,e}catch(i){if(e.isDestroyed())return;e._state=OL.FAILED;const n=`Failed to load schema: ${t.url}`;throw e.getError(n,i)}}(this),this._promise)}unload(){this._schema=void 0}get cacheKey(){return this._cacheKey}get schema(){return this._schema}}class QL extends kL{constructor(e){super();const t=(e=lm(e,{})).typedArray,i=e.resource,n=e.cacheKey;this._typedArray=t,this._resource=i,this._cacheKey=n,this._state=OL.UNLOADED,this._promise=void 0}get cacheKey(){return this._cacheKey}get typedArray(){return this._typedArray}async load(){return am(this._promise)?this._promise:am(this._typedArray)?(this._promise=Promise.resolve(this),this._promise):(this._promise=this.loadExternalBuffer(),this._promise)}unload(){this._typedArray=void 0}async loadExternalBuffer(){const e=this._resource;this._state=OL.LOADING;try{const t=await QL._fetchArrayBuffer(e);if(this.isDestroyed())return;return this._typedArray=new Uint8Array(t),this._state=OL.READY,this}catch(t){if(this.isDestroyed())return;this._state=OL.FAILED;const i=`Failed to load external buffer: ${e.url}`;throw this.getError(i,t)}}static _fetchArrayBuffer(e){return e.fetchArrayBuffer()}}function JL(e){this.referenceCount=1,this.resourceLoader=e,this._statisticsPromise=void 0}const jL=class{static get(e){const t=jL.cacheEntries[e];if(am(t))return++t.referenceCount,t.resourceLoader}static add(e){const t=e.cacheKey;return jL.cacheEntries[t]=new JL(e),e}static unload(e){const t=e.cacheKey,i=jL.cacheEntries[t];--i.referenceCount,0===i.referenceCount&&(e.destroy(),delete jL.cacheEntries[t])}static getSchemaLoader(e){e=lm(e,{});const{schema:t,resource:i}=e,n=PL.getSchemaCacheKey({schema:t,resource:i});let s=jL.get(n);return am(s)?s:(s=new UL({schema:t,resource:i,cacheKey:n}),jL.add(s))}static getExternalBufferLoader(e){e=lm(e,{});const{resource:t}=e,i=PL.getExternalBufferCacheKey({resource:t});let n=jL.get(i);return am(n)?n:(n=new QL({resource:t,cacheKey:i}),jL.add(n))}};let qL=jL;__publicField(qL,"cacheEntries",{});class $L{constructor(e){const t=(e=lm(e,{})).metadataTable,i=e.class,n=e.entityId,s=e.propertyTableJson;this._class=i,this._metadataTable=t,this._entityId=n,this._extensions=s.extensions,this._extras=s.extras}get class(){return this._class}get extras(){return this._extras}get extensions(){return this._extensions}hasProperty(e){return this._metadataTable.hasProperty(e)}hasPropertyBySemantic(e){return this._metadataTable.hasPropertyBySemantic(e)}getPropertyIds(e){return this._metadataTable.getPropertyIds(e)}getProperty(e){return this._metadataTable.getProperty(this._entityId,e)}setProperty(e,t){return this._metadataTable.setProperty(this._entityId,e,t)}getPropertyBySemantic(e){return this._metadataTable.getPropertyBySemantic(this._entityId,e)}setPropertyBySemantic(e,t){return this._metadataTable.setPropertyBySemantic(this._entityId,e,t)}}class eD{constructor(e,t,i){this._resource=e,this._subtreeJson=void 0,this._bufferLoader=void 0,this._tileAvailability=void 0,this._contentAvailabilityBitstreams=[],this._childSubtreeAvailability=void 0,this._implicitCoordinates=i,this._subtreeLevels=t.subtreeLevels,this._subdivisionScheme=t.subdivisionScheme,this._branchingFactor=t.branchingFactor,this._metadata=void 0,this._tileMetadataTable=void 0,this._tilePropertyTableJson=void 0,this._contentMetadataTables=[],this._contentPropertyTableJsons=[],this._tileJumpBuffer=void 0,this._contentJumpBuffers=[],this._ready=!1}get ready(){return this._ready}get metadata(){return this._metadata}get tileMetadataTable(){return this._tileMetadataTable}get tilePropertyTableJson(){return this._tilePropertyTableJson}get contentMetadataTables(){return this._contentMetadataTables}get contentPropertyTableJsons(){return this._contentPropertyTableJsons}get implicitCoordinates(){return this._implicitCoordinates}tileIsAvailableAtIndex(e){return this._tileAvailability.getBit(e)}tileIsAvailableAtCoordinates(e){const t=this.getTileIndex(e);return this.tileIsAvailableAtIndex(t)}contentIsAvailableAtIndex(e,t){return t=lm(t,0),this._contentAvailabilityBitstreams[t].getBit(e)}contentIsAvailableAtCoordinates(e,t){const i=this.getTileIndex(e);return this.contentIsAvailableAtIndex(i,t)}childSubtreeIsAvailableAtIndex(e){return this._childSubtreeAvailability.getBit(e)}childSubtreeIsAvailableAtCoordinates(e){const t=this.getChildSubtreeIndex(e);return this.childSubtreeIsAvailableAtIndex(t)}getLevelOffset(e){const t=this._branchingFactor;return(Math.pow(t,e)-1)/(t-1)}getParentMortonIndex(e){let t=2;return this._subdivisionScheme===DL.OCTREE&&(t=3),e>>t}getTileIndex(e){const t=e.level-this._implicitCoordinates.level;if(t<0||this._subtreeLevels<=t)throw new Error("level is out of bounds for this subtree");return e.getSubtreeCoordinates().getOffsetCoordinates(e).tileIndex}getChildSubtreeIndex(e){if(e.level-this._implicitCoordinates.level!==this._implicitCoordinates.subtreeLevels)throw new Error("level is out of bounds for this subtree");return e.getParentSubtreeCoordinates().getOffsetCoordinates(e).mortonIndex}getTileMetadataView(e){const t=function(e,t){if(!am(e._tileMetadataTable))return;const i=e.getTileIndex(t);if(e._tileAvailability.getBit(i))return e._tileJumpBuffer[i];return}(this,e);if(!am(t))return;const i=this._tileMetadataTable;return new $L({class:i.class,metadataTable:i,entityId:t,propertyTableJson:this._tilePropertyTableJson})}getContentMetadataView(e,t){const i=function(e,t,i){const n=e._contentMetadataTables;if(!am(n))return;const s=n[i];if(!am(s))return;const o=e._contentAvailabilityBitstreams[i],r=e.getTileIndex(t);if(o.getBit(r)){return e._contentJumpBuffers[i][r]}return}(this,e,t);if(!am(i))return;const n=this._contentMetadataTables[t],s=this._contentPropertyTableJsons[t];return new $L({class:n.class,metadataTable:n,entityId:i,contentIndex:t,propertyTableJson:s})}isDestroyed(){return!1}destroy(){return am(this._bufferLoader)&&qL.unload(this._bufferLoader),tG(this)}static async fromSubtreeJson(e,t,i,n,s){const o=new eD(e,n,s);let r;r=am(t)?{json:t,binary:void 0}:function(e){const t=!0,i=new DataView(e.buffer,e.byteOffset);let n=8;const s=i.getUint32(n,t);n+=8;const o=i.getUint32(n,t);n+=8;const r=function(e,t,i){return JSON.parse(MF(e,t,i))}(e,n,s);n+=s;const a=e.subarray(n,n+o);return{json:r,binary:a}}(i);const a=r.json;let l;if(o._subtreeJson=a,vP(a,"3DTILES_metadata"))l=a.extensions["3DTILES_metadata"];else if(am(a.tileMetadata)){const e=a.tileMetadata;l=a.propertyTables[e]}const g=[];if(am(a.contentMetadata)){const e=a.contentMetadata.length;for(let t=0;t<e;t++){const e=a.contentMetadata[t];g.push(a.propertyTables[e])}}let c;const d=n.metadataSchema,h=a.subtreeMetadata;if(am(h)){const e=h.class,t=d.classes[e];c=new YL({subtreeMetadata:h,class:t})}o._metadata=c,o._tilePropertyTableJson=l,o._contentPropertyTableJsons=g;const u={constant:0};a.contentAvailabilityHeaders=[],vP(a,"3DTILES_multiple_contents")?a.contentAvailabilityHeaders=a.extensions["3DTILES_multiple_contents"].contentAvailability:Array.isArray(a.contentAvailability)?a.contentAvailabilityHeaders=a.contentAvailability:a.contentAvailabilityHeaders.push(lm(a.contentAvailability,u));const I=function(e){e=am(e)?e:[];for(let t=0;t<e.length;t++){const i=e[t];i.isExternal=am(i.uri),i.isActive=!1}return e}(a.buffers),p=function(e,t){e=am(e)?e:[];for(let i=0;i<e.length;i++){const n=e[i],s=t[n.buffer];n.bufferHeader=s,n.isActive=!1}return e}(a.bufferViews,I);!function(e,t){let i;const n=e.tileAvailability;am(n.bitstream)?i=t[n.bitstream]:am(n.bufferView)&&(i=t[n.bufferView]);am(i)&&(i.isActive=!0,i.bufferHeader.isActive=!0);const s=e.contentAvailabilityHeaders;for(let r=0;r<s.length;r++)i=void 0,am(s[r].bitstream)?i=t[s[r].bitstream]:am(s[r].bufferView)&&(i=t[s[r].bufferView]),am(i)&&(i.isActive=!0,i.bufferHeader.isActive=!0);i=void 0;const o=e.childSubtreeAvailability;am(o.bitstream)?i=t[o.bitstream]:am(o.bufferView)&&(i=t[o.bufferView]);am(i)&&(i.isActive=!0,i.bufferHeader.isActive=!0)}(a,p),am(l)&&tD(l,p);for(let C=0;C<g.length;C++){tD(g[C],p)}const m=await function(e,t,i){const n=[];for(let s=0;s<t.length;s++){const o=t[s];if(o.isActive)if(o.isExternal){const t=iD(e,o);n.push(t)}else n.push(Promise.resolve(i));else n.push(Promise.resolve(void 0))}return Promise.all(n).then((function(e){const t={};for(let i=0;i<e.length;i++){const n=e[i];am(n)&&(t[i]=n)}return t}))}(o,I,r.binary),A=function(e,t){const i={};for(let n=0;n<e.length;n++){const s=e[n];if(!s.isActive)continue;const o=s.byteOffset,r=o+s.byteLength,a=t[s.buffer].subarray(o,r);i[n]=a}return i}(p,m);return function(e,t,i,n){const s=i.branchingFactor,o=i.subtreeLevels,r=(Math.pow(s,o)-1)/(s-1),a=Math.pow(s,o),l=vP(t,"3DTILES_metadata"),g=am(e._tilePropertyTableJson);let c=l||g;e._tileAvailability=nD(t.tileAvailability,n,r,c);const d=e._contentPropertyTableJsons.length>0;c=c||d;for(let h=0;h<t.contentAvailabilityHeaders.length;h++){const i=nD(t.contentAvailabilityHeaders[h],n,r,c);e._contentAvailabilityBitstreams.push(i)}e._childSubtreeAvailability=nD(t.childSubtreeAvailability,n,a)}(o,a,n,A),am(l)&&(function(e,t,i){const n=e._tilePropertyTableJson;e._tileAvailability.availableCount;const s=t.metadataSchema,o=n.class;s.classes[o]}(o,n),function(e){const t=sD(e._tileAvailability);e._tileJumpBuffer=t}(o)),function(e,t,i){const n=e._contentPropertyTableJsons,s=e._contentAvailabilityBitstreams,o=t.metadataSchema;e._contentMetadataTables;for(let r=0;r<n.length;r++){const e=n[r];s[r].availableCount;const t=e.class;o.classes[t]}}(o,n),function(e){const t=e._contentJumpBuffers,i=e._contentAvailabilityBitstreams;for(let n=0;n<i.length;n++){const e=sD(i[n]);t.push(e)}}(o),o._ready=!0,o}}function tD(e,t){const i=e.properties;let n;for(const s in i)if(i.hasOwnProperty(s)){const e=i[s];n=t[lm(e.values,e.bufferView)],n.isActive=!0,n.bufferHeader.isActive=!0;const o=lm(e.stringOffsets,e.stringOffsetBufferView);am(o)&&(n=t[o],n.isActive=!0,n.bufferHeader.isActive=!0);const r=lm(e.arrayOffsets,e.arrayOffsetBufferView);am(r)&&(n=t[r],n.isActive=!0,n.bufferHeader.isActive=!0)}}async function iD(e,t){const i=e._resource.getDerivedResource({url:t.uri}),n=qL.getExternalBufferLoader({resource:i});e._bufferLoader=n;try{await n.load()}catch(s){if(n.isDestroyed())return;throw s}return n.typedArray}function nD(e,t,i,n){if(am(e.constant))return new KL({constant:Boolean(e.constant),lengthBits:i,availableCount:e.availableCount});let s;return am(e.bitstream)?s=t[e.bitstream]:am(e.bufferView)&&(s=t[e.bufferView]),new KL({bitstream:s,lengthBits:i,availableCount:e.availableCount,computeAvailableCountEnabled:n})}function sD(e){let t=0;const i=e.lengthBits,n=e.availableCount;let s;s=n<256?new Uint8Array(i):n<65536?new Uint16Array(i):new Uint32Array(i);for(let o=0;o<e.lengthBits;o++)e.getBit(o)&&(s[o]=t,t++);return s}const oD=Object.freeze({ID:"ID",NAME:"NAME",DESCRIPTION:"DESCRIPTION",TILESET_TILE_COUNT:"TILESET_TILE_COUNT",TILE_BOUNDING_BOX:"TILE_BOUNDING_BOX",TILE_BOUNDING_REGION:"TILE_BOUNDING_REGION",TILE_BOUNDING_SPHERE:"TILE_BOUNDING_SPHERE",TILE_MINIMUM_HEIGHT:"TILE_MINIMUM_HEIGHT",TILE_MAXIMUM_HEIGHT:"TILE_MAXIMUM_HEIGHT",TILE_HORIZON_OCCLUSION_POINT:"TILE_HORIZON_OCCLUSION_POINT",TILE_GEOMETRIC_ERROR:"TILE_GEOMETRIC_ERROR",CONTENT_BOUNDING_BOX:"CONTENT_BOUNDING_BOX",CONTENT_BOUNDING_REGION:"CONTENT_BOUNDING_REGION",CONTENT_BOUNDING_SPHERE:"CONTENT_BOUNDING_SPHERE",CONTENT_MINIMUM_HEIGHT:"CONTENT_MINIMUM_HEIGHT",CONTENT_MAXIMUM_HEIGHT:"CONTENT_MAXIMUM_HEIGHT",CONTENT_HORIZON_OCCLUSION_POINT:"CONTENT_HORIZON_OCCLUSION_POINT"});class rD{constructor(e,t,i){const n=t.implicitTileset,s=t.implicitCoordinates;this._implicitTileset=n,this._implicitCoordinates=s,this._implicitSubtree=void 0,this._tileset=e,this._tile=t,this._resource=i,this._metadata=void 0,this.featurePropertiesDirty=!1,this._group=void 0;const o=s.getTemplateValues(),r=n.subtreeUriTemplate.getDerivedResource({templateValues:o});this._url=r.getUrlComponent(!0),this._ready=!1}hasProperty(e,t){return!1}getFeature(e){}applyDebugSettings(e,t){}update(e,t){}pick(e,t,i){}isDestroyed(){return!1}destroy(){return this._implicitSubtree=this._implicitSubtree&&this._implicitSubtree.destroy(),tG(this)}get featuresLength(){return 0}get pointsLength(){return 0}get trianglesLength(){return 0}get geometryByteLength(){return 0}get texturesByteLength(){return 0}get batchTableByteLength(){return 0}get innerContents(){}get ready(){return this._ready}get tileset(){return this._tileset}get tile(){return this._tile}get url(){return this._url}get metadata(){}get batchTable(){}get group(){return this._group}set group(e){this._group=e}static async fromSubtreeJson(e,t,i,n,s,o){let r;o=lm(o,0),am(s)&&(r=new Uint8Array(s,o));const a=t.implicitTileset,l=t.implicitCoordinates,g=await eD.fromSubtreeJson(i,n,r,a,l),c=new rD(e,t,i);return c._implicitSubtree=g,function(e,t){const i=e._tile,n=e._implicitCoordinates.childIndex,s=function(e,t,i,n){const s=lD(e,t,i,n,0,!0),o=e._tileset.statistics;let r=[s],a=[];const l=e._implicitTileset;for(let g=1;g<l.subtreeLevels;g++){const i=t.getLevelOffset(g),n=l.branchingFactor*r.length;for(let s=0;s<n;s++){const n=i+s;if(!t.tileIsAvailableAtIndex(n)){a.push(void 0);continue}const g=r[t.getParentMortonIndex(s)],c=lD(e,t,g,s%l.branchingFactor,n);g.children.push(c),o.numberOfTilesTotal++,a.push(c)}r=a,a=[]}return{rootTile:s,bottomRow:r}}(e,t,i,n),o=e._tileset.statistics;i.children.push(s.rootTile),o.numberOfTilesTotal++;const r=function(e,t,i){const n=[],s=e._implicitTileset.branchingFactor;for(let o=0;o<i.length;o++){const e=i[o];if(am(e))for(let i=0;i<s;i++){const r=o*s+i;t.childSubtreeIsAvailableAtIndex(r)&&n.push({tile:e,childIndex:i})}}return n}(e,t,s.bottomRow);for(let a=0;a<r.length;a++){const t=r[a],i=t.tile,n=CD(e,i,t.childIndex);i.children.push(n),o.numberOfTilesTotal++}}(c,g),c._ready=!0,c}}function aD(e,t,i){const n=oD.TILE_GEOMETRIC_ERROR;return am(e)&&e.hasPropertyBySemantic(n)?e.getPropertyBySemantic(n):t.geometricError/Math.pow(2,i.level)}function lD(e,t,i,n,s,o){const r=e._implicitTileset;let a,l;a=lm(o,!1)?i.implicitCoordinates:i.implicitCoordinates.getChildCoordinates(n),am(t.tilePropertyTableJson)&&(l=t.getTileMetadataView(a));const g=t.contentPropertyTableJsons.length;let c=!1;for(let A=0;A<g;A++)if(t.contentIsAvailableAtCoordinates(a,A)){c=!0;break}const d=function(e,t,i,n,s,o){let r;r=!am(o)||!am(o.boundingVolume)||!gD(o.boundingVolume,o)&&gD(e.boundingVolume,o)?hD(e,t,i,lm(n,!1),s):o.boundingVolume;return cD(r,o),r}(r,a,n,o,i,undefined),h=[];for(let A=0;A<r.contentCount;A++){if(!t.contentIsAvailableAtIndex(s,A))continue;const e={uri:r.contentUriTemplates[A].getDerivedResource({templateValues:a.getTemplateValues()}).url},i=dD(d,undefined);am(i)&&(e.boundingVolume=i),h.push(dm(e,r.contentHeaders[A]))}const u={boundingVolume:d,geometricError:aD(l,r,a),refine:r.refine,contents:h},I=cm(r.tileHeader,true);delete I.boundingVolume,delete I.transform,delete I.metadata;const p=dm(u,I,true),m=fD(e,r.baseResource,p,i);return m.implicitCoordinates=a,m.implicitSubtree=t,m.metadata=l,m.hasImplicitContentMetadata=c,m}function gD(e,t){return am(e)&&am(t)&&(am(t.minimumHeight)||am(t.maximumHeight))&&(vP(e,"3DTILES_bounding_volume_S2")||am(e.region))}function cD(e,t){am(t)&&(vP(e,"3DTILES_bounding_volume_S2")?function(e,t,i){am(t)&&(e.minimumHeight=t);am(i)&&(e.maximumHeight=i)}(e.extensions["3DTILES_bounding_volume_S2"],t.minimumHeight,t.maximumHeight):am(e.region)&&function(e,t,i){am(t)&&(e[4]=t);am(i)&&(e[5]=i)}(e.region,t.minimumHeight,t.maximumHeight))}function dD(e,t){let i;return am(t)&&(i=t.boundingVolume),gD(i,t)?cD(i,t):gD(e,t)&&(i=cm(e,!0),cD(i,t)),i}function hD(e,t,i,n,s){const o=e.boundingVolume;if(vP(o,"3DTILES_bounding_volume_S2"))return t.level,t.x,t.y,void t.z;if(am(o.region)){return{region:function(e,t,i,n,s){if(0===t)return e.slice();const o=IA.unpack(e,0,AD),r=e[4],a=e[5],l=Math.pow(2,-t),g=l*o.width,c=Km.negativePiToPi(o.west+i*g),d=Km.negativePiToPi(c+g),h=l*o.height,u=Km.negativePiToPi(o.south+n*h),I=Km.negativePiToPi(u+h);let p=r,m=a;if(am(s)){const e=l*(a-r);p+=s*e,m=p+e}return[c,u,d,I,p,m]}(o.region,t.level,t.x,t.y,t.z)}}return{box:function(e,t,i,n,s){if(0===t)return e;const o=ID.fromArray(e,0),r=mD.fromArray(e,3),a=Math.pow(2,-t),l=(2*i+1)*a-1,g=(2*n+1)*a-1;let c=0;const d=uD.set(a,a,1);am(s)&&(c=(2*s+1)*a-1,d.z=a);let h=pD.set(l,g,c);h=pD.applyMatrix3(r),h=pD.addVectors(h,o);let u=(new yt).copy(r);rA.multiplyByScale(u,d,u);const I=new Array(12);return h.toArray(I),u.toArray(I,3),I}(o.box,t.level,t.x,t.y,t.z)}}const uD=new Qt,ID=new Qt,pD=new Qt,mD=new yt;const AD=new IA;function CD(e,t,i){const n=e._implicitTileset,s=t.implicitCoordinates.getChildCoordinates(i),o=hD(n,s),r=aD(void 0,n,s),a=n.subtreeUriTemplate.getDerivedResource({templateValues:s.getTemplateValues()}).url,l={boundingVolume:o,geometricError:r,refine:n.refine,contents:[{uri:a}]},g=fD(e,n.baseResource,l,t);return g.implicitTileset=n,g.implicitCoordinates=s,g}function fD(e,t,i,n){return new(0,e._tile.constructor)(e._tileset,t,i,n)}const bD=Symbol("INITIAL_FRUSTUM_CULLED");class yD{constructor(e){__publicField(this,"byteSize",0),this.scene=e.scene,this.asset=lm(e.asset,{}),this.parser=e.parser,this.animations=lm(e.animations,[]),this.batchTable=lm(e.batchTable,{}),this.featureTable=lm(e.featureTable,{}),this.userData=lm(e.userData,{}),this.metadata=lm(e.metadata,{}),this.group=lm(e.group,{}),this.type=lm(e.type,"gltf")}static fromJson(e){return e=lm(e,{}),new yD(e)}traverse(e){const t=this.scene;t&&t.traverse(e)}dispose(){const e=this.scene;if(e){const t=[],i=[],n=[];this.traverse((e=>{if(e.geometry&&i.push(e.geometry),e.material){const i=e.material;t.push(e.material);for(const e in i)if(i.hasOwnProperty(e)){const t=i[e];t&&t.isTexture&&n.push(t)}}e.userData.meshFeatures&&e.userData.meshFeatures.dispose(),e.userData.structuralMetadata&&e.userData.structuralMetadata.dispose()}));for(let e=0,s=i.length;e<s;e++)i[e].dispose();for(let e=0,s=t.length;e<s;e++)t[e].dispose();for(let e=0,s=n.length;e<s;e++){const t=n[e];t.image instanceof ImageBitmap&&t.image.close(),t.dispose()}e.removeFromParent()}}update(e){const t=e.tileset,i=this.scene,n=t.gltfUpMatrix;var s;t.optimizeRaycast,i.updateMatrix(),"gltf"!==this.type&&"glb"!==this.type||i.matrix.multiply(n),i.matrix.premultiply(e.computedTransform),i.matrix.decompose(i.position,i.quaternion,i.scale),i.traverse((t=>{t[bD]=t.frustumCulled,t.isMesh&&(t.content=this,t.tile=e)})),s=!1,i.traverse((e=>{e.frustumCulled=e[bD]&&s}))}}const _D={externalTileset:function(e,t,i,n){return yz.fromJson(e,t,i,n)},b3dm:async function(e,t,i,n){const s=e._manager,o=i.url.split(/[\\/]/g);o.pop();const r=o.join("/"),a=new BL(s),l=e.gltfUpMatrix;a.adjustmentTransform.copy(l),a.workingPath=r;const g=a.parse(n),c=await g;return c.type="b3dm",yD.fromJson(c)},pnts:async function(e,t,i,n){const s=e._manager,o=i.url.split(/[\\/]/g);o.pop();const r=o.join("/"),a=new FL(s);a.workingPath=r;const l=a.parse(n),g=await l;return g.type="pnts",yD.fromJson(g)},i3dm:async function(e,t,i,n){const s=e._manager,o=i.url.split(/[\\/]/g);o.pop();const r=o.join("/"),a=new WL(s),l=e.gltfUpMatrix;a.adjustmentTransform.copy(l),a.workingPath=r;const g=a.parse(n),c=await g;return c.type="i3dm",yD.fromJson(c)},cmpt:async function(e,t,i,n){const s=e._manager,o=i.url.split(/[\\/]/g);o.pop();const r=o.join("/"),a=new zL(s),l=e.gltfUpMatrix;a.adjustmentTransform.copy(l),a.workingPath=r;const g=a.parse(n),c=await g;return c.type="cmpt",yD.fromJson(c)},gltf:async function(e,t,i,n){const s=e._manager,o=i.url.split(/[\\/]/g);o.pop();const r=o.join("/"),a=new LL(s);a.workingPath=r;const l=a.parse(n),g=await l;return g.type="gltf",yD.fromJson(g)},glb:async function(e,t,i,n){const s=e._manager,o=i.url.split(/[\\/]/g);o.pop();const r=o.join("/"),a=new LL(s);a.workingPath=r;const l=a.parse(n),g=await l;return g.type="glb",yD.fromJson(g)},subt:function(e,t,i,n,s){return rD.fromSubtreeJson(e,t,i,void 0,n,s)},subtreeJson:function(e,t,i,n){return rD.fromSubtreeJson(e,t,i,n)}},vD=new Qt,xD=new Qt,BD=new Qt,wD=new xi;class SD{constructor(e=new qt,t=new Bi){this.box=e.clone(),this.absoluteBox=e.clone(),this.transform=t.clone(),this.inverseTransform=new Bi,this.points=new Array(8).fill().map((()=>new Qt)),this.planes=new Array(6).fill().map((()=>new Cs))}clampPoint(e,t){return t.copy(e).applyMatrix4(this.inverseTransform).clamp(this.box.min,this.box.max).applyMatrix4(this.transform)}distanceToPoint(e){return this.clampPoint(e,BD).distanceTo(e)}containsPoint(e){return BD.copy(e).applyMatrix4(this.inverseTransform),this.box.containsPoint(BD)}intersectsRay(e){return wD.copy(e).applyMatrix4(this.inverseTransform),wD.intersectsBox(this.box)}intersectRay(e,t){return wD.copy(e).applyMatrix4(this.inverseTransform),wD.intersectBox(this.box,t)?(t.applyMatrix4(this.transform),t):null}update(){const{points:e,inverseTransform:t,transform:i,box:n}=this;t.copy(i).invert();const{min:s,max:o}=n;let r=0;for(let a=-1;a<=1;a+=2)for(let t=-1;t<=1;t+=2)for(let n=-1;n<=1;n+=2)e[r].set(a<0?s.x:o.x,t<0?s.y:o.y,n<0?s.z:o.z).applyMatrix4(i),r++;this.updatePlanes()}updatePlanes(){vD.copy(this.box.min).applyMatrix4(this.transform),xD.copy(this.box.max).applyMatrix4(this.transform),BD.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(BD,vD),this.planes[1].setFromNormalAndCoplanarPoint(BD,xD).negate(),BD.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(BD,vD),this.planes[3].setFromNormalAndCoplanarPoint(BD,xD).negate(),BD.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(BD,vD),this.planes[5].setFromNormalAndCoplanarPoint(BD,xD).negate()}intersectsFrustum(e){const{points:t}=this,{planes:i}=e;for(let n=0;n<6;n++){const e=i[n];let s=-1/0;for(let i=0;i<8;i++){const n=t[i],o=e.distanceToPoint(n);s=s<o?o:s}if(s<0)return!1}for(let n=0;n<6;n++){const t=this.planes[n];let i=-1/0;for(let n=0;n<8;n++){const s=e.points[n],o=t.distanceToPoint(s);i=i<o?o:i}if(i<0)return!1}return!0}}const GD=Math.PI,MD=GD/2,RD=new Qt,TD=new Qt,ZD=new Qt,VD=new Bi,WD=new Qt,ED=new Qt;new Bi;let ND=0;const FD=[];function XD(e=!1){return e?(FD[ND]||(FD[ND]=new Qt),ND++,FD[ND-1]):new Qt}function HD(){ND=0}class zD extends eA{constructor(e,t,i,n=-MD,s=MD,o=0,r=2*GD,a=0,l=0){super(e,t,i),this.latStart=n,this.latEnd=s,this.lonStart=o,this.lonEnd=r,this.heightStart=a,this.heightEnd=l}_getPoints(e=!1){const{latStart:t,latEnd:i,lonStart:n,lonEnd:s,heightStart:o,heightEnd:r}=this,a=ft.mapLinear(.5,0,1,t,i),l=ft.mapLinear(.5,0,1,n,s),g=Math.floor(n/MD)*MD,c=[[-GD/2,0],[GD/2,0],[0,g],[0,g+GD/2],[0,g+GD],[0,g+3*GD/2],[t,s],[i,s],[t,n],[i,n],[0,n],[0,s],[a,l],[t,l],[i,l],[a,n],[a,s]],d=[],h=c.length;for(let u=0;u<=1;u++){const a=ft.mapLinear(u,0,1,o,r);for(let o=0,r=h;o<r;o++){const[r,l]=c[o];if(r>=t&&r<=i&&l>=n&&l<=s){const t=XD(e);d.push(t),this.cartographicToCartesian(ED.set(l,r,a),t)}}}return d}getBoundingBox(e,t){HD();const{latStart:i,latEnd:n,lonStart:s,lonEnd:o}=this;if(n-i<GD/2){const e=ft.mapLinear(.5,0,1,i,n),r=ft.mapLinear(.5,0,1,s,o);this.cartographicToCartesian(WD.set(r,e,0),ED);const a=bA.eastNorthUpToFixedFrame(ED);t.copy(a)}else RD.set(1,0,0),TD.set(0,1,0),ZD.set(0,0,1),t.makeBasis(RD,TD,ZD);const r=this._getPoints(!0);e.makeEmpty(),e.setFromPoints(r),VD.copy(t).invert();for(let a=0,l=r.length;a<l;a++)r[a].applyMatrix4(VD);e.makeEmpty(),e.setFromPoints(r)}getBoundingSphere(e,t){HD();const i=this._getPoints(!0);e.makeEmpty(),e.setFromPoints(i,t)}}const LD=new Qt,DD=new Qt,KD=new Qt,YD=new Qt,PD=new Qt;new yt;const kD=new yt,OD=new Qt,UD=new Qt,QD=new Qt,JD=6378137;class jD{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(e){const t=this.sphere,i=this.obb||this.regionObb;return!(t&&!e.intersectsSphere(t))&&!(i&&!i.intersectsRay(e))}intersectRay(e,t=null){const i=this.sphere,n=this.obb||this.regionObb;let s=-1/0,o=-1/0;i&&e.intersectSphere(i,YD)&&(s=i.containsPoint(e.origin)?0:e.origin.distanceToSquared(YD)),n&&n.intersectRay(e,PD)&&(o=n.containsPoint(e.origin)?0:e.origin.distanceToSquared(PD));const r=Math.max(s,o);return r===-1/0?null:(e.at(Math.sqrt(r),t),t)}distanceToPoint(e){const t=this.sphere,i=this.obb||this.regionObb;let n=-1/0,s=-1/0;return t&&(n=Math.max(t.distanceToPoint(e),0)),i&&(s=i.distanceToPoint(e)),n>s?n:s}intersectsFrustum(e,t){const i=this.obb||this.regionObb,n=this.sphere;return!(n&&!e.intersectsSphere(n))&&(!(i&&!i.intersectsFrustum(e))&&Boolean(n||i))}getOBB(e,t){const i=this.obb||this.regionObb;i?(e.copy(i.box),t.copy(i.transform)):(this.getAABB(e),t.identity())}getAABB(e){if(this.sphere)this.sphere.getBoundingBox(e);else{const t=this.obb||this.regionObb;e.copy(t.box).applyMatrix4(t.transform)}}getSphere(e){if(this.sphere)e.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(e);else{const t=this.obb||this.regionObb;t.box.getBoundingSphere(e),e.applyMatrix4(t.transform)}}setObbData(e,t){const i=new SD;LD.set(e[3],e[4],e[5]),DD.set(e[6],e[7],e[8]),KD.set(e[9],e[10],e[11]);const n=LD.length(),s=DD.length(),o=KD.length();LD.normalize(),DD.normalize(),KD.normalize(),0===n&&LD.crossVectors(DD,KD),0===s&&DD.crossVectors(LD,KD),0===o&&KD.crossVectors(LD,DD),i.transform.set(LD.x,DD.x,KD.x,e[0],LD.y,DD.y,KD.y,e[1],LD.z,DD.z,KD.z,e[2],0,0,0,1).premultiply(t);const r=(new Qt).setFromMatrixColumn(i.transform,3);i.center=r,kD.fromArray(e,3);const a=(new yt).setFromMatrix4(t);i.halfAxes=a.multiply(kD),i.box.min.set(-n,-s,-o),i.box.max.set(n,s,o),i.update(),i.absoluteBox.copy(i.box).applyMatrix4(i.transform),this.obb=i}setSphereData(e,t,i,n,s){const o=new mi;o.center.set(e,t,i),o.radius=n,o.applyMatrix4(s),this.sphere=o}setRegionData(e,t,i,n,s,o){const r=new zD(JD,JD,6356752.314245179,t,n,e,i,s,o),a=new SD;r.getBoundingBox(a.box,a.transform),a.update();const l=ft.mapLinear(.5,0,1,t,n),g=ft.mapLinear(.5,0,1,e,i),{min:c,max:d}=a.box,h=(new yt).setFromMatrix4(a.transform);let u=UD;u.x=(c.x+d.x)/2,u.y=(c.y+d.y)/2,u.z=(c.z+d.z)/2;const I=QD;I.x=(d.x-c.x)/2,I.y=(d.y-c.y)/2,I.z=(d.z-c.z)/2;const p=r.cartographicToCartesian(OD.set(g,l,0));u.applyMatrix3(h),a.center=p.add(u),rA.multiplyByScale(h,I,h),a.halfAxes=h,a.absoluteBox.copy(a.box).applyMatrix4(a.transform),this.region=r,this.regionObb=a}}function qD(e){let t;try{t=function(e,t,i){return JSON.parse(MF(e,t,i))}(e)}catch(i){throw new Error("Invalid tile content.")}return t}class $D{constructor(e){const t=(e=lm(e,{})).tile,i=e.class;this._class=i,this._properties=t.properties,this._extensions=t.extensions,this._extras=t.extras}get class(){return this._class}get extras(){return this._extras}get extensions(){return this._extensions}hasProperty(e){return wF.hasProperty(e,this._properties,this._class)}hasPropertyBySemantic(e){return wF.hasPropertyBySemantic(e,this._properties,this._class)}getPropertyIds(e){return wF.getPropertyIds(this._properties,this._class,e)}getProperty(e){return wF.getProperty(e,this._properties,this._class)}setProperty(e,t){return wF.setProperty(e,t,this._properties,this._class)}getPropertyBySemantic(e){return wF.getPropertyBySemantic(e,this._properties,this._class)}setPropertyBySemantic(e,t){return wF.setPropertyBySemantic(e,t,this._properties,this._class)}}class eK{constructor(e){const t=(e=lm(e,{})).content,i=e.class;this._class=i,this._properties=t.properties,this._extensions=t.extensions,this._extras=t.extras}get class(){return this._class}get extras(){return this._extras}get extensions(){return this._extensions}hasProperty(e){return wF.hasProperty(e,this._properties,this._class)}hasPropertyBySemantic(e){return wF.hasPropertyBySemantic(e,this._properties,this._class)}getPropertyIds(e){return wF.getPropertyIds(this._properties,this._class,e)}getProperty(e){return wF.getProperty(e,this._properties,this._class)}setProperty(e,t){return wF.setProperty(e,t,this._properties,this._class)}getPropertyBySemantic(e){return wF.getPropertyBySemantic(e,this._properties,this._class)}setPropertyBySemantic(e,t){return wF.setPropertyBySemantic(e,t,this._properties,this._class)}}function tK(e,t){const i=e.metadataExtension;if(!am(i))return;const n=i.groups,s=vP(t,"3DTILES_metadata")?t.extensions["3DTILES_metadata"].group:t.group;if("number"==typeof s)return n[s];const o=i.groupIds.findIndex((function(e){return e===s}));return o>=0?n[o]:void 0}function iK(e,t){const i=vP(t,"3DTILES_metadata")?t.extensions["3DTILES_metadata"]:t.metadata;if(!am(i))return;if(!am(e.schema))return void tw("Could not find a metadata schema for content metadata. For tilesets that contain external tilesets, make sure the schema is added to the root tileset.json.");const n=lm(e.schema.classes,{});if(am(i.class)){const e=n[i.class];return new eK({content:i,class:e})}}class nK{constructor(e){e=lm(e,{}),this._metadata=e.metadata}get metadata(){return this._metadata}}const sK={contain:function(e,t){const i=e.image&&e.image.width?e.image.width/e.image.height:1;return i>t?(e.repeat.x=1,e.repeat.y=i/t,e.offset.x=0,e.offset.y=(1-e.repeat.y)/2):(e.repeat.x=t/i,e.repeat.y=1,e.offset.x=(1-e.repeat.x)/2,e.offset.y=0),e},cover:function(e,t){const i=e.image&&e.image.width?e.image.width/e.image.height:1;return i>t?(e.repeat.x=t/i,e.repeat.y=1,e.offset.x=(1-e.repeat.x)/2,e.offset.y=0):(e.repeat.x=1,e.repeat.y=i/t,e.offset.x=0,e.offset.y=(1-e.repeat.y)/2),e},fill:function(e){return e.repeat.x=1,e.repeat.y=1,e.offset.x=0,e.offset.y=0,e},getByteLength:function(e,t,i,n){const s=function(e){switch(e){case F:case X:return{byteLength:1,components:1};case z:case H:case Y:return{byteLength:2,components:1};case P:case k:return{byteLength:2,components:4};case D:case L:case K:return{byteLength:4,components:1}}throw new Error(`Unknown texture type ${e}.`)}(n);switch(i){case 1021:case Q:return e*t;case 1025:return e*t*2;case q:case $:return e*t/s.components*s.byteLength;case ee:case te:return e*t*2/s.components*s.byteLength;case U:case ie:return e*t*4/s.components*s.byteLength;case ne:case se:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case oe:case re:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case le:case ce:return Math.max(e,16)*Math.max(t,8)/4;case ae:case ge:return Math.max(e,8)*Math.max(t,8)/2;case de:case he:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case ue:case Ie:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case pe:return Math.floor((e+4)/5)*Math.floor((t+3)/4)*16;case me:return Math.floor((e+4)/5)*Math.floor((t+4)/5)*16;case Ae:return Math.floor((e+5)/6)*Math.floor((t+4)/5)*16;case Ce:return Math.floor((e+5)/6)*Math.floor((t+5)/6)*16;case fe:return Math.floor((e+7)/8)*Math.floor((t+4)/5)*16;case be:return Math.floor((e+7)/8)*Math.floor((t+5)/6)*16;case ye:return Math.floor((e+7)/8)*Math.floor((t+7)/8)*16;case _e:return Math.floor((e+9)/10)*Math.floor((t+4)/5)*16;case ve:return Math.floor((e+9)/10)*Math.floor((t+5)/6)*16;case xe:return Math.floor((e+9)/10)*Math.floor((t+7)/8)*16;case Be:return Math.floor((e+9)/10)*Math.floor((t+9)/10)*16;case we:return Math.floor((e+11)/12)*Math.floor((t+9)/10)*16;case Se:return Math.floor((e+11)/12)*Math.floor((t+11)/12)*16;case Ge:case Me:case Re:return Math.ceil(e/4)*Math.ceil(t/4)*16;case 36283:case Te:return Math.ceil(e/4)*Math.ceil(t/4)*8;case Ze:case Ve:return Math.ceil(e/4)*Math.ceil(t/4)*16}throw new Error(`Unable to determine texture byte length for ${i} format.`)}};function oK(e){if(!sK)return 0;const t=new Set;let i=0;return e.traverse((e=>{if(e.geometry&&!t.has(e.geometry)&&(i+=function(e){let t=0;for(const n in e.attributes){const i=e.getAttribute(n);t+=i.count*i.itemSize*i.array.BYTES_PER_ELEMENT}const i=e.getIndex();return t+=i?i.count*i.itemSize*i.array.BYTES_PER_ELEMENT:0,t}(e.geometry),t.add(e.geometry)),e.material){const n=e.material;for(const e in n)if(n.hasOwnProperty(e)){const s=n[e];if(s&&s.isTexture&&!t.has(s)){const{format:e,type:n,image:o}=s,{width:r,height:a}=o,l=sK.getByteLength(r,a,e,n);i+=s.generateMipmaps?4*l/3:l,t.add(s)}}}})),i}function rK(e,t){e._cancelCount++,e._tile._contentState=t;const i=e.tileset.statistics;i.numberOfPendingRequests-=e._requestsInFlight,i.numberOfAttemptedRequests+=e._requestsInFlight,e._requestsInFlight=0;const n=e._innerContentHeaders.length;e._arrayFetchPromises=new Array(n)}function aK(e,t,i,n){const s=e._innerContentResources[t].clone(),o=e.tile,r=e._serverKeys[t],a=new GF({throttle:!0,throttleByServer:!0,priorityFunction:function(){return o._priority},serverKey:r});s.request=a,e._requests[t]=a;const l=s.fetchArrayBuffer();if(am(l))return l.then((function(t){if(!(i<e._cancelCount)){if(!s.request.cancelled&&s.request.state!==SF.CANCELLED)return lK(e,-1),t;rK(e,n)}})).catch((function(o){i<e._cancelCount||(s.request.cancelled||s.request.state===SF.CANCELLED?rK(e,n):(lK(e,-1),cK(e,t,o)))}))}function lK(e,t){e._requestsInFlight+=t,e.tileset.statistics.numberOfPendingRequests+=t}async function gK(e){const t=e._cancelCount,i=await Promise.all(e._arrayFetchPromises);if(t<e._cancelCount)return;const n=i.map(((t,i)=>async function(e,t,i){if(!am(t))return;try{const n=function(e){const t=new Uint8Array(e);let i=TF(t);if("glTF"===i&&(i="glb"),bz.isBinaryFormat(i))return{contentType:i,binaryPayload:t};const n=qD(t);if(am(n.root))return{contentType:bz.EXTERNAL_TILESET,jsonPayload:n};if(am(n.root))return{contentType:bz.EXTERNAL_TILESET,jsonPayload:n};if(am(n.asset))return{contentType:bz.GLTF,jsonPayload:n};if(am(n.tileAvailability))return{contentType:bz.IMPLICIT_SUBTREE_JSON,jsonPayload:n};if(am(n.type))return{contentType:bz.GEOJSON,jsonPayload:n};if(am(n.voxelTable))return{contentType:bz.VOXEL_JSON,jsonPayload:n};throw new Error("Invalid tile content.")}(t);if(n.contentType===bz.EXTERNAL_TILESET)throw new Error("External tilesets are disabllowed inside multiple contents");const s=e._tileset,o=e._innerContentResources[i],r=e._tile;let a;const l=_D[n.contentType];a=am(n.binaryPayload)?await l(s,r,r._contentResource,n.binaryPayload.buffer,0):await Promise.resolve(l(s,r,o,n.binaryPayload.buffer));const g=e._innerContentHeaders[i];if(r.hasImplicitContentMetadata){const e=r.implicitSubtree,t=r.implicitCoordinates;a.metadata=e.getContentMetadataView(t,i)}else r.hasImplicitContent||(a.metadata=iK(s,g));const c=tK(s,g);if(am(c)&&(a.group=new nK({metadata:c})),!r.hasTilesetContent&&!r.hasImplicitContent){am(a.scene)&&(a.byteSize=oK(a.scene))}return a}catch(n){cK(e,i,n)}}(e,t,i))),s=await Promise.all(n);return e._contentCreated=!0,e._contents=s.filter(am),s}function cK(e,t,i){e._tileset,e._innerContentResources[t].url,am(i.message)?i.message:i.toString()}class dK{constructor(e,t,i,n){__publicField(this,"isMultiple3DTileContents",!0),this._tileset=e,this._tile=t,this._tilesetResource=i;const s=am(n.contents)?n.contents:n.content;this._innerContentHeaders=s,this._requestsInFlight=0,this._cancelCount=0;const o=this._innerContentHeaders.length;this._arrayFetchPromises=new Array(o),this._requests=new Array(o),this._ready=!1,this._innerContentResources=new Array(o),this._serverKeys=new Array(o);for(let r=0;r<o;r++){const e=i.getDerivedResource({url:s[r].uri}),t=PH.getServerKey(e.getUrlComponent());this._innerContentResources[r]=e,this._serverKeys[r]=t}}updatePendingRequests(e){}requestInnerContents(){if(!function(e){const t={};for(let i=0;i<e.length;i++){const n=e[i];am(t[n])?t[n]++:t[n]=1}for(let i in t)if(t.hasOwnProperty(i)&&!PH.serverHasOpenSlots(i,t[i]))return!1;return PH.heapHasOpenSlots(e.length)}(this._serverKeys))return void(this.tileset.statistics.numberOfAttemptedRequests+=this._serverKeys.length);const e=this._innerContentHeaders;lK(this,e.length);const t=this._cancelCount;for(let i=0;i<e.length;i++)this._arrayFetchPromises[i]=aK(this,i,t,this._tileset._contentState);return gK(this)}cancelRequests(){for(let e=0;e<this._requests.length;e++){const t=this._requests[e];am(t)&&t.cancel()}}traverse(e){const t=this._contents;if(t&&t.length>0)for(let i=0;i<t.length;i++){const n=t[i].scene;n&&n.traverse(e)}}dispose(){const e=this._contents;if(e&&e.length>0)for(let t=0;t<e.length;t++){e[t].dispose()}}update(e){const t=this._contents;t&&t.length>0&&t.forEach((t=>{t.update(e)}))}get tileset(){return this._tileset}get tile(){return this._tile}}parseInt(o,10);const hK=new mi,uK=new Qt,IK=new Qt,pK=new Qt;function mK(e,t){return am(e)&&am(e.extensions)&&am(e.extensions[t])}function AK(e){return function(){return e._priority}}function CK(e){const t=e._contentResource.clone(),i=new GF({throttle:!0,throttleByServer:!0,priorityFunction:AK(e),serverKey:e._serverKey});e._request=i,t.request=i;const n=e._tileset,s=t.fetchArrayBuffer();if(am(s))return async function(e,t,i,n,s){const o=e._contentState;let r;e._contentState=WH.LOADING,++t.statistics.numberOfPendingRequests;try{r=await s}catch(a){if(--t.statistics.numberOfPendingRequests,e.isDestroyed())return;if(i.cancelled||i.state===SF.CANCELLED)return e._contentState=o,void++t.statistics.numberOfAttemptedRequests;e._contentState=WH.FAILED}if(e.isDestroyed())return void--t.statistics.numberOfPendingRequests;if(i.cancelled||i.state===SF.CANCELLED)return e._contentState=o,--t.statistics.numberOfPendingRequests,void++t.statistics.numberOfAttemptedRequests;try{const i=await async function(e,t){const i=function(e){const t=new Uint8Array(e);let i=TF(t);"glTF"===i&&(i="glb");if(bz.isBinaryFormat(i))return{contentType:i,binaryPayload:t};const n=function(e){let t;try{t=function(e,t,i){return JSON.parse(MF(e,t,i))}(e)}catch(a){throw new Error("Invalid tile content.")}return t}(t);if(am(n.root))return{contentType:bz.EXTERNAL_TILESET,jsonPayload:n};if(am(n.root))return{contentType:bz.EXTERNAL_TILESET,jsonPayload:n};if(am(n.asset))return{contentType:bz.GLTF,jsonPayload:n};if(am(n.tileAvailability))return{contentType:bz.IMPLICIT_SUBTREE_JSON,jsonPayload:n};if(am(n.type))return{contentType:bz.GEOJSON,jsonPayload:n};if(am(n.voxelTable))return{contentType:bz.VOXEL_JSON,jsonPayload:n};throw new Error("Invalid tile content.")}(t),n=e._tileset;n._disableSkipLevelOfDetail=n._disableSkipLevelOfDetail||i.contentType===bz.GEOMETRY||i.contentType===bz.VECTOR,(i.contentType===bz.IMPLICIT_SUBTREE||i.contentType===bz.IMPLICIT_SUBTREE_JSON)&&(e.hasImplicitContent=!0);i.contentType===bz.EXTERNAL_TILESET&&(e.hasTilesetContent=!0);let s;const o=_D[i.contentType];if(e.isDestroyed())return;s=am(i.binaryPayload)?await o(n,e,e._contentResource,i.binaryPayload.buffer,0):await Promise.resolve(o(n,e,e._contentResource,i.jsonPayload));const r=e._contentHeader;if(e.hasImplicitContentMetadata){const t=e.implicitSubtree,i=e.implicitCoordinates;s.metadata=t.getContentMetadataView(i,0)}else e.hasImplicitContent||(s.metadata=iK(n,r));const l=tK(n,r);am(l)&&(s.group=new nK({metadata:l}));if(!e.hasTilesetContent&&!e.hasImplicitContent){const e=s.scene;am(e)&&(s.byteSize=oK(e))}return s}(e,r);if(--t.statistics.numberOfPendingRequests,e.isDestroyed())return;return e._content=i,e._contentState=WH.PROCESSING,i}catch(a){if(--t.statistics.numberOfPendingRequests,e.isDestroyed())return;throw e._contentState=WH.FAILED,a}}(e,n,i,0,s);++n.statistics.numberOfAttemptedRequests}function fK(e,t,i){return Math.max(Km.normalize(e,t,i)-Km.EPSILON7,0)}class bK{constructor(e,t,i,n){this._tileset=e,this._header=i,this.hasTilesetContent=!1,this.hasImplicitContent=!1,this.hasImplicitContentMetadata=!1,this._updatedVisibilityFrame=0;const s=am(i.contents),o=s&&i.contents.length>1||mK(i,"3DTILES_multiple_contents"),r=s&&!o?i.contents[0]:i.content;this._contentHeader=r,this.transform=am(i.transform)?(new Bi).fromArray(i.transform):new Bi;const a=am(n)?n.computedTransform:e.modelMatrix,l=(new Bi).copy(a).multiply(this.transform);let g,c;this.computedTransform=l,this.metadata=function(e,t){const i=vP(t,"3DTILES_metadata")?t.extensions["3DTILES_metadata"]:t.metadata;if(!am(i))return;if(!am(e.schema))return void tw("Could not find a metadata schema for tile metadata. For tilesets that contain external tilesets, make sure the schema is added to the root tileset.json.");const n=lm(e.schema.classes,{});if(am(i.class)){const e=n[i.class];return new $D({tile:i,class:e})}}(e,i),this.geometricError=i.geometricError,this._geometricError=i.geometricError,am(this._geometricError)||(this._geometricError=am(n)?n._geometricError:e._geometricError),g=am(i.refine)?"REPLACE"===i.refine.toUpperCase()?fP.REPLACE:fP.ADD:am(n)?n.refine:fP.REPLACE,this._parent=n;let d,h,u=!1;if(t=az.createIfNeeded(t),o)d=WH.UNLOADED,h=t.clone();else if(am(r)){let i=r.uri;am(r.url)&&(console.warn('This tileset JSON uses the "content.url" property which has been deprecated. Use "content.uri" instead.'),i=r.url),""===i?(c=new Cz(e,this),u=!0,d=WH.READY):(d=WH.UNLOADED,h=t.getDerivedResource({url:i}),PH.getServerKey(h.getUrlComponent()))}else c=new Cz(e,this),u=!0,d=WH.READY;this._content=c,this._contentResource=h,this._contentState=d,this.hasEmptyContent=u,this.hasMultipleContents=o,this.refine=g,this.children=[],this.parent=n,this._screenSpaceError=0,this._depthToCamera=0,this._centerZDepth=0,this._depth=0,this._refines=!1,this.priorityDeferred=!1,this._visible=!1,this._inRequestVolume=!0,this.contentExpired=!1,this._isInRequestVolume=!0,this._priority=0,this._priorityHolder=this,this._foveatedFactor=0;const I=new jD;"sphere"in i.boundingVolume&&I.setSphereData(...i.boundingVolume.sphere,this.computedTransform),"box"in i.boundingVolume&&I.setObbData(i.boundingVolume.box,this.computedTransform),"region"in i.boundingVolume&&I.setRegionData(...i.boundingVolume.region),this.boundingVolume=I}updatePriority(){const e=this.tileset,t=e.preferLeaves,i=e._minimumPriority,n=e._maximumPriority,s=Math.pow(10,8);Math.pow(10,9);let o=fK(this._depth,i.depth,n.depth);o=t?1-o:o;const r=function(e,t,i){const n=e*Math.pow(10,t);return parseInt(n,10)*Math.pow(10,i)}(fK(this._priorityHolder._distanceToCamera,i.distance,n.distance),4,0),a=this._priorityProgressiveResolution?0:s;fK(this._priorityHolder._foveatedFactor,i.foveatedFactor,n.foveatedFactor),this.priorityDeferred;const l=this.isVisible?0:Math.pow(10,10);this._priority=o+r+l+a}updateContent(e){const t=this.tileset;e.update(this),t.dispatchEvent({type:"loaded",tile:this})}process(e){this.contentReady||(this._selectedFrame=0,this.lastStyleTime=0,this._contentState=WH.READY,this.hasTilesetContent||this.hasImplicitContent||(e._statistics.incrementLoadCounts(this.content),++e._statistics.numberOfTilesWithContentReady,++e._statistics.numberOfLoadedTilesTotal,e._cache.add(this)));try{const t=this._content;t.isTileset3DTileContent?t.update(e):this.updateContent(t)}catch(t){this._contentState=WH.FAILED}}update(e){}cancelRequests(){this.hasMultipleContents?this._content.cancelRequests():this._request.cancel()}unloadContent(){if(!this.hasRenderableContent)return;const e=this._content;if(e){e.dispose();this.tileset.dispatchEvent({type:"dispose",tile:this}),this._content=null}this._contentState=WH.UNLOADED}requestContent(){if(!this.hasEmptyContent)return this.hasMultipleContents?function(e){let t=e._content;const i=e._tileset;if(!am(t)){const n=mK(e.content,"3DTILES_multiple_contents")?e._header.extensions["3DTILES_multiple_contents"]:e._header;t=new dK(i,e,e._contentResource.clone(),n),e._content=t}const n=t.requestInnerContents();if(am(n))return e._contentState=WH.LOADING,n.then((i=>{if(!e.isDestroyed()&&am(i))return e._contentState=WH.PROCESSING,t})).catch((t=>{if(!e.isDestroyed())return e._contentState=WH.FAILED,t}))}(this):CK(this)}visibility(){const e=this.boundingVolume,t=this._tileset._cameraInfo.frustum;e.intersectsFrustum(t,!0)?this._visible=!0:this._visible=!1}computeVisibility(e,t){const i=this.tileset.getCamera().frustum;return this.intersectBoundingVolume(e,i)}intersectBoundingVolume(e,t){}updateVisibility(e){const{tileset:t}=this;this._updatedVisibilityFrame!==t._updatedVisibilityFrame&&(this.updateTransform(),this._distanceToCamera=this.distanceToTile(),this._centerZDepth=this.distanceToTileCenter(e),this._screenSpaceError=this.getScreenSpaceError(),this._screenSpaceErrorProgressiveResolution=this.getScreenSpaceError(!1,this.tileset.progressiveResolutionHeightFraction),this._priorityProgressiveResolution=function(e,t){if(e.progressiveResolutionHeightFraction<=0||e.progressiveResolutionHeightFraction>.5)return!1;const i=e.screenSpaceError;let n=t._screenSpaceErrorProgressiveResolution>i;t._priorityProgressiveResolutionScreenSpaceErrorLeaf=!1;const s=t.parent,o=t._screenSpaceErrorProgressiveResolution<=i,r=am(s)&&s._screenSpaceErrorProgressiveResolution>i;return o&&r&&(t._priorityProgressiveResolutionScreenSpaceErrorLeaf=!0,n=!0),n}(t,this),this.priorityDeferred=function(e,t){const{tileset:i,boundingVolume:n}=e;n.getSphere(hK);const s=t._rendering.camera,o=hK.center,r=hK.radius,a=i._cameraInfo,l=IK.copy(a.directionWC).multiplyScalar(e._centerZDepth),g=pK.addVectors(a.position,l),c=pK.subVectors(g,o);if(c.length()>hK.radius){const t=pK.copy(c).normalize().multiplyScalar(r),i=pK.addVectors(o,t);pK.subVectors(i,a.position);const n=pK.normalize();e._foveatedFactor=1-Math.abs(a.directionWC.dot(n))}else e._foveatedFactor=0;const d=1-Math.cos(.5*s.fov),h=i.foveatedConeSize*d;if(e._foveatedFactor<=h)return!1;const u=d-h,I=Km.clamp((e._foveatedFactor-h)/u,0,1),p=i.foveatedInterpolationCallback(i.foveatedMinimumScreenSpaceErrorRelaxation,i.screenSpaceError,I),m=0===e._screenSpaceError&&am(e.parent)?.5*e.parent._screenSpaceError:e._screenSpaceError;return i.screenSpaceError-p<=4*m}(this,e),this.visibility(),this._updatedVisibilityFrame=t._updatedVisibilityFrame)}updateTransform(){this.geometricError=this._geometricError}distanceToTile(){const e=this.boundingVolume,t=this.tileset._cameraInfo;return e.distanceToPoint(t.position)}distanceToTileCenter(e){this.boundingVolume;const t=this._tileset._cameraInfo,i=this.boundingVolumeCenter;return uK.subVectors(i,t.position).dot(t.directionWC)}getScreenSpaceError(e,t){const i=this._tileset,n=lm(t,1),s=am(this.parent)?this.parent.geometricError:i._scaledGeometricError,o=e?s:this.geometricError;if(0===o)return 0;const r=i._cameraInfo;this.boundingVolume;const a=r.invScale;let l;if(r.isOrthographic){l=o/(r.pixelSize*a)}else{const e=Math.max(this._distanceToCamera,1e-7);if(l=o*n/(e*a*r.sseDenominator),i.dynamicScreenSpaceError){const t=i._dynamicScreenSpaceErrorComputedDensity,n=i.dynamicScreenSpaceErrorFactor,s=function(e,t){const i=e*t;return 1-Math.exp(-i*i)}(e,t)*n;l-=s}}return l}getDistance(){return 100}isDestroyed(){return!1}get contentReady(){return this._contentState===WH.READY}get contentAvailable(){return this.contentReady&&this.hasRenderableContent}get hasRenderableContent(){return!this.hasEmptyContent&&!this.hasTilesetContent&&!this.hasImplicitContent}get isVisible(){return this._visible&&this._inRequestVolume}get tileset(){return this._tileset}get hasUnloadedRenderableContent(){return this.hasRenderableContent&&this.contentUnLoaded}get contentUnLoaded(){return this._contentState===WH.UNLOADED}get content(){return this._content}get cached(){return this._content}get __visible(){const e=this._tileset;return this._selectedFrame===e._updatedVisibilityFrame}get boundingVolumeCenter(){const e=this.boundingVolume.obb||this.boundingVolume.regionObb;if(am(e))return e.center;return this.boundingVolume.sphere.center}}class yK{}const _K=new mi;class vK{static selectTile(e,t){e._wasSelectedLastFrame=!0;const{content:i,tileset:n}=e;e._selectedFrame=t.frameCount,n._selectedTiles.push(e)}static sortChildrenByDistanceToCamera(e,t){return 0===t._distanceToCamera&&0===e._distanceToCamera?t._centerZDepth-e._centerZDepth:t._distanceToCamera-e._distanceToCamera}static canTraverse(e){return 0!==e.children.length&&(!(!e.hasTilesetContent&&!e.hasImplicitContent)||e._screenSpaceError>e.tileset.screenSpaceError)}static visitTile(e,t){++e.tileset._statistics.visited,e._visitedFrame=t.frameCount}static touchTile(e,t){e._touchedFrame!==t.frameCount&&(e.tileset._cache.touch(e),e._touchedFrame=t.frameCount)}static loadTile(e,t){const{tileset:i}=e;e._requestedFrame!==t.frameCount&&e.hasUnloadedRenderableContent&&function(e){const{tileset:t}=e;if(!t._cullRequestsWhileMoving)return!0;const i=t._cameraInfo,{positionWCDeltaMagnitude:n,positionWCDeltaMagnitudeLastFrame:s}=i,o=0!==n?n:s;e.boundingVolume.getSphere(_K);const r=Math.max(2*_K.radius,1);return t.cullRequestsWhileMovingMultiplier*o/r<1}(e)&&(e._requestedFrame=t.frameCount,i._requestedTiles.push(e))}static updateTile(e,t){xK(e,t),e._wasMinPriorityChild=!1,e._priorityHolder=e,function(e){const t=e.tileset._minimumPriority,i=e.tileset._maximumPriority,n=e._priorityHolder;i.distance=Math.max(n._distanceToCamera,i.distance),t.distance=Math.min(n._distanceToCamera,t.distance),i.depth=Math.max(e._depth,i.depth),t.depth=Math.min(e._depth,t.depth),i.foveatedFactor=Math.max(n._foveatedFactor,i.foveatedFactor),t.foveatedFactor=Math.min(n._foveatedFactor,t.foveatedFactor)}(e),e._shouldSelect=!1,e._finalResolution=!0}}function xK(e,t){if(e.updateVisibility(t),!e.isVisible)return;const i=e.children.length>0;if((e.hasTilesetContent||e.hasImplicitContent)&&i){const i=e.children[0];return xK(i,t),void(e._visible=i._visible)}if(function(e){const{parent:t,tileset:i}=e;if(!am(t)||t.hasTilesetContent||t.hasImplicitContent||t.refine!==fP.ADD)return!1;return e.getScreenSpaceError(!0)<=i.screenSpaceError}(e))return void(e._visible=!1);const n=e.refine===fP.REPLACE,s=e._optimChildrenWithinParent===Iz.USE_OPTIMIZATION;return n&&s&&i&&!function(e,t){let i=!1;const n=e.children;for(let s=0;s<n.length;++s){const e=n[s];e.updateVisibility(t),i=i||e.isVisible}return i}(e,t)?(++e.tileset._statistics.numberOfTilesCulledWithChildrenUnion,void(e._visible=!1)):void 0}class BK{constructor(e=0){e=lm(e,0),this._array=new Array(e),this._length=e}get length(){return this._length}set length(e){const t=this._array,i=this._length;if(e<i)for(let n=e;n<i;++n)t[n]=void 0;else e>t.length&&(t.length=e);this._length=e}get values(){return this._array}get(e){return this._array[e]}set(e,t){e>=this._length&&(this.length=e+1),this._array[e]=t}peek(){return this._array[this._length-1]}push(e){const t=this.length++;this._array[t]=e}pop(){if(0===this._length)return;const e=this._array[this._length-1];return--this.length,e}reserve(e){e>this._array.length&&(this._array.length=e)}resize(e){this.length=e}trim(e){e=lm(e,this._length),this._array.length=e}}const wK={stack:new BK,stackMaximumLength:0},SK={stack:new BK,stackMaximumLength:0},GK={stack:new BK,stackMaximumLength:0};class MK{static selectTiles(e,t){e._requestedTiles.length=0,e._selectedTiles.length=0,e._selectedTilesToStyle.length=0,e._emptyTiles.length=0,e.hasMixedContent=!1;let i=e.root;if(vK.updateTile(i,t),!i.isVisible)return;if(i.getScreenSpaceError(!0)<e.screenSpaceError)return;!function(e,t){const{tileset:i}=e,{canTraverse:n,loadTile:s,visitTile:o,touchTile:r}=vK,a=wK.stack;a.push(e);for(;a.length>0;){wK.stackMaximumLength=Math.max(wK.stackMaximumLength,a.length);const e=a.pop(),l=e.parent,g=!am(l)||l._refines;let c=!0;if(n(e)){const i=TK(e,a,t);c=i.anyChildrenVisible,e._refines=i.refines&&g}else e._refines=!1;const d=!e._refines&&g;e.hasRenderableContent?e.refine===fP.ADD?(RK(e,t,c),s(e,t)):e.refine===fP.REPLACE&&(s(e,t),d&&RK(e,t,c)):(i._emptyTiles.push(e),s(e,t),d&&RK(e,t,c)),o(e,t),r(e,t)}}(i,t),wK.stack.trim(wK.stackMaximumLength),SK.stack.trim(SK.stackMaximumLength);const n=e._requestedTiles;for(let s=0;s<n.length;++s)n[s].updatePriority()}static forEachLoadedTile(e,t){const i=e.root;if(!am(i))return;const n=GK.stack;for(n.push(i);n.length>0;){const e=n.pop();e.children.forEach((e=>{n.push(e)}));const i=e.content;if(e.hasRenderableContent&&i){t(i.scene,e)}}}}function RK(e,t,i){const n=e.refine===fP.REPLACE,s=e._optimChildrenWithinParent===Iz.USE_OPTIMIZATION,o=e.children&&e.children.length>0,r=s&&o&&n;if(e.contentAvailable){if(r&&!i)return void++e.tileset._statistics.numberOfTilesCulledWithChildrenUnion;vK.selectTile(e,t)}}function TK(e,t,i){const n=e.refine===fP.REPLACE,{tileset:s,children:o}=e,{updateTile:r,loadTile:a,touchTile:l}=vK;for(let I=0;I<o.length;I++)r(o[I],i);o.sort(vK.sortChildrenByDistanceToCamera);const g=n&&e.hasRenderableContent;let c=!0,d=!1,h=-1,u=Number.MAX_VALUE;for(let I=0;I<o.length;++I){const e=o[I];if(e.isVisible?(t.push(e),e._foveatedFactor<u&&(h=I,u=e._foveatedFactor),d=!0):(g||s.loadSiblings)&&(e._foveatedFactor<u&&(h=I,u=e._foveatedFactor),a(e,i),l(e,i)),g){let t;t=!!e._isInRequestVolume&&(e.hasRenderableContent?e.contentAvailable:ZK(e,i)),c=c&&!(e.isVisible&&!t)}}if(d||(c=!1),-1!==h&&n){const t=o[h];t._wasMinPriorityChild=!0;const i=(e._wasMinPriorityChild||e===s.root)&&u<=e._priorityHolder._foveatedFactor?e._priorityHolder:e;i._foveatedFactor=Math.min(t._foveatedFactor,i._foveatedFactor),i._distanceToCamera=Math.min(t._distanceToCamera,i._distanceToCamera);for(let e=0;e<o.length;++e)o[e]._priorityHolder=i}return{refines:c,anyChildrenVisible:d}}function ZK(e,t){const{canTraverse:i,updateTile:n,loadTile:s,touchTile:o}=vK;let r=!0;const a=SK.stack;for(a.push(e);a.length>0;){SK.stackMaximumLength=Math.max(SK.stackMaximumLength,a.length);const e=a.pop(),l=e.children,g=l.length,c=!e.hasRenderableContent&&i(e);if(c||e.contentAvailable||(r=!1),n(e,t),e.isVisible||(s(e,t),o(e,t)),c)for(let t=0;t<g;++t){const e=l[t];a.push(e)}}return e.hasEmptyContent||r}class VK{constructor(e,t,i){const n=vP(t,"3DTILES_implicit_tiling")?t.extensions["3DTILES_implicit_tiling"]:t.implicitTiling;this.baseResource=e,this.geometricError=t.geometricError,this.metadataSchema=i;const s=t.boundingVolume;if(!(am(s.box)||am(s.region)||vP(s,"3DTILES_bounding_volume_S2")||vP(s,"3DTILES_bounding_volume_cylinder")))throw new Error("Only box, region, 3DTILES_bounding_volume_S2, and 3DTILES_bounding_volume_cylinder are supported for implicit tiling");this.boundingVolume=s,this.refine=t.refine,this.subtreeUriTemplate=new az({url:n.subtrees.uri}),this.contentUriTemplates=[],this.contentHeaders=[];const o=function(e){if(vP(e,"3DTILES_multiple_contents")){const t=e.extensions["3DTILES_multiple_contents"];return am(t.contents)?t.contents:t.content}if(am(e.contents))return e.contents;if(am(e.content))return[e.content];return[]}(t);for(let r=0;r<o.length;r++){const e=o[r];this.contentHeaders.push(cm(e,!0));const t=new az({url:e.uri});this.contentUriTemplates.push(t)}this.contentCount=this.contentHeaders.length,this.tileHeader=function(e){const t=cm(e,!0);am(t.extensions)&&(delete t.extensions["3DTILES_implicit_tiling"],delete t.extensions["3DTILES_multiple_contents"],0===Object.keys(t.extensions).length&&delete t.extensions);return delete t.implicitTiling,delete t.contents,delete t.content,t}(t),this.subdivisionScheme=DL[n.subdivisionScheme],this.branchingFactor=DL.getBranchingFactor(this.subdivisionScheme),this.subtreeLevels=n.subtreeLevels,am(n.availableLevels)?this.availableLevels=n.availableLevels:this.availableLevels=n.maximumLevel+1}}const WK={};function EK(e){return e=1431655765&((e=858993459&((e=252645135&((e=16711935&(e^e<<8))^e<<4))^e<<2))^e<<1)}function NK(e){return e=153391689&((e=51130563&((e=50393103&((e=50331903&(e^e<<16))^e<<8))^e<<4))^e<<2)}function FK(e){return e=65535&((e=16711935&((e=252645135&((e=858993459&((e&=1431655765)^e>>1))^e>>2))^e>>4))^e>>8)}function XK(e){return e=1023&((e=4278190335&((e=50393103&((e=51130563&((e&=153391689)^e>>2))^e>>4))^e>>8))^e>>16)}WK.encode2D=function(e,t){return(EK(e)|EK(t)<<1)>>>0},WK.decode2D=function(e,t){return am(t)||(t=new Array(2)),t[0]=FK(e),t[1]=FK(e>>1),t},WK.encode3D=function(e,t,i){return NK(e)|NK(t)<<1|NK(i)<<2},WK.decode3D=function(e,t){return am(t)||(t=new Array(3)),t[0]=XK(e),t[1]=XK(e>>1),t[2]=XK(e>>2),t};const HK=[0,0,0];class zK{constructor(e){this.subdivisionScheme=e.subdivisionScheme,this.subtreeLevels=e.subtreeLevels,this.level=e.level,this.x=e.x,this.y=e.y,this.z=void 0,e.subdivisionScheme===DL.OCTREE&&(this.z=e.z)}getDescendantCoordinates(e){const t=this.level+e.level,i=(this.x<<e.level)+e.x,n=(this.y<<e.level)+e.y;if(this.subdivisionScheme===DL.OCTREE){const s=(this.z<<e.level)+e.z;return new zK({subdivisionScheme:this.subdivisionScheme,subtreeLevels:this.subtreeLevels,level:t,x:i,y:n,z:s})}return new zK({subdivisionScheme:this.subdivisionScheme,subtreeLevels:this.subtreeLevels,level:t,x:i,y:n})}getAncestorCoordinates(e){const t=1<<e,i=this.level-e,n=Math.floor(this.x/t),s=Math.floor(this.y/t);if(this.subdivisionScheme===DL.OCTREE){const e=Math.floor(this.z/t);return new zK({subdivisionScheme:this.subdivisionScheme,subtreeLevels:this.subtreeLevels,level:i,x:n,y:s,z:e})}return new zK({subdivisionScheme:this.subdivisionScheme,subtreeLevels:this.subtreeLevels,level:i,x:n,y:s})}getOffsetCoordinates(e){const t=e.level-this.level,i=1<<t,n=e.x%i,s=e.y%i;if(this.subdivisionScheme===DL.OCTREE){const o=e.z%i;return new zK({subdivisionScheme:this.subdivisionScheme,subtreeLevels:this.subtreeLevels,level:t,x:n,y:s,z:o})}return new zK({subdivisionScheme:this.subdivisionScheme,subtreeLevels:this.subtreeLevels,level:t,x:n,y:s})}getChildCoordinates(e){const t=this.level+1,i=2*this.x+e%2,n=2*this.y+Math.floor(e/2)%2;if(this.subdivisionScheme===DL.OCTREE){const s=2*this.z+Math.floor(e/4)%2;return new zK({subdivisionScheme:this.subdivisionScheme,subtreeLevels:this.subtreeLevels,level:t,x:i,y:n,z:s})}return new zK({subdivisionScheme:this.subdivisionScheme,subtreeLevels:this.subtreeLevels,level:t,x:i,y:n})}getSubtreeCoordinates(){return this.getAncestorCoordinates(this.level%this.subtreeLevels)}getParentSubtreeCoordinates(){return this.getAncestorCoordinates(this.level%this.subtreeLevels+this.subtreeLevels)}isAncestor(e){const t=e.level-this.level;if(t<=0)return!1;const i=e.x>>t,n=e.y>>t,s=this.x===i,o=this.y===n;if(this.subdivisionScheme===DL.OCTREE){const i=e.z>>t,n=this.z===i;return s&&o&&n}return s&&o}isEqual(e){return this.subdivisionScheme===e.subdivisionScheme&&this.subtreeLevels===e.subtreeLevels&&this.level===e.level&&this.x===e.x&&this.y===e.y&&(this.subdivisionScheme!==DL.OCTREE||this.z===e.z)}isImplicitTilesetRoot(){return 0===this.level}isSubtreeRoot(){return this.level%this.subtreeLevels==0}isBottomOfSubtree(){return this.level%this.subtreeLevels==this.subtreeLevels-1}getTemplateValues(){const e={level:this.level,x:this.x,y:this.y};return this.subdivisionScheme===DL.OCTREE&&(e.z=this.z),e}static fromMortonIndex(e,t,i,n){let s;return e===DL.OCTREE?(s=WK.decode3D(n,HK),new zK({subdivisionScheme:e,subtreeLevels:t,level:i,x:s[0],y:s[1],z:s[2]})):(s=WK.decode2D(n,HK),new zK({subdivisionScheme:e,subtreeLevels:t,level:i,x:s[0],y:s[1]}))}static fromTileIndex(e,t,i){let n,s,o;return e===DL.OCTREE?(n=Math.floor(Math.log2(7*i+1)/3),s=((1<<3*n)-1)/7,o=i-s):(n=Math.floor(Math.log2(3*i+1)/2),s=((1<<2*n)-1)/3,o=i-s),zK.fromMortonIndex(e,t,n,o)}get childIndex(){let e=0;return e|=1&this.x,e|=(1&this.y)<<1,this.subdivisionScheme===DL.OCTREE&&(e|=(1&this.z)<<2),e}get mortonIndex(){return this.subdivisionScheme===DL.OCTREE?WK.encode3D(this.x,this.y,this.z):WK.encode2D(this.x,this.y)}get tileIndex(){return(this.subdivisionScheme===DL.OCTREE?((1<<3*this.level)-1)/7:((1<<2*this.level)-1)/3)+this.mortonIndex}}const LK=new Qt,DK=new Qt,KK=new Qt,YK=new Qt;new Qt,new Qt;function PK(e){const{latStart:t=-Math.PI/2,latEnd:i=Math.PI/2,lonStart:n=0,lonEnd:s=2*Math.PI,heightStart:o=0,heightEnd:r=0}=e,a=new ns(1,1,1,32,32),{normal:l,position:g}=a.attributes,c=g.clone();for(let d=0;d<g.count;++d){YK.fromBufferAttribute(g,d);const a=ft.mapLinear(YK.x,-.5,.5,t,i),l=ft.mapLinear(YK.y,-.5,.5,n,s);let c=o;YK.z<0&&(c=r),e.cartographicToCartesian(KK.set(l,a,c),YK),g.setXYZ(d,...YK)}a.computeVertexNormals();for(let d=0,h=c.count;d<h;d++){YK.fromBufferAttribute(c,d);const o=ft.mapLinear(YK.x,-.5,.5,t,i),r=ft.mapLinear(YK.y,-.5,.5,n,s);LK.fromBufferAttribute(l,d),e.geodeticSurfaceNormalCartographic(KK.set(r,o,0),DK),Math.abs(LK.dot(DK))>.1&&(YK.z>0&&DK.multiplyScalar(-1),l.setXYZ(d,...DK))}return a}class kK extends Ka{constructor(e=new zD,t=16776960){super(),this.ellipsoidRegion=e,this.material.color.set(t),this.update()}update(){const e=PK(this.ellipsoidRegion);this.geometry.dispose(),this.geometry=new gl(e,80)}dispose(){this.geometry.dispose(),this.material.dispose()}}const OK=new Qt,UK=["x","y","z"];class QK extends Ka{constructor(e,t=16776960,i=40){const n=new Fn,s=[];for(let o=0;o<3;o++){const e=UK[o],t=UK[(o+1)%3];OK.set(0,0,0);for(let n=0;n<i;n++){let o;o=2*Math.PI*n/(i-1),OK[e]=Math.sin(o),OK[t]=Math.cos(o),s.push(OK.x,OK.y,OK.z),o=2*Math.PI*(n+1)/(i-1),OK[e]=Math.sin(o),OK[t]=Math.cos(o),s.push(OK.x,OK.y,OK.z)}}n.setAttribute("position",new Bn(new Float32Array(s),3)),n.computeBoundingSphere(),super(n,new Wa({color:t,toneMapped:!1})),this.sphere=e,this.type="SphereHelper"}updateMatrixWorld(e){const t=this.sphere;this.position.copy(t.center),this.scale.setScalar(t.radius),super.updateMatrixWorld(e)}}const JK=Symbol("ORIGINAL_MATERIAL"),jK=()=>{},qK={};function $K(e){if(!qK[e]){const t=Math.random(),i=.5+.5*Math.random(),n=.375+.25*Math.random();qK[e]=(new In).setHSL(t,i,n)}return qK[e]}class eY{constructor(e){e={displayBoxBounds:!1,displaySphereBounds:!1,displayRegionBounds:!0,colorMode:0,maxDebugDepth:-1,maxDebugDistance:-1,maxDebugError:-1,customColorCallback:null,...e},this.name="DEBUG_TILES_PLUGIN",this.tiles=null,this.extremeDebugDepth=-1,this.extremeDebugError=-1,this.boxGroup=null,this.sphereGroup=null,this.regionGroup=null,this.displayBoxBounds=e.displayBoxBounds,this.displaySphereBounds=e.displaySphereBounds,this.displayRegionBounds=e.displayRegionBounds,this.colorMode=e.colorMode,this.maxDebugDepth=e.maxDebugDepth,this.maxDebugDistance=e.maxDebugDistance,this.maxDebugError=e.maxDebugError,this.customColorCallback=e.customColorCallback,this.getDebugColor=(e,t)=>{t.setRGB(e,e,e)}}init(e){this.tileset=e;const t=e.group;this.boxGroup=new qr,this.boxGroup.name="DebugTilesRenderer.boxGroup",t.add(this.boxGroup),this.boxGroup.updateMatrixWorld(),this.sphereGroup=new qr,this.sphereGroup.name="DebugTilesRenderer.sphereGroup",t.add(this.sphereGroup),this.sphereGroup.updateMatrixWorld(),this.regionGroup=new qr,this.regionGroup.name="DebugTilesRenderer.regionGroup",t.add(this.regionGroup),this.regionGroup.updateMatrixWorld(),this._onLoadTileSetCB=e=>{},this._onLoadTileCB=({scene:e,tile:t})=>{this._onLoadTile(t)},this._onDisposeTileCB=({tile:e})=>{this._onDisposeTile(e)},this._onUpdateAfterCB=()=>{this._onUpdateAfter()},this._onTileVisibilityChangeCB=({scene:e,tile:t,visible:i})=>{this._onTileVisibilityChange(t,i)},e.addEventListener("loaded",this._onLoadTileCB),e.addEventListener("dispose",this._onDisposeTileCB),e.addEventListener("update-after",this._onUpdateAfterCB),e.addEventListener("visibilitychange",this._onTileVisibilityChangeCB),e.traversalLoadedTile(((e,t)=>{this._onLoadTile(t)})),e._selectedTiles.forEach((e=>{this._onTileVisibilityChange(e,!0)}))}_onLoadTile(e){const t=e.content,i=e.boundingVolume,{obb:n,sphere:s,region:o,regionObb:r}=i,a=e.tileset._selectedTiles;if(n){const i=new qr;i.name="DebugTilesRenderer.boxHelperGroup",i.matrix.copy(n.transform),i.matrixAutoUpdate=!1;const s=new Rg(n.box,$K(e._depth));s.raycast=jK,i.add(s),t.boxHelperGroup=i,a.includes(e)&&this.displayBoxBounds&&(this.boxGroup.add(i),i.updateMatrixWorld())}if(s){const i=new QK(s,$K(e._depth));i.raycast=jK,t.sphereHelper=i,a.includes(e)&&this.displaySphereBounds&&(this.boxGroup.add(i),i.updateMatrixWorld())}if(o){const i=new kK(o,$K(e._depth));i.raycast=jK;const n=r.center;i.position.copy(n);const s=n.clone().multiplyScalar(-1);i.geometry.translate(...s),t.regionHelper=i,a.includes(e)&&this.displayRegionBounds&&(this.regionGroup.add(i),i.updateMatrixWorld(!0))}t.traverse((e=>{const t=e.material;t&&(e[JK]=t)}))}_onDisposeTile(e){const t=e.content;t.boxHelperGroup&&(t.boxHelperGroup.removeFromParent(),t.boxHelperGroup.children[0].geometry.dispose(),delete t.boxHelperGroup),t.sphereHelper&&(t.sphereHelper.removeFromParent(),t.sphereHelper.geometry.dispose(),delete t.sphereHelper),t.regionHelper&&(t.regionHelper.removeFromParent(),t.regionHelper.geometry.dispose(),delete t.regionHelper)}_initExtremes(e){}_onUpdateAfter(){this.tileset.root&&(this.boxGroup.visible=this.displayBoxBounds,this.sphereGroup.visible=this.displaySphereBounds,this.regionGroup.visible=this.displayRegionBounds)}_onTileVisibilityChange(e,t){const i=e.content,n=this.sphereGroup,s=this.boxGroup,o=this.regionGroup,r=i.boxHelperGroup,a=i.sphereHelper,l=i.regionHelper;t?(r&&(s.add(r),r.updateMatrixWorld(!0)),a&&(n.add(a),a.updateMatrixWorld(!0)),l&&(o.add(l),l.updateMatrixWorld(!0))):(r&&s.remove(r),a&&n.remove(a),l&&o.remove(l))}dispose(){const e=this.tileset;e.removeEventListener("loaded",this._onLoadTileCB),e.removeEventListener("dispose",this._onDisposeModelCB),e.removeEventListener("update-after",this._onUpdateAfterCB),e.removeEventListener("visibilitychange",this._onTileVisibilityChangeCB),e.traversalLoadedTile(((e,t)=>{this._onDisposeTile(t)})),this.boxGroup.removeFromParent(),this.sphereGroup.removeFromParent(),this.regionGroup.removeFromParent()}}const tY=parseInt(o,10)<165,iY=new Bi,nY=new xi,sY=new Qt,oY=[];function rY(e,t){return e.distance-t.distance}function aY(e,t,i){tY?(e.traverse((e=>{Object.getPrototypeOf(e).raycast.call(e,t,i)})),oY.sort(rY)):t.intersectObject(e,!0,i)}function lY(e,t,i,n=null){const{group:s}=e,o=t.content;null===n&&(n=nY,iY.copy(s.matrixWorld).invert(),n.copy(i.ray).applyMatrix4(iY));const r=[],a=t.children;for(let d=0;d<a.length;d++){const t=a[d];if(t._touchedFrame!==e._updatedVisibilityFrame)continue;null!==t.boundingVolume.intersectRay(n,sY)&&(sY.applyMatrix4(s.matrixWorld),r.push({distance:sY.distanceToSquared(i.ray.origin),tile:t}))}r.sort(rY);let l=null,g=null;const c=!t.isVisible&&t._touchedFrame===e._updatedVisibilityFrame;if((t.__visible||c)&&t.hasRenderableContent&&o){const e=function(e,t){aY(e,t,oY);const i=oY[0]||null;return oY.length=0,i}(o.scene,i);e&&(l=e,g=Math.pow(e.distance,2))}for(let d=0,h=r.length;d<h;d++){const t=r[d],s=t.distance,o=t.tile;if(s>g)break;const a=lY(e,o,i,n);if(a){const e=a.distance*a.distance;e<g&&(l=a,g=e)}}return l}function gY(e,t,i,n,s=null){const{group:o}=e,{content:r,boundingVolume:a}=t;if(null===s&&(s=nY,iY.copy(o.matrixWorld).invert(),s.copy(i.ray).applyMatrix4(iY)),t._touchedFrame!==e._updatedVisibilityFrame||!a.intersectsRay(s))return;const l=!t.isVisible&&t._touchedFrame===e._updatedVisibilityFrame;if((t.__visible||l)&&t.hasRenderableContent&&r)if(r.isMultiple3DTileContents){r._contents.forEach((e=>{const t=e.scene;t&&aY(t,i,n)}))}else{aY(r.scene,i,n)}const g=t.children;for(let c=0;c<g.length;c++)gY(e,g[c],i,n,s)}class cY{constructor(e){__publicField(this,"_tileMaxLevel",19),__publicField(this,"_subscribedMaxLodLevel",1),__publicField(this,"_elementHandlers",[]),__publicField(this,"_objectParent",null),__publicField(this,"subscribedDataTypeMap",{}),__publicField(this,"_active",!1),__publicField(this,"_configVersion",0),__publicField(this,"shouldIgnoreTile",(e=>e.__lodLevel>this._subscribedMaxLodLevel)),__publicField(this,"parseElements",(e=>{const t=e.cached.scene,i=t.batchTable&&t.batchTable.header;if(!i)return;if(!i.id||!i.dataType)return;const n=i.id,s=i.dataType,o={},r=new Map;let a=null,l=null,g=null;for(let c=0,d=s.length;c<d;c++){if(!this.subscribedDataTypeMap[s[c]])continue;a=s[c],l=this.subscribedDataTypeMap[a],g=n[c];const e={id:g,dataType:a,position:[],uv:[],normal:[],index:[]};o[c]=e;const t=r.get(l);t?t.push(e):r.set(l,[e])}for(const c of t.children)this.findElementInMesh(c,o,r);for(const c of r.keys()){const t=r.get(c);c.addTileElementObjects(e,t)}})),__publicField(this,"getInterleavedBufferValue2",((e,t)=>{const i=e.data.array,n=e.data.stride*t+e.offset;return[i[n],i[n+1]]})),__publicField(this,"getInterleavedBufferValue3",((e,t)=>{const i=e.data.array,n=e.data.stride*t+e.offset;return[i[n],i[n+1],i[n+2]]})),__publicField(this,"findElementInMesh",((e,t,i)=>{if(!e||!e.geometry)return;const n=e.geometry.getAttribute("_batchid");if(!n)return;const s=e.geometry.getAttribute("normal");if(!s)return;const o=e.geometry.getAttribute("position"),r=e.geometry.getAttribute("uv"),a=n.data.count,l={};let g=null;for(let d=0;d<a;d++){if(g=n.getX(d),!t[g])continue;let e=t[g],i=this.getInterleavedBufferValue3(o,d),a=this.getInterleavedBufferValue3(s,d),c=this.getInterleavedBufferValue2(r,d);e.position.push(i[0],i[1],i[2]),e.normal.push(a[0],a[1],a[2]),e.uv.push(c[0],c[1]),l[d]={batchId:g,index:e.position.length/3-1}}const c=e.geometry.index.array;for(let d=0,h=c.length-2;d<h;d+=3){let e=c[d];if(void 0===l[e])continue;let i=c[d+1],n=c[d+2],s=l[e],o=s.batchId,r=s.index,a=l[i]&&l[i].index,g=l[n]&&l[n].index;if(void 0===a||void 0===g){console.warn("one face includes more than one object");continue}t[o].index.push(r,a,g)}for(const d of Object.keys(t)){const e=t[d],i=new Fn;i.setAttribute("position",new Bn(new Float32Array(e.position),3)),i.setAttribute("normal",new Bn(new Float32Array(e.normal),3)),i.setAttribute("uv",new Bn(new Float32Array(e.uv),2)),i.setIndex(e.index),e.geometry=i}})),__publicField(this,"onTileLoad",((e,t)=>{this.parseTileInfo(e),this.shouldIgnoreTile(e)})),__publicField(this,"onTileDispose",((e,t)=>{if(!this.shouldIgnoreTile(e))for(const i of this._elementHandlers)i.disposeTileElementObjects(e)})),__publicField(this,"onTileShow",(e=>{this._active&&!this.shouldIgnoreTile(e)&&this.refreshTile(e)})),__publicField(this,"onTileHide",(e=>{if(this._active&&!this.shouldIgnoreTile(e))for(const t of this._elementHandlers)t.hideTileElementObjects(e)})),__publicField(this,"parseTileInfo",(e=>{const t=e._contentResource.url,i=t.substring(t.lastIndexOf("/")+1).split(".")[0],n=i.split("-");e.__id=i,e.__level=parseInt(n[0],10),e.__lodLevel=this._tileMaxLevel-e.__level})),__publicField(this,"refreshTile",(e=>{if(e.__elementsConfigVersion!==this._configVersion){for(const t of this._elementHandlers)t.disposeTileElementObjects(e);this.parseElements(e),e.__elementsConfigVersion=this._configVersion}for(const t of this._elementHandlers)t.showTileElementObjects(e)})),__publicField(this,"refreshTiles",(()=>{this.tilesRenderer.forEachLoadedModel(((e,t)=>{t.__visible&&!this.shouldIgnoreTile(t)&&this.refreshTile(t)})),this.engine.requestRender()})),this._objectParent=e}registerElement(e){e.parent=this._objectParent,e.engine=this.engine;for(const t of e.subscribedDataTypeIds)this.subscribedDataTypeMap[t]=e;return this._elementHandlers.push(e),this._configVersion++,this._active=!0,this.refreshTiles(),e}unregisterElement(e){for(let i of Object.keys(this.subscribedDataTypeMap))this.subscribedDataTypeMap[i]===e&&delete this.subscribedDataTypeMap[i];let t=this._elementHandlers.indexOf(e);t>-1&&(e.dispose(),this._elementHandlers.splice(t,1)),this._configVersion++,this._active=this._elementHandlers.length>0,this.refreshTiles()}tick(e){if(this._active)for(const t of this._elementHandlers)t.tick(e)}get subscribedMaxLodLevel(){return this._subscribedMaxLodLevel}set subscribedMaxLodLevel(e){this._subscribedMaxLodLevel=e}}class dY{constructor(e){const t=(e=lm(e,{})).tileset,i=e.class,n=am(t.properties)?t.properties:{};this._class=i,this._properties=n,this._extras=t.extras,this._extensions=t.extensions}hasProperty(e){return wF.hasProperty(e,this._properties,this._class)}hasPropertyBySemantic(e){return wF.hasPropertyBySemantic(e,this._properties,this._class)}getPropertyIds(e){return wF.getPropertyIds(this._properties,this._class,e)}getProperty(e){return wF.getProperty(e,this._properties,this._class)}setProperty(e,t){return wF.setProperty(e,t,this._properties,this._class)}getPropertyBySemantic(e){return wF.getPropertyBySemantic(e,this._properties,this._class)}setPropertyBySemantic(e,t){return wF.setPropertyBySemantic(e,t,this._properties,this._class)}get class(){return this._class}get extra(){return this._extras}get extensions(){return this._extensions}}class hY{constructor(e={}){e=lm(e,{});const{id:t,group:i,class:n}=e;this._id=t,this._class=n,this._properties=am(i.properties)?i.properties:{},this._extras=i.extras,this._extensions=i.extensions}get class(){return this._class}get id(){return this._id}get extras(){return this._extras}get extensions(){return this._extensions}hasProperty(e){return wF.hasProperty(e,this._properties,this._class)}hasPropertyBySemantic(e){return wF.hasPropertyBySemantic(e,this._properties,this._class)}getPropertyIds(e){return wF.getPropertyIds(this._properties,this._class,e)}getProperty(e){return wF.getProperty(e,this._properties,this._class)}setProperty(e,t){return wF.setProperty(e,t,this._properties,this._class)}getPropertyBySemantic(e){return wF.getPropertyBySemantic(e,this._properties,this._class)}setPropertyBySemantic(e,t){return wF.setPropertyBySemantic(e,t,this._properties,this._class)}}class uY{constructor(e){const t=(e=lm(e,{})).metadataJson,i=e.schema,n=lm(t.metadata,t.tileset);let s;am(n)&&(s=new dY({tileset:n,class:i.classes[n.class]}));let o=[];const r=[],a=t.groups;if(Array.isArray(a)){const e=a.length;for(let t=0;t<e;t++){const e=a[t];r.push(new hY({group:e,class:i.classes[e.class]}))}}else if(am(a)){o=Object.keys(a).sort();const e=o.length;for(let t=0;t<e;t++){const e=o[t];if(a.hasOwnProperty(e)){const t=a[e];r.push(new hY({id:e,group:a[e],class:i.classes[t.class]}))}}}this._schema=i,this._groups=r,this._groupIds=o,this._tileset=s,this._statistics=t.statistics,this._extras=t.extras,this._extensions=t.extensions}get schema(){return this._schema}get groups(){return this._groups}get groupIds(){return this._groupIds}get tileset(){return this._tileset}get statistics(){return this._statistics}get extras(){return this._extras}get extensions(){return this._extensions}}const IY={};function pY(e,t){const i=lm(e._ionRoot,e),n=i._ionEndpointResource,s="undefined"!=typeof Image;return am(t)&&(401===t.statusCode||s&&t.target instanceof Image)?(am(i._pendingPromise)||(i._pendingPromise=n.fetchJson().then((function(e){return i._ionEndpoint=e,e})).finally((function(e){return i._pendingPromise=void 0,e}))),i._pendingPromise.then((function(t){return e._ionEndpoint=t,!0}))):Promise.resolve(!1)}IY.defaultAccessToken="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1ZjJlYTllMy1kYWRiLTQwYjctOGZhOS02NGJkOTJhYTA1ODUiLCJpZCI6MjU5LCJpYXQiOjE3Mjc3OTI2NzB9.XbfI79d1v3T5OpMl4CznrcBuctSfW1lycPWlt8bq_1A",IY.defaultServer=new az({url:"https://api.cesium.com/"});const mY=class extends az{constructor(e,t){let i;const n=e.externalType,s=am(n);if(s){if("3DTILES"!==n&&"STK_TERRAIN_SERVER"!==n)throw new Error("Ion.createResource does not support external imagery assets; use IonImageryProvider instead.");i={url:e.options.url}}else i={url:e.url,retryAttempts:1,retryCallback:pY};super(i),this._ionEndpoint=e,this._ionEndpointDomain=s?void 0:new sm(e.url).authority(),this._ionEndpointResource=t,this._ionRoot=void 0,this._pendingPromise=void 0,this._credits=void 0,this._isExternal=s}static fromAssetId(e,t){const i=mY._createEndpointResource(e,t);return i.fetchJson().then((function(e){return new mY(e,i)}))}clone(e){const t=lm(this._ionRoot,this);return am(e)||(e=new mY(t._ionEndpoint,t._ionEndpointResource)),(e=az.prototype.clone.call(this,e))._ionRoot=t,e._isExternal=this._isExternal,e}fetchImage(e){if(!this._isExternal){const t=e;e={preferBlob:!0},am(t)&&(e.flipY=t.flipY,e.preferImageBitmap=t.preferImageBitmap)}return az.prototype.fetchImage.call(this,e)}_makeRequest(e){return this._isExternal||new sm(this.url).authority()!==this._ionEndpointDomain||(am(e.headers)||(e.headers={}),e.headers.Authorization=`Bearer ${this._ionEndpoint.accessToken}`,e.headers["X-Cesium-Client"]="CesiumJS","undefined"!=typeof CESIUM_VERSION&&(e.headers["X-Cesium-Client-Version"]=CESIUM_VERSION)),az.prototype._makeRequest.call(this,e)}};let AY=mY;__publicField(AY,"_createEndpointResource",(function(e,t){t=lm(t,{});let i=lm(t.server,IY.defaultServer);const n=lm(t.accessToken,IY.defaultAccessToken);i=az.createIfNeeded(i);const s={url:`v1/assets/${e}/endpoint`};return am(n)&&(s.queryParameters={access_token:n}),i.getDerivedResource(s)}));let CY=new qt;new Bi,new xi;let fY=new mi,bY=new Bi,yY=new Bi,_Y=new Bi;const vY=new Bi,xY=new Bi,BY=new Bi;let wY=new Bi,SY=new ts,GY=[],MY=new Qt,RY=new Dt;new Qt;const TY=new Qt,ZY=new Bi,VY=new Qt;class WY extends gx{constructor(e,t){super(),__publicField(this,"type","InstancedMesh"),__publicField(this,"isMesh",!0),__publicField(this,"isInstancedMesh",!0),__publicField(this,"frustumCulled",!1),__publicField(this,"instanceColor",null),__publicField(this,"count",0),__publicField(this,"instanceMatrix"),__publicField(this,"_enableInstanceColor",!1),__publicField(this,"instanceMorphMatrix",new Bi),__publicField(this,"isEventEntitySupported",!0),__publicField(this,"boundingBox",null),__publicField(this,"boundingSphere",null),__publicField(this,"getInstanceLocalMatrix",((e,t,i,n)=>null)),__publicField(this,"getEcefTransformMatrix",((e,t,i)=>{const n=this.engine.map.isGlobe,s=new Bi;if(n){const t=bA.eastNorthUpToFixedFrame(VY.fromArray(e)),i=ZY.extractRotation(t);s.multiply(i)}return s})),__publicField(this,"addCustomAttributes",(()=>{})),this.parameters={},this.geometry=e,this.material=t,this.instanceMatrix=new Ba(new Float32Array(0),16)}set enableInstanceColor(e){e!==this._enableInstanceColor&&(this._enableInstanceColor=e,this.needsUpdate=!0)}get enableInstanceColor(){return this._enableInstanceColor}collisionTest(e){let t=this.material.keepSize?this.size:0;return{width:t,height:t}}_updateData(){const{visiblePropName:e="visible",vertexVisible:t=!1}=this.parameters,i=this.engine.map.isGlobe;let n=[];n=this._enableCollision&&this._collisionData?this._collisionData:this.dataSource.userData;const s=[],o=[],r=[],a=[];let l=1/0,g=1/0,c=1/0,d=-1/0,h=-1/0,u=-1/0;for(let p=0;p<n.length;p++){const e=n[p].position,[t,i,s=0]=e;t<l&&(l=t),t>d&&(d=t),i<g&&(g=i),i>h&&(h=i),s<c&&(c=s),s>u&&(u=s)}let I=[(l+d)/2,(g+h)/2,(c+u)/2||0];for(let p=0;p<n.length;p++){const l=n[p].position;n[p].index;const g=n[p][e];if(t&&!1===g)continue;const c=this.dataSource.getDataItem(p),d=this.getInstanceLocalMatrix(l,c,p,n[p]);xY.makeTranslation(l[0]-I[0],l[1]-I[1],(l[2]||0)-I[2]);const h=this.getEcefTransformMatrix(l,c,p);vY.identity(),this.constructor===WY&&(BY.extractRotation(h),vY.multiplyMatrices(vY,BY)),d&&vY.multiplyMatrices(vY,d),vY.multiplyMatrices(xY,vY);const u=vY.elements;if(s.push(u[0],u[1],u[2],u[3],u[4],u[5],u[6],u[7],u[8],u[9],u[10],u[11],u[12],u[13],u[14],u[15]),i){const e=h.elements;o.push(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}if(r.push(Math.random()),this._enableInstanceColor){let e=cy(n[p].color);a.push(e[0],e[1],e[2])}}i&&this.geometry.setAttribute("ecefMatrix",new Ba(new Float32Array(o),16)),this.geometry.setAttribute("instancedRandomFactor",new Ba(new Float32Array(r),1)),this.addCustomAttributes(this.geometry,this.dataSource),this.geometry.computeBoundingSphere(),this.geometry.instanceCount=s.length/16,this.instanceMatrix=new Ba(new Float32Array(s),16),this._enableInstanceColor&&(this.instanceColor=new Ba(new Float32Array(a),3)),this.count=this.geometry.instanceCount,this.makeMeshPositionOffset(I),this.needsUpdate=!1}setBufferData(e){if(!e)return;const t=e.id.length;0!==t&&(this.count=t,this.geometry.instanceCount=t,e.instanceMatrix?this.instanceMatrix=new Ba(new Float32Array(e.instanceMatrix),16):this.computeTempMatrix(e))}computeTempMatrix(e){const t=this.engine.map.isGlobe;e.id;const i=e.translation,n=e.scale,s=e.rotation,o=[],r=[];let a=new Bi,l=new Qt,g=new Qt,c=new Ei,d=new Ut,h=1/0,u=1/0,I=1/0,p=-1/0,m=-1/0,A=-1/0;for(let f=0;f<this.count;f++){let e=3*f;const t=i[e],n=i[e+1],s=i[e+2];t<h&&(h=t),t>p&&(p=t),n<u&&(u=n),n>m&&(m=n),s<I&&(I=s),s>A&&(A=s)}let C=[(h+p)/2,(u+m)/2,(I+A)/2||0];for(let f=0;f<this.count;f++){let e=3*f;n?g.set(n[e],n[e+1],n[e+2]):g.set(1,1,1),i?l.set(i[e]-C[0],i[e+1]-C[1],i[e+2]-C[2]):l.set(0,0,0),TY.set(0,0,0),s&&TY.set(s[e],s[e+1],s[e+2]);const h=[i[e],i[e+1],i[e+2]];if(t){const e=this.getEcefTransformMatrix(h).elements;r.push(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}c.set(TY.x,TY.y,TY.z,"ZYX"),d.setFromEuler(c),a.compose(l,d,g),e=16*f;const u=a.elements;for(let t=0;t<16;t++)o[e+t]=u[t]}t&&this.geometry.setAttribute("ecefMatrix",new Ba(new Float32Array(r),16)),this.geometry.computeBoundingSphere(),this.instanceMatrix=new Ba(new Float32Array(o),16),this.makeMeshPositionOffset(C)}computeBoundingBox(){const e=this.geometry,t=this.count;null===this.boundingBox&&(this.boundingBox=new qt),null===e.boundingBox&&e.computeBoundingBox(),this.boundingBox.makeEmpty();for(let i=0;i<t;i++)this.getMatrixAt(i,bY),CY.copy(e.boundingBox).applyMatrix4(bY),this.boundingBox.union(CY)}computeBoundingSphere(){const e=this.geometry,t=this.count;null===this.boundingSphere&&(this.boundingSphere=new mi),null===e.boundingSphere&&e.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let i=0;i<t;i++)this.getMatrixAt(i,bY),fY.copy(e.boundingSphere).applyMatrix4(bY),this.boundingSphere.union(fY)}getMatrixAt(e,t){t.fromArray(this.instanceMatrix.array,16*e)}computeInstanceMorphMatrix(){const e=this.material;let t=e.height||0,i=1;if(e.keepSize&&(i=e.zoomUnits||1),e.isUseSize3){const t=e.size3;MY.set(t[0]*i,t[1]*i,t[2]*i)}else if(e.isUseSize2){const t=e.size2;MY.set(t[0]*i,t[1]*i,i)}else{let t=e.size||1;MY.set(t*i,t*i,t*i)}this.instanceMorphMatrix.identity().scale(MY).premultiply(wY.identity().makeTranslation(0,0,t*i))}getEntityByIndex(e){const t=this.dataSource;this._enableCollision&&this._collisionData&&(e=this._collisionData[e].index);const i={index:e,value:t.getDataItem(e),itemIndex:t.getDataItemIndex(e),pairs:{}},n=t.data;for(const s of Object.keys(n))i.pairs[s]=n[s][e];return i}raycast(e,t){if(!this.visible)return;let i=this.geometry,n=this.material,s=this.matrixWorld;if(!n||!i)return;const o=this.instanceMatrix;if(!o)return;const r=o.array;this.computeInstanceMorphMatrix();const a=this.count;if(SY.geometry=this.geometry.getInstanceGeometry?this.geometry.getInstanceGeometry():this.geometry,SY.material=n,n.isInstancedBallonMaterial){const i=e.camera,o=n.resolution,l=e.mouse,g=n.size/o[0],c=n.size/o[1],d=2*(n.height+n.size/2)/o[1],h=l.x-g,u=l.x+g,I=l.y-c-d,p=l.y+c-d;wY.multiplyMatrices(i.matrixWorldInverse,s),wY.multiplyMatrices(i.projectionMatrix,wY);for(let n=0;n<a;++n)if(_Y.fromArray(r,16*n),RY.set(0,0,0,1).applyMatrix4(_Y).applyMatrix4(wY).divideScalar(RY.w),RY.x>=h&&RY.y>=I&&RY.x<=u&&RY.y<=p){MY.set(_Y.elements[12],_Y.elements[13],_Y.elements[14]);const i=e.ray.origin.distanceTo(MY);i>=e.near&&i<=e.far&&(GY[0]={distance:i,point:MY.clone(),itemIndex:n,object:this},t.push(GY[0]),GY.length=0)}}else for(let l=0;l<a;++l)_Y.fromArray(r,16*l),yY.multiplyMatrices(_Y,this.instanceMorphMatrix),yY.multiplyMatrices(s,yY),SY.matrixWorld=yY,SY.raycast(e,GY),GY.length>0&&(GY[0].instanceId=l,GY[0].object=this,t.push(GY[0]),GY.length=0)}}class EY extends WY{constructor(){super(...arguments),__publicField(this,"isInstancedPointMesh",!0)}}let NY=new qt,FY=new Qt;class XY extends og{constructor(){super(...arguments),__publicField(this,"isCustomInstancedBufferGeometry",!0),__publicField(this,"instanceGeometry",null)}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new qt);const e=this.attributes.instancedPosition;void 0!==e?this.boundingBox.setFromBufferAttribute(e):this.boundingBox.makeEmpty(),(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('CustomInstancedBufferGeometry.computeBoundingBox: Computed min/max have NaN values.The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new mi);let e=this.attributes.instancedPosition;if(e){let t=this.boundingSphere.center;NY.setFromBufferAttribute(e),NY.getCenter(t);let i=0;for(let n=0,s=e.count;n<s;n++)FY.fromBufferAttribute(e,n),i=Math.max(i,t.distanceToSquared(FY));this.boundingSphere.radius=Math.sqrt(i),1===e.count&&(this.boundingSphere.radius=1e5),isNaN(this.boundingSphere.radius)&&console.error('CustomInstancedBufferGeometry.computeBoundingSphere(): Computed radius is NaN.The "position" attribute is likely to have NaN values.',this)}}getInstanceGeometry(){return this.instanceGeometry||(this.instanceGeometry=new Fn,this.instanceGeometry.attributes=this.attributes,this.instanceGeometry.index=this.index),this.instanceGeometry}}class HY extends XY{constructor(){super(),__publicField(this,"setModelData",(()=>{this.setAttribute("position",new Mn([-.5,0,0,-.5,0,1,.5,0,1,.5,0,0],3)),this.setAttribute("uv",new Mn([0,0,0,1,1,1,1,0],2)),this.setIndex([0,2,1,0,3,2])})),this.setModelData()}}const zY=as.merge([ws.lights,{tDiffuse:{value:null},tNormal:{value:null}}]);class LY extends mx{constructor(e={}){super(),this.name="BillboardTreeMaterial",this.type="BillboardTreeMaterial",this.isBillboardTreeMaterial=!0,this.side=2,this.lights=!0,this.transparent=!1,this.vertexShader="#define GLSLIFY 1\nvarying vec2 vUv;\nvarying vec3 vPosition;\n// varying vec3 vNormal;\nvarying float vRadian;\nvarying float vCameraRotation;\n\n#ifdef IS_GLOBE\n    attribute mat4 ecefMatrix;\n#endif\n\n#include <common>\n#include <logdepthbuf_pars_vertex>\n#include <normal_pars_vertex>\n\nmat4 removeRotation(mat4 matrix) {\n    // 提取缩放部分\n    vec3 scale;\n    scale.x = length(matrix[0].xyz);\n    scale.y = length(matrix[1].xyz);\n    scale.z = length(matrix[2].xyz);\n\n    // 构建无旋转但保留缩放的矩阵\n    mat3 scaleMatrix = mat3(\n        vec3(scale.x, 0.0, 0.0),\n        vec3(0.0, scale.y, 0.0),\n        vec3(0.0, 0.0, scale.z)\n    );\n\n    // 构建新的 matrix，去掉旋转部分\n    mat4 newMatrix = mat4(\n        vec4(scaleMatrix[0], 0.0),\n        vec4(scaleMatrix[1], 0.0),\n        vec4(scaleMatrix[2], 0.0),\n        matrix[3] // 保持原来的平移部分\n    );\n\n    return newMatrix;\n}\n\nvoid main() {\n    vUv = uv;\n\n    vec3 transformed = vec3(position);\n\n    // 计算平面的中心点\n    vec4 centerPosition = (modelMatrix * instanceMatrix * vec4(0.0, 0.0, 0.0, 1.0));\n    vPosition = centerPosition.xyz;\n\n    // 计算面向相机的旋转矩阵（仅绕Z轴旋转）\n    vec3 toCamera = normalize(centerPosition.xyz - cameraPosition);\n\n    #ifdef IS_GLOBE\n        mat4 ecefMatrixInverse = inverse(ecefMatrix);\n        toCamera = (ecefMatrixInverse * vec4(toCamera, 0.0)).xyz;\n    #endif\n\n    // vNormal = toCamera;\n    // vNormal = viewMatrix[2].xyz;\n    // #include <beginnormal_vertex>\n    // #include <defaultnormal_vertex>\n    // #include <normal_vertex>\n\n    float angleZ = atan(toCamera.x, toCamera.y);\n    float cosAngle = cos(angleZ);\n    float sinAngle = sin(angleZ);\n\n    vCameraRotation = angleZ;\n\n    mat4 faceCameraMatrix = mat4(\n        vec4(cosAngle,-sinAngle, 0.0, 0.0),\n        vec4(sinAngle, cosAngle, 0.0, 0.0),\n        vec4(0.0, 0.0, 1.0, 0.0),\n        vec4(0.0, 0.0, 0.0, 1.0)\n    );\n\n    mat4 currentInstanceMatrix = removeRotation(instanceMatrix);\n    #ifdef IS_GLOBE\n        currentInstanceMatrix = currentInstanceMatrix * ecefMatrix;\n    #endif\n\n    // 顶点数据中带的额外旋转\n    vRadian = atan(instanceMatrix[1][0], instanceMatrix[0][0]);\n\n    gl_Position = projectionMatrix * modelViewMatrix * currentInstanceMatrix * faceCameraMatrix * vec4(transformed, 1.0);\n\n    #include <logdepthbuf_vertex>\n}",this.fragmentShader="#define GLSLIFY 1\nuniform sampler2D tDiffuse;\nuniform sampler2D tNormal;\n\nvarying vec2 vUv;\nvarying vec3 vPosition;\nvarying float vRadian;\nvarying float vCameraRotation;\n\n#include <common>\n#include <packing>\n#include <logdepthbuf_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n\nvec2 getUVCoordinates(vec3 center) {\n    const int NUM_ROWS = 5;\n    const int NUM_COLS = 5;\n    const int TOTAL_IMAGES = NUM_ROWS * NUM_COLS;\n\n    // 计算面向相机的角度（仅考虑Z轴旋转）\n    float radian = vCameraRotation + vRadian;\n\n    // 计算离散角度区间的索引\n    float intervalSize = 2.0 * PI / float(TOTAL_IMAGES);\n    int index = int(floor((radian + PI) / intervalSize));\n\n    // 确保索引在 [0, TOTAL_IMAGES - 1] 范围内\n    index = (index % TOTAL_IMAGES + TOTAL_IMAGES) % TOTAL_IMAGES;\n\n    // Calculate the grid coordinates\n    int x = index % NUM_COLS;\n    int y = index / NUM_COLS;\n\n    // x轴翻转，相机顺时针旋转时，纹理按顺序切换\n    x = NUM_COLS - 1 - x;\n\n    // Calculate the UV coordinates\n    float u_min = float(x) / float(NUM_COLS);\n    float u_max = float(x + 1) / float(NUM_COLS);\n    float v_min = float(y) / float(NUM_ROWS);\n    float v_max = float(y + 1) / float(NUM_ROWS);\n\n    // Calculate the new UV coordinates\n    vec2 newUV;\n    newUV.x = clamp(mix(u_min, u_max, vUv.x), u_min, u_max);\n    newUV.y = clamp(mix(v_min, v_max, vUv.y), v_min, v_max);\n\n    return newUV;\n}\n\nvoid main() {\n    vec2 uv = getUVCoordinates(vPosition);\n\n    vec4 viewNormal = texture2D(tNormal, uv);\n    vec3 normal = unpackRGBToNormal(viewNormal.xyz);\n\n    vec4 diffuseColor = texture2D(tDiffuse, uv);\n    if (diffuseColor.a < 0.3) {\n        discard;\n    }\n\n    #if ( NUM_DIR_LIGHTS > 0 )\n        float normalLightIntensity = dot(normal, directionalLights[0].direction);\n        gl_FragColor = vec4(diffuseColor.rgb * normalLightIntensity, diffuseColor.a);\n    #else \n        gl_FragColor = diffuseColor;\n    #endif\n\n    #ifdef OPAQUE\n        gl_FragColor.a = 1.0;\n    #endif\n\n    #include <logdepthbuf_fragment>\n    #include <colorspace_fragment>\n}\n",Object.assign(this.uniforms,as.clone(zY)),fy(this,["tDiffuse","tNormal"]),_y(this,[["isGlobe","IS_GLOBE"]]),this.setValues(e)}}const DY=new Dl;let KY=null,YY=null;class PY extends EY{constructor(e={}){super(e),__publicField(this,"geometry"),__publicField(this,"material"),__publicField(this,"getInstanceLocalMatrix",((e,t,i,n)=>{const s=new Bi,o=new Bi,r=n.rotation;"number"==typeof r?o.makeRotationZ(r):r instanceof Array?o.makeRotationFromEuler(new Ei(r[1],r[2],r[3])):r instanceof Qt&&o.makeRotationFromEuler(new Ei(r.x,r.y,r.z));const a=new Bi,l=n.scale;return"number"==typeof l?a.makeScale(l,l,l):l instanceof Array?a.makeScale(l[0],l[1],l[2]):l instanceof Qt&&a.makeScale(l.x,l.y,l.z),s.multiplyMatrices(a,o),s})),this.parameters=e;let t=null,i=null;this.parameters.diffuseTexture&&this.parameters.normalTexture?(t=this.parameters.diffuseTexture,i=this.parameters.normalTexture):(KY||(KY=DY.load(mm("assets/textures/tree/hill_tree_billboard.png")),YY=DY.load(mm("assets/textures/tree/hill_tree_billboard_normal.png"))),t=KY,i=YY),t.colorSpace=Ye,t.wrapS=t.wrapT=M,t.minFilter=t.magFilter=W,this.geometry=new HY,this.material=new LY,this.geometry.scale(10,10,10),this.material.tDiffuse=t,this.material.tNormal=i}initObject(){this.material.isGlobe=this.engine.map.isGlobe}}const kY=new Bi,OY=new Bi,UY=new Qt,QY=new Qt;class JY extends Ji{constructor(e,t){if(super(),__publicField(this,"isEventEntitySupported",!0),__publicField(this,"_meshes",[]),__publicField(this,"_idIndexMap",{}),__publicField(this,"_indexIdMap",{}),__publicField(this,"_matrixAttribute",null),__publicField(this,"_count",0),__publicField(this,"_rtc",null),__publicField(this,"updateRenderingMesh",(()=>{this._cleanOldMesh();const e=this._meshes,t=e.length;for(let i=0;i<t;++i){const t=e[i],n=new Va(t.geometry,t.material);n.__eventProxyByParent=!0,n.castShadow=t.castShadow,n.receiveShadow=t.receiveShadow,n.parent=this,n.name=t.name,this.add(n),t.isInstancedMesh&&(n._isOriginalInstancedMesh=!0,n._rawInstanceMatrix=t.instanceMatrix,n._rawCount=t.count)}})),__publicField(this,"_cleanOldMesh",(()=>{const e=this.children;for(let t=e.length-1;t>=0;t--){const i=e[t];this.remove(i),i.dispose()}})),e)this._meshes=e;else{const e=this._defaultMesh=new ts(new ns(1,1,1),new Cn({color:16777215}));this._meshes=[e]}this.updateRenderingMesh(),this._matrixAttribute=new Ba(new Float32Array(16*t),16),this._initialized=!0}afterAddToEngine(e){this.engine=e}beforeRemoveFromEngine(e){this.dispose()}getEntityByIndex(e){const t=this._indexIdMap[e];if(void 0===t)return null;const i={id:t,index:e};return i.matrix=this._matrixAttribute.array.slice(16*e,16*(e+1)),i}has(e){return void 0!==this._idIndexMap[e]}clear(){this._idIndexMap={},this._indexIdMap={},this._rtc=null}setBufferData(e){if(this.clear(),!e)return;const t=e.id.length;0!==t&&(this.count=t,e.instanceMatrix?this._matrixAttribute.array.set(e.instanceMatrix,16*this._count):this.computeTempMatrix(e))}computeTempMatrix(e){const t=e.id,i=e.translation,n=e.scale,s=e.rotation,o=this._matrixAttribute.array;let r=new Bi,a=new Qt,l=new Qt,g=new Ei,c=new Ut,d=null,h=null,u=this._rtc;u||(i?(u=[i[0],i[1],i[2]],this._rtc=u,this.position.set(u[0],u[1],u[2])):u=[0,0,0]);for(let I=0;I<this._count;I++){let e=3*I;if(n?l.set(n[e],n[e+1],n[e+2]):l.set(1,1,1),i?a.set(i[e]-u[0],i[e+1]-u[1],i[e+2]-u[2]):a.set(0,0,0),QY.set(0,0,0),s&&QY.set(s[e],s[e+1],s[e+2]),this.engine&&this.engine.map.isGlobe){const t={heading:-QY.z,pitch:-QY.y,roll:QY.x},n=bA.headingPitchRollToFixedFrame(UY.set(i[e],i[e+1],i[e+2]),t);g.setFromRotationMatrix(n,"ZYX")}else g.set(QY.x,QY.y,QY.z,"ZYX");c.setFromEuler(g),r.compose(a,c,l),e=16*I;const p=r.elements;for(let t=0;t<16;t++)o[e+t]=p[t];d=t[I],h=I,this._idIndexMap[d]=h,this._indexIdMap[h]=d}}update(){if(!this._initialized)return;const e=this.children;this._matrixAttribute.needsUpdate=!0;for(const t of e){if(t._isOriginalInstancedMesh){const e=t._rawCount*this._count,i=new Float32Array(16*e);for(let n=0;n<this._count;n++){kY.fromArray(this._matrixAttribute.array,16*n);for(let e=0;e<t._rawCount;e++)OY.fromArray(t._rawInstanceMatrix.array,16*e),OY.multiplyMatrices(kY,OY),i.set(OY.elements,16*(n*t._rawCount+e))}t.instanceMatrix=new Ba(i,16),t.count=e}else t.instanceMatrix=this._matrixAttribute,t.count=this._count;t.frustumCulled=!1,t.computeBoundingSphere(),t.instanceMatrix.needsUpdate=!0}}dispose(){this._cleanOldMesh(),this._defaultMesh&&(this._defaultMesh.geometry.dispose(),this._defaultMesh.material.dispose())}raycast(e,t){this.visible?this.traverse((e=>{e.isMesh&&e._originRaycast&&(e.raycast=e._originRaycast,delete e._originRaycast)})):this.traverse((e=>{e.isMesh&&!e._originRaycast&&(e._originRaycast=e.raycast,e.raycast=()=>{})}))}set needsUpdate(e){e&&this.update()}set count(e){e!==this._count&&(this._count=e,this._matrixAttribute=new Ba(new Float32Array(16*e),16))}get count(){return this._count}set meshes(e){e&&(Array.isArray(e)?this._meshes=e:e.isMesh?this._meshes=[e]:e.isGroup&&(this._meshes=e.children),this.updateRenderingMesh(),this.update())}get meshes(){return this._meshes}}const jY=new Bi,qY=e=>{if(e.isInstancedMesh)for(let t=0;t<e.count;t++)jY.fromArray(e.instanceMatrix.array,16*t),jY.multiplyMatrices(e.matrixWorld,jY),e.instanceMatrix.array.set(jY.elements,16*t);else if(e.isSkinnedMesh)e.skeleton.pose(),e.geometry.applyMatrix4(e.bindMatrixInverse),e.geometry.applyMatrix4(e.matrixWorld);else if(e.isMesh)e.geometry.applyMatrix4(e.matrixWorld);else if(e.isBone)e.matrixWorld.decompose(e.position,e.quaternion,e.scale);else if(e.children.length>0)for(const t of e.children)qY(t);e.position.set(0,0,0),e.scale.set(1,1,1),e.quaternion.set(0,0,0,1)},$Y=(e,t)=>{if(e.isMesh||e.isBone)t.push(e);else if(e.children.length>0)for(const i of e.children)$Y(i,t)},eP=(e,t,i)=>{t&&(e=>{const t=new qt;t.setFromObject(e);const i=Math.max(t.max.x-t.min.x,t.max.y-t.min.y,t.max.z-t.min.z);e.scale.multiplyScalar(1/i)})(e),i&&(e.rotation.x=Math.PI/2),e.updateMatrixWorld(),qY(e),e.updateMatrixWorld();const n=[];return $Y(e,n),n},tP=Object.freeze(Object.defineProperty({__proto__:null,parseLODModel:(e,t,i)=>{const n=[];for(const s of e){const e=s.name;if(!e.startsWith("lod"))continue;const o=parseInt(e.substring(3),10);if(isNaN(o))continue;const r=eP(s,t,i);n[o]=r}return n},parseScene:eP},Symbol.toStringTag,{value:"Module"}));class iP{constructor(){__publicField(this,"_lastUpdateTime",0),__publicField(this,"_updateDelayTimerHander",null),__publicField(this,"_configVersion",0),__publicField(this,"_config",{tree:{enabled:!1,isFoliage:!0,isBox:!1,scaleByZ:!1,instances:[{subtype:4,modelPath:mm("assets/models/tree/planar/tree18.glb"),itemScale:1,zOffset:0},{subtype:3,modelPath:mm("assets/models/tree/planar/tree22.glb"),itemScale:1,zOffset:0},{subtype:2,modelPath:mm("assets/models/tree/planar/tree21.glb"),itemScale:1,zOffset:0},{subtype:1,modelPath:mm("assets/models/tree/planar/tree20.glb"),itemScale:1,zOffset:0},{subtype:0,modelPath:mm("assets/models/tree/planar/tree19.glb"),itemScale:1,zOffset:0}]}}),__publicField(this,"_labelEnabled",!1),__publicField(this,"_generateModelMesh",(async e=>new Promise(((t,i)=>{wH.load(e,(e=>{const i=eP(e.scene,!1,!0);t(i)}),null,i)})))),__publicField(this,"markNeedsUpdate",(()=>{this._updateDelayTimerHander||(this._updateDelayTimerHander=setTimeout((()=>{this.engine.requestRender(),this._updateDelayTimerHander=null}),100))})),__publicField(this,"remapBatchValueToNumber",(e=>e?isFinite(e)?e=Math.round(e%100):"string"==typeof e?(e=e.charCodeAt(3)||0)%100:0:0)),__publicField(this,"parseBatchTableAttribute",((e,t,i)=>{const n=e.cached.scene,s=[],o=n.batchTable&&n.batchTable.header;if(!o)return;const r=o[t];if(r){n.traverse((e=>{e.isMesh&&s.push(e)}));for(const e of s){if("type"in e.geometry.userData&&"subtype"in e.geometry.userData)continue;const t=e.geometry,n=t.getAttribute("_batchid");if(!n)continue;const s=n.data.count;let o=-1,a=0;const l=[];for(let e=0;e<s;e++)o=n.getX(e),a=this.remapBatchValueToNumber(r[o]),l.push(a);t.attributes[i]=new Bn(new Float32Array(l),1)}}})),__publicField(this,"parseLabelData",((e,t)=>{const i=e.geometry,n=t.__id,s=i.attributes.position,o=s.count;if(0===o)return;const r=i.attributes.rotation,a=t.cached.scene,l=a.matrix,g=a.batchTable.header.text,c=a.batchTable.header.rank,d=[],h=new Qt;for(let u=0;u<o;u++)h.set(s.getX(u),s.getY(u),s.getZ(u)),h.applyMatrix4(l),d.push({id:n+"-"+u,type:"text_flat",position:[h.x,h.y,h.z],text:g[u],rotateZ:r.getZ(u),rank:c&&c[u]||0});t.__labelData=d})),__publicField(this,"onTileLoad",((e,t)=>{this.refreshTile(e)})),__publicField(this,"onTileDispose",((e,t)=>{this.resetTile(e)})),__publicField(this,"onTileShow",(e=>{if(e.__instanceInfo){const t=e.__instanceInfo;Object.keys(t).forEach((e=>{const i=t[e];i.model&&(i.model.visible=!0,this.markNeedsUpdate())}))}})),__publicField(this,"onTileHide",(e=>{if(e.__instanceInfo){const t=e.__instanceInfo;Object.keys(t).forEach((e=>{const i=t[e];i.model&&(i.model.visible=!1,this.markNeedsUpdate())}))}const t=e.__labelData;e.__hasAddLabelData&&t&&(this.engine.rendering.label.removeLabels(t),e.__hasAddLabelData=!1)})),__publicField(this,"resetTile",(e=>{if(e.__instanceConfigVersion=null,e.__instanceInfo&&(Object.keys(e.__instanceInfo).forEach((t=>{const i=e.__instanceInfo[t];i.model&&(this.group.remove(i.model),i.model.dispose())})),delete e.__instanceInfo),e.__labelData&&e.__hasAddLabelData){const t=e.__labelData;this.engine.rendering.label.removeLabels(t,e.__lodLevel),e.__hasAddLabelData=!1}})),__publicField(this,"refreshTile",(e=>{const t=e.cached.scene,i=[];if(e.__instanceConfigVersion!==this._configVersion){t.traverse((e=>{e.isMesh&&i.push(e)}));for(const t of i)if(t.isMesh&&"type"in t.geometry.userData&&"subtype"in t.geometry.userData){t.visible=!1;const{type:i,subtype:n}=t.geometry.userData,s=this.getInstanceCollectionConfig(i);if(!s)continue;const o=this.getInstanceConfig(i,n);if(!o)continue;e.__instanceInfo||(e.__instanceInfo={}),s.enabled&&this.createInstanceComponent(t,e,s,o)}else"_label"===t._rawMaterialName&&(t.visible=!1,this._labelEnabled&&!e.__instanceLabelParsed&&(this.parseLabelData(t,e),e.__instanceLabelParsed=!0));e.__instanceConfigVersion=this._configVersion}const n=e.__labelData;n&&(this._labelEnabled&&!e.__hasAddLabelData&&(this.engine.rendering.label.addLabels(n,e.__lodLevel),e.__hasAddLabelData=!0),!this._labelEnabled&&e.__hasAddLabelData&&(this.engine.rendering.label.removeLabels(n,e.__lodLevel),e.__hasAddLabelData=!1))})),__publicField(this,"refreshTiles",(()=>{this.tilesRenderer.forEachLoadedModel(((e,t)=>{t.__visible&&(this.resetTile(t),this.refreshTile(t))})),this.engine.requestRender()})),this.group=new qr,this._modelMeshSingleton=new sE,this._modelMeshSingleton.generate=this._generateModelMesh}async createInstanceComponent(e,t,i,n){const s=e.geometry,o=t.__id,r=s.attributes.position,a=r.count;if(0===a)return;const l=i.type,g=l+"-"+n.subtype,c=n.itemScale||1,d=n.zOffset||0;let h;if("tree"===l)h=new PY;else{const e=await this._modelMeshSingleton.get(n.modelPath);h=new JY(e,a)}h.afterAddToEngine&&h.afterAddToEngine(this.engine);const u=[],I=s.attributes.scale,p=s.attributes.rotation,m=new Array(3*a),A=new Float32Array(3*a),C=new Float32Array(3*a),f=t.cached.scene.matrix,b=new Qt;for(let _=0;_<a;_++)b.set(r.getX(_),r.getY(_),r.getZ(_)),b.applyMatrix4(f),m[3*_]=b.x,m[3*_+1]=b.y,m[3*_+2]=b.z+d,A[3*_]=I.getX(_)*c,A[3*_+1]=I.getY(_)*c,A[3*_+2]=I.getZ(_)*c,C[3*_]=p.getX(_),C[3*_+1]=-p.getY(_),C[3*_+2]=Math.PI/2-p.getZ(_),u.push(o+"-"+_);const y={translation:m,scale:A,rotation:C,id:u};h.setBufferData(y),h.needsUpdate=!0,t.__instanceInfo[g]={model:h,data:y},this.group.add(h),h.visible=t.__visible}getInstanceCollectionConfig(e){if(am(this._config[e]))return{type:e,...this._config[e]};tw("TileInstancedElementManager: no config for type "+e)}setInstanceCollectionConfig(e,t){return this._config[e]?this._config[e]={...this._config[e],...t}:this._config[e]=t,this._configVersion++,this.refreshTiles(),this}getInstanceConfig(e,t){if(this._config[e]){let i=this._config[e].instances;for(let e=0;e<i.length;e++){const n=i[e];if(String(n.subtype)===String(t))return n}tw("TileInstancedElementManager: no config for type "+e+" subtype "+t)}else tw("TileInstancedElementManager: no config for type "+e)}setInstanceConfig(e,t,i){if(this._config[e]){let n=this._config[e].instances,s=!0;for(let e=0;e<n.length;e++){const o=n[e];if(String(o.subtype)===String(t)){n[e]={...o,...i},s=!1;break}}s&&this._config[e].instances.push({...i,subtype:t}),this._configVersion++,this.refreshTiles()}return this}set config(e){this._config=e,this._configVersion++,this.refreshTiles()}get config(){return this._config}set labelEnabled(e){this._labelEnabled=e,this._configVersion++,this.refreshTiles()}get labelEnabled(){return this._labelEnabled}}class nP{constructor(){__publicField(this,"_configVersion",0),__publicField(this,"_deletedIds",new Set),__publicField(this,"_needsRefreshAll",!1),__publicField(this,"updateEditableAttribute",(e=>{const t=e.cached.scene;t.children;const i=t.batchTable&&t.batchTable.header;if(!i)return;const n=i.id;if(!n)return;const s=this._deletedIds;t.traverse((e=>{if(e.geometry){const t=e.geometry,o=t.getAttribute("_batchid");if(!o)return;const r=o.array.length;let a=-1,l=0;const g=[];for(let e=0;e<r;e++)a=o.getX(e),l=n[a]+"",s.has(l)||this.shouldBeHidden(i,a)?g.push(1):g.push(0);t.attributes._tileEditableValue=new Bn(new Float32Array(g),1)}}))})),__publicField(this,"shouldBeHidden",((e,t)=>!1)),__publicField(this,"onTileLoad",((e,t)=>{e.__editableConfigVersion=0})),__publicField(this,"onTileDispose",((e,t)=>{})),__publicField(this,"onTileShow",(e=>{this.refreshTile(e)})),__publicField(this,"onTileHide",(e=>{})),__publicField(this,"refreshTile",(e=>{e.__editableConfigVersion!==this._configVersion&&(this.updateEditableAttribute(e),e.__editableConfigVersion=this._configVersion)})),__publicField(this,"refreshTiles",(()=>{this._needsRefreshAll&&this.tilesRenderer.forEachLoadedModel(((e,t)=>{t.__visible&&this.refreshTile(t)}))}))}addDeletedId(e){e+="",this._deletedIds.add(e),this._configVersion++,this._needsRefreshAll=!0,this.engine.requestRender()}addDeletedIds(e){for(let t=0;t<e.length;t++){const i=e[t]+"";this._deletedIds.add(i)}this._configVersion++,this._needsRefreshAll=!0,this.engine.requestRender()}removeDeletedId(e){e+="",this._deletedIds.delete(e),this._configVersion++,this._needsRefreshAll=!0,this.engine.requestRender()}removeDeletedIds(e){for(let t=0;t<e.length;t++){const i=e[t]+"";this._deletedIds.delete(i)}this._configVersion++,this._needsRefreshAll=!0,this.engine.requestRender()}hasDeletedId(e){return this._deletedIds.has(e)}requestUpdate(){this._configVersion++,this._needsRefreshAll=!0,this.engine.requestRender()}}const sP=new Qt;new Bi;const oP=new Qt,rP=new Qt,aP=new Qt(1,0,0),lP=new Qt(0,1,0),gP=new Qt,cP=new Qt,dP=Symbol("PLUGIN_REGISTERED"),hP={X:0,Y:1,Z:2,fromName:function(e){return hP[e]}},uP=new Qt,IP=new Qt,pP=new Qt,mP=new Qt,AP=()=>{};async function CP(e,t){const i=vP(t,"3DTILES_metadata")?t.extensions["3DTILES_metadata"]:t;let n;if(am(i.schemaUri))e=e.getDerivedResource({url:i.schemaUri}),n=qL.getSchemaLoader({schema:i.schema});else{if(!am(i.schema))return;n=qL.getSchemaLoader({schema:i.schema})}await n.load();const s=new uY({schema:n.schema,metadataJson:i});return qL.unload(n),s}const fP={ADD:0,REPLACE:1},bP=class extends Ji{constructor(e){super(),__publicField(this,"isEventEntitySupported",!0),__publicField(this,"is3DTiles",!0),__publicField(this,"_needsRefreshAllLoadedTiles",!1),__publicField(this,"_freezeUpdate",!1),__publicField(this,"_forceUnlit",!1),__publicField(this,"handleBeforeRender",(e=>{if(this._needsRefreshAllLoadedTiles&&(this._needsRefreshAllLoadedTiles=!1,this.traversalLoadedTile(((e,t)=>{this._refreshTileInfo(t)}))),this._freezeUpdate||!this.visible)return;const t=e.rendering.renderState;this._elementsManager&&this._elementsManager.tick(t.time),this.prePassesUpdate(t),this.update(t),this.postPassesUpdate(t),this._editableElementManager.refreshTiles()})),__publicField(this,"parseBatchTableAttribute",((e,t)=>{const i=e.scene.children,n=e.batchTable&&e.batchTable.header;if(!n)return;const s=n[t];if(s&&s.length)for(const o of i){const e=o.geometry,i=e.getAttribute("_batchid");if(!i)continue;const n=i.data.count;let r=-1,a=0;const l=[];for(let t=0;t<n;t++)r=i.getX(t),a=s[r],l.push(a);e.attributes[t]=new Bn(new Float32Array(l),1)}})),__publicField(this,"_refreshTileInfo",(e=>{var t;const i=e.content;"2.0.0"===(null==(t=this._asset)?void 0:t.tilesetVersion)&&this.parseBatchTableAttribute(i,"typeId"),i.traverse((e=>{if(!e.isMesh||!e.material)return;void 0===e._rawMaterialName&&(e._rawMaterialName=e.material.name,e._originalMaterial=e.material);const t=e._rawMaterialName;if(this._materialManager){const i=this._materialManager.getMaterialByKey(t,e);i&&i.isMaterial?e.material=i:e.material=e._originalMaterial}else e.material=e._originalMaterial;e.receiveShadow=this._receiveShadow,i._raycastMethod!==this._raycastMethod&&(this._raycastMethod===bP.RAYCAST_NONE?e.raycast=AP:e.raycast=this._overridenRaycast)})),i._raycastMethod=this._raycastMethod})),__publicField(this,"traversalLoadedTile",(e=>{this.getTraversal().forEachLoadedTile(this,e)})),e=lm(e,{}),this.plugins=[],this.preferLeaves=lm(e.preferLeaves,!1),this.dynamicScreenSpaceError=lm(e.dynamicScreenSpaceError,!0),this._updatedVisibilityFrame=0,this.dynamicScreenSpaceErrorDensity=lm(e.dynamicScreenSpaceErrorDensity,.00278),this.dynamicScreenSpaceErrorFactor=lm(e.dynamicScreenSpaceErrorFactor,40),this.dynamicScreenSpaceErrorHeightFalloff=lm(e.dynamicScreenSpaceErrorHeightFalloff,.25),this.foveatedScreenSpaceError=lm(e.foveatedScreenSpaceError,!0),this._foveatedConeSize=lm(e.foveatedConeSize,.05),this._foveatedMinimumScreenSpaceErrorRelaxation=lm(e.foveatedMinimumScreenSpaceErrorRelaxation,0),this.foveatedInterpolationCallback=lm(e.foveatedInterpolationCallback,ft.lerp),this.loadSiblings=lm(e.loadSiblings,!1),this.dynamicScreenSpaceHeightScale=e.dynamicScreenSpaceHeightScale||6,this._dynamicScreenSpaceErrorComputedDensity=0,this._cullWithChildrenBounds=lm(e.cullWithChildrenBounds,!0),this._url=void 0,this._basePath=void 0,this._root=void 0,this._cache=new $H,this._processingQueue=[],this._selectedTiles=[],this._selectedTilesToStyle=[],this._emptyTiles=[],this._requestedTiles=[],this._requestedTilesInFlight=[],this._maximumScreenSpaceError=lm(e.maximumScreenSpaceError,64),this._screenSpaceError=this._maximumScreenSpaceError,this.cullRequestsWhileMoving=lm(e.cullRequestsWhileMoving,!0),this._cullRequestsWhileMoving=!1,this.cullRequestsWhileMovingMultiplier=lm(e.cullRequestsWhileMovingMultiplier,60),this.progressiveResolutionHeightFraction=ft.clamp(lm(e.progressiveResolutionHeightFraction,.5),0,.5),this._cacheBytes=lm(e.cacheBytes,536870912),this._prevSelectedTiles=[];const t=lm(e.maximumCacheOverflowBytes,536870912);this._maximumCacheOverflowBytes=t,this._statistics=new ez,this._statisticsLast=new ez,this._maximumPriority={foveatedFactor:-Number.MAX_VALUE,depth:-Number.MAX_VALUE,distance:-Number.MAX_VALUE,reverseScreenSpaceError:-Number.MAX_VALUE},this._minimumPriority={foveatedFactor:Number.MAX_VALUE,depth:Number.MAX_VALUE,distance:Number.MAX_VALUE,reverseScreenSpaceError:Number.MAX_VALUE},this._modelMatrix=am(e.modelMatrix)?(new Bi).copy(e.modelMatrix):new Bi,this.optimizeRaycast=lm(e.optimizeRaycast,!0),this._raycastMethod=bP.RAYCAST_DEFAULT;const i=this;this._overridenRaycast=function(e,t){i.optimizeRaycast||Object.getPrototypeOf(this).raycast.call(this,e,t)},this._camera=null,this._manager=new El,Array.isArray(e.loaders)?this._loaders=e.loaders:(this._gltfLoader=BH(),this._loaders=[[/\.gltf$/,this._gltfLoader]],e.forceUnlit&&(this.forceUnlit=!0)),this.updateCustomLoaders(),this.group=new qr,this.add(this.group);(this._elementsManager=new cY(this.group)).tilesRenderer=this;const n=this._instancedElementManager=new iP;n.tilesRenderer=this,this.add(n.group);(this._editableElementManager=new nP).tilesRenderer=this,this._displayBoxBounds=lm(e.displayBoxBounds,!1),this._displayRegionBounds=lm(e.displayRegionBounds,!1),this.debug=lm(e.debug,!1),this._initEventListener()}getBounds(){const e=new qt,t=this.getBoundingBox(e);return t&&e.applyMatrix4(this.matrixWorld),t?e:null}isEntityVisible(e){return!e.id||!this._editableElementManager.hasDeletedId(e.id)}_initEventListener(){this.addEventListener("jsonloaded",this.handleLoadTileset),this.addEventListener("loaded",this.handleLoadTile),this.addEventListener("dispose",this.handleDisposeTile),this.addEventListener("visibilitychange",this.handleTileVisibleChanged)}handleLoadTileset(){this._engine&&this._engine.requestRender()}handleLoadTile(e){const t=e.tile;this._refreshTileInfo(t);const i=t.content.scene;this._elementsManager.onTileLoad(t,i),this._instancedElementManager.onTileLoad(t,i),this._editableElementManager.onTileLoad(t,i),this._engine.requestRender()}handleDisposeTile(e){const t=e.tile,i=t.content.scene;this._elementsManager.onTileDispose(t,i),this._instancedElementManager.onTileDispose(t,i),this._editableElementManager.onTileDispose(t,i)}handleTileVisibleChanged(e){const{tile:t,visible:i}=e;i?(this._instancedElementManager.onTileShow(t),this._elementsManager.onTileShow(t),this._editableElementManager.onTileShow(t)):(this._instancedElementManager.onTileHide(t),this._elementsManager.onTileHide(t),this._editableElementManager.onTileHide(t))}updateCustomLoaders(){for(const e of this._loaders)this._manager.addHandler(e[0],e[1])}afterAddToEngine(e){this._engine=e,e.addPrepareRenderListener(this.handleBeforeRender),this._elementsManager.engine=e,this._instancedElementManager.engine=e,this._editableElementManager.engine=e}setCamera(e){this._camera=e}hasCamera(){return am(this._camera)}deleteCamera(){this._camera=void 0}getCamera(){return this.hasCamera()?this._camera:this._engine&&this._engine.camera}getEntityByIntersection(e){const t=e.object;if(!am(t))return null;const{face:i,faceIndex:n}=e,s=i&&i.a,o={},r=t.content,a=t.tile;if(r&&(o._content=r),a){const e=a.tileset;o._tile=a,o._tileset=e}o._face=i,o._faceIndex=n;const l=t.geometry?t.geometry.getAttribute("_batchid"):void 0,g=r&&r.batchTable;if(void 0!==s&&l){const e=Math.round(l.getX(s));o._batchId=e;for(const t of Object.keys(g.header)){const i=g.header[t];o[t]=i[e]}}return o}updateInfo(){const e=this._engine,t=this.getCamera();this.dispatchEvent({type:"update-before"});const i=e.renderer.getPixelRatio(),n=this._cameraInfo||{positionWCDeltaMagnitude:0,positionCartographic:new Qt,lastMovedTimestamp:Date.now(),positionWCDeltaMagnitudeLastFrame:0,timeSinceMoved:0,position:new Qt,directionWC:new Qt,oldPosition:null},s=e.rendering.resolution;0!==s.x&&0!==s.y||console.warn("TilesRenderer: resolution for camera error calculation is not set.");const o=t.projectionMatrix.elements;if(n.isOrthographic=1===o[15],n.isOrthographic){const e=2/o[0],t=2/o[5];n.pixelSize=Math.max(t/(s.height*i),e/(s.width*i))}else n.sseDenominator=2/o[5]/(s.y*i);n.invScale=1,n.position=gP.copy(t.position),n.pixelRatio=e.rendering.pixelRatio;const r=n.position;n.oldPosition||(n.oldPosition=r.clone()),n.frustum||(n.frustum=new Az);const a=new Bi,l=new Bi,g=this.group;a.copy(g.matrixWorld),l.copy(a).invert(),a.premultiply(t.matrixWorldInverse),a.premultiply(t.projectionMatrix),n.frustum.setFromProjectionMatrix(a),r.set(0,0,0),r.applyMatrix4(t.matrixWorld),r.applyMatrix4(l),n.positionWCDeltaMagnitudeLastFrame=n.positionWCDeltaMagnitude;const c=cP.subVectors(r,n.oldPosition);n.positionWCDeltaMagnitude=c.length(),n.positionWCDeltaMagnitude>0?(n.timeSinceMoved=0,n.lastMovedTimestamp=Date.now()):n.timeSinceMoved=Math.max(Date.now()-n.lastMovedTimestamp,0)/1e3,n.oldPosition.copy(r),t.getWorldDirection(n.directionWC),n.positionCartographic.fromArray(e.map.unprojectArrayCoordinate(t.position.toArray())),this._cameraInfo=n}prePassesUpdate(e){if(this.updateInfo(),am(this._root)){if(function(e){!function(e){const t=e._processingQueue;let i=0;for(let n=0;n<t.length;n++){const e=t[n];e.isDestroyed()||e._contentState!==WH.PROCESSING?++i:i&&(t[n-i]=e)}t.length-=i}(e);const t=e._processingQueue,{cacheBytes:i,maximumCacheOverflowBytes:n,statistics:s}=e;for(let r=0;r<t.length;++r){const i=t[r];try{i.process(e),i.contentReady&&--s.numberOfTilesProcessing}catch(o){--s.numberOfTilesProcessing,xP()}}}(this),this.dynamicScreenSpaceError){!function(e,t,i){let n,s,o,r,a;const l=e._root,g=l.boundingVolume,c=e.getCamera(),d=e._cameraInfo,h=i.map.isGlobe;if(am(l.boundingVolume.regionObb)){n=h?jm.normalize(c.position,IP):jm.UNIT_Z,s=d.directionWC,o=d.positionCartographic.z;const e=l.boundingVolume.regionObb.box,{min:t,max:i}=e;r=t.z,a=i.z}else{const e=l.computedTransform.clone().invert(),t=i.map.map._ellipsoid||eA.WGS84,u=g.obb,I=l.boundingVolumeCenter,p=aA.multiplyByPoint(e,I,rP);if(jm.magnitude(p)>t.minimumRadius&&h){const e=RC.fromCartesian(p,t,uP);n=jm.normalize(c.position,IP),s=d.directionWC,o=d.positionCartographic.z,r=0,a=2*e.z}else{sP.copy(c.position);const t=aA.multiplyByPoint(e,sP,pP);if(n=jm.UNIT_Z,s=aA.multiplyByPointAsVector(e,d.directionWC,mP),s=jm.normalize(s,s),o=t.z,am(u)){const e=rA.getColumn(u.halfAxes,2,oP).length();r=p.z-e,a=p.z+e}else{const e=l.boundingVolume.sphere.radius;r=p.z-e,a=p.z+e}}}const u=r+(a-r)*e.dynamicScreenSpaceErrorHeightFalloff,I=a*e.dynamicScreenSpaceHeightScale,p=ft.clamp((o-u)/(I-u),0,1);let m=1-Math.abs(jm.dot(s,n));m*=1-p,e._dynamicScreenSpaceErrorComputedDensity=e.dynamicScreenSpaceErrorDensity*m}(this,0,this._engine)}this._cache.reset()}}forEachLoadedModel(e){this.traversalLoadedTile(e)}update(e){!function(e,t){if(!am(e._root))return!1;e._statistics.clear(),e._updatedVisibilityFrame=t.frameCount,function(e){e._minimumPriority.depth=Number.MAX_VALUE,e._maximumPriority.depth=-Number.MAX_VALUE,e._minimumPriority.foveatedFactor=Number.MAX_VALUE,e._maximumPriority.foveatedFactor=-Number.MAX_VALUE,e._minimumPriority.distance=Number.MAX_VALUE,e._maximumPriority.distance=-Number.MAX_VALUE,e._minimumPriority.reverseScreenSpaceError=Number.MAX_VALUE,e._maximumPriority.reverseScreenSpaceError=-Number.MAX_VALUE}(e),e._cullRequestsWhileMoving=e.cullRequestsWhileMoving,e.getTraversal().selectTiles(e,t),function(e){const t=e._requestedTiles;t.sort(BP);for(let i=0;i<t.length;++i)SP(e,t[i])}(e),function(e,t){e._styleApplied=!0;const i=e._prevSelectedTiles,n=e._selectedTiles,{statistics:s}=e;let o=0,r=0;for(o=0,r=i.length;o<r;o++){const e=i[o];n.includes(e)||wP(e,!1)}for(o=0,r=n.length;o<r;o++){const s=n[o];i.includes(s)||wP(s,!0),s.update(e,t)}s.selected=n.length,e._prevSelectedTiles=[...n];const a=e._emptyTiles;for(let l=0;l<a.length;++l){a[l].update(e,t)}}(e,t),e.dispatchEvent({type:"update-after"})}(this,e)}trimLoadedTiles(){this._cache.trim()}postPassesUpdate(e){am(this._root)&&(!function(e,t){const i=e._requestedTilesInFlight;let n=0;for(let s=0;s<i.length;++s){const e=i[s],o=t.frameCount-e._touchedFrame>=1;e._contentState===WH.LOADING?o?(e.cancelRequests(),++n):n>0&&(i[s-n]=e):++n}i.length-=n}(this,e),this._cache.unloadTiles(this,GP),this._styleApplied=!1,PH.update())}beforeRemoveFromEngine(e){this._engine.removePrepareRenderListener(this.handleBeforeRender),this.dispose()}dispose(){this.resetQueue(),this.traversalLoadedTile(((e,t)=>{this._cache.unloadTile(this,t,GP)}))}disposePlugins(){this.plugins.forEach((e=>{e.dispose&&e.dispose()}))}resetQueue(){this._prevSelectedTiles.length=0,this._processingQueue.length=0,this._requestedTiles.length=0}getTraversal(){return this.isSkippingLevelOfDetail?yK:MK}isDestroyed(){return!1}async setTilesetProperties(e,t,i){const n=await CP(t,e);this._metadataExtension=n,this._geometricError=e.geometricError,this._scaledGeometricError=e.geometricError;const s=e.asset;this._asset=s,this._extras=e.extras;const o=am(e.asset.gltfUpAxis)?hP.fromName(e.asset.gltfUpAxis):hP.Y,r=lm(i.modelUpAxis,o),a=lm(i.modelForwardAxis,hP.X);this._gltfUpMatrix=new Bi,this._properties=e.properties,this._extensionsUsed=e.extensionsUsed,this._extensions=e.extensions,this._modelUpAxis=r,this._modelForwardAxis=a,this._root=this.loadTileset(t,e),queueMicrotask((()=>{this.dispatchEvent({type:"rootloaded",tileset:e,url:t.url})}))}static async fromAssetId(e,t){const i=await AY.fromAssetId(e);return bP.fromUrl(i,t)}static fromUrl(e,t){t=lm(t,{});const i=az.createIfNeeded(e);let n;"json"===i.extension?n=i.getBaseUri(!0):i.isDataUri&&(n="");const s=new bP(t);return s._resource=i,s._url=e,s._basePath=n,bP.loadJson(i).then((async function(e){s.setTilesetProperties(e,i,t)})),s}static async fromUrlAsync(e,t){t=lm(t,{});const i=az.createIfNeeded(e);let n;"json"===i.extension?n=i.getBaseUri(!0):i.isDataUri&&(n="");const s=await bP.loadJson(i),o=await CP(i,s),r=new bP(t);r._resource=i,r._url=e,r._basePath=n,r._metadataExtension=o,r._geometricError=s.geometricError,r._scaledGeometricError=s.geometricError;const a=s.asset;r._asset=a,r._extras=s.extras;const l=am(s.asset.gltfUpAxis)?hP.fromName(s.asset.gltfUpAxis):hP.Y,g=lm(t.modelUpAxis,l),c=lm(t.modelForwardAxis,hP.X);return r._gltfUpMatrix=new Bi,r._properties=s.properties,r._extensionsUsed=s.extensionsUsed,r._extensions=s.extensions,r._modelUpAxis=g,r._modelForwardAxis=c,r._root=r.loadTileset(i,s),r}static async loadJson(e){return az.createIfNeeded(e).fetchJson()}getBoundingBox(e){if(!this.root)return!1;const t=this.root.boundingVolume;return!!t&&(t.getAABB(e),!0)}loadTileset(e,t,i){const n=t.asset;if(!am(n))throw new Error("Tileset must have an asset property.");if("0.0"!==n.version&&"1.0"!==n.version&&"1.1"!==n.version)throw new Error("The tileset must be 3D Tiles version 0.0, 1.0, or 1.1");am(t.extensionsRequired)&&bP.checkSupportedExtensions(t.extensionsRequired);const s=this._statistics,o=n.tilesetVersion;am(o)&&(this._basePath+=`?v=${o}`,(e=e.clone()).setQueryParameters({v:o}));const r=_P(this,e,t.root,i);am(i)&&(i.children.push(r),r._depth=i._depth+1);const a=[];for(a.push(r);a.length>0;){const t=a.pop();++s.numberOfTilesTotal,this._allTilesAdditive=this._allTilesAdditive&&t.refine===fP.ADD;const i=t._header.children;if(am(i))for(let n=0;n<i.length;++n){const s=i[n],o=_P(this,e,s,t);t.children.push(o),o._depth=t._depth+1,a.push(o)}this._cullWithChildrenBounds&&hz.checkChildrenWithinParent(t)}return queueMicrotask((()=>{this.dispatchEvent({type:"jsonloaded",tileset:t,url:e.url})})),r}registerPlugin(e){if(!0===e[dP])throw new Error("A plugin can only be registered to a single tile set");return this.plugins.push(e),e[dP]=!0,e.init&&e.init(this),e}raycast(e,t){if(this._root&&this.raycastMethod!==bP.RAYCAST_NONE)if(e.firstHitOnly){const i=lY(this,this._root,e);i&&t.push(i)}else gY(this,this._root,e,t)}get raycastMethod(){return this._raycastMethod}set raycastMethod(e){e!==this._raycastMethod&&(this._raycastMethod=parseInt(e,10),this._needsRefreshAllLoadedTiles=!0,this._engine&&this._engine.requestRender())}get root(){return this._root}get modelMatrix(){return this._modelMatrix}get screenSpaceError(){return this._screenSpaceError}get cacheBytes(){return this._cacheBytes}set cacheBytes(e){this._cacheBytes=e}get maximumCacheOverflowBytes(){return this._maximumCacheOverflowBytes}set maximumCacheOverflowBytes(e){this._maximumCacheOverflowBytes=e}get gltfUpMatrix(){switch(this._modelUpAxis){case hP.X:this._gltfUpMatrix.makeRotationAxis(lP,-Math.PI/2);break;case hP.Y:this._gltfUpMatrix.makeRotationAxis(aP,Math.PI/2)}return this._gltfUpMatrix}get metadataExtension(){return this._metadataExtension}get schema(){if(am(this._metadataExtension))return this._metadataExtension.schema}get metadata(){if(am(this._metadataExtension))return this._metadataExtension.tileset}get foveatedConeSize(){return this._foveatedConeSize}set foveatedConeSize(e){this._foveatedConeSize=e}get totalMemoryUsageInBytes(){return this._statistics.totalByteLength}get statistics(){return this._statistics}get foveatedMinimumScreenSpaceErrorRelaxation(){return this._foveatedMinimumScreenSpaceErrorRelaxation}set foveatedMinimumScreenSpaceErrorRelaxation(e){this._foveatedMinimumScreenSpaceErrorRelaxation=e}get maximumScreenSpaceError(){return this._maximumScreenSpaceError}set maximumScreenSpaceError(e){this._maximumScreenSpaceError=e,this._screenSpaceError=e,this._engine&&this._engine.requestRender()}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,e?(this._debugTilesPlugin=new eY,this._debugTilesPlugin.displayBoxBounds=this._displayBoxBounds,this._debugTilesPlugin.displayRegionBounds=this._displayRegionBounds,this.registerPlugin(this._debugTilesPlugin)):this._debugTilesPlugin&&this._debugTilesPlugin.dispose())}get debugTilesPlugin(){return this._debugTilesPlugin}get displayBoxBounds(){return this._displayBoxBounds}set displayBoxBounds(e){this._displayBoxBounds=e,this._debugTilesPlugin&&(this._debugTilesPlugin.displayBoxBounds=e)}get displayRegionBounds(){return this._displayRegionBounds}set displayRegionBounds(e){this._displayRegionBounds=e,this._debugTilesPlugin&&(this._debugTilesPlugin.displayRegionBounds=e)}get displaySphereBounds(){return this._displaySphereBounds}set displaySphereBounds(e){this._displaySphereBounds=e,this._debugTilesPlugin&&(this._debugTilesPlugin.displaySphereBounds=e)}get freezeUpdate(){return this._freezeUpdate}set freezeUpdate(e){this._freezeUpdate=e}get materialManager(){return this._materialManager}set materialManager(e){e!==this._materialManager&&(e&&(e.engine=this._engine,e.tiles=this,e.init(),e.isIdentity3DTilesMaterialManager&&(e.type=this._identityType)),this._materialManager=e,this._needsRefreshAllLoadedTiles=!0,this._engine.requestRender())}get castShadow(){return this._castShadow}set castShadow(e){e!==this._castShadow&&(this._castShadow=e,this._needsRefreshAllLoadedTiles=!0,this._engine&&this._engine.requestRender())}get receiveShadow(){return this._receiveShadow}set receiveShadow(e){e!==this._receiveShadow&&(this._receiveShadow=e,this._needsRefreshAllLoadedTiles=!0,this._engine&&this._engine.requestRender())}get instancedElementManager(){return this._instancedElementManager}get editableElementManager(){return this._editableElementManager}get elementsManager(){return this._elementsManager}get forceUnlit(){return this._forceUnlit}set forceUnlit(e){e!==this._forceUnlit&&this._gltfLoader&&(this._forceUnlit=e,this._gltfLoader.setForceUnlit(e),this.dispose(),this.engine&&this.engine.requestRender())}};let yP=bP;function _P(e,t,i,n){if(!(am(i.implicitTiling)||vP(i,"3DTILES_implicit_tiling")))return new bK(e,t,i,n);const s=e.schema,o=new VK(t,i,s),r=new zK({subdivisionScheme:o.subdivisionScheme,subtreeLevels:o.subtreeLevels,level:0,x:0,y:0,z:0}),a=o.subtreeUriTemplate.getDerivedResource({templateValues:r.getTemplateValues()}).url,l=cm(i,!0);l.contents=[{uri:a}],delete l.content,delete l.extensions;const g=new bK(e,t,l,n);return g.implicitTileset=o,g.implicitCoordinates=r,g}function vP(e,t){return am(e)&&am(e.extensions)&&am(e.extensions[t])}function xP(e,t,i){t.isDestroyed()||(i.isDestroyed()||i._contentResource.url,am(e.message)?e.message:e.toString())}function BP(e,t){return e._priority-t._priority}function wP(e,t){const i=e.tileset;t?function(e){const t=e.tileset,i=e._content;if(i.isMultiple3DTileContents){const e=i._contents,n=e.length;for(let i=0;i<n;++i){const n=e[i].scene;t.group.add(n)}}else{const e=i.scene;t.group.add(e)}}(e):function(e){const t=e.tileset,i=e._content;if(i.isMultiple3DTileContents){const e=i._contents,n=e.length;for(let i=0;i<n;++i){const n=e[i].scene;t.group.remove(n)}}else{const e=i.scene;t.group.remove(e)}}(e),i.dispatchEvent({type:"visibilitychange",tile:e,visible:t})}function SP(e,t){if(t.hasEmptyContent)return;const{statistics:i}=e,n=t.requestContent();am(n)&&(n.then((n=>{!am(n)||t.isDestroyed()||e.isDestroyed()||(e._processingQueue.push(t),++i.numberOfTilesProcessing,e._engine.requestRender())})).catch((i=>{xP(i,e,t)})),e._requestedTilesInFlight.push(t))}function GP(e,t){e._statistics.decrementLoadCounts(t.content),--e._statistics.numberOfTilesWithContentReady,t.unloadContent()}__publicField(yP,"RAYCAST_NONE",0),__publicField(yP,"RAYCAST_DEFAULT",1),__publicField(yP,"RAYCAST_BVH",2),__publicField(yP,"supportedExtensions",{"3DTILES_metadata":!0,"3DTILES_implicit_tiling":!0,"3DTILES_multiple_contents":!0}),__publicField(yP,"checkSupportedExtensions",(function(e){for(let t=0;t<e.length;t++)if(!bP.supportedExtensions[e[t]])throw new Error(`Unsupported 3D Tiles Extension: ${e[t]}`)}));class MP extends yP{constructor(e){const t=lm(e.errorTarget,64);super({maximumScreenSpaceError:t,forceUnlit:lm(e.forceUnlit,!1),cullWithChildrenBounds:lm(e.cullWithChildrenBounds,!0),cullRequestsWhileMoving:lm(e.cullRequestsWhileMoving,!0),cullRequestsWhileMovingMultiplier:lm(e.cullRequestsWhileMovingMultiplier,60),dynamicScreenSpaceError:lm(e.dynamicScreenSpaceError,!0),dynamicScreenSpaceErrorHeightFalloff:lm(e.dynamicScreenSpaceErrorHeightFalloff,.25),dynamicScreenSpaceErrorDensity:lm(e.dynamicScreenSpaceErrorDensity,.00278),foveatedScreenSpaceError:lm(e.foveatedScreenSpaceError,!1),foveatedConeSize:lm(e.foveatedConeSize,.3),foveatedMinimumScreenSpaceErrorRelaxation:lm(e.foveatedMinimumScreenSpaceErrorRelaxation,.8),progressiveResolutionHeightFraction:lm(e.progressiveResolutionHeightFraction,.5),cacheBytes:e.cacheBytes,maximumCacheOverflowBytes:e._maximumCacheOverflowBytes,loaders:e.loaders}),__publicField(this,"_showDebug",!1),__publicField(this,"transformFromEcefToPlane",((e,t,i=0)=>{let n=bA.eastNorthUpToFixedFrame(bA.lnglatToEcef(e,t,i));n.invert();const s=new Bi,o=this.engine.map.projectArrayCoordinate([e,t]);s.makeTranslation(o[0],o[1],0);const r=new Bi;r.multiplyMatrices(s,n),r.decompose(this.position,this.quaternion,this.scale)})),__publicField(this,"lockCameraViewport",(()=>{const e=this.getCamera(),t=this._lockedCamera=e.clone();this.setCamera(t),this._updateCameraHelper(t)})),__publicField(this,"releaseCameraViewport",(()=>{const e=this._engine;if(this._lockedCamera){const t=e.camera;this.setCamera(t),this._lockedCamera=null}this._destroyCameraHelper()})),this._errorTarget=t;const i=e.url,n=(e=lm(e,{})).assetId;if(am(n))AY.fromAssetId(n).then((t=>{let n;"json"===t.extension?n=t.getBaseUri(!0):t.isDataUri&&(n=""),this._resource=t,this._url=i,this._basePath=n,yP.loadJson(t).then((async i=>{this.setTilesetProperties(i,t,e)}))}));else{const t=az.createIfNeeded(i);let n;"json"===t.extension?n=t.getBaseUri(!0):t.isDataUri&&(n=""),this._resource=t,this._url=i,this._basePath=n,yP.loadJson(t).then((async i=>{this.setTilesetProperties(i,t,e)}))}}static async fromAssetId(e,t={}){const i=await AY.fromAssetId(e);t.url=i;return new MP(t)}_updateCameraHelper(e){const t=this._engine;this._destroyCameraHelper();const i=this._cameraHelper=new Gg(e);t.add(i)}_destroyCameraHelper(){const e=this._engine;this._cameraHelper&&(e.remove(this._cameraHelper),this._cameraHelper.dispose(),this._cameraHelper=null)}get showDebug(){return this._showDebug}set showDebug(e){this._showDebug!==e&&(this.debug=e,this.displayBoxBounds=e,this.displayRegionBounds=e,this.displaySphereBounds=e,this._showDebug=e)}get errorTarget(){return this.maximumScreenSpaceError}set errorTarget(e){this.maximumScreenSpaceError=e}get cullWithChildrenBounds(){return this._cullWithChildrenBounds}set cullWithChildrenBounds(e){this._cullWithChildrenBounds=e}get cullRequestsWhileMoving(){return this._cullRequestsWhileMoving}set cullRequestsWhileMoving(e){this._cullRequestsWhileMoving=e}get foveatedConeSize(){return this._foveatedConeSize}set foveatedConeSize(e){this._foveatedConeSize=e}get loadSiblings(){return this._loadSiblings}set loadSiblings(e){this._loadSiblings=e}}const RP=class extends ax{constructor(e){super(e),this.type="GeoJSONDataSource"}async _convertStreamingDataToObjectData(e){return await e.json()}_parseObjectDataToDataItems(e){let t=null,i=null;Array.isArray(e)?t=e:Array.isArray(e.features)||"FeatureCollection"===e.type?(t=e.features,i=e.properties):"Feature"===e.type&&(t=[e]);const n=[];for(let s=0;s<t.length;s++)n.push(new ex(t[s],i));return n}};let TP=RP;__publicField(TP,"fromGeoJSON",(function(e,t){"string"==typeof e&&console.error("It seems that you are trying to pass a URL to GeoJSONDataSource.fromGeoJSON, please use GeoJSONDataSource.fromURL instead.");let i=new RP(t);return i.setData(e),i})),__publicField(TP,"fromURL",(async function(e,t){let i=new RP(t);return await i.load(e),i})),__publicField(TP,"fromGeoJSONObject",(function(e,t){return console.warn("GeoJSONDataSource.fromGeoJSONObject is deprecated, please use GeoJSONDataSource.fromGeoJSON instead."),RP.fromGeoJSON(e,t)})),__publicField(TP,"fromObject",(function(e,t){return console.warn("GeoJSONDataSource.fromObject is deprecated, please use GeoJSONDataSource.fromGeoJSON instead."),RP.fromGeoJSON(e,t)}));var ZP={exports:{}};ZP.exports=EP,ZP.exports.parse=EP,ZP.exports.stringify=function e(t){"Feature"===t.type&&(t=t.geometry);function i(e){return e.join(" ")}function n(e){return e.map(i).join(", ")}function s(e){return e.map(n).map(o).join(", ")}function o(e){return"("+e+")"}switch(t.type){case"Point":return"POINT ("+i(t.coordinates)+")";case"LineString":return"LINESTRING ("+n(t.coordinates)+")";case"Polygon":return"POLYGON ("+s(t.coordinates)+")";case"MultiPoint":return"MULTIPOINT ("+n(t.coordinates)+")";case"MultiPolygon":return"MULTIPOLYGON ("+(t.coordinates.map(s).map(o).join(", ")+")");case"MultiLineString":return"MULTILINESTRING ("+s(t.coordinates)+")";case"GeometryCollection":return"GEOMETRYCOLLECTION ("+t.geometries.map(e).join(", ")+")";default:throw new Error("stringify requires a valid GeoJSON Feature or geometry object as input")}};var VP=/[-+]?([0-9]*\.[0-9]+|[0-9]+)([eE][-+]?[0-9]+)?/,WP=new RegExp("^"+VP.source+"(\\s"+VP.source+"){1,}");function EP(e){var t=e.split(";"),i=t.pop(),n=(t.shift()||"").split("=").pop(),s=0;function o(e){var t=i.substring(s).match(e);return t?(s+=t[0].length,t[0]):null}function r(){o(/^\s*/)}function a(){r();for(var e,t=0,i=[],n=[i],s=i;e=o(/^(\()/)||o(/^(\))/)||o(/^(,)/)||o(WP);){if("("===e)n.push(s),s=[],n[n.length-1].push(s),t++;else if(")"===e){if(0===s.length)return null;if(!(s=n.pop()))return null;if(0===--t)break}else if(","===e)s=[],n[n.length-1].push(s);else{if(e.split(/\s/g).some(isNaN))return null;Array.prototype.push.apply(s,e.split(/\s/g).map(parseFloat))}r()}return 0!==t?null:i}function l(){for(var e,t,i=[];t=o(WP)||o(/^(,)/);)","===t?(i.push(e),e=[]):t.split(/\s/g).some(isNaN)||(e||(e=[]),Array.prototype.push.apply(e,t.split(/\s/g).map(parseFloat))),r();return e?(i.push(e),i.length?i:null):null}function g(){return function(){if(!o(/^(point(\sz)?)/i))return null;if(r(),!o(/^(\()/))return null;var e=l();return e?(r(),o(/^(\))/)?{type:"Point",coordinates:e[0]}:null):null}()||function(){if(!o(/^(linestring(\sz)?)/i))return null;if(r(),!o(/^(\()/))return null;var e=l();return e&&o(/^(\))/)?{type:"LineString",coordinates:e}:null}()||function(){if(!o(/^(polygon(\sz)?)/i))return null;r();var e=a();return e?{type:"Polygon",coordinates:e}:null}()||function(){if(!o(/^(multipoint)/i))return null;r();var e=i.substring(i.indexOf("(")+1,i.length-1).replace(/\(/g,"").replace(/\)/g,"");i="MULTIPOINT ("+e+")";var t=a();return t?(r(),{type:"MultiPoint",coordinates:t}):null}()||function(){if(!o(/^(multilinestring)/i))return null;r();var e=a();return e?(r(),{type:"MultiLineString",coordinates:e}):null}()||function(){if(!o(/^(multipolygon)/i))return null;r();var e=a();return e?{type:"MultiPolygon",coordinates:e}:null}()||function(){var e,t=[];if(!o(/^(geometrycollection)/i))return null;if(r(),!o(/^(\()/))return null;for(;e=g();)t.push(e),r(),o(/^(,)/),r();return o(/^(\))/)?{type:"GeometryCollection",geometries:t}:null}()}return function(e){return e&&n.match(/\d+/)&&(e.crs={type:"name",properties:{name:"urn:ogc:def:crs:EPSG::"+n}}),e}(g())}const NP=class extends ax{constructor(e={}){super(e),__publicField(this,"_coordinatesKey","coordinates"),__publicField(this,"_parseCoordinates"),__publicField(this,"_parseFeature"),this.type="JSONDataSource",e.coordinatesKey&&(this._coordinatesKey=e.coordinatesKey),e.parseCoordinates&&(this._parseCoordinates=e.parseCoordinates),e.parseFeature&&(this._parseFeature=e.parseFeature)}async _convertStreamingDataToObjectData(e){return await e.json()}_convertObjectDataToJSONData(e){return Array.isArray(e)?e:[e]}_parseObjectDataToDataItems(e){const t=this._convertObjectDataToJSONData(e),i=[];for(let n=0,s=t.length;n<s;n++){const e=t[n],s={};let o=null;if(this._parseFeature)i.push(this._parseFeature(e));else{for(const t of Object.keys(e))t!==this.coordinatesKey?s[t]=e[t]:this.parseCoordinates||(o=ZP.exports(e[t]));this._parseCoordinates&&(o=this._parseCoordinates(e)),o=this._formatGeometry(o),i.push(new ex({geometry:o,properties:s}))}}return i}get coordinatesKey(){return this._coordinatesKey}set coordinatesKey(e){this._coordinatesKey=e}set parseCoordinates(e){this._parseCoordinates=e}get parseCoordinates(){return this._parseCoordinates}set parseFeature(e){this._parseFeature=e}get parseFeature(){return this._parseFeature}};let FP=NP;__publicField(FP,"fromURL",(async function(e,t){let i=new NP(t);return await i.load(e),i})),__publicField(FP,"fromUrl",(async function(e,t){return console.warn("JSONDataSource.fromUrl is deprecated, please use JSONDataSource.fromURL instead."),await this.fromURL(e,t)})),__publicField(FP,"fromJSON",(function(e,t){let i=new NP(t);return i.setData(e),i}));var XP="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},HP=[],zP=[],LP="undefined"!=typeof Uint8Array?Uint8Array:Array,DP=!1;function KP(){DP=!0;for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=0;t<64;++t)HP[t]=e[t],zP[e.charCodeAt(t)]=t;zP["-".charCodeAt(0)]=62,zP["_".charCodeAt(0)]=63}function YP(e,t,i){for(var n,s,o=[],r=t;r<i;r+=3)n=(e[r]<<16)+(e[r+1]<<8)+e[r+2],o.push(HP[(s=n)>>18&63]+HP[s>>12&63]+HP[s>>6&63]+HP[63&s]);return o.join("")}function PP(e){var t;DP||KP();for(var i=e.length,n=i%3,s="",o=[],r=16383,a=0,l=i-n;a<l;a+=r)o.push(YP(e,a,a+r>l?l:a+r));return 1===n?(t=e[i-1],s+=HP[t>>2],s+=HP[t<<4&63],s+="=="):2===n&&(t=(e[i-2]<<8)+e[i-1],s+=HP[t>>10],s+=HP[t>>4&63],s+=HP[t<<2&63],s+="="),o.push(s),o.join("")}function kP(e,t,i,n,s){var o,r,a=8*s-n-1,l=(1<<a)-1,g=l>>1,c=-7,d=i?s-1:0,h=i?-1:1,u=e[t+d];for(d+=h,o=u&(1<<-c)-1,u>>=-c,c+=a;c>0;o=256*o+e[t+d],d+=h,c-=8);for(r=o&(1<<-c)-1,o>>=-c,c+=n;c>0;r=256*r+e[t+d],d+=h,c-=8);if(0===o)o=1-g;else{if(o===l)return r?NaN:1/0*(u?-1:1);r+=Math.pow(2,n),o-=g}return(u?-1:1)*r*Math.pow(2,o-n)}function OP(e,t,i,n,s,o){var r,a,l,g=8*o-s-1,c=(1<<g)-1,d=c>>1,h=23===s?Math.pow(2,-24)-Math.pow(2,-77):0,u=n?0:o-1,I=n?1:-1,p=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,r=c):(r=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-r))<1&&(r--,l*=2),(t+=r+d>=1?h/l:h*Math.pow(2,1-d))*l>=2&&(r++,l/=2),r+d>=c?(a=0,r=c):r+d>=1?(a=(t*l-1)*Math.pow(2,s),r+=d):(a=t*Math.pow(2,d-1)*Math.pow(2,s),r=0));s>=8;e[i+u]=255&a,u+=I,a/=256,s-=8);for(r=r<<s|a,g+=s;g>0;e[i+u]=255&r,u+=I,r/=256,g-=8);e[i+u-I]|=128*p}var UP={}.toString,QP=Array.isArray||function(e){return"[object Array]"==UP.call(e)};function JP(){return qP.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function jP(e,t){if(JP()<t)throw new RangeError("Invalid typed array length");return qP.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=qP.prototype:(null===e&&(e=new qP(t)),e.length=t),e}function qP(e,t,i){if(!(qP.TYPED_ARRAY_SUPPORT||this instanceof qP))return new qP(e,t,i);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return tk(this,e)}return $P(this,e,t,i)}function $P(e,t,i,n){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,i,n){if(t.byteLength,i<0||t.byteLength<i)throw new RangeError("'offset' is out of bounds");if(t.byteLength<i+(n||0))throw new RangeError("'length' is out of bounds");t=void 0===i&&void 0===n?new Uint8Array(t):void 0===n?new Uint8Array(t,i):new Uint8Array(t,i,n);qP.TYPED_ARRAY_SUPPORT?(e=t).__proto__=qP.prototype:e=ik(e,t);return e}(e,t,i,n):"string"==typeof t?function(e,t,i){"string"==typeof i&&""!==i||(i="utf8");if(!qP.isEncoding(i))throw new TypeError('"encoding" must be a valid string encoding');var n=0|ok(t,i);e=jP(e,n);var s=e.write(t,i);s!==n&&(e=e.slice(0,s));return e}(e,t,i):function(e,t){if(sk(t)){var i=0|nk(t.length);return 0===(e=jP(e,i)).length||t.copy(e,0,0,i),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(n=t.length)!=n?jP(e,0):ik(e,t);if("Buffer"===t.type&&QP(t.data))return ik(e,t.data)}var n;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function ek(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function tk(e,t){if(ek(t),e=jP(e,t<0?0:0|nk(t)),!qP.TYPED_ARRAY_SUPPORT)for(var i=0;i<t;++i)e[i]=0;return e}function ik(e,t){var i=t.length<0?0:0|nk(t.length);e=jP(e,i);for(var n=0;n<i;n+=1)e[n]=255&t[n];return e}function nk(e){if(e>=JP())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+JP().toString(16)+" bytes");return 0|e}function sk(e){return!(null==e||!e._isBuffer)}function ok(e,t){if(sk(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var i=e.length;if(0===i)return 0;for(var n=!1;;)switch(t){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":case void 0:return Zk(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return Vk(e).length;default:if(n)return Zk(e).length;t=(""+t).toLowerCase(),n=!0}}function rk(e,t,i){var n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return yk(this,t,i);case"utf8":case"utf-8":return Ak(this,t,i);case"ascii":return fk(this,t,i);case"latin1":case"binary":return bk(this,t,i);case"base64":return mk(this,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return _k(this,t,i);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function ak(e,t,i){var n=e[t];e[t]=e[i],e[i]=n}function lk(e,t,i,n,s){if(0===e.length)return-1;if("string"==typeof i?(n=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),i=+i,isNaN(i)&&(i=s?0:e.length-1),i<0&&(i=e.length+i),i>=e.length){if(s)return-1;i=e.length-1}else if(i<0){if(!s)return-1;i=0}if("string"==typeof t&&(t=qP.from(t,n)),sk(t))return 0===t.length?-1:gk(e,t,i,n,s);if("number"==typeof t)return t&=255,qP.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?s?Uint8Array.prototype.indexOf.call(e,t,i):Uint8Array.prototype.lastIndexOf.call(e,t,i):gk(e,[t],i,n,s);throw new TypeError("val must be string, number or Buffer")}function gk(e,t,i,n,s){var o,r=1,a=e.length,l=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;r=2,a/=2,l/=2,i/=2}function g(e,t){return 1===r?e[t]:e.readUInt16BE(t*r)}if(s){var c=-1;for(o=i;o<a;o++)if(g(e,o)===g(t,-1===c?0:o-c)){if(-1===c&&(c=o),o-c+1===l)return c*r}else-1!==c&&(o-=o-c),c=-1}else for(i+l>a&&(i=a-l),o=i;o>=0;o--){for(var d=!0,h=0;h<l;h++)if(g(e,o+h)!==g(t,h)){d=!1;break}if(d)return o}return-1}function ck(e,t,i,n){i=Number(i)||0;var s=e.length-i;n?(n=Number(n))>s&&(n=s):n=s;var o=t.length;if(o%2!=0)throw new TypeError("Invalid hex string");n>o/2&&(n=o/2);for(var r=0;r<n;++r){var a=parseInt(t.substr(2*r,2),16);if(isNaN(a))return r;e[i+r]=a}return r}function dk(e,t,i,n){return Wk(Zk(t,e.length-i),e,i,n)}function hk(e,t,i,n){return Wk(function(e){for(var t=[],i=0;i<e.length;++i)t.push(255&e.charCodeAt(i));return t}(t),e,i,n)}function uk(e,t,i,n){return hk(e,t,i,n)}function Ik(e,t,i,n){return Wk(Vk(t),e,i,n)}function pk(e,t,i,n){return Wk(function(e,t){for(var i,n,s,o=[],r=0;r<e.length&&!((t-=2)<0);++r)n=(i=e.charCodeAt(r))>>8,s=i%256,o.push(s),o.push(n);return o}(t,e.length-i),e,i,n)}function mk(e,t,i){return 0===t&&i===e.length?PP(e):PP(e.slice(t,i))}function Ak(e,t,i){i=Math.min(e.length,i);for(var n=[],s=t;s<i;){var o,r,a,l,g=e[s],c=null,d=g>239?4:g>223?3:g>191?2:1;if(s+d<=i)switch(d){case 1:g<128&&(c=g);break;case 2:128==(192&(o=e[s+1]))&&(l=(31&g)<<6|63&o)>127&&(c=l);break;case 3:o=e[s+1],r=e[s+2],128==(192&o)&&128==(192&r)&&(l=(15&g)<<12|(63&o)<<6|63&r)>2047&&(l<55296||l>57343)&&(c=l);break;case 4:o=e[s+1],r=e[s+2],a=e[s+3],128==(192&o)&&128==(192&r)&&128==(192&a)&&(l=(15&g)<<18|(63&o)<<12|(63&r)<<6|63&a)>65535&&l<1114112&&(c=l)}null===c?(c=65533,d=1):c>65535&&(c-=65536,n.push(c>>>10&1023|55296),c=56320|1023&c),n.push(c),s+=d}return function(e){var t=e.length;if(t<=Ck)return String.fromCharCode.apply(String,e);var i="",n=0;for(;n<t;)i+=String.fromCharCode.apply(String,e.slice(n,n+=Ck));return i}(n)}qP.TYPED_ARRAY_SUPPORT=void 0===XP.TYPED_ARRAY_SUPPORT||XP.TYPED_ARRAY_SUPPORT,JP(),qP.poolSize=8192,qP._augment=function(e){return e.__proto__=qP.prototype,e},qP.from=function(e,t,i){return $P(null,e,t,i)},qP.TYPED_ARRAY_SUPPORT&&(qP.prototype.__proto__=Uint8Array.prototype,qP.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&qP[Symbol.species]),qP.alloc=function(e,t,i){return function(e,t,i,n){return ek(t),t<=0?jP(e,t):void 0!==i?"string"==typeof n?jP(e,t).fill(i,n):jP(e,t).fill(i):jP(e,t)}(null,e,t,i)},qP.allocUnsafe=function(e){return tk(null,e)},qP.allocUnsafeSlow=function(e){return tk(null,e)},qP.isBuffer=Ek,qP.compare=function(e,t){if(!sk(e)||!sk(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var i=e.length,n=t.length,s=0,o=Math.min(i,n);s<o;++s)if(e[s]!==t[s]){i=e[s],n=t[s];break}return i<n?-1:n<i?1:0},qP.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},qP.concat=function(e,t){if(!QP(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return qP.alloc(0);var i;if(void 0===t)for(t=0,i=0;i<e.length;++i)t+=e[i].length;var n=qP.allocUnsafe(t),s=0;for(i=0;i<e.length;++i){var o=e[i];if(!sk(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(n,s),s+=o.length}return n},qP.byteLength=ok,qP.prototype._isBuffer=!0,qP.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)ak(this,t,t+1);return this},qP.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)ak(this,t,t+3),ak(this,t+1,t+2);return this},qP.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)ak(this,t,t+7),ak(this,t+1,t+6),ak(this,t+2,t+5),ak(this,t+3,t+4);return this},qP.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?Ak(this,0,e):rk.apply(this,arguments)},qP.prototype.equals=function(e){if(!sk(e))throw new TypeError("Argument must be a Buffer");return this===e||0===qP.compare(this,e)},qP.prototype.inspect=function(){var e="";return this.length>0&&(e=this.toString("hex",0,50).match(/.{2}/g).join(" "),this.length>50&&(e+=" ... ")),"<Buffer "+e+">"},qP.prototype.compare=function(e,t,i,n,s){if(!sk(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===i&&(i=e?e.length:0),void 0===n&&(n=0),void 0===s&&(s=this.length),t<0||i>e.length||n<0||s>this.length)throw new RangeError("out of range index");if(n>=s&&t>=i)return 0;if(n>=s)return-1;if(t>=i)return 1;if(this===e)return 0;for(var o=(s>>>=0)-(n>>>=0),r=(i>>>=0)-(t>>>=0),a=Math.min(o,r),l=this.slice(n,s),g=e.slice(t,i),c=0;c<a;++c)if(l[c]!==g[c]){o=l[c],r=g[c];break}return o<r?-1:r<o?1:0},qP.prototype.includes=function(e,t,i){return-1!==this.indexOf(e,t,i)},qP.prototype.indexOf=function(e,t,i){return lk(this,e,t,i,!0)},qP.prototype.lastIndexOf=function(e,t,i){return lk(this,e,t,i,!1)},qP.prototype.write=function(e,t,i,n){if(void 0===t)n="utf8",i=this.length,t=0;else if(void 0===i&&"string"==typeof t)n=t,i=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(i)?(i|=0,void 0===n&&(n="utf8")):(n=i,i=void 0)}var s=this.length-t;if((void 0===i||i>s)&&(i=s),e.length>0&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var o=!1;;)switch(n){case"hex":return ck(this,e,t,i);case"utf8":case"utf-8":return dk(this,e,t,i);case"ascii":return hk(this,e,t,i);case"latin1":case"binary":return uk(this,e,t,i);case"base64":return Ik(this,e,t,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return pk(this,e,t,i);default:if(o)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),o=!0}},qP.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var Ck=4096;function fk(e,t,i){var n="";i=Math.min(e.length,i);for(var s=t;s<i;++s)n+=String.fromCharCode(127&e[s]);return n}function bk(e,t,i){var n="";i=Math.min(e.length,i);for(var s=t;s<i;++s)n+=String.fromCharCode(e[s]);return n}function yk(e,t,i){var n=e.length;(!t||t<0)&&(t=0),(!i||i<0||i>n)&&(i=n);for(var s="",o=t;o<i;++o)s+=Tk(e[o]);return s}function _k(e,t,i){for(var n=e.slice(t,i),s="",o=0;o<n.length;o+=2)s+=String.fromCharCode(n[o]+256*n[o+1]);return s}function vk(e,t,i){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>i)throw new RangeError("Trying to access beyond buffer length")}function xk(e,t,i,n,s,o){if(!sk(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>s||t<o)throw new RangeError('"value" argument is out of bounds');if(i+n>e.length)throw new RangeError("Index out of range")}function Bk(e,t,i,n){t<0&&(t=65535+t+1);for(var s=0,o=Math.min(e.length-i,2);s<o;++s)e[i+s]=(t&255<<8*(n?s:1-s))>>>8*(n?s:1-s)}function wk(e,t,i,n){t<0&&(t=4294967295+t+1);for(var s=0,o=Math.min(e.length-i,4);s<o;++s)e[i+s]=t>>>8*(n?s:3-s)&255}function Sk(e,t,i,n,s,o){if(i+n>e.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function Gk(e,t,i,n,s){return s||Sk(e,0,i,4),OP(e,t,i,n,23,4),i+4}function Mk(e,t,i,n,s){return s||Sk(e,0,i,8),OP(e,t,i,n,52,8),i+8}qP.prototype.slice=function(e,t){var i,n=this.length;if((e=~~e)<0?(e+=n)<0&&(e=0):e>n&&(e=n),(t=void 0===t?n:~~t)<0?(t+=n)<0&&(t=0):t>n&&(t=n),t<e&&(t=e),qP.TYPED_ARRAY_SUPPORT)(i=this.subarray(e,t)).__proto__=qP.prototype;else{var s=t-e;i=new qP(s,void 0);for(var o=0;o<s;++o)i[o]=this[o+e]}return i},qP.prototype.readUIntLE=function(e,t,i){e|=0,t|=0,i||vk(e,t,this.length);for(var n=this[e],s=1,o=0;++o<t&&(s*=256);)n+=this[e+o]*s;return n},qP.prototype.readUIntBE=function(e,t,i){e|=0,t|=0,i||vk(e,t,this.length);for(var n=this[e+--t],s=1;t>0&&(s*=256);)n+=this[e+--t]*s;return n},qP.prototype.readUInt8=function(e,t){return t||vk(e,1,this.length),this[e]},qP.prototype.readUInt16LE=function(e,t){return t||vk(e,2,this.length),this[e]|this[e+1]<<8},qP.prototype.readUInt16BE=function(e,t){return t||vk(e,2,this.length),this[e]<<8|this[e+1]},qP.prototype.readUInt32LE=function(e,t){return t||vk(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},qP.prototype.readUInt32BE=function(e,t){return t||vk(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},qP.prototype.readIntLE=function(e,t,i){e|=0,t|=0,i||vk(e,t,this.length);for(var n=this[e],s=1,o=0;++o<t&&(s*=256);)n+=this[e+o]*s;return n>=(s*=128)&&(n-=Math.pow(2,8*t)),n},qP.prototype.readIntBE=function(e,t,i){e|=0,t|=0,i||vk(e,t,this.length);for(var n=t,s=1,o=this[e+--n];n>0&&(s*=256);)o+=this[e+--n]*s;return o>=(s*=128)&&(o-=Math.pow(2,8*t)),o},qP.prototype.readInt8=function(e,t){return t||vk(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},qP.prototype.readInt16LE=function(e,t){t||vk(e,2,this.length);var i=this[e]|this[e+1]<<8;return 32768&i?4294901760|i:i},qP.prototype.readInt16BE=function(e,t){t||vk(e,2,this.length);var i=this[e+1]|this[e]<<8;return 32768&i?4294901760|i:i},qP.prototype.readInt32LE=function(e,t){return t||vk(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},qP.prototype.readInt32BE=function(e,t){return t||vk(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},qP.prototype.readFloatLE=function(e,t){return t||vk(e,4,this.length),kP(this,e,!0,23,4)},qP.prototype.readFloatBE=function(e,t){return t||vk(e,4,this.length),kP(this,e,!1,23,4)},qP.prototype.readDoubleLE=function(e,t){return t||vk(e,8,this.length),kP(this,e,!0,52,8)},qP.prototype.readDoubleBE=function(e,t){return t||vk(e,8,this.length),kP(this,e,!1,52,8)},qP.prototype.writeUIntLE=function(e,t,i,n){(e=+e,t|=0,i|=0,n)||xk(this,e,t,i,Math.pow(2,8*i)-1,0);var s=1,o=0;for(this[t]=255&e;++o<i&&(s*=256);)this[t+o]=e/s&255;return t+i},qP.prototype.writeUIntBE=function(e,t,i,n){(e=+e,t|=0,i|=0,n)||xk(this,e,t,i,Math.pow(2,8*i)-1,0);var s=i-1,o=1;for(this[t+s]=255&e;--s>=0&&(o*=256);)this[t+s]=e/o&255;return t+i},qP.prototype.writeUInt8=function(e,t,i){return e=+e,t|=0,i||xk(this,e,t,1,255,0),qP.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},qP.prototype.writeUInt16LE=function(e,t,i){return e=+e,t|=0,i||xk(this,e,t,2,65535,0),qP.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):Bk(this,e,t,!0),t+2},qP.prototype.writeUInt16BE=function(e,t,i){return e=+e,t|=0,i||xk(this,e,t,2,65535,0),qP.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):Bk(this,e,t,!1),t+2},qP.prototype.writeUInt32LE=function(e,t,i){return e=+e,t|=0,i||xk(this,e,t,4,4294967295,0),qP.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):wk(this,e,t,!0),t+4},qP.prototype.writeUInt32BE=function(e,t,i){return e=+e,t|=0,i||xk(this,e,t,4,4294967295,0),qP.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):wk(this,e,t,!1),t+4},qP.prototype.writeIntLE=function(e,t,i,n){if(e=+e,t|=0,!n){var s=Math.pow(2,8*i-1);xk(this,e,t,i,s-1,-s)}var o=0,r=1,a=0;for(this[t]=255&e;++o<i&&(r*=256);)e<0&&0===a&&0!==this[t+o-1]&&(a=1),this[t+o]=(e/r>>0)-a&255;return t+i},qP.prototype.writeIntBE=function(e,t,i,n){if(e=+e,t|=0,!n){var s=Math.pow(2,8*i-1);xk(this,e,t,i,s-1,-s)}var o=i-1,r=1,a=0;for(this[t+o]=255&e;--o>=0&&(r*=256);)e<0&&0===a&&0!==this[t+o+1]&&(a=1),this[t+o]=(e/r>>0)-a&255;return t+i},qP.prototype.writeInt8=function(e,t,i){return e=+e,t|=0,i||xk(this,e,t,1,127,-128),qP.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},qP.prototype.writeInt16LE=function(e,t,i){return e=+e,t|=0,i||xk(this,e,t,2,32767,-32768),qP.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):Bk(this,e,t,!0),t+2},qP.prototype.writeInt16BE=function(e,t,i){return e=+e,t|=0,i||xk(this,e,t,2,32767,-32768),qP.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):Bk(this,e,t,!1),t+2},qP.prototype.writeInt32LE=function(e,t,i){return e=+e,t|=0,i||xk(this,e,t,4,2147483647,-2147483648),qP.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):wk(this,e,t,!0),t+4},qP.prototype.writeInt32BE=function(e,t,i){return e=+e,t|=0,i||xk(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),qP.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):wk(this,e,t,!1),t+4},qP.prototype.writeFloatLE=function(e,t,i){return Gk(this,e,t,!0,i)},qP.prototype.writeFloatBE=function(e,t,i){return Gk(this,e,t,!1,i)},qP.prototype.writeDoubleLE=function(e,t,i){return Mk(this,e,t,!0,i)},qP.prototype.writeDoubleBE=function(e,t,i){return Mk(this,e,t,!1,i)},qP.prototype.copy=function(e,t,i,n){if(i||(i=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<i&&(n=i),n===i)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("sourceStart out of bounds");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-i&&(n=e.length-t+i);var s,o=n-i;if(this===e&&i<t&&t<n)for(s=o-1;s>=0;--s)e[s+t]=this[s+i];else if(o<1e3||!qP.TYPED_ARRAY_SUPPORT)for(s=0;s<o;++s)e[s+t]=this[s+i];else Uint8Array.prototype.set.call(e,this.subarray(i,i+o),t);return o},qP.prototype.fill=function(e,t,i,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,i=this.length):"string"==typeof i&&(n=i,i=this.length),1===e.length){var s=e.charCodeAt(0);s<256&&(e=s)}if(void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!qP.isEncoding(n))throw new TypeError("Unknown encoding: "+n)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<i)throw new RangeError("Out of range index");if(i<=t)return this;var o;if(t>>>=0,i=void 0===i?this.length:i>>>0,e||(e=0),"number"==typeof e)for(o=t;o<i;++o)this[o]=e;else{var r=sk(e)?e:Zk(new qP(e,n).toString()),a=r.length;for(o=0;o<i-t;++o)this[o+t]=r[o%a]}return this};var Rk=/[^+\/0-9A-Za-z-_]/g;function Tk(e){return e<16?"0"+e.toString(16):e.toString(16)}function Zk(e,t){var i;t=t||1/0;for(var n=e.length,s=null,o=[],r=0;r<n;++r){if((i=e.charCodeAt(r))>55295&&i<57344){if(!s){if(i>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(r+1===n){(t-=3)>-1&&o.push(239,191,189);continue}s=i;continue}if(i<56320){(t-=3)>-1&&o.push(239,191,189),s=i;continue}i=65536+(s-55296<<10|i-56320)}else s&&(t-=3)>-1&&o.push(239,191,189);if(s=null,i<128){if((t-=1)<0)break;o.push(i)}else if(i<2048){if((t-=2)<0)break;o.push(i>>6|192,63&i|128)}else if(i<65536){if((t-=3)<0)break;o.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return o}function Vk(e){return function(e){var t,i,n,s,o,r;DP||KP();var a=e.length;if(a%4>0)throw new Error("Invalid string. Length must be a multiple of 4");o="="===e[a-2]?2:"="===e[a-1]?1:0,r=new LP(3*a/4-o),n=o>0?a-4:a;var l=0;for(t=0,i=0;t<n;t+=4,i+=3)s=zP[e.charCodeAt(t)]<<18|zP[e.charCodeAt(t+1)]<<12|zP[e.charCodeAt(t+2)]<<6|zP[e.charCodeAt(t+3)],r[l++]=s>>16&255,r[l++]=s>>8&255,r[l++]=255&s;return 2===o?(s=zP[e.charCodeAt(t)]<<2|zP[e.charCodeAt(t+1)]>>4,r[l++]=255&s):1===o&&(s=zP[e.charCodeAt(t)]<<10|zP[e.charCodeAt(t+1)]<<4|zP[e.charCodeAt(t+2)]>>2,r[l++]=s>>8&255,r[l++]=255&s),r}(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(Rk,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function Wk(e,t,i,n){for(var s=0;s<n&&!(s+i>=t.length||s>=e.length);++s)t[s+i]=e[s];return s}function Ek(e){return null!=e&&(!!e._isBuffer||Nk(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&Nk(e.slice(0,0))}(e))}function Nk(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}class Fk extends Error{constructor(e,t,i,...n){Array.isArray(t)&&(t=t.join(" ")),super(t),void 0!==Error.captureStackTrace&&Error.captureStackTrace(this,Fk),this.code=e;for(const s of n)for(const e in s){const t=s[e];this[e]=Ek(t)?t.toString(i.encoding):null==t?t:JSON.parse(JSON.stringify(t))}}}const Xk=function(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)},Hk=function(e){const t=[];for(let i=0,n=e.length;i<n;i++){const n=e[i];if(null==n||!1===n)t[i]={disabled:!0};else if("string"==typeof n)t[i]={name:n};else{if(!Xk(n))throw new Fk("CSV_INVALID_COLUMN_DEFINITION",["Invalid column definition:","expect a string or a literal object,",`got ${JSON.stringify(n)} at position ${i}`]);if("string"!=typeof n.name)throw new Fk("CSV_OPTION_COLUMNS_MISSING_NAME",["Option columns missing name:",`property "name" is required at position ${i}`,"when column is an object literal"]);t[i]=n}}return t};class zk{constructor(e=100){this.size=e,this.length=0,this.buf=qP.allocUnsafe(e)}prepend(e){if(Ek(e)){const t=this.length+e.length;if(t>=this.size&&(this.resize(),t>=this.size))throw Error("INVALID_BUFFER_STATE");const i=this.buf;this.buf=qP.allocUnsafe(this.size),e.copy(this.buf,0),i.copy(this.buf,e.length),this.length+=e.length}else{const t=this.length++;t===this.size&&this.resize();const i=this.clone();this.buf[0]=e,i.copy(this.buf,1,0,t)}}append(e){const t=this.length++;t===this.size&&this.resize(),this.buf[t]=e}clone(){return qP.from(this.buf.slice(0,this.length))}resize(){const e=this.length;this.size=2*this.size;const t=qP.allocUnsafe(this.size);this.buf.copy(t,0,0,e),this.buf=t}toString(e){return e?this.buf.slice(0,this.length).toString(e):Uint8Array.prototype.slice.call(this.buf.slice(0,this.length))}toJSON(){return this.toString("utf8")}reset(){this.length=0}}const Lk=function(e){return{bomSkipped:!1,bufBytesStart:0,castField:e.cast_function,commenting:!1,error:void 0,enabled:1===e.from_line,escaping:!1,escapeIsQuote:Ek(e.escape)&&Ek(e.quote)&&0===qP.compare(e.escape,e.quote),expectedRecordLength:Array.isArray(e.columns)?e.columns.length:void 0,field:new zk(20),firstLineToHeaders:e.cast_first_line_to_header,needMoreDataSize:Math.max(null!==e.comment?e.comment.length:0,...e.delimiter.map((e=>e.length)),null!==e.quote?e.quote.length:0),previousBuf:void 0,quoting:!1,stop:!1,rawBuffer:new zk(100),record:[],recordHasError:!1,record_length:0,recordDelimiterMaxLength:0===e.record_delimiter.length?2:Math.max(...e.record_delimiter.map((e=>e.length))),trimChars:[qP.from(" ",e.encoding)[0],qP.from("\t",e.encoding)[0]],wasQuoting:!1,wasRowDelimiter:!1,timchars:[qP.from(qP.from([13],"utf8").toString(),e.encoding),qP.from(qP.from([10],"utf8").toString(),e.encoding),qP.from(qP.from([12],"utf8").toString(),e.encoding),qP.from(qP.from([32],"utf8").toString(),e.encoding),qP.from(qP.from([9],"utf8").toString(),e.encoding)]}},Dk=function(e){const t={};for(const s in e)t[(i=s,i.replace(/([A-Z])/g,(function(e,t){return"_"+t.toLowerCase()})))]=e[s];var i;if(void 0===t.encoding||!0===t.encoding)t.encoding="utf8";else if(null===t.encoding||!1===t.encoding)t.encoding=null;else if("string"!=typeof t.encoding&&null!==t.encoding)throw new Fk("CSV_INVALID_OPTION_ENCODING",["Invalid option encoding:","encoding must be a string or null to return a buffer,",`got ${JSON.stringify(t.encoding)}`],t);if(void 0===t.bom||null===t.bom||!1===t.bom)t.bom=!1;else if(!0!==t.bom)throw new Fk("CSV_INVALID_OPTION_BOM",["Invalid option bom:","bom must be true,",`got ${JSON.stringify(t.bom)}`],t);if(t.cast_function=null,void 0===t.cast||null===t.cast||!1===t.cast||""===t.cast)t.cast=void 0;else if("function"==typeof t.cast)t.cast_function=t.cast,t.cast=!0;else if(!0!==t.cast)throw new Fk("CSV_INVALID_OPTION_CAST",["Invalid option cast:","cast must be true or a function,",`got ${JSON.stringify(t.cast)}`],t);if(void 0===t.cast_date||null===t.cast_date||!1===t.cast_date||""===t.cast_date)t.cast_date=!1;else if(!0===t.cast_date)t.cast_date=function(e){const t=Date.parse(e);return isNaN(t)?e:new Date(t)};else if("function"!=typeof t.cast_date)throw new Fk("CSV_INVALID_OPTION_CAST_DATE",["Invalid option cast_date:","cast_date must be true or a function,",`got ${JSON.stringify(t.cast_date)}`],t);if(t.cast_first_line_to_header=null,!0===t.columns)t.cast_first_line_to_header=void 0;else if("function"==typeof t.columns)t.cast_first_line_to_header=t.columns,t.columns=!0;else if(Array.isArray(t.columns))t.columns=Hk(t.columns);else{if(void 0!==t.columns&&null!==t.columns&&!1!==t.columns)throw new Fk("CSV_INVALID_OPTION_COLUMNS",["Invalid option columns:","expect an array, a function or true,",`got ${JSON.stringify(t.columns)}`],t);t.columns=!1}if(void 0===t.group_columns_by_name||null===t.group_columns_by_name||!1===t.group_columns_by_name)t.group_columns_by_name=!1;else{if(!0!==t.group_columns_by_name)throw new Fk("CSV_INVALID_OPTION_GROUP_COLUMNS_BY_NAME",["Invalid option group_columns_by_name:","expect an boolean,",`got ${JSON.stringify(t.group_columns_by_name)}`],t);if(!1===t.columns)throw new Fk("CSV_INVALID_OPTION_GROUP_COLUMNS_BY_NAME",["Invalid option group_columns_by_name:","the `columns` mode must be activated."],t)}if(void 0===t.comment||null===t.comment||!1===t.comment||""===t.comment)t.comment=null;else if("string"==typeof t.comment&&(t.comment=qP.from(t.comment,t.encoding)),!Ek(t.comment))throw new Fk("CSV_INVALID_OPTION_COMMENT",["Invalid option comment:","comment must be a buffer or a string,",`got ${JSON.stringify(t.comment)}`],t);const n=JSON.stringify(t.delimiter);if(Array.isArray(t.delimiter)||(t.delimiter=[t.delimiter]),0===t.delimiter.length)throw new Fk("CSV_INVALID_OPTION_DELIMITER",["Invalid option delimiter:","delimiter must be a non empty string or buffer or array of string|buffer,",`got ${n}`],t);if(t.delimiter=t.delimiter.map((function(e){if(null==e||!1===e)return qP.from(",",t.encoding);if("string"==typeof e&&(e=qP.from(e,t.encoding)),!Ek(e)||0===e.length)throw new Fk("CSV_INVALID_OPTION_DELIMITER",["Invalid option delimiter:","delimiter must be a non empty string or buffer or array of string|buffer,",`got ${n}`],t);return e})),void 0===t.escape||!0===t.escape?t.escape=qP.from('"',t.encoding):"string"==typeof t.escape?t.escape=qP.from(t.escape,t.encoding):null!==t.escape&&!1!==t.escape||(t.escape=null),null!==t.escape&&!Ek(t.escape))throw new Error(`Invalid Option: escape must be a buffer, a string or a boolean, got ${JSON.stringify(t.escape)}`);if(void 0===t.from||null===t.from)t.from=1;else{if("string"==typeof t.from&&/\d+/.test(t.from)&&(t.from=parseInt(t.from)),!Number.isInteger(t.from))throw new Error(`Invalid Option: from must be an integer, got ${JSON.stringify(t.from)}`);if(t.from<0)throw new Error(`Invalid Option: from must be a positive integer, got ${JSON.stringify(e.from)}`)}if(void 0===t.from_line||null===t.from_line)t.from_line=1;else{if("string"==typeof t.from_line&&/\d+/.test(t.from_line)&&(t.from_line=parseInt(t.from_line)),!Number.isInteger(t.from_line))throw new Error(`Invalid Option: from_line must be an integer, got ${JSON.stringify(e.from_line)}`);if(t.from_line<=0)throw new Error(`Invalid Option: from_line must be a positive integer greater than 0, got ${JSON.stringify(e.from_line)}`)}if(void 0===t.ignore_last_delimiters||null===t.ignore_last_delimiters)t.ignore_last_delimiters=!1;else if("number"==typeof t.ignore_last_delimiters)t.ignore_last_delimiters=Math.floor(t.ignore_last_delimiters),0===t.ignore_last_delimiters&&(t.ignore_last_delimiters=!1);else if("boolean"!=typeof t.ignore_last_delimiters)throw new Fk("CSV_INVALID_OPTION_IGNORE_LAST_DELIMITERS",["Invalid option `ignore_last_delimiters`:","the value must be a boolean value or an integer,",`got ${JSON.stringify(t.ignore_last_delimiters)}`],t);if(!0===t.ignore_last_delimiters&&!1===t.columns)throw new Fk("CSV_IGNORE_LAST_DELIMITERS_REQUIRES_COLUMNS",["The option `ignore_last_delimiters`","requires the activation of the `columns` option"],t);if(void 0===t.info||null===t.info||!1===t.info)t.info=!1;else if(!0!==t.info)throw new Error(`Invalid Option: info must be true, got ${JSON.stringify(t.info)}`);if(void 0===t.max_record_size||null===t.max_record_size||!1===t.max_record_size)t.max_record_size=0;else if(Number.isInteger(t.max_record_size)&&t.max_record_size>=0);else{if("string"!=typeof t.max_record_size||!/\d+/.test(t.max_record_size))throw new Error(`Invalid Option: max_record_size must be a positive integer, got ${JSON.stringify(t.max_record_size)}`);t.max_record_size=parseInt(t.max_record_size)}if(void 0===t.objname||null===t.objname||!1===t.objname)t.objname=void 0;else if(Ek(t.objname)){if(0===t.objname.length)throw new Error("Invalid Option: objname must be a non empty buffer");null===t.encoding||(t.objname=t.objname.toString(t.encoding))}else if("string"==typeof t.objname){if(0===t.objname.length)throw new Error("Invalid Option: objname must be a non empty string")}else if("number"!=typeof t.objname)throw new Error(`Invalid Option: objname must be a string or a buffer, got ${t.objname}`);if(void 0!==t.objname)if("number"==typeof t.objname){if(!1!==t.columns)throw Error("Invalid Option: objname index cannot be combined with columns or be defined as a field")}else if(!1===t.columns)throw Error("Invalid Option: objname field must be combined with columns or be defined as an index");if(void 0===t.on_record||null===t.on_record)t.on_record=void 0;else if("function"!=typeof t.on_record)throw new Fk("CSV_INVALID_OPTION_ON_RECORD",["Invalid option `on_record`:","expect a function,",`got ${JSON.stringify(t.on_record)}`],t);if(null===t.quote||!1===t.quote||""===t.quote)t.quote=null;else if(void 0===t.quote||!0===t.quote?t.quote=qP.from('"',t.encoding):"string"==typeof t.quote&&(t.quote=qP.from(t.quote,t.encoding)),!Ek(t.quote))throw new Error(`Invalid Option: quote must be a buffer or a string, got ${JSON.stringify(t.quote)}`);if(void 0===t.raw||null===t.raw||!1===t.raw)t.raw=!1;else if(!0!==t.raw)throw new Error(`Invalid Option: raw must be true, got ${JSON.stringify(t.raw)}`);if(void 0===t.record_delimiter)t.record_delimiter=[];else if("string"==typeof t.record_delimiter||Ek(t.record_delimiter)){if(0===t.record_delimiter.length)throw new Fk("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a non empty string or buffer,",`got ${JSON.stringify(t.record_delimiter)}`],t);t.record_delimiter=[t.record_delimiter]}else if(!Array.isArray(t.record_delimiter))throw new Fk("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a string, a buffer or array of string|buffer,",`got ${JSON.stringify(t.record_delimiter)}`],t);if(t.record_delimiter=t.record_delimiter.map((function(e,i){if("string"!=typeof e&&!Ek(e))throw new Fk("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a string, a buffer or array of string|buffer",`at index ${i},`,`got ${JSON.stringify(e)}`],t);if(0===e.length)throw new Fk("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a non empty string or buffer",`at index ${i},`,`got ${JSON.stringify(e)}`],t);return"string"==typeof e&&(e=qP.from(e,t.encoding)),e})),"boolean"==typeof t.relax_column_count);else{if(void 0!==t.relax_column_count&&null!==t.relax_column_count)throw new Error(`Invalid Option: relax_column_count must be a boolean, got ${JSON.stringify(t.relax_column_count)}`);t.relax_column_count=!1}if("boolean"==typeof t.relax_column_count_less);else{if(void 0!==t.relax_column_count_less&&null!==t.relax_column_count_less)throw new Error(`Invalid Option: relax_column_count_less must be a boolean, got ${JSON.stringify(t.relax_column_count_less)}`);t.relax_column_count_less=!1}if("boolean"==typeof t.relax_column_count_more);else{if(void 0!==t.relax_column_count_more&&null!==t.relax_column_count_more)throw new Error(`Invalid Option: relax_column_count_more must be a boolean, got ${JSON.stringify(t.relax_column_count_more)}`);t.relax_column_count_more=!1}if("boolean"==typeof t.relax_quotes);else{if(void 0!==t.relax_quotes&&null!==t.relax_quotes)throw new Error(`Invalid Option: relax_quotes must be a boolean, got ${JSON.stringify(t.relax_quotes)}`);t.relax_quotes=!1}if("boolean"==typeof t.skip_empty_lines);else{if(void 0!==t.skip_empty_lines&&null!==t.skip_empty_lines)throw new Error(`Invalid Option: skip_empty_lines must be a boolean, got ${JSON.stringify(t.skip_empty_lines)}`);t.skip_empty_lines=!1}if("boolean"==typeof t.skip_records_with_empty_values);else{if(void 0!==t.skip_records_with_empty_values&&null!==t.skip_records_with_empty_values)throw new Error(`Invalid Option: skip_records_with_empty_values must be a boolean, got ${JSON.stringify(t.skip_records_with_empty_values)}`);t.skip_records_with_empty_values=!1}if("boolean"==typeof t.skip_records_with_error);else{if(void 0!==t.skip_records_with_error&&null!==t.skip_records_with_error)throw new Error(`Invalid Option: skip_records_with_error must be a boolean, got ${JSON.stringify(t.skip_records_with_error)}`);t.skip_records_with_error=!1}if(void 0===t.rtrim||null===t.rtrim||!1===t.rtrim)t.rtrim=!1;else if(!0!==t.rtrim)throw new Error(`Invalid Option: rtrim must be a boolean, got ${JSON.stringify(t.rtrim)}`);if(void 0===t.ltrim||null===t.ltrim||!1===t.ltrim)t.ltrim=!1;else if(!0!==t.ltrim)throw new Error(`Invalid Option: ltrim must be a boolean, got ${JSON.stringify(t.ltrim)}`);if(void 0===t.trim||null===t.trim||!1===t.trim)t.trim=!1;else if(!0!==t.trim)throw new Error(`Invalid Option: trim must be a boolean, got ${JSON.stringify(t.trim)}`);if(!0===t.trim&&!1!==e.ltrim?t.ltrim=!0:!0!==t.ltrim&&(t.ltrim=!1),!0===t.trim&&!1!==e.rtrim?t.rtrim=!0:!0!==t.rtrim&&(t.rtrim=!1),void 0===t.to||null===t.to)t.to=-1;else{if("string"==typeof t.to&&/\d+/.test(t.to)&&(t.to=parseInt(t.to)),!Number.isInteger(t.to))throw new Error(`Invalid Option: to must be an integer, got ${JSON.stringify(e.to)}`);if(t.to<=0)throw new Error(`Invalid Option: to must be a positive integer greater than 0, got ${JSON.stringify(e.to)}`)}if(void 0===t.to_line||null===t.to_line)t.to_line=-1;else{if("string"==typeof t.to_line&&/\d+/.test(t.to_line)&&(t.to_line=parseInt(t.to_line)),!Number.isInteger(t.to_line))throw new Error(`Invalid Option: to_line must be an integer, got ${JSON.stringify(e.to_line)}`);if(t.to_line<=0)throw new Error(`Invalid Option: to_line must be a positive integer greater than 0, got ${JSON.stringify(e.to_line)}`)}return t},Kk=function(e){return e.every((e=>null==e||e.toString&&""===e.toString().trim()))},Yk={utf8:qP.from([239,187,191]),utf16le:qP.from([255,254])},Pk=function(e,t={}){"string"==typeof e&&(e=qP.from(e));const i=t&&t.objname?{}:[],n=function(e={}){const t=Dk(e);return{info:{bytes:0,comment_lines:0,empty_lines:0,invalid_field_length:0,lines:1,records:0},original_options:e,options:t,state:Lk(t),__needMoreData:function(e,t,i){if(i)return!1;const{quote:n}=this.options,{quoting:s,needMoreDataSize:o,recordDelimiterMaxLength:r}=this.state;return t-e-1<Math.max(o,r,s?n.length+r:0)},parse:function(e,t,i,n){const{bom:s,from_line:o,ltrim:r,max_record_size:a,raw:l,relax_quotes:g,rtrim:c,skip_empty_lines:d,to:h,to_line:u}=this.options;let{comment:I,escape:p,quote:m,record_delimiter:A}=this.options;const{bomSkipped:C,previousBuf:f,rawBuffer:b,escapeIsQuote:y}=this.state;let _;if(void 0===f){if(void 0===e)return void n();_=e}else _=void 0!==f&&void 0===e?f:qP.concat([f,e]);if(!1===C)if(!1===s)this.state.bomSkipped=!0;else if(_.length<3){if(!1===t)return void(this.state.previousBuf=_)}else{for(const e in Yk)if(0===Yk[e].compare(_,0,Yk[e].length)){const t=Yk[e].length;this.state.bufBytesStart+=t,_=_.slice(t),this.options=Dk({...this.original_options,encoding:e}),({comment:I,escape:p,quote:m}=this.options);break}this.state.bomSkipped=!0}const v=_.length;let x;for(x=0;x<v&&!this.__needMoreData(x,v,t);x++){if(!0===this.state.wasRowDelimiter&&(this.info.lines++,this.state.wasRowDelimiter=!1),-1!==u&&this.info.lines>u)return this.state.stop=!0,void n();!1===this.state.quoting&&0===A.length&&this.__autoDiscoverRecordDelimiter(_,x)&&(A=this.options.record_delimiter);const e=_[x];if(!0===l&&b.append(e),13!==e&&10!==e||!1!==this.state.wasRowDelimiter||(this.state.wasRowDelimiter=!0),!0===this.state.escaping)this.state.escaping=!1;else{if(null!==p&&!0===this.state.quoting&&this.__isEscape(_,x,e)&&x+p.length<v){if(!y){this.state.escaping=!0,x+=p.length-1;continue}if(this.__isQuote(_,x+p.length)){this.state.escaping=!0,x+=p.length-1;continue}}if(!1===this.state.commenting&&this.__isQuote(_,x))if(!0===this.state.quoting){const t=_[x+m.length],i=c&&this.__isCharTrimable(_,x+m.length),n=null!==I&&this.__compareBytes(I,_,x+m.length,t),s=this.__isDelimiter(_,x+m.length,t),o=0===A.length?this.__autoDiscoverRecordDelimiter(_,x+m.length):this.__isRecordDelimiter(t,_,x+m.length);if(null!==p&&this.__isEscape(_,x,e)&&this.__isQuote(_,x+p.length))x+=p.length-1;else{if(!t||s||o||n||i){this.state.quoting=!1,this.state.wasQuoting=!0,x+=m.length-1;continue}if(!1===g){const e=this.__error(new Fk("CSV_INVALID_CLOSING_QUOTE",["Invalid Closing Quote:",`got "${String.fromCharCode(t)}"`,`at line ${this.info.lines}`,"instead of delimiter, record delimiter, trimable character","(if activated) or comment"],this.options,this.__infoField()));if(void 0!==e)return e}else this.state.quoting=!1,this.state.wasQuoting=!0,this.state.field.prepend(m),x+=m.length-1}}else{if(0===this.state.field.length){this.state.quoting=!0,x+=m.length-1;continue}if(!1===g){const e=this.__error(new Fk("INVALID_OPENING_QUOTE",["Invalid Opening Quote:",`a quote is found inside a field at line ${this.info.lines}`],this.options,this.__infoField(),{field:this.state.field}));if(void 0!==e)return e}}if(!1===this.state.quoting){const t=this.__isRecordDelimiter(e,_,x);if(0!==t){if(this.state.commenting&&!1===this.state.wasQuoting&&0===this.state.record.length&&0===this.state.field.length)this.info.comment_lines++;else{if(!1===this.state.enabled&&this.info.lines+(!0===this.state.wasRowDelimiter?1:0)>=o){this.state.enabled=!0,this.__resetField(),this.__resetRecord(),x+=t-1;continue}if(!0===d&&!1===this.state.wasQuoting&&0===this.state.record.length&&0===this.state.field.length){this.info.empty_lines++,x+=t-1;continue}this.info.bytes=this.state.bufBytesStart+x;const e=this.__onField();if(void 0!==e)return e;this.info.bytes=this.state.bufBytesStart+x+t;const s=this.__onRecord(i);if(void 0!==s)return s;if(-1!==h&&this.info.records>=h)return this.state.stop=!0,void n()}this.state.commenting=!1,x+=t-1;continue}if(this.state.commenting)continue;if(0!==(null===I?0:this.__compareBytes(I,_,x,e))){this.state.commenting=!0;continue}const s=this.__isDelimiter(_,x,e);if(0!==s){this.info.bytes=this.state.bufBytesStart+x;const e=this.__onField();if(void 0!==e)return e;x+=s-1;continue}}}if(!1===this.state.commenting&&0!==a&&this.state.record_length+this.state.field.length>a)return this.__error(new Fk("CSV_MAX_RECORD_SIZE",["Max Record Size:","record exceed the maximum number of tolerated bytes",`of ${a}`,`at line ${this.info.lines}`],this.options,this.__infoField()));const t=!1===r||!0===this.state.quoting||0!==this.state.field.length||!this.__isCharTrimable(_,x),s=!1===c||!1===this.state.wasQuoting;if(!0!==t||!0!==s){if(!0!==c||this.__isCharTrimable(_,x)){!1===t&&(x+=this.__isCharTrimable(_,x)-1);continue}return this.__error(new Fk("CSV_NON_TRIMABLE_CHAR_AFTER_CLOSING_QUOTE",["Invalid Closing Quote:","found non trimable byte after quote",`at line ${this.info.lines}`],this.options,this.__infoField()))}this.state.field.append(e)}if(!0===t)if(!0===this.state.quoting){const e=this.__error(new Fk("CSV_QUOTE_NOT_CLOSED",["Quote Not Closed:",`the parsing is finished with an opening quote at line ${this.info.lines}`],this.options,this.__infoField()));if(void 0!==e)return e}else if(!0===this.state.wasQuoting||0!==this.state.record.length||0!==this.state.field.length){this.info.bytes=this.state.bufBytesStart+x;const e=this.__onField();if(void 0!==e)return e;const t=this.__onRecord(i);if(void 0!==t)return t}else!0===this.state.wasRowDelimiter?this.info.empty_lines++:!0===this.state.commenting&&this.info.comment_lines++;else this.state.bufBytesStart+=x,this.state.previousBuf=_.slice(x);!0===this.state.wasRowDelimiter&&(this.info.lines++,this.state.wasRowDelimiter=!1)},__onRecord:function(e){const{columns:t,group_columns_by_name:i,encoding:n,info:s,from:o,relax_column_count:r,relax_column_count_less:a,relax_column_count_more:l,raw:g,skip_records_with_empty_values:c}=this.options,{enabled:d,record:h}=this.state;if(!1===d)return this.__resetRecord();const u=h.length;if(!0===t)return!0===c&&Kk(h)?void this.__resetRecord():this.__firstLineToColumns(h);if(!1===t&&0===this.info.records&&(this.state.expectedRecordLength=u),u!==this.state.expectedRecordLength){const e=!1===t?new Fk("CSV_RECORD_INCONSISTENT_FIELDS_LENGTH",["Invalid Record Length:",`expect ${this.state.expectedRecordLength},`,`got ${u} on line ${this.info.lines}`],this.options,this.__infoField(),{record:h}):new Fk("CSV_RECORD_INCONSISTENT_COLUMNS",["Invalid Record Length:",`columns length is ${t.length},`,`got ${u} on line ${this.info.lines}`],this.options,this.__infoField(),{record:h});if(!0===r||!0===a&&u<this.state.expectedRecordLength||!0===l&&u>this.state.expectedRecordLength)this.info.invalid_field_length++,this.state.error=e;else{const t=this.__error(e);if(t)return t}}if(!0===c&&Kk(h))this.__resetRecord();else{if(!0===this.state.recordHasError)return this.__resetRecord(),void(this.state.recordHasError=!1);if(this.info.records++,1===o||this.info.records>=o){const{objname:o}=this.options;if(!1!==t){const r={};for(let e=0,n=h.length;e<n;e++)void 0===t[e]||t[e].disabled||(!0===i&&void 0!==r[t[e].name]?Array.isArray(r[t[e].name])?r[t[e].name]=r[t[e].name].concat(h[e]):r[t[e].name]=[r[t[e].name],h[e]]:r[t[e].name]=h[e]);if(!0===g||!0===s){const t=Object.assign({record:r},!0===g?{raw:this.state.rawBuffer.toString(n)}:{},!0===s?{info:this.__infoRecord()}:{}),i=this.__push(void 0===o?t:[r[o],t],e);if(i)return i}else{const t=this.__push(void 0===o?r:[r[o],r],e);if(t)return t}}else if(!0===g||!0===s){const t=Object.assign({record:h},!0===g?{raw:this.state.rawBuffer.toString(n)}:{},!0===s?{info:this.__infoRecord()}:{}),i=this.__push(void 0===o?t:[h[o],t],e);if(i)return i}else{const t=this.__push(void 0===o?h:[h[o],h],e);if(t)return t}}this.__resetRecord()}},__firstLineToColumns:function(e){const{firstLineToHeaders:t}=this.state;try{const i=void 0===t?e:t.call(null,e);if(!Array.isArray(i))return this.__error(new Fk("CSV_INVALID_COLUMN_MAPPING",["Invalid Column Mapping:","expect an array from column function,",`got ${JSON.stringify(i)}`],this.options,this.__infoField(),{headers:i}));const n=Hk(i);return this.state.expectedRecordLength=n.length,this.options.columns=n,void this.__resetRecord()}catch(i){return i}},__resetRecord:function(){!0===this.options.raw&&this.state.rawBuffer.reset(),this.state.error=void 0,this.state.record=[],this.state.record_length=0},__onField:function(){const{cast:e,encoding:t,rtrim:i,max_record_size:n}=this.options,{enabled:s,wasQuoting:o}=this.state;if(!1===s)return this.__resetField();let r=this.state.field.toString(t);if(!0===i&&!1===o&&(r=r.trimRight()),!0===e){const[e,t]=this.__cast(r);if(void 0!==e)return e;r=t}this.state.record.push(r),0!==n&&"string"==typeof r&&(this.state.record_length+=r.length),this.__resetField()},__resetField:function(){this.state.field.reset(),this.state.wasQuoting=!1},__push:function(e,t){const{on_record:i}=this.options;if(void 0!==i){const t=this.__infoRecord();try{e=i.call(null,e,t)}catch(n){return n}if(null==e)return}t(e)},__cast:function(e){const{columns:t,relax_column_count:i}=this.options;if(!0===Array.isArray(t)&&i&&this.options.columns.length<=this.state.record.length)return[void 0,void 0];if(null!==this.state.castField)try{const t=this.__infoField();return[void 0,this.state.castField.call(null,e,t)]}catch(n){return[n]}if(this.__isFloat(e))return[void 0,parseFloat(e)];if(!1!==this.options.cast_date){const t=this.__infoField();return[void 0,this.options.cast_date.call(null,e,t)]}return[void 0,e]},__isCharTrimable:function(e,t){return((e,t)=>{const{timchars:i}=this.state;e:for(let n=0;n<i.length;n++){const s=i[n];for(let i=0;i<s.length;i++)if(s[i]!==e[t+i])continue e;return s.length}return 0})(e,t)},__isFloat:function(e){return e-parseFloat(e)+1>=0},__compareBytes:function(e,t,i,n){if(e[0]!==n)return 0;const s=e.length;for(let o=1;o<s;o++)if(e[o]!==t[i+o])return 0;return s},__isDelimiter:function(e,t,i){const{delimiter:n,ignore_last_delimiters:s}=this.options;if(!0===s&&this.state.record.length===this.options.columns.length-1)return 0;if(!1!==s&&"number"==typeof s&&this.state.record.length===s-1)return 0;e:for(let o=0;o<n.length;o++){const s=n[o];if(s[0]===i){for(let i=1;i<s.length;i++)if(s[i]!==e[t+i])continue e;return s.length}}return 0},__isRecordDelimiter:function(e,t,i){const{record_delimiter:n}=this.options,s=n.length;e:for(let o=0;o<s;o++){const s=n[o],r=s.length;if(s[0]===e){for(let e=1;e<r;e++)if(s[e]!==t[i+e])continue e;return s.length}}return 0},__isEscape:function(e,t,i){const{escape:n}=this.options;if(null===n)return!1;const s=n.length;if(n[0]===i){for(let i=0;i<s;i++)if(n[i]!==e[t+i])return!1;return!0}return!1},__isQuote:function(e,t){const{quote:i}=this.options;if(null===i)return!1;const n=i.length;for(let s=0;s<n;s++)if(i[s]!==e[t+s])return!1;return!0},__autoDiscoverRecordDelimiter:function(e,t){const{encoding:i}=this.options,n=e[t];return 13===n?10===e[t+1]?(this.options.record_delimiter.push(qP.from("\r\n",i)),this.state.recordDelimiterMaxLength=2,2):(this.options.record_delimiter.push(qP.from("\r",i)),this.state.recordDelimiterMaxLength=1,1):10===n?(this.options.record_delimiter.push(qP.from("\n",i)),this.state.recordDelimiterMaxLength=1,1):0},__error:function(e){const{encoding:t,raw:i,skip_records_with_error:n}=this.options,s="string"==typeof e?new Error(e):e;return n?(this.state.recordHasError=!0,void(void 0!==this.options.on_skip&&this.options.on_skip(s,i?this.state.rawBuffer.toString(t):void 0))):s},__infoDataSet:function(){return{...this.info,columns:this.options.columns}},__infoRecord:function(){const{columns:e,raw:t,encoding:i}=this.options;return{...this.__infoDataSet(),error:this.state.error,header:!0===e,index:this.state.record.length,raw:t?this.state.rawBuffer.toString(i):void 0}},__infoField:function(){const{columns:e}=this.options,t=Array.isArray(e);return{...this.__infoRecord(),column:!0===t?e.length>this.state.record.length?e[this.state.record.length].name:null:this.state.record.length,quoting:this.state.wasQuoting}}}}(t),s=e=>{void 0===n.options.objname?i.push(e):i[e[0]]=e[1]},o=()=>{},r=n.parse(e,!1,s,o);if(void 0!==r)throw r;const a=n.parse(void 0,!0,s,o);if(void 0!==a)throw a;return i},kk=class extends FP{constructor(e){super(e),this.type="CSVDataSource"}async _convertStreamingDataToObjectData(e){return await e.text()}_convertObjectDataToJSONData(e){return Pk(e,{columns:!0,skip_empty_lines:!0})}};let Ok=kk;__publicField(Ok,"fromURL",(async function(e,t){let i=new kk(t);return await i.load(e),i})),__publicField(Ok,"fromUrl",(async function(e,t){return console.warn("CSVDataSource.fromUrl is deprecated, please use CSVDataSource.fromURL instead."),await this.fromURL(e,t)})),__publicField(Ok,"fromCSVString",(function(e,t){let i=new kk(t);return i.setData(e),i})),new yg,new Cs(new Qt(0,0,1),0);const Uk=new Qt,Qk=new Bi;class Jk extends Ji{constructor(e={}){super(e),__publicField(this,"_container"),__publicField(this,"_point"),__publicField(this,"_dom"),__publicField(this,"_div"),__publicField(this,"_visible"),__publicField(this,"_offset"),__publicField(this,"_stopPropagation",!1),__publicField(this,"_enableDragging",!1),__publicField(this,"handleMouseDown",(e=>{e.preventDefault();const t=this.engine.rendering.canvas.getBoundingClientRect();this._sub=(new bt).set(this._screenPos.x-e.x+t.left,this._screenPos.y-e.y+t.top),(this.stopPropagation||this.enableDragging)&&e.stopPropagation(),mw?(e.target.setPointerCapture(e.pointerId),document.addEventListener(fw.MOVE,this.handleMouseMove),document.addEventListener(fw.UP,this.handleMouseUp)):(document.addEventListener(fw.MOVE,this.handleMouseMove),document.addEventListener(fw.UP,this.handleMouseUp))})),__publicField(this,"handleMouseUp",(e=>{document.removeEventListener(fw.MOVE,this.handleMouseMove),document.removeEventListener(fw.UP,this.handleMouseUp),mw&&e.target.releasePointerCapture&&e.target.releasePointerCapture(e.pointerId)})),__publicField(this,"handleMouseMove",(e=>{e.preventDefault();const t=this.engine,i=t.rendering.canvas.getBoundingClientRect(),n=e.clientX+this._sub.x-i.left,s=e.clientY+this._sub.y-i.top;Uk.copy(t.rendering.picking.pickSeaLevelWorldPosition({x:n,y:s}));const o=[Uk.x,Uk.y,Uk.z],r=t.map.unprojectArrayCoordinate(o);this.point=[r[0],r[1],this.point[2]||0],t.requestRender()})),__publicField(this,"handleWheel",(e=>{e.preventDefault(),e.stopPropagation();const t=new WheelEvent("wheel",{bubbles:!1,cancelable:!0,clientX:e.clientX,clientY:e.clientY,screenX:e.screenX,screenY:e.screenY,deltaX:e.deltaX,deltaY:e.deltaY,deltaZ:e.deltaZ,deltaMode:e.deltaMode});this.engine.map.projectionName===Zb?this.engine.rendering.renderer.domElement.dispatchEvent(t):this.engine.container.dispatchEvent(t)})),this.isDOMOverlay=!0,this.parameters=e}afterAddToEngine(e){this.engine=e;const n=e.container,s=n instanceof HTMLElement||n&&"object"==typeof n&&1===n.nodeType&&"string"==typeof n.nodeName;this._container=s?n:n.container||n._container;let o=!1;const r=e.map._mapType,a=t+"-overlay",l=this._container.children;if(l&&(o=Array.from(l).some((e=>e.id===a))),o)this._div=Array.from(l).find((e=>e.id===a));else if(this._div=document.createElement("div"),this._div.id=`${t}-overlay`,i(this._div,`${t}-overlay-pane`),"bmapgl"===r){const e=null==n?void 0:n.container;e&&e instanceof HTMLElement&&n.container.appendChild(this._div)}else n instanceof HTMLElement?n.appendChild(this._div):"mapbox"===r&&n._container.appendChild(this._div);this.dom=this.initDom(),this.point=this.parameters.point||[],this.offset=this.parameters.offset||[0,0],this.className=this.parameters.className||"",this.enableDragging=this._enableDragging||!1,this.visible=this.parameters.visible||!0,this.afterInit()}beforeRemoveFromEngine(e){this.dispose()}initDom(){if(this.parameters.dom)return this.parameters.dom;console.warn("`DOMOverlay` must contain a property `dom`.")}afterInit(){}onBeforeScenePrepareRender(e,s,o){if(this.dom&&this.visible){this.camera=o,this.renderer=e.renderer;let s=new bt;e.renderer.getSize(s),Qk.multiplyMatrices(o.matrixWorldInverse,this.matrixWorld),Qk.multiplyMatrices(o.projectionMatrix,Qk);const r=new Dt(0,0,0,1);r.applyMatrix4(Qk),r.divideScalar(r.w),r.z>1||r.z<-1?i(this.dom,`${t}-hidden`):n(this.dom,`${t}-hidden`);const a=(1+r.x)*s.x/2,l=(1-r.y)*s.y/2,g=this.dom.clientWidth,c=this.dom.clientHeight;let d,h,u=a-g/2+this.offset[0],I=a+g/2+this.offset[0];if(this.isPopup?(d=l-c+this.offset[1],h=l+this.offset[1]):(d=l-c/2+this.offset[1],h=l+c/2+this.offset[1]),I<0||u>s.x||h<0||d>s.y)return void("hidden"!==this.dom.style.visibility&&(this.dom.style.visibility="hidden"));this.dom.style.position="absolute","hidden"===this.dom.style.visibility&&(this.dom.style.visibility="visible"),this.dom.style.left=u+"px",this.dom.style.top=d+"px";const p=new Qt(this.matrixWorld.elements[12],this.matrixWorld.elements[13],this.matrixWorld.elements[14]).clone().project(o),m=(1+p.x)*s.x/2,A=(1-p.y)*s.y/2;this._screenPos=(new bt).set(m,A),this.dom.ondragstart=()=>!1,this.enableDragging?this.dom.style.touchAction="auto":this.dom.style.touchAction="none"}}onDispose(){}dispose(){this.onDispose(),this.enableDragging&&(this.dom.removeEventListener(fw.DOWN,this.handleMouseDown),this.dom.removeEventListener(fw.UP,this.handleMouseUp),document.removeEventListener(fw.MOVE,this.handleMouseMove),document.removeEventListener(fw.UP,this.handleMouseUp)),this.dom.removeEventListener("wheel",this.handleWheel),this.dom.remove(),0===this._div.childElementCount&&this._div.remove()}get dom(){return this._dom}set dom(e){if(this._dom&&(this.enableDragging&&(this._dom.removeEventListener(fw.DOWN,this.handleMouseDown),this._dom.removeEventListener(fw.UP,this.handleMouseUp)),this._div.removeChild(this._dom)),"string"==typeof e){const n=document.createElement("div");i(n,`${t}-dom-overlay-custom`);const s=(new DOMParser).parseFromString(e,"text/html").body.children;for(let e=0;e<s.length;e++)n.appendChild(s.item(e));this._dom=n}else this._dom=e;this._div.appendChild(this._dom),this._dom.style.visibility=this.visible?"visble":"hidden",this._dom.setAttribute("draggable","false"),this._dom.ondragstart=()=>!1,this.enableDragging&&(this._dom.addEventListener(fw.DOWN,this.handleMouseDown),this._dom.addEventListener(fw.UP,this.handleMouseUp),this._dom.style.cursor="pointer"),this._dom.addEventListener("wheel",this.handleWheel)}get point(){return this._point}set point(e){Array.isArray(e)&&e.length>1&&(this._point=e,this.engine&&this.position.set(...this.engine.map.projectArrayCoordinate(e)))}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.dom&&(this.dom.style.visibility=e?"visible":"hidden"))}get offset(){return this._offset}set offset(e){this._offset=e}get stopPropagation(){return this._stopPropagation}set stopPropagation(e){this._stopPropagation=e}get enableDragging(){return this._enableDragging}set enableDragging(e){this._enableDragging!==e&&(this._enableDragging=e,this.dom&&(e?(this.dom.addEventListener(fw.DOWN,this.handleMouseDown),this.dom.addEventListener(fw.UP,this.handleMouseUp),this.dom.style.cursor="pointer"):(this.dom.removeEventListener(fw.DOWN,this.handleMouseDown),this.dom.removeEventListener(fw.UP,this.handleMouseUp),this.dom.style.cursor="auto")))}get className(){return this._className}set className(e){e!==this._className&&(this.dom&&(this._className&&n(this.dom,this._className),i(this.dom,e)),this._className=e)}}class jk extends gx{constructor(){super(...arguments),__publicField(this,"isPoints",!0),__publicField(this,"isEventEntitySupported",!0)}get size(){return this.material.size}set size(e){this.material.size=e}raycast(e,t){if(!this.visible)return;const i=e.params.Points.threshold;let n=i*this.size;this.material.uniforms.zoomUnits&&(n*=this.material.uniforms.zoomUnits.value),e.params.Points.threshold=n,Ja.prototype.raycast.call(this,e,t),e.params.Points.threshold=i}getEntityByIndex(e){const t=this.dataSource;this._enableCollision&&this._collisionData&&(e=this._collisionData[e].index);const i={value:t.getDataItem(e),itemIndex:t.getDataItemIndex(e),pairs:{}},n=t.data;for(const s of Object.keys(n))i.pairs[s]=n[s][e],i[s]=n[s][e];return i}}class qk extends Fn{constructor(e){super(e),this.parameters=e}setData(e){const{vertexSizes:t,vertexColors:i}=this.parameters,{aPositions:n,aObjectIndices:s,aMapIndexs:o,aColors:r,aSizes:a}=e;this.setAttribute("position",new Mn(n,3)),this.setAttribute("objectIndex",new Mn(s,1)),this.setAttribute("aMapIndex",new Mn(o,1)),i&&this.setAttribute("aColor",new Mn(r,4)),t&&this.setAttribute("aSize",new Mn(a,1))}}const $k=new Dl,eO=as.merge([ws.fog,Ay,my,{isEmissive:{value:!1},color:{value:[1,1,0]},size:{value:30},vertexColors:{value:!1},vertexSizes:{value:!1},uShapeType:{value:2},opacity:{value:1},map:{value:null},useMap:{value:!1},uOffset:{value:[0,0]}}]);class tO extends mx{constructor(e){super(),this.name="SimplePointMaterial",this.vertexShader="#define GLSLIFY 1\n#include <common>\n\n#ifdef MVT_USE_VERTEX_SIZE\n    attribute float aSize;\n    varying float vSize;\n#endif\n\n#ifdef MVT_USE_VERTEX_OFFSET\n    attribute vec2 aOffset;\n#else\n    uniform vec2 uOffset;\n#endif\n\n#ifdef MVT_USE_VERTEX_COLOR\n    attribute vec4 aColor;\n    varying vec4 vColor;\n#endif\n\nuniform float size;\nuniform float pixelRatio;\nuniform vec2 resolution;\n\n#include <mvt_selective_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <mvt_extra_vertex_utils>\n\nvoid main() { \n    #include <mvt_selective_vertex>\n\n    vec4 worldPosition = modelMatrix * vec4(position, 1.0);\n    float pixelSize = getPixelSize(worldPosition.xyz);\n\n    #ifdef MVT_USE_VERTEX_OFFSET\n        vec2 offset = aOffset * 2. * pixelRatio * pixelSize;\n    #else\n        vec2 offset = uOffset * 2. * pixelRatio * pixelSize;\n    #endif\n\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    gl_Position.xy = gl_Position.xy - offset;\n\n    #ifdef MVT_USE_VERTEX_SIZE\n        vSize = aSize * pixelRatio;\n        gl_PointSize = vSize;\n    #else\n        gl_PointSize = size * pixelRatio;\n    #endif\n\n    #ifdef MVT_USE_VERTEX_COLOR\n        vColor = aColor;\n    #endif\n\n    #include <logdepthbuf_vertex>\n}",this.fragmentShader="#define GLSLIFY 1\n#include <common>\n\n#ifdef MVT_USE_VERTEX_COLOR\n    varying vec4 vColor;\n#else\n    uniform vec3 color;\n#endif\nuniform float uShapeType;\nuniform float opacity;\n\n#ifdef MVT_USE_VERTEX_SIZE\n    varying float vSize;\n#else\n    uniform float size;\n#endif\nuniform bool useMap;\nuniform sampler2D map;\n\n#include <mvt_selective_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n\nvoid main() {\n\n    #ifdef MVT_USE_VERTEX_COLOR\n        gl_FragColor = vColor;\n    #else\n        gl_FragColor = vec4(color, 1.0);\n    #endif\n\n    if (uShapeType == 2.) {\n        float d = distance(gl_PointCoord, vec2(0.5, 0.5));\n        #ifdef MVT_USE_VERTEX_SIZE\n            float alpha = smoothstep(0.5 + 0.5 / vSize, 0.5 - 1.0 / vSize, d);\n        #else\n            float alpha = smoothstep(0.5 + 0.5 / size, 0.5 - 1.0 / size, d);\n        #endif\n        \n        if (alpha <= 0.) {\n            discard;\n        } else {\n            gl_FragColor.a *= alpha;\n        }\n    }\n \n    if (useMap) {\n        vec4 tColor = texture2D(map, vec2(gl_PointCoord.x, 1.0 - gl_PointCoord.y));\n     //    gl_FragColor.rgb = tColor.rgb * tColor.a + gl_FragColor.rgb * (1.0 - tColor.a);\n     //    gl_FragColor.a += tColor.a;\n        \n        gl_FragColor = mix(gl_FragColor, tColor, tColor.a);\n        // gl_FragColor.rgb = mix(gl_FragColor.rgb, tColor.rgb, tColor.a);\n        // gl_FragColor.a += tColor.a;\n        // gl_FragColor = tColor;\n    }\n\n    if (gl_FragColor.a <= 0.) {\n        discard;\n    }\n\n    gl_FragColor.a *= opacity;\n    #ifdef OPAQUE\n        gl_FragColor.a = 1.0;\n    #endif\n\n    #include <mvt_selective_fragment> \n    #include <logdepthbuf_fragment> \n    #include <tonemapping_fragment>\n    #include <colorspace_fragment>\n    \n}",this.isSimplePointMaterial=!0,Object.assign(this.uniforms,as.clone(eO)),vy(this),fy(this,["size","uShapeType","opacity","isEmissive"]),yy(this,[["offset","uOffset"]]),by(this,["color"]),_y(this,[["vertexColors","MVT_USE_VERTEX_COLOR"],["vertexSizes","MVT_USE_VERTEX_SIZE"]]),By(this),Object.defineProperties(this,{mapSrc:{get:function(){return this.uniforms.map.value},set:function(e){const t=this.mapSrc,i="url_map";if(this.userData[i]===e)return;if(t&&t.dispose(),!e)return this.uniforms.map.value=null,this.uniforms.useMap.value=!1,void delete this.userData[i];const n=$k.load(e);n.wrapS=n.wrapT=M,this.uniforms.map.value=n,this.userData[i]=e,this.uniforms.useMap.value=!0}}}),this.emissiveEnabled=!0,this.emissive=[0,0,0],this.setValues(e)}dispose(){this.uniforms.map.value&&this.uniforms.map.value.dispose(),super.dispose()}}const iO=new Dl,nO=as.merge([ws.fog,Ay,Cy,{emissive:{value:[0,0,0]},isEmissive:{value:!1},width:{value:12},height:{value:12},offset:{value:[0,0]},ulength:{value:1},useCanvasMap:{value:!1},vertexIcons:{value:!1},opacity:{value:1},map:{value:null},useMap:{value:!1},uScale:{value:1},uFlat:{value:!1},keepSize:{value:!0},color:{value:[1,1,1]},vertexColors:{value:!1},jumpHeight:{value:0},jumpSpeed:{value:0},uRotateZ:{value:0}}]);class sO extends mx{constructor(e){super(),this.name="IconMaterial",this.vertexShader="#define GLSLIFY 1\n#include <common>\n\nattribute float pIndex;\nattribute float aMapIndex;\n\nuniform float pixelRatio;\nuniform float width;\nuniform float height;\nuniform float uScale;\nuniform float ulength;\nuniform vec2 resolution;\nuniform vec2 offset;\nuniform bool uFlat;\nuniform bool keepSize;\nuniform float elapsedTime;\n\nvarying vec2 vUv;\nvarying vec4 vColor;\n\n#ifdef MVT_USE_VERTEX_ROTATEZ\n    attribute float aRotateZ;\n# else\n    uniform float uRotateZ;\n#endif\n\n#ifdef MVT_USE_VERTEX_COLOR\n    attribute vec4 aColor;\n#else\n    uniform vec3 color;\n#endif\n\n#ifdef USE_ANIMATION\nuniform float jumpHeight;\nuniform float jumpSpeed;\n#endif\n\n#include <mvt_selective_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <mvt_extra_vertex_utils>\n\nvec3 transformCoord(vec3 coord, vec2 size, float corner, float rotateZ) {\n    float x = coord.x;\n    float y = coord.y;\n    if (corner == 1.0) {\n        x += -size.x * cos(rotateZ) + size.y * sin(rotateZ);\n        y += size.y * cos(rotateZ) + size.x * sin(rotateZ);\n    } else if (corner == 2.0) {\n        x += size.x * cos(rotateZ) + size.y * sin(rotateZ);\n        y += size.y * cos(rotateZ) - size.x * sin(rotateZ);\n    } else if (corner == 3.0) {\n        x += size.x * cos(rotateZ) - size.y * sin(rotateZ);\n        y += -size.y * cos(rotateZ) - size.x * sin(rotateZ);\n    } else {\n        x += -size.x * cos(rotateZ) - size.y * sin(rotateZ);\n        y += -size.y * cos(rotateZ) + size.x * sin(rotateZ);\n    }\n    return vec3(x, y, coord.z);\n}\n\nvoid main() { \n    #include <mvt_selective_vertex>\n\n    #ifdef MVT_USE_VERTEX_COLOR\n        vColor = aColor;\n    #else\n        vColor = vec4(color, 1.0);\n    #endif\n\n    float rotateZ;\n    #ifdef MVT_USE_VERTEX_ROTATEZ\n        rotateZ = aRotateZ;\n    # else\n        rotateZ = uRotateZ;\n    #endif\n\n    vec4 worldPosition = modelMatrix * vec4(position, 1.0);\n    float pixelSize = getPixelSize(worldPosition.xyz);\n    if (uFlat) {\n        float hw = width * 0.5;\n        float hh = height * 0.5;\n        if (keepSize) {\n            hw *= pixelSize;\n            hh *= pixelSize;\n        }\n\n        vec3 current = transformCoord(position, vec2(hw, hh), pIndex, -rotateZ);\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(current, 1.0);\n    }\n    else {\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        float w = gl_Position.w;\n        gl_Position /= w;\n\n        float hw = width / resolution.x * uScale;\n        float hh = height / resolution.y * uScale;\n        vec2 o = offset;\n        if (!keepSize) {\n            hw /= pixelSize;\n            hh /= pixelSize;\n            o /= pixelSize;\n        }\n\n        gl_Position.x += o.x * 2. / resolution.x;\n        gl_Position.y -= o.y * 2. / resolution.y;\n\n        if (pIndex == 1.0) {\n            gl_Position.x -= hw;\n            gl_Position.y += hh;\n        } else if (pIndex == 2.0) {\n            gl_Position.x += hw;\n            gl_Position.y += hh;\n        } else if (pIndex == 3.0) {\n            gl_Position.x += hw;\n            gl_Position.y -= hh;\n        } else {\n            gl_Position.x -= hw;\n            gl_Position.y -= hh;\n        }\n\n        #ifdef USE_ANIMATION\n            float bounce = abs(sin(elapsedTime / 1000.0 * jumpSpeed)) * jumpHeight;\n            gl_Position.y += (bounce * 2. / resolution.y);\n        #endif\n\n        gl_Position *= w;\n    }\n\n    vUv = uv;\n\n    #include <logdepthbuf_vertex>\n}",this.fragmentShader="#define GLSLIFY 1\n#include <common>\n\nuniform float opacity;\n\nuniform bool useMap;\nuniform bool useCanvasMap;\nuniform sampler2D map;\nuniform float width;\nuniform float height;\n\nvarying vec2 vUv;\nvarying vec4 vColor;\n\n#include <mvt_selective_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <mvt_emissive_pars_fragment>\n\nvoid main() {\n\n    gl_FragColor = texture2D(map, vec2(vUv.x, 1. - vUv.y));\n    // gl_FragColor = mix(gl_FragColor, vec4(1., 0., 0., 1.), 0.5);\n\n    if (gl_FragColor.a <= 0.) {\n        discard;\n    }\n    gl_FragColor *= vColor;\n\n    gl_FragColor.a *= opacity;\n    #ifdef OPAQUE\n        gl_FragColor.a = 1.0;\n    #endif\n\n    #include <mvt_selective_fragment> \n    #include <logdepthbuf_fragment> \n    #include <mvt_emissive_fragment>\n    #include <tonemapping_fragment>\n    #include <colorspace_fragment>\n}",this.isIconMaterial=!0,Object.assign(this.uniforms,as.clone(nO)),xy(this),vy(this),fy(this,["width","height","offset","opacity","emissive","isEmissive","jumpHeight","jumpSpeed"]),yy(this,[["scale","uScale"],["flat","uFlat"],["rotateZ","uRotateZ"]]),by(this,["color"]),_y(this,[["vertexRotateZs","MVT_USE_VERTEX_ROTATEZ"],["vertexColors","MVT_USE_VERTEX_COLOR"],["animationJump","USE_ANIMATION"],["isGlobe","IS_GLOBE"]]),Object.defineProperties(this,{mapSrc:{get:function(){return this.uniforms.map.value},set:function(e){const t=this.mapSrc,i=this.userData[this.urlCacheKey],n=this;if(i!==e){if(t&&t.dispose(),!e)return this.uniforms.map.value=null,this.uniforms.useMap.value=!1,void delete this.userData[this.urlCacheKey];iO.load(e,(function(t){t.wrapS=t.wrapT=M,t.colorSpace=Ye,n.uniforms.map.value=t,n.userData[n.urlCacheKey]=e,n.uniforms.useMap.value=!0,n.uniforms.useCanvasMap.value=!1}))}}},mapTexture:{get:function(){return this.uniforms.map.value},set:function(e){if(!e)return this.uniforms.map.value=null,void(this.uniforms.useCanvasMap.value=!1);e.wrapS=e.wrapT=M,e.colorSpace=Ye,this.uniforms.map.value=e,this.uniforms.useMap.value=!1,this.uniforms.useCanvasMap.value=!0,delete this.userData[this.urlCacheKey]}}}),this.setValues(e)}dispose(){this.uniforms.map.value&&this.uniforms.map.value.dispose(),super.dispose()}}class oO extends Fn{constructor(e){super(e),this.parameters=e}setData(e){const{aPositions:t,aObjectIndices:i,aUvs:n,aColors:s,pIndices:o,rotateZs:r,indices:a}=e;this.setAttribute("position",new Mn(t,3)),this.setAttribute("pIndex",new Mn(o,1)),this.setAttribute("objectIndex",new Mn(i,1)),this.setAttribute("uv",new Mn(n,2)),this.parameters.vertexColors&&this.setAttribute("aColor",new Mn(s,4)),this.parameters.vertexRotateZs&&this.setAttribute("aRotateZ",new Mn(r,1)),this.setIndex(a),this.cachedObjectIndices=i}}const rO=new Qt,aO=new Dt,lO=new Bi,gO=new Qt,cO=new Qt;class dO extends cx{constructor(e){super(e),__publicField(this,"isEventEntitySupported",!0),__publicField(this,"_padding"),__publicField(this,"oldMapTextureRes",new Map),__publicField(this,"texture"),__publicField(this,"geometry"),__publicField(this,"material"),__publicField(this,"canvas"),__publicField(this,"ctx"),__publicField(this,"iconUrlHash",new Map),__publicField(this,"boxHash",new Map),__publicField(this,"gap",[2,2]),__publicField(this,"getTextureAndHash",((e,t,i,n,s)=>{const o=this.iconUrlHash;if(!s&&this.oldMapTextureRes)return this.oldMapTextureRes;if(!e[0]||!e[0][t])return{texture:this.texture,iconUrlHash:o};let r=o.size,a=o.size,l=new Map;for(let c=0;c<e.length;c++){const i=e[c][t];void 0===o.get(i)&&(o.set(i,r),l.set(i,r),r++)}if(a===o.size)return this.oldMapTextureRes;let g=Array.from(o.entries()).map((([e,t])=>new Promise(((t,i)=>{Kx(e,(i=>{o.set(e,i),t(e)}))}))));return g})),this.parameters=e,this._padding=void 0!==this.parameters.padding?this.parameters.padding:[2,2];const t=this.canvas=document.createElement("canvas");t.width=t.height=1,this.ctx=t.getContext("2d"),this.texture=new il(t),this.defineMaterialProxyProperties(["width","height","offset","map","mapSrc","transparent","opacity","flat","keepSize","color","vertexColors","animationJump","jumpHeight","jumpSpeed"]),this.boxes=[],this.boxSize=e.boxSize||100}initObject(){let{vertexIcons:e,...t}=this.parameters;this.geometry=new oO(this.parameters),this.material=new sO(t),this.material.setCommonUniforms(this.engine.rendering.uniforms)}getDefaultParams(){return{width:12,height:12}}collisionTest(e){return{width:this.width,height:this.height}}createTexture(){if(!this.canvas)return this.oldMapTextureRes;const e=this.ctx,t=this.iconUrlHash;for(let[i,n]of t){const e=i,n=t.get(e);if("string"==typeof n)continue;const s=this.boxes.findIndex((e=>e.key===i));if(s>=0){const e=this.boxes.splice(s,1);this.boxes.unshift(e[0]);continue}const o=n.width,r=n.height,a=o+this.gap[0],l=r+this.gap[1];this.boxes.unshift({w:a,h:l,width:o,height:r,key:i,icon:n})}for(let i=0;i<this.boxes.length;i++){const e=this.boxes[i];this.boxHash.set(e.key,e)}return Dx(this.boxes,e,this.canvas,{fillStyle:this._fillStyle,fontSize:this.parameters.fontSize,gap:this.gap,padding:this.padding,dpr:this.engine.rendering.pixelRatio})?(this.texture.dispose(),this.texture=new il(this.canvas)):this.texture.needsUpdate=!0,this.oldMapTextureRes={texture:this.texture,iconUrlHash:t},{texture:this.texture,iconUrlHash:t}}async _updateData(){const{vertexIcons:e,inconPropName:t="icon",width:i,height:n}=this.parameters;let s=[];s=this._enableCollision&&this._collisionData?this._collisionData:this.dataSource.userData;const o=[],r=[],a=[],l=[],g=[],c=[],d=[];let h="",u={};if(e){let e,I=this.getTextureAndHash(s,t,i,n,!0);Array.isArray(I)?(await Promise.all(I),e=this.createTexture()):e=I,h=e.texture,u=e.iconUrlHash||{},this.material.mapTexture=h,this.material.uniforms.ulength.value=u.size;for(let i=0;i<s.length;i++){const e=s[i].position,n=s[i].index,h=s[i][t],u=s[i].rotateZ||0,I=this.boxHash.get(h);if(!I)continue;const p=s[i].color;let m;this.parameters.vertexColors&&(m=p?cy(p):[1,1,1,1]),this.parameters.vertexRotateZs&&d.push(u,u,u,u);for(let t=0;t<4;t++)o.push(...e),r.push(t),a.push(n),m&&c.push(...m);const A=I.x/this.canvas.width,C=(I.x+I.w)/this.canvas.width,f=(I.y+I.h)/this.canvas.height,b=I.y/this.canvas.height;l.push(A,f,A,b,C,b,C,f);const y=4*i;g.push(y,y+2,y+1,y,y+3,y+2)}}else for(let p=0;p<s.length;p++){const e=s[p].position,t=s[p].index,i=s[p].color,n=s[p].rotateZ||0;let h;this.parameters.vertexColors&&(h=i?cy(i):[1,1,1,1]),this.parameters.vertexRotateZs&&d.push(n,n,n,n);for(let s=0;s<4;s++)o.push(...e),r.push(s),a.push(t),h&&c.push(...h);l.push(0,1,0,0,1,0,1,1);const u=4*p;g.push(u,u+2,u+1,u,u+3,u+2)}this.geometry.setData({aColors:c,aPositions:o,pIndices:r,aObjectIndices:a,aUvs:l,rotateZs:d,indices:g}),this.geometry.computeBoundingSphere();const I=this.geometry.boundingSphere.center;this.originCenter=(new Qt).copy(I),this.makeGeometryOffsetPosition(this.geometry,o),this.needsUpdate=!1,this.engine.requestRender()}getEntityByIndex(e){const t=this.dataSource;this._enableCollision&&this._collisionData&&(e=this._collisionData[e].index);const i={index:e,value:t.getDataItem(e),itemIndex:t.getDataItemIndex(e),pairs:{}},n=t.data;for(const s of Object.keys(n))i.pairs[s]=n[s][e];return i}raycast(e,t){const i=this.flat;if(!this.visible)return;if(i){null===this.geometry.boundingSphere&&this.geometry.computeBoundingSphere();const{width:i,height:n}=this.parameters;let s=Math.max(i,n)/2;return this.keepSize&&(s*=this.material.uniforms.zoomUnits.value),this.geometry.boundingSphere.radius+=s,ts.prototype.raycast.call(this,e,t),void(this.geometry.boundingSphere.radius-=s)}const n=this.geometry,s=n.getAttribute("position");if(!s||!s.array||0===!s.array.length)return;const o=n.getAttribute("offset");let r=[];o&&(r=o.array);let a=e.camera;a||(a=this.engine.camera);const l=e.mouse;if(!l)return;const g=this.material.uniforms.resolution.value,c=l.x,d=l.y;let h=this.width/g.x,u=this.height/g.y;const I=h,p=u;let m=0,A=0,C=0,f=0,b=0,y=0;lO.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse),lO.multiplyMatrices(lO,this.matrixWorld);const _=s.array;let v=0;for(let x=0,B=_.length-11;x<B;x+=12){if(aO.set(_[x],_[x+1],_[x+2],1),aO.applyMatrix4(lO),aO.divideScalar(aO.w),this.parameters.vertexOffsets?(v=x/12*8,b=r[v]||0,y=r[v+1]||0):(b=this.material.uniforms.offset.value?this.material.uniforms.offset.value[0]:0,y=this.material.uniforms.offset.value?this.material.uniforms.offset.value[1]:0),aO.x+=2*b/g.x,aO.y-=2*y/g.y,!this.keepSize){const{x:e,y:t,z:i}=this.originCenter,n=this.getPixelSize(new Qt(_[x]+e,_[x+1]+t,_[x+2]+i));h=I/n,u=p/n,b/=n,y/=n}if(m=aO.x-h,C=aO.x+h,A=aO.y-u,f=aO.y+u,m<=c&&C>=c&&A<=d&&f>=d){rO.set(_[x],_[x+1],_[x+2]),rO.applyMatrix4(this.matrixWorld);const e={instanceId:x/12,object:this,distance:rO.distanceTo(a.position)};t.push(e)}}}onDispose(){this.texture&&this.texture.dispose()}set padding(e){this._padding=e}get padding(){return this._padding}getVertexPosition(e,t){const i=this.geometry,n=i.attributes.position,s=i.morphAttributes.position,o=i.morphTargetsRelative;t.fromBufferAttribute(n,e);const r=e%4;let a=this.parameters.width/2,l=this.parameters.height/2;if(this.keepSize){const e=this.originCenter,i=this.getPixelSize((new Qt).addVectors(e,t));a*=i,l*=i}1===r?a=-a:2===r||(3===r?l=-l:(l=-l,a=-a)),t.x+=a,t.y+=l;const g=this.morphTargetInfluences;if(s&&g){cO.set(0,0,0);for(let i=0,n=s.length;i<n;i++){const n=g[i],r=s[i];0!==n&&(gO.fromBufferAttribute(r,e),o?cO.addScaledVector(gO,n):cO.addScaledVector(gO.sub(t),n))}t.add(cO)}return t}getPixelSize(e){const{camera:t,rendering:i}=this.engine;return t.isOrthographicCamera?this.material.uniforms.zoomUnits.value:.2*t.projectionMatrix.elements[5]/i.resolution.y*t.position.distanceTo(e)}getEntityIndexByFace(e,t){return this.geometry.cachedObjectIndices[t]}}dO.prototype._computeIntersections=ts.prototype._computeIntersections;const hO=new Dt,uO=new Bi,IO=new bt;const pO=new Dl,mO=as.merge([ws.fog,Ay,Cy,{emissive:{value:[0,0,0]},isEmissive:{value:!1},width:{value:12},height:{value:12},offset:{value:[0,0]},positionOffset:{value:[0,0,0]},ulength:{value:1},useCanvasMap:{value:!1},vertexIcons:{value:!1},opacity:{value:1},map:{value:null},useMap:{value:!1},uFlat:{value:!1},keepSize:{value:!0},scaleRatio:{value:1}}]);class AO extends mx{constructor(e){super(),this.name="LabelMaterial",this.vertexShader="#define GLSLIFY 1\n#include <common>\n\nattribute float pIndex;\nattribute float aMapIndex;\n\nuniform float pixelRatio;\nuniform float width;\nuniform float height;\nuniform float ulength;\nuniform vec2 resolution;\nuniform vec2 offset;\nuniform vec3 positionOffset;\nuniform bool uFlat;\nuniform bool keepSize;\nuniform float scaleRatio;\n\n#ifdef MVT_USE_VERTEX_SIZE\n    attribute vec2 aSize;\n#endif\n\n#ifdef MVT_USE_VERTEX_POSITION_OFFSET\n    attribute vec3 aPositionOffsets;\n#endif\n\nvarying vec2 vUv;\n\n#include <mvt_selective_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <mvt_extra_vertex_utils>\n\nvoid main() {\n    #include <mvt_selective_vertex>\n    float setWidth = width;\n    float setHeight = height;\n\n    #ifdef MVT_USE_VERTEX_SIZE\n        setWidth = aSize.x * scaleRatio;\n        setHeight = aSize.y * scaleRatio;\n    #endif\n\n    vec2 o = offset * scaleRatio;\n    vec4 worldPosition = modelMatrix * vec4(position, 1.0);\n    float pixelSize = getPixelSize(worldPosition.xyz);\n    if (uFlat) {\n        float hw = setWidth * 0.5;\n        float hh = setHeight * 0.5;\n        if (keepSize) {\n            hw *= pixelSize;\n            hh *= pixelSize;\n            o *= pixelSize;\n        }\n        if (pIndex == 1.0) {\n            hw = -hw;\n        } else if (pIndex == 2.0) {\n\n        } else if (pIndex == 3.0) {\n            hh = -hh;\n        } else {\n            hw = -hw;\n            hh = -hh;\n        }\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position.x + hw, position.y + hh, position.z, 1.0);\n    }\n    else {\n        vec3 setPositionOffset = positionOffset;\n        #ifdef MVT_USE_VERTEX_POSITION_OFFSET\n            setPositionOffset = aPositionOffsets;\n        #endif\n        worldPosition.x += setPositionOffset.x;\n        worldPosition.y += setPositionOffset.y;\n        worldPosition.z += setPositionOffset.z;\n\n        gl_Position = projectionMatrix * viewMatrix * worldPosition;\n        float w = gl_Position.w;\n        gl_Position /= w;\n\n        float hw = setWidth / resolution.x;\n        float hh = setHeight / resolution.y;\n        if (!keepSize) {\n            hw /= pixelSize;\n            hh /= pixelSize;\n            o /= pixelSize;\n        }\n\n        gl_Position.x += o.x * 2. / resolution.x;\n        gl_Position.y -= o.y * 2. / resolution.y;\n\n        if (pIndex == 1.0) {\n            gl_Position.x -= hw;\n            gl_Position.y += hh;\n        } else if (pIndex == 2.0) {\n            gl_Position.x += hw;\n            gl_Position.y += hh;\n        } else if (pIndex == 3.0) {\n            gl_Position.x += hw;\n            gl_Position.y -= hh;\n        } else {\n            gl_Position.x -= hw;\n            gl_Position.y -= hh;\n        }\n\n        gl_Position *= w;\n    }\n\n    vUv = uv;\n\n    #include <logdepthbuf_vertex>\n}",this.fragmentShader="#define GLSLIFY 1\n#include <common>\n\nuniform float opacity;\n\nuniform bool useMap;\nuniform bool useCanvasMap;\nuniform sampler2D map;\nuniform float width;\nuniform float height;\n\nvarying vec2 vUv;\n\n#include <mvt_selective_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <mvt_emissive_pars_fragment>\n\nvoid main() {\n\n    gl_FragColor = texture2D(map, vec2(vUv.x, 1. - vUv.y));\n    // gl_FragColor = mix(gl_FragColor, vec4(1., 0., 0., 1.), 0.5);\n\n    if (gl_FragColor.a <= 0.) {\n        discard;\n    }\n    gl_FragColor.a *= opacity;\n    #ifdef OPAQUE\n        gl_FragColor.a = 1.0;\n    #endif\n\n    #include <mvt_selective_fragment> \n    #include <logdepthbuf_fragment> \n    #include <mvt_emissive_fragment>\n    #include <colorspace_fragment>\n}",this.isLabelMaterial=!0,Object.assign(this.uniforms,as.clone(mO)),xy(this),vy(this),yy(this,[["flat","uFlat"]]),_y(this,[["vertexBackgroundCanvas","MVT_USE_VERTEX_SIZE"],["vertexBackgrounds","MVT_USE_VERTEX_SIZE"],["vertexPositionOffsets","MVT_USE_VERTEX_POSITION_OFFSET"]]),fy(this,["width","height","offset","positionOffset","opacity","emissive","isEmissive","scaleRatio"]),Object.defineProperties(this,{mapSrc:{get:function(){return this.uniforms.map.value},set:function(e){const t=this.mapSrc,i=this.userData[this.urlCacheKey],n=this;if(i!==e){if(t&&t.dispose(),!e)return this.uniforms.map.value=null,this.uniforms.useMap.value=!1,void delete this.userData[this.urlCacheKey];pO.load(e,(function(t){t.wrapS=t.wrapT=M,t.colorSpace=Ye,n.uniforms.map.value=t,n.userData[n.urlCacheKey]=e,n.uniforms.useMap.value=!0,n.uniforms.useCanvasMap.value=!1}))}}},mapTexture:{get:function(){return this.uniforms.map.value},set:function(e){if(!e)return this.uniforms.map.value=null,void(this.uniforms.useCanvasMap.value=!1);e.wrapS=e.wrapT=M,e.colorSpace=Ye,this.uniforms.map.value=e,this.uniforms.useMap.value=!1,this.uniforms.useCanvasMap.value=!0,delete this.userData[this.urlCacheKey]}}}),this.setValues(e)}dispose(){this.uniforms.map.value&&this.uniforms.map.value.dispose(),super.dispose()}}class CO extends Fn{constructor(e){super(e),this.parameters=e}setData(e){const{vertexBackgrounds:t,vertexBackgroundCanvas:i,vertexPositionOffsets:n}=this.parameters,{aPositions:s,aObjectIndices:o,aUvs:r,pIndices:a,indices:l,aSize:g,aPositionOffsets:c}=e;this.setAttribute("position",new Mn(s,3)),this.setAttribute("pIndex",new Mn(a,1)),this.setAttribute("objectIndex",new Mn(o,1)),this.setAttribute("uv",new Mn(r,2)),(t||i)&&this.setAttribute("aSize",new Mn(g,2)),n&&this.setAttribute("aPositionOffsets",new Mn(c,3)),this.setIndex(l)}}const fO=new Qt,bO=new Dt,yO=new Bi;class _O extends cx{constructor(e){super(e),__publicField(this,"isEventEntitySupported",!0),__publicField(this,"isLabel",!0),__publicField(this,"geometry"),__publicField(this,"material"),__publicField(this,"canvas"),__publicField(this,"ctx"),__publicField(this,"texture"),__publicField(this,"iconUrlHash",new Map),__publicField(this,"canvasHash",new Map),__publicField(this,"boxHash",new Map),__publicField(this,"gap",[2,2]),__publicField(this,"_padding"),__publicField(this,"_fillStyle"),__publicField(this,"oldMapTextureRes",{}),__publicField(this,"_instanceIds",[]),__publicField(this,"labelHash"),this.parameters=e,this._padding=[0,0,0,0],this.parameters.padding&&(this.padding=this.parameters.padding),this._fillStyle=this.parameters.fillStyle||"#fff";const t=e.maxCacheSize||2e3;this.labelHash=new Zx({max:t,onRemove:(e,t)=>{this.boxHash.delete(t)}});const i=this.canvas=document.createElement("canvas");i.width=i.height=1;(this.ctx=i.getContext("2d")).textAlign="start",this.texture=new il(i),this.defineMaterialProxyProperties(["width","height","offset","transparent","opacity","flat","keepSize","positionOffset"]),this.boxes=[],this.boxSize=e.boxSize||100,e.labelTest&&(document.body.append(i),i.style.cssText="position: absolute; z-index: 111; top: 10px; left: 10px; background: #fff")}initObject(){const{background:e,fontSize:t,padding:i,fillStyle:n,vertexVisible:s,visiblePropName:o,backgroundCanvasPropName:r,maxCacheSize:a,...l}=this.parameters;this.geometry=new CO(this.parameters),this.material=new AO(l),this.material.setCommonUniforms(this.engine.rendering.uniforms)}clone(){return new this.constructor(this.parameters)}getDefaultParams(){return{width:12,height:12,fontSize:14}}collisionTest(e){return{width:this.width,height:this.height}}createLabelTexture(e){const{backgroundCanvas:t,backgroundCanvasPropName:i}=e,n=this.labelHash,s=this.iconUrlHash,o=n.cache,r=this.canvasHash,a=this.ctx;let l;for(let g in o)if(o.hasOwnProperty(g)){const e=JSON.parse(g),{icon:t,text:i,id:n}=e,o=n?r.get(g):s.get(t);if("string"==typeof o||void 0===o)continue;const a=this.boxes.findIndex((e=>e.key===g));if(a>=0){const e=this.boxes.splice(a,1);this.boxes.unshift(e[0]);continue}const l=o.width,c=o.height,d=l+this.gap[0],h=c+this.gap[1];this.boxes.unshift({w:d,h:h,width:l,height:c,key:g,icon:o,text:i})}for(let g=0;g<this.boxes.length;g++){const e=this.boxes[g];this.boxHash.set(e.key,e)}return Dx(this.boxes,a,this.canvas,{fillStyle:this._fillStyle,fontSize:this.parameters.fontSize,gap:this.gap,padding:this.padding,dpr:this.engine.rendering.pixelRatio,drawText:!(i||t),textAlign:this.parameters.textAlign})?(this.texture.dispose(),this.texture=new il(this.canvas)):this.texture.needsUpdate=!0,l=this.texture,l}async _updateData(){const{vertexSizes:e,vertexBackgrounds:t,vertexBackgroundCanvas:i,vertexPositionOffsets:n,vertexVisible:s=!1,background:o,bgPropName:r="background",textPropName:a="text",visiblePropName:l="visible",backgroundCanvas:g,backgroundCanvasPropName:c}=this.parameters;let d=[];d=this._enableCollision&&this._collisionData?this._collisionData:this.dataSource.userData,d.length>(this.parameters.maxCacheSize||2e3)&&console.warn(`Label数量超过了最大限制，请更新maxCacheSize参数；当前最大值为${this.parameters.maxCacheSize||2e3}`);let h=this.labelHash;const u=this.iconUrlHash,I=this.canvasHash;I.clear();let p,m=h.length,A=h.length,C=[];if(g||c)for(let S=0;S<d.length;S++){let e=this.parameters.vertexBackgroundCanvas?d[S][c]:g;const t=d[S][a],i=JSON.stringify({id:d[S].id||d[S].index,text:String(t)});e instanceof Promise?C.push(e.then((e=>{void 0===I.get(i)&&I.set(i,e)}))):void 0===I.get(i)&&I.set(i,e),void 0===h.get(i)&&(h.set(i,m),m++)}else{for(let e=0;e<d.length;e++){const t=this.parameters.vertexBackgrounds?d[e][r]:o,i=d[e][a],n=JSON.stringify({icon:t,text:String(i)});void 0===u.get(t)&&u.set(t,t),void 0===h.get(n)&&(h.set(n,m),m++)}C=Array.from(u.entries()).filter((e=>"string"==typeof e[1])).map((([e,t])=>new Promise(((t,i)=>{this.url2canvas(e,(i=>{u.set(e,i),t(e)}))}))))}if(C.length>0&&await Promise.all(C),A===m&&this.oldTexture&&(p=this.oldTexture),p||(p=this.createLabelTexture({backgroundCanvasPropName:c,backgroundCanvas:g}),this.oldTexture=p),!p)return;this.material.mapTexture=p,this.material.uniforms.ulength.value=h.length,this._instanceIds=[];const f=[],b=[],y=[],_=[],v=[],x=[],B=[];let w=0;for(let S=0;S<d.length;S++){let h=d[S].position;const u=d[S].index,I=d[S][a],p=d[S][l];if(s&&!1===p)continue;this._instanceIds.push(S);const m=g||c?JSON.stringify({id:d[S].id||d[S].index,text:String(I)}):JSON.stringify({icon:t?d[S][r]:o,text:String(I)}),A=this.boxHash.get(m);if(!A)continue;for(let e=0;e<4;e++)f.push(...h),b.push(e),y.push(u),n&&B.push(...d[S].positionOffset);const C=A.x/this.canvas.width,G=(A.x+A.w)/this.canvas.width,M=(A.y+A.h)/this.canvas.height,R=A.y/this.canvas.height;_.push(C,M,C,R,G,R,G,M);const T=4*w;if(v.push(T,T+2,T+1,T,T+3,T+2),w++,t||i){let t=A.width,i=A.height;const{originWidth:n,originHeight:s}=A.icon;s&&n&&(t=n,i=s),e&&(t=d[S].width,i=d[S].height),x.push(t,i,t,i,t,i,t,i)}}this.geometry.setData({aPositions:f,pIndices:b,aObjectIndices:y,aUvs:_,indices:v,aSize:x,aPositionOffsets:B}),this.geometry.computeBoundingSphere(),this.makeGeometryOffsetPosition(this.geometry,f),this.needsUpdate=!1,this.engine.requestRender()}url2canvas(e,t){if("object"==typeof e)t(e);else{let i=new Image;i.crossOrigin="anonymous",i.onload=function(){let e=i.width,n=i.height,s=document.createElement("canvas");s.width=e,s.height=n,s.getContext("2d").drawImage(i,0,0,e,n),t(s)},i.onerror=function(){let e=document.createElement("canvas");e.width=20,e.height=40;let i=e.getContext("2d");i.fillStyle="red",i.beginPath(),i.lineTo(0,0),i.lineTo(20,0),i.lineTo(10,40),i.closePath(),i.fill(),t(e)},i.src=e}}getEntityByIndex(e){const t=this.dataSource;this._enableCollision&&this._collisionData&&(e=this._collisionData[e].index);const i={index:e,value:t.getDataItem(e),itemIndex:t.getDataItemIndex(e),pairs:{}},n=t.data;for(const s of Object.keys(n))i.pairs[s]=n[s][e];return i}raycast(e,t){const i=this.flat;if(!this.visible)return;if(i)return;const n=this.geometry,s=n.getAttribute("position");if(!s||!s.array||0===!s.array.length)return;const o=n.getAttribute("offset");let r=[];o&&(r=o.array);let a=e.camera;a||(a=this.engine.camera);const l=e.mouse;if(!l)return;const g=this.material.uniforms.resolution.value,c=l.x,d=l.y;let h=this.width/g.x,u=this.height/g.y,I=[];const p=n.getAttribute("aSize");p&&(I=p.array);let m=[];const A=n.getAttribute("aPositionOffsets");m=A?A.array:[];let C=0,f=0,b=0,y=0,_=0,v=0;yO.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse),yO.multiplyMatrices(yO,this.matrixWorld);const x=s.array;let B=0,w=0,S=1;this.keepSize||(S=this.material.uniforms.zoomUnits.value);for(let G=0,M=x.length-11;G<M;G+=12){const e=this.material.positionOffset||[0,0,0];if(this.parameters.vertexPositionOffsets&&(e[0]=m[G],e[1]=m[G+1],e[2]=m[G+2]),bO.set(x[G]+e[0],x[G+1]+e[1],x[G+2]+e[2],1),bO.applyMatrix4(yO),bO.divideScalar(bO.w),this.parameters.vertexOffsets?(B=G/12*8,_=r[B]||0,v=r[B+1]||0):(_=this.material.uniforms.offset.value?this.material.uniforms.offset.value[0]:0,v=this.material.uniforms.offset.value?this.material.uniforms.offset.value[1]:0),bO.x+=2*_/g.x/S,bO.y-=2*v/g.y/S,(this.parameters.vertexSizes||this.parameters.vertexBackgrounds||this.parameters.vertexBackgroundCanvas)&&(w=G/12*8,h=I[w]/g.x,u=I[w+1]/g.y),C=bO.x-h/S,b=bO.x+h/S,f=bO.y-u/S,y=bO.y+u/S,C<=c&&b>=c&&f<=d&&y>=d){fO.set(x[G],x[G+1],x[G+2]),fO.applyMatrix4(this.matrixWorld);const e=G/12;const i={instanceId:this._instanceIds[e],object:this,distance:fO.distanceTo(a.position)};t.push(i)}}}set padding(e){2===e.length?this._padding=[e[0],e[1],e[0],e[1]]:3===e.length?this._padding=[e[0],e[1],e[2],e[1]]:e.length>=4&&(this._padding=[e[0],e[1],e[2],e[3]])}get padding(){return this._padding}onDispose(){this.texture&&this.texture.dispose(),this.canvas&&(this.canvas=null),this.iconUrlHash.clear(),this.labelHash.clear(),this.boxHash.clear()}}function vO(e,t,i,n,s,o){if(s-n<=i)return;const r=n+s>>1;xO(e,t,r,n,s,o%2),vO(e,t,i,n,r-1,o+1),vO(e,t,i,r+1,s,o+1)}function xO(e,t,i,n,s,o){for(;s>n;){if(s-n>600){const r=s-n+1,a=i-n+1,l=Math.log(r),g=.5*Math.exp(2*l/3),c=.5*Math.sqrt(l*g*(r-g)/r)*(a-r/2<0?-1:1);xO(e,t,i,Math.max(n,Math.floor(i-a*g/r+c)),Math.min(s,Math.floor(i+(r-a)*g/r+c)),o)}const r=t[2*i+o];let a=n,l=s;for(BO(e,t,n,i),t[2*s+o]>r&&BO(e,t,n,s);a<l;){for(BO(e,t,a,l),a++,l--;t[2*a+o]<r;)a++;for(;t[2*l+o]>r;)l--}t[2*n+o]===r?BO(e,t,n,l):(l++,BO(e,t,l,s)),l<=i&&(n=l+1),i<=l&&(s=l-1)}}function BO(e,t,i,n){wO(e,i,n),wO(t,2*i,2*n),wO(t,2*i+1,2*n+1)}function wO(e,t,i){const n=e[t];e[t]=e[i],e[i]=n}function SO(e,t,i,n){const s=e-i,o=t-n;return s*s+o*o}const GO=e=>e[0],MO=e=>e[1];class RO{constructor(e,t=GO,i=MO,n=64,s=Float64Array){this.nodeSize=n,this.points=e;const o=e.length<65536?Uint16Array:Uint32Array,r=this.ids=new o(e.length),a=this.coords=new s(2*e.length);for(let l=0;l<e.length;l++)r[l]=l,a[2*l]=t(e[l]),a[2*l+1]=i(e[l]);vO(r,a,n,0,r.length-1,0)}range(e,t,i,n){return function(e,t,i,n,s,o,r){const a=[0,e.length-1,0],l=[];let g,c;for(;a.length;){const d=a.pop(),h=a.pop(),u=a.pop();if(h-u<=r){for(let r=u;r<=h;r++)g=t[2*r],c=t[2*r+1],g>=i&&g<=s&&c>=n&&c<=o&&l.push(e[r]);continue}const I=Math.floor((u+h)/2);g=t[2*I],c=t[2*I+1],g>=i&&g<=s&&c>=n&&c<=o&&l.push(e[I]);const p=(d+1)%2;(0===d?i<=g:n<=c)&&(a.push(u),a.push(I-1),a.push(p)),(0===d?s>=g:o>=c)&&(a.push(I+1),a.push(h),a.push(p))}return l}(this.ids,this.coords,e,t,i,n,this.nodeSize)}within(e,t,i){return function(e,t,i,n,s,o){const r=[0,e.length-1,0],a=[],l=s*s;for(;r.length;){const g=r.pop(),c=r.pop(),d=r.pop();if(c-d<=o){for(let s=d;s<=c;s++)SO(t[2*s],t[2*s+1],i,n)<=l&&a.push(e[s]);continue}const h=Math.floor((d+c)/2),u=t[2*h],I=t[2*h+1];SO(u,I,i,n)<=l&&a.push(e[h]);const p=(g+1)%2;(0===g?i-s<=u:n-s<=I)&&(r.push(d),r.push(h-1),r.push(p)),(0===g?i+s>=u:n+s>=I)&&(r.push(h+1),r.push(c),r.push(p))}return a}(this.ids,this.coords,e,t,i,this.nodeSize)}}const TO={minZoom:0,maxZoom:16,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:e=>e};class ZO{constructor(e){this.options=zO(Object.create(TO),e),this.trees=new Array(this.options.maxZoom+1)}convertDataItemsToGeoJSON(e){return e.map((e=>({type:"Feature",properties:e.attributes,geometry:{type:"Point",coordinates:e.coordinates}})))}load(e){const{log:t,minZoom:i,maxZoom:n,nodeSize:s}=this.options;t&&console.time("total time");const o=`prepare ${e.length} points`;t&&console.time(o),this.points=this.convertDataItemsToGeoJSON(e);let r=[];for(let a=0;a<this.points.length;a++){const e=this.points[a];(Array.isArray(e)||e.geometry)&&r.push(WO(e,a))}this.trees[n+1]=new RO(r,LO,DO,s,Float32Array),t&&console.timeEnd(o);for(let a=n;a>=i;a--)r=this._cluster(r,a),this.trees[a]=new RO(r,LO,DO,s,Float32Array);return t&&console.timeEnd("total time"),this}getClusters(e,t){let i=((e[0]+180)%360+360)%360-180;const n=Math.max(-90,Math.min(90,e[1]));let s=180===e[2]?180:((e[2]+180)%360+360)%360-180;const o=Math.max(-90,Math.min(90,e[3]));if(e[2]-e[0]>=360)i=-180,s=180;else if(i>s){const e=this.getClusters([i,n,180,o],t),r=this.getClusters([-180,n,s,o],t);return e.concat(r)}const r=this.trees[this._limitZoom(t)],a=r.range(FO(i),XO(o),FO(s),XO(n)),l=[];for(const g of a){const e=r.points[g];l.push(e.numPoints?EO(e):this.points[e.index])}return l}getChildren(e){const t=this._getOriginId(e),i=this._getOriginZoom(e),n="No cluster with the specified id.",s=this.trees[i];if(!s)throw new Error(n);const o=s.points[t];if(!o)throw new Error(n);const r=this.options.radius/(this.options.extent*Math.pow(2,i-1)),a=s.within(o.x,o.y,r),l=[];for(const g of a){const t=s.points[g];t.parentId===e&&l.push(t.numPoints?EO(t):this.points[t.index])}if(0===l.length)throw new Error(n);return l}getLeaves(e,t,i){t=t||10,i=i||0;const n=[];return this._appendLeaves(n,e,t,i,0),n}getTile(e,t,i){const n=this.trees[this._limitZoom(e)],s=Math.pow(2,e),{extent:o,radius:r}=this.options,a=r/o,l=(i-a)/s,g=(i+1+a)/s,c={features:[]};return this._addTileFeatures(n.range((t-a)/s,l,(t+1+a)/s,g),n.points,t,i,s,c),0===t&&this._addTileFeatures(n.range(1-a/s,l,1,g),n.points,s,i,s,c),t===s-1&&this._addTileFeatures(n.range(0,l,a/s,g),n.points,-1,i,s,c),c.features.length?c:null}getClusterExpansionZoom(e){let t=this._getOriginZoom(e)-1;for(;t<=this.options.maxZoom;){const i=this.getChildren(e);if(t++,1!==i.length)break;e=i[0].properties.cluster_id}return t}_appendLeaves(e,t,i,n,s){const o=this.getChildren(t);for(const r of o){const t=r.properties;if(t&&t.cluster?s+t.point_count<=n?s+=t.point_count:s=this._appendLeaves(e,t.cluster_id,i,n,s):s<n?s++:e.push(r),e.length===i)break}return s}_addTileFeatures(e,t,i,n,s,o){for(const r of e){const e=t[r],a=e.numPoints,l={type:1,geometry:[[Math.round(this.options.extent*(e.x*s-i)),Math.round(this.options.extent*(e.y*s-n))]],tags:a?NO(e):this.points[e.index].properties};let g;a?g=e.id:this.options.generateId?g=e.index:this.points[e.index].id&&(g=this.points[e.index].id),void 0!==g&&(l.id=g),o.features.push(l)}}_limitZoom(e){return Math.max(this.options.minZoom,Math.min(e,this.options.maxZoom+1))}_cluster(e,t){const i=[],{radius:n,extent:s,reduce:o}=this.options,r=n/(s*Math.pow(2,t));for(let a=0;a<e.length;a++){const n=e[a];if(n.zoom<=t)continue;n.zoom=t;const s=this.trees[t+1],l=s.within(n.x,n.y,r);let g=n.numPoints||1,c=n.x*g,d=n.y*g,h=o&&g>1?this._map(n,!0):null;const u=(a<<5)+(t+1)+this.points.length;for(const e of l){const i=s.points[e];if(i.zoom<=t)continue;i.zoom=t;const r=i.numPoints||1;c+=i.x*r,d+=i.y*r,g+=r,i.parentId=u,o&&(h||(h=this._map(n,!0)),o(h,this._map(i)))}1===g?i.push(n):(n.parentId=u,i.push(VO(c/g,d/g,u,g,h)))}return i}_getOriginId(e){return e-this.points.length>>5}_getOriginZoom(e){return(e-this.points.length)%32}_map(e,t){if(e.numPoints)return t?zO({},e.properties):e.properties;const i=this.points[e.index].properties,n=this.options.map(i);return t&&n===i?zO({},n):n}}function VO(e,t,i,n,s){return{x:e,y:t,zoom:1/0,id:i,parentId:-1,numPoints:n,properties:s}}function WO(e,t){const[i,n]=Array.isArray(e)?e:e.geometry.coordinates;return{x:FO(i),y:XO(n),zoom:1/0,index:t,parentId:-1}}function EO(e){return{type:"Feature",id:e.id,properties:NO(e),geometry:{type:"Point",coordinates:[(t=e.x,360*(t-.5)),HO(e.y)]}};var t}function NO(e){const t=e.numPoints,i=t>=1e4?`${Math.round(t/1e3)}k`:t>=1e3?Math.round(t/100)/10+"k":t;return zO(zO({},e.properties),{cluster:!0,cluster_id:e.id,point_count:t,point_count_abbreviated:i})}function FO(e){return e/360+.5}function XO(e){const t=Math.sin(e*Math.PI/180),i=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return i<0?0:i>1?1:i}function HO(e){const t=(180-360*e)*Math.PI/180;return 360*Math.atan(Math.exp(t))/Math.PI-90}function zO(e,t){for(const i in t)e[i]=t[i];return e}function LO(e){return e.x}function DO(e){return e.y}class KO extends gx{constructor(){super(...arguments),__publicField(this,"isEventEntitySupported",!0)}addComponent(e){if(!e.isGeoObject)return void console.warn("Only GeoObject can be added");e.__eventProxyByParent=!0,this.add(e),e.afterAddToEngine(this.engine);const t=this.getChildDataSource(e);return t&&(e.dataSource=t),this.needsUpdate=!0,e}removeComponent(e){this.remove(e),e.__eventProxyByParent=!1,e.dataSource=null,e.beforeRemoveFromEngine(this.engine),this.needsUpdate=!0}getChildDataSource(e){return this.dataSource}onBeforeScenePrepareRender(e,t,i,n){super.onBeforeScenePrepareRender&&super.onBeforeScenePrepareRender(e,t,i,n);for(const s of this.children)s.onBeforeScenePrepareRender&&s.onBeforeScenePrepareRender(e,t,i,n)}onBeforeSceneRender(e,t,i,n){super.onBeforeSceneRender&&super.onBeforeSceneRender(e,t,i,n);for(const s of this.children)s.onBeforeSceneRender&&s.onBeforeSceneRender(e,t,i,n)}setDataSource(e){super.setDataSource(e);for(const t of this.children)t.setDataSource(this.getChildDataSource(t))}_updateData(){for(const e of this.children)e.needsUpdate&&e._updateData();this.needsUpdate=!1}dispose(){for(const e of this.children)this.removeComponent(e)}}const YO={width:30,height:30,mapSrc:"https://bj.bcebos.com/v1/yanpan-screen-attachment/resources/image/yinlianPOC/djiudian.png"},PO={fillStyle:"#ccc",fontSize:16,flat:!1},kO={maxZoom:18,minZoom:5,radius:50};class OO extends XY{constructor(){super(),__publicField(this,"setModelData",(()=>{this.setAttribute("position",new Mn([-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],3)),this.setAttribute("uv",new Mn([0,0,0,1,1,1,1,0],2)),this.setIndex([0,2,1,0,3,2])})),this.setModelData()}}const UO=e=>{Object.defineProperties(e,{color:{get:function(){return this.uniforms.color.value},set:function(e){this.uniforms.color.value=hy(e)}},height:{get:function(){return this.uniforms.height.value},set:function(e){this.uniforms.height.value=e}},size:{get:function(){return this.uniforms.size.value},set:function(e){this.uniforms.size.value=e}},size3:{get:function(){return this.uniforms.size3.value},set:function(e){Array.isArray(e)&&3===e.length&&(this.uniforms.size3.value=e)}},useSize3:{get:function(){return this.defines.USE_SIZE3},set:function(e){e===this.defines.USE_SIZE3&&(this.defines.USE_SIZE3=!!e),this.needsUpdate=!0}},opacity:{get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}}})},QO=e=>{Object.defineProperties(e,{animationRotate:{get:function(){return!!this.defines.ENABLE_ANIMATION_ROTATE},set:function(e){e!==this.animationRotate&&(e?this.defines.ENABLE_ANIMATION_ROTATE=!0:delete this.defines.ENABLE_ANIMATION_ROTATE,this.needsUpdate=!0)}},animationRotatePeriod:{get:function(){return this.uniforms.animationRotatePeriod.value},set:function(e){this.uniforms.animationRotatePeriod.value=e}},animationJump:{get:function(){return!!this.defines.ENABLE_ANIMATION_JUMP},set:function(e){e!==this.animationJump&&(e?this.defines.ENABLE_ANIMATION_JUMP=!0:delete this.defines.ENABLE_ANIMATION_JUMP,this.needsUpdate=!0)}},animationJumpPeriod:{get:function(){return this.uniforms.animationJumpPeriod.value},set:function(e){this.uniforms.animationJumpPeriod.value=e}},animationJumpHeight:{get:function(){return this.uniforms.animationJumpHeight.value},set:function(e){this.uniforms.animationJumpHeight.value=e}},animationPeriodOffset:{get:function(){return this.uniforms.animationPeriodOffset.value},set:function(e){this.uniforms.animationPeriodOffset.value=e}},animationEffect:{get:function(){return this.uniforms.animationEffect.value},set:function(e){this.uniforms.animationEffect.value=e}},animationEffectPeriod:{get:function(){return this.uniforms.animationEffectPeriod.value},set:function(e){this.uniforms.animationEffectPeriod.value=e}},animationScale:{get:function(){return!!this.defines.ENABLE_ANIMATION_SCALE},set:function(e){e!==this.animationScale&&(e?this.defines.ENABLE_ANIMATION_SCALE=!0:delete this.defines.ENABLE_ANIMATION_SCALE,this.needsUpdate=!0)}},animationBreath:{get:function(){return!!this.defines.ENABLE_ANIMATION_BREATH},set:function(e){e!==this.animationBreath&&(e?this.defines.ENABLE_ANIMATION_BREATH=!0:delete this.defines.ENABLE_ANIMATION_BREATH,this.needsUpdate=!0)}},animationPeriod:{get:function(){return this.uniforms.animationPeriod.value},set:function(e){this.uniforms.animationPeriod.value=e}}})},JO=as.merge([ws.fog,{height:{value:0},size:{value:1},size3:{value:[1,1,1]},resolution:{value:[1,1]},zoomUnits:{value:1},color:{value:[1,0,0]},opacity:{value:1}},{animationRotatePeriod:{value:4e3},animationJumpPeriod:{value:4e3},animationJumpHeight:{value:30},animationPeriodOffset:{value:!1},animationEffect:{value:!0},animationEffectPeriod:{value:4e3},animationPeriod:{value:4e3}},Ay,Cy,{isCesium:{value:!1}}]);class jO extends mx{constructor(e){super(),this.type="InstancedEffectPointMaterial",this.isInstancedEffectPointMaterial=!0,this.lights=!1,Object.assign(this.uniforms,as.clone(JO)),UO(this),QO(this),vy(this),xy(this),this.setValues(e)}}let qO=as.merge([my,{color:{value:[1,.5,0]},borderColor:{value:[0,1,0]},borderOpacity:{value:1},fillOpacity:{value:1},opacity:{value:1},radius:{value:.5},borderWidth:{value:1},isEmissive:{value:!1}}]);class $O extends jO{constructor(e){super(),__publicField(this,"name","CircleMaterial"),__publicField(this,"isCircleMaterial",!0),this.depthTest=!1,this.depthWrite=!1,e.vertexSizes||(qO=as.merge([qO,{size:{value:100}}])),Object.assign(this.uniforms,as.clone(qO)),fy(this,["borderWidth","borderOpacity","fillOpacity","isEmissive"]),by(this,["borderColor"]),_y(this,[["vertexColors","MVT_USE_VERTEX_COLOR"],["vertexSizes","MVT_USE_VERTEX_SIZE"],["isGlobe","IS_GLOBE"]]),By(this),this.vertexShader="#define GLSLIFY 1\n#include <common>\n\n#ifdef MVT_USE_VERTEX_COLOR\n    varying vec4 vColor;\n#endif\n\n#ifndef MVT_USE_VERTEX_SIZE\n    uniform float size;\n#endif\n\n#ifdef IS_GLOBE\n    attribute mat4 ecefMatrix;\n#endif\n\nvarying vec2 vPosition;\nvarying float vScale;\n\n#include <mvt_selective_pars_vertex>\n#include <mvt_keepsize_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <mvt_extra_vertex_utils>\n\nvoid main() {\n\n    #include <mvt_selective_vertex>\n    vPosition = position.xy;\n\n    vec3 transformed = vec3(position);\n    #ifdef MVT_USE_VERTEX_SIZE\n        vScale = instanceMatrix[0][0];\n    #else\n        vScale = size;\n        transformed *= size;\n    #endif\n\n    // vec4 worldPosition = (modelMatrix * vec4(transformed, 1.0));\n    float pixelSize = getPixelSize(vec3(modelMatrix * instanceMatrix * vec4(0., 0., 0., 1.)));\n    if (keepSize) {\n        transformed *= pixelSize;\n    }\n\n    #ifdef IS_GLOBE\n        gl_Position = projectionMatrix * modelViewMatrix * instanceMatrix * ecefMatrix * vec4(transformed, 1.0);\n    #else\n        gl_Position = projectionMatrix * modelViewMatrix * instanceMatrix * vec4(transformed, 1.0);\n    #endif\n    #include <logdepthbuf_vertex>\n\n    #if defined(MVT_USE_VERTEX_COLOR) && defined(USE_INSTANCING_COLOR)\n        vColor.xyz = instanceColor.xyz;\n        vColor.a = 1.0;\n    #endif\n}","Gradient"===e.type?this.fragmentShader="#define GLSLIFY 1\n#include <common>\n\n#ifdef MVT_USE_VERTEX_COLOR\n    varying vec4 vColor;\n#else\n    uniform vec3 color;\n#endif\nuniform float radius;\nuniform float opacity;\nvarying vec2 vPosition;\n\n#include <mvt_selective_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n\nvoid main() {\n    float d = distance(vPosition, vec2(0, 0));\n    if (d > 0.5) {\n        discard;\n    }\n    vec4 fillColor;\n    #ifdef MVT_USE_VERTEX_COLOR\n        fillColor = vColor;\n    #else\n        fillColor = vec4(color, 1.0);\n    #endif\n    \n    fillColor.a = smoothstep(0.0, 1.0, pow(d / radius, 2.0));\n    // 边缘抗锯齿\n    if(d > -0.99 * radius) {\n        fillColor.a *= 1.0 - smoothstep(0.99, 1.0, d / radius); \n    }\n    fillColor.a *= opacity;\n    gl_FragColor = fillColor;\n    #ifdef OPAQUE\n        gl_FragColor.a = 1.0;\n    #endif\n\n    #include <mvt_selective_fragment>\n    #include <logdepthbuf_fragment>   \n    #include <colorspace_fragment>\n}":this.fragmentShader="#define GLSLIFY 1\n#include <common>\n\n#ifdef MVT_USE_VERTEX_COLOR\n    varying vec4 vColor;\n#else\n    uniform vec3 color;\n#endif\nuniform vec3 borderColor;\nuniform float opacity;\nuniform float borderOpacity;\nuniform float fillOpacity;\nuniform float radius;\nuniform float borderWidth;\n\nvarying vec2 vPosition;\nvarying float vScale;\n\n#include <logdepthbuf_pars_fragment>\n#include <mvt_selective_pars_fragment>\n\nvoid main() {\n    float dis = distance(vPosition, vec2(0, 0));\n\n    // 用来保持边框的宽度不会随着缩放而变化\n    float radius2 = radius - (borderWidth / vScale) * radius;\n\n    // 用于抗锯齿\n    float blur = 0.001;\n    float pct = (1.0 - smoothstep(radius - blur, radius + blur, dis));\n    vec4 border = vec4(borderColor, borderOpacity);\n    #ifdef MVT_USE_VERTEX_COLOR\n        vec4 currentColor = mix(vec4(vColor.rgb, fillOpacity), border, smoothstep( radius2 - blur,radius2 + blur, dis));\n    #else\n        vec4 currentColor = mix(vec4(color, fillOpacity), border, smoothstep( radius2 - blur,radius2 + blur, dis));\n    #endif\n\n    // 设置的自身颜色的透明度优先级高于设置的opacity优先级\n    gl_FragColor = vec4(currentColor.rgb, pct * currentColor.a);\n    if (gl_FragColor.a < 0.001) {\n        discard;\n    }\n    gl_FragColor.a *= opacity;\n    #ifdef OPAQUE\n        gl_FragColor.a = 1.0;\n    #endif\n\n    #include <mvt_selective_fragment>\n    #include <logdepthbuf_fragment>\n    #include <colorspace_fragment>\n}",this.emissiveEnabled=!0,this.emissive=[0,0,0],this.setValues(e)}}const eU=as.merge([ws.fog,{heatmap:{value:null},heatmapDepth:{value:null},gradientMap:{value:null},opacity:{value:1},isEmissive:{value:!1}}]);class tU extends mx{constructor(e){super(e),this.name="HeatmapMaterial",this.isHeatmapMaterial=!0,this.fog=!0,this.lights=!1,this.transparent=!0,this.fragmentShader="#define GLSLIFY 1\n#include <common>\n\nuniform sampler2D heatmap;\nuniform sampler2D gradientMap;\nuniform sampler2D heatmapDepth;\nuniform float opacity;\nuniform vec2 resolution;\n\nvarying vec2 vUv;\n\n#include <packing>\n\n#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n    uniform float logDepthBufFC;\n#endif\n\nvoid main() {\n    vec4 color = texture2D(heatmap, vUv);\n    \n    if (color.a <= 0.) {\n        discard;\n    }\n    gl_FragColor = texture2D(gradientMap, vec2(color.a, 0.5));\n    float addAlpha = 1.0;\n    if (color.a < 0.3) {\n        addAlpha = color.a * 3.3;\n    }\n    // if (color.a < 0.3) {\n    //     gl_FragColor.a = color.a * 3.3;\n    // } else {\n    //     gl_FragColor.a = 1.0;\n    // }\n    gl_FragColor.a *= color.a;\n    gl_FragColor.a *= opacity;\n\n    vec4 depthColor = texture2D(heatmapDepth, vUv);\n\n    #if defined( USE_LOGDEPTHBUF ) \n        gl_FragDepthEXT = unpackRGBAToDepth(depthColor);\n    #endif\n    #include <colorspace_fragment>\n}",this.vertexShader="#define GLSLIFY 1\n#include <common>\nuniform sampler2D gradientMap;\n\nvarying vec2 vUv;\n\n#include <logdepthbuf_pars_vertex>\nvoid main() { \n    \n    gl_Position = vec4(position, 1.0);\n    // vUv = position.xy;\n    vUv = vec2((position.x + 1.0) * 0.5, (position.y + 1.0) * 0.5);\n    // vec4 gray = texture2D(gradientMap, vUv);\n\n    // vec4 m0 = matrixWorldInverse * vec4(gl_Position.xy, 0.0, 1.0);\n    // vec4 m1 = matrixWorldInverse * vec4(gl_Position.xy, 1.0, 1.0);\n    // m0 /= m0.w;\n    // m1 /= m1.w;\n    // vec4 pixel = m0 + (-m0.z / (m1.z - m0.z)) * (m1 - m0);\n    // pixel.z = 100. * gray.a;\n\n    // gl_Position = projectionMatrix * pixelToViewMatrix * vec4(pixel.xyz, 1.0);\n    #include <logdepthbuf_vertex>\n}",Object.assign(this.uniforms,as.clone(eU)),fy(this,["opacity","resolution","isEmissive"]),yy(this,[]),_y(this,[]),this._cachedGradient=null,Object.defineProperties(this,{gradient:{get:function(){return this._cachedGradient},set:function(e){this._cachedGradient=e,this.updateGradientMap()}}}),this.createGradientMap(),this.uniforms.gradientMap.value=this._cachedGradientMap,this.setValues(e)}createGradientMap(){let e=document.createElement("canvas");e.width=64,e.height=2;let t=e.getContext("2d"),i=t.createLinearGradient(0,0,64,0);i.addColorStop(0,"rgba(0,0,255,1)"),i.addColorStop(.3,"rgba(0,255,0,1)"),i.addColorStop(.6,"rgba(255,255,0,1)"),i.addColorStop(1,"rgba(255,0,0,1)"),t.fillStyle=i,t.fillRect(0,0,64,2),this._cachedGradientMap=new il(e)}updateGradientMap(){let e=this._cachedGradient;if("[object Object]"!==Object.prototype.toString.call(e))return;let t=this._cachedGradientMap.image.getContext("2d");t.clearRect(0,0,64,2);let i=t.createLinearGradient(0,0,64,0);for(const n in e)Object.hasOwnProperty.call(e,n)&&i.addColorStop(n,e[n]);t.fillStyle=i,t.fillRect(0,0,64,2),this._cachedGradientMap.needsUpdate=!0}dispose(){this._cachedGradientMap&&this._cachedGradientMap.dispose(),super.dispose()}}const iU=as.merge([ws.fog,{radius:{value:30},circleMap:{value:null},minValue:{value:0},maxValue:{value:100},keepSize:{value:!1},attenuateMValueFactor:{value:0}}]);class nU extends mx{constructor(e){super(e),this.type="HeatmapTextureMaterial",this.isHeatmapTextureMaterial=!0,this.fog=!0,this.lights=!1,this.transparent=!0,this.depthTest=!1,this.fragmentShader="#define GLSLIFY 1\n#include <common>\n\nuniform sampler2D circleMap;\n\nvarying vec2 vUv;\nvarying float vWeight;\nvarying float vZDepth;\n#include <logdepthbuf_pars_fragment>\nvoid main() {\n    #include <logdepthbuf_fragment>\n    gl_FragColor.a = texture2D(circleMap, vUv).a * vWeight;\n    // gl_FragColor.a = 1.;\n    //#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n        // gl_FragColor = vec4(vec3(gl_FragDepthEXT), 1.0);\n        // int d = int(gl_FragDepthEXT * 16581375.0);\n        // gl_FragColor.r = float((d & 0xff0000) >> 16) / 255.0;\n        // gl_FragColor.g = float((d & 0x00ff00) >> 8) / 255.0;\n        // gl_FragColor.b = float(d & 0x0000ff) / 255.0;\n        // gl_FragColor.r = gl_FragDepthEXT; // a\n        // gl_FragColor.g = mod(gl_FragDepthEXT * 10.0, 1.0);\n        // gl_FragColor.b = mod(gl_FragDepthEXT * 1000.0, 1.0);\n        // int d = int(gl_FragDepthEXT * 10000000.0);\n        // gl_FragColor.r = (d & 0xff000 >> 16) / 255.0; \n        // gl_FragColor.g = (d & 0x00ff00 >> 8) / 255.0; \n        // gl_FragColor.b = (d & 0x0000ff ) / 255.0; \n        // gl_FragColor.r = gl_FragDepthEXT;\n        // gl_FragColor.r = gl_FragCoord.z;\n\n        // float depthVal = gl_FragCoord.z * (256.0*256.0 - 1.0) / (256.0*256.0);\n        // vec3 encode = fract( depthVal * vec3(1.0, 256.0, 256.0*256.0) );\n        // encode.xy = encode.xy - encode.yz / 256.0 + 1.0/512.0;\n        // gl_FragColor.rgb = encode;\n\n    // #else \n    //     gl_FragColor.r = gl_FragCoord.z;\n    // #endif\n    // gl_FragColor.r = 1.0;\n    // gl_FragColor.a = gl_FragCoord.z;\n}",this.vertexShader="#define GLSLIFY 1\n#include <common>\n\nattribute float instancedWeight;\n\nuniform float radius;\nuniform float maxValue;\nuniform float minValue;\nuniform bool keepSize;\nuniform float attenuateMValueFactor;\nuniform float pixelRatio;\nuniform vec2 resolution;\n\nvarying vec2 vUv;\nvarying float vWeight;\n\n#include <logdepthbuf_pars_vertex>\n#include <mvt_extra_vertex_utils>\n\nvoid main() { \n\n    float range = (maxValue - minValue) * attenuateMValueFactor;\n\n    vec4 worldPosition = (modelMatrix * vec4(position, 1.0));\n    float pixelSize = getPixelSize(worldPosition.xyz);\n\n    if (keepSize) {\n        gl_Position = projectionMatrix * modelViewMatrix * instanceMatrix * vec4(position * radius * pixelSize, 1.0);\n        range *= pixelSize;\n    } else {\n        gl_Position = projectionMatrix * modelViewMatrix * instanceMatrix * vec4(position * radius, 1.0);\n    }\n    \n    // gl_Position = vec4(position, 1.0);\n    // vZDepth = (gl_Position.z / gl_Position.w + 1.0) * 0.5;\n   \n    vUv = vec2(position.x + 0.5, position.y + 0.5);\n    \n    vWeight = (instancedWeight - minValue) / (maxValue + range - minValue);\n\n    #include <logdepthbuf_vertex>\n}",Object.assign(this.uniforms,as.clone(iU)),fy(this,["radius","minValue","maxValue","keepSize","attenuateMValueFactor"]),yy(this,[]),_y(this,[]);const t=this.createCircleMap();this.uniforms.circleMap.value=t,this.setValues(e),this.blending=5,this.blendSrc=u,this.blendDst=h,this.blendSrcAlpha=u,this.blendDstAlpha=u}createCircleMap(){let e=document.createElement("canvas");e.width=64,e.height=64;let t=e.getContext("2d"),i=t.createRadialGradient(32,32,0,32,32,32);return i.addColorStop(0,"rgba(0,0,0,1)"),i.addColorStop(1,"rgba(0,0,0,0)"),t.fillStyle=i,t.arc(32,32,32,0,2*Math.PI,!1),t.fill(),new il(e)}dispose(){this.uniforms.circleMap.value&&this.uniforms.circleMap.value.dispose(),super.dispose()}}const sU=as.merge([ws.fog,{radius:{value:30},circleMap:{value:null},minValue:{value:0},maxValue:{value:100},keepSize:{value:!1},attenuateMValueFactor:{value:0}}]);class oU extends mx{constructor(e){super(e),this.type="HeatmapDepthTextureMaterial",this.isHeatmapDepthTextureMaterial=!0,this.fog=!0,this.lights=!1,this.transparent=!0,this.depthTest=!1,this.fragmentShader="#define GLSLIFY 1\n#include <common>\n#include <packing>\n#include <logdepthbuf_pars_fragment>\nvoid main() {\n    #include <logdepthbuf_fragment>\n\n    #if defined( USE_LOGDEPTHBUF ) \n    \n        gl_FragColor = packDepthToRGBA(gl_FragDepthEXT);\n    #else\n        gl_FragColor = packDepthToRGBA(gl_FragCoord.z);\n    #endif\n    \n}",this.vertexShader="#define GLSLIFY 1\n#include <common>\nattribute vec3 instancedPosition;\n\nuniform float radius;\nuniform bool keepSize;\nuniform float pixelRatio;\nuniform vec2 resolution;\n\n#include <logdepthbuf_pars_vertex>\n#include <mvt_extra_vertex_utils>\n\nvoid main() { \n\n    vec4 worldPosition = (modelMatrix * vec4(position, 1.0));\n    float pixelSize = getPixelSize(worldPosition.xyz);\n    if (keepSize) {\n        gl_Position = projectionMatrix * modelViewMatrix * instanceMatrix * vec4(position * radius * pixelSize * 1.1, 1.0);\n    } else {\n        gl_Position = projectionMatrix * modelViewMatrix * instanceMatrix * vec4(position * radius * 1.1, 1.0);\n    }\n    #include <logdepthbuf_vertex>\n}",Object.assign(this.uniforms,as.clone(sU)),fy(this,["radius","minValue","maxValue","keepSize","attenuateMValueFactor"]),yy(this,[]),_y(this,[]),this.setValues(e)}}class rU extends og{constructor(){super();const e=this.geometry=new xs;this.setAttribute("position",e.attributes.position),this.setAttribute("uv",e.attributes.uv),this.setIndex(e.index)}dispose(){this.geometry.dispose()}}const aU=as.merge([ws.fog,Ay,my,{map:{value:null},pixelRatio:{value:1},lineHeight:{value:14},pixelOffsetX:{value:0},pixelOffsetY:{value:0},positionOffsetX:{value:0},positionOffsetZ:{value:0},positionOffsetY:{value:0},backgroundColor:{value:[1,1,0,0]},uFlat:{value:!1},opacity:{value:1},isEmissive:{value:!1},uRotateZ:{value:0},keepSize:{value:!0},depthTexture:{value:null},cameraFar:{value:0}}]);class lU extends mx{constructor(e){super(),this.name="DefaultTextMaterial",this.vertexShader="#define GLSLIFY 1\n#include <common>\n\nuniform float positionOffsetX;\nuniform float positionOffsetY;\nuniform float pixelOffsetX;\nuniform float pixelOffsetY;\nuniform float positionOffsetZ;\nuniform bool uFlat;\n#ifdef RENDER_IN_POSTPROCESS\n    uniform float cameraFar;\n#endif\n\nattribute float pIndex;\nattribute vec2 wh;\n\n#ifdef IS_GLOBE\n    attribute mat4 instanceMatrix;\n#endif\n\n#ifdef MVT_USE_VERTEX_ROTATEZ\n    attribute float aRotateZ;\n# else\n    uniform float uRotateZ;\n#endif\n\nvarying vec2 vUv;\n\n#ifdef RENDER_IN_POSTPROCESS\n    varying vec2 vClipSpacePosition;\n    varying float vLogDepth;\n#endif\n#include <logdepthbuf_pars_vertex>\n#include <mvt_selective_pars_vertex>\n#include <mvt_keepsize_pars_vertex>\n#include <mvt_extra_vertex_utils>\n\nvec3 transformCoord(vec3 coord, vec2 size, float corner, float rotateZ) {\n    float x = coord.x;\n    float y = coord.y;\n    if (corner == 1.0) {\n        x += -size.x * cos(rotateZ) + size.y * sin(rotateZ);\n        y += size.y * cos(rotateZ) + size.x * sin(rotateZ);\n    } else if (corner == 2.0) {\n        x += size.x * cos(rotateZ) + size.y * sin(rotateZ);\n        y += size.y * cos(rotateZ) - size.x * sin(rotateZ);\n    } else if (corner == 3.0) {\n        x += size.x * cos(rotateZ) - size.y * sin(rotateZ);\n        y += -size.y * cos(rotateZ) - size.x * sin(rotateZ);\n    } else {\n        x += -size.x * cos(rotateZ) - size.y * sin(rotateZ);\n        y += -size.y * cos(rotateZ) + size.x * sin(rotateZ);\n    }\n    return vec3(x, y, coord.z);\n}\n\nvoid main() {\n    #include <mvt_selective_vertex>\n    // float x = position.x;\n    // float y = position.y;\n    vUv = uv;\n\n    float rotateZ;\n    #ifdef MVT_USE_VERTEX_ROTATEZ\n        rotateZ = aRotateZ;\n    # else\n        rotateZ = uRotateZ;\n    #endif\n\n    mat4 currentInstanceMatrix = mat4(1.0);\n    vec3 currentPosition = position;\n    #ifdef IS_GLOBE\n        currentInstanceMatrix = instanceMatrix;\n\n        currentInstanceMatrix[3][0] = position.x;\n        currentInstanceMatrix[3][1] = position.y;\n        currentInstanceMatrix[3][2] = position.z;\n\n        currentPosition = vec3(0.0, 0.0, 0.0);\n    #endif\n\n    vec4 worldPosition = (modelMatrix * currentInstanceMatrix * vec4(currentPosition, 1.0));\n\n    #ifdef RENDER_IN_POSTPROCESS\n    vec4 clipSpacePosition = projectionMatrix * viewMatrix * worldPosition;\n    vClipSpacePosition.xy = ((clipSpacePosition.xy / clipSpacePosition.w) + 1.0) / 2.0;\n\n    float fcoef = 1.0 / log2(cameraFar + 1.0);\n    float logDepth = log2(max(1e-6, 1.0 + clipSpacePosition.w)) * fcoef;\n    vLogDepth = logDepth;\n    #endif\n\n    if (uFlat) {\n        // viewMatrix[0]表示相机的右方向，不管相机如何倾斜tilt，法向量都指向正北方向，正好可以用来计算和文字的夹角\n        mat4 localViewMatrix = viewMatrix * currentInstanceMatrix;\n        vec4 right = localViewMatrix[0];\n        float theta = dot(vec2(sin(rotateZ), cos(rotateZ)), vec2(-right.y, right.x));\n        if (theta < 0.0) {\n            rotateZ += PI;\n        }\n        // TODO 支持offset\n        float hw = wh.x * 0.5;\n        float hh = wh.y * 0.5;\n        if (keepSize) {\n            float pixelSize = getPixelSize(worldPosition.xyz);\n            hw = hw * pixelSize;\n            hh = hh * pixelSize;\n        }\n\n        vec3 current = transformCoord(currentPosition, vec2(hw, hh), pIndex, -rotateZ);\n        gl_Position = projectionMatrix * modelViewMatrix * currentInstanceMatrix * vec4(current, 1.0);\n\n        // vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n    }\n    else {\n        // gl_Position = projectionMatrix * modelViewMatrix * vec4(position.x + positionOffsetX * pixelSize, position.y + positionOffsetY * pixelSize, position.z + positionOffsetZ * pixelSize, 1.0);\n        worldPosition.x += positionOffsetX;\n        worldPosition.y += positionOffsetY;\n        worldPosition.z += positionOffsetZ;\n        vec4 pos = projectionMatrix * viewMatrix * worldPosition;\n        float w = pos.w;\n        vec3 screen = pos.xyz / w;\n        \n        float hw = wh.x / resolution.x;\n        float hh = wh.y / resolution.y;\n        if (!keepSize) {\n            float pixelSize = getPixelSize(worldPosition.xyz);\n            hw = hw / pixelSize;\n            hh = hh / pixelSize;\n        }\n\n        vec3 current = transformCoord(screen.xyz, vec2(hw, hh), pIndex, -rotateZ);\n        gl_Position = vec4(current, 1.0);\n\n        gl_Position.x += pixelOffsetX * 2. / resolution.x;\n        gl_Position.y += pixelOffsetY * 2. / resolution.y;\n\n        gl_Position *= w;\n    }\n    #include <logdepthbuf_vertex>\n    // gl_PointSize = size * pixelRatio;\n    // vSize = size;\n    // vOffset = offset;\n}",this.fragmentShader="#define GLSLIFY 1\n#include <common>\n\nuniform sampler2D map;\nuniform sampler2D depthTexture;\nuniform vec4 backgroundColor;\nuniform float opacity;\nuniform float lineHeight;\n\n#ifdef RENDER_IN_POSTPROCESS\n    uniform float cameraFar;\n#endif\n\nvarying vec2 vUv;\n\n#ifdef RENDER_IN_POSTPROCESS\n    varying vec2 vClipSpacePosition;\n    varying float vLogDepth;\n#endif\n\n#include <mvt_selective_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <tonemapping_pars_fragment>\n#include <output_pars_fragment>\nvoid main() {\n    #include <logdepthbuf_fragment>\n    // gl_FragColor = vec4(1., 0, 0, 1.);\n    gl_FragColor = texture2D(map, vec2(vUv.x, 1.0 - vUv.y));\n\n    #ifdef RENDER_IN_POSTPROCESS\n    float depthValue = texture2D(depthTexture, vClipSpacePosition).r;\n    float bias = 0.001; // 避免设置一个阈值，精度误差造成文字绘制不稳定\n    if (vLogDepth > depthValue + bias) {\n        discard;\n    }\n    #endif\n\n    if (backgroundColor.a > 0.0) {\n        gl_FragColor = mix(backgroundColor, gl_FragColor, gl_FragColor.a);\n    }\n\n    if (gl_FragColor.a <= 0.0) {\n        discard;\n    }\n    gl_FragColor.a *= opacity;\n\n    #include <mvt_selective_fragment> \n    #include <tonemapping_fragment>\n    #include <colorspace_fragment>\n    \n    #include <output_fragment>\n}",this.isDefaultTextMaterial=!0,this.transparent=!0,this.depthTest=!1,this.depthWrite=!1,Object.assign(this.uniforms,as.clone(aU)),vy(this),xy(this),fy(this,["lineHeight","pixelRatio","map","depthTexture","cameraFar","pixelOffsetX","pixelOffsetY","positionOffsetX","positionOffsetY","positionOffsetZ","backgroundColor","resolution","opacity","isEmissive"]),yy(this,[["flat","uFlat"],["rotateZ","uRotateZ"]]),_y(this,[["vertexRotateZs","MVT_USE_VERTEX_ROTATEZ"],["isGlobe","IS_GLOBE"],["isRenderInPostprocess","RENDER_IN_POSTPROCESS"]]),By(this),this.emissiveEnabled=!0,this.emissive=[0,0,0],this.setValues(e)}}let gU;const cU=new Qt,dU=new Dt,hU=new Bi;const uU=as.merge([ws.fog,Ay,my,{map:{value:null},pixelRatio:{value:1},lineHeight:{value:14},pixelOffsetX:{value:0},pixelOffsetY:{value:0},positionOffsetX:{value:0},positionOffsetZ:{value:0},positionOffsetY:{value:0},backgroundColor:{value:[1,1,0,0]},uFlat:{value:!1},opacity:{value:1},isEmissive:{value:!1},uRotateZ:{value:0},keepSize:{value:!0},outlineBuffer:{value:0},outlineColor:{value:new In(0)},color:{value:new In(16777215)},sdfBuffer:{value:.75},gamma:{value:.1},isHalo:{value:0},fadeDuration:{value:300}}]);class IU extends mx{constructor(e){super(),this.name="SDFTextMaterial",this.vertexShader="#define GLSLIFY 1\n#include <common>\n\nuniform float positionOffsetX;\nuniform float positionOffsetY;\nuniform float pixelOffsetX;\nuniform float pixelOffsetY;\nuniform float positionOffsetZ;\nuniform bool uFlat;\n\nattribute float pIndex;\nattribute vec4 iconFrame;\nattribute vec2 wh;\nattribute vec4 strokeStyle;\nattribute vec3 fillStyle;\nattribute vec4 sizeAndOffset;\n\n#ifdef IS_ALIGN_ROTATE\nattribute float verticalOffsets;\n#endif\n\nvarying vec4 vStrokeStyle;\nvarying vec3 vFillStyle;\nvarying float vFontSize;\n\n#ifdef IS_GLOBE\n    attribute mat4 ecefMatrix;\n#endif\n\n#ifdef MVT_USE_VERTEX_ROTATEZ\n    attribute float aRotateZ;\n# else\n    uniform float uRotateZ;\n#endif\n\nuniform float elapsedTime;\n#ifdef MVT_ENABLE_FADE\n    attribute float fadeOpacity;\n    attribute float fadeSince;\n    uniform float fadeDuration;\n    varying float vFadeOpacity;\n#endif\n\nvarying vec2 vUv;\n#include <logdepthbuf_pars_vertex>\n#include <mvt_selective_pars_vertex>\n#include <mvt_keepsize_pars_vertex>\n#include <mvt_extra_vertex_utils>\n\nvec3 transformCoord(vec3 coord, vec2 size, float corner, float rotateZ) {\n    float x = coord.x;\n    float y = coord.y;\n    if (corner == 1.0) {\n        // 左上\n        x += -size.x * cos(rotateZ) + size.y * sin(rotateZ);\n        y += size.y * cos(rotateZ) + size.x * sin(rotateZ);\n    } else if (corner == 2.0) {\n        // 右上\n        x += size.x * cos(rotateZ) + size.y * sin(rotateZ);\n        y += size.y * cos(rotateZ) - size.x * sin(rotateZ);\n    } else if (corner == 3.0) {\n        // 右下\n        x += size.x * cos(rotateZ) - size.y * sin(rotateZ);\n        y += -size.y * cos(rotateZ) - size.x * sin(rotateZ);\n    } else {\n        // 左下\n        x += -size.x * cos(rotateZ) - size.y * sin(rotateZ);\n        y += -size.y * cos(rotateZ) + size.x * sin(rotateZ);\n    }\n    return vec3(x, y, coord.z);\n}\n\nvoid main() {\n    #include <mvt_selective_vertex>\n    // float x = position.x;\n    // float y = position.y;\n    vUv = uv;\n\n    float rotateZ;\n    #ifdef MVT_USE_VERTEX_ROTATEZ\n        rotateZ = aRotateZ;\n    # else\n        rotateZ = uRotateZ;\n    #endif\n\n    mat4 currentInstanceMatrix = mat4(1.0);\n    vec3 currentPosition = position;\n    #ifdef IS_GLOBE\n        currentInstanceMatrix = ecefMatrix;\n\n        currentInstanceMatrix[3][0] = position.x;\n        currentInstanceMatrix[3][1] = position.y;\n        currentInstanceMatrix[3][2] = position.z;\n\n        currentPosition = vec3(0.0, 0.0, 0.0);\n    #endif\n\n    float width = iconFrame.z;\n    float height = iconFrame.w;\n    float scale = sizeAndOffset.x / height;\n\n    currentPosition.x += positionOffsetX;\n    currentPosition.y += positionOffsetY;\n    currentPosition.z += positionOffsetZ;\n   vec4 worldPosition = (modelMatrix * currentInstanceMatrix * vec4(currentPosition, 1.0));\n    if (uFlat) {\n        // viewMatrix[0]表示相机的右方向，不管相机如何倾斜tilt，法向量都指向正北方向，正好可以用来计算和文字的夹角\n        mat4 localViewMatrix = viewMatrix * currentInstanceMatrix;\n        vec4 right = localViewMatrix[0];\n        float cosTheta = dot(vec2(sin(rotateZ), cos(rotateZ)), vec2(-right.y, right.x));\n\n        float rotateOffset = 0.0;\n        #ifdef IS_ALIGN_ROTATE\n        // 用于判断方向\n        float sinTheta = sin(rotateZ) * right.x - cos(rotateZ) * -right.y;\n\n        // [-π, π] + 0.25 PI\n        float theta = atan(sinTheta, cosTheta) + PI * 0.25;\n        if (theta < 0.0) {\n            theta += 2.0 * PI;\n        }\n\n        float deg = degrees(theta);\n\n        float isVertical = 0.0;\n        // 根据 theta 划分象限\n        if (deg >= 90.0 && deg < 180.0) {\n            rotateOffset = -PI * 0.5;\n            rotateZ += PI;\n            isVertical = 1.0;\n        } else if (deg >= 180.0 && deg < 270.0) {\n            rotateZ += PI;\n        } else if (deg >= 270.0){\n            rotateOffset = -PI * 0.5;\n            isVertical = 1.0;\n        }\n        #else\n        if (cosTheta < 0.0) {\n            rotateZ += PI;\n        }\n        #endif\n\n        // TODO 支持offset\n        float hw = width * 0.5 * scale;\n        float hh = height * 0.5 * scale;\n\n        float pixelSize = 1.0;\n        if (keepSize) {\n            pixelSize = getPixelSize(worldPosition.xyz);\n            // pixelSize = pixelSize * 2.0;\n            hw = hw * pixelSize;\n            hh = hh * pixelSize;\n\n        }\n\n        vec3 current = currentPosition;\n\n        #ifdef IS_ALIGN_ROTATE\n        float xOffset = isVertical == 1.0 ? ((verticalOffsets - sizeAndOffset.w) * pixelSize * scale) : sizeAndOffset.z * pixelSize * scale;\n        float yOffset = isVertical == 1.0 ? 0.0 : sizeAndOffset.w * pixelSize * scale;\n        #else\n        float xOffset = sizeAndOffset.z * pixelSize * scale;\n        float yOffset = sizeAndOffset.w * pixelSize * scale;\n        #endif\n\n        xOffset += pixelOffsetX * scale;\n        yOffset += pixelOffsetY * scale;\n\n        current = transformCoord(current, vec2(hw, hh), pIndex, -rotateZ + rotateOffset);\n        current = transformCoord(current, vec2(xOffset, yOffset), 2.0, -rotateZ);\n\n        gl_Position = projectionMatrix * modelViewMatrix * currentInstanceMatrix * vec4(current, 1.0);\n\n        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n    }\n    else {\n        // gl_Position = projectionMatrix * modelViewMatrix * vec4(position.x + positionOffsetX * pixelSize, position.y + positionOffsetY * pixelSize, position.z + positionOffsetZ * pixelSize, 1.0);\n        vec4 pos = projectionMatrix * viewMatrix * worldPosition;\n        float w = pos.w;\n       \n        vec3 screen = pos.xyz / w;\n\n        float hw = width / resolution.x * scale;\n        float hh = height / resolution.y * scale;\n\n        float pixelSize = 1.0;\n        if (!keepSize) {\n            pixelSize = getPixelSize(worldPosition.xyz);\n            pixelSize = pixelSize * 2.0;\n\n            hw /= pixelSize;\n            hh /= pixelSize;\n        }\n\n        vec3 current = transformCoord(screen.xyz, vec2(hw, hh), pIndex, -rotateZ);\n        current.x += sizeAndOffset.z * 2.0 / resolution.x * scale / pixelSize + pixelOffsetX / resolution.x;\n        current.y += sizeAndOffset.w * 2.0 / resolution.y * scale / pixelSize + pixelOffsetY / resolution.y;\n        gl_Position = vec4(current, 1.0);\n\n        gl_Position *= w;\n    }\n\n    #ifdef MVT_ENABLE_FADE\n        float fadeDiff = (elapsedTime - fadeSince) / fadeDuration;\n        if (fadeOpacity > 2.0) {\n            fadeDiff = clamp(fadeDiff, 0.0, 1.0);\n            vFadeOpacity = fadeOpacity - fadeDiff - 2.0;\n            vFadeOpacity = vFadeOpacity * vFadeOpacity;\n        } else {\n            vFadeOpacity = fadeOpacity + fadeDiff;\n            vFadeOpacity = sqrt(vFadeOpacity);\n        }\n        vFadeOpacity = clamp(vFadeOpacity, 0.0, 1.0);\n    #endif\n\n    vStrokeStyle = strokeStyle;\n    vFillStyle = fillStyle;\n\n    vFontSize = sizeAndOffset.y;\n\n    #include <logdepthbuf_vertex>\n    // gl_PointSize = size * pixelRatio;\n    // vSize = size;\n    // vOffset = offset;\n}",this.fragmentShader="#define GLSLIFY 1\n#include <common>\n\n#define SDF_BUFFER 6.0\n#define SDF_PX 8.0\n\nuniform sampler2D map;\nuniform vec4 backgroundColor;\nuniform float opacity;\nuniform float lineHeight;\nuniform vec3 color;\nuniform float sdfBuffer;\nuniform float pixelRatio;\nuniform float isHalo;\nvarying vec2 vUv;\n\nvarying vec4 vStrokeStyle;\nvarying vec3 vFillStyle;\nvarying float vgamma_scale;\nvarying float vFontSize;\n\n#include <mvt_selective_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n\n#ifdef MVT_ENABLE_FADE\n    varying float vFadeOpacity;\n#endif\nvoid main() {\n    #include <logdepthbuf_fragment>\n\n    float fontScale = vFontSize / 24.0;\n    float gamma = (0.105 / pixelRatio) / fontScale;\n    float buff = (256.0 - 64.0) / 256.0;\n\n    vec3 outColor = vFillStyle;\n\n    if (isHalo > 0.0) {\n        if (vStrokeStyle.w > 0.0) {\n          outColor = vStrokeStyle.xyz;\n          buff = (SDF_BUFFER - vStrokeStyle.w / fontScale) / SDF_PX;\n        }\n    }\n\n    float distance = texture2D(map, vec2(vUv.x, vUv.y)).r;\n    float alpha = smoothstep(buff - gamma, buff + gamma, distance);\n\n    alpha = clamp(alpha * 1.5, 0.0, 1.0);\n\n    gl_FragColor = vec4(outColor, alpha);\n\n    #ifdef MVT_ENABLE_FADE\n        gl_FragColor.a *= vFadeOpacity;\n    #endif\n    \n    #include <mvt_selective_fragment> \n    #include <tonemapping_fragment>\n    #include <colorspace_fragment>\n    \n}",this.isSDFTextMaterial=!0,this.transparent=!0,this.depthTest=!1,this.depthWrite=!1,Object.assign(this.uniforms,as.clone(uU)),vy(this),xy(this),fy(this,["lineHeight","pixelRatio","map","pixelOffsetX","pixelOffsetY","positionOffsetX","positionOffsetY","positionOffsetZ","backgroundColor","resolution","opacity","isEmissive","isHalo","fadeDuration"]),yy(this,[["flat","uFlat"],["rotateZ","uRotateZ"]]),_y(this,[["vertexRotateZs","MVT_USE_VERTEX_ROTATEZ"],["isGlobe","IS_GLOBE"],["alignRotate","IS_ALIGN_ROTATE"],["enableFade","MVT_ENABLE_FADE"]]),By(this),by(this,["color"]),this.emissiveEnabled=!0,this.emissive=[0,0,0],this.setValues(e)}}class pU extends gx{constructor(){super(...arguments),__publicField(this,"isGroup",!0)}}let mU;const AU={center:0,left:1,right:-1},CU=new Bi,fU={fontSize:48,buffer:6,radius:16},bU=new Qt,yU=16,_U="400",vU=[1,1,0],xU=[0,0,0],BU=0;class wU extends gx{constructor(){super(...arguments),__publicField(this,"isLine",!0),__publicField(this,"isLineSegments",!0)}}const SU=[];const GU=new Qt,MU=new Qt;function RU(e,t){const i=e.length,n=new Array(i);for(let s=0;s<i;s++)MU.fromArray(e[s]),n[s]=t.cartesianToCartographic(MU,GU).z;return n}const TU=new Qt,ZU=new Qt,VU=new Qt,WU=new Qt,EU=new Qt;new Qt;const NU=new EC;function FU(e,t,i,n,s,o,r,a){const l=n.scaleToGeodeticSurface(e,TU),g=n.scaleToGeodeticSurface(t,ZU),c=function(e,t,i){let n;return n=e.isVector3?e.distanceTo(t):oS(e,t),Math.ceil(n/i)}(e,t,i),d=n.cartesianToCartographic(l,VU),h=n.cartesianToCartographic(g,WU),u=function(e,t,i){const n=SU;n.length=e;let s=0;if(t===i){for(s=0;s<e;s++)n[s]=t;return n}const o=(i-t)/e;for(let r=0;r<e;r++){const e=t+r*o;n[r]=e}return n}(c,s,o);NU.setEndPoints(d,h);const I=NU.surfaceDistance/c;let p=a;d.z=s;let m=n.cartographicToCartesian(d,EU);m.toArray(r,p),p+=3;for(let A=1;A<c;A++){const e=NU.interpolateUsingSurfaceDistance(A*I,WU);e.z=u[A],m=n.cartographicToCartesian(e,EU),m.toArray(r,p),p+=3}return p}new Qt,new Qt,new Qt;const XU=new Qt,HU=new Qt,zU=new Qt,LU=new Qt,DU=new Qt,KU=new Qt,YU=new Qt;function PU(e,t,i){let n;return n=e.isVector3?e.distanceTo(t):oS(e,t),Math.ceil(n/i)}const kU=new Qt,OU=new Qt;function UU(e,t){const i=e.length,n=new Array(i);for(let s=0;s<i;s++)OU.fromArray(e[s]),n[s]=t.cartesianToCartographic(OU,kU).z;return n}class QU extends Fn{constructor(e){super(e),this._granularity=e.granularity||Km.RADIANS_PER_DEGREE,this._height=e.height||0,this.parameters=e}setData(e){this._needsUpdate=!0;this.engine.map.isGlobe?this.updateGeometry3D(e):this.updateGeometryColumbus(e),this._needsUpdate=!1}updateGeometryColumbus(e){const{vertexColors:t}=this.parameters,i=[],n=[],s=[],o=[];let r=0;for(let a=0;a<e.position.length;a++){const l=e.position[a],g=e.index[a];for(let c=0;c<l.length-1;c++){const d=l[c],h=l[c+1];if(i.push(d[0],d[1],d[2],h[0],h[1],h[2]),o.push(r,r+1),n.push(g,g),t&&e.color){let t=cy(e.color[a]);s.push(t[0],t[1],t[2],t[3]),s.push(t[0],t[1],t[2],t[3])}r+=2}}this.cachedPositions=i,this.setAttribute("position",new Mn(i,3)),this.setAttribute("objectIndex",new Mn(n,1)),t&&this.setAttribute("color",new Mn(s,4)),this.setIndex(o)}updateGeometry3D(e){const{vertexColors:t}=this.parameters,i=[],n=[],s=[],o=[];let r=0;const a=this._granularity,l=this.engine.map.map.ellipsoid||eA.WGS84,g=Km.chordLength(a,l.maximumRadius);for(let c=0;c<e.position.length;c++){const a=e.position[c],d=e.index[c],h=e.color&&e.color[c],u=UU(a,l).map((e=>e+this._height)),I=this.generateArc({positions:a,minDistance:g,ellipsoid:l,height:u}),p=I.length/3;for(let e=0;e<p-1;e++){if(i.push(I[3*e],I[3*e+1],I[3*e+2],I[3*(e+1)],I[3*(e+1)+1],I[3*(e+1)+2]),n.push(d,d),o.push(r,r+1),t&&h){let e=cy(h);s.push(e[0],e[1],e[2],e[3]),s.push(e[0],e[1],e[2],e[3])}r+=2}}this.cachedPositions=i,this.setAttribute("position",new Mn(i,3)),this.setAttribute("objectIndex",new Mn(n,1)),t&&this.setAttribute("color",new Mn(s,4)),this.setIndex(o)}generateArc(e){e||(e={});const t=e.positions,i=t.length,n=e.ellipsoid||eA.WGS84;let s=e.height||0;const o=Array.isArray(s);if(i<1)return[];if(1===i){LU.fromArray(t[0]);const e=n.scaleToGeodeticSurface(LU,XU);if(s=o?s[0]:s,0!==s){const t=n.geodeticSurfaceNormal(e,zU);jm.multiplyByScalar(t,s,t),jm.add(e,t,e)}return[e.x,e.y,e.z]}let r=e.minDistance;am(r)||(r=Km.chordLength(this._granularity,n.maximumRadius));let a,l=0;for(let u=0;u<i-1;u++)l+=PU(t[u],t[u+1],r);const g=new Array(3*(l+1));let c=0;const d=new Qt;for(a=0;a<i-1;a++){KU.fromArray(t[a]),YU.fromArray(t[a+1]),d.crossVectors(KU,YU).normalize();const e=o?s[a]:s,i=o?s[a+1]:s;c=FU(KU,YU,r,n,e,i,g,c)}DU.set(...t[i-1]);const h=n.cartesianToCartographic(DU,HU);h.z=o?s[i-1]:s;return n.cartographicToCartesian(h,zU).toArray(g,c),c+=3,g}}class JU extends Fn{constructor(){super(...arguments),__publicField(this,"_volumeSegmentLines",((e,t,i,n,s,o,r,a,l,g,c)=>{let d=0,h=new bt;const u=[r[0],r[1]];let I=rS([o[0],o[1]],u);if(c&&(h=bS(I),this._volumeExtrusions(e,t,n,i,o,h,l)),a){let s=rS(u,[a[0],a[1]]),o=new bt;o.addVectors(I,s),o.normalize();const g=yS(I,s),c=bS(I),h=Math.min(l,l/g.dot(c));this._volumeExtrusions(e,t,n,i,r,g,h),d+=2}else h=bS(I),this._volumeExtrusions(e,t,n,i,r,h,l),d+=2;return d})),__publicField(this,"_volumeExtrusions",((e,t,i,n,s,o,r)=>{i.push(o.x,o.y,0,-o.x,-o.y,0),e.push(s[0]+o.x*r/2,s[1]+o.y*r/2,s[2]),t.push(s[0]-o.x*r/2,s[1]-o.y*r/2,s[2]),n.push(r,r)}))}createVolumeGeometry(e,t){let i=this.parameters.lineWidth*t,n=[];for(let s=0;s<e.length;s++){const{vertices:t}=this.lineToShadowVolumeMesh(e[s],i);n.push([t])}return n}lineToShadowVolumeMesh(e,t){let i=0,n=null,s=null,o=null,r=null;const a=[],l=[],g=[],c=[],d=[],h=[];let u=!0;for(let m=1,A=e.length-1;m<=A;m++){if(n=r||e[m-1],s=e[m],o=e[m+1],o&&sS(s,o)){r=n;continue}const a=this._volumeSegmentLines(d,h,c,l,g,n,s,o,t,i,u);-1!==a&&(i+=a,r=null),u=!1}const I=this.conversion(d,3),p=this.conversion(h,3);return a.push(...I.concat(p.reverse())),a.push(a[0]),{vertices:a,indices:g,normals:l,widths:c}}conversion(e,t){let i=e.length,n=i%t==0?i/t:Math.floor(i/t+1),s=[];for(let o=0;o<n;o++){let i=e.slice(o*t,o*t+t);s.push(i)}return s}}const jU=new Qt,qU=new Qt,$U=new Qt,eQ=new Qt,tQ=new Qt,iQ=new Qt,nQ=new Qt,sQ=new Qt,oQ=new Qt,rQ=new Qt,aQ=new Qt,lQ=new Qt;new Qt;const gQ=new Qt,cQ=new Qt,dQ=new EC;function hQ(e,t,i){let n;return n=e.isVector3?e.distanceTo(t):oS(e,t),Math.ceil(n/i)}const uQ=[];function IQ(e,t,i,n){return function(e,t,i){i.copy(e).sub(t),i.normalize()}(e,t,n),n.cross(i).normalize(),n.cross(i).normalize(),n}const pQ=new Qt,mQ=new Qt,AQ=new Qt;function CQ(e,t,i,n,s){const o=IQ(e,t,n,mQ),r=IQ(i,t,n,AQ);s.copy(o).add(r).normalize();const a=pQ.copy(n).cross(s),l=r.dot(a)<0;return l&&s.negate(),{miter:s,isFlip:l}}const fQ=new Qt,bQ=new Qt,yQ=new Qt;class _Q extends JU{constructor(e){super(),__publicField(this,"isFatLineGeometry",!0),__publicField(this,"_segmentLines",((e,t,i,n,s,o,r,a,l,g,c,d,h,u,I,p,m)=>{let A=0,C=new bt,f=new bt,b=new bt;const y="square"===this.parameters.lineCap,_="round"===this.parameters.lineCap,v="bevel"===this.parameters.lineJoin,x="round"===this.parameters.lineJoin,B=[c[0],c[1]],w=[g[0],g[1]];let S=this.getFlatDirection(w,B),G=0;this._needsCounter&&(G=oS(c,g),this._flags.totalDistance+=G),this._flags.normal||(this._flags.normal=new bt,this._flags.normal=bS(S));let M,R,T,Z=-1;if(!this._flags.started)if(this._flags.started=!0,M=this._flags.totalDistance-G,T=this._flags.totalDistance,R=M-G,y){const l=new bt,d=new bt;l.addVectors(this._flags.normal,S),d.subVectors(this._flags.normal,S),r.push(d.x,d.y,0,-l.x,-l.y,0),e.push(g[0],g[1],g[2],g[0],g[1],g[2]);const m=[c[0]-g[0],c[1]-g[1],c[2]-g[2]];I.push(g[0]+m[0],g[1]+m[0],g[2]+m[0],g[0]+m[0],g[1]+m[0],g[2]+m[0]),p.push(c[0],c[1],c[2],c[0],c[1],c[2]),t.push(this._flags.totalDistance-G,0,this._flags.totalDistance-G,1),i.push(M,M),n.push(R,T,R,T),o.push(h,Z,h,Z),s.push(0,0),this.parameters.vertexColors&&a.push(u[0],u[1],u[2],u[3],u[0],u[1],u[2],u[3])}else if(_){const d=S.clone();d.negate();const C=new bt;C.subVectors(this._flags.normal,S),C.normalize();const f=new bt;f.addVectors(this._flags.normal,S),f.normalize();const b=this._flags.normal.clone(),y=this._flags.normal.clone();y.negate(),r.push(d.x,d.y,0),r.push(C.x,C.y,0),r.push(-f.x,-f.y,0),r.push(b.x,b.y,0),r.push(y.x,y.y,0);const _=[c[0]-g[0],c[1]-g[1],c[2]-g[2]];for(let r=0;r<5;r++)e.push(g[0],g[1],g[2]),I.push(g[0]+_[0],g[1]+_[1],g[2]+_[2]),p.push(c[0],c[1],c[2]),o.push(h,Z),t.push(this._flags.totalDistance-G,0),i.push(M),n.push(R,T),s.push(0),this.parameters.vertexColors&&a.push(u[0],u[1],u[2],u[3]);l.push(m+0,m+2,m+1,m+1,m+2,m+3,m+3,m+2,m+4),A+=3,m+=3}else this._extrusions(e,r,t,i,n,s,o,a,g,g,c,this._flags.normal,M,R,T,h,Z,!0,u,I,p);if(l.push(...-1===this._flags.lastFlip?[m+0,m+1,m+2]:[m+1,m+0,m+2]),M=this._flags.totalDistance,R=this._flags.totalDistance-G,d){T=M+oS(c,d)}else T=M+G;if(d){const y=[d[0],d[1]];f=this.getFlatDirection(B,y),b.addVectors(S,f),b.normalize();const _=yS(S,f),w=bS(S),G=h/_.dot(w);let V=b.dot(this._flags.normal)>0?-1:1,W=v;if(!W&&"miter"===this.parameters.lineJoin){Math.abs(G)>(this.parameters.miterLimit||2*h)&&(W=!0)}if(W){const b=Math.min(2*h,Math.abs(G));r.push(this._flags.normal.x*V,this._flags.normal.y*V,0),r.push(-_.x*V,-_.y*V,0),e.push(c[0],c[1],c[2],c[0],c[1],c[2]),I.push(g[0],g[1],g[2],g[0],g[1],g[2]),p.push(d[0],d[1],d[2],d[0],d[1],d[2]),o.push(h,1,b,1),i.push(M,M),n.push(R,T,R,T),s.push(0,0),l.push(...this._flags.lastFlip===-V?-1===this._flags.lastFlip?[m+2,m+1,m+3]:[m+1,m+2,m+3]:-1===this._flags.lastFlip?[m+0,m+2,m+3]:[m+2,m+0,m+3]),C=bS(f),this._flags.normal.copy(C),r.push(this._flags.normal.x*V,this._flags.normal.y*V,0),e.push(c[0],c[1],c[2]),I.push(g[0],g[1],g[2]),p.push(d[0],d[1],d[2]),o.push(h,1),i.push(M),n.push(R,T),s.push(0),r.push(-_.x*V,-_.y*V,0),e.push(c[0],c[1],c[2]),I.push(g[0],g[1],g[2]),p.push(d[0],d[1],d[2]),o.push(b,Z),i.push(M),n.push(R,T),s.push(0),r.push(this._flags.normal.x*V,this._flags.normal.y*V,0),e.push(c[0],c[1],c[2]),I.push(g[0],g[1],g[2]),p.push(d[0],d[1],d[2]),o.push(h,Z),i.push(M),n.push(R,T),s.push(0),l.push(...1===V?[m+2,m+3,m+4]:[m+3,m+2,m+4]),this._flipedUV(t,this._flags.totalDistance,V,!0),this.parameters.vertexColors&&a.push(u[0],u[1],u[2],u[3],u[0],u[1],u[2],u[3],u[0],u[1],u[2],u[3],u[0],u[1],u[2],u[3],u[0],u[1],u[2],u[3]),A+=5}else if(x){const b=Math.min(2*h,Math.abs(G));r.push(this._flags.normal.x*V,this._flags.normal.y*V,0),e.push(c[0],c[1],c[2]),I.push(g[0],g[1],g[2]),p.push(d[0],d[1],d[2]),o.push(h,1),i.push(M),n.push(R,T),s.push(0),r.push(_.x*V,_.y*V,0),e.push(c[0],c[1],c[2]),I.push(g[0],g[1],g[2]),p.push(d[0],d[1],d[2]),o.push(h,1),i.push(M),n.push(R,T),s.push(0),r.push(_.x*V,_.y*V,0),e.push(c[0],c[1],c[2]),I.push(g[0],g[1],g[2]),p.push(d[0],d[1],d[2]),o.push(h,Z),i.push(M),n.push(R,T),s.push(0),r.push(-_.x*V,-_.y*V,0),e.push(c[0],c[1],c[2]),I.push(g[0],g[1],g[2]),p.push(d[0],d[1],d[2]),o.push(b,1),i.push(M),n.push(R,T),s.push(0),r.push(-_.x*V,-_.y*V,0),e.push(c[0],c[1],c[2]),I.push(g[0],g[1],g[2]),p.push(d[0],d[1],d[2]),o.push(b,Z),i.push(M),n.push(R,T),s.push(0),l.push(...this._flags.lastFlip===-V?-1===this._flags.lastFlip?[m+2,m+1,m+5,m+2,m+5,m+3]:[m+1,m+2,m+5,m+5,m+2,m+3]:-1===this._flags.lastFlip?[m+0,m+2,m+5,m+2,m+3,m+5]:[m+2,m+0,m+5,m+3,m+2,m+5]),C=bS(f),this._flags.normal.copy(C),r.push(this._flags.normal.x*V,this._flags.normal.y*V,0),e.push(c[0],c[1],c[2]),I.push(g[0],g[1],g[2]),p.push(d[0],d[1],d[2]),o.push(h,Z),i.push(M),n.push(R,T),s.push(0),l.push(...-1===V?[m+6,m+4,m+7]:[m+4,m+6,m+7]),this._flipedUV(t,this._flags.totalDistance,V,!1),this.parameters.vertexColors&&a.push(u[0],u[1],u[2],u[3],u[0],u[1],u[2],u[3],u[0],u[1],u[2],u[3],u[0],u[1],u[2],u[3],u[0],u[1],u[2],u[3],u[0],u[1],u[2],u[3]),A+=6}else this._extrusions(e,r,t,i,n,s,o,a,c,g,d,_,M,R,T,G,1,!1,u,I,p),this._extrusions(e,r,t,i,n,s,o,a,c,g,d,_,M,R,T,G,Z,!1,u,I,p),l.push(...-1===this._flags.lastFlip?[m+2,m+1,m+3]:[m+2,m+0,m+3]),V=-1,this._flags.normal.copy(_),A+=4;this._flags.lastFlip=V}else{if(this._flags.normal=bS(S),y){const l=new bt,d=new bt;l.addVectors(S,this._flags.normal),d.subVectors(S,this._flags.normal),r.push(l.x,l.y,0,d.x,d.y,0),e.push(c[0],c[1],c[2],c[0],c[1],c[2]),I.push(g[0],g[1],g[2],g[0],g[1],g[2]);const m=[c[0]-g[0],c[1]-g[1],c[2]-g[2]];p.push(c[0]+m[0],c[1]+m[1],c[2]+m[2],c[0]+m[0],c[1]+m[1],c[2]+m[2]),o.push(h,1,h,1),t.push(this._flags.totalDistance,0,this._flags.totalDistance,1),i.push(M,M),n.push(R,T,R,T),s.push(0,0),this.parameters.vertexColors&&a.push(u[0],u[1],u[2],u[3],u[0],u[1],u[2],u[3])}else this._extrusions(e,r,t,i,n,s,o,a,c,g,d,this._flags.normal,M,R,T,h,1,!1,u,I,p);if(l.push(...-1===this._flags.lastFlip?[m+2,m+1,m+3]:[m+2,m+0,m+3]),A+=2,_){const d=new bt;d.addVectors(S,this._flags.normal),d.normalize();const C=new bt;C.subVectors(S,this._flags.normal),C.normalize();const f=S.clone();r.push(d.x,d.y,0),r.push(C.x,C.y,0),r.push(f.x,f.y,0);const b=c[0]+(c[0]-g[0]),y=c[1]+(c[1]-g[1]),_=c[2]+(c[2]-g[2]);for(let r=0;r<3;r++)e.push(c[0],c[1],c[2]),I.push(g[0],g[1],g[2]),p.push(b,y,_),o.push(h,1),t.push(this._flags.totalDistance,0),i.push(M),n.push(R,T,R,T),s.push(0),this.parameters.vertexColors&&a.push(u[0],u[1],u[2],u[3]);l.push(m+2,m+3,m+4,m+4,m+3,m+5,m+4,m+5,m+6),A+=3}}return A})),__publicField(this,"_extrusions",((e,t,i,n,s,o,r,a,l,g,c,d,h,u,I,p,m,A,C,f,b)=>{if(t.push(d.x,d.y,0,-d.x,-d.y,0),e.push(l[0],l[1],l[2],l[0],l[1],l[2]),A){const e=[c[0]-l[0],c[1]-l[1],c[2]-l[2]];f.push(g[0]-e[0],g[1]-e[1],g[2]-e[2],g[0]-e[0],g[1]-e[1],g[2]-e[2])}else f.push(g[0],g[1],g[2],g[0],g[1],g[2]);if(c)b.push(c[0],c[1],c[2],c[0],c[1],c[2]);else{const e=[l[0]-g[0],l[1]-g[1],l[2]-g[2]];b.push(l[0]+e[0],l[1]+e[1],l[2]+e[2],l[0]+e[0],l[1]+e[1],l[2]+e[2])}r.push(p,m,p,m),i.push(h,0,h,1),n.push(h,h),s.push(u,I,u,I),o.push(0,0),this.parameters.vertexColors&&a.push(C[0],C[1],C[2],C[3],C[0],C[1],C[2],C[3])})),this.parameters=e,this._granularity=e.granularity||Km.RADIANS_PER_DEGREE,this._needsUpdate=!1,this._needsCounter=!1,this._height=e.height||0,this._flags={lastFlip:-1,started:!1,normal:null,totalDistance:0}}setData(e){this._needsUpdate=!0,this.cachedData=e,(this.parameters.dashed||this.parameters.enableAnimation||this.parameters.mapSrc||this.parameters.map)&&(this._needsCounter=!0),this.updateGeometry(),this._needsUpdate=!1}updateGeometryColumbus(e){const t=[],i=[],n=[],s=[],o=[],r=[],a=[],l=[],g=[],c=[],d=[],h=[],u=[],I=[];let p=0;for(let m=0;m<e.position.length;m++){const A=gS(e.position[m]),C=e.index[m],f=this.parameters.vertexWidths?e.lineWidth[m]:this.parameters.lineWidth,b=this.parameters.vertexColors?cy(e.color[m]):[1,1,1,1];this._flags={lastFlip:-1,started:!1,normal:null,totalDistance:0};const y=A.length;let _=t.length/3,v=Math.random();d.push(v,v),n.push(0,0),h.push(C,C);for(let e=1;e<y;e++){const m=A[e-1],x=A[e],B=e<y-1?A[e+1]:null,w=this._segmentLines(t,i,r,a,c,o,g,l,s,m,x,B,f,b,u,I,_);-1!==w&&(_+=w);for(let t=0;t<w;t++)n.push(e/y),this._needsCounter&&this.parameters.enableAnimationChaos&&d.push(v),h.push(C);p=Math.max(this._flags.totalDistance,p)}if(this._needsCounter)for(let e=0;e<c.length;e++)c[e]=p}this.cachedPositions=t,this.cachedPrevs=u,this.cachedNexts=I,this.setAttribute("position",new Mn(t,3)),this.setAttribute("prev",new Mn(u,3)),this.setAttribute("next",new Mn(I,3)),this.setAttribute("uv",new Mn(i,2)),this.setAttribute("normal",new Mn(g,3)),this.setAttribute("expandAndPrev",new Mn(o,2)),this.setAttribute("counter",new Mn(n,1)),this.setAttribute("objectIndex",new Mn(h,1)),this._needsCounter&&(this.setAttribute("lengths",new Mn(r,1)),this.setAttribute("totalLength",new Mn(c,1)),this.setAttribute("prevAndNextLength",new Mn(a,2)),this.setAttribute("randomFactor",new Mn(d,1))),this.parameters.vertexColors&&this.setAttribute("aColor",new Mn(l,4)),this.setIndex(s),this.computeBoundingSphere()}updateGeometry3D(e){const t=[],i=[],n=[],s=[],o=[],r=[],a=[],l=[],g=[],c=[],d=[],h=[],u=this._granularity,I=this.engine.map.map.ellipsoid||eA.WGS84,p=Km.chordLength(u,I.maximumRadius);let m=0;const A=this.parameters.vertexColors;let C,f=0;for(let b=0,y=e.position.length;b<y;b++){const u=[];let C=gS(e.position[b]);const y=e.index[b],_=this.parameters.vertexWidths?e.lineWidth[b]:this.parameters.lineWidth,v=this.parameters.vertexColors?cy(e.color[b]):[1,1,1,1],x=RU(C,I).map((e=>e+this._height)),{positions:B,normals:w,lengths:S,randoms:G,totalLength:M,prevs:R,nexts:T,expandAndPrevs:Z,prevAndNextLengths:V,uvs:W}=this.generateArc({positions:C,indices:n,minDistance:p,ellipsoid:I,height:x,width:_,bevelIndices:u});f=Math.max(f,M);const E=B.length/3;for(let e=0;e<E;e+=4){n.push(m+e,m+e+1,m+e+2),n.push(m+e+2,m+e+1,m+e+3);const t=e+4;u.includes(t)&&(n.push(m+e+2,m+e+3,m+t),e++)}m+=E,t.push(...B),r.push(...w),c.push(...R),g.push(...T),i.push(...W),h.push(...V),d.push(...Z),l.push(...new Array(S.length).fill(y)),A&&o.push(...new Array(S.length).fill(v).flat()),this._needsCounter&&(s.push(...S),this.parameters.enableAnimationChaos&&a.push(...G))}this._needsCounter&&(C=new Array(t.length/3).fill(f)),this.cachedPositions=t,this.setAttribute("position",new Mn(t,3)),this.setAttribute("prev",new Mn(c,3)),this.setAttribute("next",new Mn(g,3)),this.setAttribute("expandAndPrev",new Mn(d,2)),this.setAttribute("normal",new Mn(r,3)),this.setAttribute("objectIndex",new Mn(l,1)),this.setAttribute("uv",new Mn(i,2)),this.setAttribute("prevAndNextLength",new Mn(h,2)),A&&this.setAttribute("aColor",new Mn(o,4)),this._needsCounter&&this.setAttribute("totalLength",new Mn(C,1)),this.setIndex(n)}updateGeometry(){const e=this.cachedData;this.engine.map.isGlobe?this.updateGeometry3D(e):this.updateGeometryColumbus(e)}getFlatDirection(e,t){return sS(e,t)?this._flags.normal?new bt(this._flags.normal.y,-this._flags.normal.x):new bt(1,0):rS(e,t)}generateArc(e){e||(e={});const t=e.positions,i=e.indices,n=e.bevelIndices||[],s=t.length,o=e.ellipsoid||eA.WGS84,r=e.width||1;let a=e.height||0;const l=Array.isArray(a);if(s<1)return[];if(1===s){const e=o.scaleToGeodeticSurface(t[0],jU);if(a=l?a[0]:a,0!==a){const t=o.geodeticSurfaceNormal(e,nQ);jm.multiplyByScalar(t,a,t),jm.add(e,t,e)}return[e.x,e.y,e.z]}let g=e.minDistance;am(g)||(g=Km.chordLength(this._granularity,o.maximumRadius));let c=0;for(let N=0;N<s-1;N++)c+=hQ(t[N],t[N+1],g);const d=2*c+(s-2),h=d,u=2*d,I=3*d,p=new Array(I),m=new Array(I),A=new Array(h),C=new Array(h),f=new Array(I),b=new Array(I),y=new Array(u),_=new Array(u),v=new Array(u),x=new Array(h);let B=0,w=0;const S=new Qt,G=new Qt;let M;const R={lastFlip:!1,curFlip:!1},T={last:0,next:0},Z=new Qt,V=new Qt;let W;for(let N=0;N<s-1;N++){if(fQ.fromArray(t[N]),bQ.fromArray(t[N+1]),S.crossVectors(fQ,bQ).normalize(),N<s-2){eA.WGS84.geodeticSurfaceNormal(bQ,Z),yQ.fromArray(t[N+2]),G.crossVectors(bQ,yQ).normalize();const{isFlip:e}=CQ(fQ,bQ,yQ,Z,V);W=V,R.curFlip=!e}else W=S;const e=M||S;T.last=Math.min(2*r,r/e.dot(S)),T.next=Math.min(2*r,Math.abs(r/W.dot(S)));const i=l?a[N]:a,c=l?a[N+1]:a,d=N<s-2,h=this.generateCartesianArc(fQ,bQ,g,o,i,c,p,f,b,B,S,G,W,e,T,R,m,r,A,y,w,d,n,_,x);B=h.index;w+=h.surfaceDistance,M||(M=lQ),W&&M.copy(W),R.lastFlip=R.curFlip}const E=Math.random();C.fill(E);for(let N=0;N<x.length;N++){let e,t,i=N-1;for(;i>=0&&x[i]===x[N];)i--;let n=N+1;for(;n<x.length&&x[n]===x[N];)n++;e=i<0?0:A[i],t=n>=x.length?A[A.length-1]:A[n],v[2*N]=e,v[2*N+1]=t}return{positions:p,normals:m,lengths:A,randoms:C,totalLength:w,prevs:f,nexts:b,expandAndPrevs:y,prevAndNextLengths:v,uvs:_,indices:i}}generateCartesianArc(e,t,i,n,s,o,r,a,l,g,c,d,h,u,I,p,m,A,C,f,b,y,_,v,x){const B=n.scaleToGeodeticSurface(e,jU),w=n.scaleToGeodeticSurface(t,qU),S=hQ(e,t,i),G=n.cartesianToCartographic(B,$U),M=n.cartesianToCartographic(w,eQ),R=((e,t,i)=>{const n=uQ;n.length=e;let s=0;if(t===i){for(s=0;s<e;s++)n[s]=t;return n}const o=(i-t)/e;for(let r=0;r<e;r++){const e=t+r*o;n[r]=e}return n})(S,s,o),{lastFlip:T,curFlip:Z}=p;dQ.setEndPoints(G,M);const V=dQ.surfaceDistance/S;let W=g;G.z=s,M.z=o;const E=gQ.copy(c).negate(),N=u?cQ.copy(u).negate():void 0,F=I.last,X=I.next;let H=c,z=E,L=A,D=A;T?(z=N,D=F):(H=u||c,L=F);let K,Y=W/3,P=n.cartographicToCartesian(G,nQ);if(P.toArray(r,W),H.toArray(m,W),C[Y]=b,v[2*Y]=b,v[2*Y+1]=0,f[2*Y]=L,f[2*Y+1]=-1,x[Y]=1,W+=3,Y=W/3,P.toArray(r,W),z.toArray(m,W),f[2*Y]=D,f[2*Y+1]=-1,C[Y]=b,v[2*Y]=b,v[2*Y+1]=1,x[Y]=1,W+=3,S>1){const e=dQ.interpolateUsingSurfaceDistance(V,iQ);e.z=R[1],n.cartographicToCartesian(e,sQ)}else n.cartographicToCartesian(M,sQ);oQ.subVectors(nQ,sQ),oQ.add(nQ),oQ.toArray(a,g),oQ.toArray(a,g+3),sQ.toArray(l,g),sQ.toArray(l,g+3);for(let U=1;U<S;U++)K?tQ.copy(iQ):dQ.interpolateUsingSurfaceDistance(U*V,tQ),S===U+1?K=M:(K=dQ.interpolateUsingSurfaceDistance((U+1)*V,iQ),K.z=R[U+1]),tQ.z=R[U],rQ.copy(nQ),P=n.cartographicToCartesian(tQ,nQ),n.cartographicToCartesian(K,aQ),Y=W/3,P.toArray(r,W),c.toArray(m,W),f[2*Y]=A,f[2*Y+1]=1,rQ.toArray(a,W),aQ.toArray(l,W),C[Y]=b+U*V,v[2*Y]=b+U*V,v[2*Y+1]=0,x[Y]=-1,W+=3,Y=W/3,P.toArray(r,W),E.toArray(m,W),f[2*Y]=A,f[2*Y+1]=1,rQ.toArray(a,W),aQ.toArray(l,W),C[Y]=b+U*V,v[2*Y]=b+U*V,v[2*Y+1]=1,x[Y]=-1,W+=3,Y=W/3,P.toArray(r,W),c.toArray(m,W),f[2*Y]=A,f[2*Y+1]=-1,rQ.toArray(a,W),aQ.toArray(l,W),C[Y]=b+U*V,v[2*Y]=b+U*V,v[2*Y+1]=0,x[Y]=1,W+=3,Y=W/3,P.toArray(r,W),E.toArray(m,W),f[2*Y]=A,f[2*Y+1]=-1,rQ.toArray(a,W),aQ.toArray(l,W),C[Y]=b+U*V,v[2*Y]=b+U*V,v[2*Y+1]=1,x[Y]=1,W+=3;const k=dQ.surfaceDistance;oQ.subVectors(nQ,aQ),oQ.add(nQ),n.cartographicToCartesian(M,sQ);const O=h?cQ.copy(h).negate():void 0;return H=c,z=E,L=A,D=A,y&&(Z?(z=O||c,D=X):(H=h||c,L=X)),Y=W/3,sQ.toArray(r,W),H.toArray(m,W),C[Y]=b+k,f[2*Y]=L,f[2*Y+1]=1,v[2*Y]=b+k,v[2*Y+1]=0,nQ.toArray(a,W),oQ.toArray(l,W),x[Y]=-1,W+=3,Y=W/3,sQ.toArray(r,W),z.toArray(m,W),C[Y]=b+k,f[2*Y]=D,f[2*Y+1]=1,nQ.toArray(a,W),oQ.toArray(l,W),v[2*Y]=b+k,v[2*Y+1]=1,x[Y]=-1,W+=3,y&&(Y=W/3,_.push(Y),sQ.toArray(r,W),Z?d.toArray(m,W):gQ.copy(d).negate().toArray(m,W),C[Y]=b+k,f[2*Y]=A,f[2*Y+1]=1,v[2*Y]=b+k,v[2*Y+1]=1,x[Y]=-1,nQ.toArray(a,W),oQ.toArray(l,W),W+=3),{index:W,surfaceDistance:k,lastLength:V}}_flipedUV(e,t,i,n){n?-1===i?e.push(t,1,t,0,t,1,t,0,t,1):e.push(t,0,t,1,t,0,t,1,t,0):-1===i?e.push(t,1,t,1,t,1,t,0,t,0,t,1):e.push(t,0,t,0,t,0,t,1,t,1,t,0)}get needsUpdate(){return this._needsUpdate}set needsUpdate(e){this._needsUpdate=e}}new Qt,new Qt;const vQ=new Bi,xQ=new xi,BQ=new mi,wQ=new Bi;const SQ=new Qt,GQ=new Qt,MQ=new Qt,RQ=new Qt,TQ=new Qt;new Qt;const ZQ=new Qt,VQ=new Qt,WQ=new Qt,EQ=[],NQ=(e,t,i,n)=>(jm.subtract(t,e,SQ),jm.multiplyByScalar(SQ,i/n,SQ),jm.add(e,SQ,SQ),[SQ.x,SQ.y,SQ.z]),FQ=[],XQ=(e,t,i)=>{const n=e.distanceTo(t);return Math.ceil(n/i)};class HQ extends Fn{constructor(e){super(),__publicField(this,"isWallGeometry",!0),__publicField(this,"_needsUpdate",!1),__publicField(this,"isClockWise",(e=>{let t=e.length,i=0;for(let n=t-1,s=0;s<t;n=s++)i+=e[n][0]*e[s][1]-e[s][0]*e[n][1];return i<0})),__publicField(this,"subdivideLine",((e,t,i,n,s,o)=>{const r=XQ(e,t,i),a=e.distanceTo(t),l=a/r;s||(s=[]),o||(o=[]);const g=new Qt,c=new Qt,d=n.cartesianToCartographic(e,c).z,h=n.cartesianToCartographic(t,c).z,u=((e,t,i)=>{const n=FQ;n.length=e;let s=0;if(t===i){for(s=0;s<e;s++)n[s]=t;return n}const o=(i-t)/e;for(let r=0;r<e;r++){const e=t+r*o;n[r]=e}return n})(r,d,h),I=RQ;let p=TQ,m=ZQ,A=0;for(let C=0;C<r;C++){const i=g.fromArray(NQ(e,t,l*C,a));n.geodeticSurfaceNormal(i,I),m=n.scaleToGeodeticSurface(i,m),p=jm.multiplyByScalar(I,u[C],p),p=jm.add(m,p,p),o[A]=p.x,o[A+1]=p.y,o[A+2]=p.z,p=jm.multiplyByScalar(I,u[C]+this._height,p),p=jm.add(m,p,p),s[A]=p.x,s[A+1]=p.y,s[A+2]=p.z,A+=3}return n.geodeticSurfaceNormal(t,I),m=n.scaleToGeodeticSurface(t,m),p=jm.multiplyByScalar(I,h,p),p=jm.add(m,p,p),o[A]=p.x,o[A+1]=p.y,o[A+2]=p.z,p=jm.multiplyByScalar(I,h+this._height,p),p=jm.add(m,p,p),s[A]=p.x,s[A+1]=p.y,s[A+2]=p.z,{topPositions:s,bottomPositions:o}})),this._height=e.height||100,this.parameters=e}setData(e){this._needsUpdate=!0,this.cachedData=e,this.updateGeometry()}computeWallGeometry3D(e,t,i,n){let s,o,r,a,l,g=e.length;const c=Km.chordLength(i,t.maximumRadius);let d=0;for(r=0;r<g-1;r++)d+=XQ(e[r],e[(r+1)%g],c);const h=d+g-1;o=3*h,s=new Array(2*o);const u=[],I=[];for(r=0;r<g-1;r++){a=e[r],l=e[(r+1)%g];const{topPositions:i,bottomPositions:n}=this.subdivideLine(a,l,c,t);u.push(...n),I.push(...i)}s=[...u,...u],g=s.length;let p=[],m=0;for(g/=6,r=0;r<g-1;r++){const e=r,t=e+1,i=e+g,o=i+1;a=GQ.fromArray(s,3*e),l=MQ.fromArray(s,3*t),jm.equalsEpsilon(a,l,Km.EPSILON10,Km.EPSILON10)||(p[m++]=e+n,p[m++]=i+n,p[m++]=t+n,p[m++]=t+n,p[m++]=i+n,p[m++]=o+n)}s=[...I,...u],g=I.length/3;const A=[];A.length=s.length;const C=[];C.length=4*g;let f=new Qt,b=new Qt,y=new Qt;new Qt;let _=!0,v=new Qt;const x=[];let B=0;for(r=0;r<h;r++){f.fromArray(I,3*r),y.fromArray(I,3*(r+1));let e=2*r,t=2*(r+o/3);void 0!==y.x?(x.push(f.distanceTo(y)),C[e]=B,C[e+1]=1,C[t]=B,C[t+1]=0,B+=x[r]):(C[e]=B,C[e+1]=1,C[t]=B,C[t+1]=0)}for(r=0;r<h;r++){if(f.fromArray(I,3*r),b.fromArray(u,3*r),y.fromArray(I,3*(r+1)),(jm.equalsEpsilon(f,y,Km.EPSILON10)||r===h-1)&&(_=!1),_){const e=jm.subtract(y,f,WQ),t=jm.subtract(b,f,VQ);v=jm.normalize(jm.cross(t,e,v),v),x.push(f.distanceTo(y))}let e=3*r,t=3*r+o;A[e]=v.x,A[e+1]=v.y,A[e+2]=v.z,A[t]=v.x,A[t+1]=v.y,A[t+2]=v.z,_=!0}return{edgePositions:s,edgeIndices:p,edgeNormals:A,edgeUvs:C,totalDistance:Array.from({length:2*h},(()=>B))}}updateGeometry3D(){let e=this.cachedData;const t=this.engine.map.map.ellipsoid||eA.WGS84,i=[],n=[],s=[],o=[],r=[];let a=0,l=0,g=e.position.length;for(a=0;a<g;a++){const g=e.position[a];!this.parameters.vertexColors||cy(e.color[a]);const c=g.map((e=>(new Qt).fromArray(e)));let d=Z_.fromPoints(c,t).projectPointsOntoPlane(c,EQ);this.isClockWise(d.map((e=>e.toArray())))&&c.reverse();const h=Km.RADIANS_PER_DEGREE,{edgePositions:u,edgeIndices:I,edgeNormals:p,edgeUvs:m,totalDistance:A}=this.computeWallGeometry3D(c,t,h,l);i.push(...u),n.push(...I),s.push(...p),o.push(...m),r.push(...A),l+=u.length/3}this.cachedPositions=i,this.setAttribute("position",new Mn(i,3)),this.setAttribute("normal",new Mn(s,3)),this.setAttribute("uv",new Mn(o,2)),this.setAttribute("totalDistance",new Mn(r,1)),this.setIndex(n)}updateGeometryColumbus(){let e=this.cachedData;const t=[],i=[],n=[],s=[],o=[],r=[],a=[];for(let l=0;l<e.position.length;l++){const g=e.position[l];e.index[l];const c=this.parameters.vertexColors?cy(e.color[l]):[1,1,1,1],d=this.parameters.vertexHeights?e.height[l]:this._height;let h=0;const u=g.length;let I=t.length/3;for(let e=0;e<u;e++){const a=g[e],l=[g[e][0],g[e][1],g[e][2]+d],p=e<u-1?g[e+1]:null;if((!p||!sS(a,p))&&(t.push(...a,...l),r.push(...c,...c),n.push(e/(u-1),e/(u-1)),o.push(h,h),i.push(h,0,h,1),e<u-1)){h+=oS(a,p);let t=I+2*e;s.push(t+1,t+2,t,t+3,t+2,t+1)}}for(let e=0;e<u;e++)a.push(h,h);I+=2*u}this.cachedPositions=t,this.setAttribute("position",new Mn(t,3)),this.setAttribute("uv",new Mn(i,2)),this.setAttribute("counter",new Mn(n,1)),this.setAttribute("distances",new Mn(o,1)),this.setAttribute("totalDistance",new Mn(a,1)),this.parameters.vertexColors&&this.setAttribute("aColor",new Mn(r,4)),this.setIndex(s)}updateGeometry(){this.engine.map.isGlobe?this.updateGeometry3D():this.updateGeometryColumbus(),this.computeBoundingSphere(),this._needsUpdate=!1}get needsUpdate(){return this._needsUpdate}set needsUpdate(e){this._needsUpdate=e}get height(){return this._height}set height(e){this._height=e}}const zQ=new Dl,LQ=as.merge([ws.fog,Ay,my,{map:{value:null},mapScale:{value:[1,1]},useMap:{value:!1},color:{value:[0,1,1]},minOpacity:{value:0},maxOpacity:{value:1},opacity:{value:1},vertexColors:{value:!1},elapsedTime:{value:0},enableAnimation:{value:!1},animationSpeed:{value:1},animationTailType:{value:3},animationTailRatio:{value:.2},animationTailLength:{value:100},animationIdle:{value:1e3},animationRatio:{value:.5},animationBales:{value:5},isEmissive:{value:!1}}]);class DQ extends mx{constructor(e){super(),this.name="WallMaterial",this.isWallMaterial=!0,this.fog=!0,this.side=2,this.forceSinglePass=!1,this.fragmentShader="#define GLSLIFY 1\n#include <common>\n#include <bsdfs>\n#include <fog_pars_fragment>\n\n#include <logdepthbuf_pars_fragment>\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n\nuniform sampler2D map;\nuniform bool useMap;\nuniform float minOpacity;\nuniform float maxOpacity;\nuniform float opacity;\nuniform float elapsedTime;\n\nvarying vec2 vUV;\nvarying vec4 vColor;\nvarying float vCounter;\nvarying float vDistance;\nvarying float vTotalDistance;\n\n#ifdef USE_ANIMATION\nuniform float animationRatio;\nuniform float animationBales;\nuniform float animationSpeed;\nvarying float vAnimationOpacity;\nvarying float vAnimationTailType;\n#endif\n\nvoid main() {\n\n    vec4 c = vColor;\n\n    if(useMap) {\n        vec4 texture = texture2D(map, vec2(vUV.x / vTotalDistance, vUV.y));\n        c *= texture;\n    }\n\n    #ifdef USE_ANIMATION\n        if (vAnimationOpacity > 1.0 || vAnimationOpacity < 0.0) {\n            c.a = 0.0;\n        }\n\n        if(vAnimationTailType == 4.) {\n            float ratio = animationRatio;\n            float bales = animationBales;\n            if(animationRatio > 1.) {\n                ratio = 1.;\n            }\n            if(animationRatio < .0) {\n                ratio = .0;\n            }\n            if(animationBales < 1.) {\n                bales = 1.;\n            }\n            if(mod((vUV.y - elapsedTime * animationSpeed * .0001), 1./bales) < ratio / bales) {\n                c.a = (1. - vUV.y) * maxOpacity;\n            } else {\n                c.a = minOpacity;\n            }\n        } else {\n            c.a *= vAnimationOpacity;\n        }\n    #endif\n\n    gl_FragColor = c;\n    gl_FragColor.a *= opacity;\n\n    if (maxOpacity > minOpacity) {\n        gl_FragColor.a = clamp(gl_FragColor.a, minOpacity, maxOpacity);\n    }\n    #ifdef OPAQUE\n        gl_FragColor.a = 1.0;\n    #endif\n\n    #include <fog_fragment>\n    #include <logdepthbuf_fragment>\n}",this.vertexShader="#define GLSLIFY 1\n#include <common>\n#include <bsdfs>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n\n#ifdef MVT_USE_VERTEX_COLOR\n    attribute vec4 aColor;\n#else\n    uniform vec3 color;\n#endif\n\nattribute float counter;\nattribute float totalDistance;\nattribute float distances;\n\nuniform float elapsedTime;\nuniform bool vertexColors;\n\nvarying vec2 vUV;\nvarying vec4 vColor;\nvarying float vCounter;\nvarying float vDistance;\nvarying float vTotalDistance;\n\nuniform vec2 mapScale;\n\n#ifdef USE_ANIMATION\nuniform float animationSpeed;\nuniform float animationTailType;\nvarying float vAnimationTailType;\nuniform float animationTailRatio;\nuniform float animationTailLength;\nuniform float animationIdle;\nvarying float vAnimationOpacity;\n#endif\n\nvoid main() {\n\n    #ifdef MVT_USE_VERTEX_COLOR\n        vColor = aColor;\n    #else\n        vColor = vec4(color, 1.0);\n    #endif\n\n    vUV = uv / mapScale;\n    vCounter = counter;\n    vDistance = distances;\n    vTotalDistance = totalDistance;\n\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\n    #ifdef USE_ANIMATION\n        if (animationTailType < 3.0) {\n            float tailLength = animationTailType == 1.0 ? totalDistance * animationTailRatio : animationTailLength;\n            float currentLength = mod(elapsedTime * animationSpeed, totalDistance + tailLength + animationIdle * animationSpeed);\n            vAnimationOpacity = (distances - (currentLength - tailLength)) / tailLength;\n        }\n        else if (animationTailType == 3.0) {\n            vAnimationOpacity = 1.0 - mod(elapsedTime * animationSpeed / 1000.0, 1.0) + uv.y;\n        } \n        else if (animationTailType == 4.0) {\n            vAnimationTailType = animationTailType;\n        }\n    #endif\n\n    #include <beginnormal_vertex>\n    vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n    #include <fog_vertex>\n\n    #include <logdepthbuf_vertex>\n}",Object.assign(this.uniforms,as.clone(LQ)),fy(this,["map","minOpacity","maxOpacity","opacity","elapsedTime","animationSpeed","animationTailType","animationTailRatio","animationTailLength","animationIdle","animationBales","animationRatio","isEmissive"]),by(this,["color"]),_y(this,[["vertexColors","MVT_USE_VERTEX_COLOR"],["enableAnimation","USE_ANIMATION"]]),By(this),Object.defineProperties(this,{mapSrc:{get:function(){return this.uniforms.map.value},set:function(e){const t=this.mapSrc,i="url_map";if(this.userData[i]===e)return;if(t&&t.dispose(),!e)return this.uniforms.map.value=null,this.uniforms.useMap.value=!1,void delete this.userData[i];const n=zQ.load(e);n.wrapS=n.wrapT=G,n.colorSpace=Ye,this.uniforms.map.value=n,this.userData[i]=e,this.uniforms.useMap.value=!0}},mapScale:{get:function(){return this.uniforms.map.value},set:function(e){this.uniforms.mapScale.value="number"==typeof e?[e,e]:e}}}),this.emissiveEnabled=!0,this.emissive=[0,0,0],this.setValues(e)}dispose(){this.uniforms.map.value&&this.uniforms.map.value.dispose(),super.dispose()}}var KQ={exports:{}};function YQ(e,t,i){i=i||2;var n,s,o,r,a,l,g,c=t&&t.length,d=c?t[0]*i:e.length,h=PQ(e,0,d,i,!0),u=[];if(!h||h.next===h.prev)return u;if(c&&(h=function(e,t,i,n){var s,o,r,a=[];for(s=0,o=t.length;s<o;s++)(r=PQ(e,t[s]*n,s<o-1?t[s+1]*n:e.length,n,!1))===r.next&&(r.steiner=!0),a.push(iJ(r));for(a.sort(qQ),s=0;s<a.length;s++)i=$Q(a[s],i);return i}(e,t,h,i)),e.length>80*i){n=o=e[0],s=r=e[1];for(var I=i;I<d;I+=i)(a=e[I])<n&&(n=a),(l=e[I+1])<s&&(s=l),a>o&&(o=a),l>r&&(r=l);g=0!==(g=Math.max(o-n,r-s))?32767/g:0}return OQ(h,u,i,n,s,g,0),u}function PQ(e,t,i,n,s){var o,r;if(s===pJ(e,t,i,n)>0)for(o=t;o<i;o+=n)r=hJ(o,e[o],e[o+1],r);else for(o=i-n;o>=t;o-=n)r=hJ(o,e[o],e[o+1],r);return r&&rJ(r,r.next)&&(uJ(r),r=r.next),r}function kQ(e,t){if(!e)return e;t||(t=e);var i,n=e;do{if(i=!1,n.steiner||!rJ(n,n.next)&&0!==oJ(n.prev,n,n.next))n=n.next;else{if(uJ(n),(n=t=n.prev)===n.next)break;i=!0}}while(i||n!==t);return t}function OQ(e,t,i,n,s,o,r){if(e){!r&&o&&function(e,t,i,n){var s=e;do{0===s.z&&(s.z=tJ(s.x,s.y,t,i,n)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==e);s.prevZ.nextZ=null,s.prevZ=null,function(e){var t,i,n,s,o,r,a,l,g=1;do{for(i=e,e=null,o=null,r=0;i;){for(r++,n=i,a=0,t=0;t<g&&(a++,n=n.nextZ);t++);for(l=g;a>0||l>0&&n;)0!==a&&(0===l||!n||i.z<=n.z)?(s=i,i=i.nextZ,a--):(s=n,n=n.nextZ,l--),o?o.nextZ=s:e=s,s.prevZ=o,o=s;i=n}o.nextZ=null,g*=2}while(r>1)}(s)}(e,n,s,o);for(var a,l,g=e;e.prev!==e.next;)if(a=e.prev,l=e.next,o?QQ(e,n,s,o):UQ(e))t.push(a.i/i|0),t.push(e.i/i|0),t.push(l.i/i|0),uJ(e),e=l.next,g=l.next;else if((e=l)===g){r?1===r?OQ(e=JQ(kQ(e),t,i),t,i,n,s,o,2):2===r&&jQ(e,t,i,n,s,o):OQ(kQ(e),t,i,n,s,o,1);break}}}function UQ(e){var t=e.prev,i=e,n=e.next;if(oJ(t,i,n)>=0)return!1;for(var s=t.x,o=i.x,r=n.x,a=t.y,l=i.y,g=n.y,c=s<o?s<r?s:r:o<r?o:r,d=a<l?a<g?a:g:l<g?l:g,h=s>o?s>r?s:r:o>r?o:r,u=a>l?a>g?a:g:l>g?l:g,I=n.next;I!==t;){if(I.x>=c&&I.x<=h&&I.y>=d&&I.y<=u&&nJ(s,a,o,l,r,g,I.x,I.y)&&oJ(I.prev,I,I.next)>=0)return!1;I=I.next}return!0}function QQ(e,t,i,n){var s=e.prev,o=e,r=e.next;if(oJ(s,o,r)>=0)return!1;for(var a=s.x,l=o.x,g=r.x,c=s.y,d=o.y,h=r.y,u=a<l?a<g?a:g:l<g?l:g,I=c<d?c<h?c:h:d<h?d:h,p=a>l?a>g?a:g:l>g?l:g,m=c>d?c>h?c:h:d>h?d:h,A=tJ(u,I,t,i,n),C=tJ(p,m,t,i,n),f=e.prevZ,b=e.nextZ;f&&f.z>=A&&b&&b.z<=C;){if(f.x>=u&&f.x<=p&&f.y>=I&&f.y<=m&&f!==s&&f!==r&&nJ(a,c,l,d,g,h,f.x,f.y)&&oJ(f.prev,f,f.next)>=0)return!1;if(f=f.prevZ,b.x>=u&&b.x<=p&&b.y>=I&&b.y<=m&&b!==s&&b!==r&&nJ(a,c,l,d,g,h,b.x,b.y)&&oJ(b.prev,b,b.next)>=0)return!1;b=b.nextZ}for(;f&&f.z>=A;){if(f.x>=u&&f.x<=p&&f.y>=I&&f.y<=m&&f!==s&&f!==r&&nJ(a,c,l,d,g,h,f.x,f.y)&&oJ(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;b&&b.z<=C;){if(b.x>=u&&b.x<=p&&b.y>=I&&b.y<=m&&b!==s&&b!==r&&nJ(a,c,l,d,g,h,b.x,b.y)&&oJ(b.prev,b,b.next)>=0)return!1;b=b.nextZ}return!0}function JQ(e,t,i){var n=e;do{var s=n.prev,o=n.next.next;!rJ(s,o)&&aJ(s,n,n.next,o)&&cJ(s,o)&&cJ(o,s)&&(t.push(s.i/i|0),t.push(n.i/i|0),t.push(o.i/i|0),uJ(n),uJ(n.next),n=e=o),n=n.next}while(n!==e);return kQ(n)}function jQ(e,t,i,n,s,o){var r=e;do{for(var a=r.next.next;a!==r.prev;){if(r.i!==a.i&&sJ(r,a)){var l=dJ(r,a);return r=kQ(r,r.next),l=kQ(l,l.next),OQ(r,t,i,n,s,o,0),void OQ(l,t,i,n,s,o,0)}a=a.next}r=r.next}while(r!==e)}function qQ(e,t){return e.x-t.x}function $Q(e,t){var i=function(e,t){var i,n=t,s=e.x,o=e.y,r=-1/0;do{if(o<=n.y&&o>=n.next.y&&n.next.y!==n.y){var a=n.x+(o-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(a<=s&&a>r&&(r=a,i=n.x<n.next.x?n:n.next,a===s))return i}n=n.next}while(n!==t);if(!i)return null;var l,g=i,c=i.x,d=i.y,h=1/0;n=i;do{s>=n.x&&n.x>=c&&s!==n.x&&nJ(o<d?s:r,o,c,d,o<d?r:s,o,n.x,n.y)&&(l=Math.abs(o-n.y)/(s-n.x),cJ(n,e)&&(l<h||l===h&&(n.x>i.x||n.x===i.x&&eJ(i,n)))&&(i=n,h=l)),n=n.next}while(n!==g);return i}(e,t);if(!i)return t;var n=dJ(i,e);return kQ(n,n.next),kQ(i,i.next)}function eJ(e,t){return oJ(e.prev,e,t.prev)<0&&oJ(t.next,e,e.next)<0}function tJ(e,t,i,n,s){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-i)*s|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*s|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function iJ(e){var t=e,i=e;do{(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next}while(t!==e);return i}function nJ(e,t,i,n,s,o,r,a){return(s-r)*(t-a)>=(e-r)*(o-a)&&(e-r)*(n-a)>=(i-r)*(t-a)&&(i-r)*(o-a)>=(s-r)*(n-a)}function sJ(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&aJ(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&(cJ(e,t)&&cJ(t,e)&&function(e,t){var i=e,n=!1,s=(e.x+t.x)/2,o=(e.y+t.y)/2;do{i.y>o!=i.next.y>o&&i.next.y!==i.y&&s<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==e);return n}(e,t)&&(oJ(e.prev,e,t.prev)||oJ(e,t.prev,t))||rJ(e,t)&&oJ(e.prev,e,e.next)>0&&oJ(t.prev,t,t.next)>0)}function oJ(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function rJ(e,t){return e.x===t.x&&e.y===t.y}function aJ(e,t,i,n){var s=gJ(oJ(e,t,i)),o=gJ(oJ(e,t,n)),r=gJ(oJ(i,n,e)),a=gJ(oJ(i,n,t));return s!==o&&r!==a||(!(0!==s||!lJ(e,i,t))||(!(0!==o||!lJ(e,n,t))||(!(0!==r||!lJ(i,e,n))||!(0!==a||!lJ(i,t,n)))))}function lJ(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}function gJ(e){return e>0?1:e<0?-1:0}function cJ(e,t){return oJ(e.prev,e,e.next)<0?oJ(e,t,e.next)>=0&&oJ(e,e.prev,t)>=0:oJ(e,t,e.prev)<0||oJ(e,e.next,t)<0}function dJ(e,t){var i=new IJ(e.i,e.x,e.y),n=new IJ(t.i,t.x,t.y),s=e.next,o=t.prev;return e.next=t,t.prev=e,i.next=s,s.prev=i,n.next=i,i.prev=n,o.next=n,n.prev=o,n}function hJ(e,t,i,n){var s=new IJ(e,t,i);return n?(s.next=n.next,s.prev=n,n.next.prev=s,n.next=s):(s.prev=s,s.next=s),s}function uJ(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function IJ(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function pJ(e,t,i,n){for(var s=0,o=t,r=i-n;o<i;o+=n)s+=(e[r]-e[o])*(e[o+1]+e[r+1]),r=o;return s}function mJ(e,t,i,n,s){for(var o=s+1;n<=s;){var r=n+s>>>1,a=e[r];(void 0!==i?i(a,t):a-t)>=0?(o=r,s=r-1):n=r+1}return o}function AJ(e,t,i,n,s){for(var o=s+1;n<=s;){var r=n+s>>>1,a=e[r];(void 0!==i?i(a,t):a-t)>0?(o=r,s=r-1):n=r+1}return o}function CJ(e,t,i,n,s){for(var o=n-1;n<=s;){var r=n+s>>>1,a=e[r];(void 0!==i?i(a,t):a-t)<0?(o=r,n=r+1):s=r-1}return o}function fJ(e,t,i,n,s){for(var o=n-1;n<=s;){var r=n+s>>>1,a=e[r];(void 0!==i?i(a,t):a-t)<=0?(o=r,n=r+1):s=r-1}return o}function bJ(e,t,i,n,s){for(;n<=s;){var o=n+s>>>1,r=e[o],a=void 0!==i?i(r,t):r-t;if(0===a)return o;a<=0?n=o+1:s=o-1}return-1}function yJ(e,t,i,n,s,o){return"function"==typeof i?o(e,t,i,void 0===n?0:0|n,void 0===s?e.length-1:0|s):o(e,t,void 0,void 0===i?0:0|i,void 0===n?e.length-1:0|n)}KQ.exports=YQ,KQ.exports.default=YQ,YQ.deviation=function(e,t,i,n){var s=t&&t.length,o=s?t[0]*i:e.length,r=Math.abs(pJ(e,0,o,i));if(s)for(var a=0,l=t.length;a<l;a++){var g=t[a]*i,c=a<l-1?t[a+1]*i:e.length;r-=Math.abs(pJ(e,g,c,i))}var d=0;for(a=0;a<n.length;a+=3){var h=n[a]*i,u=n[a+1]*i,I=n[a+2]*i;d+=Math.abs((e[h]-e[I])*(e[u+1]-e[h+1])-(e[h]-e[u])*(e[I+1]-e[h+1]))}return 0===r&&0===d?0:Math.abs((d-r)/r)},YQ.flatten=function(e){for(var t=e[0][0].length,i={vertices:[],holes:[],dimensions:t},n=0,s=0;s<e.length;s++){for(var o=0;o<e[s].length;o++)for(var r=0;r<t;r++)i.vertices.push(e[s][o][r]);s>0&&(n+=e[s-1].length,i.holes.push(n))}return i};var _J={ge:function(e,t,i,n,s){return yJ(e,t,i,n,s,mJ)},gt:function(e,t,i,n,s){return yJ(e,t,i,n,s,AJ)},lt:function(e,t,i,n,s){return yJ(e,t,i,n,s,CJ)},le:function(e,t,i,n,s){return yJ(e,t,i,n,s,fJ)},eq:function(e,t,i,n,s){return yJ(e,t,i,n,s,bJ)}},vJ={exports:{}},xJ=function(e,t,i){var n=e*t,s=BJ*e,o=s-(s-e),r=e-o,a=BJ*t,l=a-(a-t),g=t-l,c=r*g-(n-o*l-r*l-o*g);if(i)return i[0]=c,i[1]=n,i;return[c,n]},BJ=+(Math.pow(2,27)+1);var wJ=function(e,t){var i=0|e.length,n=0|t.length;if(1===i&&1===n)return function(e,t){var i=e+t,n=i-e,s=i-n,o=t-n,r=e-s,a=r+o;if(a)return[a,i];return[i]}(e[0],t[0]);var s,o,r=new Array(i+n),a=0,l=0,g=0,c=Math.abs,d=e[l],h=c(d),u=t[g],I=c(u);h<I?(o=d,(l+=1)<i&&(h=c(d=e[l]))):(o=u,(g+=1)<n&&(I=c(u=t[g])));l<i&&h<I||g>=n?(s=d,(l+=1)<i&&(h=c(d=e[l]))):(s=u,(g+=1)<n&&(I=c(u=t[g])));var p,m,A=s+o,C=A-s,f=o-C,b=f,y=A;for(;l<i&&g<n;)h<I?(s=d,(l+=1)<i&&(h=c(d=e[l]))):(s=u,(g+=1)<n&&(I=c(u=t[g]))),(f=(o=b)-(C=(A=s+o)-s))&&(r[a++]=f),b=y-((p=y+A)-(m=p-y))+(A-m),y=p;for(;l<i;)(f=(o=b)-(C=(A=(s=d)+o)-s))&&(r[a++]=f),b=y-((p=y+A)-(m=p-y))+(A-m),y=p,(l+=1)<i&&(d=e[l]);for(;g<n;)(f=(o=b)-(C=(A=(s=u)+o)-s))&&(r[a++]=f),b=y-((p=y+A)-(m=p-y))+(A-m),y=p,(g+=1)<n&&(u=t[g]);b&&(r[a++]=b);y&&(r[a++]=y);a||(r[a++]=0);return r.length=a,r};var SJ=xJ,GJ=function(e,t,i){var n=e+t,s=n-e,o=t-s,r=e-(n-s);if(i)return i[0]=r+o,i[1]=n,i;return[r+o,n]},MJ=function(e,t){var i=e.length;if(1===i){var n=SJ(e[0],t);return n[0]?n:[n[1]]}var s=new Array(2*i),o=[.1,.1],r=[.1,.1],a=0;SJ(e[0],t,o),o[0]&&(s[a++]=o[0]);for(var l=1;l<i;++l){SJ(e[l],t,r);var g=o[1];GJ(g,r[0],o),o[0]&&(s[a++]=o[0]);var c=r[1],d=o[1],h=c+d,u=d-(h-c);o[1]=h,u&&(s[a++]=u)}o[1]&&(s[a++]=o[1]);0===a&&(s[a++]=0);return s.length=a,s};var RJ=function(e,t){var i=0|e.length,n=0|t.length;if(1===i&&1===n)return function(e,t){var i=e+t,n=i-e,s=i-n,o=t-n,r=e-s,a=r+o;if(a)return[a,i];return[i]}(e[0],-t[0]);var s,o,r=new Array(i+n),a=0,l=0,g=0,c=Math.abs,d=e[l],h=c(d),u=-t[g],I=c(u);h<I?(o=d,(l+=1)<i&&(h=c(d=e[l]))):(o=u,(g+=1)<n&&(I=c(u=-t[g])));l<i&&h<I||g>=n?(s=d,(l+=1)<i&&(h=c(d=e[l]))):(s=u,(g+=1)<n&&(I=c(u=-t[g])));var p,m,A=s+o,C=A-s,f=o-C,b=f,y=A;for(;l<i&&g<n;)h<I?(s=d,(l+=1)<i&&(h=c(d=e[l]))):(s=u,(g+=1)<n&&(I=c(u=-t[g]))),(f=(o=b)-(C=(A=s+o)-s))&&(r[a++]=f),b=y-((p=y+A)-(m=p-y))+(A-m),y=p;for(;l<i;)(f=(o=b)-(C=(A=(s=d)+o)-s))&&(r[a++]=f),b=y-((p=y+A)-(m=p-y))+(A-m),y=p,(l+=1)<i&&(d=e[l]);for(;g<n;)(f=(o=b)-(C=(A=(s=u)+o)-s))&&(r[a++]=f),b=y-((p=y+A)-(m=p-y))+(A-m),y=p,(g+=1)<n&&(u=-t[g]);b&&(r[a++]=b);y&&(r[a++]=y);a||(r[a++]=0);return r.length=a,r};!function(e){var t=xJ,i=wJ,n=MJ,s=RJ;function o(e,t,i,n){return function(i,s,o){var r=e(e(t(s[1],o[0]),t(-o[1],s[0])),e(t(i[1],s[0]),t(-s[1],i[0]))),a=e(t(i[1],o[0]),t(-o[1],i[0])),l=n(r,a);return l[l.length-1]}}function r(e,t,i,n){return function(s,o,r,a){var l=e(e(i(e(t(r[1],a[0]),t(-a[1],r[0])),o[2]),e(i(e(t(o[1],a[0]),t(-a[1],o[0])),-r[2]),i(e(t(o[1],r[0]),t(-r[1],o[0])),a[2]))),e(i(e(t(o[1],a[0]),t(-a[1],o[0])),s[2]),e(i(e(t(s[1],a[0]),t(-a[1],s[0])),-o[2]),i(e(t(s[1],o[0]),t(-o[1],s[0])),a[2])))),g=e(e(i(e(t(r[1],a[0]),t(-a[1],r[0])),s[2]),e(i(e(t(s[1],a[0]),t(-a[1],s[0])),-r[2]),i(e(t(s[1],r[0]),t(-r[1],s[0])),a[2]))),e(i(e(t(o[1],r[0]),t(-r[1],o[0])),s[2]),e(i(e(t(s[1],r[0]),t(-r[1],s[0])),-o[2]),i(e(t(s[1],o[0]),t(-o[1],s[0])),r[2])))),c=n(l,g);return c[c.length-1]}}function a(e,t,i,n){return function(s,o,r,a,l){var g=e(e(e(i(e(i(e(t(a[1],l[0]),t(-l[1],a[0])),r[2]),e(i(e(t(r[1],l[0]),t(-l[1],r[0])),-a[2]),i(e(t(r[1],a[0]),t(-a[1],r[0])),l[2]))),o[3]),e(i(e(i(e(t(a[1],l[0]),t(-l[1],a[0])),o[2]),e(i(e(t(o[1],l[0]),t(-l[1],o[0])),-a[2]),i(e(t(o[1],a[0]),t(-a[1],o[0])),l[2]))),-r[3]),i(e(i(e(t(r[1],l[0]),t(-l[1],r[0])),o[2]),e(i(e(t(o[1],l[0]),t(-l[1],o[0])),-r[2]),i(e(t(o[1],r[0]),t(-r[1],o[0])),l[2]))),a[3]))),e(i(e(i(e(t(r[1],a[0]),t(-a[1],r[0])),o[2]),e(i(e(t(o[1],a[0]),t(-a[1],o[0])),-r[2]),i(e(t(o[1],r[0]),t(-r[1],o[0])),a[2]))),-l[3]),e(i(e(i(e(t(a[1],l[0]),t(-l[1],a[0])),o[2]),e(i(e(t(o[1],l[0]),t(-l[1],o[0])),-a[2]),i(e(t(o[1],a[0]),t(-a[1],o[0])),l[2]))),s[3]),i(e(i(e(t(a[1],l[0]),t(-l[1],a[0])),s[2]),e(i(e(t(s[1],l[0]),t(-l[1],s[0])),-a[2]),i(e(t(s[1],a[0]),t(-a[1],s[0])),l[2]))),-o[3])))),e(e(i(e(i(e(t(o[1],l[0]),t(-l[1],o[0])),s[2]),e(i(e(t(s[1],l[0]),t(-l[1],s[0])),-o[2]),i(e(t(s[1],o[0]),t(-o[1],s[0])),l[2]))),a[3]),e(i(e(i(e(t(o[1],a[0]),t(-a[1],o[0])),s[2]),e(i(e(t(s[1],a[0]),t(-a[1],s[0])),-o[2]),i(e(t(s[1],o[0]),t(-o[1],s[0])),a[2]))),-l[3]),i(e(i(e(t(r[1],a[0]),t(-a[1],r[0])),o[2]),e(i(e(t(o[1],a[0]),t(-a[1],o[0])),-r[2]),i(e(t(o[1],r[0]),t(-r[1],o[0])),a[2]))),s[3]))),e(i(e(i(e(t(r[1],a[0]),t(-a[1],r[0])),s[2]),e(i(e(t(s[1],a[0]),t(-a[1],s[0])),-r[2]),i(e(t(s[1],r[0]),t(-r[1],s[0])),a[2]))),-o[3]),e(i(e(i(e(t(o[1],a[0]),t(-a[1],o[0])),s[2]),e(i(e(t(s[1],a[0]),t(-a[1],s[0])),-o[2]),i(e(t(s[1],o[0]),t(-o[1],s[0])),a[2]))),r[3]),i(e(i(e(t(o[1],r[0]),t(-r[1],o[0])),s[2]),e(i(e(t(s[1],r[0]),t(-r[1],s[0])),-o[2]),i(e(t(s[1],o[0]),t(-o[1],s[0])),r[2]))),-a[3]))))),c=e(e(e(i(e(i(e(t(a[1],l[0]),t(-l[1],a[0])),r[2]),e(i(e(t(r[1],l[0]),t(-l[1],r[0])),-a[2]),i(e(t(r[1],a[0]),t(-a[1],r[0])),l[2]))),s[3]),i(e(i(e(t(a[1],l[0]),t(-l[1],a[0])),s[2]),e(i(e(t(s[1],l[0]),t(-l[1],s[0])),-a[2]),i(e(t(s[1],a[0]),t(-a[1],s[0])),l[2]))),-r[3])),e(i(e(i(e(t(r[1],l[0]),t(-l[1],r[0])),s[2]),e(i(e(t(s[1],l[0]),t(-l[1],s[0])),-r[2]),i(e(t(s[1],r[0]),t(-r[1],s[0])),l[2]))),a[3]),i(e(i(e(t(r[1],a[0]),t(-a[1],r[0])),s[2]),e(i(e(t(s[1],a[0]),t(-a[1],s[0])),-r[2]),i(e(t(s[1],r[0]),t(-r[1],s[0])),a[2]))),-l[3]))),e(e(i(e(i(e(t(r[1],l[0]),t(-l[1],r[0])),o[2]),e(i(e(t(o[1],l[0]),t(-l[1],o[0])),-r[2]),i(e(t(o[1],r[0]),t(-r[1],o[0])),l[2]))),s[3]),i(e(i(e(t(r[1],l[0]),t(-l[1],r[0])),s[2]),e(i(e(t(s[1],l[0]),t(-l[1],s[0])),-r[2]),i(e(t(s[1],r[0]),t(-r[1],s[0])),l[2]))),-o[3])),e(i(e(i(e(t(o[1],l[0]),t(-l[1],o[0])),s[2]),e(i(e(t(s[1],l[0]),t(-l[1],s[0])),-o[2]),i(e(t(s[1],o[0]),t(-o[1],s[0])),l[2]))),r[3]),i(e(i(e(t(o[1],r[0]),t(-r[1],o[0])),s[2]),e(i(e(t(s[1],r[0]),t(-r[1],s[0])),-o[2]),i(e(t(s[1],o[0]),t(-o[1],s[0])),r[2]))),-l[3])))),d=n(g,c);return d[d.length-1]}}function l(e){return(3===e?o:4===e?r:a)(i,t,n,s)}var g=l(3),c=l(4),d=[function(){return 0},function(){return 0},function(e,t){return t[0]-e[0]},function(e,t,i){var n,s=(e[1]-i[1])*(t[0]-i[0]),o=(e[0]-i[0])*(t[1]-i[1]),r=s-o;if(s>0){if(o<=0)return r;n=s+o}else{if(!(s<0))return r;if(o>=0)return r;n=-(s+o)}var a=33306690738754716e-32*n;return r>=a||r<=-a?r:g(e,t,i)},function(e,t,i,n){var s=e[0]-n[0],o=t[0]-n[0],r=i[0]-n[0],a=e[1]-n[1],l=t[1]-n[1],g=i[1]-n[1],d=e[2]-n[2],h=t[2]-n[2],u=i[2]-n[2],I=o*g,p=r*l,m=r*a,A=s*g,C=s*l,f=o*a,b=d*(I-p)+h*(m-A)+u*(C-f),y=7771561172376103e-31*((Math.abs(I)+Math.abs(p))*Math.abs(d)+(Math.abs(m)+Math.abs(A))*Math.abs(h)+(Math.abs(C)+Math.abs(f))*Math.abs(u));return b>y||-b>y?b:c(e,t,i,n)}];function h(e){var t=d[e.length];return t||(t=d[e.length]=l(e.length)),t.apply(void 0,e)}function u(e,t,i,n,s,o,r){return function(t,i,a,l,g){switch(arguments.length){case 0:case 1:return 0;case 2:return n(t,i);case 3:return s(t,i,a);case 4:return o(t,i,a,l);case 5:return r(t,i,a,l,g)}for(var c=new Array(arguments.length),d=0;d<arguments.length;++d)c[d]=arguments[d];return e(c)}}!function(){for(;d.length<=5;)d.push(l(d.length));e.exports=u.apply(void 0,[h].concat(d));for(var t=0;t<=5;++t)e.exports[t]=d[t]}()}(vJ);var TJ=_J,ZJ=vJ.exports[3],VJ=0,WJ=function(e,t){for(var i=e.length,n=t.length,s=[],o=0;o<i;++o)s.push(new NJ(e[o],null,VJ,o));for(o=0;o<n;++o){var r=t[o],a=e[r[0]],l=e[r[1]];a[0]<l[0]?s.push(new NJ(a,l,2,o),new NJ(l,a,1,o)):a[0]>l[0]&&s.push(new NJ(l,a,2,o),new NJ(a,l,1,o))}s.sort(FJ);for(var g=s[0].a[0]-(1+Math.abs(s[0].a[0]))*Math.pow(2,-52),c=[new EJ([g,1],[g,0],-1,[],[])],d=[],h=(o=0,s.length);o<h;++o){var u=s[o],I=u.type;I===VJ?HJ(d,c,e,u.a,u.idx):2===I?LJ(c,e,u):DJ(c,e,u)}return d};function EJ(e,t,i,n,s){this.a=e,this.b=t,this.idx=i,this.lowerIds=n,this.upperIds=s}function NJ(e,t,i,n){this.a=e,this.b=t,this.type=i,this.idx=n}function FJ(e,t){var i=e.a[0]-t.a[0]||e.a[1]-t.a[1]||e.type-t.type;return i||(e.type!==VJ&&(i=ZJ(e.a,e.b,t.b))?i:e.idx-t.idx)}function XJ(e,t){return ZJ(e.a,e.b,t)}function HJ(e,t,i,n,s){for(var o=TJ.lt(t,n,XJ),r=TJ.gt(t,n,XJ),a=o;a<r;++a){for(var l=t[a],g=l.lowerIds,c=g.length;c>1&&ZJ(i[g[c-2]],i[g[c-1]],n)>0;)e.push([g[c-1],g[c-2],s]),c-=1;g.length=c,g.push(s);var d=l.upperIds;for(c=d.length;c>1&&ZJ(i[d[c-2]],i[d[c-1]],n)<0;)e.push([d[c-2],d[c-1],s]),c-=1;d.length=c,d.push(s)}}function zJ(e,t){var i;return(i=e.a[0]<t.a[0]?ZJ(e.a,e.b,t.a):ZJ(t.b,t.a,e.a))?i:(i=t.b[0]<e.b[0]?ZJ(e.a,e.b,t.b):ZJ(t.b,t.a,e.b))||e.idx-t.idx}function LJ(e,t,i){var n=TJ.le(e,i,zJ),s=e[n],o=s.upperIds,r=o[o.length-1];s.upperIds=[r],e.splice(n+1,0,new EJ(i.a,i.b,i.idx,[r],o))}function DJ(e,t,i){var n=i.a;i.a=i.b,i.b=n;var s=TJ.eq(e,i,zJ),o=e[s];e[s-1].upperIds=o.upperIds,e.splice(s,1)}var KJ=_J,YJ=function(e,t){for(var i=new Array(e),n=0;n<e;++n)i[n]=[];return new PJ(i,t)};function PJ(e,t){this.stars=e,this.edges=t}var kJ=PJ.prototype;function OJ(e,t,i){for(var n=1,s=e.length;n<s;n+=2)if(e[n-1]===t&&e[n]===i)return e[n-1]=e[s-2],e[n]=e[s-1],void(e.length=s-2)}kJ.isConstraint=function(){var e=[0,0];function t(e,t){return e[0]-t[0]||e[1]-t[1]}return function(i,n){return e[0]=Math.min(i,n),e[1]=Math.max(i,n),KJ.eq(this.edges,e,t)>=0}}(),kJ.removeTriangle=function(e,t,i){var n=this.stars;OJ(n[e],t,i),OJ(n[t],i,e),OJ(n[i],e,t)},kJ.addTriangle=function(e,t,i){var n=this.stars;n[e].push(t,i),n[t].push(i,e),n[i].push(e,t)},kJ.opposite=function(e,t){for(var i=this.stars[t],n=1,s=i.length;n<s;n+=2)if(i[n]===e)return i[n-1];return-1},kJ.flip=function(e,t){var i=this.opposite(e,t),n=this.opposite(t,e);this.removeTriangle(e,t,i),this.removeTriangle(t,e,n),this.addTriangle(e,n,i),this.addTriangle(t,i,n)},kJ.edges=function(){for(var e=this.stars,t=[],i=0,n=e.length;i<n;++i)for(var s=e[i],o=0,r=s.length;o<r;o+=2)t.push([s[o],s[o+1]]);return t},kJ.cells=function(){for(var e=this.stars,t=[],i=0,n=e.length;i<n;++i)for(var s=e[i],o=0,r=s.length;o<r;o+=2){var a=s[o],l=s[o+1];i<Math.min(a,l)&&t.push([i,a,l])}return t};var UJ={exports:{}};!function(e){var t=xJ,i=wJ,n=RJ,s=MJ;function o(e){return(3===e?r:4===e?a:5===e?l:g)(i,n,t,s)}function r(e,t,i,n){return function(s,o,r){var a=i(s[0],s[0]),l=n(a,o[0]),g=n(a,r[0]),c=i(o[0],o[0]),d=n(c,s[0]),h=n(c,r[0]),u=i(r[0],r[0]),I=n(u,s[0]),p=n(u,o[0]),m=e(t(p,h),t(d,l)),A=t(I,g),C=t(m,A);return C[C.length-1]}}function a(e,t,i,n){return function(s,o,r,a){var l=e(i(s[0],s[0]),i(s[1],s[1])),g=n(l,o[0]),c=n(l,r[0]),d=n(l,a[0]),h=e(i(o[0],o[0]),i(o[1],o[1])),u=n(h,s[0]),I=n(h,r[0]),p=n(h,a[0]),m=e(i(r[0],r[0]),i(r[1],r[1])),A=n(m,s[0]),C=n(m,o[0]),f=n(m,a[0]),b=e(i(a[0],a[0]),i(a[1],a[1])),y=n(b,s[0]),_=n(b,o[0]),v=n(b,r[0]),x=e(e(n(t(v,f),o[1]),e(n(t(_,p),-r[1]),n(t(C,I),a[1]))),e(n(t(_,p),s[1]),e(n(t(y,d),-o[1]),n(t(u,g),a[1])))),B=e(e(n(t(v,f),s[1]),e(n(t(y,d),-r[1]),n(t(A,c),a[1]))),e(n(t(C,I),s[1]),e(n(t(A,c),-o[1]),n(t(u,g),r[1])))),w=t(x,B);return w[w.length-1]}}function l(e,t,i,n){return function(s,o,r,a,l){var g=e(i(s[0],s[0]),e(i(s[1],s[1]),i(s[2],s[2]))),c=n(g,o[0]),d=n(g,r[0]),h=n(g,a[0]),u=n(g,l[0]),I=e(i(o[0],o[0]),e(i(o[1],o[1]),i(o[2],o[2]))),p=n(I,s[0]),m=n(I,r[0]),A=n(I,a[0]),C=n(I,l[0]),f=e(i(r[0],r[0]),e(i(r[1],r[1]),i(r[2],r[2]))),b=n(f,s[0]),y=n(f,o[0]),_=n(f,a[0]),v=n(f,l[0]),x=e(i(a[0],a[0]),e(i(a[1],a[1]),i(a[2],a[2]))),B=n(x,s[0]),w=n(x,o[0]),S=n(x,r[0]),G=n(x,l[0]),M=e(i(l[0],l[0]),e(i(l[1],l[1]),i(l[2],l[2]))),R=n(M,s[0]),T=n(M,o[0]),Z=n(M,r[0]),V=n(M,a[0]),W=e(e(e(n(e(n(t(V,G),r[1]),e(n(t(Z,v),-a[1]),n(t(S,_),l[1]))),o[2]),e(n(e(n(t(V,G),o[1]),e(n(t(T,C),-a[1]),n(t(w,A),l[1]))),-r[2]),n(e(n(t(Z,v),o[1]),e(n(t(T,C),-r[1]),n(t(y,m),l[1]))),a[2]))),e(n(e(n(t(S,_),o[1]),e(n(t(w,A),-r[1]),n(t(y,m),a[1]))),-l[2]),e(n(e(n(t(V,G),o[1]),e(n(t(T,C),-a[1]),n(t(w,A),l[1]))),s[2]),n(e(n(t(V,G),s[1]),e(n(t(R,u),-a[1]),n(t(B,h),l[1]))),-o[2])))),e(e(n(e(n(t(T,C),s[1]),e(n(t(R,u),-o[1]),n(t(p,c),l[1]))),a[2]),e(n(e(n(t(w,A),s[1]),e(n(t(B,h),-o[1]),n(t(p,c),a[1]))),-l[2]),n(e(n(t(S,_),o[1]),e(n(t(w,A),-r[1]),n(t(y,m),a[1]))),s[2]))),e(n(e(n(t(S,_),s[1]),e(n(t(B,h),-r[1]),n(t(b,d),a[1]))),-o[2]),e(n(e(n(t(w,A),s[1]),e(n(t(B,h),-o[1]),n(t(p,c),a[1]))),r[2]),n(e(n(t(y,m),s[1]),e(n(t(b,d),-o[1]),n(t(p,c),r[1]))),-a[2]))))),E=e(e(e(n(e(n(t(V,G),r[1]),e(n(t(Z,v),-a[1]),n(t(S,_),l[1]))),s[2]),n(e(n(t(V,G),s[1]),e(n(t(R,u),-a[1]),n(t(B,h),l[1]))),-r[2])),e(n(e(n(t(Z,v),s[1]),e(n(t(R,u),-r[1]),n(t(b,d),l[1]))),a[2]),n(e(n(t(S,_),s[1]),e(n(t(B,h),-r[1]),n(t(b,d),a[1]))),-l[2]))),e(e(n(e(n(t(Z,v),o[1]),e(n(t(T,C),-r[1]),n(t(y,m),l[1]))),s[2]),n(e(n(t(Z,v),s[1]),e(n(t(R,u),-r[1]),n(t(b,d),l[1]))),-o[2])),e(n(e(n(t(T,C),s[1]),e(n(t(R,u),-o[1]),n(t(p,c),l[1]))),r[2]),n(e(n(t(y,m),s[1]),e(n(t(b,d),-o[1]),n(t(p,c),r[1]))),-l[2])))),N=t(W,E);return N[N.length-1]}}function g(e,t,i,n){return function(s,o,r,a,l,g){var c=e(e(i(s[0],s[0]),i(s[1],s[1])),e(i(s[2],s[2]),i(s[3],s[3]))),d=n(c,o[0]),h=n(c,r[0]),u=n(c,a[0]),I=n(c,l[0]),p=n(c,g[0]),m=e(e(i(o[0],o[0]),i(o[1],o[1])),e(i(o[2],o[2]),i(o[3],o[3]))),A=n(m,s[0]),C=n(m,r[0]),f=n(m,a[0]),b=n(m,l[0]),y=n(m,g[0]),_=e(e(i(r[0],r[0]),i(r[1],r[1])),e(i(r[2],r[2]),i(r[3],r[3]))),v=n(_,s[0]),x=n(_,o[0]),B=n(_,a[0]),w=n(_,l[0]),S=n(_,g[0]),G=e(e(i(a[0],a[0]),i(a[1],a[1])),e(i(a[2],a[2]),i(a[3],a[3]))),M=n(G,s[0]),R=n(G,o[0]),T=n(G,r[0]),Z=n(G,l[0]),V=n(G,g[0]),W=e(e(i(l[0],l[0]),i(l[1],l[1])),e(i(l[2],l[2]),i(l[3],l[3]))),E=n(W,s[0]),N=n(W,o[0]),F=n(W,r[0]),X=n(W,a[0]),H=n(W,g[0]),z=e(e(i(g[0],g[0]),i(g[1],g[1])),e(i(g[2],g[2]),i(g[3],g[3]))),L=n(z,s[0]),D=n(z,o[0]),K=n(z,r[0]),Y=n(z,a[0]),P=n(z,l[0]),k=e(e(e(n(e(e(n(e(n(t(P,H),a[1]),e(n(t(Y,V),-l[1]),n(t(X,Z),g[1]))),r[2]),n(e(n(t(P,H),r[1]),e(n(t(K,S),-l[1]),n(t(F,w),g[1]))),-a[2])),e(n(e(n(t(Y,V),r[1]),e(n(t(K,S),-a[1]),n(t(T,B),g[1]))),l[2]),n(e(n(t(X,Z),r[1]),e(n(t(F,w),-a[1]),n(t(T,B),l[1]))),-g[2]))),o[3]),e(n(e(e(n(e(n(t(P,H),a[1]),e(n(t(Y,V),-l[1]),n(t(X,Z),g[1]))),o[2]),n(e(n(t(P,H),o[1]),e(n(t(D,y),-l[1]),n(t(N,b),g[1]))),-a[2])),e(n(e(n(t(Y,V),o[1]),e(n(t(D,y),-a[1]),n(t(R,f),g[1]))),l[2]),n(e(n(t(X,Z),o[1]),e(n(t(N,b),-a[1]),n(t(R,f),l[1]))),-g[2]))),-r[3]),n(e(e(n(e(n(t(P,H),r[1]),e(n(t(K,S),-l[1]),n(t(F,w),g[1]))),o[2]),n(e(n(t(P,H),o[1]),e(n(t(D,y),-l[1]),n(t(N,b),g[1]))),-r[2])),e(n(e(n(t(K,S),o[1]),e(n(t(D,y),-r[1]),n(t(x,C),g[1]))),l[2]),n(e(n(t(F,w),o[1]),e(n(t(N,b),-r[1]),n(t(x,C),l[1]))),-g[2]))),a[3]))),e(e(n(e(e(n(e(n(t(Y,V),r[1]),e(n(t(K,S),-a[1]),n(t(T,B),g[1]))),o[2]),n(e(n(t(Y,V),o[1]),e(n(t(D,y),-a[1]),n(t(R,f),g[1]))),-r[2])),e(n(e(n(t(K,S),o[1]),e(n(t(D,y),-r[1]),n(t(x,C),g[1]))),a[2]),n(e(n(t(T,B),o[1]),e(n(t(R,f),-r[1]),n(t(x,C),a[1]))),-g[2]))),-l[3]),n(e(e(n(e(n(t(X,Z),r[1]),e(n(t(F,w),-a[1]),n(t(T,B),l[1]))),o[2]),n(e(n(t(X,Z),o[1]),e(n(t(N,b),-a[1]),n(t(R,f),l[1]))),-r[2])),e(n(e(n(t(F,w),o[1]),e(n(t(N,b),-r[1]),n(t(x,C),l[1]))),a[2]),n(e(n(t(T,B),o[1]),e(n(t(R,f),-r[1]),n(t(x,C),a[1]))),-l[2]))),g[3])),e(n(e(e(n(e(n(t(P,H),a[1]),e(n(t(Y,V),-l[1]),n(t(X,Z),g[1]))),o[2]),n(e(n(t(P,H),o[1]),e(n(t(D,y),-l[1]),n(t(N,b),g[1]))),-a[2])),e(n(e(n(t(Y,V),o[1]),e(n(t(D,y),-a[1]),n(t(R,f),g[1]))),l[2]),n(e(n(t(X,Z),o[1]),e(n(t(N,b),-a[1]),n(t(R,f),l[1]))),-g[2]))),s[3]),n(e(e(n(e(n(t(P,H),a[1]),e(n(t(Y,V),-l[1]),n(t(X,Z),g[1]))),s[2]),n(e(n(t(P,H),s[1]),e(n(t(L,p),-l[1]),n(t(E,I),g[1]))),-a[2])),e(n(e(n(t(Y,V),s[1]),e(n(t(L,p),-a[1]),n(t(M,u),g[1]))),l[2]),n(e(n(t(X,Z),s[1]),e(n(t(E,I),-a[1]),n(t(M,u),l[1]))),-g[2]))),-o[3])))),e(e(e(n(e(e(n(e(n(t(P,H),o[1]),e(n(t(D,y),-l[1]),n(t(N,b),g[1]))),s[2]),n(e(n(t(P,H),s[1]),e(n(t(L,p),-l[1]),n(t(E,I),g[1]))),-o[2])),e(n(e(n(t(D,y),s[1]),e(n(t(L,p),-o[1]),n(t(A,d),g[1]))),l[2]),n(e(n(t(N,b),s[1]),e(n(t(E,I),-o[1]),n(t(A,d),l[1]))),-g[2]))),a[3]),n(e(e(n(e(n(t(Y,V),o[1]),e(n(t(D,y),-a[1]),n(t(R,f),g[1]))),s[2]),n(e(n(t(Y,V),s[1]),e(n(t(L,p),-a[1]),n(t(M,u),g[1]))),-o[2])),e(n(e(n(t(D,y),s[1]),e(n(t(L,p),-o[1]),n(t(A,d),g[1]))),a[2]),n(e(n(t(R,f),s[1]),e(n(t(M,u),-o[1]),n(t(A,d),a[1]))),-g[2]))),-l[3])),e(n(e(e(n(e(n(t(X,Z),o[1]),e(n(t(N,b),-a[1]),n(t(R,f),l[1]))),s[2]),n(e(n(t(X,Z),s[1]),e(n(t(E,I),-a[1]),n(t(M,u),l[1]))),-o[2])),e(n(e(n(t(N,b),s[1]),e(n(t(E,I),-o[1]),n(t(A,d),l[1]))),a[2]),n(e(n(t(R,f),s[1]),e(n(t(M,u),-o[1]),n(t(A,d),a[1]))),-l[2]))),g[3]),n(e(e(n(e(n(t(Y,V),r[1]),e(n(t(K,S),-a[1]),n(t(T,B),g[1]))),o[2]),n(e(n(t(Y,V),o[1]),e(n(t(D,y),-a[1]),n(t(R,f),g[1]))),-r[2])),e(n(e(n(t(K,S),o[1]),e(n(t(D,y),-r[1]),n(t(x,C),g[1]))),a[2]),n(e(n(t(T,B),o[1]),e(n(t(R,f),-r[1]),n(t(x,C),a[1]))),-g[2]))),s[3]))),e(e(n(e(e(n(e(n(t(Y,V),r[1]),e(n(t(K,S),-a[1]),n(t(T,B),g[1]))),s[2]),n(e(n(t(Y,V),s[1]),e(n(t(L,p),-a[1]),n(t(M,u),g[1]))),-r[2])),e(n(e(n(t(K,S),s[1]),e(n(t(L,p),-r[1]),n(t(v,h),g[1]))),a[2]),n(e(n(t(T,B),s[1]),e(n(t(M,u),-r[1]),n(t(v,h),a[1]))),-g[2]))),-o[3]),n(e(e(n(e(n(t(Y,V),o[1]),e(n(t(D,y),-a[1]),n(t(R,f),g[1]))),s[2]),n(e(n(t(Y,V),s[1]),e(n(t(L,p),-a[1]),n(t(M,u),g[1]))),-o[2])),e(n(e(n(t(D,y),s[1]),e(n(t(L,p),-o[1]),n(t(A,d),g[1]))),a[2]),n(e(n(t(R,f),s[1]),e(n(t(M,u),-o[1]),n(t(A,d),a[1]))),-g[2]))),r[3])),e(n(e(e(n(e(n(t(K,S),o[1]),e(n(t(D,y),-r[1]),n(t(x,C),g[1]))),s[2]),n(e(n(t(K,S),s[1]),e(n(t(L,p),-r[1]),n(t(v,h),g[1]))),-o[2])),e(n(e(n(t(D,y),s[1]),e(n(t(L,p),-o[1]),n(t(A,d),g[1]))),r[2]),n(e(n(t(x,C),s[1]),e(n(t(v,h),-o[1]),n(t(A,d),r[1]))),-g[2]))),-a[3]),n(e(e(n(e(n(t(T,B),o[1]),e(n(t(R,f),-r[1]),n(t(x,C),a[1]))),s[2]),n(e(n(t(T,B),s[1]),e(n(t(M,u),-r[1]),n(t(v,h),a[1]))),-o[2])),e(n(e(n(t(R,f),s[1]),e(n(t(M,u),-o[1]),n(t(A,d),a[1]))),r[2]),n(e(n(t(x,C),s[1]),e(n(t(v,h),-o[1]),n(t(A,d),r[1]))),-a[2]))),g[3]))))),O=e(e(e(n(e(e(n(e(n(t(P,H),a[1]),e(n(t(Y,V),-l[1]),n(t(X,Z),g[1]))),r[2]),n(e(n(t(P,H),r[1]),e(n(t(K,S),-l[1]),n(t(F,w),g[1]))),-a[2])),e(n(e(n(t(Y,V),r[1]),e(n(t(K,S),-a[1]),n(t(T,B),g[1]))),l[2]),n(e(n(t(X,Z),r[1]),e(n(t(F,w),-a[1]),n(t(T,B),l[1]))),-g[2]))),s[3]),e(n(e(e(n(e(n(t(P,H),a[1]),e(n(t(Y,V),-l[1]),n(t(X,Z),g[1]))),s[2]),n(e(n(t(P,H),s[1]),e(n(t(L,p),-l[1]),n(t(E,I),g[1]))),-a[2])),e(n(e(n(t(Y,V),s[1]),e(n(t(L,p),-a[1]),n(t(M,u),g[1]))),l[2]),n(e(n(t(X,Z),s[1]),e(n(t(E,I),-a[1]),n(t(M,u),l[1]))),-g[2]))),-r[3]),n(e(e(n(e(n(t(P,H),r[1]),e(n(t(K,S),-l[1]),n(t(F,w),g[1]))),s[2]),n(e(n(t(P,H),s[1]),e(n(t(L,p),-l[1]),n(t(E,I),g[1]))),-r[2])),e(n(e(n(t(K,S),s[1]),e(n(t(L,p),-r[1]),n(t(v,h),g[1]))),l[2]),n(e(n(t(F,w),s[1]),e(n(t(E,I),-r[1]),n(t(v,h),l[1]))),-g[2]))),a[3]))),e(e(n(e(e(n(e(n(t(Y,V),r[1]),e(n(t(K,S),-a[1]),n(t(T,B),g[1]))),s[2]),n(e(n(t(Y,V),s[1]),e(n(t(L,p),-a[1]),n(t(M,u),g[1]))),-r[2])),e(n(e(n(t(K,S),s[1]),e(n(t(L,p),-r[1]),n(t(v,h),g[1]))),a[2]),n(e(n(t(T,B),s[1]),e(n(t(M,u),-r[1]),n(t(v,h),a[1]))),-g[2]))),-l[3]),n(e(e(n(e(n(t(X,Z),r[1]),e(n(t(F,w),-a[1]),n(t(T,B),l[1]))),s[2]),n(e(n(t(X,Z),s[1]),e(n(t(E,I),-a[1]),n(t(M,u),l[1]))),-r[2])),e(n(e(n(t(F,w),s[1]),e(n(t(E,I),-r[1]),n(t(v,h),l[1]))),a[2]),n(e(n(t(T,B),s[1]),e(n(t(M,u),-r[1]),n(t(v,h),a[1]))),-l[2]))),g[3])),e(n(e(e(n(e(n(t(P,H),r[1]),e(n(t(K,S),-l[1]),n(t(F,w),g[1]))),o[2]),n(e(n(t(P,H),o[1]),e(n(t(D,y),-l[1]),n(t(N,b),g[1]))),-r[2])),e(n(e(n(t(K,S),o[1]),e(n(t(D,y),-r[1]),n(t(x,C),g[1]))),l[2]),n(e(n(t(F,w),o[1]),e(n(t(N,b),-r[1]),n(t(x,C),l[1]))),-g[2]))),s[3]),n(e(e(n(e(n(t(P,H),r[1]),e(n(t(K,S),-l[1]),n(t(F,w),g[1]))),s[2]),n(e(n(t(P,H),s[1]),e(n(t(L,p),-l[1]),n(t(E,I),g[1]))),-r[2])),e(n(e(n(t(K,S),s[1]),e(n(t(L,p),-r[1]),n(t(v,h),g[1]))),l[2]),n(e(n(t(F,w),s[1]),e(n(t(E,I),-r[1]),n(t(v,h),l[1]))),-g[2]))),-o[3])))),e(e(e(n(e(e(n(e(n(t(P,H),o[1]),e(n(t(D,y),-l[1]),n(t(N,b),g[1]))),s[2]),n(e(n(t(P,H),s[1]),e(n(t(L,p),-l[1]),n(t(E,I),g[1]))),-o[2])),e(n(e(n(t(D,y),s[1]),e(n(t(L,p),-o[1]),n(t(A,d),g[1]))),l[2]),n(e(n(t(N,b),s[1]),e(n(t(E,I),-o[1]),n(t(A,d),l[1]))),-g[2]))),r[3]),n(e(e(n(e(n(t(K,S),o[1]),e(n(t(D,y),-r[1]),n(t(x,C),g[1]))),s[2]),n(e(n(t(K,S),s[1]),e(n(t(L,p),-r[1]),n(t(v,h),g[1]))),-o[2])),e(n(e(n(t(D,y),s[1]),e(n(t(L,p),-o[1]),n(t(A,d),g[1]))),r[2]),n(e(n(t(x,C),s[1]),e(n(t(v,h),-o[1]),n(t(A,d),r[1]))),-g[2]))),-l[3])),e(n(e(e(n(e(n(t(F,w),o[1]),e(n(t(N,b),-r[1]),n(t(x,C),l[1]))),s[2]),n(e(n(t(F,w),s[1]),e(n(t(E,I),-r[1]),n(t(v,h),l[1]))),-o[2])),e(n(e(n(t(N,b),s[1]),e(n(t(E,I),-o[1]),n(t(A,d),l[1]))),r[2]),n(e(n(t(x,C),s[1]),e(n(t(v,h),-o[1]),n(t(A,d),r[1]))),-l[2]))),g[3]),n(e(e(n(e(n(t(X,Z),r[1]),e(n(t(F,w),-a[1]),n(t(T,B),l[1]))),o[2]),n(e(n(t(X,Z),o[1]),e(n(t(N,b),-a[1]),n(t(R,f),l[1]))),-r[2])),e(n(e(n(t(F,w),o[1]),e(n(t(N,b),-r[1]),n(t(x,C),l[1]))),a[2]),n(e(n(t(T,B),o[1]),e(n(t(R,f),-r[1]),n(t(x,C),a[1]))),-l[2]))),s[3]))),e(e(n(e(e(n(e(n(t(X,Z),r[1]),e(n(t(F,w),-a[1]),n(t(T,B),l[1]))),s[2]),n(e(n(t(X,Z),s[1]),e(n(t(E,I),-a[1]),n(t(M,u),l[1]))),-r[2])),e(n(e(n(t(F,w),s[1]),e(n(t(E,I),-r[1]),n(t(v,h),l[1]))),a[2]),n(e(n(t(T,B),s[1]),e(n(t(M,u),-r[1]),n(t(v,h),a[1]))),-l[2]))),-o[3]),n(e(e(n(e(n(t(X,Z),o[1]),e(n(t(N,b),-a[1]),n(t(R,f),l[1]))),s[2]),n(e(n(t(X,Z),s[1]),e(n(t(E,I),-a[1]),n(t(M,u),l[1]))),-o[2])),e(n(e(n(t(N,b),s[1]),e(n(t(E,I),-o[1]),n(t(A,d),l[1]))),a[2]),n(e(n(t(R,f),s[1]),e(n(t(M,u),-o[1]),n(t(A,d),a[1]))),-l[2]))),r[3])),e(n(e(e(n(e(n(t(F,w),o[1]),e(n(t(N,b),-r[1]),n(t(x,C),l[1]))),s[2]),n(e(n(t(F,w),s[1]),e(n(t(E,I),-r[1]),n(t(v,h),l[1]))),-o[2])),e(n(e(n(t(N,b),s[1]),e(n(t(E,I),-o[1]),n(t(A,d),l[1]))),r[2]),n(e(n(t(x,C),s[1]),e(n(t(v,h),-o[1]),n(t(A,d),r[1]))),-l[2]))),-a[3]),n(e(e(n(e(n(t(T,B),o[1]),e(n(t(R,f),-r[1]),n(t(x,C),a[1]))),s[2]),n(e(n(t(T,B),s[1]),e(n(t(M,u),-r[1]),n(t(v,h),a[1]))),-o[2])),e(n(e(n(t(R,f),s[1]),e(n(t(M,u),-o[1]),n(t(A,d),a[1]))),r[2]),n(e(n(t(x,C),s[1]),e(n(t(v,h),-o[1]),n(t(A,d),r[1]))),-a[2]))),l[3]))))),U=t(k,O);return U[U.length-1]}}var c=[function(){return 0},function(){return 0},function(){return 0}];function d(e){var t=c[e.length];return t||(t=c[e.length]=o(e.length)),t.apply(void 0,e)}function h(e,t,i,n,s,o,r,a){return function(t,i,l,g,c,d){switch(arguments.length){case 0:case 1:return 0;case 2:return n(t,i);case 3:return s(t,i,l);case 4:return o(t,i,l,g);case 5:return r(t,i,l,g,c);case 6:return a(t,i,l,g,c,d)}for(var h=new Array(arguments.length),u=0;u<arguments.length;++u)h[u]=arguments[u];return e(h)}}!function(){for(;c.length<=6;)c.push(o(c.length));e.exports=h.apply(void 0,[d].concat(c));for(var t=0;t<=6;++t)e.exports[t]=c[t]}()}(UJ);var QJ=UJ.exports[4],JJ=function(e,t){for(var i=[],n=e.length,s=t.stars,o=0;o<n;++o)for(var r=s[o],a=1;a<r.length;a+=2){if(!((d=r[a])<o)&&!t.isConstraint(o,d)){for(var l=r[a-1],g=-1,c=1;c<r.length;c+=2)if(r[c-1]===d){g=r[c];break}g<0||QJ(e[o],e[d],e[l],e[g])<0&&i.push(o,d)}}for(;i.length>0;){for(var d=i.pop(),h=(l=-1,g=-1,r=s[o=i.pop()],1);h<r.length;h+=2){var u=r[h-1],I=r[h];u===d?g=I:I===d&&(l=u)}l<0||g<0||(QJ(e[o],e[d],e[l],e[g])>=0||(t.flip(o,d),jJ(e,t,i,l,o,g),jJ(e,t,i,o,g,l),jJ(e,t,i,g,d,l),jJ(e,t,i,d,l,g)))}};function jJ(e,t,i,n,s,o){var r=t.opposite(n,s);if(!(r<0)){if(s<n){var a=n;n=s,s=a,a=o,o=r,r=a}t.isConstraint(n,s)||QJ(e[n],e[s],e[o],e[r])<0&&i.push(n,s)}}var qJ,$J=_J,ej=function(e,t,i){var n=function(e,t){for(var i=e.cells(),n=i.length,s=0;s<n;++s){var o=(p=i[s])[0],r=p[1],a=p[2];r<a?r<o&&(p[0]=r,p[1]=a,p[2]=o):a<o&&(p[0]=a,p[1]=o,p[2]=r)}i.sort(ij);var l=new Array(n);for(s=0;s<l.length;++s)l[s]=0;var g=[],c=[],d=new Array(3*n),h=new Array(3*n),u=null;t&&(u=[]);var I=new tj(i,d,h,l,g,c,u);for(s=0;s<n;++s)for(var p=i[s],m=0;m<3;++m){o=p[m],r=p[(m+1)%3];var A=d[3*s+m]=I.locate(r,o,e.opposite(r,o)),C=h[3*s+m]=e.isConstraint(o,r);A<0&&(C?c.push(s):(g.push(s),l[s]=1),t&&u.push([r,o,-1]))}return I}(e,i);if(0===t)return i?n.cells.concat(n.boundary):n.cells;var s=1,o=n.active,r=n.next,a=n.flags,l=n.cells,g=n.constraint,c=n.neighbor;for(;o.length>0||r.length>0;){for(;o.length>0;){var d=o.pop();if(a[d]!==-s){a[d]=s,l[d];for(var h=0;h<3;++h){var u=c[3*d+h];u>=0&&0===a[u]&&(g[3*d+h]?r.push(u):(o.push(u),a[u]=s))}}}var I=r;r=o,o=I,r.length=0,s=-s}var p=function(e,t,i){for(var n=0,s=0;s<e.length;++s)t[s]===i&&(e[n++]=e[s]);return e.length=n,e}(l,a,t);if(i)return p.concat(n.boundary);return p};function tj(e,t,i,n,s,o,r){this.cells=e,this.neighbor=t,this.flags=n,this.constraint=i,this.active=s,this.next=o,this.boundary=r}function ij(e,t){return e[0]-t[0]||e[1]-t[1]||e[2]-t[2]}tj.prototype.locate=(qJ=[0,0,0],function(e,t,i){var n=e,s=t,o=i;return t<i?t<e&&(n=t,s=i,o=e):i<e&&(n=i,s=e,o=t),n<0?-1:(qJ[0]=n,qJ[1]=s,qJ[2]=o,$J.eq(this.cells,qJ,ij))});var nj=WJ,sj=YJ,oj=JJ,rj=ej,aj=function(e,t,i){Array.isArray(t)?(i=i||{},t=t||[]):(i=t||{},t=[]);var n=!!cj(i,"delaunay",!0),s=!!cj(i,"interior",!0),o=!!cj(i,"exterior",!0),r=!!cj(i,"infinity",!1);if(!s&&!o||0===e.length)return[];var a=nj(e,t);if(n||s!==o||r){for(var l=sj(e.length,function(e){return e.map(lj).sort(gj)}(t)),g=0;g<a.length;++g){var c=a[g];l.addTriangle(c[0],c[1],c[2])}return n&&oj(e,l),o?s?r?rj(l,0,r):l.cells():rj(l,1,r):rj(l,-1)}return a};function lj(e){return[Math.min(e[0],e[1]),Math.max(e[0],e[1])]}function gj(e,t){return e[0]-t[0]||e[1]-t[1]}function cj(e,t,i){return t in e?e[t]:i}function dj(e,t,i=1e4){for(let n=0;n<t.length;n+=i)e.push(...t.slice(n,n+i))}function hj(e){let t=[],i=0;for(i=0;i<e.length-1;i++)t.push([i,i+1]);return t.push([i,0]),t}function uj(e,t){const i=[];for(let n=0;n<t.length;n++){const s=t[n],[o,r]=s;0===n&&i.push(e[o]),i.push(e[r])}return i}function Ij(e){let t={},i={},n=[],s=0;for(let o=0;o<e.length;o++){const r=e[o],a=r[2]||0,l=`${r[0]},${r[1]},${a}`;void 0!==t[l]?s++:(t[l]=o-s,n.push(r));const g=t[l];i[o]=g}return{indexMap:i,points:n}}function pj(e,t){let i=[],n={},s=0;for(let o=0;o<e.length;o++){const r=e[o];if(r[0]=t[r[0]],r[1]=t[r[1]],r[0]===r[1])continue;const a=`${r[0]},${r[1]}`;void 0!==n[a]?s++:(n[a]=o-s,i.push(r))}return i}function mj(e){let t=e.length,i=0;for(let n=t-1,s=0;s<t;n=s++)i+=e[n][0]*e[s][1]-e[s][0]*e[n][1];return i<0}const Aj=[1,1,0,1];let Cj=new Qt,fj=new Qt;const bj=new Qt,yj=new Qt,_j=new Qt,vj=new Qt,xj=new Qt,Bj=new Qt,wj=new Qt,Sj=new bt,Gj=new bt,Mj=new bt,Rj=new Qt,Tj=new Qt,Zj=new Qt,Vj=new Qt,Wj=new Qt,Ej=new Qt,Nj=new bt,Fj=[0,0,0],Xj=[0,0,0],Hj=[0,0,0],zj=[],Lj=new Qt,Dj=(e,t,i,n)=>(jm.subtract(t,e,Lj),jm.multiplyByScalar(Lj,i/n,Lj),jm.add(e,Lj,Lj),[Lj.x,Lj.y,Lj.z]),Kj=new Qt,Yj=new Qt,Pj=(e,t,i,n,s,o,r,a=!0)=>{r=r||Km.RADIANS_PER_DEGREE;const l=!!o,g=n.slice(0);let c=0;const d=t.length,h=new Array(3*d),u=new Array(2*d),I=new Array(d);let p=0,m=0,A=0;for(c=0;c<d;c++){const e=t[c];if(h[p++]=e.x,h[p++]=e.y,h[p++]=e.z,l){const e=o[c];u[m++]=e.x,u[m++]=e.y}I[A++]=i[c]}const C=[],f={},b={},y=e.maximumRadius,_=Km.chordLength(r,y),v=_*_;for(;g.length>0;){const e=g.pop(),t=g.pop(),i=g.pop(),n=bj.fromArray(h,3*i),o=yj.fromArray(h,3*t),r=_j.fromArray(h,3*e),d=I[i],p=I[t],m=I[e];let A,_,x;l&&(A=Sj.fromArray(u,2*i),_=Gj.fromArray(u,2*t),x=Mj.fromArray(u,2*e));const B=jm.multiplyByScalar(jm.normalize(n,vj),y,vj),w=jm.multiplyByScalar(jm.normalize(o,xj),y,xj),S=jm.multiplyByScalar(jm.normalize(r,Bj),y,Bj),G=jm.magnitudeSquared(jm.subtract(B,w,wj)),M=jm.magnitudeSquared(jm.subtract(w,S,wj)),R=jm.magnitudeSquared(jm.subtract(S,B,wj)),T=Math.max(G,M,R);let Z,V,W,E;a&&T>v?G===T?(Z=`${Math.min(i,t)} ${Math.max(i,t)}`,c=f[Z],null==c?(V=jm.add(n,o,wj),jm.multiplyByScalar(V,.5,V),h.push(V.x,V.y,V.z),c=h.length/3-1,f[Z]=c,E=.5*(d+p),I.push(E),b[Z]=E,l&&(W=oA.add(A,_,wj),oA.multiplyByScalar(W,.5,W),u.push(W.x,W.y))):E=b[Z],g.push(i,c,e),g.push(c,t,e)):M===T?(Z=`${Math.min(t,e)} ${Math.max(t,e)}`,c=f[Z],c?E=b[Z]:(V=jm.add(o,r,wj),jm.multiplyByScalar(V,.5,V),h.push(V.x,V.y,V.z),c=h.length/3-1,f[Z]=c,E=.5*(p+m),I.push(E),b[Z]=E,l&&(W=oA.add(_,x,wj),oA.multiplyByScalar(W,.5,W),u.push(W.x,W.y))),g.push(t,c,i),g.push(c,e,i)):R===T&&(Z=`${Math.min(e,i)} ${Math.max(e,i)}`,c=f[Z],c?E=b[Z]:(V=jm.add(r,n,wj),jm.multiplyByScalar(V,.5,V),h.push(V.x,V.y,V.z),c=h.length/3-1,f[Z]=c,E=.5*(m+d),I.push(E),b[Z]=E,l&&(W=oA.add(x,A,wj),oA.multiplyByScalar(W,.5,W),u.push(W.x,W.y))),g.push(e,c,t),g.push(c,i,t)):(C.push(i+s),C.push(t+s),C.push(e+s))}return{subdividedPositions:h,subdividedTexcoords:u,subdividedIndices:C,subdividedHeights:I}};class kj extends Fn{constructor(e){super(),__publicField(this,"isPolygonGeometry",!0),__publicField(this,"_useUV",!1),__publicField(this,"_useEarCut",!1),__publicField(this,"_sideUVNormalized",!1),__publicField(this,"_sideUVReversed",!1),__publicField(this,"_sideUVUseHeight",!1),__publicField(this,"_rectangle",null),__publicField(this,"triangulate",((e,t)=>{const i=e.reduce(((e,t)=>e.concat(t.toArray())),[]);return KQ.exports(i,t)})),__publicField(this,"addGeoPolygonToVertices",((e,t,i=0,n=0,s,o,r,a,l,g,c,d,h,u,I=!1)=>{let p=e.vertices;const m=e.dimensions;Array.isArray(c)||(c=Aj);let A=1/0,C=1/0,f=-1/0,b=-1/0;for(let B=0,w=p.length-m+1;B<w;B+=m)A=p[B]<A?p[B]:A,C=p[B+1]<C?p[B+1]:C,f=p[B]>f?p[B]:f,b=p[B+1]>b?p[B+1]:b;const y=new bt((f+A)/2,(b+C)/2),_=new Qt,v=new Qt;let x=[];for(let B=0;B<=t.length-m;B+=m){let e=[];for(let r=0;r<3;r++){const o=t[B+r]*m;let f;f=2===m||I&&!this.perPositionHeight?new Qt(p[o],p[o+1],i):new Qt(p[o],p[o+1],p[o+2]+i),e.push(f),s.push(f.x,f.y,f.z),g.push(c[0],c[1],c[2],c[3]),this._pushHeightAndConcave(u,i,-1),_S(Nj.set(p[o],p[o+1]),y,l),a.push(Nj.x-A,Nj.y-C),d.push(h),x.push(n+B+r)}let o=[0,0,1];2!==m&&(_.subVectors(e[2],e[1]),v.subVectors(e[0],e[1]),_.cross(v),_.normalize(),o=_.toArray()),r.push(...o,...o,...o)}I?o.push(...x.reverse()):o.push(...x)})),__publicField(this,"_encodeConcave",((e,t,i)=>{let n=0;return e&&(n|=1),t&&(n|=2),i&&(n|=4),n})),__publicField(this,"_pushHeightAndConcave",((e,t,i,n,s,o,r)=>{if(-1===i)return void e.push(t,this._encodeConcave(!1,!1,!1));const a=function(e,t,i){const n=[i[0]-t[0],i[1]-t[1]],s=[e[0]-t[0],e[1]-t[1]];return(n[0]*s[0]+n[1]*s[1])/Math.sqrt((n[0]*n[0]+n[1]*n[1])*(s[0]*s[0]+s[1]*s[1]))>-.866&&-n[1]*s[0]+n[0]*s[1]<0}(n,s,o),l=Array.isArray(e);0===i?l?e.push(0,this._encodeConcave(!1,a,!1),t,this._encodeConcave(!0,a,!1)):(e.bottom.push(0,this._encodeConcave(!0,a,!1)),e.top.push(t,this._encodeConcave(!1,a,!1))):i===r-1?l?e.push(t,this._encodeConcave(!1,a,!0),0,this._encodeConcave(!0,a,!0)):(e.bottom.push(0,this._encodeConcave(!0,a,!0)),e.top.push(t,this._encodeConcave(!1,a,!0))):l?e.push(t,this._encodeConcave(!1,a,!0),0,this._encodeConcave(!0,a,!0),0,this._encodeConcave(!0,a,!1),t,this._encodeConcave(!1,a,!1)):(e.bottom.push(0,this._encodeConcave(!0,a,!0),0,this._encodeConcave(!0,a,!1)),e.top.push(t,this._encodeConcave(!1,a,!0),t,this._encodeConcave(!1,a,!1)))})),__publicField(this,"_pushPosition",((e,t,i,n)=>{const s=this._calculateHeights(t,i,n);e.push(t[0],t[1],s.bottom,t[0],t[1],s.top,i[0],i[1],s.nextTop,i[0],i[1],s.nextBottom)})),__publicField(this,"_pushNormal",((e,t,i)=>{const n=this._calculateNormal(t,i);e.push(...n,...n,...n,...n)})),__publicField(this,"_pushUV",((e,t,i,n,s)=>{let o=0,r=0,a=i[0]-t[0],l=i[1]-t[1];const g=Math.sqrt(a*a+l*l);return this._sideUVUseHeight?(o=1*n,r=1*n):(o=0,r=1*n,this._sideUVNormalized&&(r=1),this._sideUVReversed&&(o=r,r=0)),e.push(1*s,o,1*s,r),s+=g,e.push(1*s,r,1*s,o),s})),__publicField(this,"_pushColor",((e,t,i=4)=>{for(let n=0;n<i;n++)e.push(t[0],t[1],t[2],t[3])})),__publicField(this,"_pushObjectIndex",((e,t)=>{e.push(t,t,t,t)})),__publicField(this,"addSideFace",((e,t,i,n,s,o,r,a,l,g,c,d)=>{let h=i;mj(e)&&e.reverse(),Array.isArray(l)||(l=Aj);const u=e.length;let I=0;for(let p=0,m=u;p<m;p++){let m=0===p?e.length-2:p-1,A=p===e.length-1?1:p+1,C=e[m],f=e[p],b=e[A];this._pushHeightAndConcave(d,t,p,C,f,b,u),p!==e.length-1&&(A=(p+1)%u,b=e[A],this._pushPosition(n,f,b,t),this._pushNormal(o,f,b),this._pushColor(a,l),this._pushObjectIndex(g,c),I=this._pushUV(r,f,b,t,I),h=i+4*p,s.push(h,h+2,h+1,h,h+3,h+2))}})),__publicField(this,"subdivideLineCount",((e,t,i)=>{const n=e.distanceTo(t)/i,s=Math.max(0,Math.ceil(Math.log2(n)));return Math.pow(2,s)})),__publicField(this,"subdivideLine",((e,t,i,n,s,o,r,a,l,g,c)=>{const d=this.subdivideLineCount(e,t,o),h=e.distanceTo(t),u=h/d;this.extrude&&this._extrudeValue;let I=jm.clone(e,new Qt),p=jm.clone(t,new Qt),m=new Qt,A=new Qt,C=i,f=n;const b=r.scaleToGeodeticSurface(I);r.geodeticSurfaceNormal(I,m);const y=r.scaleToGeodeticSurface(p);r.geodeticSurfaceNormal(p,A),C+=this._zOffset,f+=this._zOffset,this.extrude&&(C+=a,f+=a),jm.multiplyByScalar(m,C,m),jm.add(b,m,I),jm.multiplyByScalar(A,f,A),jm.add(y,A,p),g||(g=[]),c||(c=[]);const _=new Qt,v=new Qt;let x,B,w=[];x=r.cartesianToCartographic(I,v).z,B=r.cartesianToCartographic(p,v).z,w=((e,t,i)=>{const n=zj;n.length=e;let s=0;if(t===i){for(s=0;s<e;s++)n[s]=t;return n}const o=(i-t)/e;for(let r=0;r<e;r++){const e=t+r*o;n[r]=e}return n})(d,x,B);const S=Rj;let G=Tj,M=Vj,R=0,T=0;for(let Z=0;Z<d;Z++){const e=_.fromArray(Dj(I,p,u*Z,h));T=w[Z],r.geodeticSurfaceNormal(e,S),M=r.scaleToGeodeticSurface(e,M),G=jm.multiplyByScalar(S,this._zOffset+s,G),G=jm.add(M,G,G),c[R]=G.x,c[R+1]=G.y,c[R+2]=G.z,Z>0&&l.bottom.push(0,this._encodeConcave(!0,!1,!1)),this.perPositionHeight?(M=oA.clone(e,M),G=jm.clone(M,G)):(G=jm.multiplyByScalar(S,T,G),G=jm.add(M,G,G)),g[R]=G.x,g[R+1]=G.y,g[R+2]=G.z,Z>0&&l.top.push(a,this._encodeConcave(!0,!1,!1)),R+=3}return r.geodeticSurfaceNormal(p,S),M=r.scaleToGeodeticSurface(p,M),G=jm.multiplyByScalar(S,this._zOffset+s,G),G=jm.add(M,G,G),c[R]=G.x,c[R+1]=G.y,c[R+2]=G.z,this.perPositionHeight?G=oA.clone(p,G):(G=jm.multiplyByScalar(S,B,G),G=jm.add(M,G,G)),g[R]=G.x,g[R+1]=G.y,g[R+2]=G.z,{topPositions:g,bottomPositions:c}})),__publicField(this,"crossVectors3",((e,t)=>{const i=[];return i[0]=e[1]*t[2]-e[2]*t[1],i[1]=e[2]*t[0]-e[0]*t[2],i[2]=e[0]*t[1]-e[1]*t[0],i})),this.parameters=e,this._needsUpdate=!1,this._extrude=lm(e.extrude,!1),this._extrudeValue=lm(e.extrudeValue,0),this._enableBottomFace=lm(e.enableBottomFace,!1),this.perPositionHeight=lm(e.perPositionHeight,!1),this._zOffset=lm(e.zOffset,0),this.cachedPositions=[],this.cachedObjectIndices=[]}setData(e){this._needsUpdate=!0,this.cachedData=e,this.updateGeometry()}updateGeometry(){this.engine.map.isGlobe?this.updateGeometry3D():this.updateGeometryColumbus()}updateGeometry3D(){const e=this.cachedData,t=this.engine.map.map.ellipsoid||eA.WGS84,i=[],n=[],s=[],o=[],r=[],a=[];let l=0;const g=[],c=[],d=[],h=[],u=[],I=[];let p=0;const m=Rj;let A=Tj;const C=Zj;let f=Vj;for(let y=0;y<e.position.length;y++){const b=e.position[y];e.index[y];const _=this.parameters.vertexHeights?e.height[y]:this.extrudeValue,v=e.color?cy(e.color[y]):Aj,x=gS(b[0],!0),B=RU(x,t).map((e=>e)),w=0;if(x.length<3)continue;for(let e=0;e<x.length;e++){let i=x[e];t.scaleToGeodeticSurface(Cj.fromArray(i),fj),x[e]=fj.toArray()}const S=aV(x,t),G=lV(S,x,t),M=[];let R=Number.POSITIVE_INFINITY,T=Number.POSITIVE_INFINITY;R=Math.min(...G.map((e=>e.x))),T=Math.min(...G.map((e=>e.y)));for(let e=0;e<G.length;e++){const t=G[e],i=t.x-R,n=t.y-T;M.push(new bt(i,n))}const Z=this.triangulate(G),V=x.map((e=>new Qt(...e)));let W=this.parameters.granularity;const E=this.extrude&&this._enableBottomFace,N=!(this.extrude&&this.perPositionHeight),F=E||N,{subdividedPositions:X,subdividedTexcoords:H,subdividedIndices:z,subdividedHeights:L}=Pj(t,V,B,Z,l,M,W,F);let D=X.length;const K=r.length,Y=[];let P=0;if(N){for(let e=0;e<D;e+=3)C.fromArray(X,e),t.geodeticSurfaceNormal(C,m),f=t.scaleToGeodeticSurface(C,f),P=L[e/3],this.extrudeValue&&!this.perPositionHeight&&(P=0),A=jm.multiplyByScalar(m,this._zOffset+_+P,A),A=jm.add(f,A,A),Y[e]=A.x,Y[e+1]=A.y,Y[e+2]=A.z,r[e+K]=m.x,r[e+1+K]=m.y,r[e+2+K]=m.z,n.push(_,this._encodeConcave(!1,!1,!1));dj(i,Y),dj(s,z),dj(a,H)}else{for(let e=0;e<V.length;e++){const i=V[e],s=M[e];t.geodeticSurfaceNormal(i,m),r[3*e+K]=m.x,r[3*e+1+K]=m.y,r[3*e+2+K]=m.z,f=jm.clone(i,f),A=jm.multiplyByScalar(m,this._zOffset+B[e]+_,A),A=jm.add(f,A,A),Y[3*e]=A.x,Y[3*e+1]=A.y,Y[3*e+2]=A.z,n.push(_,this._encodeConcave(!1,!1,!1)),a.push(s.x,s.y)}i.push(...Y),s.push(...Z)}const k=r.length;if(E)for(let e=0;e<D;e+=3)C.fromArray(X,e),t.geodeticSurfaceNormal(C,m),f=t.scaleToGeodeticSurface(C,f),A=jm.multiplyByScalar(m,this._zOffset+w,A),A=jm.add(f,A,A),X[e]=A.x,X[e+1]=A.y,X[e+2]=A.z,r[e+k]=-m.x,r[e+1+k]=-m.y,r[e+2+k]=-m.z,n.push(0,this._encodeConcave(!0,!1,!1));let O=Y.length/3;if(this.extrude&&this._enableBottomFace&&(i.push(...X),O+=X.length/3),l+=O,this.extrude&&this._enableBottomFace){const e=[],t=Y.length/3,i=z.length-1;for(let n=0;n<=i;n++)e.push(z[n]+t);dj(a,H),dj(s,e.reverse())}if(dj(o,Array.from({length:O},(()=>v)).flat()),this.extrude){mj(G.map((e=>e.toArray())))&&(V.reverse(),G.reverse());const{edgePositions:e,edgeHeightAndConcaves:i,edgeIndices:n,edgeNormals:s,edgeUvs:o}=this.computeWallGeometry3D(V,G,t,Km.RADIANS_PER_DEGREE,p,_,B,w);g.push(...e),c.push(...i),d.push(...n),h.push(...s),u.push(...Array.from({length:e.length/3},(()=>v)).flat()),I.push(...o),p+=e.length/3}}const b=s.length;this.extrude&&(d.forEach(((e,t)=>d[t]=e+l)),dj(i,g),dj(n,c),dj(s,d),dj(r,h),dj(o,u),dj(a,I)),this.cachedPositions=i,this.setAttribute("position",new Mn(i,3)),this.setAttribute("heightAndConcave",new Mn(n,2)),this.parameters.vertexColors&&this.setAttribute("aColor",new Mn(o,4)),this.setAttribute("uv",new Mn(a,2)),this.setAttribute("normal",new Mn(r,3)),this.setIndex(s),this.clearGroups(),this.addGroup(0,b,1),this.extrude&&this.addGroup(b,s.length-b,0),this.computeBoundingSphere(),this._needsUpdate=!1}updateGeometryColumbus(){let e=this.cachedData,t=null,i=null;const n=[],s=[],o=[],r=[],a=[];let l=[];const g=[],c=[],d=[],h=[],u=[],I=[],p=[],m=[],A=e.position&&e.position.length||0;for(let y=0;y<A;y++){const A=e.position[y],C=e.index[y],f=e.color?cy(e.color[y]):Aj,_=this.parameters.vertexHeights?e.height[y]:this.extrudeValue,v=this._useUV&&e.uvRotation?e.uvRotation[y]:0;let x=!1;const B=A[0],w=hj(B),{indexMap:S,points:G}=Ij(B),M=pj(w,S);t=KQ.exports.flatten([G]);const R=uj(G,M);try{i=aj(G,M,{interior:!0,exterior:!1}).flat(),x=0===i.length,(x||this._useEarCut)&&(t=KQ.exports.flatten(A),i=KQ.exports(t.vertices,t.holes,t.dimensions))}catch(b){i=KQ.exports(t.vertices,t.holes,t.dimensions)}this.extrude&&this._enableBottomFace&&this.addGeoPolygonToVertices(t,i,this._zOffset,n.length/3,n,l,s,o,v,g,f,r,C,a,!0),this.addGeoPolygonToVertices(t,i,this._zOffset+_,n.length/3,n,l,s,o,v,g,f,r,C,a),this.extrude&&_>0&&this.addSideFace(R,_,c.length/3,c,m,d,h,p,f,u,C,I)}const C=l.length;let f=n.length/3;for(let y=0;y<m.length;y++)m[y]+=f;dj(n,c),dj(s,d),dj(g,p),dj(o,h),dj(a,I),dj(l,m),this.cachedPositions=n,this.cachedObjectIndices=r,this.setAttribute("position",new Mn(n,3)),this.parameters.vertexColors&&this.setAttribute("aColor",new Mn(g,4)),this._useUV?this.setAttribute("uv",new Mn(o,2)):this.deleteAttribute("uv"),this.setAttribute("heightAndConcave",new Mn(a,2)),this.setAttribute("normal",new Mn(s,3)),this.setIndex(l),this.clearGroups(),this.addGroup(0,C,1),this.extrude&&this.addGroup(C,l.length-C,0),this.computeBoundingSphere(),this._needsUpdate=!1}_calculateHeights(e,t,i){const[n,s]=[e[2]||0,t[2]||0],o=this._zOffset||0,r=this.perPositionHeight;return{bottom:o+(r?n:0),nextBottom:o+(r?s:0),top:n+o+i,nextTop:s+o+i}}_calculateNormal(e,t){const i=t[0]-e[0],n=t[1]-e[1],s=Math.hypot(i,n);return[n/s,-i/s,0]}computeWallGeometry3D(e,t,i,n,s,o,r,a){let l,g,c,d,h,u=e.length;const I=Km.chordLength(n,i.maximumRadius);let p=0;for(c=0;c<u;c++)p+=this.subdivideLineCount(e[c],e[(c+1)%u],I);const m=p+u;g=3*m,l=new Array(2*g);const A=[],C=[],f={bottom:[],top:[]};let b=0,y=0;for(c=0;c<u+1;c++){d=e[c],h=e[(c+1)%u],this.perPositionHeight&&(b=r[c],y=r[(c+1)%u]);let n=c===u?0:c,s=c===u-1?0:n+1;if(t[0===c?u-1:c-1].toArray(Fj),t[n].toArray(Xj),t[s].toArray(Hj),this._pushHeightAndConcave(f,o,c,Fj,Xj,Hj,u+1),c===u)continue;const{topPositions:l,bottomPositions:g}=this.subdivideLine(d,h,b,y,a,I,i,o,f);A.push(...g),C.push(...l)}l=[...A,...A];const _=[...f.top,...f.bottom];u=l.length;let v=[],x=0;for(u/=6,c=0;c<u;c++){const e=c,t=e+1,i=e+u,n=i+1;d=Kj.fromArray(l,3*e),h=Yj.fromArray(l,3*t),jm.equalsEpsilon(d,h,Km.EPSILON10,Km.EPSILON10)||(v[x++]=e+s,v[x++]=i+s,v[x++]=t+s,v[x++]=t+s,v[x++]=i+s,v[x++]=n+s)}l=[...C,...A],u=C.length/3;const B=[];B.length=l.length;const w=[];w.length=4*u;let S=new Qt,G=new Qt,M=new Qt,R=!0,T=new Qt;const Z=[];let V=0;for(c=0;c<m;c++){S.fromArray(C,3*c),G.fromArray(A,3*c),M.fromArray(C,3*(c+1));const e=i.cartesianToCartographic(S).z,t=i.cartesianToCartographic(G).z;let n=2*c,s=2*(c+g/3);if(void 0===M.x?(w[n]=V,w[n+1]=e,w[s]=V,w[s+1]=t):(Z.push(S.distanceTo(M)),w[n]=V,w[n+1]=e,w[s]=V,w[s+1]=t,V+=Z[c]),(jm.equalsEpsilon(S,M,Km.EPSILON10)||c===m-1)&&(R=!1),R){const e=jm.subtract(M,S,Ej),t=jm.subtract(G,S,Wj);T=jm.normalize(jm.cross(t,e,T),T)}let o=3*c,r=3*c+g;B[o]=T.x,B[o+1]=T.y,B[o+2]=T.z,B[r]=T.x,B[r+1]=T.y,B[r+2]=T.z,R=!0}return{edgePositions:l,edgeIndices:v,edgeNormals:B,edgeUvs:w,edgeHeightAndConcaves:_,totalDistance:Array.from({length:2*m},(()=>V))}}get extrude(){return this._extrude}set extrude(e){const t=!!e;t!==this._extrude&&(this._extrude=t,this._needsUpdate=!0)}get extrudeValue(){return this._extrudeValue}set extrudeValue(e){!isNaN(e)&&e>=0&&e!==this._extrudeValue&&(this._extrudeValue=e,this._needsUpdate=!0)}get sideUVNormalized(){return this._sideUVNormalized}set sideUVNormalized(e){e!==this._sideUVNormalized&&(this._extrude&&(this._needsUpdate=!0),this._sideUVNormalized=e)}get sideUVReversed(){return this._sideUVReversed}set sideUVReversed(e){e!==this._sideUVReversed&&(this._extrude&&(this._needsUpdate=!0),this._sideUVReversed=e)}get sideUVUseHeight(){return this._sideUVUseHeight}set sideUVUseHeight(e){e!==this._sideUVUseHeight&&(this._extrude&&(this._needsUpdate=!0),this._sideUVUseHeight=e)}get useUV(){return this._useUV}set useUV(e){e!==this._useUV&&(this._needsUpdate=!0,this._useUV=e)}get needsUpdate(){return this._needsUpdate}set needsUpdate(e){this._needsUpdate=e}set useEarCut(e){this._useEarCut!==e&&(this._useEarCut=e)}}const Oj=new Dl,Uj=as.merge([ws.fog,ws.lights,Ay,my,{isEmissive:{value:!1},opacity:{value:1},color:{value:[0,1,1]},vertexColors:{value:!1},map:{value:void 0},mapLength:{value:new bt},mapSrc:{value:""},mapScale:{value:1},normalOffset:{value:0},concaveIntensity:{value:.2},heightIntensity:{value:.4}}]);class Qj extends mx{constructor(e){super(),this.name="PolygonMaterial",this.isPolygonMaterial=!0,this.lights=!0,this.fog=!0,this.fragmentShader="#define GLSLIFY 1\n#include <common>\n\n#ifdef USE_MAP\n    varying vec2 vUv;\n    uniform sampler2D map;\n    uniform vec2 mapLength;\n#else\n    #ifdef MVT_USE_VERTEX_COLOR\n        varying vec4 vColor;\n    #else\n        uniform vec3 color;\n    #endif\n#endif\n\nuniform float opacity;\n\n#ifdef USE_AO\nuniform float concaveIntensity;\nuniform float heightIntensity;\n\nvarying float v_concave;\nvarying float v_ground;\nvarying float v_h;\n#endif\n\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <mvt_selective_pars_fragment>\n\nvoid main() {\n    #ifdef USE_MAP\n        gl_FragColor = texture2D(map, vec2(mod(vUv.x, mapLength.x) / mapLength.x, mod(vUv.y, mapLength.y) / mapLength.y));\n    #else\n        #ifdef MVT_USE_VERTEX_COLOR\n            gl_FragColor = vColor;\n        #else\n            gl_FragColor = vec4(color, 1.0);\n        #endif\n    #endif\n\n    gl_FragColor.a *= opacity;\n    if (gl_FragColor.a <= 0.) {\n        discard;\n    }\n\n    #if ( NUM_DIR_LIGHTS > 0 )\n        // 根据方向光的方向与法向，来计算颜色衰减程度，值范围为-1~1，给重映射到0.8~1的范围\n        float normalLightIntensity = dot(vNormal, directionalLights[0].direction);\n        gl_FragColor = vec4(gl_FragColor.rgb * (normalLightIntensity / 10.0 + 0.9), gl_FragColor.a);\n    #endif\n\n    #ifdef OPAQUE\n        gl_FragColor.a = 1.0;\n    #endif\n\n    #ifdef USE_AO\n    float ao_shade = 1.0;\n    float concave = v_concave * v_concave;\n    float intensity = concaveIntensity;\n    float x_shade = mix(1.0, mix(0.6, 0.75, min(0.01, 1.0)), intensity) + 0.1 * intensity;\n    ao_shade *= mix(1.0, x_shade * x_shade * x_shade, concave);\n\n    intensity = heightIntensity;\n    float h_floors = v_h / 3.0;\n    float y_shade = 1.0 - 0.9 * intensity * min(v_ground, 1.0);\n    ao_shade *= (1.0 - 0.08 * intensity) * (y_shade + (1.0 - y_shade) * (1.0 - pow(1.0 - min(h_floors / 16.0, 1.0), 16.0))) + 0.08 * intensity * min(h_floors / 160.0, 1.0);\n\n    gl_FragColor.rgb *= ao_shade;\n    #endif\n\n    #include <mvt_selective_fragment>\n    #include <fog_fragment>\n    #include <logdepthbuf_fragment>\n    #include <tonemapping_fragment>\n    #include <colorspace_fragment>\n    \n}\n\n",this.vertexShader="#define GLSLIFY 1\n#include <common>\n#include <fog_pars_vertex>\n\n#ifdef USE_MAP\n    varying vec2 vUv;\n    uniform float mapScale;\n#else\n    #ifdef MVT_USE_VERTEX_COLOR\n        attribute vec4 aColor;\n        varying vec4 vColor;\n    #endif\n#endif\n\nuniform float normalOffset;\n\n#ifdef USE_AO\nattribute vec2 heightAndConcave;\n\nvarying float v_concave;\nvarying float v_h;\nvarying float v_ground;\n#endif\n\n#include <normal_pars_vertex>\n\n#include <logdepthbuf_pars_vertex>\n#include <mvt_selective_pars_vertex>\n\nvoid main() {\n\n    #include <mvt_selective_vertex>\n\n    #ifdef USE_MAP\n        vUv = uv / mapScale;\n    #else\n        #ifdef MVT_USE_VERTEX_COLOR\n            vColor = aColor;\n        #endif\n    #endif\n\n    #include <begin_vertex>\n\n    #include <beginnormal_vertex>\n    #include <defaultnormal_vertex>\n    #include <normal_vertex>\n\n    vec4 viewCoord = modelViewMatrix * vec4( transformed, 1.0 );\n    viewCoord.xyz += normalize(transformedNormal) * 0.0;\n\n    #ifdef USE_AO\n    v_h = heightAndConcave.x;\n    float encodeConcave = heightAndConcave.y;\n    v_ground = mod(encodeConcave, 2.0);\n    float concave = mod(floor(encodeConcave * 0.5), 2.0);\n    float start = mod(floor(encodeConcave * 0.25), 2.0);\n    concave = pow(concave, 2.2);\n    v_concave = mix(concave, -concave, start);\n    #endif\n\n    gl_Position = projectionMatrix * viewCoord;\n    #include <fog_vertex>\n    #include <logdepthbuf_vertex>\n\n}\n\n",Object.defineProperty(this,"mapSrc",{get:function(){return this.uniforms.map.value},set:function(e){const t=this.mapSrc,i=this.userData[this.urlCacheKey],n=this;if(i!==e){if(t&&t.dispose(),!e)return this.uniforms.map.value=null,delete this.defines.USE_MAP,void delete this.userData[this.urlCacheKey];Oj.load(e,(function(t){t.colorSpace=Ye,n.uniforms.map.value=t,n.uniforms.mapLength.value=new bt(t.image.naturalWidth,t.image.naturalHeight),n.userData[n.urlCacheKey]=e,n.defines.USE_MAP=!0,n.needsUpdate=!0}))}}}),Object.assign(this.uniforms,as.clone(Uj)),e.mapSrc&&(this.mapSrc=e.mapSrc,delete e.mapSrc),fy(this,["opacity","mapScale","isEmissive","normalOffset","concaveIntensity","heightIntensity"]),by(this,["color"]),_y(this,[["vertexColors","MVT_USE_VERTEX_COLOR"],["useAO","USE_AO"]]),vy(this),By(this),this.emissiveEnabled=!0,this.emissive=[0,0,0],this.setValues(e)}dispose(){this.uniforms.map.value&&this.uniforms.map.value.dispose(),super.dispose()}}const Jj=new Dl,jj=as.merge([ws.fog,ws.lights,Ay,my,{isEmissive:{value:!1},opacity:{value:1},color:{value:new Qt(1,1,1)},vertexColors:{value:!1},useNormal:{value:!1},map:{value:void 0},mapLength:{value:new bt},mapSrc:{value:""},mapScale:{value:1},normalOffset:{value:0},rectBounds:{value:new Dt(0,0,0,0)},inverseProjection:{value:new Bi},depthTexture:{value:null},cameraNear:{value:0},cameraFar:{value:0},viewInverseMatrix:{value:new Bi},cameraProjectionMatrix:{value:new Bi}}]);class qj extends mx{constructor(e){super(),this.name="ShadowVolumeMaterial",this.isShadowMaterial=!0,this.lights=!0,this.fog=!0,this.fragmentShader="#define GLSLIFY 1\n#include <common>\n\n#include <packing>\n\nvarying vec4 vSouthWestCorner;\nvarying vec2 vInversePlaneExtents;\nuniform mat4 inverseProjection;\nuniform sampler2D depthTexture;\nuniform vec2 resolution;\nuniform float cameraNear;\nuniform float cameraFar;\nuniform mat4 viewInverseMatrix;\nuniform float pixelRatio;\n\n#ifdef USE_MAP\n    uniform sampler2D map;\n#endif\n\nfloat linearize_depth(in float depth, in float cameraNear, in float cameraFar){\n    float a = cameraFar / (cameraFar - cameraNear);\n    float b = cameraFar * cameraNear / (cameraNear - cameraFar);\n    return a + b / depth;\n}\n\nfloat reconstruct_depth(sampler2D tDepth, const in vec2 uv, in float cameraNear, in float cameraFar){\n    float depth = texture2D(tDepth, uv).x;\n    return pow(2.0, depth * log2(cameraFar + 1.0)) - 1.0;\n}\n\nfloat getDepthFromTexture(sampler2D tDepth, vec2 uv) {\n    #if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n        return linearize_depth(reconstruct_depth(tDepth, uv, cameraNear, cameraFar), cameraNear, cameraFar);\n    #else\n        return texture2D(tDepth, uv).x;\n    #endif\n}\n\nvec3 getWorldPositionFromDepth(float depth, vec2 vUV) {\n    float z = depth * 2.0 - 1.0;\n    vec4 clipSpacePosition = vec4(vUV * 2.0 - 1.0, z, 1.0);\n\n    vec4 viewSpacePosition = inverseProjection * clipSpacePosition;\n    \n    vec4 worldSpacePosition = viewInverseMatrix * viewSpacePosition;\n\n    return worldSpacePosition.xyz / worldSpacePosition.w;\n}\n\n#ifdef USE_NORMAL\n\n    vec3 vectorFromOffset(vec3 worldCoordinate, vec2 positiveOffset) {\n        vec2 glFragCoordXY = gl_FragCoord.xy;\n        // Sample depths at both offset and negative offset\n        float upOrRightLogDepth = getDepthFromTexture(depthTexture, (glFragCoordXY + positiveOffset) / resolution.xy / pixelRatio);\n        float downOrLeftLogDepth = getDepthFromTexture(depthTexture, (glFragCoordXY - positiveOffset) / resolution.xy / pixelRatio);\n        // Explicitly evaluate both paths\n        // Necessary for multifrustum and for edges of the screen\n        bvec2 upOrRightInBounds = lessThan(glFragCoordXY + positiveOffset, resolution.xy * pixelRatio);\n        float useUpOrRight = float(upOrRightLogDepth > 0.0 && upOrRightInBounds.x && upOrRightInBounds.y);\n        float useDownOrLeft = float(useUpOrRight == 0.0);\n\n        vec3 upOrRightEC = getWorldPositionFromDepth(upOrRightLogDepth, (glFragCoordXY + positiveOffset) / resolution.xy / pixelRatio);\n        vec3 downOrLeftEC = getWorldPositionFromDepth(downOrLeftLogDepth, (glFragCoordXY - positiveOffset) / resolution.xy / pixelRatio);\n        return (upOrRightEC - worldCoordinate.xyz) * useUpOrRight + (worldCoordinate.xyz - downOrLeftEC) * useDownOrLeft;\n    }\n\n#endif\n\n#ifdef MVT_USE_VERTEX_COLOR\n    varying vec4 vColor;\n#else\n    uniform vec3 color;\n#endif\n\nuniform float opacity;\n\n// 模拟glDepthClamp\n#if !defined( USE_LOGDEPTHBUF )\nvarying float vWindowZ;\n\nvoid writeDepthClamp() {\n    \n    gl_FragDepthEXT = clamp(vWindowZ * gl_FragCoord.w, 0.0, 1.0);\n    \n}\n#endif\n\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <mvt_selective_pars_fragment>\n\nvoid main() {\n    vec2 coordUV = gl_FragCoord.xy / resolution / pixelRatio;\n    float depth = getDepthFromTexture(depthTexture, coordUV);\n    vec3 worldCoordinate = getWorldPositionFromDepth(depth, coordUV);\n\n    #ifdef MVT_USE_VERTEX_COLOR\n        gl_FragColor = vColor;\n    #else\n        gl_FragColor = vec4(color, 1.0);\n    #endif\n\n    #ifdef USE_MAP\n\n        vec2 fragUv = vec2(0.0);\n        fragUv.x = (worldCoordinate.x - vSouthWestCorner.x) * vInversePlaneExtents.x;\n        fragUv.y = (worldCoordinate.y - vSouthWestCorner.y) * vInversePlaneExtents.y;\n\n        vec4 mapColor = texture2D(map, fragUv);\n\n        vec3 fragColor = vec3(0.0);\n        #ifdef MVT_USE_VERTEX_COLOR\n            mapColor *= vColor;\n        #else\n            mapColor *= vec4(color, 1.0);\n        #endif\n\n        gl_FragColor = mapColor;\n    #endif\n\n    #ifdef USE_NORMAL\n        // Compute normal by sampling adjacent pixels in 2x2 block in screen space\n        vec3 downUp = vectorFromOffset(worldCoordinate, vec2(0.0, 1.0));\n        vec3 leftRight = vectorFromOffset(worldCoordinate, vec2(1.0, 0.0));\n        vec3 normalWC = normalize(cross(leftRight, downUp));\n    #endif\n\n    gl_FragColor.a *= opacity;\n    if (gl_FragColor.a <= 0.) {\n        discard;\n    }\n\n    #ifdef OPAQUE\n        gl_FragColor.a = 1.0;\n    #endif\n\n    #if !defined( USE_LOGDEPTHBUF ) \n        vFragDepth = writeDepthClamp();\n    #endif\n\n    #include <mvt_selective_fragment>\n    #include <fog_fragment>\n    #include <logdepthbuf_fragment>\n    #include <tonemapping_fragment>\n    #include <colorspace_fragment>\n\n}",this.vertexShader="#define GLSLIFY 1\n#include <common>\n#include <fog_pars_vertex>\n\n#ifdef USE_MAP\n    varying vec4 vSouthWestCorner;\n    varying vec2 vInversePlaneExtents;\n\n    uniform float mapScale;\n    uniform vec4 rectBounds;\n#else\n    #ifdef MVT_USE_VERTEX_COLOR\n        attribute vec4 aColor;\n        varying vec4 vColor;\n    #endif\n#endif\n\nuniform float normalOffset;\n\n#include <normal_pars_vertex>\n\n#include <logdepthbuf_pars_vertex>\n#include <mvt_selective_pars_vertex>\n\n// 模拟glDepthClamp,解决ZFail的远平面被视锥体所裁剪的问题\n#if !defined( USE_LOGDEPTHBUF )\n    varying float vWindowZ;\n#endif\n\nvec4 depthClamp(vec4 coords) {\n    #if !defined( USE_LOGDEPTHBUF )\n        vWindowZ = (0.5 * (coords.z / coords.w) + 0.5) * coords.w;\n\n        coords.z = 0.0; \n    #else \n        coords.z = min(coords.z, coords.w);\n    #endif\n\n    return coords;\n}\n\nvoid main() {\n\n    #include <mvt_selective_vertex>\n\n    #ifdef USE_MAP\n        float eastExtend = rectBounds.z - rectBounds.x;\n        float northExtend = rectBounds.w - rectBounds.y;\n\n        vInversePlaneExtents = vec2(1.0 / eastExtend, 1.0 / northExtend);\n        vSouthWestCorner = modelMatrix * vec4(rectBounds.xy, 0.0, 1.0);\n    #else\n        #ifdef MVT_USE_VERTEX_COLOR\n            vColor = aColor;\n        #endif\n    #endif\n\n    #include <begin_vertex>\n\n    #include <beginnormal_vertex>\n    #include <defaultnormal_vertex>\n    #include <normal_vertex>\n\n    vec4 viewCoord = modelViewMatrix * vec4( transformed, 1.0 );\n    viewCoord.xyz += normalize(transformedNormal) * normalOffset;\n\n    gl_Position = projectionMatrix * viewCoord;\n    #include <fog_vertex>\n    #include <logdepthbuf_vertex>\n\n    gl_Position = depthClamp(gl_Position);\n\n}",Object.defineProperty(this,"mapSrc",{get:function(){return this.uniforms.map.value},set:function(e){const t=this.mapSrc,i=this.userData[this.urlCacheKey],n=this;if(i!==e){if(t&&t.dispose(),!e)return this.uniforms.map.value=null,delete this.defines.USE_MAP,void delete this.userData[this.urlCacheKey];Jj.load(e,(function(t){t.colorSpace=Ye,n.uniforms.map.value=t,n.uniforms.mapLength.value=new bt(t.image.naturalWidth,t.image.naturalHeight),n.userData[n.urlCacheKey]=e,n.defines.USE_MAP=!0,n.needsUpdate=!0}))}}}),Object.assign(this.uniforms,as.clone(jj)),e.mapSrc&&(this.mapSrc=e.mapSrc,delete e.mapSrc),fy(this,["opacity","mapScale","isEmissive","normalOffset","rectBounds"]),by(this,["color"]),_y(this,[["vertexColors","MVT_USE_VERTEX_COLOR"],["useNormal","USE_NORMAL"]]),vy(this),By(this),this.emissiveEnabled=!0,this.emissive=[0,0,0],this.setValues(e)}dispose(){this.uniforms.map.value&&this.uniforms.map.value.dispose(),super.dispose()}}const $j={};class eq extends cx{constructor(e={}){super(),__publicField(this,"isEventEntitySupported",!0),__publicField(this,"geometry"),__publicField(this,"material"),__publicField(this,"extrude"),__publicField(this,"extrudeValue"),__publicField(this,"color"),__publicField(this,"vertexColors"),__publicField(this,"emissive"),__publicField(this,"opacity"),__publicField(this,"mapSrc"),__publicField(this,"mapScale"),this.isPolygon=!0,this.parameters=e,this._nearScale=e.nearScale||5,this.isGroundPrimitive=e.isGroundPrimitive,this.isDynamic=e.isDynamic||!1,this.needReMapUv=this.isGroundPrimitive,this.excludeElements=e.excludeElements||[],this._sharedResourcesId=this.getSharedResourceFromExcludeElement(this.excludeElements),this.renderOrder=e.renderOrder||0,this.defineGeometryProxyProperties(["extrude","extrudeValue","vertexHeights","enableBottomFace","zOffset","perPositionHeight"]),this.defineMaterialProxyProperties(["transparent","opacity","color","vertexColors","emissive","mapSrc","mapScale","side","depthWrite","colorWrite","stencilWrite","stencilFunc","stencilZFail","stencilZPass","normalOffset","useNormal","useAO","concaveIntensity","heightIntensity"])}initObject(){const{extrude:e,extrudeValue:t,vertexHeights:i,enableBottomFace:n,zOffset:s,...o}=this.parameters;(this.geometry=new kj(this.parameters)).engine=this.engine;let r=null;if(this.isGroundPrimitive){if(r=this.material=new qj(o),this.needReMapUv){const e=this._sharedResourcesId,t=$j[e];if(t){const{depthTexture:e,depthRenderTarget:i}=t;t.refCount++,this.depthRenderTarget=i,r.uniforms.depthTexture.value=e}else{const t=this.engine.rendering.resolution,i=this.engine.rendering.pixelRatio,n=this.depthRenderTarget=new Yt(t.x*i,t.y*i),s=new ta;s.type=O,n.depthTexture=s,r.uniforms.depthTexture.value=s,$j[e]={depthRenderTarget:n,depthTexture:s,refCount:1,lastRenderFrame:-1}}}}else r=this.material=new Qj(o);r.setCommonUniforms(this.engine.rendering.uniforms)}onBeforeSceneRenderHook(e,t,i,n){if(!this.needReMapUv)return;const s=n.frameCount,o=$j[this._sharedResourcesId];if(o){if(o.lastRenderFrame!==s){const n=e.renderer;n.setRenderTarget(this.depthRenderTarget);let s=[];t.traverse((e=>{(e.isGroundPrimitive||this.excludeElements.includes(e))&&(e.originVisible=e.visible,e.visible=!1,s.push(e))}));let o=i.near;i.near=o*this.nearScale,i.updateProjectionMatrix(),n.render(t,i);for(let e=0;e<s.length;e++)s[e].visible=s[e].originVisible;this.material.uniforms.cameraNear.value=i.near,this.material.uniforms.cameraFar.value=i.far,this.material.uniforms.viewInverseMatrix.value.copy(i.matrixWorld),this.material.uniforms.pixelRatio.value=e.rendering.pixelRatio,this.material.uniforms.inverseProjection.value.copy(i.projectionMatrixInverse.clone()),i.near=o,i.updateProjectionMatrix(),n.setRenderTarget(null)}else{let t=i.near;i.near=t*this.nearScale,i.updateProjectionMatrix(),this.material.uniforms.cameraNear.value=i.near,this.material.uniforms.cameraFar.value=i.far,this.material.uniforms.viewInverseMatrix.value.copy(i.matrixWorld),this.material.uniforms.pixelRatio.value=e.rendering.pixelRatio,this.material.uniforms.inverseProjection.value.copy(i.projectionMatrixInverse.clone()),i.near=t,i.updateProjectionMatrix()}o.lastRenderFrame=s}}_updateData(){let e=this.dataSource.data;if(this.geometry.setData(e),this.geometry.computeBoundingSphere(),this.makeGeometryOffsetPosition(this.geometry,this.geometry.cachedPositions),this.geometry.computeBoundingSphere(),this.geometry.computeBoundingBox(),this.needsUpdate=!1,this.needReMapUv){const e=this.computeRectangleBounds();this.material.rectBounds.fromArray(e)}this.needsUpdate=!1}computeRectangleBounds(){const e=this.geometry.attributes.position.array,t=e.length;let i=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;for(let r=0;r<t;r+=3){const t=e[r],a=e[r+1];i=Math.min(i,t),s=Math.min(s,a),n=Math.max(n,t),o=Math.max(o,a)}return[i,s,n,o]}afterGeometryUpdate(){this.makeGeometryOffsetPosition(this.geometry,this.geometry.cachedPositions),this.geometry.computeBoundingSphere(),this.geometry.computeBoundingBox()}getEntityIndexByFace(e,t){return this.geometry.cachedObjectIndices[t]}getSharedResourceFromExcludeElement(e){let t="";if(e.length>0){t=e.map((e=>e.uuid)).join("-")}return t}dispose(){if(this.needReMapUv){const e=$j[this._sharedResourcesId];if(e&&(e.refCount--,0===e.refCount)){const{depthRenderTarget:t,depthTexture:i}=e;t.dispose(),i.dispose(),delete $j[this._sharedResourcesId]}}super.dispose()}get nearScale(){return this._nearScale}set nearScale(e){this._nearScale=e}}eq.prototype.raycast=ts.prototype.raycast,eq.prototype._computeIntersections=ts.prototype._computeIntersections,eq.prototype.getVertexPosition=ts.prototype.getVertexPosition,function(e,t){if(s[e])return;const i=t||document,n=document.createElement("style");n.type="text/css",n.innerHTML=e;const o=i.getElementsByTagName("head")[0];try{o.appendChild(n),s[e]=!0}catch(pb){}}('.mapv-widgets-pane{position:absolute;z-index:15;bottom:0;left:0;right:0}.mapv-widgets-pane .bottom-right-anchor{position:absolute;width:52px;bottom:40px;right:20px}.mapv-widgets-pane .bottom-left-anchor{position:absolute;bottom:60px;left:20px}.mapv-widgets-pane .compass{width:52px;height:54px;margin-top:10px;visibility:visible;position:relative;background-size:266px;background-repeat:no-repeat;background-position:0 0}.mapv-widgets-pane .compass .compass-up{position:absolute;left:20px;margin:2px;width:8px;height:8px;fill:#000;cursor:pointer}.mapv-widgets-pane .compass .compass-up:hover{fill:#2c82ff}.mapv-widgets-pane .compass .compass-down{position:absolute;left:20px;bottom:2px;margin:2px;width:8px;height:8px;fill:#000;cursor:pointer}.mapv-widgets-pane .compass .compass-down:hover{fill:#2c82ff}.mapv-widgets-pane .compass .compass-left{cursor:pointer;position:absolute;top:5px;left:2px;width:15px;height:42px;background-size:266px;background-repeat:no-repeat;background-position:-75px -5px}.mapv-widgets-pane .compass .compass-left:hover{background-position:-89px -5px}.mapv-widgets-pane .compass .compass-right{cursor:pointer;position:absolute;top:5px;right:2px;width:15px;height:42px;background-size:266px;background-repeat:no-repeat;background-position:-75px -5px;transform:rotateY(180deg);-ms-transform:rotateY(180deg);-webkit-transform:rotateY(180deg);-o-transform:rotateY(180deg);-moz-transform:rotateY(180deg)}.mapv-widgets-pane .compass .compass-right:hover{background-position:-89px -5px}.mapv-widgets-pane .compass .compass-center{cursor:pointer;position:absolute;top:11px;left:19px;width:14px;height:32px;background-size:266px;background-repeat:no-repeat;background-position:-56px -10px;transform:rotate(0)}.mapv-widgets-pane .zoom{width:26px;height:54px;visibility:visible;margin-left:13px;margin-top:10px}.mapv-widgets-pane .zoom .zoom-add{cursor:pointer;width:26px;height:26px;background-color:#fff;border-bottom:1px solid #ccc;border-radius:2px 2px 0 0;background-position:0 0}.mapv-widgets-pane .zoom .zoom-add:hover .zoom-add-tag{background-position:20px 0}.mapv-widgets-pane .zoom .zoom-add-tag{position:absolute;width:10px;height:10px;margin:8px;background-size:40px 10px}.mapv-widgets-pane .zoom .zoom-sub{cursor:pointer;width:26px;height:26px;background-color:#fff;border-bottom:1px solid #ccc;border-radius:0 0 2px 2px}.mapv-widgets-pane .zoom .zoom-sub:hover .zoom-sub-tag{background-position:10px 0}.mapv-widgets-pane .zoom .zoom-sub-tag{position:absolute;width:10px;height:10px;margin:8px;background-size:40px 10px;background-position:-10px 0}.mapv-widgets-pane .scale{position:absolute;bottom:10px;left:100px;visibility:visible;width:90px;height:26px}.mapv-widgets-pane .scale .scale-text{width:100%;font-size:10px;text-align:center;user-select:none;transition:width .3s}.mapv-widgets-pane .scale .scale-line{position:relative;width:100%;height:8px;user-select:none}.mapv-widgets-pane .scale .scale-line-mid{position:absolute;left:2px;right:2px;top:3px;bottom:2px;background-color:#333;overflow:hidden}.mapv-widgets-pane .scale .scale-line-left{position:absolute;width:2px;height:8px;background-color:#333;overflow:hidden}.mapv-widgets-pane .scale .scale-line-right{position:absolute;width:2px;height:8px;background-color:#333;overflow:hidden;right:0}.mapv-widgets-pane .drawer{position:absolute;right:31px;bottom:164px;margin:2px;cursor:pointer}.mapv-widgets-pane .drawer .drawer-btn{background-color:#fff;padding:5px 5px 0;border-radius:2px}.mapv-widgets-pane .drawer .drawer-btn:hover{background-color:#f3f3f3}.mapv-widgets-pane .drawer .drawer-icon{height:16px;width:16px;fill:#797979}.mapv-widgets-pane .drawer .drawer-list{position:absolute;right:32px;top:0;display:none;list-style:none;background-color:#fff;box-shadow:0 0 20px #00000026;white-space:nowrap;border-radius:2px}.mapv-widgets-pane .drawer .drawer-item{display:flex;align-items:center;padding:0 16px;height:24px;line-height:24px}.mapv-widgets-pane .drawer .drawer-item-check{margin:0}.mapv-widgets-pane .drawer .drawer-item-name{margin-left:6px;font-size:12px}.mapv-widgets-pane .drawer .drawer-arrow{width:0;height:0;border-width:4px;border-style:solid;border-color:transparent transparent transparent #fff;position:absolute;top:11px;right:-7px}.mapv-widgets-pane .mouse-location{position:absolute;bottom:10px;right:20px;visibility:visible;padding:2px 6px;background-color:#fff;font-size:14px;border-radius:2px}.mapv-widgets-pane .logo{position:absolute;width:81px;height:27px;bottom:10px;left:5px;visibility:visible}.mapv-widgets-pane .geo-locate{background-color:#fff;width:26px;visibility:visible;cursor:pointer;border-bottom:1px solid #ccc;height:26px}.mapv-widgets-pane .fullscreen{background-color:#fff;height:26px;width:26px;visibility:visible;cursor:pointer;border-bottom:1px solid #ccc}.mapv-widgets-pane .export-image{background-color:#fff;width:26px;visibility:visible;cursor:pointer;border-bottom:1px solid #ccc;height:26px}.mapv-widgets-pane .geo-locate:hover .widgets-group-svg,.mapv-widgets-pane .fullscreen:hover .widgets-group-svg,.mapv-widgets-pane .export-image:hover .widgets-group-svg{fill:#2c82ff}.mapv-widgets-pane .widgets-group-svg{margin:5px;height:16px;width:16px;fill:#999}.mapv-overlay-pane{position:absolute;z-index:10}.mapv-overlay-pane .mapv-popup{width:200px;height:110px}.mapv-overlay-pane .mapv-popup .frame{width:198px;height:98px;background:white;border-radius:4px;border:1px solid #e6e1e1}.mapv-overlay-pane .mapv-popup .title{height:30px;border-bottom:1px solid #e6e1e1;line-height:30px;padding-left:10px;font-size:18px;font-weight:500}.mapv-overlay-pane .mapv-popup .close{width:20px;height:31px;position:absolute;font-size:20px;text-align:center;right:5px;cursor:pointer}.mapv-overlay-pane .mapv-popup .triangle{width:0;height:0;border-top:10px solid white;border-left:12px solid transparent;border-right:12px solid transparent;margin-left:88px}.mapv-overlay-pane .mapv-popup .content{padding:5px}.mapv-dom-points{position:absolute;z-index:10;user-select:none}.mapv-measure-pane{display:inline-block;position:absolute;height:30px;border-radius:5px;padding:0 5px;line-height:30px;background-color:#797774;color:#fff;transform:translate(-50%,-130%);overflow:visible;white-space:nowrap}.mapv-measure-pane:after{content:"";position:absolute;width:0;height:0;left:50%;bottom:0;border:6px solid transparent;border-top:6px solid #797774;background-color:transparent;transform:translate(-50%,10px)}.mapv-container{touch-action:none}.mapv-hidden{display:none!important}\n'),window.MAPVTHREE_VERSION="1.0.0",window._hmt=window._hmt||[],function(){let e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?1baab79677df9b34e5e6db4315726094";let t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}(),e.BaiduMapConfig=oE,e.BaiduVectorTileProvider=fE,e.BingImageryTileProvider=vW,e.CSVDataSource=Ok,e.CesiumConfig=rE,e.CesiumTerrainTileProvider=class extends dW{constructor(e={}){super(e),__publicField(this,"name","CesiumTerrainTileProvider"),__publicField(this,"_supportedTargetProjectionNames",[Zb,Tb,Rb]),__publicField(this,"_url","https://assets.ion.cesium.com/ap-northeast-1/asset_depot/1/CesiumWorldTerrain/v1.2"),__publicField(this,"_defaultMaxLevel",16),__publicField(this,"_shouldCheckTileAvailable",!0),__publicField(this,"_canUpsample",!0),__publicField(this,"_isDefaultCesium",!0),this._accessToken=e.accessToken||rE.accessToken,e.url&&(this._url=e.url,this._isDefaultCesium=!1)}initProjectionAndGrid(){this._sourceProjection.name===Tb?this._grid=new JV(this._engine,this._sourceProjection,this._targetProjection):this._sourceProjection.name===Rb&&(this._grid=new cW(this._engine,this._sourceProjection,this._targetProjection));const e=this._targetProjection.name;let t=null;t=Tv(e===Tb?Tb:Rb),this.rasterProjection=t,this._grid.rasterProjection=t}async _asyncInit(){await this._refreshAccessToken();let e=null;const t={};this._isDefaultCesium&&(e={Accept:"application/json",Authorization:"Bearer "+this._sessionToken},t.headers=e);const i=await NW(`${this._url}/layer.json`,t).then((e=>e.json()));this._layerConfig=i,this._urlTemplate=this._url+"/"+i.tiles[0],this._version=i.version;const n=this._availableTiles=i.available;this._maxLevel=n.length-1;const s=i.projection||Rb;this._sourceProjection=Tv(s),this._dataLoader=new FN(this,zN,2)}async _refreshAccessToken(){if(!this._isDefaultCesium)return;const e=await NW(`https://api.cesium.com/v1/assets/1/endpoint?access_token=${this._accessToken}`,{headers:{Accept:"application/json",Authorization:"Bearer "+this._accessToken}}).then((e=>e.json()));this._sessionToken=e.accessToken,this._lastRefreshTokenTime=Date.now()}async _checkAndRefreshAccessToken(){this._isDefaultCesium&&Date.now()-this._lastRefreshTokenTime>36e5&&await this._refreshAccessToken()}getTileURL(e,t,i,n){return this._urlTemplate.replace("{version}",this._version).replace("{z}",this._sourceProjection.name===Rb?e-1:e).replace("{x}",t).replace("{y}",i)}getFetchOptions(){return this._isDefaultCesium?{headers:{Accept:"application/vnd.quantized-mesh,application/octet-stream;q=0.9,*/*;q=0.01",Authorization:"Bearer "+this._sessionToken}}:{}}isTileAvailable(e,t,i){this._sourceProjection.name===Rb&&(e-=1);const n=this._availableTiles;if(!n||0===n.length)return;if(e>=n.length)return!1;const s=n[e];for(let o=0,r=s.length;o<r;++o){const e=s[o];if(t>=e.startX&&t<=e.endX&&i>=e.startY&&i<=e.endY)return!0}return!1}async doRequestTileData(e){const t=this._targetProjection.name;let i,n;if(await this._checkAndRefreshAccessToken(),e.needUpSample){const t=e.parentKey.split("-").map((e=>+e));DN.set(t[1],t[2],t[0]);const n=this._quadtree.getTile(DN.z,DN.x,DN.y);i=await this._dataLoader.upsample(n.terrainData,DN,e)}else i=await this._dataLoader.requestTile(e),e.quantizedMesh=i;if(e.terrainData=i,i&&(n=await this._dataLoader.createMesh(i,e,{})),!n)return console.warn(`no data for tile ${e.key}`),t===Zb?this._requestEcefTileData(e):this._requestPlaneTileData(e);const s=new Fn,o=new aa(n.vertices,6);return s.setAttribute("position",new ga(o,3,0)),s.setAttribute("uv",new ga(o,2,4)),s.setIndex(new Bn(n.indices,1)),s._heights=[n.minimumHeight,n.maximumHeight],t!==Zb&&(e.targetBoundingBox.getSize(LN),s.scale(LN.x,LN.y,1)),s}},e.Circle=class extends EY{constructor(e){super(e),__publicField(this,"geometry"),__publicField(this,"material"),__publicField(this,"color"),__publicField(this,"size"),__publicField(this,"opacity"),__publicField(this,"type"),__publicField(this,"borderColor"),__publicField(this,"borderWidth"),__publicField(this,"borderOpacity"),__publicField(this,"fillOpacity"),__publicField(this,"getInstanceLocalMatrix",((e,t,i)=>{const{vertexSizes:n}=this.parameters,{size:s}=this.dataSource.data;if(n&&s){const e=new Bi;return e.makeScale(s[i],s[i],s[i]),e}return null})),__publicField(this,"addCustomAttributes",(()=>{const{vertexColors:e}=this.parameters,{color:t}=this.dataSource.data,i=[];e&&t&&t.forEach((e=>{const t=cy(e);i.push(t[0],t[1],t[2])})),this.instanceColor=new Ba(new Float32Array(i),3)})),this.parameters=e,this.defineMaterialProxyProperties(["color","size","size3","opacity","borderWidth","borderColor","borderOpacity","fillOpacity","radius","keepSize","transparent"])}initObject(){const e=this.engine.map.isGlobe;this.geometry=new OO,this.material=new $O(this.parameters),this.material.isGlobe=e,this.material.setCommonUniforms(this.engine.rendering.uniforms)}collisionTest(e){let t=0;return this.material.keepSize&&(t=this.parameters.vertexSizes&&e.size?e.size:this.size),{width:t,height:t}}},e.ClusterPoint=class extends KO{constructor(e={}){super(e),__publicField(this,"_ready"),__publicField(this,"_cluster"),__publicField(this,"_clusterDataSource"),__publicField(this,"_icon"),__publicField(this,"_label"),__publicField(this,"_minUpdateInterval"),__publicField(this,"isEventEntitySupported",!0),__publicField(this,"_minUpdateInterval",300),__publicField(this,"_lastUpdateTime",0),__publicField(this,"_updateTimeoutHandler",null),__publicField(this,"_clusterData",[]),__publicField(this,"_updateRenderingData",(()=>{const{map:e}=this.engine,t=e.getBoundingBox(),i=Math.round(e.getZoom()),n=this._cluster.getClusters([...t.min,...t.max],i);this._clusterData=n,this._clusterDataSource.objects.length>0&&this._clusterDataSource.setData(n),this._clusterDataSource.update();for(const s of this.children)s._updateData()})),this.parameters=e,this._ready=!1,this._cluster=new ZO(Object.assign({},kO,e.cluster)),this._cluster.load([]);(this._clusterDataSource=new TP).defineAttribute("size").defineAttribute("icon").defineAttribute("text",(e=>(e&&e.cluster?e.point_count:0)+""))}initObject(){}afterAddToEngine(e){super.afterAddToEngine(e);const t=this.parameters;t.icon&&(this._icon=this.addComponent(new dO(Object.assign({},YO,t.icon)))),t.label&&(this._label=this.addComponent(new _O(Object.assign({},PO,t.label)))),this._ready=!0}_updateData(){let e=this.dataSource.data;this.cachedData=e,this._cluster.load(this.dataSource.dataItems),this.needsUpdate=!1}onBeforeScenePrepareRender(e,t,i,n){if(!this._ready||!this.dataSource)return;this._needsUpdate&&this._updateRenderingData(),clearTimeout(this._updateTimeoutHandler);const s=n.time;if(s-this._lastUpdateTime>this._minUpdateInterval)return this._updateRenderingData(),void(this._lastUpdateTime=s);this._updateTimeoutHandler=setTimeout((()=>{this._updateRenderingData(),e.requestRender()}),this._minUpdateInterval),super.onBeforeScenePrepareRender(e,t,i,n)}getChildDataSource(){return this._clusterDataSource}getEntityByIndex(e){const t=this._clusterDataSource;if(!t)return;const i={index:e,value:t.getDataItem(e),itemIndex:t.getDataItemIndex(e),pairs:{}},n=t.data;for(const s of Object.keys(n))i.pairs[s]=n[s][e];return i}get minUpdateInterval(){return this._minUpdateInterval}set minUpdateInterval(e){e<16&&(e=16),this._minUpdateInterval=e}get clusterDataSource(){return this._clusterDataSource}get clusterData(){return this._clusterData}},e.DOMOverlay=Jk,e.DataItem=ex,e.DataSource=ax,e.Default3DTiles=MP,e.DefaultSky=hb,e.DomPoints=class extends gx{constructor(e){super(e),__publicField(this,"isDomPoints",!0),__publicField(this,"frustumCulled",!1),__publicField(this,"_visible",!0),__publicField(this,"onBeforeScenePrepareRenderHook",((e,s,o)=>{this.container=e.map.container;let r=e.renderer;const a=this.points,l=this.nodes;r.getSize(IO),uO.multiplyMatrices(o.matrixWorldInverse,this.matrixWorld),uO.multiplyMatrices(o.projectionMatrix,uO);for(let g=0;g<a.length;g++){hO.set(a[g][0],a[g][1],a[g][2],1),hO.applyMatrix4(uO),hO.divideScalar(hO.w);const e=(hO.x+1)/2*IO.x,s=(1-hO.y)/2*IO.y;if(!l[g])return;hO.x>1||hO.x<-1||hO.y>1||hO<-1||hO.z>1||hO<-1?i(l[g],`${t}-hidden`):n(l[g],`${t}-hidden`),l[g].style.left=e+this.offset[0]+"px",l[g].style.top=s+this.offset[1]+"px"}})),this.points=[],this.nodes=[],this.offset=[0,0],this.parameters=e}renderItem(e){const t=document.createElement("div");return t.style.position="absolute",t.style.width="60px",t.style.height="40px",t.style.background="#FFFFFF",t}clone(){const e=super.clone();return e.parameters=this.parameters,e.renderItem=this.renderItem,e}_updateData(){const e=this.engine,s=e.camera,o=e.renderer,{offset:r=[0,0]}=this.parameters;for(let t=0;t<this.nodes.length;t++)this.nodes[t].remove();this.nodes=[],this.points=[];const a=this.dataSource;if(!a)return;a.needsUpdate&&a.update(),o.getSize(IO),uO.multiplyMatrices(s.matrixWorldInverse,this.matrixWorld),uO.multiplyMatrices(s.projectionMatrix,uO);const l=a.data&&a.data.position||[];for(let g=0,c=a.size;g<c;g++){const e=l[g];this.points.push(e);const s=this.renderItem(a.getDataItem(g));hO.set(e[0],e[1],e[2],1),hO.applyMatrix4(uO),hO.divideScalar(hO.w);const o=(hO.x+1)/2*IO.x,c=(1-hO.y)/2*IO.y;hO.x>1||hO.x<-1||hO.y>1||hO<-1||hO.z>1||hO<-1?i(s,`${t}-hidden`):n(s,`${t}-hidden`),i(s,`${t}-dom-points`),s.style.left=o+r[0]+"px",s.style.top=c+r[1]+"px",s.style.visibility=!0===this.visible?"":"hidden",this.nodes.push(s),this.container.appendChild(s)}this.offset=r,this.needsUpdate=!1,this.engine&&this.engine.requestRender()}onDispose(){this.nodes&&this.nodes.length&&this.nodes.forEach((e=>{e.remove()})),this.points=[],this.nodes=[]}set visible(e){if(this._visible===e)return;this._visible=e;let t=!0==!!e?"":"hidden";this.nodes&&this.nodes.length&&this.nodes.forEach((e=>{e.style.visibility=t}))}get visible(){return this._visible}},e.DynamicSky=class extends _m{constructor(e={}){super(e),__publicField(this,"isDynamicSky",!0),__publicField(this,"_rtFlipCount",0),__publicField(this,"_skyNeedsCapture",!0),__publicField(this,"_skyNeedsUpdate",!0),__publicField(this,"_staticEnvMapNeedsUpdate",!0),__publicField(this,"_realtimeCapture",!0),__publicField(this,"_envMapType",2),__publicField(this,"_PMREMGenerator",null),__publicField(this,"_cloud",null),__publicField(this,"_envRenderTarget1",null),__publicField(this,"_envRenderTarget2",null),__publicField(this,"_skyAtmosphere",null),__publicField(this,"_lastCameraZ",-1/0),__publicField(this,"name","DynamicSky"),__publicField(this,"dynamicCloud",!1),__publicField(this,"_envCaptureLocationKey",""),__publicField(this,"_setupClouds",(()=>{const e=this._engine,t=new Dl,i=t.load(mm("assets/textures/cloud/weather_1.png"),(e=>{i.wrapS=i.wrapT=G})),n=t.load(mm("assets/textures/cloud/shape_1.png"),(e=>{n.wrapS=n.wrapT=G})),s=t.load(mm("assets/textures/cloud/BlueNoise_R_128.png"),(e=>{s.wrapS=s.wrapT=G})),o=this._volumetricCloudsPass=new BN({tBlueNoise:s,tWeather:i,tNoise:n});o.renderOrder=2001,o.sky=this,e.rendering.main.postprocessings.add(o)})),__publicField(this,"updateRealtimeEnvironment",(()=>{const e=this._engine;if(this._skyAtmosphere.material.uStarVisible=!1,!this._cubeRenderTarget){const e=this._cubeRenderTarget=new Is(256);e.texture.type=Y,e.texture.minFilter=N,e.texture.magFilter=W,e.texture.generateMipmaps=!0,this._cubeCamera=new hs(1,1e3,e)}e.rendering.objectsScene.visible=!1,e.rendering.environmentScene.visible=!0;const t=e.scene;let i=t.background;t.background={};const n=e.rendering.environmentScene;e.map.isGlobe&&(e.map.projection.localFrameToFixedFrame(e.rendering.camera.position,GN),GN.decompose(wN,n.quaternion,wN),n.updateMatrixWorld()),this._cubeCamera.update(e.renderer,t),this._PMREMGenerator||(this._PMREMGenerator=new ks(e.renderer)),this._envRT=this._PMREMGenerator.fromCubemap(this._cubeRenderTarget.texture,this._envRT),e.rendering.scene.environment=this._envRT.texture,t.background=i,e.rendering.objectsScene.visible=!0,e.rendering.environmentScene.visible=!1,this._skyAtmosphere.material.uStarVisible=!0})),__publicField(this,"disposeEnvRenderTarget",(e=>{this._envRenderTarget1&&(this._envRenderTarget1.dispose(),this._envRenderTarget1=null),this._envRenderTarget2&&(this._envRenderTarget2.dispose(),this._envRenderTarget2=null)})),this._affectWorld=!0,this._upDirection=new Qt(0,0,1)}afterAddToEngine(e){super.afterAddToEngine(e),this._engine=e,this.initEnv()}initEnv(){const e=this._engine,t=this._skyAtmosphere=new mN;t.collisionDisabled=!0,t.__isEnvironment=!0,t.renderOrder=-100,e.add(t);const i=this._postPass=new fN;i.renderOrder=50,i.sky=this,e.rendering.main.opaquePostprocessings.add(i),this._cloudAmbientBottomColorGradient=new ym([[0,new In("#010105")],[5.5/24,new In("#010105")],[5.8/24,new In("#aa0000")],[6.1/24,new In("#aa9944")],[.3125,new In("#aaaaaa")],[.5,new In("#bbccdd")]]),this._cloudSunIntensityGradient=new ym([[0,.01],[5.5/24,.05],[.3125,.1],[.5,.4]]),this._setupClouds()}onBeforeScenePrepareRender(){super.onBeforeScenePrepareRender();const e=this._engine,t=e.map.isGlobe,i=this._skyAtmosphere,n=this._cloud;e.camera,i.material.uTime=e.rendering.uniforms.elapsedTime.value,i.material.uniforms.isGlobe.value=t,e.rendering.renderState.isRendererRecreated&&(this.disposeEnvRenderTarget(),i._hasPaintedScatterBuffer=!1,this._skyNeedsUpdate=!0,this._skyNeedsCapture=!0,this._hasCaptureSky=!1,n&&n.updateRenderCacheData());let s=e.map.getViewHeight();const o=Math.abs(s-(this._lastViewHeight||-1/0));if(this._lastViewHeight=s,t){o>1&&(this._skyNeedsUpdate=!0),e.map.getCameraLocation(wN);const t=`${Math.round(wN.x/10)}-${Math.round(wN.y/10)}`;t!==this._envCaptureLocationKey&&(this._envCaptureLocationKey=t,this._skyNeedsCapture=!0,this._hasCaptureSky=!1)}else this._skyNeedsUpdate=!1;(this._skyNeedsCapture||this._skyNeedsUpdate)&&(i.viewHeight=t?Math.max(s/1e6,2e-4):2e-4,i.updateRenderTargets(e.rendering.renderer,e.rendering.camera),n&&(n.material.uniforms.skyAltitude.value=i.altitude)),this.dynamicCloud&&(n.material.uniforms.time.value=e.rendering.uniforms.elapsedTime.value),this._hasCaptureSky||(this._skyNeedsCapture=!0),s>1e4&&(this._skyNeedsCapture=!1),(this._skyNeedsCapture||this.dynamicCloud)&&(i.position.set(0,0,0),i.updateMatrixWorld(),n&&(n.position.set(0,0,0),n.updateMatrixWorld()),this._affectWorld&&(e.rendering.stats.beginTimeStatsItem("Sky.CaptureEnvironment"),this.updateRealtimeEnvironment(),e.rendering.stats.endTimeStatsItem("Sky.CaptureEnvironment")),this._hasCaptureSky=!0),this._affectWorld||(e.rendering.scene.environment=null),i.position.copy(e.rendering.camera.position),i.position.z-=0,n&&n.position.copy(e.rendering.camera.position),this._skyNeedsCapture=!1}updateLight(){if(super.updateLight(),this._lensflare){const e=this._sunDirection.z,t=this._sunDirection.x;let i=10*this._engine.map.getCameraDistance();if(e>.01&&this.sunLight.intensity>.1&&i<1e6){this._lensflare.visible=!0;const[n,s]=this._engine.map.getProjectionCenter();this._lensflare.position.set(n+t*i,s,e*i)}else this._lensflare.visible=!1}}onTimeChanged(e){this._skyAtmosphere.altitude=(e/86400-.25)*Math.PI*2,this._skyNeedsCapture=!0,this._updateClouds()}_updateClouds(){const e=this._volumetricCloudsPass;if(e){const t=this._timeRatio>.5?1-this._timeRatio:this._timeRatio,i=this._cloudSunIntensityGradient.lerp(t),n=this.sunLight.color;e.sunColor=wN.set(n.r,n.g,n.b).multiplyScalar(i*(1-this.mixGrayFactor)),e.sunDirection=wN.set(-this.localSunDirection.x,-this.localSunDirection.y,-this.localSunDirection.z),this._cloudAmbientBottomColorGradient.lerp(t,SN),wN.set(SN.r,SN.g,SN.b).multiplyScalar(1-this.mixGrayFactor),e.ambientColorBottom=wN}}getTextures(){return 2===this._envMapType?[this._envRenderTarget1.texture,this._envRenderTarget2.texture]:[]}beforeRemoveFromEngine(e){this.disposeEnvRenderTarget(this._realtimeCapture),e.remove(this._skyAtmosphere),e.remove(this._cloud),e.rendering.main.postprocessings.remove(this._postPass),e.rendering.main.postprocessings.remove(this._volumetricCloudsPass),this._skyNeedsUpdate=!0,this._skyNeedsCapture=!0,this._timeChanged=!0,super.beforeRemoveFromEngine(e)}dispose(){super.dispose()}set useVolumetricClouds(e){this._volumetricCloudsPass.useVolumetric=e}get useVolumetricClouds(){return this._volumetricCloudsPass.useVolumetric}set affectWorld(e){this._skyNeedsCapture=!0,this._affectWorld=e}get affectWorld(){return this._affectWorld}get cloudIntensity(){return this._cloud&&this._cloud.coverage||0}set cloudIntensity(e){this._cloud&&(this._cloud.coverage=e,this._skyNeedsCapture=!0)}get mixGrayFactor(){return this._skyAtmosphere.mixGrayFactor}set mixGrayFactor(e){this._skyAtmosphere.mixGrayFactor=e,this._skyNeedsCapture=!0,this._updateClouds()}get realtimeCapture(){return this._realtimeCapture}set realtimeCapture(e){e!==this._realtimeCapture&&(console.warn("has not been supported"),this._skyNeedsCapture=!0,this._realtimeCapture=e)}get skyAtmosphere(){return this._skyAtmosphere}get clipUnderground(){return!1}set clipUnderground(e){console.warn("has not been supported")}get enablePostPass(){return this._postPass.enabled||!1}set enablePostPass(e){this._postPass&&(this._postPass.enabled=e)}get enableVolumetricClouds(){return this._volumetricCloudsPass&&this._volumetricCloudsPass.enabled||!1}set enableVolumetricClouds(e){this._volumetricCloudsPass&&(this._volumetricCloudsPass.enabled=e)}get cloudCoverage(){return this._volumetricCloudsPass&&this._volumetricCloudsPass.coverage||0}set cloudCoverage(e){this._volumetricCloudsPass&&(this._volumetricCloudsPass.coverage=e)}get cloudDensity(){return this._volumetricCloudsPass&&this._volumetricCloudsPass.density||0}set cloudDensity(e){this._volumetricCloudsPass&&(this._volumetricCloudsPass.density=e)}get cloudSpeed(){return this._volumetricCloudsPass&&this._volumetricCloudsPass.speed||1}set cloudSpeed(e){this._volumetricCloudsPass&&(this._volumetricCloudsPass.speed=e)}get cloudShapeBaseScale(){return this._volumetricCloudsPass&&this._volumetricCloudsPass.shapeBaseScale||1}set cloudShapeBaseScale(e){this._volumetricCloudsPass&&(this._volumetricCloudsPass.shapeBaseScale=e)}get cloudShapeDetailScale(){return this._volumetricCloudsPass&&this._volumetricCloudsPass.shapeDetailScale||1}set cloudShapeDetailScale(e){this._volumetricCloudsPass&&(this._volumetricCloudsPass.shapeDetailScale=e)}get cloudMarchSteps(){return this._volumetricCloudsPass.marchSteps}set cloudMarchSteps(e){this._volumetricCloudsPass.marchSteps=e}get cloudSelfShadowSteps(){return this._volumetricCloudsPass.selfShadowSteps}set cloudSelfShadowSteps(e){this._volumetricCloudsPass.selfShadowSteps=e}get upDirection(){return this._upDirection}},e.DynamicWeather=Sb,e.EmptySky=_m,e.Engine=class{constructor(e,t={}){__publicField(this,"_container"),__publicField(this,"_event"),__publicField(this,"_map"),__publicField(this,"_rendering"),__publicField(this,"_selection"),__publicField(this,"_widgets"),__publicField(this,"isEngine",!0),this._container=e,this._event=new PB(this,t.event),this._map=new bE(this,t.map),this._map.init();const i=this.map.getResolution();this._rendering=new cw(this,{resolution:i,...t.rendering}),this._rendering.init(),this._map.afterInit(),this._rendering.startRenderLoop(),this._selection=new iN(this,t.selection),this._widgets=new pN(this,t.widgets),this.trackingRequest()}add(e){return this._rendering.add(e)}remove(e){this._rendering.remove(e)}requestRender(){this._rendering.requestRender()}addPrepareRenderListener(e){this._rendering.addPrepareRenderListener(e)}addBeforeRenderListener(e){this._rendering.addBeforeRenderListener(e)}removeBeforeRenderListener(e){this._rendering.removeBeforeRenderListener(e)}removePrepareRenderListener(e){this._rendering.removePrepareRenderListener(e)}addBeforePrepareRenderObject(e){this._rendering.addBeforePrepareRenderObject(e)}removeBeforePrepareRenderObject(e){this._rendering.removeBeforePrepareRenderObject(e)}addBeforeRenderObject(e){this._rendering.addBeforeRenderObject(e)}removeBeforeRenderObject(e){this._rendering.removeBeforeRenderObject(e)}lockCamera(){this.camera._isLocked=!0}unlockCamera(){this.camera._isLocked=!1}get container(){return this._container}get map(){return this._map}get rendering(){return this._rendering}get widgets(){return this._widgets}get renderer(){return this._rendering.renderer}get scene(){return this._rendering.scene}get camera(){return this._rendering.camera}get event(){return this._event}get selection(){return this._selection}dispose(){this._widgets.dispose(),this._event.dispose(),this._selection.dispose(),this._rendering.dispose(),this._map.dispose()}trackingRequest(){var e,t;null==(t=null==(e=this._map._map)?void 0:e.map)||t._printLog("mapvthree")}},e.FastTileLoaderStrategy=KZ,e.FatLine=class extends cx{constructor(e){super(),__publicField(this,"isEventEntitySupported",!0),__publicField(this,"_resolution",new bt),__publicField(this,"geometry"),__publicField(this,"material"),__publicField(this,"lineJoin"),__publicField(this,"lineCap"),__publicField(this,"miterLimit"),__publicField(this,"keepSize"),__publicField(this,"color"),__publicField(this,"vertexColors"),__publicField(this,"mapSrc"),__publicField(this,"opacity"),__publicField(this,"alphaTest"),__publicField(this,"dashed"),__publicField(this,"dashArray"),__publicField(this,"dashOffset"),__publicField(this,"dashRatio"),__publicField(this,"enableAnimation"),__publicField(this,"enableAnimationChaos"),__publicField(this,"animationSpeed"),__publicField(this,"animationTailType"),__publicField(this,"animationTailRatio"),__publicField(this,"animationTailLength"),__publicField(this,"animationIdle"),__publicField(this,"makeGeometryOffsetPosition",(e=>{if(!this._enableRtc)return;const t=e.boundingSphere&&e.boundingSphere.center;if(!t)return this._cachedRtc=[0,0,0],void this.updateTransform();const{x:i,y:n,z:s}=t,o=e.cachedPositions,r=e.cachedPrevs,a=e.cachedNexts;this.makePostionArrayOffset(e.attributes.position.array,i,n,s,o),e.attributes.prev&&this.makePostionArrayOffset(e.attributes.prev.array,i,n,s,r),e.attributes.next&&this.makePostionArrayOffset(e.attributes.next.array,i,n,s,a),this.geometry.computeBoundingSphere(),this._cachedRtc=[i,n,s],this.updateTransform()})),this.parameters=e,this.parameters.lineJoin=this.parameters.lineJoin||"bevel",this.defineGeometryProxyProperties(["lineJoin","lineCap","miterLimit"]),this.defineMaterialProxyProperties(["antialias","map","mapSrc","mapGap","height","keepSize","transparent","opacity","alphaTest","dashed","dashArray","dashOffset","dashRatio","enableAnimation","enableAnimationChaos","animationInterval","animationSpeed","animationTailType","animationTailRatio","animationTailLength","animationIdle","color","vertexColors","vertexWidths","emissive","keepDashLength"])}getDefaultParams(){return{lineWidth:4}}initObject(){const{lineJoin:e,lineCap:t,...i}=this.parameters;(this.geometry=new _Q(this.parameters)).engine=this.engine,i.enablePrevAndNext=!0;(this.material=new PW(i)).setCommonUniforms(this.engine.rendering.uniforms)}_updateData(){const e=this.dataSource.data;this.geometry.setData(e),this.geometry.computeBoundingSphere(),this.geometry.computeBoundingBox(),this.makeGeometryOffsetPosition(this.geometry),this.needsUpdate=!1}afterGeometryUpdate(){this.geometry.computeBoundingSphere(),this.makeGeometryOffsetPosition(this.geometry),this.geometry.computeBoundingSphere(),this.geometry.computeBoundingBox()}computeViewportTransformation(e,t,i,n){const s=e.x||0,o=e.y||0;t=t||0;const r=.5*(e.width||0),a=.5*(e.height||0),l=.5*((i=i||1)-t),g=r,c=a,d=l,h=s+r,u=o+a,I=t+l,p=n.elements;return p[0]=g,p[1]=0,p[2]=0,p[3]=0,p[4]=0,p[5]=c,p[6]=0,p[7]=0,p[8]=0,p[9]=0,p[10]=d,p[11]=0,p[12]=h,p[13]=u,p[14]=I,p[15]=1,n}onBeforeScenePrepareRenderHook(){const{x:e,y:t}=this.engine.rendering.uniforms.resolution.value;this._resolution.x===e&&this._resolution.y===t||(this.material.uniforms.viewportTransform.value.copy(this.computeViewportTransformation({width:this.engine.rendering.uniforms.resolution.value.x,height:this.engine.rendering.uniforms.resolution.value.y},0,1,wQ)),this._resolution.set(e,t)),this.material.uniforms.cameraNear.value=this.engine.camera.near,this.material.uniforms.cameraFar.value=this.engine.camera.far,this.material.uniforms.fovY.value=this.engine.camera.fov/180*Math.PI,this.material.uniforms.fovX.value=this.material.uniforms.fovY.value*this.engine.camera.aspect}get lineWidth(){return this.parameters.lineWidth}set lineWidth(e){this.parameters.lineWidth=e,this.needsUpdate=!0,this.engine.requestRender()}raycast(e,t){if(!this.visible)return;const i=this.geometry,n=this.matrixWorld,s=e.params.Line.threshold,o=i.drawRange;let r=this.lineWidth/2;if(this.material.keepSize&&(r*=this.material.uniforms.zoomUnits.value),null===i.boundingSphere&&i.computeBoundingSphere(),BQ.copy(i.boundingSphere),BQ.applyMatrix4(n),BQ.radius+=r,!1===e.ray.intersectsSphere(BQ))return;vQ.copy(n).invert(),xQ.copy(e.ray).applyMatrix4(vQ);const a=r/((this.scale.x+this.scale.y+this.scale.z)/3),l=a*a,g=new Qt,c=new Qt,d=new Qt,h=new Qt;if(i.isBufferGeometry){const n=i.index,s=i.attributes,r=s.position,a=s.objectIndex;if(null!==n){for(let i=Math.max(0,o.start),s=Math.min(n.count,o.start+o.count)-1;i<s;i+=2){const s=n.getX(i),o=n.getX(i+1);g.fromBufferAttribute(r,s),c.fromBufferAttribute(r,o);if(xQ.distanceSqToSegment(g,c,h,d)>l)continue;h.applyMatrix4(this.matrixWorld);const u=e.ray.origin.distanceTo(h);u<e.near||u>e.far||t.push({distance:u,point:d.clone().applyMatrix4(this.matrixWorld),index:a.getX(s),face:null,faceIndex:null,object:this})}}else{for(let i=Math.max(0,o.start),n=Math.min(r.count,o.start+o.count)-1;i<n;i+=2){g.fromBufferAttribute(r,i),c.fromBufferAttribute(r,i+1);if(xQ.distanceSqToSegment(g,c,h,d)>l)continue;h.applyMatrix4(this.matrixWorld);const n=e.ray.origin.distanceTo(h);n<e.near||n>e.far||t.push({distance:n,point:d.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}}e.params.Line.threshold=s}},e.GEOMETRY_TYPE_LINE=2,e.GEOMETRY_TYPE_POINT=1,e.GEOMETRY_TYPE_POLYGON=3,e.GLTFLoader=eX,e.GeoInstancedMesh=WY,e.GeoJSONDataSource=TP,e.Heatmap=class extends cx{constructor(e){super(e),__publicField(this,"isHeatmap",!0),__publicField(this,"frustumCulled",!1),__publicField(this,"geometry"),__publicField(this,"material"),__publicField(this,"scene"),__publicField(this,"pointMesh"),__publicField(this,"pointMaterial"),__publicField(this,"pointGeometry"),__publicField(this,"renderTarget"),__publicField(this,"depthMaterial"),__publicField(this,"depthRenderTarget"),this.parameters=e,this.defineMaterialProxyProperties(["resolution"])}getDefaultParams(){return{radius:100,maxValue:1,gradient:{0:"rgba(0,0,255,1)",.3:"rgba(0,255,0,1)",.6:"rgba(255,255,0,1)",1:"rgba(255,0,0,1)"}}}initObject(){let e=this.parameters;const t=this.geometry=new Fn;t.setAttribute("position",new Bn(new Float32Array([-1,1,0,1,1,0,-1,-1,0,1,-1,0]),3)),t.setAttribute("uv",new Bn(new Float32Array([0,1,1,1,0,0,1,0]),2)),t.setIndex([0,2,1,2,3,1]);(this.material=new tU({})).setCommonUniforms(this.engine.rendering.uniforms);const[i,n]=this.resolution||[],s=this.scene=new ra;this.renderTarget=new Yt(i,n),this.depthRenderTarget=new Yt(i,n,{}),this.depthMaterial=new oU({keepSize:this.parameters.keepSize});const o=this.pointGeometry=new rU,r=this.pointMaterial=new nU({keepSize:this.parameters.keepSize});r.setCommonUniforms(this.engine.rendering.uniforms),this.depthMaterial.setCommonUniforms(this.engine.rendering.uniforms);const a=this.pointMesh=new WY(o,r);a.engine=this.engine,this.pointMesh.matrixAutoUpdate=!0,a.frustumCulled=!1,s.add(a),this.material.uniforms.heatmap.value=this.renderTarget.texture,this.material.uniforms.heatmapDepth.value=this.depthRenderTarget.texture,void 0!==e.gradient&&(this.gradient=e.gradient),void 0!==e.radius&&(this.radius=e.radius),void 0!==e.minValue&&(this.minValue=e.minValue),void 0!==e.maxValue&&(this.maxValue=e.maxValue),void 0!==e.opacity&&(this.opacity=e.opacity),void 0!==e.keepSize&&(this.keepSize=e.keepSize),void 0!==e.attenuateMValueFactor&&(this.attenuateMValueFactor=e.attenuateMValueFactor)}onBeforeSceneRenderHook(e,t,i,n){let s=e.renderer;const o=n.cameraOffset;this.scene.position.set(-o.x,-o.y,-o.z),s.setRenderTarget(this.renderTarget),!1===s.autoClear&&s.clear(),s.render(this.scene,i),s.setRenderTarget(this.depthRenderTarget),!1===s.autoClear&&s.clear(),this.scene.overrideMaterial=this.depthMaterial,s.render(this.scene,i),this.scene.overrideMaterial=null,s.setRenderTarget(null)}set dataSource(e){this.pointMesh.dataSource=e}get dataSource(){return this.pointMesh.dataSource}_updateData(){this.pointMesh.dataSource&&(this.pointMesh.addCustomAttributes=(e,t)=>{let i=t.data,n=[];for(let s=0;s<i.position.length;s++){const e=i.count[s]?i.count[s]:1;n.push(e)}e.setAttribute("instancedWeight",new Ba(new Float32Array(n),1))},this.pointMesh._updateData())}dispose(){this.material.dispose(),this.geometry.dispose(),this.pointGeometry.dispose(),this.pointMaterial.dispose(),this.renderTarget.dispose(),this.depthMaterial.dispose(),this.depthRenderTarget.dispose()}set gradient(e){"[object Object]"===Object.prototype.toString.call(e)&&(this.material.gradient=e)}set radius(e){!isNaN(e)&&e>0&&(this.pointMaterial.radius=e,this.depthMaterial.radius=e)}get radius(){return this.pointMaterial.radius}set minValue(e){isNaN(e)||(this.pointMaterial.minValue=e)}get minValue(){return this.pointMaterial.minValue}set maxValue(e){isNaN(e)||(this.pointMaterial.maxValue=e)}get maxValue(){return this.pointMaterial.maxValue}set opacity(e){isNaN(e)||(this.material.opacity=e)}get opacity(){return this.material.opacity}set keepSize(e){this.pointMaterial.keepSize=e,this.depthMaterial.keepSize=e}get keepSize(){return this.pointMaterial.keepSize}set attenuateMValueFactor(e){this.pointMaterial.attenuateMValueFactor=e}},e.HierarchicalTileLoaderStrategy=YZ,e.Icon=dO,e.ImageryTileProvider=_W,e.JSONDataSource=FP,e.LODModel=class extends Ji{constructor(e){super(e),__publicField(this,"_hysteresis",.1),__publicField(this,"_levels",[]),__publicField(this,"_currentLevel"),__publicField(this,"_currentModel"),__publicField(this,"_loader",wH),__publicField(this,"_generateModelMesh",(async e=>new Promise(((t,i)=>{this._loader.load(e,(e=>{t(e.scene)}),null,i)})))),__publicField(this,"update",(async()=>{if(!this.visible)return;const e=this._engine.camera,t=this.levels,i=this.position,n=t.length;if(n>0){const s=e.position.distanceTo(i),o=t[n-1].hysteresis||this.hysteresis;if(s>t[n-1].distance*(1+o))return this._modelMeshSingleton.keys.forEach((async e=>{(await this._modelMeshSingleton.get(e)).visible=!1})),!VH.cache[this.uuid]&&this.isInit&&VH.set(this.uuid,this),this._currentLevel=void 0,void(this._currentModel=void 0);let r,a;VH.remove(this.uuid);for(let e=0;e<n;e++){const i=t[e];let n=i.distance;if(i.init){if(!0===(await this._modelMeshSingleton.get(i.file)).visible){n+=n*(i.hysteresis||this.hysteresis)}}if(void 0===r&&s<=n)r=e;else if(i.init){(await this._modelMeshSingleton.get(i.file)).visible=!1}}if(r>=0){let e=t[r],i=await this._modelMeshSingleton.get(e.file);e.init?i.visible=!0:(this.add(i),e.init=!0,this.handleLoaded(i)),a=i}this._currentLevel=r,this._currentModel=a}})),e.hysteresis&&(this.hysteresis=e.hysteresis),e.levels&&(this.levels=e.levels)}afterAddToEngine(e){this._engine=e,this._modelMeshSingleton=new sE,this._modelMeshSingleton.generate=this._generateModelMesh,this._engine.rendering.addPrepareRenderListener(this.update)}beforeRemoveFromEngine(e){this.dispose()}addLevel(e,t=0,i=0){t=Math.abs(t);const n=this.levels;let s;for(s=0;s<n.length&&!(t<n[s].distance);s++);return n.splice(s,0,{distance:t,hysteresis:i,file:e,init:!1}),this}removeLevel(e){for(let t=0;t<this.levels.length;t++){if(e===this.levels[t].file){this.levels.splice(t,1);break}}return this}getCurrentLevel(){return this._currentLevel}getCurrentModel(){return this._currentModel}async getModel(e){let t=this.levels[e];if(t)return await this._modelMeshSingleton.get(t.file)}handleLoaded(e){this.dispatchEvent({type:"loaded",value:e}),this.levels.every((e=>e.init))&&this.dispatchEvent({type:"complete",value:this})}dispose(){this._loaded&&(this._engine.rendering.removePrepareRenderListener(this.update),this.destroyModel())}get isInit(){return this.levels.findIndex((e=>e.init))>=0}destroyModel(){this._modelMeshSingleton.keys.forEach((async e=>{let t=await this._modelMeshSingleton.get(e);this.remove(t),t.traverse((e=>{if(e.isMesh){e.geometry.dispose(),e.material.dispose();const t=e.material.map;t&&(t.image instanceof ImageBitmap&&t.image.close(),t.dispose())}}))}));for(let e=0;e<this.levels.length;e++){this.levels[e].init=!1}this._modelMeshSingleton.clear()}get transform(){return{translate:this.position,rotation:this.rotation,scale:this.scale}}set transform(e){e.translate&&(e.translate instanceof Qt?this.position.copy(e.translate):this.position.set(...e.translate)),e.rotation&&(e.rotation instanceof Qt?this.rotation.copy(e.rotation):this.rotation.set(...e.rotation)),e.scale&&(e.scale instanceof Qt?this.scale.copy(e.scale):"number"==typeof e.scale?this.scale.setScalar(e.scale):this.scale.set(...e.scale))}get levels(){return this._levels}set levels(e){this._levels=e.map((e=>(e.init=!1,e)))}get hysteresis(){return this._hysteresis}set hysteresis(e){this._hysteresis=e}},e.Label=nB,e.MapView=GW,e.Marker=class extends Jk{constructor(e={}){super(e),__publicField(this,"_icon"),__publicField(this,"_width"),__publicField(this,"_height"),this.isMarker=!0}initDom(){let e=document.createElement("img");return i(e,`${t}-marker`),e}afterInit(){this.icon=this.parameters.icon||"https://webmap0.bdimg.com/image/api/marker_red.png",this.width=this.parameters.width||25,this.height=this.parameters.height||25}get icon(){return this._icon}set icon(e){this.dom&&(this.dom.src=e),this._icon=e}get width(){return this._width}set width(e){this.dom&&(this.dom.width=e),this._width=e}get height(){return this._height}set height(e){this.dom&&(this.dom.height=e),this._height=e}},e.OSMImageryTileProvider=class extends _W{constructor(e){super({...e,projection:Tb}),__publicField(this,"name","OSMImageryTileProvider"),__publicField(this,"_supportedTargetProjectionNames",[Tb,Rb]),__publicField(this,"_defaultStartLevel",1),__publicField(this,"_defaultMaxLevel",18),__publicField(this,"_maxParallelRequestNum",24),__publicField(this,"_useWebMeractorProjectionAndGrid",!0)}getTileURL(e,t,i,n){const s=Math.abs(t+i)%MN.length;return`${MN[s]}/${e}/${t}/${n.reverseY}.png`}},e.PROJECTION_BD_MERCATOR=Vb,e.PROJECTION_ECEF=Zb,e.PROJECTION_EQUAL_EARTH="EPSG:8857",e.PROJECTION_GEO=Rb,e.PROJECTION_SCREEN_PIXEL=Wb,e.PROJECTION_UTM="UTM",e.PROJECTION_WEB_MERCATOR=Tb,e.PlaneTerrainTileProvider=dW,e.Polygon=eq,e.Popup=class extends Jk{constructor(e){super(e),__publicField(this,"_titleDiv"),__publicField(this,"_contentDiv"),__publicField(this,"_title"),__publicField(this,"_content"),__publicField(this,"_closePopup"),__publicField(this,"click",(()=>{this.visible=!1})),this.isPopup=!0}initDom(){const e=document.createElement("div");i(e,`${t}-popup`);const n=document.createElement("div");i(n,"frame");const s=this._titleDiv=document.createElement("div");i(s,"title"),s.innerText=this.title;const o=this._closePopup=document.createElement("div");i(o,"close"),o.innerText="x",o.addEventListener("click",this.click);const r=this._contentDiv=document.createElement("div");i(r,"content"),r.innerText=this.content,n.appendChild(o),n.appendChild(s),n.appendChild(r);const a=document.createElement("div");return i(a,"triangle"),e.appendChild(n),e.appendChild(a),e}afterInit(){this.title=this.parameters.title||"title",this.content=this.parameters.content||"content"}onDispose(){this._closePopup.removeEventListener("click",this.click)}get title(){return this._title}set title(e){e&&(this._title=e,this._titleDiv&&(this._titleDiv.innerText=e))}get content(){return this._content}set content(e){this._content=e,this._contentDiv&&(this._contentDiv.innerText=e)}},e.RENDER_STAGE_BLOOM=11,e.RENDER_STAGE_FEATURES=20,e.RENDER_STAGE_POSTPROCESSING=30,e.RENDER_STAGE_PREPARE=0,e.RENDER_STAGE_SCENE=10,e.RasterSurface=rW,e.SDFText=class extends pU{constructor(e){super(e),__publicField(this,"frustumCulled",!0),__publicField(this,"_needsUpdate",!1),__publicField(this,"_enableFade",!1),__publicField(this,"texture",null),__publicField(this,"_padding",[0,0]),__publicField(this,"_characterSet",function(){const e=[];for(let t=32;t<128;t++)e.push(String.fromCharCode(t));return e}()),__publicField(this,"_collisionBoxCache",{}),__publicField(this,"_sdfTextureNeedUpdate",!1),__publicField(this,"updateRenderingData",(()=>{const[e,t]=this.material.resolution||[],i=this.engine.map.isGlobe;let n=new Bi;if(isNaN(e)||e<=0||isNaN(t)||t<=0)return void console.warn("resolution is invalid");const s=[],o=[],r=[],a=[],l=[],g=[],c=[],d=[],h=[],u=[],I=[],p=[],m=[],{mapping:A,width:C,height:f}=this.fontAtalasManager.atlas||{};let b=[0],y=0,_=null;for(let x=0;x<this.cachedData.length;x++){_=this.cachedData[x];const e=_.position;_.index;const t=_.text,v=_.textStyle,{fontSize:B=this._fontSize,fontWeight:w=this._fontWeight,lineWidth:S=this._lineWidth,strokeStyle:G=this._strokeStyle,fillStyle:M=this._fillStyle,rotateZ:R=0,hOffset:T=0,vOffset:Z=0,offset:V=[0,0]}=v||{},W=Array.from(t).map((e=>e+w)),E=this._letterSpacing*this._fontSettings.fontSize,{x:N,y:F,rowWidth:X,rowNum:H,heightSize:z,textHeights:L,size:[D,K]}=Rx(t,W,1,"break-word",-1*B,A,E),Y=N.length;y+=b[x];const P=Array.from(t);let k=0,O=0;const U=z/2;for(let b=0;b<Y;b++){const t=P[b];if("\\"===t)continue;const v=A[t+w];if(!v)return;if(i){n=bA.eastNorthUpToFixedFrame(bU.fromArray(e),null,n),n.elements[12]=0,n.elements[13]=0,n.elements[14]=0;for(let e=0;e<4;e++)for(let t=0;t<16;t++)d.push(n.elements[t])}if(r.push(0,1,2,3),this.alignRotate){const e=L[b],t=O+e/2-U;O+=e,I.push(t,t,t,t)}const x=4*(y+k);a.push(x,x+2,x+1,x,x+3,x+2),s.push(...e,...e,...e,...e);let{x:W,y:E,width:z,height:Y}=v;z+=2*this._fontSettings.buffer,o.push(W,E,z,Y,W,E,z,Y,W,E,z,Y,W,E,z,Y);const Q=W/C,J=E/f,j=Q+z/C,q=J+Y/f;l.push(Q,q,Q,J,j,J,j,q);const $=(1-AU[this.textAlign])*(D-X[b])/2,ee=V[0]*B+T,te=V[1]*B+Z,ie=-1*D/2+$+N[b]+ee,ne=K/H*(H-1)/2-F[b]+te,se=B*(Y/this._fontSettings.fontSize);if(u.push(se,B,ie,ne,se,B,ie,ne,se,B,ie,ne,se,B,ie,ne),g.push(G[0],G[1],G[2],S,G[0],G[1],G[2],S,G[0],G[1],G[2],S,G[0],G[1],G[2],S),c.push(M[0],M[1],M[2],M[0],M[1],M[2],M[0],M[1],M[2],M[0],M[1],M[2]),this.parameters.vertexRotateZs&&h.push(R,R,R,R),this._enableFade){const e=_.fadeOpacity||.001,t=_.fadeSince||0;p.push(e,e,e,e),m.push(t,t,t,t)}k++}b.push(k)}const v=this.geometry;v.setAttribute("position",new Mn(s,3)),v.setAttribute("pIndex",new Mn(r,1)),v.setAttribute("sizeAndOffset",new Mn(u,4)),v.setAttribute("iconFrame",new Mn(o,4)),v.setAttribute("uv",new Mn(l,2)),v.setAttribute("strokeStyle",new Mn(g,4)),v.setAttribute("fillStyle",new Mn(c,3)),this.alignRotate&&v.setAttribute("verticalOffsets",new Mn(I,1)),i&&v.setAttribute("ecefMatrix",new Mn(d,16)),this.parameters.vertexRotateZs&&v.setAttribute("aRotateZ",new Mn(h,1)),this._enableFade&&(v.setAttribute("fadeOpacity",new Mn(p,1)),v.setAttribute("fadeSince",new Mn(m,1))),v.setIndex(a),v.computeBoundingSphere(),this.makeGeometryOffsetPosition(v,s),this.needsUpdate=!1,this._enableFade&&(this.material[0].fadeDuration=this._fadeData.fadeDuration,this.material[1].fadeDuration=this._fadeData.fadeDuration)})),__publicField(this,"getStrictStyleId",(e=>{if(this.parameters.vertexStyles){let{fontSize:t,fontWeight:i,lineWidth:n,fillStyle:s=[],strokeStyle:o=[]}=e;return`${t}_${i}_${n}_${s[0]}_${s[1]}_${s[2]}_${o[0]}_${o[1]}_${o[2]}`}return 0})),this.parameters=e,this._flat=lm(this.parameters.flat,!1),this._fontSize=lm(this.parameters.fontSize,yU),this._fontWeight=lm(this.parameters.fontWeight,_U),this._letterSpacing=lm(this.parameters.letterSpacing,0);const t=lm(this.parameters.fillStyle,vU);Array.isArray(t)?this._fillStyle=t:this._fillStyle=cy(t),this._lineWidth=lm(this.parameters.lineWidth,BU),this.outlineWidth=lm(this.parameters.lineWidth,BU);const i=lm(this.parameters.strokeStyle,xU);Array.isArray(i)?this._strokeStyle=i:this._strokeStyle=cy(i),this._fontFamily=lm(this.parameters.fontFamily,"Microsoft Yahei"),this._padding=lm(this.parameters.padding,[2,2]),this._margin=lm(this.parameters.margin,[0,0]),this.textAlign=lm(this.parameters.textAlign,"center"),this.alignRotate=lm(this.parameters.alignRotate,!1),this._enableFade=lm(this.parameters.enableFade,!1),this.cachedData=[],this.shouldUpdateRenderingData=!1,this.drawingData=[],this._fadeData=new Hx;const n=this.canvas=document.createElement("canvas");n.width=n.height=1;const s=this.ctx=n.getContext("2d");s.textAlign="start",s.textBaseline="top",this.matrixAutoUpdate=!0}initObject(){const{fillStyle:e,strokeStyle:t,fontFamily:i,vertexStyles:n,...s}=this.parameters;this.geometry=new Fn(this.parameters);const o=new IU(s);o.setCommonUniforms(this.engine.rendering.uniforms),o.isHalo=0,o.enableFade=this._enableFade;const r=new IU(s);r.setCommonUniforms(this.engine.rendering.uniforms),r.isHalo=1,r.enableFade=this._enableFade,this.material=[o,r],this.defineMaterialProperties(["lineHeight","pixelRatio","map","pixelOffsetX","pixelOffsetY","positionOffsetX","positionOffsetY","positionOffsetZ","backgroundColor","resolution","opacity","flat","isGlobe","alignRotate"]),this.add(new ts(this.geometry,r)),this.add(new ts(this.geometry,o));const a=this.engine.map.isGlobe;this.material.isGlobe=a;const l=`${this.fontFamily} ${this._fontWeight}`;this.fontStack=l;const g=new Xx;this.fontAtalasManager=g}onBeforeSceneRender(e,t,i,n){super.onBeforeSceneRender(e,t,i,n),this._enableFade&&!this._fadeData.isStable(n.elapsedTime)&&e.requestRender()}update(){this.updateRenderingData()}updateSdfTexture(){if(this._sdfTextureNeedUpdate){this._fontSettings={fontFamily:this._fontFamily,fontWeight:"400",characterSet:this._characterSet,sdf:!0,...fU},this.fontAtalasManager.setProps(this._fontSettings);const{textureData:e,width:t,height:i}=this.fontAtalasManager.atlas;if(!this.texture){const e=new Uint8Array(t*i);this.texture=new ya(e,t,i),this.texture.minFilter=this.texture.magFilter=W,this.texture.format=q}this.texture.image.data.set(e),this.texture.needsUpdate=!0,this.material.map=this.texture,this._sdfTextureNeedUpdate=!1}}_updateData(){this._enableCollision&&this._collisionData?this.cachedData=this._collisionData:this.cachedData=this.dataSource.userData.map((e=>{let t=this.collisionTest(e);return{...e,w:t.width,h:t.height}})),this._enableFade&&(this._fadeData.update(this.cachedData,this.engine.rendering.uniforms.elapsedTime.value),this.cachedData=this._fadeData.data);let e={};this.fontAtalasManager&&this.fontAtalasManager.mapping&&(e=this.fontAtalasManager.mapping);let t=new Map,i=!1;const n=this.cachedData,s=n.length;for(let o=0;o<s;o++){const s=n[o],r=s.text,a=s.textStyle||{},l={fontSize:lm(a.fontSize,this._fontSize),fontWeight:lm(a.fontWeight,this._fontWeight),lineWidth:lm(a.lineWidth,this._lineWidth),fillStyle:lm(a.fillStyle,this._fillStyle),strokeStyle:lm(a.strokeStyle,this._strokeStyle)},g=Array.from(r);for(let n=0,o=g.length;n<o;n++){const s=g[n],o=s+l.fontWeight;t.set(o,{char:s,textStyle:l}),e[o]||(i=!0)}}i&&(this._sdfTextureNeedUpdate=!0,this._characterSet=t.values()),this.updateSdfTexture(this._characterSet),this.update()}_setupCanvas(e,t){e.save(),e.scale(t,t),e.textBaseline="top"}_calculateTransform(e,t){return this.engine.map.isGlobe?(t||(t=new Bi),bA.eastNorthUpToFixedFrame(bU.fromArray(e),null,t),t.extractRotation(t),t):CU}_processTextStyle(e={}){return{fontSize:lm(e.fontSize,this._fontSize),fontWeight:lm(e.fontWeight,this._fontWeight),lineWidth:lm(e.lineWidth,this._lineWidth),fillStyle:lm(e.fillStyle,this._fillStyle),strokeStyle:lm(e.strokeStyle,this._strokeStyle),rotateZ:lm(e.rotateZ,0)}}_generateCacheName(e,t){let i="";if(this._flat){i+=e.position.join("_")}if(this.parameters.vertexStyles){const{fontWeight:n,fontSize:s,lineWidth:o}=t;i+=`${e.text}_${s}_${n}_${o}`}else i+=`${e.text}_${this._fontSize}`;return i}_calculateRotation(e,t,i){const n=new Bi;n.multiplyMatrices(e,t);const s=n.elements[0],o=n.elements[1];return Math.sin(i)*-o+Math.cos(i)*s}_calculateCharInfo(e,t,i,n,s,o){const r=t.measureText(e).width;return{char:e,width:r+2*o[0],height:i,offsetX:n+r/2,offsetY:s}}_calculatePixelSize(e,t){const i=this._rendering.renderState.cameraOffset;t.sub(i);return((e,t,i)=>.2*Math.tan(t/2)*e/i*10)(e.position.distanceTo(t),e.fov*Math.PI/180,this._rendering.resolution.y)}_processTextLayout(e,t,i){const n=this.ctx,s=this._padding,o=String(e).split("\\"),r=-(t*o.length)/2;return o.map(((e,i)=>{const o=[];let a=0;for(let s=0;s<e.length;s++){const l=e[s],g=n.measureText(l).width;o.push({char:l,width:g,height:t,offsetX:0,offsetY:-(r+t/2+i*t)}),a+=g}let l=-a/2;for(let t=0;t<o.length;t++){const e=o[t];l+=e.width/2,e.offsetX=l,l+=e.width/2,e.width+=2*s[0]}return o}))}_applyRotateZ(e,t,i){const n=this.engine.camera.matrixWorld;return this._calculateRotation(n,i,t)<0&&(t+=Math.PI),e.map((e=>{const i=e.offsetX,n=e.offsetY;return{...e,offsetX:i*Math.cos(t)-n*Math.sin(t),offsetY:i*Math.sin(t)+n*Math.cos(t)}}))}collisionTest(e){const t=this.ctx,i=this.engine.rendering.pixelRatio,n=this._fontSize,s=this._fontFamily,o=this._padding,r=this._processTextStyle(e.textStyle);this._setupCanvas(t,i);const a=this._generateCacheName(e,r);if(this._collisionBoxCache[a]){const e=this._collisionBoxCache[a],t=e.chars;if(t){const i=e.rotationMatrix,n=this._applyRotateZ(t,r.rotateZ,i);return{...this._collisionBoxCache[a],chars:n}}return e}let l=n;const g=this.getStrictStyleId(r);if(g===mU){let{fontWeight:e,fontSize:i,lineWidth:n}=r;t.font=e>=10&&e%10==0?10*e+" "+i+"px "+s:i+"px "+s,l=i,n>0&&(t.lineWidth=n)}else t.font=n+"px "+s,mU=g;if(this._flat){const t=this._calculateTransform(e.position),i=this._processTextLayout(e.text,l,r).flat();this._collisionBoxCache[a]={chars:i,rotationMatrix:t};return{chars:this._applyRotateZ(i,r.rotateZ,t),rotationMatrix:t}}let c=String(e.text).split("\\");const d=c.map((e=>t.measureText(e).width));let h=Math.max(...d),u=l*c.length;const I=h+2*o[0],p=u+2*o[1];return t.restore(),this._collisionBoxCache[a]={width:I,height:p},{width:I,height:p}}onDispose(){this.texture&&this.texture.dispose()}get needsUpdate(){return this._needsUpdate}set needsUpdate(e){this._needsUpdate=e}set fontSize(e){this._fontSize!==e&&(this._fontSize=e,this._collisionBoxCache={},this._sdfTextureNeedUpdate=!0)}get fontSize(){return this._fontSize}set fontFamily(e){this._fontFamily!==e&&(this._fontFamily=e,this._collisionBoxCache={},this._sdfTextureNeedUpdate=!0)}get fontFamily(){return this._fontFamily}set fillStyle(e){this._fillStyle=e}get fillStyle(){return this._fillStyle}set padding(e){this._padding!==e&&(this._padding=e,this._collisionBoxCache={})}get padding(){return this._padding}set strokeStyle(e){this._shouldStroke=!!e,this._strokeStyle=e}get strokeStyle(){return this._strokeStyle}get enableFade(){return this._enableFade}set enableFade(e){this._enableFade=e,this.material[0].enableFade=e,this.material[1].enableFade=e}defineMaterialProperties(e=[]){for(let t=0;t<e.length;t++){const i=e[t];Object.defineProperty(this.material,i,{get:function(){return this&&this[0][i]},set:function(e){this.forEach((t=>{t[i]=e}))}})}this.defineMaterialProxyProperties(e)}},e.SimpleLine=class extends wU{constructor(e){super(e),__publicField(this,"geometry"),__publicField(this,"material"),__publicField(this,"color"),this.parameters=e,this.defineGeometryProxyProperties(["granularity"]),this.defineMaterialColorProxyProperties(["color"])}initObject(){this.geometry=new QU(this.parameters),this.geometry.engine=this.engine,this.material=new Wa(this.parameters)}_updateData(){const e=this.dataSource.data;this.geometry.setData(e),this.geometry.computeBoundingSphere(),this.makeGeometryOffsetPosition(this.geometry,this.geometry.cachedPositions),this.needsUpdate=!1}},e.SimpleModel=class extends Ji{constructor(e){super(e),__publicField(this,"_autoYUpToZUp",!0),this._parameters=e,this._name=e.name||"",this._object=e.object||e.url,void 0!==e.autoYUpToZUp&&(this._autoYUpToZUp=e.autoYUpToZUp)}afterAddToEngine(e){this._engine=e,this.setTransform({point:this._parameters.point||[0,0,0],scale:this._parameters.scale||[1,1,1],rotation:this._parameters.rotation||[0,0,0]}),this._initModel()}beforeRemoveFromEngine(){this.dispose()}async _initModel(){if(!this._object)return void console.error("object of SimpleModel is required");let e=null;if("string"==typeof this._object){const t=await MH.get(this._object);e=t.animations&&t.animations.length>0?SH(t.scene):t.scene.clone(),this._updateData(t,e),this.dispatchEvent({type:"loaded",value:this}),this._autoYUpToZUp&&e.rotateX(Math.PI/2)}else this._object.isObject3D&&(e=this._object);this.add(e)}dispose(){}setTransform(e={}){if(e.point){e.point instanceof Qt?RH.copy(e.point):e.point instanceof Array&&RH.set(e.point[0],e.point[1],e.point[2]||0);const t=this._engine.map.projectCoordinate(RH);this.position.copy(t)}if(e.rotation){if(e.rotation instanceof Ei?ZH.copy(e.rotation):e.rotation instanceof Qt?ZH.setFromVector3(e.rotation,"XYZ"):e.rotation instanceof Array&&ZH.set(e.rotation[0],e.rotation[1],e.rotation[2],"XYZ"),this._engine.map.isGlobe){const e={heading:ZH.z,pitch:ZH.y,roll:ZH.x},t=bA.headingPitchRollToFixedFrame(this.position,e);ZH.setFromRotationMatrix(t)}this.rotation.set(ZH.x,ZH.y,ZH.z,ZH.order)}e.scale&&(e.scale instanceof Qt?TH.copy(e.scale):"number"==typeof e.scale?TH.set(e.scale,e.scale,e.scale):e.scale instanceof Array&&TH.set(e.scale[0],e.scale[1],e.scale[2]),this.scale.set(TH.x,TH.y,TH.z))}set point(e){e&&this.setTransform({point:e})}get autoYUpToZUp(){return this._autoYUpToZUp}_updateData(){}},e.SimplePoint=class extends jk{constructor(e){super(e),__publicField(this,"geometry"),__publicField(this,"material"),__publicField(this,"color"),__publicField(this,"vertexColors"),__publicField(this,"size"),__publicField(this,"vertexSizes"),__publicField(this,"opacity"),this.parameters=e,this.defineMaterialProxyProperties(["size","uShapeType","opacity","emissive","vertexColors","vertexSizes","color","mapSrc"]),this.defineMaterialUpdateProxyProperties(["transparent"])}collisionTest(e){return this.parameters.vertexSizes&&e.size?{width:e.size,height:e.size}:{width:this.size,height:this.size}}initObject(){this.geometry=new qk(this.parameters),this.material=new tO(this.parameters),this.material.setCommonUniforms(this.engine.rendering.uniforms)}_updateData(){const e=this.dataSource.data,{vertexSizes:t,vertexColors:i}=this.parameters;let n=[];n=this._enableCollision&&this._collisionData?this._collisionData:this.dataSource.userData;const s=[],o=[],r=[],a=[];for(let l=0;l<n.length;l++){const g=n[l].position,c=n[l].index;if(s.push(...g),o.push(c),i&&e.color){let e=cy(n[l].color);r.push(e[0],e[1],e[2],e[3])}t&&e.size&&a.push(n[l].size)}this.geometry.setData({aPositions:s,aObjectIndices:o,aColors:r,aSizes:a}),this.geometry.computeBoundingSphere(),this.makeGeometryOffsetPosition(this.geometry,s),this.needsUpdate=!1}},e.TerrainTileProvider=gW,e.Text=class extends cx{constructor(e){super(e),__publicField(this,"isEventEntitySupported",!0),__publicField(this,"_fontSize"),__publicField(this,"_fontFamily"),__publicField(this,"_fillStyle"),__publicField(this,"_padding"),__publicField(this,"_strokeStyle"),__publicField(this,"_shouldStroke"),__publicField(this,"_collisionBoxCache",{}),__publicField(this,"isRenderInPostprocess",!1),__publicField(this,"geometry"),__publicField(this,"material"),__publicField(this,"cachedData",[]),__publicField(this,"drawingData"),__publicField(this,"canvas"),__publicField(this,"ctx"),__publicField(this,"texture"),__publicField(this,"matrixAutoUpdate",!0),__publicField(this,"sortByStyle",(e=>this.parameters.vertexStyles?e.sort(((e,t)=>t.styleId-e.styleId)):e)),__publicField(this,"getStrictStyleId",(e=>{if(this.parameters.vertexStyles){let{fontSize:t,fontWeight:i,lineWidth:n,fillStyle:s=[],strokeStyle:o=[]}=e;return`${t}_${i}_${n}_${s[0]}_${s[1]}_${s[2]}_${s[3]}_${o[0]}_${o[1]}_${o[2]}_${o[3]}`}return 0})),__publicField(this,"updateRenderingData",(()=>{const e=this.engine.rendering.pixelRatio,t=this.engine.map.isGlobe,i=this.canvas,n=this.ctx,s=this._fontSize,o=this._fontFamily,r=this._fillStyle,a=this._padding,l=this.cachedData||[],g=zx(l);0===l.length&&(g.w=1,g.h=1);let c=g.w,d=g.h;i.width=c*e,i.height=d*e,n.save(),n.scale(e,e),n.textBaseline="top",n.fillStyle=r,this._shouldStroke&&(n.strokeStyle=this._strokeStyle,this._lineWidth>0&&(n.lineWidth=this._lineWidth)),n.font=s+"px "+o,this.shadowColor&&(n.shadowColor=this.shadowColor,n.shadowOffsetX=this.shadowOffsetX||0,n.shadowOffsetY=this.shadowOffsetY||0,n.shadowBlur=this.shadowBlur||0);const h=[],u=[],I=[],p=[],m=[],A=[],C=[],f=[];let b=s,y=1/0,_=1/0,v=1/0,x=-1/0,B=-1/0,w=-1/0;for(let V=0;V<l.length;V++){const e=l[V].position,[t,i,n=0]=e;t<y&&(y=t),t>x&&(x=t),i<_&&(_=i),i>B&&(B=i),n<v&&(v=n),n>w&&(w=n)}let S=(y+x)/2,G=(_+B)/2,M=(v+w)/2;S=Number.isNaN(S)?0:S,G=Number.isNaN(G)?0:G,M=Number.isNaN(M)?0:M;let R=[S,G,M],T=new Bi;for(let V=0,W=l.length;V<W;++V){const e=l[V],i=this.getStrictStyleId(e);if(this.parameters.vertexStyles&&gU!==i){gU=i;let{fontWeight:t,fontSize:s,fillStyle:r,strokeStyle:a,lineWidth:l}=e;n.font=t>=10&&t%10==0?10*t+" "+s+"px "+o:s+"px "+o,b=s,l>0&&(n.lineWidth=l,n.strokeStyle="rgba("+a.join(",")+")"),n.fillStyle="rgba("+r.join(",")+")"}let s=String(e.text).split("\\");for(let t=0;t<s.length;t++)(this._shouldStroke||this.parameters.vertexStyles)&&n.strokeText(s[t],e.x+a[0],e.y+a[1]+t*b),n.fillText(s[t],e.x+a[0],e.y+a[1]+t*b);let[r,g,y=0]=e.position;if(t){T=bA.eastNorthUpToFixedFrame(new Qt(r,g,y),null,T),T.elements[12]=0,T.elements[13]=0,T.elements[14]=0;for(let e=0;e<4;e++)for(let t=0;t<16;t++)f.push(T.elements[t])}r-=R[0],g-=R[1],y-=R[2],h.push(r,g,y,r,g,y,r,g,y,r,g,y),I.push(0,1,2,3),m.push(e.w,e.h,e.w,e.h,e.w,e.h,e.w,e.h);const _=4*V;p.push(_,_+2,_+1,_,_+3,_+2);const v=e.x/c,x=(e.x+e.w)/c,B=(e.y+e.h)/d,w=e.y/d;u.push(v,B,v,w,x,w,x,B),A.push(e.index,e.index,e.index,e.index),this.parameters.vertexRotateZs&&C.push(e.rotateZ,e.rotateZ,e.rotateZ,e.rotateZ)}n.restore();const Z=this.geometry;Z.setAttribute("position",new Mn(h,3)),Z.setAttribute("pIndex",new Mn(I,1)),Z.setAttribute("wh",new Mn(m,2)),Z.setAttribute("uv",new Mn(u,2)),t&&Z.setAttribute("instanceMatrix",new Mn(f,16)),this.parameters.vertexRotateZs&&Z.setAttribute("aRotateZ",new Mn(C,1)),Z.setIndex(p),Z.computeBoundingSphere(),this.makeMeshPositionOffset(R),h.length>0&&(this.texture&&this.texture.dispose(),this.texture=new il(this.canvas),this.texture.minFilter=W,this.texture.magFilter=W,this.texture.generateMipmaps=!1,this.material.uniforms.map.value=this.texture),this.needsUpdate=!1,gU=null})),this.parameters=e,this._fontSize=void 0!==this.parameters.fontSize?this.parameters.fontSize:16,this._fontFamily=void 0!==this.parameters.fontFamily?this.parameters.fontFamily:"Microsoft Yahei",this._fillStyle=void 0!==this.parameters.fillStyle?this.parameters.fillStyle:"#ff0",this._padding=void 0!==this.parameters.padding?this.parameters.padding:[2,2],this.strokeStyle=this.parameters.strokeStyle,this._lineWidth=this.parameters.lineWidth,this.isRenderInPostprocess=this.parameters.isRenderInPostprocess||!1,this.cachedData=[],this.drawingData=[];const t=this.canvas=document.createElement("canvas");t.width=t.height=1;const i=this.ctx=t.getContext("2d");i.textAlign="start",i.textBaseline="top",this.defineMaterialProxyProperties(["lineHeight","map","pixelOffsetX","pixelOffsetY","positionOffsetX","positionOffsetY","positionOffsetZ","backgroundColor","resolution","opacity","flat","emissive","keepSize"])}initObject(){let{padding:e,fillStyle:t,strokeStyle:i,lineWidth:n,fontSize:s,fontFamily:o,vertexStyles:r,...a}=this.parameters;const l=this.engine.map.isGlobe;this.geometry=new Fn(this.parameters),this.material=new lU(a),this.material.isGlobe=l,this.material.setCommonUniforms(this.engine.rendering.uniforms),this.texture=new il(this.canvas),this.texture.minFilter=W,this.texture.magFilter=W,this.texture.generateMipmaps=!1,this.material.uniforms.map.value=this.texture}_updateData(){this._enableCollision&&this._collisionData?(this.cachedData=this.sortByStyle(this._collisionData),gU=null):(this.cachedData=this.sortByStyle(this.dataSource.userData).map((e=>{let t=this.collisionTest(e);return{...e,w:t.width,h:t.height}})),gU=null),this.update()}onBeforeScenePrepareRenderHook(e,t,i){const n=e.rendering.main.sceneRendering.depthTexture;this.material.uniforms.depthTexture.value=n,this.material.uniforms.cameraFar.value=e.rendering.camera.far}update(){this.updateRenderingData()}collisionTest(e){const t=this.ctx,i=this.engine.rendering.pixelRatio,n=this._fontSize,s=this._fontFamily,o=this._padding;t.save(),t.scale(i,i),t.textBaseline="top";let r="";if(this.parameters.vertexStyles){let{text:t,fontWeight:i,fontSize:n,lineWidth:s}=e;r+=`${t}_${n}_${i}_${s}`}else r+=`${e.text}_${n}`;if(this._collisionBoxCache[r])return this._collisionBoxCache[r];let a=n;const l=this.getStrictStyleId(e);if(this.parameters.vertexStyles&&l!==gU){let{fontWeight:i,fontSize:n,lineWidth:o}=e;t.font=i>=10&&i%10==0?10*i+" "+n+"px "+s:n+"px "+s,a=n,o>0&&(t.lineWidth=o)}else t.font=n+"px "+s;let g=String(e.text).split("\\");const c=g.map((e=>t.measureText(e).width));let d=Math.max(...c),h=a*g.length;const u=d+2*o[0],I=h+2*o[1];return t.restore(),this._collisionBoxCache[r]={width:u,height:I},{width:u,height:I}}onDispose(){this.texture&&this.texture.dispose()}getEntityByIndex(e){const t=this.dataSource;this._enableCollision&&this._collisionData&&(e=this._collisionData[e].index);const i={index:e,value:t.getDataItem(e),itemIndex:t.getDataItemIndex(e),pairs:{}},n=t.data;for(const s of Object.keys(n))i.pairs[s]=n[s][e];return i}raycast(e,t){const i=this.flat;if(!this.visible)return;if(i)return;const n=this.geometry,s=n.getAttribute("position");if(!s||!s.array||0===!s.array.length)return;let o=e.camera;o||(o=this.engine.camera);const r=e.mouse;if(!r)return;const a=this.material.uniforms.resolution.value,l=r.x,g=r.y;let c=[];const d=n.getAttribute("wh");d&&(c=d.array);let h=0,u=0,I=0,p=0,m=0,A=0;hU.multiplyMatrices(o.projectionMatrix,o.matrixWorldInverse),hU.multiplyMatrices(hU,this.matrixWorld);const C=s.array;let f=0,b=1;this.keepSize||(b=this.material.uniforms.zoomUnits.value);for(let y=0,_=C.length-11;y<_;y+=12)if(dU.set(C[y],C[y+1],C[y+2],1),dU.applyMatrix4(hU),dU.divideScalar(dU.w),f=y/12*8,m=c[f]/a.x,A=c[f+1]/a.y,h=dU.x-m/b,I=dU.x+m/b,u=dU.y-A/b,p=dU.y+A/b,h<=l&&I>=l&&u<=g&&p>=g){cU.set(C[y],C[y+1],C[y+2]),cU.applyMatrix4(this.matrixWorld);const e={instanceId:y/12,object:this,distance:cU.distanceTo(o.position)};t.push(e)}}set fontSize(e){this._fontSize!==e&&(this._fontSize=e,this._collisionBoxCache={},this.needsUpdate=!0,this.engine.requestRender())}get fontSize(){return this._fontSize}set fontFamily(e){this._fontFamily!==e&&(this._fontFamily=e,this._collisionBoxCache={},this.needsUpdate=!0,this.engine.requestRender())}get fontFamily(){return this._fontFamily}set fillStyle(e){this._fillStyle=e,this.needsUpdate=!0,this.engine.requestRender()}get fillStyle(){return this._fillStyle}set strokeStyle(e){this._shouldStroke=!!e,this._strokeStyle=e,this.needsUpdate=!0,this.engine&&this.engine.requestRender()}get strokeStyle(){return this._strokeStyle}set lineWidth(e){this._lineWidth=e,this.needsUpdate=!0,this.engine.requestRender()}get lineWidth(){return this._lineWidth}set padding(e){this._padding!==e&&(this._padding=e,this._collisionBoxCache={},this.needsUpdate=!0,this.engine.requestRender())}get padding(){return this._padding}},e.TiandituConfig=aE,e.TiandituImageryTileProvider=class extends _W{constructor(e){super({...e}),__publicField(this,"name","TiandituImageryTileProvider"),__publicField(this,"_tk",""),__publicField(this,"_supportedTargetProjectionNames",[Rb,Tb]),__publicField(this,"_defaultMaxLevel",18),this._tk=e.tk||aE.tk}initProjectionAndGrid(){this._sourceProjection=this._targetProjection,this._sourceProjection.name===Tb?this._grid=new JV(this._engine,this._sourceProjection,this._targetProjection):this._sourceProjection.name===Rb&&(this._grid=new cW(this._engine,this._sourceProjection,this._targetProjection))}getTileURL(e,t,i,n){if(0===e)return!1;const s=this._sourceProjection.name===Rb?"vec_c":"vec_w";return`https://t2.tianditu.gov.cn/DataServer?tk=${this._tk}&T=${s}&x=${t}&y=${n.reverseY}&l=${e}`}},e.TileProvider=jV,e.VectorSurface=lW,e.VectorTileProvider=RW,e.Wall=class extends cx{constructor(e){super(),__publicField(this,"geometry"),__publicField(this,"material"),__publicField(this,"height"),__publicField(this,"color"),__publicField(this,"vertexColors"),__publicField(this,"map"),__publicField(this,"opacity"),__publicField(this,"minOpacity"),__publicField(this,"maxOpacity"),__publicField(this,"enableAnimation"),__publicField(this,"animationSpeed"),__publicField(this,"animationTailType"),__publicField(this,"animationTailRatio"),__publicField(this,"animationTailLength"),__publicField(this,"animationIdle"),__publicField(this,"animationRatio"),__publicField(this,"animationBales"),this.parameters=e,this.defineGeometryUpdateProxyProperties(["height"]),this.defineMaterialProxyProperties(["color","vertexColors","emissive","map","mapScale","transparent","opacity","minOpacity","maxOpacity","enableAnimation","animationSpeed","animationTailType","animationTailRatio","animationTailLength","animationIdle","animationBales","animationRatio"])}getDefaultParams(){return{height:100}}initObject(){const{height:e,...t}=this.parameters;(this.geometry=new HQ(this.parameters)).engine=this.engine;(this.material=new DQ(t)).setCommonUniforms(this.engine.rendering.uniforms)}_updateData(){const e=this.dataSource.data;this.geometry.setData(e),this.geometry.computeBoundingSphere(),this.geometry.computeBoundingBox(),this.makeGeometryOffsetPosition(this.geometry,this.geometry.cachedPositions),this.needsUpdate=!1}},e.colorUtils=py,e.geojsonUtils=qv,e.gltfLoader=wH,e.mapViewConstants=VV,e.modelUtils=tP,e.objectUtils=hm,e.requestUtils=zW,e.urlUtils=bm,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
